This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
.gitmodules
backend/.env.backup
backend/.prettierrc
backend/check-db.sh
backend/eslint.config.mjs
backend/nest-cli.json
backend/nixpacks.toml
backend/package.json
backend/Procfile
backend/railway.json
backend/README.md
backend/src/app.controller.spec.ts
backend/src/app.controller.ts
backend/src/app.module.ts
backend/src/app.service.ts
backend/src/chat/chat.controller.ts
backend/src/chat/chat.module.ts
backend/src/chat/chat.service.ts
backend/src/contracts/abis/GameToken.json
backend/src/contracts/abis/Marketplace.json
backend/src/contracts/abis/PropertyNFT.json
backend/src/contracts/abis/QuestSystem.json
backend/src/contracts/abis/TokenSwap.json
backend/src/contracts/abis/YieldDistributor.json
backend/src/contracts/contracts.module.ts
backend/src/contracts/contracts.service.ts
backend/src/database/database.module.ts
backend/src/database/init-db.ts
backend/src/database/migrate-contribution-to-numeric.sql
backend/src/database/run-migration.ts
backend/src/database/schema/chat.schema.ts
backend/src/database/schema/guilds.schema.ts
backend/src/database/schema/index.ts
backend/src/database/schema/leaderboard.schema.ts
backend/src/database/schema/marketplace.schema.ts
backend/src/database/schema/properties.schema.ts
backend/src/database/schema/quests.schema.ts
backend/src/database/schema/users.schema.ts
backend/src/database/schema/yield.schema.ts
backend/src/events/event-indexer.service.ts
backend/src/events/events.module.ts
backend/src/guilds/guilds.controller.ts
backend/src/guilds/guilds.module.ts
backend/src/guilds/guilds.service.ts
backend/src/leaderboard/cleanup-contracts.sql
backend/src/leaderboard/leaderboard.controller.spec.ts
backend/src/leaderboard/leaderboard.controller.ts
backend/src/leaderboard/leaderboard.module.ts
backend/src/leaderboard/leaderboard.service.spec.ts
backend/src/leaderboard/leaderboard.service.ts
backend/src/main.ts
backend/src/mantle/mantle-api.service.ts
backend/src/mantle/mantle-gas.service.ts
backend/src/mantle/mantle-sdk.service.ts
backend/src/mantle/mantle.module.ts
backend/src/mantle/multi-rpc.service.ts
backend/src/mantle/oracle.controller.ts
backend/src/mantle/oracle.service.ts
backend/src/mantle/price-update.service.ts
backend/src/marketplace/marketplace.controller.spec.ts
backend/src/marketplace/marketplace.controller.ts
backend/src/marketplace/marketplace.module.ts
backend/src/marketplace/marketplace.service.spec.ts
backend/src/marketplace/marketplace.service.ts
backend/src/properties/properties.controller.spec.ts
backend/src/properties/properties.controller.ts
backend/src/properties/properties.module.ts
backend/src/properties/properties.service.spec.ts
backend/src/properties/properties.service.ts
backend/src/quests/quests.controller.spec.ts
backend/src/quests/quests.controller.ts
backend/src/quests/quests.module.ts
backend/src/quests/quests.service.spec.ts
backend/src/quests/quests.service.ts
backend/src/users/users.controller.ts
backend/src/users/users.module.ts
backend/src/users/users.service.ts
backend/src/websocket/websocket.gateway.spec.ts
backend/src/websocket/websocket.gateway.ts
backend/src/websocket/websocket.module.ts
backend/src/yield/yield.controller.spec.ts
backend/src/yield/yield.controller.ts
backend/src/yield/yield.module.ts
backend/src/yield/yield.service.spec.ts
backend/src/yield/yield.service.ts
backend/test/app.e2e-spec.ts
backend/test/jest-e2e.json
backend/tsconfig.build.json
backend/tsconfig.json
CHECK_LINK.sh
contracts/.gitignore
contracts/check_new_marketplace.s.sol
contracts/deploy.sh
contracts/foundry.lock
contracts/foundry.toml
contracts/README.md
contracts/script/CheckMarketplacePropertyNFT.s.sol
contracts/script/CheckOldMarketplace.s.sol
contracts/script/CheckPropertyLink.s.sol
contracts/script/Deploy.s.sol
contracts/script/DeployAll.s.sol
contracts/script/DeployMarketplace.s.sol
contracts/script/DeployMockRWA.s.sol
contracts/script/DeployTokenSwap.s.sol
contracts/script/DeployYieldDistributor.s.sol
contracts/script/FindLinkedProperties.s.sol
contracts/script/FixQuestSystemPropertyNFT.s.sol
contracts/script/FreshDeploy.s.sol
contracts/script/FundTokenSwap.s.sol
contracts/script/InitializePropertyCosts.s.sol
contracts/script/MintRWAForAddresses.s.sol
contracts/script/RecoverListings.s.sol
contracts/script/RedeployPropertyNFT.s.sol
contracts/script/RedeployQuestSystem.s.sol
contracts/script/SetupMinter.s.sol
contracts/script/SetupQuestSystemMinter.s.sol
contracts/script/VerifyPropertyLink.s.sol
contracts/script/VerifyRWAYield.s.sol
contracts/script/WhitelistChronicle.s.sol
contracts/src/GameToken.sol
contracts/src/interfaces/IRWA.sol
contracts/src/Marketplace.sol
contracts/src/MockRWA.sol
contracts/src/PropertyNFT.sol
contracts/src/QuestSystem.sol
contracts/src/TokenSwap.sol
contracts/src/YieldDistributor.sol
contracts/test/PropertyNFT.t.sol
docker-compose.yml
frontend/.gitignore
frontend/app/favicon.ico
frontend/app/game/page.tsx
frontend/app/globals.css
frontend/app/layout.tsx
frontend/app/leaderboard/page.tsx
frontend/app/page.tsx
frontend/eslint.config.mjs
frontend/next.config.ts
frontend/package.json
frontend/postcss.config.mjs
frontend/public/abis/PropertyNFT.json
frontend/public/abis/TokenSwap.json
frontend/public/abis/YieldDistributor.json
frontend/public/assets/fonts/KnightWarrior-w16n8.otf
frontend/public/file.svg
frontend/public/globe.svg
frontend/public/next.svg
frontend/public/vercel.svg
frontend/public/window.svg
frontend/README.md
frontend/src/components/game/BuildMenu.tsx
frontend/src/components/game/CityView.tsx
frontend/src/components/game/GameGuide.tsx
frontend/src/components/game/PropertyCard.tsx
frontend/src/components/game/PropertyDetails.tsx
frontend/src/components/game/PropertyMap.tsx
frontend/src/components/game/YieldDisplay.tsx
frontend/src/components/GlobalChat.tsx
frontend/src/components/Guilds.tsx
frontend/src/components/Leaderboard.tsx
frontend/src/components/Marketplace.tsx
frontend/src/components/Quests.tsx
frontend/src/components/RWALinkModal.tsx
frontend/src/components/TokenPurchase.tsx
frontend/src/components/ui/avatar.tsx
frontend/src/components/ui/button.tsx
frontend/src/components/ui/card.tsx
frontend/src/components/ui/input.tsx
frontend/src/components/ui/scroll-area.tsx
frontend/src/components/UserProfile.tsx
frontend/src/components/VisitPortfolio.tsx
frontend/src/components/WalletConnect.tsx
frontend/src/config/index.tsx
frontend/src/context/index.tsx
frontend/src/hooks/useChat.ts
frontend/src/hooks/useMNTPrice.ts
frontend/src/lib/api.ts
frontend/src/lib/contracts.ts
frontend/src/lib/mantle-viem.ts
frontend/src/lib/utils.ts
frontend/tsconfig.json
railway.json
README.md
START_ALL.bat
START_ALL.sh
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Dependencies
node_modules/
.pnp
.pnp.js

# Testing
coverage/
*.log

# Production
build/
dist/
.next/
out/

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Hardhat
cache/
artifacts/
typechain-types/

# Database
*.db
*.sqlite

# Documentation/Planning (keep local, don't commit)
*.md
!README.md

# Misc
*.pid
*.seed
*.pid.lock
</file>

<file path=".gitmodules">
[submodule "contracts/lib/openzeppelin-contracts"]
	path = contracts/lib/openzeppelin-contracts
	url = https://github.com/OpenZeppelin/openzeppelin-contracts
</file>

<file path="backend/.prettierrc">
{
  "singleQuote": true,
  "trailingComma": "all"
}
</file>

<file path="backend/eslint.config.mjs">
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);
</file>

<file path="backend/nest-cli.json">
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
</file>

<file path="backend/src/app.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});
</file>

<file path="backend/src/app.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
</file>

<file path="backend/src/database/database.module.ts">
import { Module, Global } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';

export const DATABASE_CONNECTION = 'DATABASE_CONNECTION';

@Global()
@Module({
  imports: [ConfigModule],
  providers: [
    {
      provide: DATABASE_CONNECTION,
      useFactory: (configService: ConfigService) => {
        const connectionString =
          configService.get<string>('DATABASE_URL') ||
          'postgresql://postgres:password@localhost:5432/property_tycoon';

        const client = postgres(connectionString);
        return drizzle(client, { schema });
      },
      inject: [ConfigService],
    },
  ],
  exports: [DATABASE_CONNECTION],
})
export class DatabaseModule {}
</file>

<file path="backend/src/database/schema/marketplace.schema.ts">
import { pgTable, uuid, varchar, numeric, boolean, timestamp } from 'drizzle-orm/pg-core';
import { users } from './users.schema';
import { properties } from './properties.schema';

export const marketplaceListings = pgTable('marketplace_listings', {
  id: uuid('id').defaultRandom().primaryKey(),
  propertyId: uuid('property_id')
    .notNull()
    .references(() => properties.id, { onDelete: 'cascade' })
    .unique(),
  sellerId: uuid('seller_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  price: numeric('price').notNull(),
  isActive: boolean('is_active').default(true).notNull(),
  listingType: varchar('listing_type', { length: 20 }).notNull(),
  auctionEndTime: timestamp('auction_end_time'),
  highestBid: numeric('highest_bid'),
  highestBidderId: uuid('highest_bidder_id').references(() => users.id),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type MarketplaceListing = typeof marketplaceListings.$inferSelect;
export type NewMarketplaceListing = typeof marketplaceListings.$inferInsert;
</file>

<file path="backend/src/leaderboard/leaderboard.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { LeaderboardController } from './leaderboard.controller';

describe('LeaderboardController', () => {
  let controller: LeaderboardController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [LeaderboardController],
    }).compile();

    controller = module.get<LeaderboardController>(LeaderboardController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});
</file>

<file path="backend/src/leaderboard/leaderboard.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { LeaderboardService } from './leaderboard.service';

describe('LeaderboardService', () => {
  let service: LeaderboardService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [LeaderboardService],
    }).compile();

    service = module.get<LeaderboardService>(LeaderboardService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/mantle/mantle-sdk.service.ts">
import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { CrossChainMessenger, L1ChainID, L2ChainID } from '@mantleio/sdk';
import { ethers } from 'ethers';

@Injectable()
export class MantleSdkService implements OnModuleInit {
  private readonly logger = new Logger(MantleSdkService.name);
  private messenger: CrossChainMessenger | null = null;

  async onModuleInit() {
    await this.initializeMessenger();
  }

  private async initializeMessenger() {
    try {
      // Initialize providers
      const l1Provider = new ethers.providers.JsonRpcProvider(
        process.env.L1_RPC_URL || 'https://eth.llamarpc.com',
      );
      const l2Provider = new ethers.providers.JsonRpcProvider(
        process.env.MANTLE_RPC_URL || 'https://rpc.mantle.xyz',
      );

      // Create cross-chain messenger
      this.messenger = new CrossChainMessenger({
        l1SignerOrProvider: l1Provider,
        l2SignerOrProvider: l2Provider,
        l1ChainId: L1ChainID.MAINNET,
        l2ChainId: L2ChainID.MANTLE,
      });

      this.logger.log('Mantle SDK CrossChainMessenger initialized');
    } catch (error) {
      this.logger.error('Failed to initialize Mantle SDK', error);
    }
  }

  /**
   * Get cross-chain messenger instance
   */
  getMessenger(): CrossChainMessenger | null {
    return this.messenger;
  }

  /**
   * Check if messenger is ready
   */
  isReady(): boolean {
    return this.messenger !== null;
  }

  /**
   * Get L1 to L2 message status
   */
  async getMessageStatus(messageHash: string) {
    if (!this.messenger) {
      throw new Error('Messenger not initialized');
    }

    try {
      const status = await this.messenger.getMessageStatus(messageHash);
      return status;
    } catch (error) {
      this.logger.error('Failed to get message status', error);
      throw error;
    }
  }

  /**
   * Estimate gas for depositing ETH to Mantle L2
   * Note: Mantle SDK API varies - this is a placeholder implementation
   * Adjust based on actual @mantleio/sdk version and API
   */
  async estimateDepositGas(amount: string, tokenAddress?: string) {
    if (!this.messenger) {
      throw new Error('Messenger not initialized');
    }

    try {
      const parsedAmount = ethers.utils.parseEther(amount);
      this.logger.log(`Estimating gas for deposit: ${amount}`);
      
      // TODO: Implement actual Mantle SDK gas estimation
      // The exact API depends on the @mantleio/sdk version
      // For now, return a reasonable estimate
      // Standard L2 deposit typically costs ~50k-100k gas
      const estimatedGas = tokenAddress ? '100000' : '80000';
      
      this.logger.log(`Estimated gas: ${estimatedGas}`);
      return estimatedGas;
    } catch (error) {
      this.logger.error('Failed to estimate deposit gas', error);
      // Return a default estimate if SDK method fails
      return '100000'; // Conservative estimate for L2 deposit
    }
  }

  /**
   * Get withdrawal status for L2 to L1 withdrawals
   */
  async getWithdrawalStatus(txHash: string) {
    if (!this.messenger) {
      throw new Error('Messenger not initialized');
    }

    try {
      const status = await this.messenger.getMessageStatus(txHash);
      return status;
    } catch (error) {
      this.logger.error('Failed to get withdrawal status', error);
      throw error;
    }
  }

  /**
   * Get L2 block number
   */
  async getL2BlockNumber(): Promise<number> {
    if (!this.messenger) {
      throw new Error('Messenger not initialized');
    }

    try {
      const blockNumber = await this.messenger.l2Provider.getBlockNumber();
      return blockNumber;
    } catch (error) {
      this.logger.error('Failed to get L2 block number', error);
      throw error;
    }
  }

  /**
   * Get L1 block number
   */
  async getL1BlockNumber(): Promise<number> {
    if (!this.messenger) {
      throw new Error('Messenger not initialized');
    }

    try {
      const blockNumber = await this.messenger.l1Provider.getBlockNumber();
      return blockNumber;
    } catch (error) {
      this.logger.error('Failed to get L1 block number', error);
      throw error;
    }
  }
}
</file>

<file path="backend/src/marketplace/marketplace.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { MarketplaceController } from './marketplace.controller';

describe('MarketplaceController', () => {
  let controller: MarketplaceController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [MarketplaceController],
    }).compile();

    controller = module.get<MarketplaceController>(MarketplaceController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});
</file>

<file path="backend/src/marketplace/marketplace.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { MarketplaceService } from './marketplace.service';

describe('MarketplaceService', () => {
  let service: MarketplaceService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [MarketplaceService],
    }).compile();

    service = module.get<MarketplaceService>(MarketplaceService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/properties/properties.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { PropertiesController } from './properties.controller';

describe('PropertiesController', () => {
  let controller: PropertiesController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [PropertiesController],
    }).compile();

    controller = module.get<PropertiesController>(PropertiesController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});
</file>

<file path="backend/src/properties/properties.module.ts">
import { Module } from '@nestjs/common';
import { PropertiesService } from './properties.service';
import { PropertiesController } from './properties.controller';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';

@Module({
  imports: [DatabaseModule, ContractsModule],
  controllers: [PropertiesController],
  providers: [PropertiesService],
  exports: [PropertiesService],
})
export class PropertiesModule {}
</file>

<file path="backend/src/properties/properties.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { PropertiesService } from './properties.service';

describe('PropertiesService', () => {
  let service: PropertiesService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [PropertiesService],
    }).compile();

    service = module.get<PropertiesService>(PropertiesService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/quests/quests.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { QuestsController } from './quests.controller';

describe('QuestsController', () => {
  let controller: QuestsController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [QuestsController],
    }).compile();

    controller = module.get<QuestsController>(QuestsController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});
</file>

<file path="backend/src/quests/quests.module.ts">
import { Module } from '@nestjs/common';
import { QuestsService } from './quests.service';
import { QuestsController } from './quests.controller';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';

@Module({
  imports: [DatabaseModule, ContractsModule],
  controllers: [QuestsController],
  providers: [QuestsService],
  exports: [QuestsService],
})
export class QuestsModule {}
</file>

<file path="backend/src/quests/quests.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { QuestsService } from './quests.service';

describe('QuestsService', () => {
  let service: QuestsService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [QuestsService],
    }).compile();

    service = module.get<QuestsService>(QuestsService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/src/websocket/websocket.gateway.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { WebsocketGateway } from './websocket.gateway';

describe('WebsocketGateway', () => {
  let gateway: WebsocketGateway;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [WebsocketGateway],
    }).compile();

    gateway = module.get<WebsocketGateway>(WebsocketGateway);
  });

  it('should be defined', () => {
    expect(gateway).toBeDefined();
  });
});
</file>

<file path="backend/src/yield/yield.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { YieldController } from './yield.controller';

describe('YieldController', () => {
  let controller: YieldController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [YieldController],
    }).compile();

    controller = module.get<YieldController>(YieldController);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });
});
</file>

<file path="backend/src/yield/yield.service.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { YieldService } from './yield.service';

describe('YieldService', () => {
  let service: YieldService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [YieldService],
    }).compile();

    service = module.get<YieldService>(YieldService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });
});
</file>

<file path="backend/test/app.e2e-spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { App } from 'supertest/types';
import { AppModule } from './../src/app.module';

describe('AppController (e2e)', () => {
  let app: INestApplication<App>;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    await app.init();
  });

  it('/ (GET)', () => {
    return request(app.getHttpServer())
      .get('/')
      .expect(200)
      .expect('Hello World!');
  });
});
</file>

<file path="backend/test/jest-e2e.json">
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}
</file>

<file path="backend/tsconfig.build.json">
{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}
</file>

<file path="backend/tsconfig.json">
{
  "compilerOptions": {
    "module": "nodenext",
    "moduleResolution": "nodenext",
    "resolvePackageJsonExports": true,
    "esModuleInterop": true,
    "isolatedModules": true,
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}
</file>

<file path="contracts/.gitignore">
out/
cache/
broadcast/
lib/
.env
</file>

<file path="contracts/deploy.sh">
#!/bin/bash

# Property Tycoon Contract Deployment Script
# Deploys all contracts to Mantle Testnet

set -e

echo "=== Property Tycoon Contract Deployment ==="
echo ""

# Check if .env exists
if [ ! -f .env ]; then
    echo "Error: .env file not found!"
    echo "Please copy .env.example to .env and fill in your values"
    exit 1
fi

# Load environment variables
source .env

# Check if PRIVATE_KEY is set
if [ -z "$PRIVATE_KEY" ]; then
    echo "Error: PRIVATE_KEY not set in .env file"
    exit 1
fi

# Check if MANTLE_API_KEY is set
if [ -z "$MANTLE_API_KEY" ]; then
    echo "Warning: MANTLE_API_KEY not set. Contracts will deploy but not verify."
fi

echo "Building contracts..."
forge build

echo ""
echo "Deploying contracts to Mantle Testnet..."
echo ""

# Deploy using script
forge script script/Deploy.s.sol:DeployScript \
  --rpc-url mantle_testnet \
  --broadcast \
  --verify \
  -vvv

echo ""
echo "=== Deployment Complete ==="
echo ""
echo "Please update the following files with the deployed addresses:"
echo "1. backend/.env"
echo "2. frontend/.env.local"
echo "3. README.md (root)"
echo ""
</file>

<file path="contracts/foundry.lock">
{
  "lib\\openzeppelin-contracts": {
    "tag": {
      "name": "v5.5.0",
      "rev": "fcbae5394ae8ad52d8e580a3477db99814b9d565"
    }
  }
}
</file>

<file path="contracts/foundry.toml">
[profile.default]
src = "src"
out = "out"
libs = ["lib"]
solc = "0.8.24"
optimizer = true
optimizer_runs = 200
via_ir = false

[rpc_endpoints]
mantle_testnet = "https://rpc.testnet.mantle.xyz"
mantle_mainnet = "https://rpc.mantle.xyz"

[etherscan]
mantle_testnet = { key = "${MANTLE_API_KEY}", url = "https://explorer.testnet.mantle.xyz/api" }
mantle_mainnet = { key = "${MANTLE_API_KEY}", url = "https://explorer.mantle.xyz/api" }
</file>

<file path="contracts/script/Deploy.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {Marketplace} from "../src/Marketplace.sol";
import {QuestSystem} from "../src/QuestSystem.sol";

contract DeployScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Deploying Property Tycoon contracts to Mantle...");
        console.log("Deployer:", vm.addr(deployerPrivateKey));
        
        GameToken gameToken = new GameToken();
        console.log("GameToken deployed at:", address(gameToken));
        
        PropertyNFT propertyNFT = new PropertyNFT();
        console.log("PropertyNFT deployed at:", address(propertyNFT));
        
        YieldDistributor yieldDistributor = new YieldDistributor(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("YieldDistributor deployed at:", address(yieldDistributor));
        
        Marketplace marketplace = new Marketplace(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("Marketplace deployed at:", address(marketplace));
        
        QuestSystem questSystem = new QuestSystem(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("QuestSystem deployed at:", address(questSystem));
        
        console.log("\n=== Deployment Summary ===");
        console.log("GameToken:", address(gameToken));
        console.log("PropertyNFT:", address(propertyNFT));
        console.log("YieldDistributor:", address(yieldDistributor));
        console.log("Marketplace:", address(marketplace));
        console.log("QuestSystem:", address(questSystem));
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/test/PropertyNFT.t.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test, console} from "forge-std/Test.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";

contract PropertyNFTTest is Test {
    PropertyNFT public propertyNFT;
    address public owner = address(1);
    address public user = address(2);
    
    function setUp() public {
        propertyNFT = new PropertyNFT();
    }
    
    function testMintProperty() public {
        vm.prank(owner);
        uint256 tokenId = propertyNFT.mintProperty(
            user,
            PropertyNFT.PropertyType.Residential,
            1000,
            500
        );
        
        assertEq(propertyNFT.ownerOf(tokenId), user);
        PropertyNFT.Property memory prop = propertyNFT.getProperty(tokenId);
        assertEq(uint256(prop.propertyType), uint256(PropertyNFT.PropertyType.Residential));
        assertEq(prop.value, 1000);
    }
    
    function testLinkToRWA() public {
        vm.prank(owner);
        uint256 tokenId = propertyNFT.mintProperty(
            user,
            PropertyNFT.PropertyType.Commercial,
            2000,
            800
        );
        
        vm.prank(user);
        propertyNFT.linkToRWA(tokenId, address(0x123), 1);
        
        PropertyNFT.Property memory prop = propertyNFT.getProperty(tokenId);
        assertEq(prop.rwaContract, address(0x123));
        assertEq(prop.rwaTokenId, 1);
    }
}
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: property-tycoon-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: property_tycoon
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;
</file>

<file path="frontend/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/src/components/ui/button.tsx">
import * as React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils';

const buttonVariants = cva(
  'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive: 'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline: 'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
        secondary: 'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 rounded-md px-3',
        lg: 'h-11 rounded-md px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button className={cn(buttonVariants({ variant, size, className }))} ref={ref} {...props} />
    );
  },
);
Button.displayName = 'Button';

export { Button, buttonVariants };
</file>

<file path="frontend/src/components/ui/input.tsx">
import * as React from 'react';
import { cn } from '@/lib/utils';

export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
          className,
        )}
        ref={ref}
        {...props}
      />
    );
  },
);
Input.displayName = 'Input';

export { Input };
</file>

<file path="backend/.env.backup">
# Server Configuration
PORT=3001
API_PREFIX=api
CORS_ORIGIN=http://localhost:3000

# Database Configuration
DATABASE_URL=postgresql://postgres:password@localhost:5432/property_tycoon

# Mantle Network Configuration
MANTLE_RPC_URL=https://rpc.sepolia.mantle.xyz
L1_RPC_URL=https://eth.llamarpc.com

# Contract Addresses (Mantle Sepolia Testnet)
PROPERTY_NFT_ADDRESS=0x0AE7119c7187D88643fb7B409937B68828eE733D
GAME_TOKEN_ADDRESS=0x32D9a9b9e241Da421f34786De0B39fD34D1EfeA8
YIELD_DISTRIBUTOR_ADDRESS=0x8CaD66cd3CcF6038879fa7bEC68d4F808c92A3cd
MARKETPLACE_ADDRESS=0xe9E855ff6EB78055AaE90631468BfC948A1446Bb
QUEST_SYSTEM_ADDRESS=0xb5a595A6cd30D1798387A2c781E0646FCA8c4AeD

# Private Key for Contract Interactions (Backend Signer)
# IMPORTANT: Use a dedicated wallet with minimal funds for backend operations
# DO NOT use your main wallet private key
PRIVATE_KEY=0x29332143cd080547332727a8f7b2110c16dda3b9a74653b8084e54a24c076478

# Chronicle Oracle Addresses (Optional - for RWA price feeds)
CHRONICLE_USDC_ORACLE=
CHRONICLE_USDT_ORACLE=
CHRONICLE_ETH_ORACLE=
CHRONICLE_MNT_ORACLE=



ENABLE_PROPERTY_SYNC=true
</file>

<file path="backend/check-db.sh">

</file>

<file path="backend/src/app.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  @Get('health')
  healthCheck() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      service: 'Property Tycoon Backend',
      version: '1.0.0',
    };
  }
}
</file>

<file path="backend/src/chat/chat.controller.ts">
import { Controller, Post, Get, Body, Param, Query } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { ChatService, ChatMessageDto } from './chat.service';

@ApiTags('chat')
@Controller('chat')
export class ChatController {
  constructor(private readonly chatService: ChatService) {}

  @Post('messages')
  @ApiOperation({ summary: 'Send a chat message' })
  @ApiResponse({ status: 201, description: 'Message sent successfully' })
  async sendMessage(
    @Body('walletAddress') walletAddress: string,
    @Body('message') message: string,
  ): Promise<ChatMessageDto> {
    return this.chatService.sendMessage(walletAddress, message);
  }

  @Get('messages')
  @ApiOperation({ summary: 'Get recent chat messages' })
  @ApiResponse({ status: 200, description: 'List of chat messages' })
  async getMessages(@Query('limit') limit?: number): Promise<ChatMessageDto[]> {
    return this.chatService.getRecentMessages(limit || 100);
  }
}
</file>

<file path="backend/src/chat/chat.module.ts">
import { Module } from '@nestjs/common';
import { ChatController } from './chat.controller';
import { ChatService } from './chat.service';
import { DatabaseModule } from '../database/database.module';
import { WebsocketGateway } from '../websocket/websocket.gateway';

@Module({
  imports: [DatabaseModule],
  controllers: [ChatController],
  providers: [ChatService, WebsocketGateway],
  exports: [ChatService],
})
export class ChatModule {}
</file>

<file path="backend/src/contracts/abis/GameToken.json">
[
  {
    "type": "constructor",
    "inputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "allowance",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "spender",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "approve",
    "inputs": [
      {
        "name": "spender",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "value",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "bool",
        "internalType": "bool"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "balanceOf",
    "inputs": [
      {
        "name": "account",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "burn",
    "inputs": [
      {
        "name": "amount",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "decimals",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "uint8",
        "internalType": "uint8"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "mint",
    "inputs": [
      {
        "name": "to",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "amount",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "name",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "string",
        "internalType": "string"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "owner",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "address"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "renounceOwnership",
    "inputs": [],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "symbol",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "string",
        "internalType": "string"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "totalSupply",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "transfer",
    "inputs": [
      {
        "name": "to",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "value",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "bool",
        "internalType": "bool"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "transferFrom",
    "inputs": [
      {
        "name": "from",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "to",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "value",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "bool",
        "internalType": "bool"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "transferOwnership",
    "inputs": [
      {
        "name": "newOwner",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "event",
    "name": "Approval",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "spender",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "value",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "OwnershipTransferred",
    "inputs": [
      {
        "name": "previousOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "newOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "Transfer",
    "inputs": [
      {
        "name": "from",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "to",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "value",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "error",
    "name": "ERC20InsufficientAllowance",
    "inputs": [
      {
        "name": "spender",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "allowance",
        "type": "uint256",
        "internalType": "uint256"
      },
      {
        "name": "needed",
        "type": "uint256",
        "internalType": "uint256"
      }
    ]
  },
  {
    "type": "error",
    "name": "ERC20InsufficientBalance",
    "inputs": [
      {
        "name": "sender",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "balance",
        "type": "uint256",
        "internalType": "uint256"
      },
      {
        "name": "needed",
        "type": "uint256",
        "internalType": "uint256"
      }
    ]
  },
  {
    "type": "error",
    "name": "ERC20InvalidApprover",
    "inputs": [
      {
        "name": "approver",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "ERC20InvalidReceiver",
    "inputs": [
      {
        "name": "receiver",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "ERC20InvalidSender",
    "inputs": [
      {
        "name": "sender",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "ERC20InvalidSpender",
    "inputs": [
      {
        "name": "spender",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "OwnableInvalidOwner",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "OwnableUnauthorizedAccount",
    "inputs": [
      {
        "name": "account",
        "type": "address",
        "internalType": "address"
      }
    ]
  }
]
</file>

<file path="backend/src/contracts/abis/QuestSystem.json">
[
  {
    "type": "constructor",
    "inputs": [
      {
        "name": "_propertyNFT",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "_gameToken",
        "type": "address",
        "internalType": "address"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "batchCheckQuests",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "questTypes",
        "type": "uint8[]",
        "internalType": "enum QuestSystem.QuestType[]"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "checkDiversifyPortfolioQuest",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "checkFirstPropertyQuest",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "checkPropertyMogulQuest",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "checkRWAPioneerQuest",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "gameToken",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "contract GameToken"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "getTotalQuestsCompleted",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "hasCompletedQuest",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "questType",
        "type": "uint8",
        "internalType": "enum QuestSystem.QuestType"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "bool",
        "internalType": "bool"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "owner",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "address"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "playerProgress",
    "inputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "totalQuestsCompleted",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "propertyNFT",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "contract PropertyNFT"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "quests",
    "inputs": [
      {
        "name": "",
        "type": "uint8",
        "internalType": "enum QuestSystem.QuestType"
      }
    ],
    "outputs": [
      {
        "name": "questType",
        "type": "uint8",
        "internalType": "enum QuestSystem.QuestType"
      },
      {
        "name": "name",
        "type": "string",
        "internalType": "string"
      },
      {
        "name": "description",
        "type": "string",
        "internalType": "string"
      },
      {
        "name": "reward",
        "type": "uint256",
        "internalType": "uint256"
      },
      {
        "name": "isActive",
        "type": "bool",
        "internalType": "bool"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "renounceOwnership",
    "inputs": [],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "transferOwnership",
    "inputs": [
      {
        "name": "newOwner",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "event",
    "name": "OwnershipTransferred",
    "inputs": [
      {
        "name": "previousOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "newOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "QuestCompleted",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "questType",
        "type": "uint8",
        "indexed": false,
        "internalType": "enum QuestSystem.QuestType"
      },
      {
        "name": "reward",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "QuestProgressUpdated",
    "inputs": [
      {
        "name": "player",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "questType",
        "type": "uint8",
        "indexed": false,
        "internalType": "enum QuestSystem.QuestType"
      },
      {
        "name": "progress",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "error",
    "name": "OwnableInvalidOwner",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "OwnableUnauthorizedAccount",
    "inputs": [
      {
        "name": "account",
        "type": "address",
        "internalType": "address"
      }
    ]
  }
]
</file>

<file path="backend/src/contracts/abis/TokenSwap.json">
{"abi":[{"type":"constructor","inputs":[{"name":"_gameToken","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"EXCHANGE_RATE","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"MIN_PURCHASE_MNT","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"buyTokens","inputs":[],"outputs":[],"stateMutability":"payable"},{"type":"function","name":"depositTokens","inputs":[{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"gameToken","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract GameToken"}],"stateMutability":"view"},{"type":"function","name":"getMntAmount","inputs":[{"name":"tycoonAmount","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"pure"},{"type":"function","name":"getTokenBalance","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getTycoonAmount","inputs":[{"name":"mntAmount","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"pure"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"withdrawMNT","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"withdrawTokens","inputs":[{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"TokensPurchased","inputs":[{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"mntAmount","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"tycoonAmount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"TokensWithdrawn","inputs":[{"name":"to","type":"address","indexed":true,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]},{"type":"error","name":"ReentrancyGuardReentrantCall","inputs":[]}],"bytecode":{"object":"0x608060405234801561000f575f80fd5b50604051610a9e380380610a9e83398101604081905261002e916100f5565b338061005357604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b61005c816100a6565b5060017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055600180546001600160a01b0319166001600160a01b0392909216919091179055610122565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f60208284031215610105575f80fd5b81516001600160a01b038116811461011b575f80fd5b9392505050565b61096f8061012f5f395ff3fe6080604052600436106100bf575f3560e01c80639a5ed7381161007c578063d0febe4c11610057578063d0febe4c146101cf578063d87810d6146101d7578063dd49756e146101f6578063f2fde38b14610215575f80fd5b80639a5ed73814610177578063c3dfdae614610191578063d0dea103146101b0575f80fd5b806314a8bd0d146100c3578063315a095d146100ea5780636e5c09561461010b578063715018a61461011f57806382b2e257146101335780638da5cb5b14610147575b5f80fd5b3480156100ce575f80fd5b506100d7606481565b6040519081526020015b60405180910390f35b3480156100f5575f80fd5b5061010961010436600461084e565b610234565b005b348015610116575f80fd5b50610109610341565b34801561012a575f80fd5b506101096103c6565b34801561013e575f80fd5b506100d76103d9565b348015610152575f80fd5b505f546001600160a01b03165b6040516001600160a01b0390911681526020016100e1565b348015610182575f80fd5b506100d766038d7ea4c6800081565b34801561019c575f80fd5b5060015461015f906001600160a01b031681565b3480156101bb575f80fd5b506100d76101ca36600461084e565b610448565b61010961045a565b3480156101e2575f80fd5b506100d76101f136600461084e565b610686565b348015610201575f80fd5b5061010961021036600461084e565b610692565b348015610220575f80fd5b5061010961022f366004610865565b610729565b61023c610763565b6001546001600160a01b031663a9059cbb61025e5f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af11580156102a8573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102cc9190610892565b6102f15760405162461bcd60e51b81526004016102e8906108b1565b60405180910390fd5b5f546001600160a01b03166001600160a01b03167f6352c5382c4a4578e712449ca65e83cdb392d045dfcf1cad9615189db2da244b8260405161033691815260200190565b60405180910390a250565b610349610763565b478061038c5760405162461bcd60e51b81526020600482015260126024820152714e6f204d4e5420746f20776974686472617760701b60448201526064016102e8565b5f80546040516001600160a01b039091169183156108fc02918491818181858888f193505050501580156103c2573d5f803e3d5ffd5b5050565b6103ce610763565b6103d75f61078f565b565b6001546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa15801561041f573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061044391906108e0565b905090565b5f6104546064836108f7565b92915050565b6104626107de565b66038d7ea4c680003410156104b95760405162461bcd60e51b815260206004820152601d60248201527f4d696e696d756d20707572636861736520697320302e303031204d4e5400000060448201526064016102e8565b5f6104c5606434610916565b6001546040516370a0823160e01b81523060048201529192505f916001600160a01b03909116906370a0823190602401602060405180830381865afa158015610510573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053491906108e0565b9050818110156105925760405162461bcd60e51b8152602060048201526024808201527f496e73756666696369656e7420746f6b656e7320696e207377617020636f6e746044820152631c9858dd60e21b60648201526084016102e8565b60015460405163a9059cbb60e01b8152336004820152602481018490526001600160a01b039091169063a9059cbb906044016020604051808303815f875af11580156105e0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106049190610892565b6106205760405162461bcd60e51b81526004016102e8906108b1565b604080513481526020810184905233917f8fafebcaf9d154343dad25669bfa277f4fbacd7ac6b0c4fed522580e040a0f33910160405180910390a250506103d760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b5f610454606483610916565b6001546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af11580156106e6573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061070a9190610892565b6107265760405162461bcd60e51b81526004016102e8906108b1565b50565b610731610763565b6001600160a01b03811661075a57604051631e4fbdf760e01b81525f60048201526024016102e8565b6107268161078f565b5f546001600160a01b031633146103d75760405163118cdaa760e01b81523360048201526024016102e8565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6107e661080c565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00546002036103d757604051633ee5aeb560e01b815260040160405180910390fd5b5f6020828403121561085e575f80fd5b5035919050565b5f60208284031215610875575f80fd5b81356001600160a01b038116811461088b575f80fd5b9392505050565b5f602082840312156108a2575f80fd5b8151801515811461088b575f80fd5b602080825260159082015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b604082015260600190565b5f602082840312156108f0575f80fd5b5051919050565b5f8261091157634e487b7160e01b5f52601260045260245ffd5b500490565b808202811582820484141761045457634e487b7160e01b5f52601160045260245ffdfea264697066735822122022ebdbc7e4f730ba17e7e729a663fba52e6e5a0dd780a57b2af35c301da05b6f64736f6c63430008180033","sourceMap":"386:2907:54:-:0;;;836:102;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;876:10;;1269:95:0;;1322:31;;-1:-1:-1;;;1322:31:0;;1350:1;1322:31;;;455:51:57;428:18;;1322:31:0;;;;;;;1269:95;1373:32;1392:12;1373:18;:32::i;:::-;-1:-1:-1;2365:1:13;1505:66;2539;898:9:54::1;:33:::0;;-1:-1:-1;;;;;;898:33:54::1;-1:-1:-1::0;;;;;898:33:54;;;::::1;::::0;;;::::1;::::0;;386:2907;;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;14:290:57:-;84:6;137:2;125:9;116:7;112:23;108:32;105:52;;;153:1;150;143:12;105:52;179:16;;-1:-1:-1;;;;;224:31:57;;214:42;;204:70;;270:1;267;260:12;204:70;293:5;14:290;-1:-1:-1;;;14:290:57:o;309:203::-;386:2907:54;;;;;;","linkReferences":{}},"deployedBytecode":{"object":"0x6080604052600436106100bf575f3560e01c80639a5ed7381161007c578063d0febe4c11610057578063d0febe4c146101cf578063d87810d6146101d7578063dd49756e146101f6578063f2fde38b14610215575f80fd5b80639a5ed73814610177578063c3dfdae614610191578063d0dea103146101b0575f80fd5b806314a8bd0d146100c3578063315a095d146100ea5780636e5c09561461010b578063715018a61461011f57806382b2e257146101335780638da5cb5b14610147575b5f80fd5b3480156100ce575f80fd5b506100d7606481565b6040519081526020015b60405180910390f35b3480156100f5575f80fd5b5061010961010436600461084e565b610234565b005b348015610116575f80fd5b50610109610341565b34801561012a575f80fd5b506101096103c6565b34801561013e575f80fd5b506100d76103d9565b348015610152575f80fd5b505f546001600160a01b03165b6040516001600160a01b0390911681526020016100e1565b348015610182575f80fd5b506100d766038d7ea4c6800081565b34801561019c575f80fd5b5060015461015f906001600160a01b031681565b3480156101bb575f80fd5b506100d76101ca36600461084e565b610448565b61010961045a565b3480156101e2575f80fd5b506100d76101f136600461084e565b610686565b348015610201575f80fd5b5061010961021036600461084e565b610692565b348015610220575f80fd5b5061010961022f366004610865565b610729565b61023c610763565b6001546001600160a01b031663a9059cbb61025e5f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af11580156102a8573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102cc9190610892565b6102f15760405162461bcd60e51b81526004016102e8906108b1565b60405180910390fd5b5f546001600160a01b03166001600160a01b03167f6352c5382c4a4578e712449ca65e83cdb392d045dfcf1cad9615189db2da244b8260405161033691815260200190565b60405180910390a250565b610349610763565b478061038c5760405162461bcd60e51b81526020600482015260126024820152714e6f204d4e5420746f20776974686472617760701b60448201526064016102e8565b5f80546040516001600160a01b039091169183156108fc02918491818181858888f193505050501580156103c2573d5f803e3d5ffd5b5050565b6103ce610763565b6103d75f61078f565b565b6001546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa15801561041f573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061044391906108e0565b905090565b5f6104546064836108f7565b92915050565b6104626107de565b66038d7ea4c680003410156104b95760405162461bcd60e51b815260206004820152601d60248201527f4d696e696d756d20707572636861736520697320302e303031204d4e5400000060448201526064016102e8565b5f6104c5606434610916565b6001546040516370a0823160e01b81523060048201529192505f916001600160a01b03909116906370a0823190602401602060405180830381865afa158015610510573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053491906108e0565b9050818110156105925760405162461bcd60e51b8152602060048201526024808201527f496e73756666696369656e7420746f6b656e7320696e207377617020636f6e746044820152631c9858dd60e21b60648201526084016102e8565b60015460405163a9059cbb60e01b8152336004820152602481018490526001600160a01b039091169063a9059cbb906044016020604051808303815f875af11580156105e0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106049190610892565b6106205760405162461bcd60e51b81526004016102e8906108b1565b604080513481526020810184905233917f8fafebcaf9d154343dad25669bfa277f4fbacd7ac6b0c4fed522580e040a0f33910160405180910390a250506103d760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b5f610454606483610916565b6001546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af11580156106e6573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061070a9190610892565b6107265760405162461bcd60e51b81526004016102e8906108b1565b50565b610731610763565b6001600160a01b03811661075a57604051631e4fbdf760e01b81525f60048201526024016102e8565b6107268161078f565b5f546001600160a01b031633146103d75760405163118cdaa760e01b81523360048201526024016102e8565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6107e661080c565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00546002036103d757604051633ee5aeb560e01b815260040160405180910390fd5b5f6020828403121561085e575f80fd5b5035919050565b5f60208284031215610875575f80fd5b81356001600160a01b038116811461088b575f80fd5b9392505050565b5f602082840312156108a2575f80fd5b8151801515811461088b575f80fd5b602080825260159082015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b604082015260600190565b5f602082840312156108f0575f80fd5b5051919050565b5f8261091157634e487b7160e01b5f52601260045260245ffd5b500490565b808202811582820484141761045457634e487b7160e01b5f52601160045260245ffdfea264697066735822122022ebdbc7e4f730ba17e7e729a663fba52e6e5a0dd780a57b2af35c301da05b6f64736f6c63430008180033","sourceMap":"386:2907:54:-:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;542:43;;;;;;;;;;;;582:3;542:43;;;;;160:25:57;;;148:2;133:18;542:43:54;;;;;;;;2468:190;;;;;;;;;;-1:-1:-1;2468:190:54;;;;;:::i;:::-;;:::i;:::-;;1915:192;;;;;;;;;;;;;:::i;2293:101:0:-;;;;;;;;;;;;;:::i;3176:115:54:-;;;;;;;;;;;;;:::i;1638:85:0:-;;;;;;;;;;-1:-1:-1;1684:7:0;1710:6;-1:-1:-1;;;;;1710:6:0;1638:85;;;-1:-1:-1;;;;;545:32:57;;;527:51;;515:2;500:18;1638:85:0;381:203:57;591:54:54;;;;;;;;;;;;634:11;591:54;;439:26;;;;;;;;;;-1:-1:-1;439:26:54;;;;-1:-1:-1;;;;;439:26:54;;;2973:126;;;;;;;;;;-1:-1:-1;2973:126:54;;;;;:::i;:::-;;:::i;1074:763::-;;;:::i;2754:123::-;;;;;;;;;;-1:-1:-1;2754:123:54;;;;;:::i;:::-;;:::i;2214:154::-;;;;;;;;;;-1:-1:-1;2214:154:54;;;;;:::i;:::-;;:::i;2543:215:0:-;;;;;;;;;;-1:-1:-1;2543:215:0;;;;;:::i;:::-;;:::i;2468:190:54:-;1531:13:0;:11;:13::i;:::-;2543:9:54::1;::::0;-1:-1:-1;;;;;2543:9:54::1;:18;2562:7;1684::0::0;1710:6;-1:-1:-1;;;;;1710:6:0;;1638:85;2562:7:54::1;2543:35;::::0;-1:-1:-1;;;;;;2543:35:54::1;::::0;;;;;;-1:-1:-1;;;;;1299:32:57;;;2543:35:54::1;::::0;::::1;1281:51:57::0;1348:18;;;1341:34;;;1254:18;;2543:35:54::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2535:69;;;;-1:-1:-1::0;;;2535:69:54::1;;;;;;;:::i;:::-;;;;;;;;;1684:7:0::0;1710:6;-1:-1:-1;;;;;1710:6:0;-1:-1:-1;;;;;2619:32:54::1;;2644:6;2619:32;;;;160:25:57::0;;148:2;133:18;;14:177;2619:32:54::1;;;;;;;;2468:190:::0;:::o;1915:192::-;1531:13:0;:11;:13::i;:::-;1983:21:54::1;2022:11:::0;2014:42:::1;;;::::0;-1:-1:-1;;;2014:42:54;;2220:2:57;2014:42:54::1;::::0;::::1;2202:21:57::0;2259:2;2239:18;;;2232:30;-1:-1:-1;;;2278:18:57;;;2271:48;2336:18;;2014:42:54::1;2018:342:57::0;2014:42:54::1;1684:7:0::0;1710:6;;2066:34:54::1;::::0;-1:-1:-1;;;;;1710:6:0;;;;2066:34:54;::::1;;;::::0;2092:7;;2066:34;1684:7:0;2066:34:54;2092:7;1710:6:0;2066:34:54;::::1;;;;;;;;;;;;;::::0;::::1;;;;;;1955:152;1915:192::o:0;2293:101:0:-;1531:13;:11;:13::i;:::-;2357:30:::1;2384:1;2357:18;:30::i;:::-;2293:101::o:0;3176:115:54:-;3250:9;;:34;;-1:-1:-1;;;3250:34:54;;3278:4;3250:34;;;527:51:57;3224:7:54;;-1:-1:-1;;;;;3250:9:54;;:19;;500:18:57;;3250:34:54;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;3243:41;;3176:115;:::o;2973:126::-;3038:7;3064:28;582:3;3064:12;:28;:::i;:::-;3057:35;2973:126;-1:-1:-1;;2973:126:54:o;1074:763::-;3023:21:13;:19;:21::i;:::-;634:11:54::1;1141:9;:29;;1133:71;;;::::0;-1:-1:-1;;;1133:71:54;;2978:2:57;1133:71:54::1;::::0;::::1;2960:21:57::0;3017:2;2997:18;;;2990:30;3056:31;3036:18;;;3029:59;3105:18;;1133:71:54::1;2776:353:57::0;1133:71:54::1;1350:20;1373:25;582:3;1373:9;:25;:::i;:::-;1490:9;::::0;:34:::1;::::0;-1:-1:-1;;;1490:34:54;;1518:4:::1;1490:34;::::0;::::1;527:51:57::0;1350:48:54;;-1:-1:-1;1464:23:54::1;::::0;-1:-1:-1;;;;;1490:9:54;;::::1;::::0;:19:::1;::::0;500:18:57;;1490:34:54::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;1464:60;;1561:12;1542:15;:31;;1534:80;;;::::0;-1:-1:-1;;;1534:80:54;;3606:2:57;1534:80:54::1;::::0;::::1;3588:21:57::0;3645:2;3625:18;;;3618:30;3684:34;3664:18;;;3657:62;-1:-1:-1;;;3735:18:57;;;3728:34;3779:19;;1534:80:54::1;3404:400:57::0;1534:80:54::1;1684:9;::::0;:44:::1;::::0;-1:-1:-1;;;1684:44:54;;1703:10:::1;1684:44;::::0;::::1;1281:51:57::0;1348:18;;;1341:34;;;-1:-1:-1;;;;;1684:9:54;;::::1;::::0;:18:::1;::::0;1254::57;;1684:44:54::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;1676:78;;;;-1:-1:-1::0;;;1676:78:54::1;;;;;;;:::i;:::-;1778:52;::::0;;1806:9:::1;3983:25:57::0;;4039:2;4024:18;;4017:34;;;1794:10:54::1;::::0;1778:52:::1;::::0;3956:18:57;1778:52:54::1;;;;;;;1123:714;;3065:20:13::0;2365:1;1505:66;3972:62;3749:292;2754:123:54;2819:7;2845:25;582:3;2845:9;:25;:::i;2214:154::-;2278:9;;:57;;-1:-1:-1;;;2278:57:54;;2301:10;2278:57;;;4302:34:57;2321:4:54;4352:18:57;;;4345:43;4404:18;;;4397:34;;;-1:-1:-1;;;;;2278:9:54;;;;:22;;4237:18:57;;2278:57:54;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2270:91;;;;-1:-1:-1;;;2270:91:54;;;;;;;:::i;:::-;2214:154;:::o;2543:215:0:-;1531:13;:11;:13::i;:::-;-1:-1:-1;;;;;2627:22:0;::::1;2623:91;;2672:31;::::0;-1:-1:-1;;;2672:31:0;;2700:1:::1;2672:31;::::0;::::1;527:51:57::0;500:18;;2672:31:0::1;381:203:57::0;2623:91:0::1;2723:28;2742:8;2723:18;:28::i;1796:162::-:0;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;735:10:11;1855:23:0;1851:101;;1901:40;;-1:-1:-1;;;1901:40:0;;735:10:11;1901:40:0;;;527:51:57;500:18;;1901:40:0;381:203:57;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;3749:292:13:-;3872:25;:23;:25::i;:::-;2407:1;1505:66;3972:62;3749:292::o;3586:157::-;1505:66;4560:52;2407:1;4560:63;3644:93;;3696:30;;-1:-1:-1;;;3696:30:13;;;;;;;;;;;196:180:57;255:6;308:2;296:9;287:7;283:23;279:32;276:52;;;324:1;321;314:12;276:52;-1:-1:-1;347:23:57;;196:180;-1:-1:-1;196:180:57:o;816:286::-;875:6;928:2;916:9;907:7;903:23;899:32;896:52;;;944:1;941;934:12;896:52;970:23;;-1:-1:-1;;;;;1022:31:57;;1012:42;;1002:70;;1068:1;1065;1058:12;1002:70;1091:5;816:286;-1:-1:-1;;;816:286:57:o;1386:277::-;1453:6;1506:2;1494:9;1485:7;1481:23;1477:32;1474:52;;;1522:1;1519;1512:12;1474:52;1554:9;1548:16;1607:5;1600:13;1593:21;1586:5;1583:32;1573:60;;1629:1;1626;1619:12;1668:345;1870:2;1852:21;;;1909:2;1889:18;;;1882:30;-1:-1:-1;;;1943:2:57;1928:18;;1921:51;2004:2;1989:18;;1668:345::o;2365:184::-;2435:6;2488:2;2476:9;2467:7;2463:23;2459:32;2456:52;;;2504:1;2501;2494:12;2456:52;-1:-1:-1;2527:16:57;;2365:184;-1:-1:-1;2365:184:57:o;2554:217::-;2594:1;2620;2610:132;;2664:10;2659:3;2655:20;2652:1;2645:31;2699:4;2696:1;2689:15;2727:4;2724:1;2717:15;2610:132;-1:-1:-1;2756:9:57;;2554:217::o;3134:265::-;3207:9;;;3238;;3255:15;;;3249:22;;3235:37;3225:168;;3315:10;3310:3;3306:20;3303:1;3296:31;3350:4;3347:1;3340:15;3378:4;3375:1;3368:15","linkReferences":{}},"methodIdentifiers":{"EXCHANGE_RATE()":"14a8bd0d","MIN_PURCHASE_MNT()":"9a5ed738","buyTokens()":"d0febe4c","depositTokens(uint256)":"dd49756e","gameToken()":"c3dfdae6","getMntAmount(uint256)":"d0dea103","getTokenBalance()":"82b2e257","getTycoonAmount(uint256)":"d87810d6","owner()":"8da5cb5b","renounceOwnership()":"715018a6","transferOwnership(address)":"f2fde38b","withdrawMNT()":"6e5c0956","withdrawTokens(uint256)":"315a095d"},"rawMetadata":"{\"compiler\":{\"version\":\"0.8.24+commit.e11b9ed9\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_gameToken\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"OwnableInvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"OwnableUnauthorizedAccount\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"ReentrancyGuardReentrantCall\",\"type\":\"error\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"previousOwner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"OwnershipTransferred\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"buyer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"mntAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"tycoonAmount\",\"type\":\"uint256\"}],\"name\":\"TokensPurchased\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"TokensWithdrawn\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"EXCHANGE_RATE\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"MIN_PURCHASE_MNT\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"buyTokens\",\"outputs\":[],\"stateMutability\":\"payable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"depositTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"gameToken\",\"outputs\":[{\"internalType\":\"contract GameToken\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tycoonAmount\",\"type\":\"uint256\"}],\"name\":\"getMntAmount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getTokenBalance\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"mntAmount\",\"type\":\"uint256\"}],\"name\":\"getTycoonAmount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"renounceOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"transferOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"withdrawMNT\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"withdrawTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}],\"devdoc\":{\"details\":\"Exchange rate: 1 MNT = 100 TYCOON tokens\",\"errors\":{\"OwnableInvalidOwner(address)\":[{\"details\":\"The owner is not a valid owner account. (eg. `address(0)`)\"}],\"OwnableUnauthorizedAccount(address)\":[{\"details\":\"The caller account is not authorized to perform an operation.\"}],\"ReentrancyGuardReentrantCall()\":[{\"details\":\"Unauthorized reentrant call.\"}]},\"kind\":\"dev\",\"methods\":{\"buyTokens()\":{\"details\":\"Sends MNT to contract, transfers TYCOON tokens to buyer\"},\"owner()\":{\"details\":\"Returns the address of the current owner.\"},\"renounceOwnership()\":{\"details\":\"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner.\"},\"transferOwnership(address)\":{\"details\":\"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner.\"}},\"title\":\"TokenSwap\",\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{\"buyTokens()\":{\"notice\":\"Buy TYCOON tokens with MNT\"},\"depositTokens(uint256)\":{\"notice\":\"Owner can deposit TYCOON tokens to contract for users to purchase\"},\"getMntAmount(uint256)\":{\"notice\":\"Get the amount of MNT needed for a given TYCOON amount\"},\"getTokenBalance()\":{\"notice\":\"Get contract's TYCOON token balance\"},\"getTycoonAmount(uint256)\":{\"notice\":\"Get the amount of TYCOON tokens for a given MNT amount\"},\"withdrawMNT()\":{\"notice\":\"Owner can withdraw MNT from contract\"},\"withdrawTokens(uint256)\":{\"notice\":\"Owner can withdraw TYCOON tokens from contract (emergency)\"}},\"notice\":\"Allows users to buy TYCOON tokens with MNT\",\"version\":1}},\"settings\":{\"compilationTarget\":{\"src/TokenSwap.sol\":\"TokenSwap\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":true,\"runs\":200},\"remappings\":[\":@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/\",\":erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/\",\":forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/\",\":halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/\",\":openzeppelin-contracts/=lib/openzeppelin-contracts/\"]},\"sources\":{\"lib/openzeppelin-contracts/contracts/access/Ownable.sol\":{\"keccak256\":\"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6\",\"dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a\"]},\"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol\":{\"keccak256\":\"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c\",\"dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\":{\"keccak256\":\"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195\",\"dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\":{\"keccak256\":\"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303\",\"dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol\":{\"keccak256\":\"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e\",\"dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR\"]},\"lib/openzeppelin-contracts/contracts/utils/Context.sol\":{\"keccak256\":\"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12\",\"dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF\"]},\"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol\":{\"keccak256\":\"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99\",\"dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N\"]},\"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol\":{\"keccak256\":\"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b\",\"dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM\"]},\"src/GameToken.sol\":{\"keccak256\":\"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28\",\"dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35\"]},\"src/TokenSwap.sol\":{\"keccak256\":\"0x578684bf663eca8ac20f5408c76cca46342a32a32cb8e46fc93fee84aa8e26de\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://e0b77cca2265a4195c265d7e98581fb54060dd6024fc7cb208f396f72681f740\",\"dweb:/ipfs/QmYmBm4FxT8SJrUfC4C9UqxGLFMU9MJSv98G16ZWvgB7zY\"]}},\"version\":1}","metadata":{"compiler":{"version":"0.8.24+commit.e11b9ed9"},"language":"Solidity","output":{"abi":[{"inputs":[{"internalType":"address","name":"_gameToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"OwnableInvalidOwner"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"type":"error","name":"OwnableUnauthorizedAccount"},{"inputs":[],"type":"error","name":"ReentrancyGuardReentrantCall"},{"inputs":[{"internalType":"address","name":"previousOwner","type":"address","indexed":true},{"internalType":"address","name":"newOwner","type":"address","indexed":true}],"type":"event","name":"OwnershipTransferred","anonymous":false},{"inputs":[{"internalType":"address","name":"buyer","type":"address","indexed":true},{"internalType":"uint256","name":"mntAmount","type":"uint256","indexed":false},{"internalType":"uint256","name":"tycoonAmount","type":"uint256","indexed":false}],"type":"event","name":"TokensPurchased","anonymous":false},{"inputs":[{"internalType":"address","name":"to","type":"address","indexed":true},{"internalType":"uint256","name":"amount","type":"uint256","indexed":false}],"type":"event","name":"TokensWithdrawn","anonymous":false},{"inputs":[],"stateMutability":"view","type":"function","name":"EXCHANGE_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"MIN_PURCHASE_MNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"payable","type":"function","name":"buyTokens"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"depositTokens"},{"inputs":[],"stateMutability":"view","type":"function","name":"gameToken","outputs":[{"internalType":"contract GameToken","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"tycoonAmount","type":"uint256"}],"stateMutability":"pure","type":"function","name":"getMntAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"getTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"mntAmount","type":"uint256"}],"stateMutability":"pure","type":"function","name":"getTycoonAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"renounceOwnership"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"transferOwnership"},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"withdrawMNT"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"withdrawTokens"}],"devdoc":{"kind":"dev","methods":{"buyTokens()":{"details":"Sends MNT to contract, transfers TYCOON tokens to buyer"},"owner()":{"details":"Returns the address of the current owner."},"renounceOwnership()":{"details":"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner."},"transferOwnership(address)":{"details":"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner."}},"version":1},"userdoc":{"kind":"user","methods":{"buyTokens()":{"notice":"Buy TYCOON tokens with MNT"},"depositTokens(uint256)":{"notice":"Owner can deposit TYCOON tokens to contract for users to purchase"},"getMntAmount(uint256)":{"notice":"Get the amount of MNT needed for a given TYCOON amount"},"getTokenBalance()":{"notice":"Get contract's TYCOON token balance"},"getTycoonAmount(uint256)":{"notice":"Get the amount of TYCOON tokens for a given MNT amount"},"withdrawMNT()":{"notice":"Owner can withdraw MNT from contract"},"withdrawTokens(uint256)":{"notice":"Owner can withdraw TYCOON tokens from contract (emergency)"}},"version":1}},"settings":{"remappings":["@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/","erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/","forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/","halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/","openzeppelin-contracts/=lib/openzeppelin-contracts/"],"optimizer":{"enabled":true,"runs":200},"metadata":{"bytecodeHash":"ipfs"},"compilationTarget":{"src/TokenSwap.sol":"TokenSwap"},"evmVersion":"cancun","libraries":{}},"sources":{"lib/openzeppelin-contracts/contracts/access/Ownable.sol":{"keccak256":"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb","urls":["bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6","dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol":{"keccak256":"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998","urls":["bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c","dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol":{"keccak256":"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29","urls":["bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195","dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol":{"keccak256":"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2","urls":["bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303","dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol":{"keccak256":"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f","urls":["bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e","dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Context.sol":{"keccak256":"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2","urls":["bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12","dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol":{"keccak256":"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53","urls":["bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99","dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol":{"keccak256":"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97","urls":["bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b","dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM"],"license":"MIT"},"src/GameToken.sol":{"keccak256":"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169","urls":["bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28","dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35"],"license":"MIT"},"src/TokenSwap.sol":{"keccak256":"0x578684bf663eca8ac20f5408c76cca46342a32a32cb8e46fc93fee84aa8e26de","urls":["bzz-raw://e0b77cca2265a4195c265d7e98581fb54060dd6024fc7cb208f396f72681f740","dweb:/ipfs/QmYmBm4FxT8SJrUfC4C9UqxGLFMU9MJSv98G16ZWvgB7zY"],"license":"MIT"}},"version":1},"id":54}
</file>

<file path="backend/src/contracts/contracts.module.ts">
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ContractsService } from './contracts.service';
import { MantleModule } from '../mantle/mantle.module';

@Module({
  imports: [ConfigModule, MantleModule],
  providers: [ContractsService],
  exports: [ContractsService],
})
export class ContractsModule {}
</file>

<file path="backend/src/database/schema/index.ts">
export * from './users.schema';
export * from './properties.schema';
export * from './yield.schema';
export * from './marketplace.schema';
export * from './quests.schema';
export * from './leaderboard.schema';
export * from './chat.schema';
export * from './guilds.schema';
</file>

<file path="backend/src/database/schema/quests.schema.ts">
import { pgTable, uuid, bigint, timestamp, boolean, varchar, integer, numeric } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

export const quests = pgTable('quests', {
  id: uuid('id').defaultRandom().primaryKey(),
  questId: bigint('quest_id', { mode: 'number' }).notNull().unique(),
  name: varchar('name', { length: 200 }).notNull(),
  description: varchar('description', { length: 1000 }),
  rewardAmount: numeric('reward_amount').notNull(), // Use NUMERIC to handle large values
  requiredProperties: integer('required_properties').notNull(),
  requiredPropertyType: varchar('required_property_type', { length: 50 }),
  active: boolean('active').default(true).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const questProgress = pgTable('quest_progress', {
  id: uuid('id').defaultRandom().primaryKey(),
  questId: uuid('quest_id')
    .notNull()
    .references(() => quests.id, { onDelete: 'cascade' }),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  completed: boolean('completed').default(false).notNull(),
  progress: integer('progress').default(0).notNull(),
  rewardClaimed: boolean('reward_claimed').default(false).notNull(),
  completedAt: timestamp('completed_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type Quest = typeof quests.$inferSelect;
export type NewQuest = typeof quests.$inferInsert;
export type QuestProgress = typeof questProgress.$inferSelect;
export type NewQuestProgress = typeof questProgress.$inferInsert;
</file>

<file path="backend/src/database/schema/yield.schema.ts">
import { pgTable, uuid, bigint, timestamp, varchar, boolean } from 'drizzle-orm/pg-core';
import { properties } from './properties.schema';
import { users } from './users.schema';

export const yieldRecords = pgTable('yield_records', {
  id: uuid('id').defaultRandom().primaryKey(),
  propertyId: uuid('property_id')
    .notNull()
    .references(() => properties.id, { onDelete: 'cascade' }),
  ownerId: uuid('owner_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  amount: bigint('amount', { mode: 'bigint' }).notNull(),
  claimed: boolean('claimed').default(false).notNull(),
  transactionHash: varchar('transaction_hash', { length: 66 }),
  claimedAt: timestamp('claimed_at'),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export type YieldRecord = typeof yieldRecords.$inferSelect;
export type NewYieldRecord = typeof yieldRecords.$inferInsert;
</file>

<file path="backend/src/mantle/mantle-api.service.ts">
import { Injectable, Logger } from '@nestjs/common';

@Injectable()
export class MantleApiService {
  private readonly logger = new Logger(MantleApiService.name);
  private readonly rpcUrl: string;

  constructor() {
    this.rpcUrl = process.env.MANTLE_RPC_URL || 'https://rpc.mantle.xyz';
  }

  /**
   * Get block range using Mantle's custom eth_getBlockRange method
   * More efficient than multiple eth_getBlockByNumber calls
   */
  async getBlockRange(
    startBlock: number | string,
    endBlock: number | string,
    includeTransactions: boolean = false,
  ) {
    try {
      const startHex = typeof startBlock === 'number' 
        ? `0x${startBlock.toString(16)}` 
        : startBlock;
      const endHex = typeof endBlock === 'number' 
        ? `0x${endBlock.toString(16)}` 
        : endBlock;

      const response = await fetch(this.rpcUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'eth_getBlockRange',
          params: [startHex, endHex, includeTransactions],
          id: 1,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      return data.result;
    } catch (error) {
      this.logger.error('Failed to get block range', error);
      throw error;
    }
  }

  /**
   * Get rollup info using Mantle's custom rollup_getInfo method
   */
  async getRollupInfo() {
    try {
      const response = await fetch(this.rpcUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'rollup_getInfo',
          params: [],
          id: 1,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      return data.result;
    } catch (error) {
      this.logger.error('Failed to get rollup info', error);
      throw error;
    }
  }

  /**
   * Check if node is synced
   */
  async isNodeSynced(): Promise<boolean> {
    try {
      const info = await this.getRollupInfo();
      return !info.syncing;
    } catch (error) {
      this.logger.error('Failed to check node sync status', error);
      return false;
    }
  }

  /**
   * Get L1 block number from rollup info
   */
  async getL1BlockNumber(): Promise<number> {
    try {
      const info = await this.getRollupInfo();
      return info.ethContext?.blockNumber || 0;
    } catch (error) {
      this.logger.error('Failed to get L1 block number', error);
      return 0;
    }
  }

  /**
   * Get L2 transaction index
   */
  async getL2Index(): Promise<number> {
    try {
      const info = await this.getRollupInfo();
      return info.rollupContext?.index || 0;
    } catch (error) {
      this.logger.error('Failed to get L2 index', error);
      return 0;
    }
  }

  /**
   * Get L2 gas price
   */
  async getL2GasPrice(): Promise<bigint> {
    try {
      const response = await fetch(this.rpcUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'eth_gasPrice',
          params: [],
          id: 1,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      return BigInt(data.result);
    } catch (error) {
      this.logger.error('Failed to get L2 gas price', error);
      throw error;
    }
  }

  /**
   * Get L1 base fee
   */
  async getL1BaseFee(): Promise<bigint> {
    try {
      // Use GasPriceOracle contract address
      const gasPriceOracleAddress = '0x420000000000000000000000000000000000000F';
      const gasPriceOracleABI = [
        'function l1BaseFee() view returns (uint256)',
      ];

      const response = await fetch(this.rpcUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jsonrpc: '2.0',
          method: 'eth_call',
          params: [
            {
              to: gasPriceOracleAddress,
              data: '0x519b4bd3', // l1BaseFee() function selector
            },
            'latest',
          ],
          id: 1,
        }),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message);
      }

      return BigInt(data.result);
    } catch (error) {
      this.logger.error('Failed to get L1 base fee', error);
      throw error;
    }
  }
}
</file>

<file path="backend/src/mantle/mantle-gas.service.ts">
import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { ethers } from 'ethers';
import { MantleApiService } from './mantle-api.service';

/**
 * Service for optimizing gas usage on Mantle Network
 * Uses Mantle's GasPriceOracle and custom RPC methods
 */
@Injectable()
export class MantleGasService {
  private readonly logger = new Logger(MantleGasService.name);
  private readonly gasPriceOracleAddress = '0x420000000000000000000000000000000000000F';
  private provider: ethers.providers.JsonRpcProvider;
  private gasPriceOracle: ethers.Contract;

  constructor(
    private configService: ConfigService,
    private mantleApiService: MantleApiService,
  ) {
    this.initializeGasOracle();
  }

  private initializeGasOracle() {
    const rpcUrl = this.configService.get<string>('MANTLE_RPC_URL');
    if (!rpcUrl) {
      this.logger.warn('MANTLE_RPC_URL not set, gas optimization disabled');
      return;
    }

    this.provider = new ethers.providers.JsonRpcProvider(rpcUrl);
    
    // GasPriceOracle ABI
    const gasPriceOracleABI = [
      'function l1BaseFee() view returns (uint256)',
      'function gasPrice() view returns (uint256)',
      'function getL1GasUsed(bytes memory _data) view returns (uint256)',
      'function getL1Fee(bytes memory _data) view returns (uint256)',
    ];

    this.gasPriceOracle = new ethers.Contract(
      this.gasPriceOracleAddress,
      gasPriceOracleABI,
      this.provider,
    );
  }

  /**
   * Get optimized gas price for Mantle L2 transactions
   * Returns both L1 base fee and L2 gas price
   */
  async getOptimizedGasPrice(): Promise<{
    l1BaseFee: bigint;
    l2GasPrice: bigint;
    totalEstimate: bigint;
  }> {
    try {
      const l1BaseFee = await this.gasPriceOracle.l1BaseFee();
      const l2GasPrice = await this.gasPriceOracle.gasPrice();
      
      // Estimate total cost (simplified - actual cost depends on transaction data)
      const totalEstimate = l1BaseFee.add(l2GasPrice);

      return {
        l1BaseFee: BigInt(l1BaseFee.toString()),
        l2GasPrice: BigInt(l2GasPrice.toString()),
        totalEstimate: BigInt(totalEstimate.toString()),
      };
    } catch (error) {
      this.logger.error('Failed to get optimized gas price', error);
      throw error;
    }
  }

  /**
   * Estimate L1 fee for a transaction
   * Useful for calculating total cost of cross-chain operations
   */
  async estimateL1Fee(transactionData: string): Promise<bigint> {
    try {
      const l1Fee = await this.gasPriceOracle.getL1Fee(transactionData);
      return BigInt(l1Fee.toString());
    } catch (error) {
      this.logger.error('Failed to estimate L1 fee', error);
      throw error;
    }
  }

  /**
   * Get formatted gas prices for display
   */
  async getFormattedGasPrices() {
    try {
      const gasPrices = await this.getOptimizedGasPrice();
      
      return {
        l1BaseFee: {
          wei: gasPrices.l1BaseFee.toString(),
          gwei: ethers.utils.formatUnits(gasPrices.l1BaseFee.toString(), 'gwei'),
          ether: ethers.utils.formatEther(gasPrices.l1BaseFee.toString()),
        },
        l2GasPrice: {
          wei: gasPrices.l2GasPrice.toString(),
          gwei: ethers.utils.formatUnits(gasPrices.l2GasPrice.toString(), 'gwei'),
          ether: ethers.utils.formatEther(gasPrices.l2GasPrice.toString()),
        },
        totalEstimate: {
          wei: gasPrices.totalEstimate.toString(),
          gwei: ethers.utils.formatUnits(gasPrices.totalEstimate.toString(), 'gwei'),
          ether: ethers.utils.formatEther(gasPrices.totalEstimate.toString()),
        },
      };
    } catch (error) {
      this.logger.error('Failed to get formatted gas prices', error);
      throw error;
    }
  }

  /**
   * Check if Mantle node is synced before submitting transactions
   */
  async isNodeReady(): Promise<boolean> {
    try {
      return await this.mantleApiService.isNodeSynced();
    } catch (error) {
      this.logger.error('Failed to check node sync status', error);
      return false;
    }
  }
}
</file>

<file path="backend/src/mantle/mantle.module.ts">
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { MantleSdkService } from './mantle-sdk.service';
import { OracleService } from './oracle.service';
import { MantleApiService } from './mantle-api.service';
import { MantleGasService } from './mantle-gas.service';
import { OracleController } from './oracle.controller';
import { PriceUpdateService } from './price-update.service';
import { MultiRpcService } from './multi-rpc.service';

@Module({
  imports: [ConfigModule],
  controllers: [OracleController],
  providers: [
    MantleSdkService,
    OracleService,
    MantleApiService,
    MantleGasService,
    PriceUpdateService,
    MultiRpcService,
  ],
  exports: [MantleSdkService, OracleService, MantleApiService, MantleGasService, MultiRpcService],
})
export class MantleModule {}
</file>

<file path="backend/src/mantle/multi-rpc.service.ts">
import { Injectable, Logger } from '@nestjs/common';
import { ethers } from 'ethers';

/**
 * Multi-RPC Provider Service
 * Automatically fails over to backup RPC endpoints when primary fails
 */
@Injectable()
export class MultiRpcService {
  private readonly logger = new Logger(MultiRpcService.name);
  private providers: ethers.providers.JsonRpcProvider[] = [];
  private currentProviderIndex: number = 0;
  private readonly rpcEndpoints: string[];

  constructor() {
    // Mantle Sepolia Testnet RPC endpoints (in priority order)
    // Can be overridden via MANTLE_RPC_URLS env var (comma-separated)
    const customRpcUrls = process.env.MANTLE_RPC_URLS;
    
    if (customRpcUrls) {
      this.rpcEndpoints = customRpcUrls.split(',').map(url => url.trim()).filter(url => url.length > 0);
      this.logger.log(`Using custom RPC endpoints from MANTLE_RPC_URLS: ${this.rpcEndpoints.length} endpoints`);
    } else {
      // Default fallback chain for Mantle Sepolia Testnet
      this.rpcEndpoints = [
        process.env.MANTLE_RPC_URL || 'https://rpc.sepolia.mantle.xyz', // Official (primary)
        'https://rpc.ankr.com/mantle_sepolia', // Ankr (backup 1)
        'https://mantle-sepolia.drpc.org', // DRPC (backup 2)
        'https://rpc.sepolia.mantle.xyz', // Official (fallback)
      ];
      this.logger.log(`Using default RPC endpoints: ${this.rpcEndpoints.length} endpoints`);
    }

    // Initialize all providers
    this.providers = this.rpcEndpoints.map((url, index) => {
      const provider = new ethers.providers.JsonRpcProvider(url);
      this.logger.log(`Initialized RPC provider ${index + 1}/${this.rpcEndpoints.length}: ${url}`);
      return provider;
    });

    if (this.providers.length === 0) {
      throw new Error('No RPC endpoints configured');
    }
  }

  /**
   * Get the current active provider
   */
  getProvider(): ethers.providers.JsonRpcProvider {
    return this.providers[this.currentProviderIndex];
  }

  /**
   * Execute a function with automatic RPC failover
   * Tries each RPC endpoint in order until one succeeds
   */
  async executeWithFailover<T>(
    operation: (provider: ethers.providers.JsonRpcProvider) => Promise<T>,
    operationName: string = 'operation',
  ): Promise<T> {
    const startIndex = this.currentProviderIndex;
    let lastError: Error | null = null;

    // Try all providers starting from current
    for (let attempt = 0; attempt < this.providers.length; attempt++) {
      const providerIndex = (startIndex + attempt) % this.providers.length;
      const provider = this.providers[providerIndex];
      const rpcUrl = this.rpcEndpoints[providerIndex];

      try {
        const result = await operation(provider);
        
        // If successful and we switched providers, log it
        if (providerIndex !== this.currentProviderIndex) {
          this.currentProviderIndex = providerIndex;
          this.logger.log(` Switched to RPC endpoint ${providerIndex + 1}/${this.rpcEndpoints.length}: ${rpcUrl}`);
        }
        
        return result;
      } catch (error: any) {
        lastError = error;
        const errorMsg = error.message || error.toString();
        
        // Log the failure but continue to next provider
        this.logger.warn(
          ` RPC endpoint ${providerIndex + 1}/${this.rpcEndpoints.length} failed for ${operationName}: ${errorMsg.substring(0, 100)}`,
        );
        
        // If this was the current provider, switch to next
        if (providerIndex === this.currentProviderIndex) {
          this.currentProviderIndex = (this.currentProviderIndex + 1) % this.providers.length;
          this.logger.log(
            ` Failing over to RPC endpoint ${this.currentProviderIndex + 1}/${this.rpcEndpoints.length}: ${this.rpcEndpoints[this.currentProviderIndex]}`,
          );
        }
      }
    }

    // All providers failed
    this.logger.error(` All ${this.providers.length} RPC endpoints failed for ${operationName}`);
    throw lastError || new Error(`All RPC endpoints failed for ${operationName}`);
  }

  /**
   * Test connectivity to all RPC endpoints
   */
  async testConnectivity(): Promise<void> {
    this.logger.log('Testing RPC endpoint connectivity...');
    
    for (let i = 0; i < this.providers.length; i++) {
      const provider = this.providers[i];
      const rpcUrl = this.rpcEndpoints[i];
      
      try {
        const blockNumber = await provider.getBlockNumber();
        this.logger.log(` RPC ${i + 1}/${this.providers.length} (${rpcUrl}): Connected - Block #${blockNumber}`);
      } catch (error: any) {
        this.logger.warn(` RPC ${i + 1}/${this.providers.length} (${rpcUrl}): Failed - ${error.message}`);
      }
    }
  }

  /**
   * Get current RPC endpoint URL
   */
  getCurrentRpcUrl(): string {
    return this.rpcEndpoints[this.currentProviderIndex];
  }

  /**
   * Get all RPC endpoint URLs
   */
  getAllRpcUrls(): string[] {
    return [...this.rpcEndpoints];
  }
}
</file>

<file path="backend/src/mantle/oracle.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { OracleService } from './oracle.service';

@Controller('api/oracle')
export class OracleController {
  constructor(private readonly oracleService: OracleService) {}

  @Get('mnt-price')
  async getMNTPrice() {
    try {
      const price = await this.oracleService.getMNTPrice();
      // Convert BigInt to string for JSON response
      const priceString = price.toString();
      // Convert from wei (18 decimals) to USD
      const priceInUSD = Number(price) / 1e18;
      // TYCOON/USD = MNT/USD / 100 (since 1 MNT = 100 TYCOON)
      const tycoonPriceUSD = priceInUSD / 100;

      return {
        success: true,
        mntPriceUSD: priceInUSD,
        tycoonPriceUSD: tycoonPriceUSD,
        priceWei: priceString,
        timestamp: Date.now(),
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'Failed to fetch MNT price',
        // Fallback price (approximate MNT price as of Dec 2025)
        mntPriceUSD: 0.98,
        tycoonPriceUSD: 0.0098,
        timestamp: Date.now(),
      };
    }
  }
}
</file>

<file path="backend/src/mantle/price-update.service.ts">
import { Injectable, Logger, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { OracleService } from './oracle.service';
import { WebsocketGateway } from '../websocket/websocket.gateway';

@Injectable()
export class PriceUpdateService implements OnModuleInit, OnModuleDestroy {
  private readonly logger = new Logger(PriceUpdateService.name);
  private priceUpdateInterval: NodeJS.Timeout | null = null;
  
  // Update price every 5 minutes (300000 ms)
  private readonly UPDATE_INTERVAL_MS = 5 * 60 * 1000;

  constructor(
    private readonly oracleService: OracleService,
    private readonly websocketGateway: WebsocketGateway,
  ) {}

  async onModuleInit() {
    this.logger.log(' Starting price update service...');
    // Fetch and broadcast initial price (with small delay to ensure gateway is ready)
    setTimeout(async () => {
      await this.broadcastPriceUpdate();
    }, 2000);
    // Set up periodic updates
    this.priceUpdateInterval = setInterval(() => {
      this.broadcastPriceUpdate();
    }, this.UPDATE_INTERVAL_MS);
    this.logger.log(` Price updates will be broadcast every ${this.UPDATE_INTERVAL_MS / 1000} seconds`);
  }

  onModuleDestroy() {
    if (this.priceUpdateInterval) {
      clearInterval(this.priceUpdateInterval);
      this.logger.log('Price update service stopped');
    }
  }

  private async broadcastPriceUpdate() {
    try {
      const price = await this.oracleService.getMNTPrice();
      // Convert BigInt to number
      const priceInUSD = Number(price) / 1e18;
      // TYCOON/USD = MNT/USD / 100 (since 1 MNT = 100 TYCOON)
      const tycoonPriceUSD = priceInUSD / 100;

      const priceData = {
        mntPriceUSD: priceInUSD,
        tycoonPriceUSD: tycoonPriceUSD,
        timestamp: Date.now(),
      };

      // Broadcast to all connected clients via Socket.io
      this.websocketGateway.emitPriceUpdate(priceData);
      this.logger.log(` Broadcasted price update: MNT/USD = $${priceInUSD.toFixed(4)}, TYCOON/USD = $${tycoonPriceUSD.toFixed(6)}`);
    } catch (error: any) {
      this.logger.warn(` Failed to fetch price for broadcast: ${error.message}`);
      // Use fallback price
      const fallbackPrice = 0.98;
      const fallbackTycoonPrice = fallbackPrice / 100;
      this.websocketGateway.emitPriceUpdate({
        mntPriceUSD: fallbackPrice,
        tycoonPriceUSD: fallbackTycoonPrice,
        timestamp: Date.now(),
      });
      this.logger.log(` Broadcasted fallback price: MNT/USD = $${fallbackPrice.toFixed(4)}, TYCOON/USD = $${fallbackTycoonPrice.toFixed(6)}`);
    }
  }
}
</file>

<file path="backend/src/marketplace/marketplace.controller.ts">
import { Controller, Get, Param, Post } from '@nestjs/common';
import { MarketplaceService } from './marketplace.service';

@Controller('marketplace')
export class MarketplaceController {
  constructor(private readonly marketplaceService: MarketplaceService) {}

  @Get('listings')
  getActiveListings() {
    return this.marketplaceService.getActiveListings();
  }

  @Post('sync')
  async syncListings() {
    return this.marketplaceService.syncListingsFromBlockchain();
  }

  @Get('debug')
  async debugMarketplace() {
    return this.marketplaceService.debugMarketplaceState();
  }

  @Get('listing/:id')
  getListing(@Param('id') id: string) {
    return this.marketplaceService.getListing(Number(id));
  }
}
</file>

<file path="backend/src/marketplace/marketplace.module.ts">
import { Module } from '@nestjs/common';
import { MarketplaceService } from './marketplace.service';
import { MarketplaceController } from './marketplace.controller';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';
import { PropertiesModule } from '../properties/properties.module';

@Module({
  imports: [DatabaseModule, ContractsModule, PropertiesModule],
  controllers: [MarketplaceController],
  providers: [MarketplaceService],
  exports: [MarketplaceService],
})
export class MarketplaceModule {}
</file>

<file path="backend/src/quests/quests.controller.ts">
import { Controller, Get, Post, Param, Query, Body } from '@nestjs/common';
import { QuestsService } from './quests.service';

@Controller('quests')
export class QuestsController {
  constructor(private readonly questsService: QuestsService) {}

  @Get()
  findAll(@Query('address') address?: string) {
    return this.questsService.findAll(address);
  }

  @Get('sync')
  async syncQuests() {
    await this.questsService.syncQuestsFromContract();
    return { message: 'Quests synced from contract' };
  }

  @Get('progress/:address')
  getQuestProgress(@Param('address') address: string) {
    return this.questsService.getQuestProgress(address);
  }

  @Get('check/:address/:questId')
  checkQuestCompletion(@Param('address') address: string, @Param('questId') questId: string) {
    return this.questsService.checkQuestCompletion(address, Number(questId));
  }

  @Get('sync-progress/:address')
  async syncProgress(@Param('address') address: string) {
    await this.questsService.syncQuestProgressForUser(address);
    return { message: 'Quest progress synced from contract' };
  }

  @Post(':id/claim')
  async claimQuest(@Param('id') id: string, @Body() body: { address: string }) {
    return this.questsService.claimQuest(body.address, Number(id));
  }

  @Get(':id')
  getQuest(@Param('id') id: string) {
    return this.questsService.getQuest(Number(id));
  }
}
</file>

<file path="backend/src/quests/quests.service.ts">
import { Injectable, Logger, Inject, OnModuleInit } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, sql, and } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';

@Injectable()
export class QuestsService implements OnModuleInit {
  private readonly logger = new Logger(QuestsService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
  ) {}

  async onModuleInit() {
    // Wait for database and contracts to initialize
    setTimeout(async () => {
      try {
        // Check if quests table exists by trying a simple query with Drizzle
        const existingQuests = await this.db.select({ count: sql<number>`count(*)::int` }).from(schema.quests);
        const count = existingQuests[0]?.count || 0;
        
        if (count === 0) {
          this.logger.log('No quests in database, syncing from contract on startup...');
          await this.syncQuestsFromContract();
        } else {
          this.logger.log(`Found ${count} quest(s) in database`);
        }
      } catch (error: any) {
        // If table doesn't exist or connection issue, log and continue
        if (error.message?.includes('does not exist') || error.message?.includes('relation') || error.code === '42P01') {
          this.logger.warn('Quests table may not exist yet. Run "npm run db:init" to initialize database tables.');
        } else {
          this.logger.warn('Could not check quests on startup:', error.message);
        }
      }
    }, 5000); // Wait 5 seconds for database and contracts to initialize
  }

  async findAll(walletAddress?: string) {
    try {
      // First, try to sync quests from contract if database is empty
      const existingQuests = await this.db.select().from(schema.quests).limit(1);
      if (existingQuests.length === 0) {
        this.logger.log('No quests in database, syncing from contract...');
        await this.syncQuestsFromContract();
        // Try to get quests again after sync
        const questsAfterSync = await this.db.select().from(schema.quests).where(eq(schema.quests.active, true));
        return this.formatQuestsForFrontend(questsAfterSync, walletAddress);
      }
      
      const quests = await this.db.select().from(schema.quests).where(eq(schema.quests.active, true));
      return this.formatQuestsForFrontend(quests, walletAddress);
    } catch (error: any) {
      this.logger.error(`Error fetching quests: ${error.message}`);
      // Return empty array if table doesn't exist yet or other error
      if (error.message?.includes('does not exist') || error.message?.includes('relation') || error.code === '42P01') {
        this.logger.warn('Quests table does not exist. Please run "npm run db:init" to initialize database.');
        return [];
      }
      // For other errors, try to sync and return empty array
      this.logger.warn('Error fetching quests, attempting sync...');
      try {
        await this.syncQuestsFromContract();
        const quests = await this.db.select().from(schema.quests).where(eq(schema.quests.active, true));
        return this.formatQuestsForFrontend(quests, walletAddress);
      } catch (syncError: any) {
        this.logger.error('Sync also failed:', syncError.message);
        return [];
      }
    }
  }

  async formatQuestsForFrontend(quests: any[], walletAddress?: string) {
    if (!walletAddress) {
      // Return quests without progress if no wallet address
      return quests.map(q => ({
        id: q.id,
        questId: q.questId,
        title: q.name,
        description: q.description,
        reward: q.rewardAmount?.toString() || '0', // Return as string for JSON serialization
        progress: 0,
        target: q.requiredProperties || 1,
        completed: false,
        type: this.getQuestType(q.questId),
      }));
    }

    // Get user's quest progress
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      // User doesn't exist yet, return quests without progress
      return quests.map(q => ({
        id: q.id,
        questId: q.questId,
        title: q.name,
        description: q.description,
        reward: q.rewardAmount?.toString() || '0', // Return as string for JSON serialization
        progress: 0,
        target: q.requiredProperties || 1,
        completed: false,
        type: this.getQuestType(q.questId),
      }));
    }

    // Get quest progress from database
    const progressRecords = await this.db
      .select()
      .from(schema.questProgress)
      .where(eq(schema.questProgress.userId, user.id));

    // Also check contract for completion status
    const progressMap = new Map<string, { completed: boolean; progress: number }>();
    
    for (const progress of progressRecords) {
      const [quest] = await this.db
        .select()
        .from(schema.quests)
        .where(eq(schema.quests.id, progress.questId))
        .limit(1);
      if (quest) {
        progressMap.set(quest.questId.toString(), {
          completed: progress.completed,
          progress: progress.progress || 0,
        });
      }
    }

    // Check contract for completion status (in case database is out of sync)
    for (const quest of quests) {
      try {
        const contractCompleted = await this.contractsService.hasCompletedQuest(walletAddress, quest.questId);
        if (contractCompleted) {
          const existing = progressMap.get(quest.questId.toString());
          if (!existing || !existing.completed) {
            progressMap.set(quest.questId.toString(), {
              completed: true,
              progress: 100,
            });
          }
        }
      } catch (error) {
        // Ignore errors checking contract
      }
    }

    // Format quests with progress
    return quests.map(q => {
      const progress = progressMap.get(q.questId.toString()) || { completed: false, progress: 0 };
      return {
        id: q.id,
        questId: q.questId,
        title: q.name,
        description: q.description,
        reward: q.rewardAmount?.toString() || '0', // Return as string for JSON serialization
        progress: progress.progress,
        target: q.requiredProperties || 1,
        completed: progress.completed,
        type: this.getQuestType(q.questId),
      };
    });
  }

  private getQuestType(questId: number): 'diversify' | 'yield' | 'properties' | 'guild' {
    switch (questId) {
      case 0: return 'properties'; // First Property
      case 1: return 'diversify'; // Diversify Portfolio
      case 2: return 'yield'; // Yield Master
      case 3: return 'properties'; // Property Mogul
      case 4: return 'guild'; // RWA Pioneer
      default: return 'properties';
    }
  }

  async syncQuestsFromContract() {
    try {
      if (!this.contractsService.questSystem) {
        this.logger.error('QuestSystem contract not initialized');
        return;
      }

      this.logger.log('Syncing quests from QuestSystem contract...');
      
      // Quest types: 0=FirstProperty, 1=DiversifyPortfolio, 2=YieldMaster, 3=PropertyMogul, 4=RWAPioneer
      const questTypes = [0, 1, 2, 3, 4];
      const questNames = [
        'First Property',
        'Diversify Portfolio',
        'Yield Master',
        'Property Mogul',
        'RWA Pioneer'
      ];
      const questDescriptions = [
        'Mint your first property',
        'Own 3 different property types',
        'Collect yield 7 days in a row',
        'Own 10 properties',
        'Link 5 properties to RWA'
      ];

      for (let i = 0; i < questTypes.length; i++) {
        try {
          const contractQuestData = await this.contractsService.getQuest(questTypes[i]);
          
          // contractQuestData is a tuple: [questType, name, description, reward, isActive]
          const questType = questTypes[i];
          const name = questNames[i]; // Use our names since contract might not return string properly
          const description = questDescriptions[i];
          const reward = contractQuestData.reward?.toString() || contractQuestData[3]?.toString() || '0';
          const isActive = contractQuestData.isActive !== undefined ? contractQuestData.isActive : contractQuestData[4] !== undefined ? contractQuestData[4] : true;

          // Check if quest already exists
          const [existing] = await this.db
            .select()
            .from(schema.quests)
            .where(eq(schema.quests.questId, questType))
            .limit(1);

          const questDataToSave = {
            questId: questType,
            name: name,
            description: description,
            rewardAmount: reward, // Store as string for NUMERIC type
            requiredProperties: questType === 3 ? 10 : questType === 0 ? 1 : 0, // PropertyMogul needs 10, FirstProperty needs 1
            active: isActive,
            updatedAt: new Date(),
          };

          if (existing) {
            // Update existing quest
            await this.db
              .update(schema.quests)
              .set(questDataToSave)
              .where(eq(schema.quests.questId, questType));
            this.logger.log(`Updated quest ${questType}: ${name}`);
          } else {
            // Insert new quest using raw SQL with NUMERIC for large values
            const requiredProps = questType === 3 ? 10 : questType === 0 ? 1 : 0;
            
            try {
              await this.db.execute(sql`
                INSERT INTO quests (quest_id, name, description, reward_amount, required_properties, active, created_at, updated_at)
                VALUES (${questType}::bigint, ${name}, ${description || null}, ${reward}::numeric, ${requiredProps}, ${isActive}, NOW(), NOW())
                ON CONFLICT (quest_id) DO UPDATE SET
                  name = EXCLUDED.name,
                  description = EXCLUDED.description,
                  reward_amount = EXCLUDED.reward_amount,
                  required_properties = EXCLUDED.required_properties,
                  active = EXCLUDED.active,
                  updated_at = NOW()
              `);
              this.logger.log(`Inserted/Updated quest ${questType}: ${name}`);
            } catch (sqlError: any) {
              // Fallback to Drizzle if raw SQL fails
              this.logger.warn(`Raw SQL insert failed, trying Drizzle: ${sqlError.message}`);
              const insertData = {
                questId: questType,
                name: name,
                description: description || null,
                rewardAmount: reward, // Store as string for NUMERIC
                requiredProperties: requiredProps,
                active: isActive,
                createdAt: new Date(),
                updatedAt: new Date(),
              };
              await this.db.insert(schema.quests).values(insertData);
              this.logger.log(`Inserted quest ${questType} via Drizzle: ${name}`);
            }
          }
        } catch (error: any) {
          this.logger.error(`Error syncing quest ${questTypes[i]}: ${error.message}`);
          this.logger.error(`Error details:`, {
            code: error.code,
            detail: error.detail,
            hint: error.hint,
            constraint: error.constraint,
            table: error.table,
            column: error.column,
          });
        }
      }

      this.logger.log(' Quest sync complete');
    } catch (error) {
      this.logger.error(`Error syncing quests from contract: ${error.message}`);
    }
  }

  async getQuest(questId: number) {
    try {
      // Get quest from contract by quest type (0-4)
      const questData = await this.contractsService.getQuest(questId);
      
      // Also get from database if exists
      const [dbQuest] = await this.db
        .select()
        .from(schema.quests)
        .where(eq(schema.quests.questId, questId))
        .limit(1);

      // Serialize BigInt values in contractData
      const serializedContractData = this.serializeBigInts(questData);
      const serializedDbQuest = dbQuest ? this.serializeBigInts(dbQuest) : null;

      return {
        contractData: serializedContractData,
        dbData: serializedDbQuest,
      };
    } catch (error) {
      this.logger.error(`Error getting quest: ${error.message}`);
      throw error;
    }
  }

  // Helper to recursively convert BigInt values to strings for JSON serialization
  private serializeBigInts(obj: any): any {
    if (obj === null || obj === undefined) {
      return obj;
    }
    
    if (typeof obj === 'bigint') {
      return obj.toString();
    }
    
    if (Array.isArray(obj)) {
      return obj.map(item => this.serializeBigInts(item));
    }
    
    if (typeof obj === 'object') {
      const result: any = {};
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          result[key] = this.serializeBigInts(obj[key]);
        }
      }
      return result;
    }
    
    return obj;
  }

  async getQuestProgress(walletAddress: string) {
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      return [];
    }

    return this.db
      .select()
      .from(schema.questProgress)
      .where(eq(schema.questProgress.userId, user.id));
  }

  async checkQuestCompletion(walletAddress: string, questType: number) {
    try {
      const completed = await this.contractsService.hasCompletedQuest(walletAddress, questType);
      return { completed, questType };
    } catch (error) {
      this.logger.error(`Error checking quest completion: ${error.message}`);
      throw error;
    }
  }

  async syncQuestProgressForUser(walletAddress: string) {
    try {
      if (!this.contractsService.questSystem) {
        this.logger.error('QuestSystem contract not initialized');
        return;
      }

      // Get or create user
      let [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
        .limit(1);

      if (!user) {
        [user] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: walletAddress.toLowerCase(),
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      // Get all quests
      const quests = await this.db.select().from(schema.quests).where(eq(schema.quests.active, true));

      // Check completion status for each quest from contract
      for (const quest of quests) {
        try {
          const completed = await this.contractsService.hasCompletedQuest(walletAddress, quest.questId);
          
          // Get or create quest progress
          const [existingProgress] = await this.db
            .select()
            .from(schema.questProgress)
            .where(
              and(
                eq(schema.questProgress.userId, user.id),
                eq(schema.questProgress.questId, quest.id)
              )
            )
            .limit(1);

          if (existingProgress) {
            // Update existing progress
            await this.db
              .update(schema.questProgress)
              .set({
                completed: completed,
                progress: completed ? 100 : existingProgress.progress,
                updatedAt: new Date(),
                completedAt: completed && !existingProgress.completedAt ? new Date() : existingProgress.completedAt,
              })
              .where(eq(schema.questProgress.id, existingProgress.id));
          } else {
            // Create new progress entry
            await this.db.insert(schema.questProgress).values({
              questId: quest.id,
              userId: user.id,
              completed: completed,
              progress: completed ? 100 : 0,
              rewardClaimed: completed, // If completed, reward was already minted
              completedAt: completed ? new Date() : null,
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          }
        } catch (error: any) {
          this.logger.error(`Error syncing quest ${quest.questId} progress: ${error.message}`);
        }
      }

      this.logger.log(`Quest progress synced for user ${walletAddress}`);
    } catch (error: any) {
      this.logger.error(`Error syncing quest progress: ${error.message}`);
      throw error;
    }
  }

  async claimQuest(walletAddress: string, questType: number) {
    try {
      if (!this.contractsService.questSystem) {
        throw new Error('QuestSystem contract not initialized');
      }

      this.logger.log(`Claiming quest ${questType} for ${walletAddress}`);

      // Call the appropriate check function based on quest type
      let tx: any;
      switch (questType) {
        case 0: // FirstProperty
          tx = await this.contractsService.questSystem.checkFirstPropertyQuest(walletAddress);
          break;
        case 1: // DiversifyPortfolio
          tx = await this.contractsService.questSystem.checkDiversifyPortfolioQuest(walletAddress);
          break;
        case 2: // YieldMaster - not implemented in contract yet
          throw new Error('YieldMaster quest not yet implemented in contract');
        case 3: // PropertyMogul
          tx = await this.contractsService.questSystem.checkPropertyMogulQuest(walletAddress);
          break;
        case 4: // RWAPioneer
          tx = await this.contractsService.questSystem.checkRWAPioneerQuest(walletAddress);
          break;
        default:
          throw new Error(`Invalid quest type: ${questType}`);
      }

      // Wait for transaction to be mined
      const receipt = await tx.wait();
      this.logger.log(`Quest ${questType} claimed successfully. Tx: ${receipt.transactionHash}`);

      // Sync quest progress after claiming
      await this.syncQuestProgressForUser(walletAddress);

      return {
        success: true,
        transactionHash: receipt.transactionHash,
        questType,
      };
    } catch (error: any) {
      this.logger.error(`Error claiming quest ${questType}: ${error.message}`);
      throw error;
    }
  }
}
</file>

<file path="backend/src/websocket/websocket.module.ts">
import { Module, Global } from '@nestjs/common';
import { WebsocketGateway } from './websocket.gateway';

@Global()
@Module({
  providers: [WebsocketGateway],
  exports: [WebsocketGateway],
})
export class WebsocketModule {}
</file>

<file path="backend/src/yield/yield.controller.ts">
import { Controller, Get, Post, Param, Query } from '@nestjs/common';
import { YieldService } from './yield.service';

@Controller('yield')
export class YieldController {
  constructor(private readonly yieldService: YieldService) {}

  @Get('pending/:address')
  getPendingYield(@Param('address') address: string) {
    return this.yieldService.getPendingYield(address);
  }

  @Get('property/:propertyId')
  getPropertyYield(@Param('propertyId') propertyId: string) {
    return this.yieldService.getPropertyYield(Number(propertyId));
  }

  @Get('calculate/:propertyId')
  calculateYield(@Param('propertyId') propertyId: string, @Query('days') days?: string) {
    return this.yieldService.calculateYieldWithOracle(propertyId, days ? Number(days) : 1);
  }

  @Get('history/:address')
  getYieldHistory(@Param('address') address: string) {
    return this.yieldService.getYieldHistory(address);
  }

  @Get('time/:address')
  getYieldTimeInfo(@Param('address') address: string) {
    return this.yieldService.getYieldTimeInfo(address);
  }

  @Post('time/:address/broadcast')
  async broadcastYieldTimeUpdate(@Param('address') address: string) {
    const success = await this.yieldService.broadcastYieldTimeUpdateForUser(address);
    if (!success) {
      throw new Error(`Failed to broadcast yield time update for ${address}`);
    }
    return { success: true, message: `Broadcasted yield time update for ${address}` };
  }
}
</file>

<file path="backend/src/yield/yield.module.ts">
import { Module } from '@nestjs/common';
import { YieldService } from './yield.service';
import { YieldController } from './yield.controller';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';
import { MantleModule } from '../mantle/mantle.module';
import { WebsocketGateway } from '../websocket/websocket.gateway';

@Module({
  imports: [DatabaseModule, ContractsModule, MantleModule],
  controllers: [YieldController],
  providers: [YieldService, WebsocketGateway],
  exports: [YieldService],
})
export class YieldModule {}
</file>

<file path="CHECK_LINK.sh">
#!/bin/bash
# Quick script to check if a property is linked to RWA on-chain

PROPERTY_ID=${1:-1}
PROPERTY_NFT="0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c"
RPC_URL="https://rpc.sepolia.mantle.xyz"

echo "Checking Property #$PROPERTY_ID..."
echo ""

# Check if property is linked
echo "=== On-Chain Link Status ==="
cast call $PROPERTY_NFT "getProperty(uint256)" $PROPERTY_ID --rpc-url $RPC_URL | grep -E "rwaContract|rwaTokenId" || echo "Property data retrieved"

echo ""
echo "=== Yield Calculation ==="
YIELD_DIST="0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4"
YIELD=$(cast call $YIELD_DIST "calculateYield(uint256)" $PROPERTY_ID --rpc-url $RPC_URL)
echo "Claimable Yield: $YIELD wei"
echo "Claimable Yield: $(cast --to-unit $YIELD ether) TYCOON"
</file>

<file path="contracts/check_new_marketplace.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;
import {Script, console} from "forge-std/Script.sol";
import {Marketplace} from "../src/Marketplace.sol";
contract CheckNewMarketplace is Script {
    function run() external {
        address marketplaceAddress = 0xe9E855ff6EB78055AaE90631468BfC948A1446Bb;
        address expectedPropertyNFT = 0xe1fF4f5f79D843208A0c70a0634a0CE4F034D697;
        Marketplace marketplace = Marketplace(marketplaceAddress);
        address actualPropertyNFT = address(marketplace.propertyNFT());
        console.log("Marketplace:", marketplaceAddress);
        console.log("Expected PropertyNFT:", expectedPropertyNFT);
        console.log("Actual PropertyNFT:", actualPropertyNFT);
        if (actualPropertyNFT == expectedPropertyNFT) {
            console.log("SUCCESS: Marketplace accepts NEW properties");
        } else {
            console.log("ERROR: Marketplace uses OLD PropertyNFT - needs redeployment");
        }
    }
}
</file>

<file path="contracts/script/CheckMarketplacePropertyNFT.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {Marketplace} from "../src/Marketplace.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";

/**
 * @notice Check which PropertyNFT address the Marketplace contract is using
 */
contract CheckMarketplacePropertyNFT is Script {
    function run() external {
        address marketplaceAddress = vm.envAddress("MARKETPLACE_ADDRESS");
        address expectedPropertyNFT = vm.envAddress("PROPERTY_NFT_ADDRESS");
        
        console.log("==========================================");
        console.log("Checking Marketplace PropertyNFT Address");
        console.log("==========================================");
        console.log("Marketplace Address:", marketplaceAddress);
        console.log("Expected PropertyNFT:", expectedPropertyNFT);
        
        Marketplace marketplace = Marketplace(marketplaceAddress);
        address actualPropertyNFT = address(marketplace.propertyNFT());
        
        console.log("Actual PropertyNFT in Marketplace:", actualPropertyNFT);
        
        if (actualPropertyNFT == expectedPropertyNFT) {
            console.log("SUCCESS: Marketplace is using the CORRECT PropertyNFT address");
        } else {
            console.log("ERROR: Marketplace is using the WRONG PropertyNFT address!");
            console.log("Marketplace needs to be redeployed with the new PropertyNFT address");
        }
        
        // Also verify the PropertyNFT contract exists
        PropertyNFT propertyNFT = PropertyNFT(actualPropertyNFT);
        try propertyNFT.name() returns (string memory) {
            console.log("SUCCESS: PropertyNFT contract exists and is accessible");
        } catch {
            console.log("ERROR: PropertyNFT contract does not exist or is not accessible");
        }
    }
}
</file>

<file path="contracts/script/CheckPropertyLink.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {MockRWA} from "../src/MockRWA.sol";

/**
 * @title CheckPropertyLink
 * @notice Quick script to check if a property is linked to RWA and what yield it calculates
 */
contract CheckPropertyLink is Script {
    function run() external view {
        address propertyNFTAddr = vm.envOr("PROPERTY_NFT_ADDRESS", address(0));
        address yieldDistributorAddr = vm.envOr("YIELD_DISTRIBUTOR_ADDRESS", address(0));
        address mockRWAAddr = vm.envOr("MOCK_RWA_ADDRESS", address(0));
        uint256 propertyId = vm.envOr("PROPERTY_ID", uint256(0));
        
        require(propertyNFTAddr != address(0), "PROPERTY_NFT_ADDRESS not set");
        require(yieldDistributorAddr != address(0), "YIELD_DISTRIBUTOR_ADDRESS not set");
        require(mockRWAAddr != address(0), "MOCK_RWA_ADDRESS not set");
        require(propertyId > 0, "PROPERTY_ID not set");
        
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddr);
        YieldDistributor yieldDistributor = YieldDistributor(yieldDistributorAddr);
        MockRWA mockRWA = MockRWA(mockRWAAddr);
        
        console.log("=== Checking Property Link ===");
        console.log("Property ID:", propertyId);
        console.log("");
        
        // Get property data
        PropertyNFT.Property memory prop = propertyNFT.getProperty(propertyId);
        
        console.log("Property Value:", prop.value);
        console.log("Property Yield Rate:", prop.yieldRate);
        console.log("RWA Contract:", prop.rwaContract);
        console.log("RWA Token ID:", prop.rwaTokenId);
        console.log("");
        
        // Check if linked
        bool isLinked = prop.rwaContract != address(0) && prop.rwaTokenId > 0;
        console.log("Is Linked to RWA:", isLinked ? "YES" : "NO");
        console.log("");
        
        if (isLinked) {
            console.log("Property IS linked. Checking RWA data...");
            
            // Get RWA data directly (no try-catch needed for view function)
            MockRWA.RWAProperty memory rwaProp = mockRWA.getRWAProperty(prop.rwaTokenId);
            
            if (rwaProp.isActive && rwaProp.value > 0) {
                console.log("RWA Name:", rwaProp.name);
                console.log("RWA Value:", rwaProp.value);
                console.log("RWA Monthly Yield:", rwaProp.monthlyYield);
                console.log("RWA Active:", rwaProp.isActive);
                
                uint256 rwaYieldRate = mockRWA.getYieldRate(prop.rwaTokenId);
                console.log("RWA Yield Rate:", rwaYieldRate);
                console.log("");
                
                // Calculate what yield SHOULD be using RWA
                uint256 dailyYieldRWA = (rwaProp.value * rwaYieldRate) / (365 * 10000);
                console.log("Expected Daily Yield (RWA):", dailyYieldRWA);
                
                // Calculate what yield would be using property
                uint256 dailyYieldProperty = (prop.value * prop.yieldRate) / (365 * 10000);
                console.log("Expected Daily Yield (Property):", dailyYieldProperty);
                console.log("");
            } else {
                console.log("WARNING: RWA is not active or has invalid value");
            }
        }
        
        // Get actual yield from YieldDistributor
        try yieldDistributor.calculateYield(propertyId) returns (uint256 yieldAmount) {
            console.log("=== Actual Yield from YieldDistributor ===");
            console.log("Yield Amount:", yieldAmount);
            console.log("Yield Amount (TYCOON):", yieldAmount / 1e18);
            console.log("");
            
            if (isLinked) {
                // Calculate expected using property data
                uint256 timeSinceUpdate = block.timestamp - prop.createdAt;
                if (timeSinceUpdate > 365 days) timeSinceUpdate = 365 days;
                uint256 periods = timeSinceUpdate / 1 days;
                if (periods > 365) periods = 365;
                
                uint256 dailyYieldProperty = (prop.value * prop.yieldRate) / (365 * 10000);
                uint256 expectedPropertyYield = dailyYieldProperty * periods;
                
                console.log("Expected Yield (using Property data):", expectedPropertyYield);
                console.log("Actual Yield:", yieldAmount);
                console.log("");
                
                if (yieldAmount > expectedPropertyYield) {
                    console.log("[OK] Yield is HIGHER than property yield - RWA is being used!");
                } else if (yieldAmount == expectedPropertyYield) {
                    console.log("[WARN] Yield equals property yield - RWA might not be used");
                } else {
                    console.log("[ERROR] Yield is LOWER - something is wrong");
                }
            }
        } catch Error(string memory reason) {
            console.log("ERROR calculating yield:", reason);
        } catch {
            console.log("ERROR: Failed to calculate yield");
        }
    }
}
</file>

<file path="contracts/script/DeployAll.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {TokenSwap} from "../src/TokenSwap.sol";
import {QuestSystem} from "../src/QuestSystem.sol";

/**
 * @notice Deploy all updated contracts
 * @dev Run this script to deploy:
 * 1. Updated GameToken (with minter role)
 * 2. Updated PropertyNFT (with purchaseProperty)
 * 3. Updated YieldDistributor (minting yield)
 * 4. TokenSwap (for buying TYCOON with MNT)
 * 5. Setup minter role
 * 6. Setup PropertyNFT gameToken
 */
contract DeployAll is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Deploying Updated Contracts");
        console.log("==========================================");
        
        // Step 1: Deploy GameToken
        console.log("\n1. Deploying GameToken...");
        GameToken gameToken = new GameToken();
        console.log("GameToken deployed at:", address(gameToken));
        
        // Step 2: Deploy PropertyNFT
        console.log("\n2. Deploying PropertyNFT...");
        PropertyNFT propertyNFT = new PropertyNFT();
        console.log("PropertyNFT deployed at:", address(propertyNFT));
        
        // Step 3: Deploy YieldDistributor
        console.log("\n3. Deploying YieldDistributor...");
        YieldDistributor yieldDistributor = new YieldDistributor(address(propertyNFT), address(gameToken));
        console.log("YieldDistributor deployed at:", address(yieldDistributor));
        
        // Step 4: Deploy TokenSwap
        console.log("\n4. Deploying TokenSwap...");
        TokenSwap tokenSwap = new TokenSwap(address(gameToken));
        console.log("TokenSwap deployed at:", address(tokenSwap));
        
        // Step 5: Deploy QuestSystem (if not already deployed, use existing address)
        address questSystemAddress = vm.envOr("QUEST_SYSTEM_ADDRESS", address(0));
        QuestSystem questSystem;
        if (questSystemAddress == address(0)) {
            console.log("\n5. Deploying QuestSystem...");
            questSystem = new QuestSystem(address(propertyNFT), address(gameToken));
            console.log("QuestSystem deployed at:", address(questSystem));
        } else {
            console.log("\n5. Using existing QuestSystem at:", questSystemAddress);
            questSystem = QuestSystem(questSystemAddress);
        }
        
        // Step 6: Set YieldDistributor as minter in GameToken
        console.log("\n6. Setting YieldDistributor as minter in GameToken...");
        gameToken.setMinter(address(yieldDistributor), true);
        bool isYieldDistributorMinter = gameToken.minters(address(yieldDistributor));
        console.log("YieldDistributor is minter:", isYieldDistributorMinter);
        require(isYieldDistributorMinter, "Failed to set YieldDistributor as minter");
        
        // Step 7: Set QuestSystem as minter in GameToken
        console.log("\n7. Setting QuestSystem as minter in GameToken...");
        gameToken.setMinter(address(questSystem), true);
        bool isQuestSystemMinter = gameToken.minters(address(questSystem));
        console.log("QuestSystem is minter:", isQuestSystemMinter);
        require(isQuestSystemMinter, "Failed to set QuestSystem as minter");
        
        // Step 8: Set GameToken in PropertyNFT
        console.log("\n8. Setting GameToken in PropertyNFT...");
        propertyNFT.setGameToken(address(gameToken));
        address propertyNFTGameToken = address(propertyNFT.gameToken());
        console.log("PropertyNFT gameToken set to:", propertyNFTGameToken);
        require(propertyNFTGameToken == address(gameToken), "Failed to set gameToken");
        
        // Step 9: Fund TokenSwap with TYCOON tokens (optional - can do manually)
        console.log("\n9. Funding TokenSwap with TYCOON tokens...");
        uint256 swapFundAmount = 1_000_000 * 10**18; // 1 million TYCOON for users to purchase
        gameToken.transfer(address(tokenSwap), swapFundAmount);
        uint256 swapBalance = gameToken.balanceOf(address(tokenSwap));
        console.log("TokenSwap balance:", swapBalance / 10**18, "TYCOON");
        
        console.log("\n==========================================");
        console.log("Deployment Complete!");
        console.log("==========================================");
        console.log("\nContract Addresses:");
        console.log("GameToken:", address(gameToken));
        console.log("PropertyNFT:", address(propertyNFT));
        console.log("YieldDistributor:", address(yieldDistributor));
        console.log("TokenSwap:", address(tokenSwap));
        console.log("QuestSystem:", address(questSystem));
        
        console.log("\nNext Steps:");
        console.log("1. Update frontend/.env.local with new addresses");
        console.log("2. Update backend/.env with new addresses");
        console.log("3. Update frontend/src/lib/contracts.ts with new addresses");
        console.log("4. Update README.md with new addresses");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/FindLinkedProperties.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";

/**
 * @title FindLinkedProperties
 * @notice Find all properties that are linked to RWA
 */
contract FindLinkedProperties is Script {
    function run() external view {
        address propertyNFTAddr = vm.envOr("PROPERTY_NFT_ADDRESS", address(0));
        require(propertyNFTAddr != address(0), "PROPERTY_NFT_ADDRESS not set");
        
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddr);
        
        console.log("=== Finding Properties Linked to RWA ===\n");
        console.log("Checking properties 1-50...\n");
        
        uint256 linkedCount = 0;
        
        for (uint256 i = 1; i <= 50; i++) {
            try propertyNFT.getProperty(i) returns (PropertyNFT.Property memory prop) {
                if (prop.rwaContract != address(0) && prop.rwaTokenId > 0) {
                    linkedCount++;
                    console.log("Property #", i, "IS LINKED:");
                    console.log("  RWA Contract:", prop.rwaContract);
                    console.log("  RWA Token ID:", prop.rwaTokenId);
                    console.log("  Property Value:", prop.value);
                    console.log("  Property Yield Rate:", prop.yieldRate);
                    console.log("");
                }
            } catch {
                // Property doesn't exist, skip
                continue;
            }
        }
        
        console.log("=== Summary ===");
        console.log("Total linked properties found:", linkedCount);
        
        if (linkedCount == 0) {
            console.log("\n[WARN] No properties are linked to RWA on-chain.");
            console.log("If you linked a property, check:");
            console.log("  1. Transaction succeeded in your wallet");
            console.log("  2. You're checking the correct property ID");
            console.log("  3. Wait a few seconds for blockchain sync");
        }
    }
}
</file>

<file path="contracts/script/FreshDeploy.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {TokenSwap} from "../src/TokenSwap.sol";
import {QuestSystem} from "../src/QuestSystem.sol";
import {Marketplace} from "../src/Marketplace.sol";

/**
 * @title FreshDeploy
 * @notice Fresh deployment of all contracts with proper initialization
 * @dev Deploys in correct order and sets up all relationships
 */
contract FreshDeploy is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("FRESH DEPLOYMENT - All Contracts");
        console.log("==========================================");
        console.log("Deployer:", vm.addr(deployerPrivateKey));
        
        // Step 1: Deploy GameToken
        console.log("\n1. Deploying GameToken...");
        GameToken gameToken = new GameToken();
        console.log("   GameToken:", address(gameToken));
        
        // Step 2: Deploy PropertyNFT (with costs initialized in constructor)
        console.log("\n2. Deploying PropertyNFT...");
        PropertyNFT propertyNFT = new PropertyNFT();
        console.log("   PropertyNFT:", address(propertyNFT));
        
        // Step 3: Deploy YieldDistributor
        console.log("\n3. Deploying YieldDistributor...");
        YieldDistributor yieldDistributor = new YieldDistributor(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("   YieldDistributor:", address(yieldDistributor));
        
        // Step 4: Deploy TokenSwap
        console.log("\n4. Deploying TokenSwap...");
        TokenSwap tokenSwap = new TokenSwap(address(gameToken));
        console.log("   TokenSwap:", address(tokenSwap));
        
        // Step 5: Deploy QuestSystem
        console.log("\n5. Deploying QuestSystem...");
        QuestSystem questSystem = new QuestSystem(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("   QuestSystem:", address(questSystem));
        
        // Step 6: Deploy Marketplace
        console.log("\n6. Deploying Marketplace...");
        Marketplace marketplace = new Marketplace(
            address(propertyNFT),
            address(gameToken)
        );
        console.log("   Marketplace:", address(marketplace));
        
        // Step 7: Set YieldDistributor as minter in GameToken
        console.log("\n7. Setting YieldDistributor as minter...");
        gameToken.setMinter(address(yieldDistributor), true);
        require(gameToken.minters(address(yieldDistributor)), "Failed to set YieldDistributor as minter");
        console.log("    YieldDistributor is minter");
        
        // Step 8: Set QuestSystem as minter in GameToken
        console.log("\n8. Setting QuestSystem as minter...");
        gameToken.setMinter(address(questSystem), true);
        require(gameToken.minters(address(questSystem)), "Failed to set QuestSystem as minter");
        console.log("    QuestSystem is minter");
        
        // Step 9: Set GameToken in PropertyNFT
        console.log("\n9. Setting GameToken in PropertyNFT...");
        propertyNFT.setGameToken(address(gameToken));
        require(address(propertyNFT.gameToken()) == address(gameToken), "Failed to set gameToken");
        console.log("    GameToken set in PropertyNFT");
        
        // Step 10: Verify PropertyNFT costs are initialized
        console.log("\n10. Verifying PropertyNFT costs...");
        uint256 residentialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Residential);
        uint256 commercialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Commercial);
        uint256 industrialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Industrial);
        console.log("   Residential cost:", residentialCost / 10**18, "TYCOON");
        console.log("   Commercial cost:", commercialCost / 10**18, "TYCOON");
        console.log("   Industrial cost:", industrialCost / 10**18, "TYCOON");
        require(residentialCost > 0 && commercialCost > 0 && industrialCost > 0, "Property costs not initialized");
        console.log("    All property costs initialized");
        
        // Step 11: Verify QuestSystem is using correct PropertyNFT
        console.log("\n11. Verifying QuestSystem configuration...");
        address questPropertyNFT = address(questSystem.propertyNFT());
        address questGameToken = address(questSystem.gameToken());
        require(questPropertyNFT == address(propertyNFT), "QuestSystem using wrong PropertyNFT");
        require(questGameToken == address(gameToken), "QuestSystem using wrong GameToken");
        console.log("   QuestSystem using correct PropertyNFT:", questPropertyNFT);
        console.log("   QuestSystem using correct GameToken:", questGameToken);
        
        // Step 12: Fund TokenSwap (optional - can skip if low on funds)
        console.log("\n12. Funding TokenSwap with TYCOON tokens...");
        uint256 swapFundAmount = 1_000_000 * 10**18; // 1 million TYCOON
        gameToken.transfer(address(tokenSwap), swapFundAmount);
        uint256 swapBalance = gameToken.balanceOf(address(tokenSwap));
        console.log("   TokenSwap balance:", swapBalance / 10**18, "TYCOON");
        
        console.log("\n==========================================");
        console.log("DEPLOYMENT COMPLETE!");
        console.log("==========================================");
        console.log("\nContract Addresses:");
        console.log("GameToken:", address(gameToken));
        console.log("PropertyNFT:", address(propertyNFT));
        console.log("YieldDistributor:", address(yieldDistributor));
        console.log("TokenSwap:", address(tokenSwap));
        console.log("QuestSystem:", address(questSystem));
        console.log("Marketplace:", address(marketplace));
        
        console.log("\nNext Steps:");
        console.log("1. Update frontend/.env.local");
        console.log("2. Update backend/.env");
        console.log("3. Update frontend/src/lib/contracts.ts");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/MintRWAForAddresses.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {MockRWA} from "../src/MockRWA.sol";

/**
 * @title MintRWAForAddresses
 * @notice Script to mint RWA properties to different addresses
 * @dev Edit the addresses array below to specify recipients
 * 
 * Usage:
 * 1. Edit the addresses array in this script
 * 2. Set MOCK_RWA_ADDRESS in .env
 * 3. Run: forge script script/MintRWAForAddresses.s.sol:MintRWAForAddresses --rpc-url $MANTLE_RPC_URL --broadcast
 */
contract MintRWAForAddresses is Script {
    function run() public {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);

        // Get MockRWA contract address from environment
        address mockRWAAddress = vm.envOr("MOCK_RWA_ADDRESS", address(0));
        require(mockRWAAddress != address(0), "MOCK_RWA_ADDRESS not set in .env");
        
        MockRWA mockRWA = MockRWA(mockRWAAddress);
        
        console.log("Minting RWA properties to different addresses...");
        console.log("MockRWA Contract:", mockRWAAddress);
        
        // EDIT THIS ARRAY: Add addresses you want to mint RWA properties to
        address[] memory recipients = new address[](3);
        recipients[0] = 0x3210607AC8126770E850957cE7373ee7e59e3A29; // Address 1
        recipients[1] = 0xcbA548De848baE1968583b2502f44c46539453A8; // Address 2
        recipients[2] = 0x63AB0CA2bDa77a4432C2a13285BFD1f7258646e1; // Address 3
        
        // Property configurations
        string[] memory names = new string[](3);
        names[0] = "NYC Apartment #42";
        names[1] = "Commercial Building #15";
        names[2] = "Industrial Warehouse #8";
        
        uint256[] memory values = new uint256[](3);
        values[0] = 1000000 * 10**18;  // $1M
        values[1] = 2000000 * 10**18;  // $2M
        values[2] = 5000000 * 10**18;  // $5M
        
        uint256[] memory monthlyYields = new uint256[](3);
        monthlyYields[0] = 5000 * 10**18;   // $5K/month
        monthlyYields[1] = 15000 * 10**18;  // $15K/month
        monthlyYields[2] = 50000 * 10**18;  // $50K/month
        
        string[] memory locations = new string[](3);
        locations[0] = "New York, NY";
        locations[1] = "Los Angeles, CA";
        locations[2] = "Chicago, IL";
        
        // Mint properties to each address
        for (uint256 i = 0; i < recipients.length; i++) {
            require(recipients[i] != address(0), "Invalid recipient address");
            
            uint256 tokenId = mockRWA.mintRWAProperty(
                recipients[i],
                names[i],
                values[i],
                monthlyYields[i],
                locations[i]
            );
            
            console.log("Minted RWA token", tokenId, "to", recipients[i]);
        }
        
        console.log("Minting complete! Total properties minted:", recipients.length);
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/RedeployQuestSystem.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {QuestSystem} from "../src/QuestSystem.sol";
import {GameToken} from "../src/GameToken.sol";

/**
 * @title RedeployQuestSystem
 * @notice Redeploy QuestSystem to a new address (old one was overwritten by PropertyNFT)
 */
contract RedeployQuestSystem is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        // Use new PropertyNFT address (hardcoded since .env might be outdated)
        address propertyNFTAddress = vm.envOr("PROPERTY_NFT_ADDRESS", 0x1A9890B59E7DD74dA063adB3f9f6262379fE5c2A);
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Redeploying QuestSystem");
        console.log("==========================================");
        console.log("PropertyNFT Address:", propertyNFTAddress);
        console.log("GameToken Address:", gameTokenAddress);
        
        // Deploy new QuestSystem
        QuestSystem questSystem = new QuestSystem(propertyNFTAddress, gameTokenAddress);
        console.log("New QuestSystem deployed at:", address(questSystem));
        
        // Set QuestSystem as minter in GameToken
        GameToken gameToken = GameToken(gameTokenAddress);
        gameToken.setMinter(address(questSystem), true);
        bool isMinter = gameToken.minters(address(questSystem));
        console.log("QuestSystem is minter:", isMinter);
        require(isMinter, "Failed to set QuestSystem as minter");
        
        console.log("\n==========================================");
        console.log("QuestSystem redeployed successfully!");
        console.log("==========================================");
        console.log("\nNew QuestSystem Address:", address(questSystem));
        console.log("\nNext Steps:");
        console.log("1. Update frontend/.env.local with new address");
        console.log("2. Update backend/.env with new address");
        console.log("3. Update frontend/src/lib/contracts.ts with new address");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/SetupMinter.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";

/**
 * @notice Set YieldDistributor as minter in GameToken
 * @dev Run this after deploying YieldDistributor
 */
contract SetupMinter is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        address yieldDistributorAddress = vm.envAddress("YIELD_DISTRIBUTOR_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Setting YieldDistributor as minter in GameToken...");
        console.log("GameToken address:", gameTokenAddress);
        console.log("YieldDistributor address:", yieldDistributorAddress);
        
        GameToken gameToken = GameToken(gameTokenAddress);
        gameToken.setMinter(yieldDistributorAddress, true);
        
        bool isMinter = gameToken.minters(yieldDistributorAddress);
        console.log("YieldDistributor is minter:", isMinter);
        require(isMinter, "Failed to set minter");
        
        console.log("Successfully set YieldDistributor as minter!");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/VerifyPropertyLink.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {MockRWA} from "../src/MockRWA.sol";

/**
 * @title VerifyPropertyLink
 * @notice Verify if a property is actually linked to RWA on-chain
 */
contract VerifyPropertyLink is Script {
    function run() external view {
        address propertyNFTAddr = vm.envOr("PROPERTY_NFT_ADDRESS", address(0));
        address yieldDistributorAddr = vm.envOr("YIELD_DISTRIBUTOR_ADDRESS", address(0));
        address mockRWAAddr = vm.envOr("MOCK_RWA_ADDRESS", address(0));
        uint256 propertyId = vm.envOr("PROPERTY_ID", uint256(1));
        
        require(propertyNFTAddr != address(0), "PROPERTY_NFT_ADDRESS not set");
        require(yieldDistributorAddr != address(0), "YIELD_DISTRIBUTOR_ADDRESS not set");
        require(mockRWAAddr != address(0), "MOCK_RWA_ADDRESS not set");
        
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddr);
        YieldDistributor yieldDistributor = YieldDistributor(yieldDistributorAddr);
        MockRWA mockRWA = MockRWA(mockRWAAddr);
        
        console.log("=== Verifying Property Link ===");
        console.log("Property ID:", propertyId);
        console.log("");
        
        // Check if property exists
        try propertyNFT.ownerOf(propertyId) returns (address owner) {
            console.log("Property Owner:", owner);
        } catch {
            console.log("ERROR: Property does not exist!");
            return;
        }
        
        // Get property data
        PropertyNFT.Property memory prop = propertyNFT.getProperty(propertyId);
        
        console.log("=== Property Data ===");
        console.log("Property Value:", prop.value);
        console.log("Property Yield Rate:", prop.yieldRate);
        console.log("RWA Contract:", prop.rwaContract);
        console.log("RWA Token ID:", prop.rwaTokenId);
        console.log("");
        
        // Check if linked
        bool isLinked = prop.rwaContract != address(0) && prop.rwaTokenId > 0;
        console.log("Is Linked to RWA:", isLinked ? "YES" : "NO");
        console.log("");
        
        if (!isLinked) {
            console.log("PROPERTY IS NOT LINKED TO RWA!");
            console.log("You need to call linkToRWA() on PropertyNFT contract");
            return;
        }
        
        // Verify RWA exists
        console.log("=== Verifying RWA ===");
        console.log("RWA Contract Address:", prop.rwaContract);
        console.log("RWA Token ID:", prop.rwaTokenId);
        console.log("");
        
        // Check if RWA token exists
        try mockRWA.ownerOf(prop.rwaTokenId) returns (address rwaOwner) {
            console.log("RWA Owner:", rwaOwner);
        } catch {
            console.log("ERROR: RWA token does not exist!");
            console.log("The RWA token ID", prop.rwaTokenId, "does not exist in MockRWA contract");
            return;
        }
        
        // Get RWA data using public mapping
        try mockRWA.properties(prop.rwaTokenId) returns (
            string memory name,
            uint256 value,
            uint256 monthlyYield,
            string memory location,
            uint256 createdAt,
            bool isActive
        ) {
            console.log("RWA Name:", name);
            console.log("RWA Value:", value);
            console.log("RWA Monthly Yield:", monthlyYield);
            console.log("RWA Location:", location);
            console.log("RWA Active:", isActive);
            console.log("");
            
            if (!isActive) {
                console.log("WARNING: RWA is not active!");
            }
            
            if (value == 0) {
                console.log("WARNING: RWA value is 0!");
            }
            
            // Get yield rate
            uint256 rwaYieldRate = mockRWA.getYieldRate(prop.rwaTokenId);
            console.log("RWA Yield Rate (basis points):", rwaYieldRate);
            console.log("RWA Yield Rate (percent):", rwaYieldRate / 100);
            console.log("");
        } catch {
            console.log("ERROR: Failed to fetch RWA data");
            return;
        }
        
        // Test calculateYield
        console.log("=== Testing Yield Calculation ===");
        try yieldDistributor.calculateYield(propertyId) returns (uint256 yieldAmount) {
            console.log("Yield Amount (wei):", yieldAmount);
            console.log("Yield Amount (TYCOON):", yieldAmount / 1e18);
            console.log("");
            console.log("SUCCESS: Yield calculation works!");
        } catch Error(string memory reason) {
            console.log("ERROR calculating yield:", reason);
        } catch {
            console.log("ERROR: calculateYield reverted");
        }
    }
}
</file>

<file path="contracts/script/VerifyRWAYield.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {MockRWA} from "../src/MockRWA.sol";

/**
 * @title VerifyRWAYield
 * @notice Script to verify that RWA yield integration is working correctly
 * @dev Compares yield calculation for linked vs unlinked properties
 */
contract VerifyRWAYield is Script {
    function run() external view {
        // Contract addresses (Mantle Sepolia Testnet)
        address yieldDistributorAddr = vm.envOr("YIELD_DISTRIBUTOR_ADDRESS", address(0));
        address propertyNFTAddr = vm.envOr("PROPERTY_NFT_ADDRESS", address(0));
        address mockRWAAddr = vm.envOr("MOCK_RWA_ADDRESS", address(0));
        
        require(yieldDistributorAddr != address(0), "YIELD_DISTRIBUTOR_ADDRESS not set");
        require(propertyNFTAddr != address(0), "PROPERTY_NFT_ADDRESS not set");
        require(mockRWAAddr != address(0), "MOCK_RWA_ADDRESS not set");
        
        YieldDistributor yieldDistributor = YieldDistributor(yieldDistributorAddr);
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddr);
        MockRWA mockRWA = MockRWA(mockRWAAddr);
        
        console.log("=== RWA Yield Integration Verification ===\n");
        
        // Get a property ID to test (you can change this)
        uint256 propertyId = vm.envOr("PROPERTY_ID", uint256(0));
        
        if (propertyId == 0) {
            console.log("Usage: Set PROPERTY_ID in .env to test a specific property");
            console.log("Example: PROPERTY_ID=1 forge script script/VerifyRWAYield.s.sol:VerifyRWAYield --rpc-url $MANTLE_RPC_URL");
            return;
        }
        
        console.log("Testing Property ID:", propertyId);
        console.log("YieldDistributor:", yieldDistributorAddr);
        console.log("PropertyNFT:", propertyNFTAddr);
        console.log("MockRWA:", mockRWAAddr);
        console.log("");
        
        // Get property data
        PropertyNFT.Property memory prop = propertyNFT.getProperty(propertyId);
        
        console.log("=== Property Data ===");
        console.log("Property Value:", prop.value);
        console.log("Property Yield Rate (basis points):", prop.yieldRate);
        console.log("Property Yield Rate (percent):", prop.yieldRate / 100);
        console.log("RWA Contract:", prop.rwaContract);
        console.log("RWA Token ID:", prop.rwaTokenId);
        console.log("");
        
        // Check if linked to RWA
        bool isLinked = prop.rwaContract != address(0) && prop.rwaTokenId > 0;
        
        if (isLinked) {
            console.log("[OK] Property IS linked to RWA");
            console.log("");
            
            // Get RWA data
            MockRWA.RWAProperty memory rwaProp = mockRWA.getRWAProperty(prop.rwaTokenId);
            
            if (rwaProp.isActive && rwaProp.value > 0) {
                console.log("=== RWA Data ===");
                console.log("RWA Name:", rwaProp.name);
                console.log("RWA Value:", rwaProp.value);
                console.log("RWA Monthly Yield:", rwaProp.monthlyYield);
                console.log("RWA Location:", rwaProp.location);
                console.log("RWA Active:", rwaProp.isActive);
                
                // Calculate RWA yield rate
                uint256 rwaYieldRate = mockRWA.getYieldRate(prop.rwaTokenId);
                console.log("RWA Yield Rate (basis points):", rwaYieldRate);
                console.log("RWA Yield Rate (percent):", rwaYieldRate / 100);
                console.log("");
                
                // Calculate expected yield using RWA data
                uint256 dailyYieldRWA = (rwaProp.value * rwaYieldRate) / (365 * 10000);
                console.log("Expected Daily Yield (using RWA):", dailyYieldRWA);
                
                // Calculate expected yield using property data (for comparison)
                uint256 dailyYieldProperty = (prop.value * prop.yieldRate) / (365 * 10000);
                console.log("Expected Daily Yield (using Property):", dailyYieldProperty);
                console.log("");
                
                if (dailyYieldRWA > dailyYieldProperty) {
                    console.log("[OK] RWA yield is HIGHER than property yield");
                    console.log("   Difference:", dailyYieldRWA - dailyYieldProperty, "wei per day");
                } else if (dailyYieldRWA < dailyYieldProperty) {
                    console.log("[WARN] RWA yield is LOWER than property yield");
                    console.log("   Difference:", dailyYieldProperty - dailyYieldRWA, "wei per day");
                } else {
                    console.log("[WARN] RWA yield equals property yield");
                }
                console.log("");
            } else {
                console.log("[WARN] RWA is not active or has invalid value");
            }
        } else {
            console.log("[INFO] Property is NOT linked to RWA");
            console.log("   Will use property's own value and yield rate");
            console.log("");
        }
        
        // Get actual yield from YieldDistributor
        try yieldDistributor.calculateYield(propertyId) returns (uint256 yieldAmount) {
            console.log("=== Actual Yield from YieldDistributor ===");
            console.log("Claimable Yield:", yieldAmount, "wei");
            console.log("Claimable Yield (TYCOON):", yieldAmount / 1e18, "TYCOON");
            console.log("");
            
            if (isLinked) {
                console.log("[OK] YieldDistributor is using RWA data for calculation");
                console.log("   (If RWA yield > property yield, you should see higher yield)");
            } else {
                console.log("[INFO] YieldDistributor is using property data for calculation");
            }
        } catch Error(string memory reason) {
            console.log("[ERROR] Error calculating yield:", reason);
        } catch {
            console.log("[ERROR] Failed to calculate yield");
        }
        
        console.log("\n=== Verification Complete ===");
    }
}
</file>

<file path="contracts/script/WhitelistChronicle.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";

// SelfKisser ABI
interface ISelfKisser {
    function selfKiss(address oracle) external;
    function selfKiss(address oracle, address who) external;
}

/**
 * @title WhitelistChronicle
 * @notice Whitelist addresses to read from Chronicle Oracles on Mantle Testnet
 * @dev Uses SelfKisser contract to whitelist addresses
 */
contract WhitelistChronicle is Script {
    // SelfKisser address for Mantle Testnet
    address constant SELF_KISSER = 0x9ee0DC1f7cF1a5c083914e3de197Fd1F484E0578;
    
    // Chronicle Oracle addresses on Mantle Sepolia
    address constant USDC_ORACLE = 0x9Dd500569A6e77ECdDE7694CDc2E58ac587768D0;
    address constant USDT_ORACLE = 0xD671F5F7c2fb6f75439641C36a578842f5b376A9;
    address constant ETH_ORACLE = 0xa6896dCf3f5Dc3c29A5bD3a788D6b7e901e487D8;
    address constant MNT_ORACLE = 0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307;
    
    function run() public {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address deployerAddress = vm.addr(deployerPrivateKey);
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Whitelisting Chronicle Oracles");
        console.log("==========================================");
        console.log("Deployer Address:", deployerAddress);
        console.log("SelfKisser:", SELF_KISSER);
        
        ISelfKisser selfKisser = ISelfKisser(SELF_KISSER);
        
        // Whitelist deployer address for each oracle
        console.log("\n1. Whitelisting USDC Oracle...");
        selfKisser.selfKiss(USDC_ORACLE);
        console.log("   Whitelisted for USDC Oracle");
        
        console.log("\n2. Whitelisting USDT Oracle...");
        selfKisser.selfKiss(USDT_ORACLE);
        console.log("   Whitelisted for USDT Oracle");
        
        console.log("\n3. Whitelisting ETH Oracle...");
        selfKisser.selfKiss(ETH_ORACLE);
        console.log("   Whitelisted for ETH Oracle");
        
        console.log("\n4. Whitelisting MNT Oracle...");
        selfKisser.selfKiss(MNT_ORACLE);
        console.log("   Whitelisted for MNT Oracle");
        
        console.log("\n==========================================");
        console.log("Whitelisting Complete!");
        console.log("Address", deployerAddress, "is now whitelisted for all Chronicle Oracles");
        console.log("==========================================");
        
        vm.stopBroadcast();
    }
    
    /**
     * @notice Whitelist a specific address (e.g., backend wallet or contract)
     * @param addressToWhitelist The address to whitelist
     */
    function whitelistAddress(address addressToWhitelist) public {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        ISelfKisser selfKisser = ISelfKisser(SELF_KISSER);
        
        console.log("Whitelisting address:", addressToWhitelist);
        
        selfKisser.selfKiss(USDC_ORACLE, addressToWhitelist);
        selfKisser.selfKiss(USDT_ORACLE, addressToWhitelist);
        selfKisser.selfKiss(ETH_ORACLE, addressToWhitelist);
        selfKisser.selfKiss(MNT_ORACLE, addressToWhitelist);
        
        console.log("Address whitelisted for all oracles");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/src/GameToken.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract GameToken is ERC20, Ownable {
    // Mapping of addresses allowed to mint tokens (e.g., YieldDistributor, QuestSystem)
    mapping(address => bool) public minters;
    
    constructor() ERC20("Tycoon Token", "TYCOON") Ownable(msg.sender) {
        _mint(msg.sender, 1_000_000_000 * 10**18);
    }
    
    /**
     * @notice Add or remove a minter address
     * @dev Only owner can set minters
     */
    function setMinter(address _minter, bool _enabled) public onlyOwner {
        minters[_minter] = _enabled;
    }
    
    /**
     * @notice Mint tokens (owner or authorized minter)
     */
    function mint(address to, uint256 amount) public {
        require(msg.sender == owner() || minters[msg.sender], "Not authorized to mint");
        _mint(to, amount);
    }
    
    function burn(uint256 amount) public {
        _burn(msg.sender, amount);
    }
}
</file>

<file path="contracts/src/Marketplace.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "./PropertyNFT.sol";
import "./GameToken.sol";

contract Marketplace is ReentrancyGuard, Ownable {
    PropertyNFT public propertyNFT;
    GameToken public gameToken;
    
    struct Listing {
        uint256 propertyId;
        address seller;
        uint256 price;
        bool isActive;
        uint256 createdAt;
    }
    
    struct Auction {
        uint256 propertyId;
        address seller;
        uint256 startingPrice;
        uint256 highestBid;
        address highestBidder;
        uint256 endTime;
        bool isActive;
    }
    
    mapping(uint256 => Listing) public listings;
    mapping(uint256 => Auction) public auctions;
    uint256 public listingFee = 25; // 2.5% in basis points
    uint256 public auctionFee = 25; // 2.5% in basis points
    
    event PropertyListed(uint256 indexed propertyId, address indexed seller, uint256 price);
    event PropertySold(uint256 indexed propertyId, address indexed seller, address indexed buyer, uint256 price);
    event ListingCancelled(uint256 indexed propertyId);
    event AuctionCreated(uint256 indexed propertyId, address indexed seller, uint256 startingPrice, uint256 endTime);
    event BidPlaced(uint256 indexed propertyId, address indexed bidder, uint256 amount);
    event AuctionEnded(uint256 indexed propertyId, address indexed winner, uint256 finalPrice);
    
    constructor(address _propertyNFT, address _gameToken) Ownable(msg.sender) {
        propertyNFT = PropertyNFT(_propertyNFT);
        gameToken = GameToken(_gameToken);
    }
    
    function listProperty(uint256 propertyId, uint256 price) public {
        require(propertyNFT.ownerOf(propertyId) == msg.sender, "Not owner");
        require(price > 0, "Invalid price");
        require(!listings[propertyId].isActive, "Already listed");
        
        propertyNFT.transferFrom(msg.sender, address(this), propertyId);
        
        listings[propertyId] = Listing({
            propertyId: propertyId,
            seller: msg.sender,
            price: price,
            isActive: true,
            createdAt: block.timestamp
        });
        
        emit PropertyListed(propertyId, msg.sender, price);
    }
    
    function buyProperty(uint256 propertyId) public nonReentrant {
        Listing storage listing = listings[propertyId];
        require(listing.isActive, "Not listed");
        
        uint256 fee = (listing.price * listingFee) / 1000;
        uint256 sellerAmount = listing.price - fee;
        
        gameToken.transferFrom(msg.sender, listing.seller, sellerAmount);
        gameToken.transferFrom(msg.sender, owner(), fee);
        
        propertyNFT.transferFrom(address(this), msg.sender, propertyId);
        
        listing.isActive = false;
        
        emit PropertySold(propertyId, listing.seller, msg.sender, listing.price);
    }
    
    function cancelListing(uint256 propertyId) public {
        Listing storage listing = listings[propertyId];
        require(listing.seller == msg.sender, "Not seller");
        require(listing.isActive, "Not active");
        
        propertyNFT.transferFrom(address(this), msg.sender, propertyId);
        listing.isActive = false;
        
        emit ListingCancelled(propertyId);
    }
    
    function createAuction(
        uint256 propertyId,
        uint256 startingPrice,
        uint256 duration
    ) public {
        require(propertyNFT.ownerOf(propertyId) == msg.sender, "Not owner");
        require(startingPrice > 0, "Invalid price");
        require(duration > 0, "Invalid duration");
        require(!auctions[propertyId].isActive, "Auction exists");
        
        propertyNFT.transferFrom(msg.sender, address(this), propertyId);
        
        auctions[propertyId] = Auction({
            propertyId: propertyId,
            seller: msg.sender,
            startingPrice: startingPrice,
            highestBid: startingPrice,
            highestBidder: address(0),
            endTime: block.timestamp + duration,
            isActive: true
        });
        
        emit AuctionCreated(propertyId, msg.sender, startingPrice, block.timestamp + duration);
    }
    
    function placeBid(uint256 propertyId, uint256 bidAmount) public nonReentrant {
        Auction storage auction = auctions[propertyId];
        require(auction.isActive, "Auction not active");
        require(block.timestamp < auction.endTime, "Auction ended");
        require(bidAmount > auction.highestBid, "Bid too low");
        
        if (auction.highestBidder != address(0)) {
            gameToken.transfer(auction.highestBidder, auction.highestBid);
        }
        
        gameToken.transferFrom(msg.sender, address(this), bidAmount);
        
        auction.highestBid = bidAmount;
        auction.highestBidder = msg.sender;
        
        emit BidPlaced(propertyId, msg.sender, bidAmount);
    }
    
    function endAuction(uint256 propertyId) public nonReentrant {
        Auction storage auction = auctions[propertyId];
        require(auction.isActive, "Auction not active");
        require(block.timestamp >= auction.endTime, "Auction ongoing");
        
        if (auction.highestBidder != address(0)) {
            uint256 fee = (auction.highestBid * auctionFee) / 1000;
            uint256 sellerAmount = auction.highestBid - fee;
            
            gameToken.transfer(auction.seller, sellerAmount);
            gameToken.transfer(owner(), fee);
            propertyNFT.transferFrom(address(this), auction.highestBidder, propertyId);
            
            emit AuctionEnded(propertyId, auction.highestBidder, auction.highestBid);
        } else {
            propertyNFT.transferFrom(address(this), auction.seller, propertyId);
        }
        
        auction.isActive = false;
    }
    
    function batchListProperties(
        uint256[] calldata propertyIds,
        uint256[] calldata prices
    ) public {
        require(propertyIds.length == prices.length, "Array length mismatch");
        require(propertyIds.length > 0 && propertyIds.length <= 20, "Invalid batch size");
        
        for (uint256 i = 0; i < propertyIds.length; i++) {
            listProperty(propertyIds[i], prices[i]);
        }
    }
    
    /**
     * @notice Get all active listings
     * @return propertyIds Array of property IDs that are actively listed
     * @return sellers Array of seller addresses corresponding to each property
     * @return prices Array of prices corresponding to each property
     */
    function getActiveListings() public view returns (
        uint256[] memory propertyIds,
        address[] memory sellers,
        uint256[] memory prices
    ) {
        // Get all properties owned by this marketplace contract
        uint256[] memory ownedProperties = propertyNFT.getOwnerProperties(address(this));
        
        // Count active listings first
        uint256 activeCount = 0;
        for (uint256 i = 0; i < ownedProperties.length; i++) {
            if (listings[ownedProperties[i]].isActive) {
                activeCount++;
            }
        }
        
        // Allocate arrays
        propertyIds = new uint256[](activeCount);
        sellers = new address[](activeCount);
        prices = new uint256[](activeCount);
        
        // Fill arrays with active listings
        uint256 index = 0;
        for (uint256 i = 0; i < ownedProperties.length; i++) {
            uint256 propertyId = ownedProperties[i];
            Listing storage listing = listings[propertyId];
            if (listing.isActive) {
                propertyIds[index] = propertyId;
                sellers[index] = listing.seller;
                prices[index] = listing.price;
                index++;
            }
        }
        
        return (propertyIds, sellers, prices);
    }
    
    /**
     * @notice Get active listings count
     * @return count Number of active listings
     */
    function getActiveListingsCount() public view returns (uint256) {
        uint256[] memory ownedProperties = propertyNFT.getOwnerProperties(address(this));
        uint256 count = 0;
        for (uint256 i = 0; i < ownedProperties.length; i++) {
            if (listings[ownedProperties[i]].isActive) {
                count++;
            }
        }
        return count;
    }
}
</file>

<file path="contracts/src/QuestSystem.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/access/Ownable.sol";
import "./PropertyNFT.sol";
import "./GameToken.sol";

contract QuestSystem is Ownable {
    PropertyNFT public propertyNFT;
    GameToken public gameToken;
    
    enum QuestType { 
        FirstProperty,
        DiversifyPortfolio,
        YieldMaster,
        PropertyMogul,
        RWAPioneer
    }
    
    struct Quest {
        QuestType questType;
        string name;
        string description;
        uint256 reward;
        bool isActive;
    }
    
    struct PlayerProgress {
        mapping(QuestType => bool) completedQuests;
        mapping(QuestType => uint256) questProgress;
        uint256 totalQuestsCompleted;
    }
    
    mapping(QuestType => Quest) public quests;
    mapping(address => PlayerProgress) public playerProgress;
    
    event QuestCompleted(address indexed player, QuestType questType, uint256 reward);
    event QuestProgressUpdated(address indexed player, QuestType questType, uint256 progress);
    
    constructor(address _propertyNFT, address _gameToken) Ownable(msg.sender) {
        propertyNFT = PropertyNFT(_propertyNFT);
        gameToken = GameToken(_gameToken);
        
        _initializeQuests();
    }
    
    function _initializeQuests() private {
        quests[QuestType.FirstProperty] = Quest({
            questType: QuestType.FirstProperty,
            name: "First Property",
            description: "Mint your first property",
            reward: 100 * 10**18,
            isActive: true
        });
        
        quests[QuestType.DiversifyPortfolio] = Quest({
            questType: QuestType.DiversifyPortfolio,
            name: "Diversify Portfolio",
            description: "Own 3 different property types",
            reward: 500 * 10**18,
            isActive: true
        });
        
        quests[QuestType.YieldMaster] = Quest({
            questType: QuestType.YieldMaster,
            name: "Yield Master",
            description: "Collect yield 7 days in a row",
            reward: 1000 * 10**18,
            isActive: true
        });
        
        quests[QuestType.PropertyMogul] = Quest({
            questType: QuestType.PropertyMogul,
            name: "Property Mogul",
            description: "Own 10 properties",
            reward: 2000 * 10**18,
            isActive: true
        });
        
        quests[QuestType.RWAPioneer] = Quest({
            questType: QuestType.RWAPioneer,
            name: "RWA Pioneer",
            description: "Link 5 properties to RWA",
            reward: 1500 * 10**18,
            isActive: true
        });
    }
    
    function checkFirstPropertyQuest(address player) public {
        Quest storage quest = quests[QuestType.FirstProperty];
        require(quest.isActive, "Quest not active");
        require(!playerProgress[player].completedQuests[QuestType.FirstProperty], "Already completed");
        
        uint256 propertyCount = propertyNFT.getOwnerPropertyCount(player);
        require(propertyCount >= 1, "Requirement not met");
        
        playerProgress[player].completedQuests[QuestType.FirstProperty] = true;
        playerProgress[player].totalQuestsCompleted++;
        
        gameToken.mint(player, quest.reward);
        emit QuestCompleted(player, QuestType.FirstProperty, quest.reward);
    }
    
    function checkDiversifyPortfolioQuest(address player) public {
        Quest storage quest = quests[QuestType.DiversifyPortfolio];
        require(quest.isActive, "Quest not active");
        require(!playerProgress[player].completedQuests[QuestType.DiversifyPortfolio], "Already completed");
        
        uint256[] memory properties = propertyNFT.getOwnerProperties(player);
        require(properties.length >= 3, "Not enough properties");
        
        bool[4] memory hasType;
        for (uint256 i = 0; i < properties.length; i++) {
            PropertyNFT.Property memory prop = propertyNFT.getProperty(properties[i]);
            hasType[uint256(prop.propertyType)] = true;
        }
        
        uint256 typeCount = 0;
        for (uint256 i = 0; i < 4; i++) {
            if (hasType[i]) typeCount++;
        }
        
        require(typeCount >= 3, "Not diversified");
        
        playerProgress[player].completedQuests[QuestType.DiversifyPortfolio] = true;
        playerProgress[player].totalQuestsCompleted++;
        
        gameToken.mint(player, quest.reward);
        emit QuestCompleted(player, QuestType.DiversifyPortfolio, quest.reward);
    }
    
    function checkPropertyMogulQuest(address player) public {
        Quest storage quest = quests[QuestType.PropertyMogul];
        require(quest.isActive, "Quest not active");
        require(!playerProgress[player].completedQuests[QuestType.PropertyMogul], "Already completed");
        
        uint256 propertyCount = propertyNFT.getOwnerPropertyCount(player);
        require(propertyCount >= 10, "Requirement not met");
        
        playerProgress[player].completedQuests[QuestType.PropertyMogul] = true;
        playerProgress[player].totalQuestsCompleted++;
        
        gameToken.mint(player, quest.reward);
        emit QuestCompleted(player, QuestType.PropertyMogul, quest.reward);
    }
    
    function checkRWAPioneerQuest(address player) public {
        Quest storage quest = quests[QuestType.RWAPioneer];
        require(quest.isActive, "Quest not active");
        require(!playerProgress[player].completedQuests[QuestType.RWAPioneer], "Already completed");
        
        uint256[] memory properties = propertyNFT.getOwnerProperties(player);
        uint256 linkedCount = 0;
        
        for (uint256 i = 0; i < properties.length; i++) {
            PropertyNFT.Property memory prop = propertyNFT.getProperty(properties[i]);
            if (prop.rwaContract != address(0)) {
                linkedCount++;
            }
        }
        
        require(linkedCount >= 5, "Not enough RWA links");
        
        playerProgress[player].completedQuests[QuestType.RWAPioneer] = true;
        playerProgress[player].totalQuestsCompleted++;
        
        gameToken.mint(player, quest.reward);
        emit QuestCompleted(player, QuestType.RWAPioneer, quest.reward);
    }
    
    function batchCheckQuests(address player, QuestType[] calldata questTypes) public {
        for (uint256 i = 0; i < questTypes.length; i++) {
            if (questTypes[i] == QuestType.FirstProperty) {
                checkFirstPropertyQuest(player);
            } else if (questTypes[i] == QuestType.DiversifyPortfolio) {
                checkDiversifyPortfolioQuest(player);
            } else if (questTypes[i] == QuestType.PropertyMogul) {
                checkPropertyMogulQuest(player);
            } else if (questTypes[i] == QuestType.RWAPioneer) {
                checkRWAPioneerQuest(player);
            }
        }
    }
    
    function hasCompletedQuest(address player, QuestType questType) public view returns (bool) {
        return playerProgress[player].completedQuests[questType];
    }
    
    function getTotalQuestsCompleted(address player) public view returns (uint256) {
        return playerProgress[player].totalQuestsCompleted;
    }
    
    /**
     * @notice Owner can update quest reward
     * @dev Allows changing rewards without redeploying
     */
    function updateQuestReward(QuestType questType, uint256 newReward) public onlyOwner {
        require(quests[questType].questType == questType, "Invalid quest type");
        quests[questType].reward = newReward;
    }
    
    /**
     * @notice Owner can enable/disable a quest
     * @dev Allows disabling quests without redeploying
     */
    function setQuestActive(QuestType questType, bool isActive) public onlyOwner {
        require(quests[questType].questType == questType, "Invalid quest type");
        quests[questType].isActive = isActive;
    }
    
    /**
     * @notice Owner can update quest description
     * @dev Allows updating quest info without redeploying
     */
    function updateQuestDescription(QuestType questType, string memory newDescription) public onlyOwner {
        require(quests[questType].questType == questType, "Invalid quest type");
        quests[questType].description = newDescription;
    }
}
</file>

<file path="frontend/public/abis/PropertyNFT.json">

</file>

<file path="frontend/public/abis/TokenSwap.json">
{"abi":[{"type":"constructor","inputs":[{"name":"_gameToken","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"EXCHANGE_RATE","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"MIN_PURCHASE_MNT","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"buyTokens","inputs":[],"outputs":[],"stateMutability":"payable"},{"type":"function","name":"depositTokens","inputs":[{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"gameToken","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract GameToken"}],"stateMutability":"view"},{"type":"function","name":"getMntAmount","inputs":[{"name":"tycoonAmount","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"pure"},{"type":"function","name":"getTokenBalance","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getTycoonAmount","inputs":[{"name":"mntAmount","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"pure"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"withdrawMNT","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"withdrawTokens","inputs":[{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"TokensPurchased","inputs":[{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"mntAmount","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"tycoonAmount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"TokensWithdrawn","inputs":[{"name":"to","type":"address","indexed":true,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]},{"type":"error","name":"ReentrancyGuardReentrantCall","inputs":[]}],"bytecode":{"object":"0x608060405234801561000f575f80fd5b50604051610a9e380380610a9e83398101604081905261002e916100f5565b338061005357604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b61005c816100a6565b5060017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055600180546001600160a01b0319166001600160a01b0392909216919091179055610122565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f60208284031215610105575f80fd5b81516001600160a01b038116811461011b575f80fd5b9392505050565b61096f8061012f5f395ff3fe6080604052600436106100bf575f3560e01c80639a5ed7381161007c578063d0febe4c11610057578063d0febe4c146101cf578063d87810d6146101d7578063dd49756e146101f6578063f2fde38b14610215575f80fd5b80639a5ed73814610177578063c3dfdae614610191578063d0dea103146101b0575f80fd5b806314a8bd0d146100c3578063315a095d146100ea5780636e5c09561461010b578063715018a61461011f57806382b2e257146101335780638da5cb5b14610147575b5f80fd5b3480156100ce575f80fd5b506100d7606481565b6040519081526020015b60405180910390f35b3480156100f5575f80fd5b5061010961010436600461084e565b610234565b005b348015610116575f80fd5b50610109610341565b34801561012a575f80fd5b506101096103c6565b34801561013e575f80fd5b506100d76103d9565b348015610152575f80fd5b505f546001600160a01b03165b6040516001600160a01b0390911681526020016100e1565b348015610182575f80fd5b506100d766038d7ea4c6800081565b34801561019c575f80fd5b5060015461015f906001600160a01b031681565b3480156101bb575f80fd5b506100d76101ca36600461084e565b610448565b61010961045a565b3480156101e2575f80fd5b506100d76101f136600461084e565b610686565b348015610201575f80fd5b5061010961021036600461084e565b610692565b348015610220575f80fd5b5061010961022f366004610865565b610729565b61023c610763565b6001546001600160a01b031663a9059cbb61025e5f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af11580156102a8573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102cc9190610892565b6102f15760405162461bcd60e51b81526004016102e8906108b1565b60405180910390fd5b5f546001600160a01b03166001600160a01b03167f6352c5382c4a4578e712449ca65e83cdb392d045dfcf1cad9615189db2da244b8260405161033691815260200190565b60405180910390a250565b610349610763565b478061038c5760405162461bcd60e51b81526020600482015260126024820152714e6f204d4e5420746f20776974686472617760701b60448201526064016102e8565b5f80546040516001600160a01b039091169183156108fc02918491818181858888f193505050501580156103c2573d5f803e3d5ffd5b5050565b6103ce610763565b6103d75f61078f565b565b6001546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa15801561041f573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061044391906108e0565b905090565b5f6104546064836108f7565b92915050565b6104626107de565b66038d7ea4c680003410156104b95760405162461bcd60e51b815260206004820152601d60248201527f4d696e696d756d20707572636861736520697320302e303031204d4e5400000060448201526064016102e8565b5f6104c5606434610916565b6001546040516370a0823160e01b81523060048201529192505f916001600160a01b03909116906370a0823190602401602060405180830381865afa158015610510573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053491906108e0565b9050818110156105925760405162461bcd60e51b8152602060048201526024808201527f496e73756666696369656e7420746f6b656e7320696e207377617020636f6e746044820152631c9858dd60e21b60648201526084016102e8565b60015460405163a9059cbb60e01b8152336004820152602481018490526001600160a01b039091169063a9059cbb906044016020604051808303815f875af11580156105e0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106049190610892565b6106205760405162461bcd60e51b81526004016102e8906108b1565b604080513481526020810184905233917f8fafebcaf9d154343dad25669bfa277f4fbacd7ac6b0c4fed522580e040a0f33910160405180910390a250506103d760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b5f610454606483610916565b6001546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af11580156106e6573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061070a9190610892565b6107265760405162461bcd60e51b81526004016102e8906108b1565b50565b610731610763565b6001600160a01b03811661075a57604051631e4fbdf760e01b81525f60048201526024016102e8565b6107268161078f565b5f546001600160a01b031633146103d75760405163118cdaa760e01b81523360048201526024016102e8565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6107e661080c565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00546002036103d757604051633ee5aeb560e01b815260040160405180910390fd5b5f6020828403121561085e575f80fd5b5035919050565b5f60208284031215610875575f80fd5b81356001600160a01b038116811461088b575f80fd5b9392505050565b5f602082840312156108a2575f80fd5b8151801515811461088b575f80fd5b602080825260159082015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b604082015260600190565b5f602082840312156108f0575f80fd5b5051919050565b5f8261091157634e487b7160e01b5f52601260045260245ffd5b500490565b808202811582820484141761045457634e487b7160e01b5f52601160045260245ffdfea264697066735822122022ebdbc7e4f730ba17e7e729a663fba52e6e5a0dd780a57b2af35c301da05b6f64736f6c63430008180033","sourceMap":"386:2907:54:-:0;;;836:102;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;876:10;;1269:95:0;;1322:31;;-1:-1:-1;;;1322:31:0;;1350:1;1322:31;;;455:51:57;428:18;;1322:31:0;;;;;;;1269:95;1373:32;1392:12;1373:18;:32::i;:::-;-1:-1:-1;2365:1:13;1505:66;2539;898:9:54::1;:33:::0;;-1:-1:-1;;;;;;898:33:54::1;-1:-1:-1::0;;;;;898:33:54;;;::::1;::::0;;;::::1;::::0;;386:2907;;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;14:290:57:-;84:6;137:2;125:9;116:7;112:23;108:32;105:52;;;153:1;150;143:12;105:52;179:16;;-1:-1:-1;;;;;224:31:57;;214:42;;204:70;;270:1;267;260:12;204:70;293:5;14:290;-1:-1:-1;;;14:290:57:o;309:203::-;386:2907:54;;;;;;","linkReferences":{}},"deployedBytecode":{"object":"0x6080604052600436106100bf575f3560e01c80639a5ed7381161007c578063d0febe4c11610057578063d0febe4c146101cf578063d87810d6146101d7578063dd49756e146101f6578063f2fde38b14610215575f80fd5b80639a5ed73814610177578063c3dfdae614610191578063d0dea103146101b0575f80fd5b806314a8bd0d146100c3578063315a095d146100ea5780636e5c09561461010b578063715018a61461011f57806382b2e257146101335780638da5cb5b14610147575b5f80fd5b3480156100ce575f80fd5b506100d7606481565b6040519081526020015b60405180910390f35b3480156100f5575f80fd5b5061010961010436600461084e565b610234565b005b348015610116575f80fd5b50610109610341565b34801561012a575f80fd5b506101096103c6565b34801561013e575f80fd5b506100d76103d9565b348015610152575f80fd5b505f546001600160a01b03165b6040516001600160a01b0390911681526020016100e1565b348015610182575f80fd5b506100d766038d7ea4c6800081565b34801561019c575f80fd5b5060015461015f906001600160a01b031681565b3480156101bb575f80fd5b506100d76101ca36600461084e565b610448565b61010961045a565b3480156101e2575f80fd5b506100d76101f136600461084e565b610686565b348015610201575f80fd5b5061010961021036600461084e565b610692565b348015610220575f80fd5b5061010961022f366004610865565b610729565b61023c610763565b6001546001600160a01b031663a9059cbb61025e5f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af11580156102a8573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102cc9190610892565b6102f15760405162461bcd60e51b81526004016102e8906108b1565b60405180910390fd5b5f546001600160a01b03166001600160a01b03167f6352c5382c4a4578e712449ca65e83cdb392d045dfcf1cad9615189db2da244b8260405161033691815260200190565b60405180910390a250565b610349610763565b478061038c5760405162461bcd60e51b81526020600482015260126024820152714e6f204d4e5420746f20776974686472617760701b60448201526064016102e8565b5f80546040516001600160a01b039091169183156108fc02918491818181858888f193505050501580156103c2573d5f803e3d5ffd5b5050565b6103ce610763565b6103d75f61078f565b565b6001546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa15801561041f573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061044391906108e0565b905090565b5f6104546064836108f7565b92915050565b6104626107de565b66038d7ea4c680003410156104b95760405162461bcd60e51b815260206004820152601d60248201527f4d696e696d756d20707572636861736520697320302e303031204d4e5400000060448201526064016102e8565b5f6104c5606434610916565b6001546040516370a0823160e01b81523060048201529192505f916001600160a01b03909116906370a0823190602401602060405180830381865afa158015610510573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053491906108e0565b9050818110156105925760405162461bcd60e51b8152602060048201526024808201527f496e73756666696369656e7420746f6b656e7320696e207377617020636f6e746044820152631c9858dd60e21b60648201526084016102e8565b60015460405163a9059cbb60e01b8152336004820152602481018490526001600160a01b039091169063a9059cbb906044016020604051808303815f875af11580156105e0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106049190610892565b6106205760405162461bcd60e51b81526004016102e8906108b1565b604080513481526020810184905233917f8fafebcaf9d154343dad25669bfa277f4fbacd7ac6b0c4fed522580e040a0f33910160405180910390a250506103d760017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b5f610454606483610916565b6001546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af11580156106e6573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061070a9190610892565b6107265760405162461bcd60e51b81526004016102e8906108b1565b50565b610731610763565b6001600160a01b03811661075a57604051631e4fbdf760e01b81525f60048201526024016102e8565b6107268161078f565b5f546001600160a01b031633146103d75760405163118cdaa760e01b81523360048201526024016102e8565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b6107e661080c565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00546002036103d757604051633ee5aeb560e01b815260040160405180910390fd5b5f6020828403121561085e575f80fd5b5035919050565b5f60208284031215610875575f80fd5b81356001600160a01b038116811461088b575f80fd5b9392505050565b5f602082840312156108a2575f80fd5b8151801515811461088b575f80fd5b602080825260159082015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b604082015260600190565b5f602082840312156108f0575f80fd5b5051919050565b5f8261091157634e487b7160e01b5f52601260045260245ffd5b500490565b808202811582820484141761045457634e487b7160e01b5f52601160045260245ffdfea264697066735822122022ebdbc7e4f730ba17e7e729a663fba52e6e5a0dd780a57b2af35c301da05b6f64736f6c63430008180033","sourceMap":"386:2907:54:-:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;542:43;;;;;;;;;;;;582:3;542:43;;;;;160:25:57;;;148:2;133:18;542:43:54;;;;;;;;2468:190;;;;;;;;;;-1:-1:-1;2468:190:54;;;;;:::i;:::-;;:::i;:::-;;1915:192;;;;;;;;;;;;;:::i;2293:101:0:-;;;;;;;;;;;;;:::i;3176:115:54:-;;;;;;;;;;;;;:::i;1638:85:0:-;;;;;;;;;;-1:-1:-1;1684:7:0;1710:6;-1:-1:-1;;;;;1710:6:0;1638:85;;;-1:-1:-1;;;;;545:32:57;;;527:51;;515:2;500:18;1638:85:0;381:203:57;591:54:54;;;;;;;;;;;;634:11;591:54;;439:26;;;;;;;;;;-1:-1:-1;439:26:54;;;;-1:-1:-1;;;;;439:26:54;;;2973:126;;;;;;;;;;-1:-1:-1;2973:126:54;;;;;:::i;:::-;;:::i;1074:763::-;;;:::i;2754:123::-;;;;;;;;;;-1:-1:-1;2754:123:54;;;;;:::i;:::-;;:::i;2214:154::-;;;;;;;;;;-1:-1:-1;2214:154:54;;;;;:::i;:::-;;:::i;2543:215:0:-;;;;;;;;;;-1:-1:-1;2543:215:0;;;;;:::i;:::-;;:::i;2468:190:54:-;1531:13:0;:11;:13::i;:::-;2543:9:54::1;::::0;-1:-1:-1;;;;;2543:9:54::1;:18;2562:7;1684::0::0;1710:6;-1:-1:-1;;;;;1710:6:0;;1638:85;2562:7:54::1;2543:35;::::0;-1:-1:-1;;;;;;2543:35:54::1;::::0;;;;;;-1:-1:-1;;;;;1299:32:57;;;2543:35:54::1;::::0;::::1;1281:51:57::0;1348:18;;;1341:34;;;1254:18;;2543:35:54::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2535:69;;;;-1:-1:-1::0;;;2535:69:54::1;;;;;;;:::i;:::-;;;;;;;;;1684:7:0::0;1710:6;-1:-1:-1;;;;;1710:6:0;-1:-1:-1;;;;;2619:32:54::1;;2644:6;2619:32;;;;160:25:57::0;;148:2;133:18;;14:177;2619:32:54::1;;;;;;;;2468:190:::0;:::o;1915:192::-;1531:13:0;:11;:13::i;:::-;1983:21:54::1;2022:11:::0;2014:42:::1;;;::::0;-1:-1:-1;;;2014:42:54;;2220:2:57;2014:42:54::1;::::0;::::1;2202:21:57::0;2259:2;2239:18;;;2232:30;-1:-1:-1;;;2278:18:57;;;2271:48;2336:18;;2014:42:54::1;2018:342:57::0;2014:42:54::1;1684:7:0::0;1710:6;;2066:34:54::1;::::0;-1:-1:-1;;;;;1710:6:0;;;;2066:34:54;::::1;;;::::0;2092:7;;2066:34;1684:7:0;2066:34:54;2092:7;1710:6:0;2066:34:54;::::1;;;;;;;;;;;;;::::0;::::1;;;;;;1955:152;1915:192::o:0;2293:101:0:-;1531:13;:11;:13::i;:::-;2357:30:::1;2384:1;2357:18;:30::i;:::-;2293:101::o:0;3176:115:54:-;3250:9;;:34;;-1:-1:-1;;;3250:34:54;;3278:4;3250:34;;;527:51:57;3224:7:54;;-1:-1:-1;;;;;3250:9:54;;:19;;500:18:57;;3250:34:54;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;3243:41;;3176:115;:::o;2973:126::-;3038:7;3064:28;582:3;3064:12;:28;:::i;:::-;3057:35;2973:126;-1:-1:-1;;2973:126:54:o;1074:763::-;3023:21:13;:19;:21::i;:::-;634:11:54::1;1141:9;:29;;1133:71;;;::::0;-1:-1:-1;;;1133:71:54;;2978:2:57;1133:71:54::1;::::0;::::1;2960:21:57::0;3017:2;2997:18;;;2990:30;3056:31;3036:18;;;3029:59;3105:18;;1133:71:54::1;2776:353:57::0;1133:71:54::1;1350:20;1373:25;582:3;1373:9;:25;:::i;:::-;1490:9;::::0;:34:::1;::::0;-1:-1:-1;;;1490:34:54;;1518:4:::1;1490:34;::::0;::::1;527:51:57::0;1350:48:54;;-1:-1:-1;1464:23:54::1;::::0;-1:-1:-1;;;;;1490:9:54;;::::1;::::0;:19:::1;::::0;500:18:57;;1490:34:54::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;1464:60;;1561:12;1542:15;:31;;1534:80;;;::::0;-1:-1:-1;;;1534:80:54;;3606:2:57;1534:80:54::1;::::0;::::1;3588:21:57::0;3645:2;3625:18;;;3618:30;3684:34;3664:18;;;3657:62;-1:-1:-1;;;3735:18:57;;;3728:34;3779:19;;1534:80:54::1;3404:400:57::0;1534:80:54::1;1684:9;::::0;:44:::1;::::0;-1:-1:-1;;;1684:44:54;;1703:10:::1;1684:44;::::0;::::1;1281:51:57::0;1348:18;;;1341:34;;;-1:-1:-1;;;;;1684:9:54;;::::1;::::0;:18:::1;::::0;1254::57;;1684:44:54::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;1676:78;;;;-1:-1:-1::0;;;1676:78:54::1;;;;;;;:::i;:::-;1778:52;::::0;;1806:9:::1;3983:25:57::0;;4039:2;4024:18;;4017:34;;;1794:10:54::1;::::0;1778:52:::1;::::0;3956:18:57;1778:52:54::1;;;;;;;1123:714;;3065:20:13::0;2365:1;1505:66;3972:62;3749:292;2754:123:54;2819:7;2845:25;582:3;2845:9;:25;:::i;2214:154::-;2278:9;;:57;;-1:-1:-1;;;2278:57:54;;2301:10;2278:57;;;4302:34:57;2321:4:54;4352:18:57;;;4345:43;4404:18;;;4397:34;;;-1:-1:-1;;;;;2278:9:54;;;;:22;;4237:18:57;;2278:57:54;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2270:91;;;;-1:-1:-1;;;2270:91:54;;;;;;;:::i;:::-;2214:154;:::o;2543:215:0:-;1531:13;:11;:13::i;:::-;-1:-1:-1;;;;;2627:22:0;::::1;2623:91;;2672:31;::::0;-1:-1:-1;;;2672:31:0;;2700:1:::1;2672:31;::::0;::::1;527:51:57::0;500:18;;2672:31:0::1;381:203:57::0;2623:91:0::1;2723:28;2742:8;2723:18;:28::i;1796:162::-:0;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;735:10:11;1855:23:0;1851:101;;1901:40;;-1:-1:-1;;;1901:40:0;;735:10:11;1901:40:0;;;527:51:57;500:18;;1901:40:0;381:203:57;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;3749:292:13:-;3872:25;:23;:25::i;:::-;2407:1;1505:66;3972:62;3749:292::o;3586:157::-;1505:66;4560:52;2407:1;4560:63;3644:93;;3696:30;;-1:-1:-1;;;3696:30:13;;;;;;;;;;;196:180:57;255:6;308:2;296:9;287:7;283:23;279:32;276:52;;;324:1;321;314:12;276:52;-1:-1:-1;347:23:57;;196:180;-1:-1:-1;196:180:57:o;816:286::-;875:6;928:2;916:9;907:7;903:23;899:32;896:52;;;944:1;941;934:12;896:52;970:23;;-1:-1:-1;;;;;1022:31:57;;1012:42;;1002:70;;1068:1;1065;1058:12;1002:70;1091:5;816:286;-1:-1:-1;;;816:286:57:o;1386:277::-;1453:6;1506:2;1494:9;1485:7;1481:23;1477:32;1474:52;;;1522:1;1519;1512:12;1474:52;1554:9;1548:16;1607:5;1600:13;1593:21;1586:5;1583:32;1573:60;;1629:1;1626;1619:12;1668:345;1870:2;1852:21;;;1909:2;1889:18;;;1882:30;-1:-1:-1;;;1943:2:57;1928:18;;1921:51;2004:2;1989:18;;1668:345::o;2365:184::-;2435:6;2488:2;2476:9;2467:7;2463:23;2459:32;2456:52;;;2504:1;2501;2494:12;2456:52;-1:-1:-1;2527:16:57;;2365:184;-1:-1:-1;2365:184:57:o;2554:217::-;2594:1;2620;2610:132;;2664:10;2659:3;2655:20;2652:1;2645:31;2699:4;2696:1;2689:15;2727:4;2724:1;2717:15;2610:132;-1:-1:-1;2756:9:57;;2554:217::o;3134:265::-;3207:9;;;3238;;3255:15;;;3249:22;;3235:37;3225:168;;3315:10;3310:3;3306:20;3303:1;3296:31;3350:4;3347:1;3340:15;3378:4;3375:1;3368:15","linkReferences":{}},"methodIdentifiers":{"EXCHANGE_RATE()":"14a8bd0d","MIN_PURCHASE_MNT()":"9a5ed738","buyTokens()":"d0febe4c","depositTokens(uint256)":"dd49756e","gameToken()":"c3dfdae6","getMntAmount(uint256)":"d0dea103","getTokenBalance()":"82b2e257","getTycoonAmount(uint256)":"d87810d6","owner()":"8da5cb5b","renounceOwnership()":"715018a6","transferOwnership(address)":"f2fde38b","withdrawMNT()":"6e5c0956","withdrawTokens(uint256)":"315a095d"},"rawMetadata":"{\"compiler\":{\"version\":\"0.8.24+commit.e11b9ed9\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_gameToken\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"OwnableInvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"OwnableUnauthorizedAccount\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"ReentrancyGuardReentrantCall\",\"type\":\"error\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"previousOwner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"OwnershipTransferred\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"buyer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"mntAmount\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"tycoonAmount\",\"type\":\"uint256\"}],\"name\":\"TokensPurchased\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"TokensWithdrawn\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"EXCHANGE_RATE\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"MIN_PURCHASE_MNT\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"buyTokens\",\"outputs\":[],\"stateMutability\":\"payable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"depositTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"gameToken\",\"outputs\":[{\"internalType\":\"contract GameToken\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tycoonAmount\",\"type\":\"uint256\"}],\"name\":\"getMntAmount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getTokenBalance\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"mntAmount\",\"type\":\"uint256\"}],\"name\":\"getTycoonAmount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"pure\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"renounceOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"transferOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"withdrawMNT\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"withdrawTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}],\"devdoc\":{\"details\":\"Exchange rate: 1 MNT = 100 TYCOON tokens\",\"errors\":{\"OwnableInvalidOwner(address)\":[{\"details\":\"The owner is not a valid owner account. (eg. `address(0)`)\"}],\"OwnableUnauthorizedAccount(address)\":[{\"details\":\"The caller account is not authorized to perform an operation.\"}],\"ReentrancyGuardReentrantCall()\":[{\"details\":\"Unauthorized reentrant call.\"}]},\"kind\":\"dev\",\"methods\":{\"buyTokens()\":{\"details\":\"Sends MNT to contract, transfers TYCOON tokens to buyer\"},\"owner()\":{\"details\":\"Returns the address of the current owner.\"},\"renounceOwnership()\":{\"details\":\"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner.\"},\"transferOwnership(address)\":{\"details\":\"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner.\"}},\"title\":\"TokenSwap\",\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{\"buyTokens()\":{\"notice\":\"Buy TYCOON tokens with MNT\"},\"depositTokens(uint256)\":{\"notice\":\"Owner can deposit TYCOON tokens to contract for users to purchase\"},\"getMntAmount(uint256)\":{\"notice\":\"Get the amount of MNT needed for a given TYCOON amount\"},\"getTokenBalance()\":{\"notice\":\"Get contract's TYCOON token balance\"},\"getTycoonAmount(uint256)\":{\"notice\":\"Get the amount of TYCOON tokens for a given MNT amount\"},\"withdrawMNT()\":{\"notice\":\"Owner can withdraw MNT from contract\"},\"withdrawTokens(uint256)\":{\"notice\":\"Owner can withdraw TYCOON tokens from contract (emergency)\"}},\"notice\":\"Allows users to buy TYCOON tokens with MNT\",\"version\":1}},\"settings\":{\"compilationTarget\":{\"src/TokenSwap.sol\":\"TokenSwap\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":true,\"runs\":200},\"remappings\":[\":@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/\",\":erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/\",\":forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/\",\":halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/\",\":openzeppelin-contracts/=lib/openzeppelin-contracts/\"]},\"sources\":{\"lib/openzeppelin-contracts/contracts/access/Ownable.sol\":{\"keccak256\":\"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6\",\"dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a\"]},\"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol\":{\"keccak256\":\"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c\",\"dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\":{\"keccak256\":\"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195\",\"dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\":{\"keccak256\":\"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303\",\"dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol\":{\"keccak256\":\"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e\",\"dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR\"]},\"lib/openzeppelin-contracts/contracts/utils/Context.sol\":{\"keccak256\":\"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12\",\"dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF\"]},\"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol\":{\"keccak256\":\"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99\",\"dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N\"]},\"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol\":{\"keccak256\":\"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b\",\"dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM\"]},\"src/GameToken.sol\":{\"keccak256\":\"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28\",\"dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35\"]},\"src/TokenSwap.sol\":{\"keccak256\":\"0x578684bf663eca8ac20f5408c76cca46342a32a32cb8e46fc93fee84aa8e26de\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://e0b77cca2265a4195c265d7e98581fb54060dd6024fc7cb208f396f72681f740\",\"dweb:/ipfs/QmYmBm4FxT8SJrUfC4C9UqxGLFMU9MJSv98G16ZWvgB7zY\"]}},\"version\":1}","metadata":{"compiler":{"version":"0.8.24+commit.e11b9ed9"},"language":"Solidity","output":{"abi":[{"inputs":[{"internalType":"address","name":"_gameToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"OwnableInvalidOwner"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"type":"error","name":"OwnableUnauthorizedAccount"},{"inputs":[],"type":"error","name":"ReentrancyGuardReentrantCall"},{"inputs":[{"internalType":"address","name":"previousOwner","type":"address","indexed":true},{"internalType":"address","name":"newOwner","type":"address","indexed":true}],"type":"event","name":"OwnershipTransferred","anonymous":false},{"inputs":[{"internalType":"address","name":"buyer","type":"address","indexed":true},{"internalType":"uint256","name":"mntAmount","type":"uint256","indexed":false},{"internalType":"uint256","name":"tycoonAmount","type":"uint256","indexed":false}],"type":"event","name":"TokensPurchased","anonymous":false},{"inputs":[{"internalType":"address","name":"to","type":"address","indexed":true},{"internalType":"uint256","name":"amount","type":"uint256","indexed":false}],"type":"event","name":"TokensWithdrawn","anonymous":false},{"inputs":[],"stateMutability":"view","type":"function","name":"EXCHANGE_RATE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"MIN_PURCHASE_MNT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"payable","type":"function","name":"buyTokens"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"depositTokens"},{"inputs":[],"stateMutability":"view","type":"function","name":"gameToken","outputs":[{"internalType":"contract GameToken","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"tycoonAmount","type":"uint256"}],"stateMutability":"pure","type":"function","name":"getMntAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"getTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"mntAmount","type":"uint256"}],"stateMutability":"pure","type":"function","name":"getTycoonAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"renounceOwnership"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"transferOwnership"},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"withdrawMNT"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"withdrawTokens"}],"devdoc":{"kind":"dev","methods":{"buyTokens()":{"details":"Sends MNT to contract, transfers TYCOON tokens to buyer"},"owner()":{"details":"Returns the address of the current owner."},"renounceOwnership()":{"details":"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner."},"transferOwnership(address)":{"details":"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner."}},"version":1},"userdoc":{"kind":"user","methods":{"buyTokens()":{"notice":"Buy TYCOON tokens with MNT"},"depositTokens(uint256)":{"notice":"Owner can deposit TYCOON tokens to contract for users to purchase"},"getMntAmount(uint256)":{"notice":"Get the amount of MNT needed for a given TYCOON amount"},"getTokenBalance()":{"notice":"Get contract's TYCOON token balance"},"getTycoonAmount(uint256)":{"notice":"Get the amount of TYCOON tokens for a given MNT amount"},"withdrawMNT()":{"notice":"Owner can withdraw MNT from contract"},"withdrawTokens(uint256)":{"notice":"Owner can withdraw TYCOON tokens from contract (emergency)"}},"version":1}},"settings":{"remappings":["@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/","erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/","forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/","halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/","openzeppelin-contracts/=lib/openzeppelin-contracts/"],"optimizer":{"enabled":true,"runs":200},"metadata":{"bytecodeHash":"ipfs"},"compilationTarget":{"src/TokenSwap.sol":"TokenSwap"},"evmVersion":"cancun","libraries":{}},"sources":{"lib/openzeppelin-contracts/contracts/access/Ownable.sol":{"keccak256":"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb","urls":["bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6","dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol":{"keccak256":"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998","urls":["bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c","dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol":{"keccak256":"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29","urls":["bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195","dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol":{"keccak256":"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2","urls":["bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303","dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol":{"keccak256":"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f","urls":["bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e","dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Context.sol":{"keccak256":"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2","urls":["bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12","dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol":{"keccak256":"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53","urls":["bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99","dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol":{"keccak256":"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97","urls":["bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b","dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM"],"license":"MIT"},"src/GameToken.sol":{"keccak256":"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169","urls":["bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28","dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35"],"license":"MIT"},"src/TokenSwap.sol":{"keccak256":"0x578684bf663eca8ac20f5408c76cca46342a32a32cb8e46fc93fee84aa8e26de","urls":["bzz-raw://e0b77cca2265a4195c265d7e98581fb54060dd6024fc7cb208f396f72681f740","dweb:/ipfs/QmYmBm4FxT8SJrUfC4C9UqxGLFMU9MJSv98G16ZWvgB7zY"],"license":"MIT"}},"version":1},"id":54}
</file>

<file path="frontend/public/abis/YieldDistributor.json">
[
  {
    "type": "constructor",
    "inputs": [
      {
        "name": "_propertyNFT",
        "type": "address",
        "internalType": "address"
      },
      {
        "name": "_gameToken",
        "type": "address",
        "internalType": "address"
      }
    ],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "YIELD_UPDATE_INTERVAL",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "batchClaimYield",
    "inputs": [
      {
        "name": "propertyIds",
        "type": "uint256[]",
        "internalType": "uint256[]"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "batchDistributeYield",
    "inputs": [
      {
        "name": "propertyIds",
        "type": "uint256[]",
        "internalType": "uint256[]"
      },
      {
        "name": "amounts",
        "type": "uint256[]",
        "internalType": "uint256[]"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "calculateYield",
    "inputs": [
      {
        "name": "propertyId",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "claimYield",
    "inputs": [
      {
        "name": "propertyId",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "distributeYield",
    "inputs": [
      {
        "name": "propertyId",
        "type": "uint256",
        "internalType": "uint256"
      },
      {
        "name": "amount",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "gameToken",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "contract IERC20"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "getTotalPendingYield",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "lastYieldUpdate",
    "inputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "owner",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "address"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "pendingYield",
    "inputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "propertyNFT",
    "inputs": [],
    "outputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "contract PropertyNFT"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "renounceOwnership",
    "inputs": [],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "function",
    "name": "totalYieldClaimed",
    "inputs": [
      {
        "name": "",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [
      {
        "name": "",
        "type": "uint256",
        "internalType": "uint256"
      }
    ],
    "stateMutability": "view"
  },
  {
    "type": "function",
    "name": "transferOwnership",
    "inputs": [
      {
        "name": "newOwner",
        "type": "address",
        "internalType": "address"
      }
    ],
    "outputs": [],
    "stateMutability": "nonpayable"
  },
  {
    "type": "event",
    "name": "BatchYieldClaimed",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "propertyIds",
        "type": "uint256[]",
        "indexed": false,
        "internalType": "uint256[]"
      },
      {
        "name": "totalAmount",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "BatchYieldDistributed",
    "inputs": [
      {
        "name": "propertyIds",
        "type": "uint256[]",
        "indexed": false,
        "internalType": "uint256[]"
      },
      {
        "name": "amounts",
        "type": "uint256[]",
        "indexed": false,
        "internalType": "uint256[]"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "OwnershipTransferred",
    "inputs": [
      {
        "name": "previousOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "newOwner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "YieldClaimed",
    "inputs": [
      {
        "name": "propertyId",
        "type": "uint256",
        "indexed": true,
        "internalType": "uint256"
      },
      {
        "name": "owner",
        "type": "address",
        "indexed": true,
        "internalType": "address"
      },
      {
        "name": "amount",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "event",
    "name": "YieldDistributed",
    "inputs": [
      {
        "name": "propertyId",
        "type": "uint256",
        "indexed": true,
        "internalType": "uint256"
      },
      {
        "name": "amount",
        "type": "uint256",
        "indexed": false,
        "internalType": "uint256"
      }
    ],
    "anonymous": false
  },
  {
    "type": "error",
    "name": "OwnableInvalidOwner",
    "inputs": [
      {
        "name": "owner",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "OwnableUnauthorizedAccount",
    "inputs": [
      {
        "name": "account",
        "type": "address",
        "internalType": "address"
      }
    ]
  },
  {
    "type": "error",
    "name": "ReentrancyGuardReentrantCall",
    "inputs": []
  }
]
</file>

<file path="frontend/src/components/game/PropertyMap.tsx">

</file>

<file path="frontend/src/components/GlobalChat.tsx">
'use client';

import { useState, useEffect, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Send, Globe, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { useChat } from '@/hooks/useChat';

interface GlobalChatProps {
  isOpen: boolean;
  onClose: () => void;
}

export function GlobalChat({ isOpen, onClose }: GlobalChatProps) {
  const { messages, isLoading, isSending, sendMessage } = useChat();
  const [inputValue, setInputValue] = useState('');
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [messages, isOpen]);

  const handleSend = async () => {
    if (!inputValue.trim()) return;
    
    try {
      await sendMessage(inputValue);
      setInputValue('');
    } catch (error) {
      console.error('Failed to send message:', error);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50"
          />

          {/* Chat Panel */}
          <motion.div
            initial={{ x: '100%' }}
            animate={{ x: 0 }}
            exit={{ x: '100%' }}
            transition={{ type: 'spring', damping: 25, stiffness: 200 }}
            className="fixed right-0 top-0 bottom-0 w-full max-w-md z-50 bg-gradient-to-l from-gray-900/95 to-gray-900/90 backdrop-blur-xl border-l border-white/10 shadow-2xl flex flex-col"
          >
            {/* Header */}
            <div className="p-4 border-b border-white/10 flex items-center justify-between bg-white/5">
              <div className="flex items-center gap-3">
                <div className="relative">
                  <div className="absolute inset-0 bg-emerald-500 blur-md opacity-50 rounded-full" />
                  <div className="relative bg-gradient-to-br from-emerald-500 to-teal-600 p-2 rounded-full">
                    <Globe className="w-5 h-5 text-white" />
                  </div>
                </div>
                <div>
                  <h2 className="text-lg font-bold text-white flex items-center gap-2">
                    Global Chat
                    <span className="flex h-2 w-2 rounded-full bg-emerald-500 animate-pulse" />
                  </h2>
                  <p className="text-xs text-emerald-400/80">Live on Mantle Network</p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="icon"
                onClick={onClose}
                className="text-gray-400 hover:text-white hover:bg-white/10 rounded-full"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>

            {/* Messages Area */}
            <ScrollArea className="flex-1 p-4">
              {isLoading && messages.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                  <Loader2 className="w-8 h-8 animate-spin mb-2 text-emerald-500" />
                  <p>Loading messages...</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {messages.length === 0 && (
                    <div className="text-center text-gray-500 py-10">
                      <p>No messages yet. Be the first to say hello!</p>
                    </div>
                  )}
                  
                  {messages.map((msg) => (
                    <motion.div
                      key={msg.id}
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      className={`flex ${msg.isMe ? 'justify-end' : 'justify-start'}`}
                    >
                      <div className={`flex gap-3 max-w-[85%] ${msg.isMe ? 'flex-row-reverse' : 'flex-row'}`}>
                        {!msg.isMe && (
                          <Avatar className="w-8 h-8 border border-white/20">
                            {msg.avatar ? (
                              <img src={msg.avatar} alt={msg.username || msg.walletAddress} className="w-full h-full" />
                            ) : (
                              <AvatarFallback className="bg-gradient-to-br from-indigo-500 to-purple-600 text-xs text-white">
                                {msg.username?.[0] || msg.walletAddress.slice(2, 3).toUpperCase()}
                              </AvatarFallback>
                            )}
                          </Avatar>
                        )}
                        <div className={`space-y-1 ${msg.isMe ? 'items-end' : 'items-start'} flex flex-col`}>
                          {!msg.isMe && (
                            <span className="text-xs text-gray-400 ml-1">
                              {msg.username || `${msg.walletAddress.slice(0, 6)}...${msg.walletAddress.slice(-4)}`}
                            </span>
                          )}
                          <div
                            className={`p-3 rounded-2xl text-sm leading-relaxed shadow-lg backdrop-blur-sm ${
                              msg.isMe
                                ? 'bg-gradient-to-br from-emerald-600 to-teal-600 text-white rounded-tr-none'
                                : 'bg-white/10 text-gray-100 border border-white/10 rounded-tl-none'
                            }`}
                          >
                            {msg.message}
                          </div>
                          <span className="text-[10px] text-gray-500 px-1">
                            {new Date(msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                      </div>
                    </motion.div>
                  ))}
                  <div ref={scrollRef} />
                </div>
              )}
            </ScrollArea>

            {/* Input Area */}
            <div className="p-4 border-t border-white/10 bg-black/20 backdrop-blur-md">
              <div className="flex gap-2">
                <Input
                  value={inputValue}
                  onChange={(e) => setInputValue(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder="Type a message..."
                  disabled={isSending}
                  className="bg-white/5 border-white/10 text-white placeholder:text-gray-500 focus-visible:ring-emerald-500/50 focus-visible:border-emerald-500/50"
                />
                <Button
                  onClick={handleSend}
                  disabled={isSending || !inputValue.trim()}
                  className="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white shadow-lg shadow-emerald-900/20"
                >
                  {isSending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                </Button>
              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
}
</file>

<file path="frontend/src/components/TokenPurchase.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract } from 'wagmi';
import { parseEther, formatEther } from 'viem';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Coins, Loader2 } from 'lucide-react';
import { CONTRACTS, TOKEN_SWAP_ABI } from '@/lib/contracts';

export function TokenPurchase() {
  const { address, isConnected } = useAccount();
  const [mntAmount, setMntAmount] = useState<string>('0.01');
  const [isPurchasing, setIsPurchasing] = useState(false);

  const { writeContract: writeBuyTokens, data: buyHash, isPending: isBuyPending } = useWriteContract();

  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
    hash: buyHash,
  });

  // Calculate TYCOON amount (1 MNT = 100 TYCOON)
  const tycoonAmount = mntAmount ? (parseFloat(mntAmount) * 100).toFixed(0) : '0';

  // Get TokenSwap balance
  const { data: swapBalance } = useReadContract({
    address: CONTRACTS.TokenSwap,
    abi: TOKEN_SWAP_ABI,
    functionName: 'getTokenBalance',
    query: { enabled: !!CONTRACTS.TokenSwap },
  });

  const handlePurchase = async () => {
    if (!address || !isConnected) return;
    if (!mntAmount || parseFloat(mntAmount) < 0.001) {
      alert('Minimum purchase is 0.001 MNT');
      return;
    }

    try {
      setIsPurchasing(true);
      const mntAmountWei = parseEther(mntAmount);
      
      writeBuyTokens({
        address: CONTRACTS.TokenSwap,
        abi: TOKEN_SWAP_ABI,
        functionName: 'buyTokens',
        value: mntAmountWei,
      });
    } catch (error) {
      console.error('Error purchasing tokens:', error);
      alert('Failed to purchase tokens. Please try again.');
      setIsPurchasing(false);
    }
  };

  // Reset after successful purchase
  useEffect(() => {
    if (isConfirmed && isPurchasing) {
      setIsPurchasing(false);
      setMntAmount('0.01');
      // Balance will update automatically via useReadContract hook
    }
  }, [isConfirmed, isPurchasing]);

  const isProcessing = isBuyPending || isConfirming || isPurchasing;
  const canPurchase = isConnected && mntAmount && parseFloat(mntAmount) >= 0.001 && !isProcessing;

  return (
    <Card className="border-white/10 bg-white/5 backdrop-blur-md">
      <CardHeader>
        <CardTitle className="text-white flex items-center gap-2">
          <Coins className="w-5 h-5" />
          Buy TYCOON Tokens
        </CardTitle>
        <p className="text-sm text-gray-400">
          Exchange Rate: 1 MNT = 100 TYCOON
        </p>
        {swapBalance && (
          <p className="text-xs text-gray-500">
            Available: {formatEther(swapBalance as bigint)} TYCOON
          </p>
        )}
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <label className="text-sm text-gray-300 mb-2 block">MNT Amount</label>
          <Input
            type="number"
            step="0.001"
            min="0.001"
            value={mntAmount}
            onChange={(e) => setMntAmount(e.target.value)}
            placeholder="0.01"
            disabled={isProcessing}
            className="bg-white/5 border-white/10 text-white"
          />
          <p className="text-xs text-gray-400 mt-1">
            Minimum: 0.001 MNT
          </p>
        </div>

        <div className="p-3 bg-white/5 rounded-lg border border-white/10">
          <div className="flex justify-between items-center">
            <span className="text-sm text-gray-300">You will receive:</span>
            <span className="text-lg font-semibold text-emerald-400">
              {tycoonAmount} TYCOON
            </span>
          </div>
        </div>

        {!isConnected ? (
          <Button disabled className="w-full">
            Connect Wallet to Purchase
          </Button>
        ) : (
          <Button
            onClick={handlePurchase}
            disabled={!canPurchase}
            className="w-full"
          >
            {isProcessing ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                {isBuyPending ? 'Confirming...' : isConfirming ? 'Processing...' : 'Purchasing...'}
              </>
            ) : (
              `Buy ${tycoonAmount} TYCOON`
            )}
          </Button>
        )}

        {buyHash && (
          <p className="text-xs text-gray-400 text-center">
            Transaction: {buyHash.slice(0, 10)}...{buyHash.slice(-8)}
          </p>
        )}

        {isConfirmed && (
          <div className="p-3 bg-emerald-500/20 border border-emerald-500/50 rounded-lg">
            <p className="text-sm text-emerald-400 text-center">
               Purchase successful! Your TYCOON balance will update automatically.
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
</file>

<file path="frontend/src/components/WalletConnect.tsx">
'use client';

import { useAccount } from 'wagmi';
import { formatAddress } from '@/lib/utils';

export function WalletConnect() {
  const { address, isConnected } = useAccount();

  if (isConnected && address) {
    return (
      <div className="flex items-center gap-3">
        <div className="px-4 py-2 rounded-lg bg-white/10 backdrop-blur-sm border border-white/20">
          <span className="text-sm font-medium text-white font-numbers">
            {formatAddress(address)}
          </span>
        </div>
        <w3m-button balance="hide" />
      </div>
    );
  }

  return <w3m-button />;
}
</file>

<file path="frontend/src/hooks/useMNTPrice.ts">
'use client';

import { useState, useEffect, useRef } from 'react';
import { io, Socket } from 'socket.io-client';

// Backend API endpoint for MNT price (uses whitelisted backend wallet)
const BACKEND_API_URL = process.env.NEXT_PUBLIC_API_URL 
  ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') 
  : 'http://localhost:3001';

// Cache price for 5 minutes
const PRICE_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

interface PriceCache {
  price: number;
  timestamp: number;
}

let priceCache: PriceCache | null = null;

/**
 * Hook to fetch MNT/USD price from Chronicle Oracle
 * Returns TYCOON/USD rate (since 1 MNT = 100 TYCOON)
 */
export function useMNTPrice() {
  const [mntPrice, setMntPrice] = useState<number | null>(null);
  const [tycoonPrice, setTycoonPrice] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const socketRef = useRef<Socket | null>(null);

  useEffect(() => {
    // Initial fetch from API
    const fetchInitialPrice = async () => {
      try {
        setLoading(true);
        setError(null);

        const response = await fetch(`${BACKEND_API_URL}/api/oracle/mnt-price`);
        const data = await response.json();

        if (data.success && data.mntPriceUSD) {
          const priceInUSD = data.mntPriceUSD;
          const tycoonUSD = data.tycoonPriceUSD || priceInUSD / 100;

          // Update cache
          priceCache = {
            price: priceInUSD,
            timestamp: Date.now(),
          };

          setMntPrice(priceInUSD);
          setTycoonPrice(tycoonUSD);
          setLoading(false);
          console.log(` Chronicle Oracle (via backend): MNT/USD = $${priceInUSD.toFixed(4)}, TYCOON/USD = $${tycoonUSD.toFixed(6)}`);
        } else {
          // Backend returned fallback price
          const fallbackPrice = data.mntPriceUSD || 0.98;
          const tycoonUSD = data.tycoonPriceUSD || fallbackPrice / 100;
          setMntPrice(fallbackPrice);
          setTycoonPrice(tycoonUSD);
          setLoading(false);
        }
      } catch (err: any) {
        console.error(' Failed to fetch MNT price from backend:', err);
        setError(err.message || 'Failed to fetch price');
        setLoading(false);
        
        // Use cached price if available
        if (priceCache) {
          setMntPrice(priceCache.price);
          setTycoonPrice(priceCache.price / 100);
        } else {
          // Fallback: Use approximate MNT price
          const fallbackPrice = 0.98;
          setMntPrice(fallbackPrice);
          setTycoonPrice(fallbackPrice / 100);
        }
      }
    };

    // Set up Socket.io connection for real-time price updates
    const socket: Socket = io(BACKEND_API_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
    });

    socketRef.current = socket;

    socket.on('connect', () => {
      console.log(' Connected to WebSocket for price updates');
    });

    socket.on('price:update', (data: { mntPriceUSD: number; tycoonPriceUSD: number; timestamp: number }) => {
      console.log(` Real-time price update: MNT/USD = $${data.mntPriceUSD.toFixed(4)}, TYCOON/USD = $${data.tycoonPriceUSD.toFixed(6)}`);
      
      // Update cache
      priceCache = {
        price: data.mntPriceUSD,
        timestamp: data.timestamp,
      };

      // Update state
      setMntPrice(data.mntPriceUSD);
      setTycoonPrice(data.tycoonPriceUSD);
      setLoading(false);
      setError(null);
    });

    socket.on('disconnect', () => {
      console.warn(' Disconnected from WebSocket for price updates');
    });

    socket.on('connect_error', (err) => {
      console.warn(' WebSocket connection error:', err.message);
    });

    // Fetch initial price
    fetchInitialPrice();

    // Cleanup on unmount
    return () => {
      if (socketRef.current) {
        socketRef.current.disconnect();
        socketRef.current = null;
      }
    };
  }, []);

  return {
    mntPriceUSD: mntPrice,
    tycoonPriceUSD: tycoonPrice,
    loading,
    error,
  };
}

/**
 * Convert TYCOON amount to USD
 */
export function tycoonToUSD(tycoonAmount: bigint | number, tycoonPriceUSD: number | null): number | null {
  if (!tycoonPriceUSD) return null;
  
  const tycoonNum = typeof tycoonAmount === 'bigint' 
    ? Number(tycoonAmount) / 1e18 
    : tycoonAmount;
  
  return tycoonNum * tycoonPriceUSD;
}

/**
 * Format USD value for display
 */
export function formatUSD(usdValue: number | null): string {
  if (usdValue === null) return '';
  if (usdValue < 0.01) return `$${usdValue.toFixed(4)}`;
  if (usdValue < 1) return `$${usdValue.toFixed(2)}`;
  return `$${usdValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "db:init": "ts-node -r tsconfig-paths/register src/database/init-db.ts"
  },
  "dependencies": {
    "@mantleio/sdk": "^1.0.5",
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/platform-socket.io": "^11.1.10",
    "@nestjs/swagger": "^11.2.3",
    "@nestjs/websockets": "^11.1.10",
    "@types/pg": "^8.16.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.3",
    "drizzle-orm": "^0.45.1",
    "ethers": "^5.8.0",
    "postgres": "^3.4.7",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "socket.io": "^4.8.3"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}
</file>

<file path="backend/src/chat/chat.service.ts">
import { Injectable, Logger, Inject } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, desc } from 'drizzle-orm';
import { WebsocketGateway } from '../websocket/websocket.gateway';

export interface ChatMessageDto {
  id: string;
  userId: string;
  walletAddress: string;
  username?: string;
  avatar?: string;
  message: string;
  createdAt: Date;
}

@Injectable()
export class ChatService {
  private readonly logger = new Logger(ChatService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private websocketGateway: WebsocketGateway,
  ) {}

  async sendMessage(walletAddress: string, message: string): Promise<ChatMessageDto> {
    // Get or create user
    let [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      [user] = await this.db
        .insert(schema.users)
        .values({
          walletAddress: walletAddress.toLowerCase(),
          createdAt: new Date(),
          updatedAt: new Date(),
        })
        .returning();
    }

    // Create chat message
    const [chatMessage] = await this.db
      .insert(schema.chatMessages)
      .values({
        userId: user.id,
        message: message.trim(),
        createdAt: new Date(),
      })
      .returning();

    // Generate avatar URL using dicebear (using wallet address as seed)
    const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.walletAddress}`;

    const messageDto = {
      id: chatMessage.id,
      userId: user.id,
      walletAddress: user.walletAddress,
      username: user.username || undefined,
      avatar: avatarUrl,
      message: chatMessage.message,
      createdAt: chatMessage.createdAt,
    };

    // Broadcast via WebSocket
    this.websocketGateway.emitChatMessage(messageDto);

    return messageDto;
  }

  async getRecentMessages(limit: number = 50): Promise<ChatMessageDto[]> {
    const messages = await this.db
      .select({
        id: schema.chatMessages.id,
        userId: schema.chatMessages.userId,
        message: schema.chatMessages.message,
        createdAt: schema.chatMessages.createdAt,
        walletAddress: schema.users.walletAddress,
        username: schema.users.username,
      })
      .from(schema.chatMessages)
      .leftJoin(schema.users, eq(schema.chatMessages.userId, schema.users.id))
      .orderBy(desc(schema.chatMessages.createdAt))
      .limit(limit);

    return messages.map((msg) => {
      // Generate avatar URL using dicebear (using wallet address as seed)
      const avatarUrl = msg.walletAddress 
        ? `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.walletAddress}`
        : undefined;

      return {
        id: msg.id,
        userId: msg.userId,
        walletAddress: msg.walletAddress || '',
        username: msg.username || undefined,
        avatar: avatarUrl,
        message: msg.message,
        createdAt: msg.createdAt,
      };
    });
  }
}
</file>

<file path="backend/src/contracts/abis/Marketplace.json">
{"abi":[{"type":"constructor","inputs":[{"name":"_propertyNFT","type":"address","internalType":"address"},{"name":"_gameToken","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"auctionFee","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"auctions","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"seller","type":"address","internalType":"address"},{"name":"startingPrice","type":"uint256","internalType":"uint256"},{"name":"highestBid","type":"uint256","internalType":"uint256"},{"name":"highestBidder","type":"address","internalType":"address"},{"name":"endTime","type":"uint256","internalType":"uint256"},{"name":"isActive","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"batchListProperties","inputs":[{"name":"propertyIds","type":"uint256[]","internalType":"uint256[]"},{"name":"prices","type":"uint256[]","internalType":"uint256[]"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"buyProperty","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"cancelListing","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"createAuction","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"startingPrice","type":"uint256","internalType":"uint256"},{"name":"duration","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"endAuction","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"gameToken","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract GameToken"}],"stateMutability":"view"},{"type":"function","name":"getActiveListings","inputs":[],"outputs":[{"name":"propertyIds","type":"uint256[]","internalType":"uint256[]"},{"name":"sellers","type":"address[]","internalType":"address[]"},{"name":"prices","type":"uint256[]","internalType":"uint256[]"}],"stateMutability":"view"},{"type":"function","name":"getActiveListingsCount","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"listProperty","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"price","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"listingFee","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"listings","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"seller","type":"address","internalType":"address"},{"name":"price","type":"uint256","internalType":"uint256"},{"name":"isActive","type":"bool","internalType":"bool"},{"name":"createdAt","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"placeBid","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"bidAmount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"propertyNFT","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract PropertyNFT"}],"stateMutability":"view"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"AuctionCreated","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"seller","type":"address","indexed":true,"internalType":"address"},{"name":"startingPrice","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"endTime","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"AuctionEnded","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"winner","type":"address","indexed":true,"internalType":"address"},{"name":"finalPrice","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"BidPlaced","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"bidder","type":"address","indexed":true,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"ListingCancelled","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"PropertyListed","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"seller","type":"address","indexed":true,"internalType":"address"},{"name":"price","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"PropertySold","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"seller","type":"address","indexed":true,"internalType":"address"},{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"price","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]},{"type":"error","name":"ReentrancyGuardReentrantCall","inputs":[]}],"bytecode":{"object":"0x6080604052601960055560196006553480156200001a575f80fd5b5060405162001cbc38038062001cbc8339810160408190526200003d9162000130565b60017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005533806200008757604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b6200009281620000c5565b50600180546001600160a01b039384166001600160a01b0319918216179091556002805492909316911617905562000166565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b80516001600160a01b03811681146200012b575f80fd5b919050565b5f806040838503121562000142575f80fd5b6200014d8362000114565b91506200015d6020840162000114565b90509250929050565b611b4880620001745f395ff3fe608060405234801561000f575f80fd5b5060043610610111575f3560e01c80637b55927c1161009e578063c3999a321161006e578063c3999a321461029c578063c3dfdae6146102af578063cda4beef146102c2578063de74e57b146102d5578063f2fde38b14610354575f80fd5b80637b55927c1461025a57806387c35bc0146102625780638da5cb5b14610279578063b9a2de3a14610289575f80fd5b8063571a26a0116100e4578063571a26a01461018457806357c90de5146102235780636a1b7ecc146102365780636fa830a61461023f578063715018a614610252575f80fd5b806314525b6b14610115578063305a67a81461013157806337f76838146101465780634eda529b14610171575b5f80fd5b61011e60065481565b6040519081526020015b60405180910390f35b61014461013f366004611741565b610367565b005b600154610159906001600160a01b031681565b6040516001600160a01b039091168152602001610128565b61014461017f366004611758565b61049e565b6101df610192366004611741565b600460208190525f9182526040909120805460018201546002830154600384015494840154600585015460069095015493956001600160a01b039384169592949093909116919060ff1687565b604080519788526001600160a01b0396871660208901528701949094526060860192909252909216608084015260a0830191909152151560c082015260e001610128565b610144610231366004611758565b6106fd565b61011e60055481565b61014461024d366004611741565b610956565b610144610bb6565b61011e610bc9565b61026a610c9e565b604051610128939291906117b2565b5f546001600160a01b0316610159565b610144610297366004611741565b610f2f565b6101446102aa36600461186b565b611267565b600254610159906001600160a01b031681565b6101446102d03660046118d2565b611352565b6103226102e3366004611741565b600360208190525f91825260409091208054600182015460028301549383015460049093015491936001600160a01b0390911692909160ff9091169085565b604080519586526001600160a01b0390941660208601529284019190915215156060830152608082015260a001610128565b61014461036236600461190f565b611642565b5f81815260036020526040902060018101546001600160a01b031633146103c25760405162461bcd60e51b815260206004820152600a6024820152692737ba1039b2b63632b960b11b60448201526064015b60405180910390fd5b600381015460ff166104035760405162461bcd60e51b815260206004820152600a6024820152694e6f742061637469766560b01b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061043790309033908790600401611931565b5f604051808303815f87803b15801561044e575f80fd5b505af1158015610460573d5f803e3d5ffd5b50505060038201805460ff191690555060405182907f411aee90354c51b1b04cd563fcab2617142a9d50da19232d888547c8a1b7fd8a905f90a25050565b6001546040516331a9108f60e11b81526004810184905233916001600160a01b031690636352211e90602401602060405180830381865afa1580156104e5573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105099190611955565b6001600160a01b03161461054b5760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b60448201526064016103b9565b5f811161058a5760405162461bcd60e51b815260206004820152600d60248201526c496e76616c696420707269636560981b60448201526064016103b9565b5f828152600360208190526040909120015460ff16156105dd5760405162461bcd60e51b815260206004820152600e60248201526d105b1c9958591e481b1a5cdd195960921b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061061190339030908790600401611931565b5f604051808303815f87803b158015610628575f80fd5b505af115801561063a573d5f803e3d5ffd5b50506040805160a08101825285815233602080830182815283850188815260016060860181815242608088019081525f8d81526003808852908a902098518955945192880180546001600160a01b0319166001600160a01b0390941693909317909255915160028701559051918501805460ff1916921515929092179091555160049093019290925591518581529193508592507f23fb658c1698b92f5fe511a079c17ecf7965cbc3f1b873328c67e2c3c0820f1f910160405180910390a35050565b61070561167c565b5f828152600460205260409020600681015460ff1661075b5760405162461bcd60e51b815260206004820152601260248201527141756374696f6e206e6f742061637469766560701b60448201526064016103b9565b8060050154421061079e5760405162461bcd60e51b815260206004820152600d60248201526c105d58dd1a5bdb88195b991959609a1b60448201526064016103b9565b806003015482116107df5760405162461bcd60e51b815260206004820152600b60248201526a42696420746f6f206c6f7760a81b60448201526064016103b9565b60048101546001600160a01b03161561087357600254600482810154600384015460405163a9059cbb60e01b81526001600160a01b039283169381019390935260248301529091169063a9059cbb906044016020604051808303815f875af115801561084d573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108719190611970565b505b6002546040516323b872dd60e01b81526001600160a01b03909116906323b872dd906108a790339030908790600401611931565b6020604051808303815f875af11580156108c3573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108e79190611970565b50600381018290556004810180546001600160a01b0319163390811790915560405183815284907f0e54eff26401bf69b81b26f60bd85ef47f5d85275c1d268d84f68d6897431c479060200160405180910390a35061095260015f80516020611af383398151915255565b5050565b61095e61167c565b5f8181526003602081905260409091209081015460ff166109ae5760405162461bcd60e51b815260206004820152600a602482015269139bdd081b1a5cdd195960b21b60448201526064016103b9565b5f6103e860055483600201546109c491906119a3565b6109ce91906119c0565b90505f8183600201546109e191906119df565b60025460018501546040516323b872dd60e01b81529293506001600160a01b03918216926323b872dd92610a1e9233929116908690600401611931565b6020604051808303815f875af1158015610a3a573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610a5e9190611970565b506002546001600160a01b03166323b872dd33610a825f546001600160a01b031690565b856040518463ffffffff1660e01b8152600401610aa193929190611931565b6020604051808303815f875af1158015610abd573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610ae19190611970565b506001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd90610b1690309033908990600401611931565b5f604051808303815f87803b158015610b2d575f80fd5b505af1158015610b3f573d5f803e3d5ffd5b5050505060038301805460ff191690556001830154600284015460405190815233916001600160a01b03169086907fddd64180d9701c7ede08673ac8106484ff983a472929330d4fbde4e35d65cb069060200160405180910390a4505050610bb360015f80516020611af383398151915255565b50565b610bbe611697565b610bc75f6116c3565b565b60015460405163cb64489760e01b81523060048201525f9182916001600160a01b039091169063cb644897906024015f60405180830381865afa158015610c12573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052610c399190810190611a06565b90505f805b8251811015610c975760035f848381518110610c5c57610c5c611ab3565b60209081029190910181015182528101919091526040015f206003015460ff1615610c8f5781610c8b81611ac7565b9250505b600101610c3e565b5092915050565b60015460405163cb64489760e01b8152306004820152606091829182915f916001600160a01b039091169063cb644897906024015f60405180830381865afa158015610cec573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052610d139190810190611a06565b90505f805b8251811015610d715760035f848381518110610d3657610d36611ab3565b60209081029190910181015182528101919091526040015f206003015460ff1615610d695781610d6581611ac7565b9250505b600101610d18565b508067ffffffffffffffff811115610d8b57610d8b6119f2565b604051908082528060200260200182016040528015610db4578160200160208202803683370190505b5094508067ffffffffffffffff811115610dd057610dd06119f2565b604051908082528060200260200182016040528015610df9578160200160208202803683370190505b5093508067ffffffffffffffff811115610e1557610e156119f2565b604051908082528060200260200182016040528015610e3e578160200160208202803683370190505b5092505f805b8351811015610f26575f848281518110610e6057610e60611ab3565b6020908102919091018101515f818152600392839052604090209182015490925060ff1615610f1c5781898581518110610e9c57610e9c611ab3565b6020908102919091010152600181015488516001600160a01b0390911690899086908110610ecc57610ecc611ab3565b60200260200101906001600160a01b031690816001600160a01b0316815250508060020154878581518110610f0357610f03611ab3565b602090810291909101015283610f1881611ac7565b9450505b5050600101610e44565b50505050909192565b610f3761167c565b5f818152600460205260409020600681015460ff16610f8d5760405162461bcd60e51b815260206004820152601260248201527141756374696f6e206e6f742061637469766560701b60448201526064016103b9565b8060050154421015610fd35760405162461bcd60e51b815260206004820152600f60248201526e41756374696f6e206f6e676f696e6760881b60448201526064016103b9565b60048101546001600160a01b0316156111dd575f6103e86006548360030154610ffc91906119a3565b61100691906119c0565b90505f81836003015461101991906119df565b600254600185015460405163a9059cbb60e01b81526001600160a01b03918216600482015260248101849052929350169063a9059cbb906044016020604051808303815f875af115801561106f573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906110939190611970565b506002546001600160a01b031663a9059cbb6110b65f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018590526044016020604051808303815f875af1158015611100573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906111249190611970565b506001546004808501546040516323b872dd60e01b81526001600160a01b03938416936323b872dd9361115e9330939216918a9101611931565b5f604051808303815f87803b158015611175575f80fd5b505af1158015611187573d5f803e3d5ffd5b50505050600483015460038401546040519081526001600160a01b039091169085907fd2aa34a4fdbbc6dff6a3e56f46e0f3ae2a31d7785ff3487aa5c95c642acea5019060200160405180910390a35050611246565b60018054908201546040516323b872dd60e01b81526001600160a01b03928316926323b872dd92611218923092909116908790600401611931565b5f604051808303815f87803b15801561122f575f80fd5b505af1158015611241573d5f803e3d5ffd5b505050505b600601805460ff19169055610bb360015f80516020611af383398151915255565b8281146112ae5760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b60448201526064016103b9565b82158015906112be575060148311155b6112ff5760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b60448201526064016103b9565b5f5b8381101561134b5761134385858381811061131e5761131e611ab3565b9050602002013584848481811061133757611337611ab3565b9050602002013561049e565b600101611301565b5050505050565b6001546040516331a9108f60e11b81526004810185905233916001600160a01b031690636352211e90602401602060405180830381865afa158015611399573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906113bd9190611955565b6001600160a01b0316146113ff5760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b60448201526064016103b9565b5f821161143e5760405162461bcd60e51b815260206004820152600d60248201526c496e76616c696420707269636560981b60448201526064016103b9565b5f81116114805760405162461bcd60e51b815260206004820152601060248201526f24b73b30b634b210323ab930ba34b7b760811b60448201526064016103b9565b5f8381526004602052604090206006015460ff16156114d25760405162461bcd60e51b815260206004820152600e60248201526d41756374696f6e2065786973747360901b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061150690339030908890600401611931565b5f604051808303815f87803b15801561151d575f80fd5b505af115801561152f573d5f803e3d5ffd5b50506040805160e081018252868152336020820152908101859052606081018590525f608082015291505060a081016115688342611adf565b8152600160209182018190525f8681526004808452604091829020855181559385015192840180546001600160a01b039485166001600160a01b031991821617909155918501516002850155606085015160038501556080850151908401805491909316911617905560a0820151600582015560c0909101516006909101805491151560ff1990921691909117905533837fc9050d42180a61cb0d9ebb8ad118b62fe6eab12cf12ff752c4a0cc7da9ddf627846116258542611adf565b6040805192835260208301919091520160405180910390a3505050565b61164a611697565b6001600160a01b03811661167357604051631e4fbdf760e01b81525f60048201526024016103b9565b610bb3816116c3565b611684611712565b60025f80516020611af383398151915255565b5f546001600160a01b03163314610bc75760405163118cdaa760e01b81523360048201526024016103b9565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f80516020611af383398151915254600203610bc757604051633ee5aeb560e01b815260040160405180910390fd5b5f60208284031215611751575f80fd5b5035919050565b5f8060408385031215611769575f80fd5b50508035926020909101359150565b5f815180845260208085019450602084015f5b838110156117a75781518752958201959082019060010161178b565b509495945050505050565b606081525f6117c46060830186611778565b8281036020848101919091528551808352868201928201905f5b818110156118035784516001600160a01b0316835293830193918301916001016117de565b505084810360408601526118178187611778565b98975050505050505050565b5f8083601f840112611833575f80fd5b50813567ffffffffffffffff81111561184a575f80fd5b6020830191508360208260051b8501011115611864575f80fd5b9250929050565b5f805f806040858703121561187e575f80fd5b843567ffffffffffffffff80821115611895575f80fd5b6118a188838901611823565b909650945060208701359150808211156118b9575f80fd5b506118c687828801611823565b95989497509550505050565b5f805f606084860312156118e4575f80fd5b505081359360208301359350604090920135919050565b6001600160a01b0381168114610bb3575f80fd5b5f6020828403121561191f575f80fd5b813561192a816118fb565b9392505050565b6001600160a01b039384168152919092166020820152604081019190915260600190565b5f60208284031215611965575f80fd5b815161192a816118fb565b5f60208284031215611980575f80fd5b8151801515811461192a575f80fd5b634e487b7160e01b5f52601160045260245ffd5b80820281158282048414176119ba576119ba61198f565b92915050565b5f826119da57634e487b7160e01b5f52601260045260245ffd5b500490565b818103818111156119ba576119ba61198f565b634e487b7160e01b5f52604160045260245ffd5b5f6020808385031215611a17575f80fd5b825167ffffffffffffffff80821115611a2e575f80fd5b818501915085601f830112611a41575f80fd5b815181811115611a5357611a536119f2565b8060051b604051601f19603f83011681018181108582111715611a7857611a786119f2565b604052918252848201925083810185019188831115611a95575f80fd5b938501935b8285101561181757845184529385019392850192611a9a565b634e487b7160e01b5f52603260045260245ffd5b5f60018201611ad857611ad861198f565b5060010190565b808201808211156119ba576119ba61198f56fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a2646970667358221220d53af9de4bf5920df97b25ced7addb1fa60dbf552bbdaa37297b05c3087c370164736f6c63430008180033","sourceMap":"226:8229:37:-:0;;;859:2;831:30;;919:2;891:30;;1527:173;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2365:1:13;1505:66;2539;1589:10:37;;1269:95:0;;1322:31;;-1:-1:-1;;;1322:31:0;;1350:1;1322:31;;;640:51:39;613:18;;1322:31:0;;;;;;;1269:95;1373:32;1392:12;1373:18;:32::i;:::-;-1:-1:-1;1611:11:37::1;:39:::0;;-1:-1:-1;;;;;1611:39:37;;::::1;-1:-1:-1::0;;;;;;1611:39:37;;::::1;;::::0;;;1660:9:::1;:33:::0;;;;;::::1;::::0;::::1;;::::0;;226:8229;;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;14:177:39:-;93:13;;-1:-1:-1;;;;;135:31:39;;125:42;;115:70;;181:1;178;171:12;115:70;14:177;;;:::o;196:293::-;275:6;283;336:2;324:9;315:7;311:23;307:32;304:52;;;352:1;349;342:12;304:52;375:40;405:9;375:40;:::i;:::-;365:50;;434:49;479:2;468:9;464:18;434:49;:::i;:::-;424:59;;196:293;;;;;:::o;494:203::-;226:8229:37;;;;;;","linkReferences":{}},"deployedBytecode":{"object":"0x608060405234801561000f575f80fd5b5060043610610111575f3560e01c80637b55927c1161009e578063c3999a321161006e578063c3999a321461029c578063c3dfdae6146102af578063cda4beef146102c2578063de74e57b146102d5578063f2fde38b14610354575f80fd5b80637b55927c1461025a57806387c35bc0146102625780638da5cb5b14610279578063b9a2de3a14610289575f80fd5b8063571a26a0116100e4578063571a26a01461018457806357c90de5146102235780636a1b7ecc146102365780636fa830a61461023f578063715018a614610252575f80fd5b806314525b6b14610115578063305a67a81461013157806337f76838146101465780634eda529b14610171575b5f80fd5b61011e60065481565b6040519081526020015b60405180910390f35b61014461013f366004611741565b610367565b005b600154610159906001600160a01b031681565b6040516001600160a01b039091168152602001610128565b61014461017f366004611758565b61049e565b6101df610192366004611741565b600460208190525f9182526040909120805460018201546002830154600384015494840154600585015460069095015493956001600160a01b039384169592949093909116919060ff1687565b604080519788526001600160a01b0396871660208901528701949094526060860192909252909216608084015260a0830191909152151560c082015260e001610128565b610144610231366004611758565b6106fd565b61011e60055481565b61014461024d366004611741565b610956565b610144610bb6565b61011e610bc9565b61026a610c9e565b604051610128939291906117b2565b5f546001600160a01b0316610159565b610144610297366004611741565b610f2f565b6101446102aa36600461186b565b611267565b600254610159906001600160a01b031681565b6101446102d03660046118d2565b611352565b6103226102e3366004611741565b600360208190525f91825260409091208054600182015460028301549383015460049093015491936001600160a01b0390911692909160ff9091169085565b604080519586526001600160a01b0390941660208601529284019190915215156060830152608082015260a001610128565b61014461036236600461190f565b611642565b5f81815260036020526040902060018101546001600160a01b031633146103c25760405162461bcd60e51b815260206004820152600a6024820152692737ba1039b2b63632b960b11b60448201526064015b60405180910390fd5b600381015460ff166104035760405162461bcd60e51b815260206004820152600a6024820152694e6f742061637469766560b01b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061043790309033908790600401611931565b5f604051808303815f87803b15801561044e575f80fd5b505af1158015610460573d5f803e3d5ffd5b50505060038201805460ff191690555060405182907f411aee90354c51b1b04cd563fcab2617142a9d50da19232d888547c8a1b7fd8a905f90a25050565b6001546040516331a9108f60e11b81526004810184905233916001600160a01b031690636352211e90602401602060405180830381865afa1580156104e5573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906105099190611955565b6001600160a01b03161461054b5760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b60448201526064016103b9565b5f811161058a5760405162461bcd60e51b815260206004820152600d60248201526c496e76616c696420707269636560981b60448201526064016103b9565b5f828152600360208190526040909120015460ff16156105dd5760405162461bcd60e51b815260206004820152600e60248201526d105b1c9958591e481b1a5cdd195960921b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061061190339030908790600401611931565b5f604051808303815f87803b158015610628575f80fd5b505af115801561063a573d5f803e3d5ffd5b50506040805160a08101825285815233602080830182815283850188815260016060860181815242608088019081525f8d81526003808852908a902098518955945192880180546001600160a01b0319166001600160a01b0390941693909317909255915160028701559051918501805460ff1916921515929092179091555160049093019290925591518581529193508592507f23fb658c1698b92f5fe511a079c17ecf7965cbc3f1b873328c67e2c3c0820f1f910160405180910390a35050565b61070561167c565b5f828152600460205260409020600681015460ff1661075b5760405162461bcd60e51b815260206004820152601260248201527141756374696f6e206e6f742061637469766560701b60448201526064016103b9565b8060050154421061079e5760405162461bcd60e51b815260206004820152600d60248201526c105d58dd1a5bdb88195b991959609a1b60448201526064016103b9565b806003015482116107df5760405162461bcd60e51b815260206004820152600b60248201526a42696420746f6f206c6f7760a81b60448201526064016103b9565b60048101546001600160a01b03161561087357600254600482810154600384015460405163a9059cbb60e01b81526001600160a01b039283169381019390935260248301529091169063a9059cbb906044016020604051808303815f875af115801561084d573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108719190611970565b505b6002546040516323b872dd60e01b81526001600160a01b03909116906323b872dd906108a790339030908790600401611931565b6020604051808303815f875af11580156108c3573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108e79190611970565b50600381018290556004810180546001600160a01b0319163390811790915560405183815284907f0e54eff26401bf69b81b26f60bd85ef47f5d85275c1d268d84f68d6897431c479060200160405180910390a35061095260015f80516020611af383398151915255565b5050565b61095e61167c565b5f8181526003602081905260409091209081015460ff166109ae5760405162461bcd60e51b815260206004820152600a602482015269139bdd081b1a5cdd195960b21b60448201526064016103b9565b5f6103e860055483600201546109c491906119a3565b6109ce91906119c0565b90505f8183600201546109e191906119df565b60025460018501546040516323b872dd60e01b81529293506001600160a01b03918216926323b872dd92610a1e9233929116908690600401611931565b6020604051808303815f875af1158015610a3a573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610a5e9190611970565b506002546001600160a01b03166323b872dd33610a825f546001600160a01b031690565b856040518463ffffffff1660e01b8152600401610aa193929190611931565b6020604051808303815f875af1158015610abd573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610ae19190611970565b506001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd90610b1690309033908990600401611931565b5f604051808303815f87803b158015610b2d575f80fd5b505af1158015610b3f573d5f803e3d5ffd5b5050505060038301805460ff191690556001830154600284015460405190815233916001600160a01b03169086907fddd64180d9701c7ede08673ac8106484ff983a472929330d4fbde4e35d65cb069060200160405180910390a4505050610bb360015f80516020611af383398151915255565b50565b610bbe611697565b610bc75f6116c3565b565b60015460405163cb64489760e01b81523060048201525f9182916001600160a01b039091169063cb644897906024015f60405180830381865afa158015610c12573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052610c399190810190611a06565b90505f805b8251811015610c975760035f848381518110610c5c57610c5c611ab3565b60209081029190910181015182528101919091526040015f206003015460ff1615610c8f5781610c8b81611ac7565b9250505b600101610c3e565b5092915050565b60015460405163cb64489760e01b8152306004820152606091829182915f916001600160a01b039091169063cb644897906024015f60405180830381865afa158015610cec573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f19168201604052610d139190810190611a06565b90505f805b8251811015610d715760035f848381518110610d3657610d36611ab3565b60209081029190910181015182528101919091526040015f206003015460ff1615610d695781610d6581611ac7565b9250505b600101610d18565b508067ffffffffffffffff811115610d8b57610d8b6119f2565b604051908082528060200260200182016040528015610db4578160200160208202803683370190505b5094508067ffffffffffffffff811115610dd057610dd06119f2565b604051908082528060200260200182016040528015610df9578160200160208202803683370190505b5093508067ffffffffffffffff811115610e1557610e156119f2565b604051908082528060200260200182016040528015610e3e578160200160208202803683370190505b5092505f805b8351811015610f26575f848281518110610e6057610e60611ab3565b6020908102919091018101515f818152600392839052604090209182015490925060ff1615610f1c5781898581518110610e9c57610e9c611ab3565b6020908102919091010152600181015488516001600160a01b0390911690899086908110610ecc57610ecc611ab3565b60200260200101906001600160a01b031690816001600160a01b0316815250508060020154878581518110610f0357610f03611ab3565b602090810291909101015283610f1881611ac7565b9450505b5050600101610e44565b50505050909192565b610f3761167c565b5f818152600460205260409020600681015460ff16610f8d5760405162461bcd60e51b815260206004820152601260248201527141756374696f6e206e6f742061637469766560701b60448201526064016103b9565b8060050154421015610fd35760405162461bcd60e51b815260206004820152600f60248201526e41756374696f6e206f6e676f696e6760881b60448201526064016103b9565b60048101546001600160a01b0316156111dd575f6103e86006548360030154610ffc91906119a3565b61100691906119c0565b90505f81836003015461101991906119df565b600254600185015460405163a9059cbb60e01b81526001600160a01b03918216600482015260248101849052929350169063a9059cbb906044016020604051808303815f875af115801561106f573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906110939190611970565b506002546001600160a01b031663a9059cbb6110b65f546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018590526044016020604051808303815f875af1158015611100573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906111249190611970565b506001546004808501546040516323b872dd60e01b81526001600160a01b03938416936323b872dd9361115e9330939216918a9101611931565b5f604051808303815f87803b158015611175575f80fd5b505af1158015611187573d5f803e3d5ffd5b50505050600483015460038401546040519081526001600160a01b039091169085907fd2aa34a4fdbbc6dff6a3e56f46e0f3ae2a31d7785ff3487aa5c95c642acea5019060200160405180910390a35050611246565b60018054908201546040516323b872dd60e01b81526001600160a01b03928316926323b872dd92611218923092909116908790600401611931565b5f604051808303815f87803b15801561122f575f80fd5b505af1158015611241573d5f803e3d5ffd5b505050505b600601805460ff19169055610bb360015f80516020611af383398151915255565b8281146112ae5760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b60448201526064016103b9565b82158015906112be575060148311155b6112ff5760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b60448201526064016103b9565b5f5b8381101561134b5761134385858381811061131e5761131e611ab3565b9050602002013584848481811061133757611337611ab3565b9050602002013561049e565b600101611301565b5050505050565b6001546040516331a9108f60e11b81526004810185905233916001600160a01b031690636352211e90602401602060405180830381865afa158015611399573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906113bd9190611955565b6001600160a01b0316146113ff5760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b60448201526064016103b9565b5f821161143e5760405162461bcd60e51b815260206004820152600d60248201526c496e76616c696420707269636560981b60448201526064016103b9565b5f81116114805760405162461bcd60e51b815260206004820152601060248201526f24b73b30b634b210323ab930ba34b7b760811b60448201526064016103b9565b5f8381526004602052604090206006015460ff16156114d25760405162461bcd60e51b815260206004820152600e60248201526d41756374696f6e2065786973747360901b60448201526064016103b9565b6001546040516323b872dd60e01b81526001600160a01b03909116906323b872dd9061150690339030908890600401611931565b5f604051808303815f87803b15801561151d575f80fd5b505af115801561152f573d5f803e3d5ffd5b50506040805160e081018252868152336020820152908101859052606081018590525f608082015291505060a081016115688342611adf565b8152600160209182018190525f8681526004808452604091829020855181559385015192840180546001600160a01b039485166001600160a01b031991821617909155918501516002850155606085015160038501556080850151908401805491909316911617905560a0820151600582015560c0909101516006909101805491151560ff1990921691909117905533837fc9050d42180a61cb0d9ebb8ad118b62fe6eab12cf12ff752c4a0cc7da9ddf627846116258542611adf565b6040805192835260208301919091520160405180910390a3505050565b61164a611697565b6001600160a01b03811661167357604051631e4fbdf760e01b81525f60048201526024016103b9565b610bb3816116c3565b611684611712565b60025f80516020611af383398151915255565b5f546001600160a01b03163314610bc75760405163118cdaa760e01b81523360048201526024016103b9565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f80516020611af383398151915254600203610bc757604051633ee5aeb560e01b815260040160405180910390fd5b5f60208284031215611751575f80fd5b5035919050565b5f8060408385031215611769575f80fd5b50508035926020909101359150565b5f815180845260208085019450602084015f5b838110156117a75781518752958201959082019060010161178b565b509495945050505050565b606081525f6117c46060830186611778565b8281036020848101919091528551808352868201928201905f5b818110156118035784516001600160a01b0316835293830193918301916001016117de565b505084810360408601526118178187611778565b98975050505050505050565b5f8083601f840112611833575f80fd5b50813567ffffffffffffffff81111561184a575f80fd5b6020830191508360208260051b8501011115611864575f80fd5b9250929050565b5f805f806040858703121561187e575f80fd5b843567ffffffffffffffff80821115611895575f80fd5b6118a188838901611823565b909650945060208701359150808211156118b9575f80fd5b506118c687828801611823565b95989497509550505050565b5f805f606084860312156118e4575f80fd5b505081359360208301359350604090920135919050565b6001600160a01b0381168114610bb3575f80fd5b5f6020828403121561191f575f80fd5b813561192a816118fb565b9392505050565b6001600160a01b039384168152919092166020820152604081019190915260600190565b5f60208284031215611965575f80fd5b815161192a816118fb565b5f60208284031215611980575f80fd5b8151801515811461192a575f80fd5b634e487b7160e01b5f52601160045260245ffd5b80820281158282048414176119ba576119ba61198f565b92915050565b5f826119da57634e487b7160e01b5f52601260045260245ffd5b500490565b818103818111156119ba576119ba61198f565b634e487b7160e01b5f52604160045260245ffd5b5f6020808385031215611a17575f80fd5b825167ffffffffffffffff80821115611a2e575f80fd5b818501915085601f830112611a41575f80fd5b815181811115611a5357611a536119f2565b8060051b604051601f19603f83011681018181108582111715611a7857611a786119f2565b604052918252848201925083810185019188831115611a95575f80fd5b938501935b8285101561181757845184529385019392850192611a9a565b634e487b7160e01b5f52603260045260245ffd5b5f60018201611ad857611ad861198f565b5060010190565b808201808211156119ba576119ba61198f56fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a2646970667358221220d53af9de4bf5920df97b25ced7addb1fa60dbf552bbdaa37297b05c3087c370164736f6c63430008180033","sourceMap":"226:8229:37:-:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;891:30;;;;;;;;;160:25:39;;;148:2;133:18;891:30:37;;;;;;;;3014:391;;;;;;:::i;:::-;;:::i;:::-;;281:30;;;;;-1:-1:-1;;;;;281:30:37;;;;;;-1:-1:-1;;;;;566:32:39;;;548:51;;536:2;521:18;281:30:37;381:224:39;1710:634:37;;;;;;:::i;:::-;;:::i;782:43::-;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;;;;782:43:37;;;;;;;;;;;;;;;;;;;;;1172:25:39;;;-1:-1:-1;;;;;1271:15:39;;;1266:2;1251:18;;1244:43;1303:18;;1296:34;;;;1361:2;1346:18;;1339:34;;;;1410:15;;;1404:3;1389:19;;1382:44;1224:3;1442:19;;1435:35;;;;1514:14;1507:22;1501:3;1486:19;;1479:51;1159:3;1144:19;782:43:37;863:673:39;4314:715:37;;;;;;:::i;:::-;;:::i;831:30::-;;;;;;2354:650;;;;;;:::i;:::-;;:::i;2293:101:0:-;;;:::i;8074:379:37:-;;;:::i;6662:1298::-;;;:::i;:::-;;;;;;;;;:::i;1638:85:0:-;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;1638:85;;5039:900:37;;;;;;:::i;:::-;;:::i;5949:425::-;;;;;;:::i;:::-;;:::i;317:26::-;;;;;-1:-1:-1;;;;;317:26:37;;;3415:889;;;;;;:::i;:::-;;:::i;733:43::-;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;;;;733:43:37;;;;;;;;;;;;;;;;;5151:25:39;;;-1:-1:-1;;;;;5212:32:39;;;5207:2;5192:18;;5185:60;5261:18;;;5254:34;;;;5331:14;5324:22;5319:2;5304:18;;5297:50;5378:3;5363:19;;5356:35;5138:3;5123:19;733:43:37;4898:499:39;2543:215:0;;;;;;:::i;:::-;;:::i;3014:391:37:-;3074:23;3100:20;;;:8;:20;;;;;3138:14;;;;-1:-1:-1;;;;;3138:14:37;3156:10;3138:28;3130:51;;;;-1:-1:-1;;;3130:51:37;;5992:2:39;3130:51:37;;;5974:21:39;6031:2;6011:18;;;6004:30;-1:-1:-1;;;6050:18:39;;;6043:40;6100:18;;3130:51:37;;;;;;;;;3199:16;;;;;;3191:39;;;;-1:-1:-1;;;3191:39:37;;6331:2:39;3191:39:37;;;6313:21:39;6370:2;6350:18;;;6343:30;-1:-1:-1;;;6389:18:39;;;6382:40;6439:18;;3191:39:37;6129:334:39;3191:39:37;3249:11;;:63;;-1:-1:-1;;;3249:63:37;;-1:-1:-1;;;;;3249:11:37;;;;:24;;:63;;3282:4;;3289:10;;3301;;3249:63;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;;3322:16:37;;;:24;;-1:-1:-1;;3322:24:37;;;-1:-1:-1;3370:28:37;;3387:10;;3370:28;;3341:5;;3370:28;3064:341;3014:391;:::o;1710:634::-;1792:11;;:31;;-1:-1:-1;;;1792:31:37;;;;;160:25:39;;;1827:10:37;;-1:-1:-1;;;;;1792:11:37;;:19;;133:18:39;;1792:31:37;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1;;;;;1792:45:37;;1784:67;;;;-1:-1:-1;;;1784:67:37;;7306:2:39;1784:67:37;;;7288:21:39;7345:1;7325:18;;;7318:29;-1:-1:-1;;;7363:18:39;;;7356:39;7412:18;;1784:67:37;7104:332:39;1784:67:37;1877:1;1869:5;:9;1861:35;;;;-1:-1:-1;;;1861:35:37;;7643:2:39;1861:35:37;;;7625:21:39;7682:2;7662:18;;;7655:30;-1:-1:-1;;;7701:18:39;;;7694:43;7754:18;;1861:35:37;7441:337:39;1861:35:37;1915:20;;;;:8;:20;;;;;;;;:29;;;;1914:30;1906:57;;;;-1:-1:-1;;;1906:57:37;;7985:2:39;1906:57:37;;;7967:21:39;8024:2;8004:18;;;7997:30;-1:-1:-1;;;8043:18:39;;;8036:44;8097:18;;1906:57:37;7783:338:39;1906:57:37;1982:11;;:63;;-1:-1:-1;;;1982:63:37;;-1:-1:-1;;;;;1982:11:37;;;;:24;;:63;;2007:10;;2027:4;;2034:10;;1982:63;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;2087:181:37;;;;;;;;;;;2153:10;2087:181;;;;;;;;;;;;;2213:4;2087:181;;;;;;2242:15;2087:181;;;;;;-1:-1:-1;2064:20:37;;;:8;:20;;;;;;;:204;;;;;;;;;;;-1:-1:-1;;;;;;2064:204:37;-1:-1:-1;;;;;2064:204:37;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;2064:204:37;;;;;;;;;;;;;;;;;;;;2292:45;;160:25:39;;;2153:10:37;;-1:-1:-1;2087:181:37;;-1:-1:-1;2292:45:37;;133:18:39;2292:45:37;;;;;;;1710:634;;:::o;4314:715::-;3023:21:13;:19;:21::i;:::-;4401:23:37::1;4427:20:::0;;;:8:::1;:20;::::0;;;;4465:16:::1;::::0;::::1;::::0;::::1;;4457:47;;;::::0;-1:-1:-1;;;4457:47:37;;8328:2:39;4457:47:37::1;::::0;::::1;8310:21:39::0;8367:2;8347:18;;;8340:30;-1:-1:-1;;;8386:18:39;;;8379:48;8444:18;;4457:47:37::1;8126:342:39::0;4457:47:37::1;4540:7;:15;;;4522;:33;4514:59;;;::::0;-1:-1:-1;;;4514:59:37;;8675:2:39;4514:59:37::1;::::0;::::1;8657:21:39::0;8714:2;8694:18;;;8687:30;-1:-1:-1;;;8733:18:39;;;8726:43;8786:18;;4514:59:37::1;8473:337:39::0;4514:59:37::1;4603:7;:18;;;4591:9;:30;4583:54;;;::::0;-1:-1:-1;;;4583:54:37;;9017:2:39;4583:54:37::1;::::0;::::1;8999:21:39::0;9056:2;9036:18;;;9029:30;-1:-1:-1;;;9075:18:39;;;9068:41;9126:18;;4583:54:37::1;8815:335:39::0;4583:54:37::1;4660:21;::::0;::::1;::::0;-1:-1:-1;;;;;4660:21:37::1;:35:::0;4656:127:::1;;4711:9;::::0;4730:21:::1;::::0;;::::1;::::0;4753:18:::1;::::0;::::1;::::0;4711:61:::1;::::0;-1:-1:-1;;;4711:61:37;;-1:-1:-1;;;;;4730:21:37;;::::1;4711:61:::0;;::::1;9329:51:39::0;;;;9396:18;;;9389:34;4711:9:37;;::::1;::::0;:18:::1;::::0;9302::39;;4711:61:37::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;;4656:127;4801:9;::::0;:60:::1;::::0;-1:-1:-1;;;4801:60:37;;-1:-1:-1;;;;;4801:9:37;;::::1;::::0;:22:::1;::::0;:60:::1;::::0;4824:10:::1;::::0;4844:4:::1;::::0;4851:9;;4801:60:::1;;;:::i;:::-;;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;4880:18:37::1;::::0;::::1;:30:::0;;;4920:21:::1;::::0;::::1;:34:::0;;-1:-1:-1;;;;;;4920:34:37::1;4944:10;4920:34:::0;;::::1;::::0;;;4978:44:::1;::::0;160:25:39;;;4988:10:37;;4978:44:::1;::::0;148:2:39;133:18;4978:44:37::1;;;;;;;4391:638;3065:20:13::0;2365:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292;3065:20;4314:715:37;;:::o;2354:650::-;3023:21:13;:19;:21::i;:::-;2425:23:37::1;2451:20:::0;;;:8:::1;:20;::::0;;;;;;;2489:16;;::::1;::::0;::::1;;2481:39;;;::::0;-1:-1:-1;;;2481:39:37;;9918:2:39;2481:39:37::1;::::0;::::1;9900:21:39::0;9957:2;9937:18;;;9930:30;-1:-1:-1;;;9976:18:39;;;9969:40;10026:18;;2481:39:37::1;9716:334:39::0;2481:39:37::1;2539:11;2584:4;2570:10;;2554:7;:13;;;:26;;;;:::i;:::-;2553:35;;;;:::i;:::-;2539:49;;2598:20;2637:3;2621:7;:13;;;:19;;;;:::i;:::-;2659:9;::::0;;2694:14;::::1;::::0;2659:64:::1;::::0;-1:-1:-1;;;2659:64:37;;2598:42;;-1:-1:-1;;;;;;2659:9:37;;::::1;::::0;:22:::1;::::0;:64:::1;::::0;2682:10:::1;::::0;2694:14;::::1;::::0;2598:42;;2659:64:::1;;;:::i;:::-;;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;2733:9:37::1;::::0;-1:-1:-1;;;;;2733:9:37::1;:22;2756:10;2768:7;1684::0::0;1710:6;-1:-1:-1;;;;;1710:6:0;;1638:85;2768:7:37::1;2777:3;2733:48;;;;;;;;;;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;2800:11:37::1;::::0;:63:::1;::::0;-1:-1:-1;;;2800:63:37;;-1:-1:-1;;;;;2800:11:37;;::::1;::::0;:24:::1;::::0;:63:::1;::::0;2833:4:::1;::::0;2840:10:::1;::::0;2852;;2800:63:::1;;;:::i;:::-;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;::::0;::::1;;;;;-1:-1:-1::0;;;;2882:16:37::1;::::0;::::1;:24:::0;;-1:-1:-1;;2882:24:37::1;::::0;;-1:-1:-1;2955:14:37;::::1;::::0;2983:13:::1;::::0;::::1;::::0;2930:67:::1;::::0;160:25:39;;;2971:10:37::1;::::0;-1:-1:-1;;;;;2955:14:37::1;::::0;2943:10;;2930:67:::1;::::0;148:2:39;133:18;2930:67:37::1;;;;;;;2415:589;;;3065:20:13::0;2365:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292;3065:20;2354:650:37;:::o;2293:101:0:-;1531:13;:11;:13::i;:::-;2357:30:::1;2384:1;2357:18;:30::i;:::-;2293:101::o:0;8074:379:37:-;8183:11;;:45;;-1:-1:-1;;;8183:45:37;;8222:4;8183:45;;;548:51:39;8129:7:37;;;;-1:-1:-1;;;;;8183:11:37;;;;:30;;521:18:39;;8183:45:37;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;8183:45:37;;;;;;;;;;;;:::i;:::-;8148:80;;8238:13;8270:9;8265:160;8289:15;:22;8285:1;:26;8265:160;;;8336:8;:28;8345:15;8361:1;8345:18;;;;;;;;:::i;:::-;;;;;;;;;;;;8336:28;;;;;;;;;;-1:-1:-1;8336:28:37;:37;;;;;8332:83;;;8393:7;;;;:::i;:::-;;;;8332:83;8313:3;;8265:160;;;-1:-1:-1;8441:5:37;8074:379;-1:-1:-1;;8074:379:37:o;6662:1298::-;6933:11;;:45;;-1:-1:-1;;;6933:45:37;;6972:4;6933:45;;;548:51:39;6721:28:37;;;;;;6898:32;;-1:-1:-1;;;;;6933:11:37;;;;:30;;521:18:39;;6933:45:37;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;6933:45:37;;;;;;;;;;;;:::i;:::-;6898:80;;7036:19;7074:9;7069:166;7093:15;:22;7089:1;:26;7069:166;;;7140:8;:28;7149:15;7165:1;7149:18;;;;;;;;:::i;:::-;;;;;;;;;;;;7140:28;;;;;;;;;;-1:-1:-1;7140:28:37;:37;;;;;7136:89;;;7197:13;;;;:::i;:::-;;;;7136:89;7117:3;;7069:166;;;;7308:11;7294:26;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;7294:26:37;;7280:40;;7354:11;7340:26;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;7340:26:37;;7330:36;;7399:11;7385:26;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;7385:26:37;;7376:35;;7474:13;7506:9;7501:397;7525:15;:22;7521:1;:26;7501:397;;;7568:18;7589:15;7605:1;7589:18;;;;;;;;:::i;:::-;;;;;;;;;;;;7621:23;7647:20;;;:8;:20;;;;;;;7685:16;;;;7589:18;;-1:-1:-1;7685:16:37;;7681:207;;;7742:10;7721:11;7733:5;7721:18;;;;;;;;:::i;:::-;;;;;;;;;;:31;7787:14;;;;7770;;-1:-1:-1;;;;;7787:14:37;;;;7770:7;;7778:5;;7770:14;;;;;;:::i;:::-;;;;;;:31;-1:-1:-1;;;;;7770:31:37;;;-1:-1:-1;;;;;7770:31:37;;;;;7835:7;:13;;;7819:6;7826:5;7819:13;;;;;;;;:::i;:::-;;;;;;;;;;:29;7866:7;;;;:::i;:::-;;;;7681:207;-1:-1:-1;;7549:3:37;;7501:397;;;;7916:37;;;6662:1298;;;:::o;5039:900::-;3023:21:13;:19;:21::i;:::-;5109:23:37::1;5135:20:::0;;;:8:::1;:20;::::0;;;;5173:16:::1;::::0;::::1;::::0;::::1;;5165:47;;;::::0;-1:-1:-1;;;5165:47:37;;8328:2:39;5165:47:37::1;::::0;::::1;8310:21:39::0;8367:2;8347:18;;;8340:30;-1:-1:-1;;;8386:18:39;;;8379:48;8444:18;;5165:47:37::1;8126:342:39::0;5165:47:37::1;5249:7;:15;;;5230;:34;;5222:62;;;::::0;-1:-1:-1;;;5222:62:37;;12431:2:39;5222:62:37::1;::::0;::::1;12413:21:39::0;12470:2;12450:18;;;12443:30;-1:-1:-1;;;12489:18:39;;;12482:45;12544:18;;5222:62:37::1;12229:339:39::0;5222:62:37::1;5307:21;::::0;::::1;::::0;-1:-1:-1;;;;;5307:21:37::1;:35:::0;5303:587:::1;;5358:11;5408:4;5394:10;;5373:7;:18;;;:31;;;;:::i;:::-;5372:40;;;;:::i;:::-;5358:54;;5426:20;5470:3;5449:7;:18;;;:24;;;;:::i;:::-;5500:9;::::0;;5519:14;::::1;::::0;5500:48:::1;::::0;-1:-1:-1;;;5500:48:37;;-1:-1:-1;;;;;5519:14:37;;::::1;5500:48;::::0;::::1;9329:51:39::0;9396:18;;;9389:34;;;5426:47:37;;-1:-1:-1;5500:9:37::1;::::0;:18:::1;::::0;9302::39;;5500:48:37::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;5562:9:37::1;::::0;-1:-1:-1;;;;;5562:9:37::1;:18;5581:7;1684::0::0;1710:6;-1:-1:-1;;;;;1710:6:0;;1638:85;5581:7:37::1;5562:32;::::0;-1:-1:-1;;;;;;5562:32:37::1;::::0;;;;;;-1:-1:-1;;;;;9347:32:39;;;5562::37::1;::::0;::::1;9329:51:39::0;9396:18;;;9389:34;;;9302:18;;5562:32:37::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;5608:11:37::1;::::0;5648:21:::1;::::0;;::::1;::::0;5608:74:::1;::::0;-1:-1:-1;;;5608:74:37;;-1:-1:-1;;;;;5608:11:37;;::::1;::::0;:24:::1;::::0;:74:::1;::::0;5641:4:::1;::::0;5648:21;::::1;::::0;5671:10;;5608:74:::1;;:::i;:::-;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;::::0;::::1;;;;;-1:-1:-1::0;;;;5739:21:37::1;::::0;::::1;::::0;5762:18:::1;::::0;::::1;::::0;5714:67:::1;::::0;160:25:39;;;-1:-1:-1;;;;;5739:21:37;;::::1;::::0;5727:10;;5714:67:::1;::::0;148:2:39;133:18;5714:67:37::1;;;;;;;5344:448;;5303:587;;;5812:11;::::0;;5852:14;;::::1;::::0;5812:67:::1;::::0;-1:-1:-1;;;5812:67:37;;-1:-1:-1;;;;;5812:11:37;;::::1;::::0;:24:::1;::::0;:67:::1;::::0;5845:4:::1;::::0;5852:14;;::::1;::::0;5868:10;;5812:67:::1;;;:::i;:::-;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;::::0;::::1;;;;;;;;;5303:587;5908:16;;:24:::0;;-1:-1:-1;;5908:24:37::1;::::0;;3065:20:13;2365:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292;5949:425:37;6084:35;;;6076:69;;;;-1:-1:-1;;;6076:69:37;;12775:2:39;6076:69:37;;;12757:21:39;12814:2;12794:18;;;12787:30;-1:-1:-1;;;12833:18:39;;;12826:51;12894:18;;6076:69:37;12573:345:39;6076:69:37;6163:22;;;;;:50;;-1:-1:-1;6211:2:37;6189:24;;;6163:50;6155:81;;;;-1:-1:-1;;;6155:81:37;;13125:2:39;6155:81:37;;;13107:21:39;13164:2;13144:18;;;13137:30;-1:-1:-1;;;13183:18:39;;;13176:48;13241:18;;6155:81:37;12923:342:39;6155:81:37;6260:9;6255:113;6275:22;;;6255:113;;;6318:39;6331:11;;6343:1;6331:14;;;;;;;:::i;:::-;;;;;;;6347:6;;6354:1;6347:9;;;;;;;:::i;:::-;;;;;;;6318:12;:39::i;:::-;6299:3;;6255:113;;;;5949:425;;;;:::o;3415:889::-;3554:11;;:31;;-1:-1:-1;;;3554:31:37;;;;;160:25:39;;;3589:10:37;;-1:-1:-1;;;;;3554:11:37;;:19;;133:18:39;;3554:31:37;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1;;;;;3554:45:37;;3546:67;;;;-1:-1:-1;;;3546:67:37;;7306:2:39;3546:67:37;;;7288:21:39;7345:1;7325:18;;;7318:29;-1:-1:-1;;;7363:18:39;;;7356:39;7412:18;;3546:67:37;7104:332:39;3546:67:37;3647:1;3631:13;:17;3623:43;;;;-1:-1:-1;;;3623:43:37;;7643:2:39;3623:43:37;;;7625:21:39;7682:2;7662:18;;;7655:30;-1:-1:-1;;;7701:18:39;;;7694:43;7754:18;;3623:43:37;7441:337:39;3623:43:37;3695:1;3684:8;:12;3676:41;;;;-1:-1:-1;;;3676:41:37;;13472:2:39;3676:41:37;;;13454:21:39;13511:2;13491:18;;;13484:30;-1:-1:-1;;;13530:18:39;;;13523:46;13586:18;;3676:41:37;13270:340:39;3676:41:37;3736:20;;;;:8;:20;;;;;:29;;;;;3735:30;3727:57;;;;-1:-1:-1;;;3727:57:37;;13817:2:39;3727:57:37;;;13799:21:39;13856:2;13836:18;;;13829:30;-1:-1:-1;;;13875:18:39;;;13868:44;13929:18;;3727:57:37;13615:338:39;3727:57:37;3803:11;;:63;;-1:-1:-1;;;3803:63:37;;-1:-1:-1;;;;;3803:11:37;;;;:24;;:63;;3828:10;;3848:4;;3855:10;;3803:63;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;3908:284:37;;;;;;;;;;;3974:10;3908:284;;;;;;;;;;;;;;;;-1:-1:-1;3908:284:37;;;;;-1:-1:-1;;3908:284:37;;;4127:26;4145:8;4127:15;:26;:::i;:::-;3908:284;;4177:4;3908:284;;;;;;;;3885:20;;;:8;:20;;;;;;;;:307;;;;;;;;;;;;;-1:-1:-1;;;;;3885:307:37;;;-1:-1:-1;;;;;;3885:307:37;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;3885:307:37;;;;;;;;;4243:10;3894;4216:81;4255:13;4270:26;4288:8;4270:15;:26;:::i;:::-;4216:81;;;14262:25:39;;;14318:2;14303:18;;14296:34;;;;14235:18;4216:81:37;;;;;;;3415:889;;;:::o;2543:215:0:-;1531:13;:11;:13::i;:::-;-1:-1:-1;;;;;2627:22:0;::::1;2623:91;;2672:31;::::0;-1:-1:-1;;;2672:31:0;;2700:1:::1;2672:31;::::0;::::1;548:51:39::0;521:18;;2672:31:0::1;381:224:39::0;2623:91:0::1;2723:28;2742:8;2723:18;:28::i;3749:292:13:-:0;3872:25;:23;:25::i;:::-;2407:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292::o;1796:162:0:-;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;735:10:11;1855:23:0;1851:101;;1901:40;;-1:-1:-1;;;1901:40:0;;735:10:11;1901:40:0;;;548:51:39;521:18;;1901:40:0;381:224:39;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;3586:157:13:-;-1:-1:-1;;;;;;;;;;;4560:52:13;2407:1;4560:63;3644:93;;3696:30;;-1:-1:-1;;;3696:30:13;;;;;;;;;;;196:180:39;255:6;308:2;296:9;287:7;283:23;279:32;276:52;;;324:1;321;314:12;276:52;-1:-1:-1;347:23:39;;196:180;-1:-1:-1;196:180:39:o;610:248::-;678:6;686;739:2;727:9;718:7;714:23;710:32;707:52;;;755:1;752;745:12;707:52;-1:-1:-1;;778:23:39;;;848:2;833:18;;;820:32;;-1:-1:-1;610:248:39:o;1541:439::-;1594:3;1632:5;1626:12;1659:6;1654:3;1647:19;1685:4;1714;1709:3;1705:14;1698:21;;1753:4;1746:5;1742:16;1776:1;1786:169;1800:6;1797:1;1794:13;1786:169;;;1861:13;;1849:26;;1895:12;;;;1930:15;;;;1822:1;1815:9;1786:169;;;-1:-1:-1;1971:3:39;;1541:439;-1:-1:-1;;;;;1541:439:39:o;1985:1002::-;2320:2;2309:9;2302:21;2283:4;2346:56;2398:2;2387:9;2383:18;2375:6;2346:56;:::i;:::-;2459:22;;;2421:2;2439:18;;;2432:50;;;;2531:13;;2553:22;;;2629:15;;;;2591;;;2662:1;2672:195;2686:6;2683:1;2680:13;2672:195;;;2751:13;;-1:-1:-1;;;;;2747:39:39;2735:52;;2842:15;;;;2807:12;;;;2783:1;2701:9;2672:195;;;2676:3;;2912:9;2907:3;2903:19;2898:2;2887:9;2883:18;2876:47;2940:41;2977:3;2969:6;2940:41;:::i;:::-;2932:49;1985:1002;-1:-1:-1;;;;;;;;1985:1002:39:o;3200:367::-;3263:8;3273:6;3327:3;3320:4;3312:6;3308:17;3304:27;3294:55;;3345:1;3342;3335:12;3294:55;-1:-1:-1;3368:20:39;;3411:18;3400:30;;3397:50;;;3443:1;3440;3433:12;3397:50;3480:4;3472:6;3468:17;3456:29;;3540:3;3533:4;3523:6;3520:1;3516:14;3508:6;3504:27;3500:38;3497:47;3494:67;;;3557:1;3554;3547:12;3494:67;3200:367;;;;;:::o;3572:773::-;3694:6;3702;3710;3718;3771:2;3759:9;3750:7;3746:23;3742:32;3739:52;;;3787:1;3784;3777:12;3739:52;3827:9;3814:23;3856:18;3897:2;3889:6;3886:14;3883:34;;;3913:1;3910;3903:12;3883:34;3952:70;4014:7;4005:6;3994:9;3990:22;3952:70;:::i;:::-;4041:8;;-1:-1:-1;3926:96:39;-1:-1:-1;4129:2:39;4114:18;;4101:32;;-1:-1:-1;4145:16:39;;;4142:36;;;4174:1;4171;4164:12;4142:36;;4213:72;4277:7;4266:8;4255:9;4251:24;4213:72;:::i;:::-;3572:773;;;;-1:-1:-1;4304:8:39;-1:-1:-1;;;;3572:773:39:o;4577:316::-;4654:6;4662;4670;4723:2;4711:9;4702:7;4698:23;4694:32;4691:52;;;4739:1;4736;4729:12;4691:52;-1:-1:-1;;4762:23:39;;;4832:2;4817:18;;4804:32;;-1:-1:-1;4883:2:39;4868:18;;;4855:32;;4577:316;-1:-1:-1;4577:316:39:o;5402:131::-;-1:-1:-1;;;;;5477:31:39;;5467:42;;5457:70;;5523:1;5520;5513:12;5538:247;5597:6;5650:2;5638:9;5629:7;5625:23;5621:32;5618:52;;;5666:1;5663;5656:12;5618:52;5705:9;5692:23;5724:31;5749:5;5724:31;:::i;:::-;5774:5;5538:247;-1:-1:-1;;;5538:247:39:o;6468:375::-;-1:-1:-1;;;;;6726:15:39;;;6708:34;;6778:15;;;;6773:2;6758:18;;6751:43;6825:2;6810:18;;6803:34;;;;6658:2;6643:18;;6468:375::o;6848:251::-;6918:6;6971:2;6959:9;6950:7;6946:23;6942:32;6939:52;;;6987:1;6984;6977:12;6939:52;7019:9;7013:16;7038:31;7063:5;7038:31;:::i;9434:277::-;9501:6;9554:2;9542:9;9533:7;9529:23;9525:32;9522:52;;;9570:1;9567;9560:12;9522:52;9602:9;9596:16;9655:5;9648:13;9641:21;9634:5;9631:32;9621:60;;9677:1;9674;9667:12;10055:127;10116:10;10111:3;10107:20;10104:1;10097:31;10147:4;10144:1;10137:15;10171:4;10168:1;10161:15;10187:168;10260:9;;;10291;;10308:15;;;10302:22;;10288:37;10278:71;;10329:18;;:::i;:::-;10187:168;;;;:::o;10360:217::-;10400:1;10426;10416:132;;10470:10;10465:3;10461:20;10458:1;10451:31;10505:4;10502:1;10495:15;10533:4;10530:1;10523:15;10416:132;-1:-1:-1;10562:9:39;;10360:217::o;10582:128::-;10649:9;;;10670:11;;;10667:37;;;10684:18;;:::i;10715:127::-;10776:10;10771:3;10767:20;10764:1;10757:31;10807:4;10804:1;10797:15;10831:4;10828:1;10821:15;10847:1105;10942:6;10973:2;11016;11004:9;10995:7;10991:23;10987:32;10984:52;;;11032:1;11029;11022:12;10984:52;11065:9;11059:16;11094:18;11135:2;11127:6;11124:14;11121:34;;;11151:1;11148;11141:12;11121:34;11189:6;11178:9;11174:22;11164:32;;11234:7;11227:4;11223:2;11219:13;11215:27;11205:55;;11256:1;11253;11246:12;11205:55;11285:2;11279:9;11307:2;11303;11300:10;11297:36;;;11313:18;;:::i;:::-;11359:2;11356:1;11352:10;11391:2;11385:9;11454:2;11450:7;11445:2;11441;11437:11;11433:25;11425:6;11421:38;11509:6;11497:10;11494:22;11489:2;11477:10;11474:18;11471:46;11468:72;;;11520:18;;:::i;:::-;11556:2;11549:22;11606:18;;;11640:15;;;;-1:-1:-1;11682:11:39;;;11678:20;;;11710:19;;;11707:39;;;11742:1;11739;11732:12;11707:39;11766:11;;;;11786:135;11802:6;11797:3;11794:15;11786:135;;;11868:10;;11856:23;;11819:12;;;;11899;;;;11786:135;;11957:127;12018:10;12013:3;12009:20;12006:1;11999:31;12049:4;12046:1;12039:15;12073:4;12070:1;12063:15;12089:135;12128:3;12149:17;;;12146:43;;12169:18;;:::i;:::-;-1:-1:-1;12216:1:39;12205:13;;12089:135::o;13958:125::-;14023:9;;;14044:10;;;14041:36;;;14057:18;;:::i","linkReferences":{}},"methodIdentifiers":{"auctionFee()":"14525b6b","auctions(uint256)":"571a26a0","batchListProperties(uint256[],uint256[])":"c3999a32","buyProperty(uint256)":"6fa830a6","cancelListing(uint256)":"305a67a8","createAuction(uint256,uint256,uint256)":"cda4beef","endAuction(uint256)":"b9a2de3a","gameToken()":"c3dfdae6","getActiveListings()":"87c35bc0","getActiveListingsCount()":"7b55927c","listProperty(uint256,uint256)":"4eda529b","listingFee()":"6a1b7ecc","listings(uint256)":"de74e57b","owner()":"8da5cb5b","placeBid(uint256,uint256)":"57c90de5","propertyNFT()":"37f76838","renounceOwnership()":"715018a6","transferOwnership(address)":"f2fde38b"},"rawMetadata":"{\"compiler\":{\"version\":\"0.8.24+commit.e11b9ed9\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_propertyNFT\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"_gameToken\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"OwnableInvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"OwnableUnauthorizedAccount\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"ReentrancyGuardReentrantCall\",\"type\":\"error\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"seller\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"startingPrice\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"endTime\",\"type\":\"uint256\"}],\"name\":\"AuctionCreated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"winner\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"finalPrice\",\"type\":\"uint256\"}],\"name\":\"AuctionEnded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"bidder\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"BidPlaced\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"ListingCancelled\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"previousOwner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"OwnershipTransferred\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"seller\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"price\",\"type\":\"uint256\"}],\"name\":\"PropertyListed\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"seller\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"buyer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"price\",\"type\":\"uint256\"}],\"name\":\"PropertySold\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"auctionFee\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"auctions\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"seller\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"startingPrice\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"highestBid\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"highestBidder\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"endTime\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"isActive\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"},{\"internalType\":\"uint256[]\",\"name\":\"prices\",\"type\":\"uint256[]\"}],\"name\":\"batchListProperties\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"buyProperty\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"cancelListing\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"startingPrice\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"duration\",\"type\":\"uint256\"}],\"name\":\"createAuction\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"endAuction\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"gameToken\",\"outputs\":[{\"internalType\":\"contract GameToken\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getActiveListings\",\"outputs\":[{\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"},{\"internalType\":\"address[]\",\"name\":\"sellers\",\"type\":\"address[]\"},{\"internalType\":\"uint256[]\",\"name\":\"prices\",\"type\":\"uint256[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"getActiveListingsCount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"price\",\"type\":\"uint256\"}],\"name\":\"listProperty\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"listingFee\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"listings\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"seller\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"price\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"isActive\",\"type\":\"bool\"},{\"internalType\":\"uint256\",\"name\":\"createdAt\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"bidAmount\",\"type\":\"uint256\"}],\"name\":\"placeBid\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"propertyNFT\",\"outputs\":[{\"internalType\":\"contract PropertyNFT\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"renounceOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"transferOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}],\"devdoc\":{\"errors\":{\"OwnableInvalidOwner(address)\":[{\"details\":\"The owner is not a valid owner account. (eg. `address(0)`)\"}],\"OwnableUnauthorizedAccount(address)\":[{\"details\":\"The caller account is not authorized to perform an operation.\"}],\"ReentrancyGuardReentrantCall()\":[{\"details\":\"Unauthorized reentrant call.\"}]},\"kind\":\"dev\",\"methods\":{\"getActiveListings()\":{\"returns\":{\"prices\":\"Array of prices corresponding to each property\",\"propertyIds\":\"Array of property IDs that are actively listed\",\"sellers\":\"Array of seller addresses corresponding to each property\"}},\"getActiveListingsCount()\":{\"returns\":{\"_0\":\"count Number of active listings\"}},\"owner()\":{\"details\":\"Returns the address of the current owner.\"},\"renounceOwnership()\":{\"details\":\"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner.\"},\"transferOwnership(address)\":{\"details\":\"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner.\"}},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{\"getActiveListings()\":{\"notice\":\"Get all active listings\"},\"getActiveListingsCount()\":{\"notice\":\"Get active listings count\"}},\"version\":1}},\"settings\":{\"compilationTarget\":{\"src/Marketplace.sol\":\"Marketplace\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":true,\"runs\":200},\"remappings\":[\":@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/\",\":erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/\",\":forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/\",\":halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/\",\":openzeppelin-contracts/=lib/openzeppelin-contracts/\"]},\"sources\":{\"lib/openzeppelin-contracts/contracts/access/Ownable.sol\":{\"keccak256\":\"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6\",\"dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a\"]},\"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol\":{\"keccak256\":\"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c\",\"dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\":{\"keccak256\":\"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195\",\"dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\":{\"keccak256\":\"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303\",\"dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol\":{\"keccak256\":\"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e\",\"dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol\":{\"keccak256\":\"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b\",\"dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol\":{\"keccak256\":\"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3\",\"dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol\":{\"keccak256\":\"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e\",\"dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol\":{\"keccak256\":\"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e\",\"dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol\":{\"keccak256\":\"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435\",\"dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6\"]},\"lib/openzeppelin-contracts/contracts/utils/Bytes.sol\":{\"keccak256\":\"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147\",\"dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR\"]},\"lib/openzeppelin-contracts/contracts/utils/Context.sol\":{\"keccak256\":\"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12\",\"dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF\"]},\"lib/openzeppelin-contracts/contracts/utils/Panic.sol\":{\"keccak256\":\"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a\",\"dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG\"]},\"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol\":{\"keccak256\":\"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99\",\"dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N\"]},\"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol\":{\"keccak256\":\"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b\",\"dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM\"]},\"lib/openzeppelin-contracts/contracts/utils/Strings.sol\":{\"keccak256\":\"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a\",\"dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol\":{\"keccak256\":\"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377\",\"dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol\":{\"keccak256\":\"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617\",\"dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u\"]},\"lib/openzeppelin-contracts/contracts/utils/math/Math.sol\":{\"keccak256\":\"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c\",\"dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol\":{\"keccak256\":\"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8\",\"dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol\":{\"keccak256\":\"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03\",\"dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ\"]},\"src/GameToken.sol\":{\"keccak256\":\"0xd20a54ae0c82386d88c1c6cb33befb7768bf0b2bb525cdb43ae01f875d1244cb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://53d560199a4c4ec178521769da624b41c34fa1a47216f786eec74facc8f194f9\",\"dweb:/ipfs/QmeQu9mDTZFRqNwqZNh1jeegMceEnTYgPvwoiXyWQdTPs4\"]},\"src/Marketplace.sol\":{\"keccak256\":\"0x8187ab9ba81927dfe554245fd4046081f1a84205b7e889a645327a5c50be041a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://19de2a6a76270b2ba2c288d3a06711ab5e27e5980b4c42aa8b3b41ae34508773\",\"dweb:/ipfs/QmfJz5U5Bi7TTpDePXREsCPv97eAQQeG28RZptqxoqMHVq\"]},\"src/PropertyNFT.sol\":{\"keccak256\":\"0x757ac606ad07c3ef8949bc29037e2c1e2e7505625a78ae53f63d27b6a2ccd13b\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://96473b93e6a4a8f2f6d6a66bf7fd518759417a4b07bdddee0e07fa9b9d45627d\",\"dweb:/ipfs/QmcAAVyByV4anBQkuSRwFAodk4RmNPjRdm2s4SwkWweDaQ\"]}},\"version\":1}","metadata":{"compiler":{"version":"0.8.24+commit.e11b9ed9"},"language":"Solidity","output":{"abi":[{"inputs":[{"internalType":"address","name":"_propertyNFT","type":"address"},{"internalType":"address","name":"_gameToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"OwnableInvalidOwner"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"type":"error","name":"OwnableUnauthorizedAccount"},{"inputs":[],"type":"error","name":"ReentrancyGuardReentrantCall"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"seller","type":"address","indexed":true},{"internalType":"uint256","name":"startingPrice","type":"uint256","indexed":false},{"internalType":"uint256","name":"endTime","type":"uint256","indexed":false}],"type":"event","name":"AuctionCreated","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"winner","type":"address","indexed":true},{"internalType":"uint256","name":"finalPrice","type":"uint256","indexed":false}],"type":"event","name":"AuctionEnded","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"bidder","type":"address","indexed":true},{"internalType":"uint256","name":"amount","type":"uint256","indexed":false}],"type":"event","name":"BidPlaced","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true}],"type":"event","name":"ListingCancelled","anonymous":false},{"inputs":[{"internalType":"address","name":"previousOwner","type":"address","indexed":true},{"internalType":"address","name":"newOwner","type":"address","indexed":true}],"type":"event","name":"OwnershipTransferred","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"seller","type":"address","indexed":true},{"internalType":"uint256","name":"price","type":"uint256","indexed":false}],"type":"event","name":"PropertyListed","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"seller","type":"address","indexed":true},{"internalType":"address","name":"buyer","type":"address","indexed":true},{"internalType":"uint256","name":"price","type":"uint256","indexed":false}],"type":"event","name":"PropertySold","anonymous":false},{"inputs":[],"stateMutability":"view","type":"function","name":"auctionFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"auctions","outputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"address","name":"seller","type":"address"},{"internalType":"uint256","name":"startingPrice","type":"uint256"},{"internalType":"uint256","name":"highestBid","type":"uint256"},{"internalType":"address","name":"highestBidder","type":"address"},{"internalType":"uint256","name":"endTime","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}]},{"inputs":[{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]"},{"internalType":"uint256[]","name":"prices","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function","name":"batchListProperties"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"buyProperty"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"cancelListing"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"uint256","name":"startingPrice","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"createAuction"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"endAuction"},{"inputs":[],"stateMutability":"view","type":"function","name":"gameToken","outputs":[{"internalType":"contract GameToken","name":"","type":"address"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"getActiveListings","outputs":[{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]"},{"internalType":"address[]","name":"sellers","type":"address[]"},{"internalType":"uint256[]","name":"prices","type":"uint256[]"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"getActiveListingsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"uint256","name":"price","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"listProperty"},{"inputs":[],"stateMutability":"view","type":"function","name":"listingFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"listings","outputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"address","name":"seller","type":"address"},{"internalType":"uint256","name":"price","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"uint256","name":"createdAt","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"uint256","name":"bidAmount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"placeBid"},{"inputs":[],"stateMutability":"view","type":"function","name":"propertyNFT","outputs":[{"internalType":"contract PropertyNFT","name":"","type":"address"}]},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"renounceOwnership"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"transferOwnership"}],"devdoc":{"kind":"dev","methods":{"getActiveListings()":{"returns":{"prices":"Array of prices corresponding to each property","propertyIds":"Array of property IDs that are actively listed","sellers":"Array of seller addresses corresponding to each property"}},"getActiveListingsCount()":{"returns":{"_0":"count Number of active listings"}},"owner()":{"details":"Returns the address of the current owner."},"renounceOwnership()":{"details":"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner."},"transferOwnership(address)":{"details":"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner."}},"version":1},"userdoc":{"kind":"user","methods":{"getActiveListings()":{"notice":"Get all active listings"},"getActiveListingsCount()":{"notice":"Get active listings count"}},"version":1}},"settings":{"remappings":["@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/","erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/","forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/","halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/","openzeppelin-contracts/=lib/openzeppelin-contracts/"],"optimizer":{"enabled":true,"runs":200},"metadata":{"bytecodeHash":"ipfs"},"compilationTarget":{"src/Marketplace.sol":"Marketplace"},"evmVersion":"cancun","libraries":{}},"sources":{"lib/openzeppelin-contracts/contracts/access/Ownable.sol":{"keccak256":"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb","urls":["bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6","dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol":{"keccak256":"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998","urls":["bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c","dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol":{"keccak256":"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29","urls":["bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195","dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol":{"keccak256":"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2","urls":["bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303","dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol":{"keccak256":"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f","urls":["bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e","dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol":{"keccak256":"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039","urls":["bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b","dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol":{"keccak256":"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f","urls":["bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3","dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol":{"keccak256":"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055","urls":["bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e","dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol":{"keccak256":"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76","urls":["bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e","dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol":{"keccak256":"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd","urls":["bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435","dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Bytes.sol":{"keccak256":"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33","urls":["bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147","dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Context.sol":{"keccak256":"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2","urls":["bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12","dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Panic.sol":{"keccak256":"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a","urls":["bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a","dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol":{"keccak256":"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53","urls":["bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99","dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol":{"keccak256":"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97","urls":["bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b","dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Strings.sol":{"keccak256":"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a","urls":["bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a","dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol":{"keccak256":"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e","urls":["bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377","dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol":{"keccak256":"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c","urls":["bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617","dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/Math.sol":{"keccak256":"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c","urls":["bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c","dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol":{"keccak256":"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54","urls":["bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8","dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol":{"keccak256":"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3","urls":["bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03","dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ"],"license":"MIT"},"src/GameToken.sol":{"keccak256":"0xd20a54ae0c82386d88c1c6cb33befb7768bf0b2bb525cdb43ae01f875d1244cb","urls":["bzz-raw://53d560199a4c4ec178521769da624b41c34fa1a47216f786eec74facc8f194f9","dweb:/ipfs/QmeQu9mDTZFRqNwqZNh1jeegMceEnTYgPvwoiXyWQdTPs4"],"license":"MIT"},"src/Marketplace.sol":{"keccak256":"0x8187ab9ba81927dfe554245fd4046081f1a84205b7e889a645327a5c50be041a","urls":["bzz-raw://19de2a6a76270b2ba2c288d3a06711ab5e27e5980b4c42aa8b3b41ae34508773","dweb:/ipfs/QmfJz5U5Bi7TTpDePXREsCPv97eAQQeG28RZptqxoqMHVq"],"license":"MIT"},"src/PropertyNFT.sol":{"keccak256":"0x757ac606ad07c3ef8949bc29037e2c1e2e7505625a78ae53f63d27b6a2ccd13b","urls":["bzz-raw://96473b93e6a4a8f2f6d6a66bf7fd518759417a4b07bdddee0e07fa9b9d45627d","dweb:/ipfs/QmcAAVyByV4anBQkuSRwFAodk4RmNPjRdm2s4SwkWweDaQ"],"license":"MIT"}},"version":1},"id":37}
</file>

<file path="backend/src/contracts/abis/PropertyNFT.json">
{"abi":[{"type":"constructor","inputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"approve","inputs":[{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"balanceOf","inputs":[{"name":"owner","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"batchMintProperties","inputs":[{"name":"to","type":"address","internalType":"address"},{"name":"propertyTypes","type":"uint8[]","internalType":"enum PropertyNFT.PropertyType[]"},{"name":"values","type":"uint256[]","internalType":"uint256[]"},{"name":"yieldRates","type":"uint256[]","internalType":"uint256[]"}],"outputs":[{"name":"","type":"uint256[]","internalType":"uint256[]"}],"stateMutability":"nonpayable"},{"type":"function","name":"gameToken","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract IERC20"}],"stateMutability":"view"},{"type":"function","name":"getApproved","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"getOwnerProperties","inputs":[{"name":"owner","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256[]","internalType":"uint256[]"}],"stateMutability":"view"},{"type":"function","name":"getOwnerPropertyCount","inputs":[{"name":"owner","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"getProperty","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"tuple","internalType":"struct PropertyNFT.Property","components":[{"name":"propertyType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"},{"name":"value","type":"uint256","internalType":"uint256"},{"name":"yieldRate","type":"uint256","internalType":"uint256"},{"name":"rwaContract","type":"address","internalType":"address"},{"name":"rwaTokenId","type":"uint256","internalType":"uint256"},{"name":"totalYieldEarned","type":"uint256","internalType":"uint256"},{"name":"createdAt","type":"uint256","internalType":"uint256"},{"name":"isActive","type":"bool","internalType":"bool"}]}],"stateMutability":"view"},{"type":"function","name":"getPropertyTypeCount","inputs":[{"name":"propertyType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"isApprovedForAll","inputs":[{"name":"owner","type":"address","internalType":"address"},{"name":"operator","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"linkToRWA","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"rwaContract","type":"address","internalType":"address"},{"name":"rwaTokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"mintProperty","inputs":[{"name":"to","type":"address","internalType":"address"},{"name":"propertyType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"},{"name":"value","type":"uint256","internalType":"uint256"},{"name":"yieldRate","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"nonpayable"},{"type":"function","name":"name","inputs":[],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"ownerOf","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"ownerProperties","inputs":[{"name":"","type":"address","internalType":"address"},{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"properties","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"propertyType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"},{"name":"value","type":"uint256","internalType":"uint256"},{"name":"yieldRate","type":"uint256","internalType":"uint256"},{"name":"rwaContract","type":"address","internalType":"address"},{"name":"rwaTokenId","type":"uint256","internalType":"uint256"},{"name":"totalYieldEarned","type":"uint256","internalType":"uint256"},{"name":"createdAt","type":"uint256","internalType":"uint256"},{"name":"isActive","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"propertyCosts","inputs":[{"name":"","type":"uint8","internalType":"enum PropertyNFT.PropertyType"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"propertyTypeCounts","inputs":[{"name":"","type":"uint8","internalType":"enum PropertyNFT.PropertyType"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"purchaseProperty","inputs":[{"name":"propertyType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"},{"name":"value","type":"uint256","internalType":"uint256"},{"name":"yieldRate","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"nonpayable"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"safeTransferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"safeTransferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"data","type":"bytes","internalType":"bytes"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"setApprovalForAll","inputs":[{"name":"operator","type":"address","internalType":"address"},{"name":"approved","type":"bool","internalType":"bool"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"setGameToken","inputs":[{"name":"_gameToken","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"supportsInterface","inputs":[{"name":"interfaceId","type":"bytes4","internalType":"bytes4"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"symbol","inputs":[],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"tokenURI","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"transferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"upgradeProperty","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"newType","type":"uint8","internalType":"enum PropertyNFT.PropertyType"},{"name":"newValue","type":"uint256","internalType":"uint256"},{"name":"newYieldRate","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"withdrawTokens","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"Approval","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"approved","type":"address","indexed":true,"internalType":"address"},{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"ApprovalForAll","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"operator","type":"address","indexed":true,"internalType":"address"},{"name":"approved","type":"bool","indexed":false,"internalType":"bool"}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"PropertiesBatchMinted","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"tokenIds","type":"uint256[]","indexed":false,"internalType":"uint256[]"}],"anonymous":false},{"type":"event","name":"PropertyCreated","inputs":[{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"propertyType","type":"uint8","indexed":false,"internalType":"enum PropertyNFT.PropertyType"},{"name":"value","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"PropertyLinkedToRWA","inputs":[{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"rwaContract","type":"address","indexed":false,"internalType":"address"},{"name":"rwaTokenId","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"PropertyPurchased","inputs":[{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"buyer","type":"address","indexed":true,"internalType":"address"},{"name":"propertyType","type":"uint8","indexed":false,"internalType":"enum PropertyNFT.PropertyType"},{"name":"cost","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"PropertyUpgraded","inputs":[{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"newType","type":"uint8","indexed":false,"internalType":"enum PropertyNFT.PropertyType"},{"name":"newValue","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"Transfer","inputs":[{"name":"from","type":"address","indexed":true,"internalType":"address"},{"name":"to","type":"address","indexed":true,"internalType":"address"},{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"}],"anonymous":false},{"type":"error","name":"ERC721IncorrectOwner","inputs":[{"name":"sender","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InsufficientApproval","inputs":[{"name":"operator","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}]},{"type":"error","name":"ERC721InvalidApprover","inputs":[{"name":"approver","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidOperator","inputs":[{"name":"operator","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidReceiver","inputs":[{"name":"receiver","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidSender","inputs":[{"name":"sender","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721NonexistentToken","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}]},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]},{"type":"error","name":"ReentrancyGuardReentrantCall","inputs":[]}],"bytecode":{"object":"0x608060405234801562000010575f80fd5b50336040518060400160405280600b81526020016a141c9bdc195c9d1e53919560aa1b81525060405180604001604052806004815260200163050524f560e41b815250815f9081620000639190620002bf565b506001620000728282620002bf565b5050506001600160a01b038116620000a357604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b620000ae81620001d0565b5060017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00555f8080526008602081905268056bc75e2d631000007f5eff886ea0ce6ca488a3d6e336d6c0f75f46d19b42c06ce5ee98e42c96d256c755680ad78ebc5ac620000091600160038111156200012b576200012b6200038b565b81526020019081526020015f2081905550681b1ae4d6e2ef50000060085f600260038111156200015f576200015f6200038b565b60038111156200017357620001736200038b565b81526020019081526020015f2081905550683635c9adc5dea0000060085f600380811115620001a657620001a66200038b565b6003811115620001ba57620001ba6200038b565b815260208101919091526040015f20556200039f565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b634e487b7160e01b5f52604160045260245ffd5b600181811c908216806200024a57607f821691505b6020821081036200026957634e487b7160e01b5f52602260045260245ffd5b50919050565b601f821115620002ba57805f5260205f20601f840160051c81016020851015620002965750805b601f840160051c820191505b81811015620002b7575f8155600101620002a2565b50505b505050565b81516001600160401b03811115620002db57620002db62000221565b620002f381620002ec845462000235565b846200026f565b602080601f83116001811462000329575f8415620003115750858301515b5f19600386901b1c1916600185901b17855562000383565b5f85815260208120601f198616915b82811015620003595788860151825594840194600190910190840162000338565b50858210156200037757878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b634e487b7160e01b5f52602160045260245ffd5b61288380620003ad5f395ff3fe608060405234801561000f575f80fd5b50600436106101e7575f3560e01c806380d29e6611610109578063c87b56dd1161009e578063f2fde38b1161006e578063f2fde38b14610456578063f412cc6e14610469578063f7b1080814610488578063fc0dbbb7146104fb575f80fd5b8063c87b56dd146103f5578063cb64489714610408578063d79fb4ff1461041b578063e985e9c514610443575f80fd5b806395d89b41116100d957806395d89b41146103b4578063a22cb465146103bc578063b88d4fde146103cf578063c3dfdae6146103e2575f80fd5b806380d29e66146103755780638d8f2adb146103885780638da5cb5b146103905780638f48bd5b146103a1575f80fd5b806342842e0e1161017f5780636b39bac81161014f5780636b39bac81461033457806370a0823114610347578063715018a61461035a5780637d61a62b14610362575f80fd5b806342842e0e146102dc57806355d5efb4146102ef5780635a25f7bd146103025780636352211e14610321575f80fd5b80632222f588116101ba5780632222f5881461026857806323b872dd1461028957806325add6521461029c57806332665ffb146102bc575f80fd5b806301ffc9a7146101eb57806306fdde0314610213578063081812fc14610228578063095ea7b314610253575b5f80fd5b6101fe6101f9366004612150565b61050e565b60405190151581526020015b60405180910390f35b61021b61055f565b60405161020a91906121b8565b61023b6102363660046121ca565b6105ee565b6040516001600160a01b03909116815260200161020a565b6102666102613660046121fc565b610615565b005b61027b610276366004612232565b610624565b60405190815260200161020a565b610266610297366004612262565b610ab2565b6102af6102aa3660046122e3565b610b3b565b60405161020a9190612386565b6102cf6102ca3660046121ca565b610ead565b60405161020a91906123fd565b6102666102ea366004612262565b610f99565b61027b6102fd366004612466565b610fb8565b61027b6103103660046124a5565b60086020525f908152604090205481565b61023b61032f3660046121ca565b611192565b6102666103423660046124be565b61119c565b61027b6103553660046124e0565b6112b4565b6102666112f9565b6102666103703660046124f9565b61130c565b6102666103833660046124e0565b6114dc565b610266611506565b6006546001600160a01b031661023b565b61027b6103af3660046121fc565b611699565b61021b6116c4565b6102666103ca366004612529565b6116d3565b6102666103dd366004612572565b6116de565b60075461023b906001600160a01b031681565b61021b6104033660046121ca565b6116f6565b6102af6104163660046124e0565b611766565b61027b6104293660046124e0565b6001600160a01b03165f908152600b602052604090205490565b6101fe610451366004612647565b6117cf565b6102666104643660046124e0565b6117fc565b61027b6104773660046124a5565b600c6020525f908152604090205481565b6104e76104963660046121ca565b600a6020525f90815260409020805460018201546002830154600384015460048501546005860154600687015460079097015460ff96871697959694956001600160a01b0390941694929391921688565b60405161020a989796959493929190612678565b61027b6105093660046124a5565b611836565b5f6001600160e01b031982166380ac58cd60e01b148061053e57506001600160e01b03198216635b5e139f60e01b145b8061055957506301ffc9a760e01b6001600160e01b03198316145b92915050565b60605f805461056d906126c7565b80601f0160208091040260200160405190810160405280929190818152602001828054610599906126c7565b80156105e45780601f106105bb576101008083540402835291602001916105e4565b820191905f5260205f20905b8154815290600101906020018083116105c757829003601f168201915b5050505050905090565b5f6105f882611872565b505f828152600460205260409020546001600160a01b0316610559565b6106208282336118aa565b5050565b5f61062d6118b7565b6007546001600160a01b031661067f5760405162461bcd60e51b815260206004820152601260248201527111d85b59481d1bdad95b881b9bdd081cd95d60721b60448201526064015b60405180910390fd5b5f60085f866003811115610695576106956123c9565b60038111156106a6576106a66123c9565b81526020019081526020015f205490505f81116106fd5760405162461bcd60e51b8152602060048201526015602482015274496e76616c69642070726f7065727479207479706560581b6044820152606401610676565b6007546040516370a0823160e01b815233600482015282916001600160a01b0316906370a0823190602401602060405180830381865afa158015610743573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061076791906126ff565b10156107b55760405162461bcd60e51b815260206004820152601b60248201527f496e73756666696369656e74205459434f4f4e2062616c616e636500000000006044820152606401610676565b6007546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af1158015610809573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061082d9190612716565b6108715760405162461bcd60e51b8152602060048201526015602482015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b6044820152606401610676565b600980545f918261088183612745565b91905055905061089133826118e5565b6040518061010001604052808760038111156108af576108af6123c9565b8152602080820188905260408083018890525f606084018190526080840181905260a084018190524260c0850152600160e0909401849052858152600a90925290208251815491929091839160ff1990911690836003811115610914576109146123c9565b021790555060208281015160018381019190915560408085015160028501556060850151600380860180546001600160a01b0319166001600160a01b03909316929092179091556080860151600486015560a0860151600586015560c0860151600686015560e0909501516007909401805460ff191694151594909417909355335f908152600b835292832080549182018155835290822001839055600c9188908111156109c4576109c46123c9565b60038111156109d5576109d56123c9565b81526020019081526020015f205f8154809291906109f290612745565b9190505550336001600160a01b0316817f828d9172b5c26092cc7b90e5975570842347a49f37e3c060c3c6050c1f3f943a8888604051610a3392919061275d565b60405180910390a3336001600160a01b0316817fb30e21874a58b588dd7fa5662db417747b356f4a5eb09895bec9ea032c22c93d8885604051610a7792919061275d565b60405180910390a3915050610aab60017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b9392505050565b6001600160a01b038216610adb57604051633250574960e11b81525f6004820152602401610676565b5f610ae78383336118fe565b9050836001600160a01b0316816001600160a01b031614610b35576040516364283d7b60e01b81526001600160a01b0380861660048301526024820184905282166044820152606401610676565b50505050565b6060610b45611a1b565b8584148015610b5357508382145b610b975760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b6044820152606401610676565b8515801590610ba7575060328611155b610be85760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b6044820152606401610676565b5f8667ffffffffffffffff811115610c0257610c0261255e565b604051908082528060200260200182016040528015610c2b578160200160208202803683370190505b5090505f5b87811015610e5f57600980545f9182610c4883612745565b919050559050610c588b826118e5565b6040518061010001604052808b8b85818110610c7657610c76612778565b9050602002016020810190610c8b91906124a5565b6003811115610c9c57610c9c6123c9565b8152602001898985818110610cb357610cb3612778565b905060200201358152602001878785818110610cd157610cd1612778565b602090810292909201358352505f828201819052604080840182905260608401829052426080850152600160a0909401849052858252600a909252208251815491929091839160ff1990911690836003811115610d3057610d306123c9565b0217905550602082810151600183810191909155604080850151600285015560608501516003850180546001600160a01b0319166001600160a01b039283161790556080860151600486015560a0860151600586015560c0860151600686015560e0909501516007909401805460ff191694151594909417909355928e165f908152600b82529182208054938401815582528120909101829055600c908b8b85818110610ddf57610ddf612778565b9050602002016020810190610df491906124a5565b6003811115610e0557610e056123c9565b6003811115610e1657610e166123c9565b81526020019081526020015f205f815480929190610e3390612745565b919050555080838381518110610e4b57610e4b612778565b602090810291909101015250600101610c30565b50886001600160a01b03167fbbde24150c326c205f41f669f09a3ccd4ea9d193b34e274e6763c851ad6518b882604051610e999190612386565b60405180910390a298975050505050505050565b610ef9604080516101008101909152805f81526020015f81526020015f81526020015f6001600160a01b031681526020015f81526020015f81526020015f81526020015f151581525090565b5f828152600a602052604090819020815161010081019092528054829060ff166003811115610f2a57610f2a6123c9565b6003811115610f3b57610f3b6123c9565b8152600182015460208201526002820154604082015260038201546001600160a01b0316606082015260048201546080820152600582015460a0820152600682015460c082015260079091015460ff16151560e09091015292915050565b610fb383838360405180602001604052805f8152506116de565b505050565b5f610fc1611a1b565b600980545f9182610fd183612745565b919050559050610fe186826118e5565b604051806101000160405280866003811115610fff57610fff6123c9565b8152602080820187905260408083018790525f606084018190526080840181905260a084018190524260c0850152600160e0909401849052858152600a90925290208251815491929091839160ff1990911690836003811115611064576110646123c9565b021790555060208281015160018381019190915560408085015160028501556060850151600380860180546001600160a01b0319166001600160a01b039384161790556080870151600487015560a0870151600587015560c0870151600687015560e0909601516007909501805460ff191695151595909517909455928a165f908152600b835292832080549182018155835290822001839055600c918790811115611112576111126123c9565b6003811115611123576111236123c9565b81526020019081526020015f205f81548092919061114090612745565b9190505550856001600160a01b0316817f828d9172b5c26092cc7b90e5975570842347a49f37e3c060c3c6050c1f3f943a878760405161118192919061275d565b60405180910390a395945050505050565b5f61055982611872565b336111a684611192565b6001600160a01b0316146111e85760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b6044820152606401610676565b5f838152600a602052604090206007015460ff1661123e5760405162461bcd60e51b815260206004820152601360248201527250726f7065727479206e6f742061637469766560681b6044820152606401610676565b5f838152600a60209081526040918290206003810180546001600160a01b0319166001600160a01b0387169081179091556004909101849055825190815290810183905284917fc395d71585a1c7d91a003fe2b3d8f591b94fb980b66d5c8d25803a92f03a77b4910160405180910390a2505050565b5f6001600160a01b0382166112de576040516322718ad960e21b81525f6004820152602401610676565b506001600160a01b03165f9081526003602052604090205490565b611301611a1b565b61130a5f611a48565b565b3361131685611192565b6001600160a01b0316146113585760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b6044820152606401610676565b5f848152600a602052604090206007015460ff166113ae5760405162461bcd60e51b815260206004820152601360248201527250726f7065727479206e6f742061637469766560681b6044820152606401610676565b5f848152600a602052604081205460ff1690600c908260038111156113d5576113d56123c9565b60038111156113e6576113e66123c9565b81526020019081526020015f205f8154809291906114039061278c565b9190505550600c5f85600381111561141d5761141d6123c9565b600381111561142e5761142e6123c9565b81526020019081526020015f205f81548092919061144b90612745565b90915550505f858152600a60205260409020805485919060ff1916600183600381111561147a5761147a6123c9565b02179055505f858152600a602052604090819020600181018590556002018390555185907f47443aaadfb3aecd43b01a8cbc041fa65029affb63a2e16c3eb4169882176bf6906114cd908790879061275d565b60405180910390a25050505050565b6114e4611a1b565b600780546001600160a01b0319166001600160a01b0392909216919091179055565b61150e611a1b565b6007546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa158015611554573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061157891906126ff565b90505f81116115c15760405162461bcd60e51b81526020600482015260156024820152744e6f20746f6b656e7320746f20776974686472617760581b6044820152606401610676565b6007546001600160a01b031663a9059cbb6115e46006546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af115801561162e573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906116529190612716565b6116965760405162461bcd60e51b8152602060048201526015602482015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b6044820152606401610676565b50565b600b602052815f5260405f2081815481106116b2575f80fd5b905f5260205f20015f91509150505481565b60606001805461056d906126c7565b610620338383611a99565b6116e9848484610ab2565b610b353385858585611b37565b606061170182611872565b505f61171760408051602081019091525f815290565b90505f8151116117355760405180602001604052805f815250610aab565b8061173f84611c5f565b6040516020016117509291906127a1565b6040516020818303038152906040529392505050565b6001600160a01b0381165f908152600b60209081526040918290208054835181840281018401909452808452606093928301828280156117c357602002820191905f5260205f20905b8154815260200190600101908083116117af575b50505050509050919050565b6001600160a01b039182165f90815260056020908152604080832093909416825291909152205460ff1690565b611804611a1b565b6001600160a01b03811661182d57604051631e4fbdf760e01b81525f6004820152602401610676565b61169681611a48565b5f600c5f83600381111561184c5761184c6123c9565b600381111561185d5761185d6123c9565b81526020019081526020015f20549050919050565b5f818152600260205260408120546001600160a01b03168061055957604051637e27328960e01b815260048101849052602401610676565b610fb38383836001611cef565b6118bf611df3565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b610620828260405180602001604052805f815250611e35565b5f8061190b858585611e4c565b90506001600160a01b038116156119d9576001600160a01b0381165f908152600b60205260408120905b81548110156119d6578582828154811061195157611951612778565b905f5260205f200154036119ce578154829061196f906001906127cf565b8154811061197f5761197f612778565b905f5260205f20015482828154811061199a5761199a612778565b905f5260205f200181905550818054806119b6576119b66127e2565b600190038181905f5260205f20015f905590556119d6565b600101611935565b50505b6001600160a01b03851615611a13576001600160a01b0385165f908152600b60209081526040822080546001810182559083529120018490555b949350505050565b6006546001600160a01b0316331461130a5760405163118cdaa760e01b8152336004820152602401610676565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b038216611acb57604051630b61174360e31b81526001600160a01b0383166004820152602401610676565b6001600160a01b038381165f81815260056020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6001600160a01b0383163b15611c5857604051630a85bd0160e11b81526001600160a01b0384169063150b7a0290611b799088908890879087906004016127f6565b6020604051808303815f875af1925050508015611bb3575060408051601f3d908101601f19168201909252611bb091810190612832565b60015b611c1a573d808015611be0576040519150601f19603f3d011682016040523d82523d5f602084013e611be5565b606091505b5080515f03611c1257604051633250574960e11b81526001600160a01b0385166004820152602401610676565b805160208201fd5b6001600160e01b03198116630a85bd0160e11b14611c5657604051633250574960e11b81526001600160a01b0385166004820152602401610676565b505b5050505050565b60605f611c6b83611f3e565b60010190505f8167ffffffffffffffff811115611c8a57611c8a61255e565b6040519080825280601f01601f191660200182016040528015611cb4576020820181803683370190505b5090508181016020015b5f19016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a8504945084611cbe57509392505050565b8080611d0357506001600160a01b03821615155b15611dc4575f611d1284611872565b90506001600160a01b03831615801590611d3e5750826001600160a01b0316816001600160a01b031614155b8015611d515750611d4f81846117cf565b155b15611d7a5760405163a9fbf51f60e01b81526001600160a01b0384166004820152602401610676565b8115611dc25783856001600160a01b0316826001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45b505b50505f90815260046020526040902080546001600160a01b0319166001600160a01b0392909216919091179055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005460020361130a57604051633ee5aeb560e01b815260040160405180910390fd5b611e3f8383612015565b610fb3335f858585611b37565b5f828152600260205260408120546001600160a01b0390811690831615611e7857611e78818486612076565b6001600160a01b03811615611eb257611e935f855f80611cef565b6001600160a01b0381165f90815260036020526040902080545f190190555b6001600160a01b03851615611ee0576001600160a01b0385165f908152600360205260409020805460010190555b5f8481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b5f8072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b8310611f7c5772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310611fa8576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc100008310611fc657662386f26fc10000830492506010015b6305f5e1008310611fde576305f5e100830492506008015b6127108310611ff257612710830492506004015b60648310612004576064830492506002015b600a83106105595760010192915050565b6001600160a01b03821661203e57604051633250574960e11b81525f6004820152602401610676565b5f61204a83835f6118fe565b90506001600160a01b03811615610fb3576040516339e3563760e11b81525f6004820152602401610676565b6120818383836120da565b610fb3576001600160a01b0383166120af57604051637e27328960e01b815260048101829052602401610676565b60405163177e802f60e01b81526001600160a01b038316600482015260248101829052604401610676565b5f6001600160a01b03831615801590611a135750826001600160a01b0316846001600160a01b03161480612113575061211384846117cf565b80611a135750505f908152600460205260409020546001600160a01b03908116911614919050565b6001600160e01b031981168114611696575f80fd5b5f60208284031215612160575f80fd5b8135610aab8161213b565b5f5b8381101561218557818101518382015260200161216d565b50505f910152565b5f81518084526121a481602086016020860161216b565b601f01601f19169290920160200192915050565b602081525f610aab602083018461218d565b5f602082840312156121da575f80fd5b5035919050565b80356001600160a01b03811681146121f7575f80fd5b919050565b5f806040838503121561220d575f80fd5b612216836121e1565b946020939093013593505050565b8035600481106121f7575f80fd5b5f805f60608486031215612244575f80fd5b61224d84612224565b95602085013595506040909401359392505050565b5f805f60608486031215612274575f80fd5b61227d846121e1565b925061228b602085016121e1565b9150604084013590509250925092565b5f8083601f8401126122ab575f80fd5b50813567ffffffffffffffff8111156122c2575f80fd5b6020830191508360208260051b85010111156122dc575f80fd5b9250929050565b5f805f805f805f6080888a0312156122f9575f80fd5b612302886121e1565b9650602088013567ffffffffffffffff8082111561231e575f80fd5b61232a8b838c0161229b565b909850965060408a0135915080821115612342575f80fd5b61234e8b838c0161229b565b909650945060608a0135915080821115612366575f80fd5b506123738a828b0161229b565b989b979a50959850939692959293505050565b602080825282518282018190525f9190848201906040850190845b818110156123bd578351835292840192918401916001016123a1565b50909695505050505050565b634e487b7160e01b5f52602160045260245ffd5b600481106123f957634e487b7160e01b5f52602160045260245ffd5b9052565b5f610100820190506124108284516123dd565b602083015160208301526040830151604083015260018060a01b0360608401511660608301526080830151608083015260a083015160a083015260c083015160c083015260e0830151151560e083015292915050565b5f805f8060808587031215612479575f80fd5b612482856121e1565b935061249060208601612224565b93969395505050506040820135916060013590565b5f602082840312156124b5575f80fd5b610aab82612224565b5f805f606084860312156124d0575f80fd5b8335925061228b602085016121e1565b5f602082840312156124f0575f80fd5b610aab826121e1565b5f805f806080858703121561250c575f80fd5b8435935061249060208601612224565b8015158114611696575f80fd5b5f806040838503121561253a575f80fd5b612543836121e1565b915060208301356125538161251c565b809150509250929050565b634e487b7160e01b5f52604160045260245ffd5b5f805f8060808587031215612585575f80fd5b61258e856121e1565b935061259c602086016121e1565b925060408501359150606085013567ffffffffffffffff808211156125bf575f80fd5b818701915087601f8301126125d2575f80fd5b8135818111156125e4576125e461255e565b604051601f8201601f19908116603f0116810190838211818310171561260c5761260c61255e565b816040528281528a6020848701011115612624575f80fd5b826020860160208301375f60208483010152809550505050505092959194509250565b5f8060408385031215612658575f80fd5b612661836121e1565b915061266f602084016121e1565b90509250929050565b6101008101612687828b6123dd565b602082019890985260408101969096526001600160a01b03949094166060860152608085019290925260a084015260c0830152151560e090910152919050565b600181811c908216806126db57607f821691505b6020821081036126f957634e487b7160e01b5f52602260045260245ffd5b50919050565b5f6020828403121561270f575f80fd5b5051919050565b5f60208284031215612726575f80fd5b8151610aab8161251c565b634e487b7160e01b5f52601160045260245ffd5b5f6001820161275657612756612731565b5060010190565b6040810161276b82856123dd565b8260208301529392505050565b634e487b7160e01b5f52603260045260245ffd5b5f8161279a5761279a612731565b505f190190565b5f83516127b281846020880161216b565b8351908301906127c681836020880161216b565b01949350505050565b8181038181111561055957610559612731565b634e487b7160e01b5f52603160045260245ffd5b6001600160a01b03858116825284166020820152604081018390526080606082018190525f906128289083018461218d565b9695505050505050565b5f60208284031215612842575f80fd5b8151610aab8161213b56fea2646970667358221220cb4eb16c3b4922367c85ae5766a0769c5bd050c243afb69f238558e08119068c64736f6c63430008180033","sourceMap":"287:8542:52:-:0;;;1562:450;;;;;;;;;;1614:10;1380:113:5;;;;;;;;;;;;;-1:-1:-1;;;1380:113:5;;;;;;;;;;;;;;;;-1:-1:-1;;;1380:113:5;;;1454:5;1446;:13;;;;;;:::i;:::-;-1:-1:-1;1469:7:5;:17;1479:7;1469;:17;:::i;:::-;-1:-1:-1;;;;;;;;1273:26:0;;1269:95;;1322:31;;-1:-1:-1;;;1322:31:0;;1350:1;1322:31;;;2847:51:57;2820:18;;1322:31:0;;;;;;;1269:95;1373:32;1392:12;1373:18;:32::i;:::-;-1:-1:-1;2365:1:13;1505:66;2539;:52;1702:39:52;;;:13:::2;:39;::::0;;;1744:12:::2;1702:39:::0;:54;1822:12:::2;::::0;1795:23:::2;1781:38;;;;;;;;:::i;:::-;;;;;;;;;;;;:53;;;;1900:12;1859:13;:38;1873:23;1859:38;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;:53;;;;1973:13;1936;:34;1950:19;1936:34:::0;::::2;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;::::0;;::::2;::::0;::::2;::::0;;;;;;-1:-1:-1;1936:34:52;:50;287:8542;;2912:187:0;3004:6;;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;;3052:40;;3004:6;;;3020:17;3004:6;;3052:40;;2985:16;;3052:40;2975:124;2912:187;:::o;14:127:57:-;75:10;70:3;66:20;63:1;56:31;106:4;103:1;96:15;130:4;127:1;120:15;146:380;225:1;221:12;;;;268;;;289:61;;343:4;335:6;331:17;321:27;;289:61;396:2;388:6;385:14;365:18;362:38;359:161;;442:10;437:3;433:20;430:1;423:31;477:4;474:1;467:15;505:4;502:1;495:15;359:161;;146:380;;;:::o;657:518::-;759:2;754:3;751:11;748:421;;;795:5;792:1;785:16;839:4;836:1;826:18;909:2;897:10;893:19;890:1;886:27;880:4;876:38;945:4;933:10;930:20;927:47;;;-1:-1:-1;968:4:57;927:47;1023:2;1018:3;1014:12;1011:1;1007:20;1001:4;997:31;987:41;;1078:81;1096:2;1089:5;1086:13;1078:81;;;1155:1;1141:16;;1122:1;1111:13;1078:81;;;1082:3;;748:421;657:518;;;:::o;1351:1345::-;1471:10;;-1:-1:-1;;;;;1493:30:57;;1490:56;;;1526:18;;:::i;:::-;1555:97;1645:6;1605:38;1637:4;1631:11;1605:38;:::i;:::-;1599:4;1555:97;:::i;:::-;1707:4;;1764:2;1753:14;;1781:1;1776:663;;;;2483:1;2500:6;2497:89;;;-1:-1:-1;2552:19:57;;;2546:26;2497:89;-1:-1:-1;;1308:1:57;1304:11;;;1300:24;1296:29;1286:40;1332:1;1328:11;;;1283:57;2599:81;;1746:944;;1776:663;604:1;597:14;;;641:4;628:18;;-1:-1:-1;;1812:20:57;;;1930:236;1944:7;1941:1;1938:14;1930:236;;;2033:19;;;2027:26;2012:42;;2125:27;;;;2093:1;2081:14;;;;1960:19;;1930:236;;;1934:3;2194:6;2185:7;2182:19;2179:201;;;2255:19;;;2249:26;-1:-1:-1;;2338:1:57;2334:14;;;2350:3;2330:24;2326:37;2322:42;2307:58;2292:74;;2179:201;;;2426:1;2417:6;2414:1;2410:14;2406:22;2400:4;2393:36;1746:944;;;;;1351:1345;;:::o;2909:127::-;2970:10;2965:3;2961:20;2958:1;2951:31;3001:4;2998:1;2991:15;3025:4;3022:1;3015:15;2909:127;287:8542:52;;;;;;","linkReferences":{}},"deployedBytecode":{"object":"0x608060405234801561000f575f80fd5b50600436106101e7575f3560e01c806380d29e6611610109578063c87b56dd1161009e578063f2fde38b1161006e578063f2fde38b14610456578063f412cc6e14610469578063f7b1080814610488578063fc0dbbb7146104fb575f80fd5b8063c87b56dd146103f5578063cb64489714610408578063d79fb4ff1461041b578063e985e9c514610443575f80fd5b806395d89b41116100d957806395d89b41146103b4578063a22cb465146103bc578063b88d4fde146103cf578063c3dfdae6146103e2575f80fd5b806380d29e66146103755780638d8f2adb146103885780638da5cb5b146103905780638f48bd5b146103a1575f80fd5b806342842e0e1161017f5780636b39bac81161014f5780636b39bac81461033457806370a0823114610347578063715018a61461035a5780637d61a62b14610362575f80fd5b806342842e0e146102dc57806355d5efb4146102ef5780635a25f7bd146103025780636352211e14610321575f80fd5b80632222f588116101ba5780632222f5881461026857806323b872dd1461028957806325add6521461029c57806332665ffb146102bc575f80fd5b806301ffc9a7146101eb57806306fdde0314610213578063081812fc14610228578063095ea7b314610253575b5f80fd5b6101fe6101f9366004612150565b61050e565b60405190151581526020015b60405180910390f35b61021b61055f565b60405161020a91906121b8565b61023b6102363660046121ca565b6105ee565b6040516001600160a01b03909116815260200161020a565b6102666102613660046121fc565b610615565b005b61027b610276366004612232565b610624565b60405190815260200161020a565b610266610297366004612262565b610ab2565b6102af6102aa3660046122e3565b610b3b565b60405161020a9190612386565b6102cf6102ca3660046121ca565b610ead565b60405161020a91906123fd565b6102666102ea366004612262565b610f99565b61027b6102fd366004612466565b610fb8565b61027b6103103660046124a5565b60086020525f908152604090205481565b61023b61032f3660046121ca565b611192565b6102666103423660046124be565b61119c565b61027b6103553660046124e0565b6112b4565b6102666112f9565b6102666103703660046124f9565b61130c565b6102666103833660046124e0565b6114dc565b610266611506565b6006546001600160a01b031661023b565b61027b6103af3660046121fc565b611699565b61021b6116c4565b6102666103ca366004612529565b6116d3565b6102666103dd366004612572565b6116de565b60075461023b906001600160a01b031681565b61021b6104033660046121ca565b6116f6565b6102af6104163660046124e0565b611766565b61027b6104293660046124e0565b6001600160a01b03165f908152600b602052604090205490565b6101fe610451366004612647565b6117cf565b6102666104643660046124e0565b6117fc565b61027b6104773660046124a5565b600c6020525f908152604090205481565b6104e76104963660046121ca565b600a6020525f90815260409020805460018201546002830154600384015460048501546005860154600687015460079097015460ff96871697959694956001600160a01b0390941694929391921688565b60405161020a989796959493929190612678565b61027b6105093660046124a5565b611836565b5f6001600160e01b031982166380ac58cd60e01b148061053e57506001600160e01b03198216635b5e139f60e01b145b8061055957506301ffc9a760e01b6001600160e01b03198316145b92915050565b60605f805461056d906126c7565b80601f0160208091040260200160405190810160405280929190818152602001828054610599906126c7565b80156105e45780601f106105bb576101008083540402835291602001916105e4565b820191905f5260205f20905b8154815290600101906020018083116105c757829003601f168201915b5050505050905090565b5f6105f882611872565b505f828152600460205260409020546001600160a01b0316610559565b6106208282336118aa565b5050565b5f61062d6118b7565b6007546001600160a01b031661067f5760405162461bcd60e51b815260206004820152601260248201527111d85b59481d1bdad95b881b9bdd081cd95d60721b60448201526064015b60405180910390fd5b5f60085f866003811115610695576106956123c9565b60038111156106a6576106a66123c9565b81526020019081526020015f205490505f81116106fd5760405162461bcd60e51b8152602060048201526015602482015274496e76616c69642070726f7065727479207479706560581b6044820152606401610676565b6007546040516370a0823160e01b815233600482015282916001600160a01b0316906370a0823190602401602060405180830381865afa158015610743573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061076791906126ff565b10156107b55760405162461bcd60e51b815260206004820152601b60248201527f496e73756666696369656e74205459434f4f4e2062616c616e636500000000006044820152606401610676565b6007546040516323b872dd60e01b8152336004820152306024820152604481018390526001600160a01b03909116906323b872dd906064016020604051808303815f875af1158015610809573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061082d9190612716565b6108715760405162461bcd60e51b8152602060048201526015602482015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b6044820152606401610676565b600980545f918261088183612745565b91905055905061089133826118e5565b6040518061010001604052808760038111156108af576108af6123c9565b8152602080820188905260408083018890525f606084018190526080840181905260a084018190524260c0850152600160e0909401849052858152600a90925290208251815491929091839160ff1990911690836003811115610914576109146123c9565b021790555060208281015160018381019190915560408085015160028501556060850151600380860180546001600160a01b0319166001600160a01b03909316929092179091556080860151600486015560a0860151600586015560c0860151600686015560e0909501516007909401805460ff191694151594909417909355335f908152600b835292832080549182018155835290822001839055600c9188908111156109c4576109c46123c9565b60038111156109d5576109d56123c9565b81526020019081526020015f205f8154809291906109f290612745565b9190505550336001600160a01b0316817f828d9172b5c26092cc7b90e5975570842347a49f37e3c060c3c6050c1f3f943a8888604051610a3392919061275d565b60405180910390a3336001600160a01b0316817fb30e21874a58b588dd7fa5662db417747b356f4a5eb09895bec9ea032c22c93d8885604051610a7792919061275d565b60405180910390a3915050610aab60017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b9392505050565b6001600160a01b038216610adb57604051633250574960e11b81525f6004820152602401610676565b5f610ae78383336118fe565b9050836001600160a01b0316816001600160a01b031614610b35576040516364283d7b60e01b81526001600160a01b0380861660048301526024820184905282166044820152606401610676565b50505050565b6060610b45611a1b565b8584148015610b5357508382145b610b975760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b6044820152606401610676565b8515801590610ba7575060328611155b610be85760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b6044820152606401610676565b5f8667ffffffffffffffff811115610c0257610c0261255e565b604051908082528060200260200182016040528015610c2b578160200160208202803683370190505b5090505f5b87811015610e5f57600980545f9182610c4883612745565b919050559050610c588b826118e5565b6040518061010001604052808b8b85818110610c7657610c76612778565b9050602002016020810190610c8b91906124a5565b6003811115610c9c57610c9c6123c9565b8152602001898985818110610cb357610cb3612778565b905060200201358152602001878785818110610cd157610cd1612778565b602090810292909201358352505f828201819052604080840182905260608401829052426080850152600160a0909401849052858252600a909252208251815491929091839160ff1990911690836003811115610d3057610d306123c9565b0217905550602082810151600183810191909155604080850151600285015560608501516003850180546001600160a01b0319166001600160a01b039283161790556080860151600486015560a0860151600586015560c0860151600686015560e0909501516007909401805460ff191694151594909417909355928e165f908152600b82529182208054938401815582528120909101829055600c908b8b85818110610ddf57610ddf612778565b9050602002016020810190610df491906124a5565b6003811115610e0557610e056123c9565b6003811115610e1657610e166123c9565b81526020019081526020015f205f815480929190610e3390612745565b919050555080838381518110610e4b57610e4b612778565b602090810291909101015250600101610c30565b50886001600160a01b03167fbbde24150c326c205f41f669f09a3ccd4ea9d193b34e274e6763c851ad6518b882604051610e999190612386565b60405180910390a298975050505050505050565b610ef9604080516101008101909152805f81526020015f81526020015f81526020015f6001600160a01b031681526020015f81526020015f81526020015f81526020015f151581525090565b5f828152600a602052604090819020815161010081019092528054829060ff166003811115610f2a57610f2a6123c9565b6003811115610f3b57610f3b6123c9565b8152600182015460208201526002820154604082015260038201546001600160a01b0316606082015260048201546080820152600582015460a0820152600682015460c082015260079091015460ff16151560e09091015292915050565b610fb383838360405180602001604052805f8152506116de565b505050565b5f610fc1611a1b565b600980545f9182610fd183612745565b919050559050610fe186826118e5565b604051806101000160405280866003811115610fff57610fff6123c9565b8152602080820187905260408083018790525f606084018190526080840181905260a084018190524260c0850152600160e0909401849052858152600a90925290208251815491929091839160ff1990911690836003811115611064576110646123c9565b021790555060208281015160018381019190915560408085015160028501556060850151600380860180546001600160a01b0319166001600160a01b039384161790556080870151600487015560a0870151600587015560c0870151600687015560e0909601516007909501805460ff191695151595909517909455928a165f908152600b835292832080549182018155835290822001839055600c918790811115611112576111126123c9565b6003811115611123576111236123c9565b81526020019081526020015f205f81548092919061114090612745565b9190505550856001600160a01b0316817f828d9172b5c26092cc7b90e5975570842347a49f37e3c060c3c6050c1f3f943a878760405161118192919061275d565b60405180910390a395945050505050565b5f61055982611872565b336111a684611192565b6001600160a01b0316146111e85760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b6044820152606401610676565b5f838152600a602052604090206007015460ff1661123e5760405162461bcd60e51b815260206004820152601360248201527250726f7065727479206e6f742061637469766560681b6044820152606401610676565b5f838152600a60209081526040918290206003810180546001600160a01b0319166001600160a01b0387169081179091556004909101849055825190815290810183905284917fc395d71585a1c7d91a003fe2b3d8f591b94fb980b66d5c8d25803a92f03a77b4910160405180910390a2505050565b5f6001600160a01b0382166112de576040516322718ad960e21b81525f6004820152602401610676565b506001600160a01b03165f9081526003602052604090205490565b611301611a1b565b61130a5f611a48565b565b3361131685611192565b6001600160a01b0316146113585760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b6044820152606401610676565b5f848152600a602052604090206007015460ff166113ae5760405162461bcd60e51b815260206004820152601360248201527250726f7065727479206e6f742061637469766560681b6044820152606401610676565b5f848152600a602052604081205460ff1690600c908260038111156113d5576113d56123c9565b60038111156113e6576113e66123c9565b81526020019081526020015f205f8154809291906114039061278c565b9190505550600c5f85600381111561141d5761141d6123c9565b600381111561142e5761142e6123c9565b81526020019081526020015f205f81548092919061144b90612745565b90915550505f858152600a60205260409020805485919060ff1916600183600381111561147a5761147a6123c9565b02179055505f858152600a602052604090819020600181018590556002018390555185907f47443aaadfb3aecd43b01a8cbc041fa65029affb63a2e16c3eb4169882176bf6906114cd908790879061275d565b60405180910390a25050505050565b6114e4611a1b565b600780546001600160a01b0319166001600160a01b0392909216919091179055565b61150e611a1b565b6007546040516370a0823160e01b81523060048201525f916001600160a01b0316906370a0823190602401602060405180830381865afa158015611554573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061157891906126ff565b90505f81116115c15760405162461bcd60e51b81526020600482015260156024820152744e6f20746f6b656e7320746f20776974686472617760581b6044820152606401610676565b6007546001600160a01b031663a9059cbb6115e46006546001600160a01b031690565b6040516001600160e01b031960e084901b1681526001600160a01b039091166004820152602481018490526044016020604051808303815f875af115801561162e573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906116529190612716565b6116965760405162461bcd60e51b8152602060048201526015602482015274151bdad95b881d1c985b9cd9995c8819985a5b1959605a1b6044820152606401610676565b50565b600b602052815f5260405f2081815481106116b2575f80fd5b905f5260205f20015f91509150505481565b60606001805461056d906126c7565b610620338383611a99565b6116e9848484610ab2565b610b353385858585611b37565b606061170182611872565b505f61171760408051602081019091525f815290565b90505f8151116117355760405180602001604052805f815250610aab565b8061173f84611c5f565b6040516020016117509291906127a1565b6040516020818303038152906040529392505050565b6001600160a01b0381165f908152600b60209081526040918290208054835181840281018401909452808452606093928301828280156117c357602002820191905f5260205f20905b8154815260200190600101908083116117af575b50505050509050919050565b6001600160a01b039182165f90815260056020908152604080832093909416825291909152205460ff1690565b611804611a1b565b6001600160a01b03811661182d57604051631e4fbdf760e01b81525f6004820152602401610676565b61169681611a48565b5f600c5f83600381111561184c5761184c6123c9565b600381111561185d5761185d6123c9565b81526020019081526020015f20549050919050565b5f818152600260205260408120546001600160a01b03168061055957604051637e27328960e01b815260048101849052602401610676565b610fb38383836001611cef565b6118bf611df3565b60027f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055565b610620828260405180602001604052805f815250611e35565b5f8061190b858585611e4c565b90506001600160a01b038116156119d9576001600160a01b0381165f908152600b60205260408120905b81548110156119d6578582828154811061195157611951612778565b905f5260205f200154036119ce578154829061196f906001906127cf565b8154811061197f5761197f612778565b905f5260205f20015482828154811061199a5761199a612778565b905f5260205f200181905550818054806119b6576119b66127e2565b600190038181905f5260205f20015f905590556119d6565b600101611935565b50505b6001600160a01b03851615611a13576001600160a01b0385165f908152600b60209081526040822080546001810182559083529120018490555b949350505050565b6006546001600160a01b0316331461130a5760405163118cdaa760e01b8152336004820152602401610676565b600680546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0905f90a35050565b6001600160a01b038216611acb57604051630b61174360e31b81526001600160a01b0383166004820152602401610676565b6001600160a01b038381165f81815260056020908152604080832094871680845294825291829020805460ff191686151590811790915591519182527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31910160405180910390a3505050565b6001600160a01b0383163b15611c5857604051630a85bd0160e11b81526001600160a01b0384169063150b7a0290611b799088908890879087906004016127f6565b6020604051808303815f875af1925050508015611bb3575060408051601f3d908101601f19168201909252611bb091810190612832565b60015b611c1a573d808015611be0576040519150601f19603f3d011682016040523d82523d5f602084013e611be5565b606091505b5080515f03611c1257604051633250574960e11b81526001600160a01b0385166004820152602401610676565b805160208201fd5b6001600160e01b03198116630a85bd0160e11b14611c5657604051633250574960e11b81526001600160a01b0385166004820152602401610676565b505b5050505050565b60605f611c6b83611f3e565b60010190505f8167ffffffffffffffff811115611c8a57611c8a61255e565b6040519080825280601f01601f191660200182016040528015611cb4576020820181803683370190505b5090508181016020015b5f19016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a8504945084611cbe57509392505050565b8080611d0357506001600160a01b03821615155b15611dc4575f611d1284611872565b90506001600160a01b03831615801590611d3e5750826001600160a01b0316816001600160a01b031614155b8015611d515750611d4f81846117cf565b155b15611d7a5760405163a9fbf51f60e01b81526001600160a01b0384166004820152602401610676565b8115611dc25783856001600160a01b0316826001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560405160405180910390a45b505b50505f90815260046020526040902080546001600160a01b0319166001600160a01b0392909216919091179055565b7f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f005460020361130a57604051633ee5aeb560e01b815260040160405180910390fd5b611e3f8383612015565b610fb3335f858585611b37565b5f828152600260205260408120546001600160a01b0390811690831615611e7857611e78818486612076565b6001600160a01b03811615611eb257611e935f855f80611cef565b6001600160a01b0381165f90815260036020526040902080545f190190555b6001600160a01b03851615611ee0576001600160a01b0385165f908152600360205260409020805460010190555b5f8481526002602052604080822080546001600160a01b0319166001600160a01b0389811691821790925591518793918516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91a4949350505050565b5f8072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b8310611f7c5772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef81000000008310611fa8576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc100008310611fc657662386f26fc10000830492506010015b6305f5e1008310611fde576305f5e100830492506008015b6127108310611ff257612710830492506004015b60648310612004576064830492506002015b600a83106105595760010192915050565b6001600160a01b03821661203e57604051633250574960e11b81525f6004820152602401610676565b5f61204a83835f6118fe565b90506001600160a01b03811615610fb3576040516339e3563760e11b81525f6004820152602401610676565b6120818383836120da565b610fb3576001600160a01b0383166120af57604051637e27328960e01b815260048101829052602401610676565b60405163177e802f60e01b81526001600160a01b038316600482015260248101829052604401610676565b5f6001600160a01b03831615801590611a135750826001600160a01b0316846001600160a01b03161480612113575061211384846117cf565b80611a135750505f908152600460205260409020546001600160a01b03908116911614919050565b6001600160e01b031981168114611696575f80fd5b5f60208284031215612160575f80fd5b8135610aab8161213b565b5f5b8381101561218557818101518382015260200161216d565b50505f910152565b5f81518084526121a481602086016020860161216b565b601f01601f19169290920160200192915050565b602081525f610aab602083018461218d565b5f602082840312156121da575f80fd5b5035919050565b80356001600160a01b03811681146121f7575f80fd5b919050565b5f806040838503121561220d575f80fd5b612216836121e1565b946020939093013593505050565b8035600481106121f7575f80fd5b5f805f60608486031215612244575f80fd5b61224d84612224565b95602085013595506040909401359392505050565b5f805f60608486031215612274575f80fd5b61227d846121e1565b925061228b602085016121e1565b9150604084013590509250925092565b5f8083601f8401126122ab575f80fd5b50813567ffffffffffffffff8111156122c2575f80fd5b6020830191508360208260051b85010111156122dc575f80fd5b9250929050565b5f805f805f805f6080888a0312156122f9575f80fd5b612302886121e1565b9650602088013567ffffffffffffffff8082111561231e575f80fd5b61232a8b838c0161229b565b909850965060408a0135915080821115612342575f80fd5b61234e8b838c0161229b565b909650945060608a0135915080821115612366575f80fd5b506123738a828b0161229b565b989b979a50959850939692959293505050565b602080825282518282018190525f9190848201906040850190845b818110156123bd578351835292840192918401916001016123a1565b50909695505050505050565b634e487b7160e01b5f52602160045260245ffd5b600481106123f957634e487b7160e01b5f52602160045260245ffd5b9052565b5f610100820190506124108284516123dd565b602083015160208301526040830151604083015260018060a01b0360608401511660608301526080830151608083015260a083015160a083015260c083015160c083015260e0830151151560e083015292915050565b5f805f8060808587031215612479575f80fd5b612482856121e1565b935061249060208601612224565b93969395505050506040820135916060013590565b5f602082840312156124b5575f80fd5b610aab82612224565b5f805f606084860312156124d0575f80fd5b8335925061228b602085016121e1565b5f602082840312156124f0575f80fd5b610aab826121e1565b5f805f806080858703121561250c575f80fd5b8435935061249060208601612224565b8015158114611696575f80fd5b5f806040838503121561253a575f80fd5b612543836121e1565b915060208301356125538161251c565b809150509250929050565b634e487b7160e01b5f52604160045260245ffd5b5f805f8060808587031215612585575f80fd5b61258e856121e1565b935061259c602086016121e1565b925060408501359150606085013567ffffffffffffffff808211156125bf575f80fd5b818701915087601f8301126125d2575f80fd5b8135818111156125e4576125e461255e565b604051601f8201601f19908116603f0116810190838211818310171561260c5761260c61255e565b816040528281528a6020848701011115612624575f80fd5b826020860160208301375f60208483010152809550505050505092959194509250565b5f8060408385031215612658575f80fd5b612661836121e1565b915061266f602084016121e1565b90509250929050565b6101008101612687828b6123dd565b602082019890985260408101969096526001600160a01b03949094166060860152608085019290925260a084015260c0830152151560e090910152919050565b600181811c908216806126db57607f821691505b6020821081036126f957634e487b7160e01b5f52602260045260245ffd5b50919050565b5f6020828403121561270f575f80fd5b5051919050565b5f60208284031215612726575f80fd5b8151610aab8161251c565b634e487b7160e01b5f52601160045260245ffd5b5f6001820161275657612756612731565b5060010190565b6040810161276b82856123dd565b8260208301529392505050565b634e487b7160e01b5f52603260045260245ffd5b5f8161279a5761279a612731565b505f190190565b5f83516127b281846020880161216b565b8351908301906127c681836020880161216b565b01949350505050565b8181038181111561055957610559612731565b634e487b7160e01b5f52603160045260245ffd5b6001600160a01b03858116825284166020820152604081018390526080606082018190525f906128289083018461218d565b9695505050505050565b5f60208284031215612842575f80fd5b8151610aab8161213b56fea2646970667358221220cb4eb16c3b4922367c85ae5766a0769c5bd050c243afb69f238558e08119068c64736f6c63430008180033","sourceMap":"287:8542:52:-:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;1527:300:5;;;;;;:::i;:::-;;:::i;:::-;;;565:14:57;;558:22;540:41;;528:2;513:18;1527:300:5;;;;;;;;2263:89;;;:::i;:::-;;;;;;;:::i;3299:154::-;;;;;;:::i;:::-;;:::i;:::-;;;-1:-1:-1;;;;;1697:32:57;;;1679:51;;1667:2;1652:18;3299:154:5;1533:203:57;3152:113:5;;;;;;:::i;:::-;;:::i;:::-;;2580:1392:52;;;;;;:::i;:::-;;:::i;:::-;;;2837:25:57;;;2825:2;2810:18;2580:1392:52;2691:177:57;3852:578:5;;;;;;:::i;:::-;;:::i;5118:1301:52:-;;;;;;:::i;:::-;;:::i;:::-;;;;;;;:::i;7547:119::-;;;;;;:::i;:::-;;:::i;:::-;;;;;;;:::i;4464:132:5:-;;;;;;:::i;:::-;;:::i;4337:771:52:-;;;;;;:::i;:::-;;:::i;442:53::-;;;;;;:::i;:::-;;;;;;;;;;;;;;2103:118:5;;;;;;:::i;:::-;;:::i;6429:429:52:-;;;;;;:::i;:::-;;:::i;1861:208:5:-;;;;;;:::i;:::-;;:::i;2293:101:0:-;;;:::i;6868:669:52:-;;;;;;:::i;:::-;;:::i;2180:106::-;;;;;;:::i;:::-;;:::i;4080:247::-;;;:::i;1638:85:0:-;1710:6;;-1:-1:-1;;;;;1710:6:0;1638:85;;929:52:52;;;;;;:::i;:::-;;:::i;2394:93:5:-;;;:::i;3487:144::-;;;;;;:::i;:::-;;:::i;4630:233::-;;;;;;:::i;:::-;;:::i;350:23:52:-;;;;;-1:-1:-1;;;;;350:23:52;;;2529:255:5;;;;;;:::i;:::-;;:::i;7676:128:52:-;;;;;;:::i;:::-;;:::i;7814:129::-;;;;;;:::i;:::-;-1:-1:-1;;;;;7907:22:52;7881:7;7907:22;;;:15;:22;;;;;:29;;7814:129;3665:153:5;;;;;;:::i;:::-;;:::i;2543:215:0:-;;;;;;:::i;:::-;;:::i;987:58:52:-;;;;;;:::i;:::-;;;;;;;;;;;;;;877:46;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;;;;877:46:52;;;;;;;;;;;;;;;;;;;;;;;;;:::i;7953:143::-;;;;;;:::i;:::-;;:::i;1527:300:5:-;1629:4;-1:-1:-1;;;;;;1664:40:5;;-1:-1:-1;;;1664:40:5;;:104;;-1:-1:-1;;;;;;;1720:48:5;;-1:-1:-1;;;1720:48:5;1664:104;:156;;;-1:-1:-1;;;;;;;;;;829:40:16;;;1784:36:5;1645:175;1527:300;-1:-1:-1;;1527:300:5:o;2263:89::-;2308:13;2340:5;2333:12;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;2263:89;:::o;3299:154::-;3366:7;3385:22;3399:7;3385:13;:22::i;:::-;-1:-1:-1;5679:7:5;5705:24;;;:15;:24;;;;;;-1:-1:-1;;;;;5705:24:5;3425:21;5609:127;3152:113;3223:35;3232:2;3236:7;735:10:11;3223:8:5;:35::i;:::-;3152:113;;:::o;2580:1392:52:-;2726:7;3023:21:13;:19;:21::i;:::-;2761:9:52::1;::::0;-1:-1:-1;;;;;2761:9:52::1;2745:63;;;::::0;-1:-1:-1;;;2745:63:52;;11708:2:57;2745:63:52::1;::::0;::::1;11690:21:57::0;11747:2;11727:18;;;11720:30;-1:-1:-1;;;11766:18:57;;;11759:48;11824:18;;2745:63:52::1;;;;;;;;;2818:12;2833:13;:27;2847:12;2833:27;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;2818:42;;2885:1;2878:4;:8;2870:42;;;::::0;-1:-1:-1;;;2870:42:52;;12055:2:57;2870:42:52::1;::::0;::::1;12037:21:57::0;12094:2;12074:18;;;12067:30;-1:-1:-1;;;12113:18:57;;;12106:51;12174:18;;2870:42:52::1;11853:345:57::0;2870:42:52::1;2986:9;::::0;:31:::1;::::0;-1:-1:-1;;;2986:31:52;;3006:10:::1;2986:31;::::0;::::1;1679:51:57::0;3021:4:52;;-1:-1:-1;;;;;2986:9:52::1;::::0;:19:::1;::::0;1652:18:57;;2986:31:52::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;:39;;2978:79;;;::::0;-1:-1:-1;;;2978:79:52;;12594:2:57;2978:79:52::1;::::0;::::1;12576:21:57::0;12633:2;12613:18;;;12606:30;12672:29;12652:18;;;12645:57;12719:18;;2978:79:52::1;12392:351:57::0;2978:79:52::1;3140:9;::::0;:55:::1;::::0;-1:-1:-1;;;3140:55:52;;3163:10:::1;3140:55;::::0;::::1;12988:34:57::0;3183:4:52::1;13038:18:57::0;;;13031:43;13090:18;;;13083:34;;;-1:-1:-1;;;;;3140:9:52;;::::1;::::0;:22:::1;::::0;12923:18:57;;3140:55:52::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;3132:89;;;::::0;-1:-1:-1;;;3132:89:52;;13580:2:57;3132:89:52::1;::::0;::::1;13562:21:57::0;13619:2;13599:18;;;13592:30;-1:-1:-1;;;13638:18:57;;;13631:51;13699:18;;3132:89:52::1;13378:345:57::0;3132:89:52::1;3291:15;:17:::0;;3273:15:::1;::::0;;3291:17:::1;::::0;::::1;:::i;:::-;;;;;3273:35;;3318:30;3328:10;3340:7;3318:9;:30::i;:::-;3389:285;;;;;;;;3426:12;3389:285;;;;;;;;:::i;:::-;::::0;;::::1;::::0;;::::1;::::0;;;;;;;;;;-1:-1:-1;3389:285:52;;;;;;;;;;;;;;;;;;3620:15:::1;3389:285:::0;;;;3659:4:::1;3389:285:::0;;;;;;;3367:19;;;:10:::1;:19:::0;;;;;:307;;;;:19;;:307;;:19;;-1:-1:-1;;3367:307:52;;::::1;::::0;;::::1;::::0;::::1;;;;;;:::i;:::-;;;::::0;;-1:-1:-1;3367:307:52::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;;;::::1;::::0;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;::::1;::::0;;-1:-1:-1;;;;;;3367:307:52::1;-1:-1:-1::0;;;;;3367:307:52;;::::1;::::0;;;::::1;::::0;;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;-1:-1:-1;;3367:307:52::1;::::0;::::1;;::::0;;;::::1;::::0;;;3709:10:::1;-1:-1:-1::0;3693:27:52;;;:15:::1;:27:::0;;;;;:41;;;;::::1;::::0;;;;;;;::::1;::::0;;;3744:18:::1;::::0;3763:12;;3744:32;::::1;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;:34;;;;;;;;;:::i;:::-;;;;;;3827:10;-1:-1:-1::0;;;;;3802:57:52::1;3818:7;3802:57;3839:12;3853:5;3802:57;;;;;;;:::i;:::-;;;;;;;;3901:10;-1:-1:-1::0;;;;;3874:58:52::1;3892:7;3874:58;3913:12;3927:4;3874:58;;;;;;;:::i;:::-;;;;;;;;3958:7:::0;-1:-1:-1;;3065:20:13;2365:1;1505:66;3972:62;3749:292;3065:20;2580:1392:52;;;;;:::o;3852:578:5:-;-1:-1:-1;;;;;3946:16:5;;3942:87;;3985:33;;-1:-1:-1;;;3985:33:5;;4015:1;3985:33;;;1679:51:57;1652:18;;3985:33:5;1533:203:57;3942:87:5;4247:21;4271:34;4279:2;4283:7;735:10:11;4271:7:5;:34::i;:::-;4247:58;;4336:4;-1:-1:-1;;;;;4319:21:5;:13;-1:-1:-1;;;;;4319:21:5;;4315:109;;4363:50;;-1:-1:-1;;;4363:50:5;;-1:-1:-1;;;;;14549:15:57;;;4363:50:5;;;14531:34:57;14581:18;;;14574:34;;;14644:15;;14624:18;;;14617:43;14466:18;;4363:50:5;14291:375:57;4315:109:5;3932:498;3852:578;;;:::o;5118:1301:52:-;5320:16;1531:13:0;:11;:13::i;:::-;5356:37:52;;::::1;:75:::0;::::1;;;-1:-1:-1::0;5397:34:52;;::::1;5356:75;5348:109;;;::::0;-1:-1:-1;;;5348:109:52;;14873:2:57;5348:109:52::1;::::0;::::1;14855:21:57::0;14912:2;14892:18;;;14885:30;-1:-1:-1;;;14931:18:57;;;14924:51;14992:18;;5348:109:52::1;14671:345:57::0;5348:109:52::1;5475:24:::0;;;;;:54:::1;;-1:-1:-1::0;5527:2:52::1;5503:26:::0;::::1;;5475:54;5467:85;;;::::0;-1:-1:-1;;;5467:85:52;;15223:2:57;5467:85:52::1;::::0;::::1;15205:21:57::0;15262:2;15242:18;;;15235:30;-1:-1:-1;;;15281:18:57;;;15274:48;15339:18;;5467:85:52::1;15021:342:57::0;5467:85:52::1;5571:25;5613:13:::0;5599:35:::1;::::0;::::1;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;::::0;-1:-1:-1;5599:35:52::1;;5571:63;;5658:9;5653:676;5673:24:::0;;::::1;5653:676;;;5736:15;:17:::0;;5718:15:::1;::::0;;5736:17:::1;::::0;::::1;:::i;:::-;;;;;5718:35;;5767:22;5777:2;5781:7;5767:9;:22::i;:::-;5838:333;;;;;;;;5879:13;;5893:1;5879:16;;;;;;;:::i;:::-;;;;;;;;;;;;;;:::i;:::-;5838:333;;;;;;;;:::i;:::-;;;;;5920:6;;5927:1;5920:9;;;;;;;:::i;:::-;;;;;;;5838:333;;;;5958:10;;5969:1;5958:13;;;;;;;:::i;:::-;;::::0;;::::1;::::0;;;::::1;;5838:333:::0;;-1:-1:-1;6010:1:52::1;5838:333:::0;;::::1;::::0;;;;;;;;;;;;;;;;6109:15:::1;5838:333:::0;;;;6152:4:::1;5838:333:::0;;;;;;;5816:19;;;:10:::1;:19:::0;;;;:355;;;;:19;;:355;;:19;;-1:-1:-1;;5816:355:52;;::::1;::::0;;::::1;::::0;::::1;;;;;;:::i;:::-;;;::::0;;-1:-1:-1;5816:355:52::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;;;::::1;::::0;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;-1:-1:-1;;;;;;5816:355:52::1;-1:-1:-1::0;;;;;5816:355:52;;::::1;;::::0;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;-1:-1:-1;;5816:355:52::1;::::0;::::1;;::::0;;;::::1;::::0;;;6198:19;;::::1;-1:-1:-1::0;6198:19:52;;;:15:::1;:19:::0;;;;;:33;;;;::::1;::::0;;;;;;;;::::1;::::0;;;6245:18:::1;::::0;6264:13;;6278:1;6264:16;;::::1;;;;;:::i;:::-;;;;;;;;;;;;;;:::i;:::-;6245:36;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;:38;;;;;;;;;:::i;:::-;;;;;;6311:7;6297:8;6306:1;6297:11;;;;;;;;:::i;:::-;;::::0;;::::1;::::0;;;;;:21;-1:-1:-1;5699:3:52::1;;5653:676;;;;6374:2;-1:-1:-1::0;;;;;6352:35:52::1;;6378:8;6352:35;;;;;;:::i;:::-;;;;;;;;6404:8:::0;5118:1301;-1:-1:-1;;;;;;;;5118:1301:52:o;7547:119::-;7606:15;-1:-1:-1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;7606:15:52;7640:19;;;;:10;:19;;;;;;;7633:26;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;;;;7633:26:52;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;7547:119;-1:-1:-1;;7547:119:52:o;4464:132:5:-;4550:39;4567:4;4573:2;4577:7;4550:39;;;;;;;;;;;;:16;:39::i;:::-;4464:132;;;:::o;4337:771:52:-;4496:7;1531:13:0;:11;:13::i;:::-;4533:15:52::1;:17:::0;;4515:15:::1;::::0;;4533:17:::1;::::0;::::1;:::i;:::-;;;;;4515:35;;4560:22;4570:2;4574:7;4560:9;:22::i;:::-;4623:285;;;;;;;;4660:12;4623:285;;;;;;;;:::i;:::-;::::0;;::::1;::::0;;::::1;::::0;;;;;;;;;;-1:-1:-1;4623:285:52;;;;;;;;;;;;;;;;;;4854:15:::1;4623:285:::0;;;;4893:4:::1;4623:285:::0;;;;;;;4601:19;;;:10:::1;:19:::0;;;;;:307;;;;:19;;:307;;:19;;-1:-1:-1;;4601:307:52;;::::1;::::0;;::::1;::::0;::::1;;;;;;:::i;:::-;;;::::0;;-1:-1:-1;4601:307:52::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;;;::::1;::::0;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;::::1;::::0;;-1:-1:-1;;;;;;4601:307:52::1;-1:-1:-1::0;;;;;4601:307:52;;::::1;;::::0;;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;::::1;::::0;;::::1;::::0;::::1;::::0;;::::1;::::0;;-1:-1:-1;;4601:307:52::1;::::0;::::1;;::::0;;;::::1;::::0;;;4927:19;;::::1;-1:-1:-1::0;4927:19:52;;;:15:::1;:19:::0;;;;;:33;;;;::::1;::::0;;;;;;;::::1;::::0;;;4970:18:::1;::::0;4989:12;;4970:32;::::1;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;:34;;;;;;;;;:::i;:::-;;;;;;5053:2;-1:-1:-1::0;;;;;5028:49:52::1;5044:7;5028:49;5057:12;5071:5;5028:49;;;;;;;:::i;:::-;;;;;;;;5094:7:::0;4337:771;-1:-1:-1;;;;;4337:771:52:o;2103:118:5:-;2166:7;2192:22;2206:7;2192:13;:22::i;6429:429:52:-;6581:10;6561:16;6569:7;6561;:16::i;:::-;-1:-1:-1;;;;;6561:30:52;;6553:52;;;;-1:-1:-1;;;6553:52:52;;15702:2:57;6553:52:52;;;15684:21:57;15741:1;15721:18;;;15714:29;-1:-1:-1;;;15759:18:57;;;15752:39;15808:18;;6553:52:52;15500:332:57;6553:52:52;6623:19;;;;:10;:19;;;;;:28;;;;;6615:60;;;;-1:-1:-1;;;6615:60:52;;16039:2:57;6615:60:52;;;16021:21:57;16078:2;16058:18;;;16051:30;-1:-1:-1;;;16097:18:57;;;16090:49;16156:18;;6615:60:52;15837:343:57;6615:60:52;6685:19;;;;:10;:19;;;;;;;;;:31;;;:45;;-1:-1:-1;;;;;;6685:45:52;-1:-1:-1;;;;;6685:45:52;;;;;;;;6740:30;;;;:43;;;6798:53;;16359:51:57;;;16426:18;;;16419:34;;;6685:19:52;;6798:53;;16332:18:57;6798:53:52;;;;;;;6429:429;;;:::o;1861:208:5:-;1924:7;-1:-1:-1;;;;;1947:19:5;;1943:87;;1989:30;;-1:-1:-1;;;1989:30:5;;2016:1;1989:30;;;1679:51:57;1652:18;;1989:30:5;1533:203:57;1943:87:5;-1:-1:-1;;;;;;2046:16:5;;;;;:9;:16;;;;;;;1861:208::o;2293:101:0:-;1531:13;:11;:13::i;:::-;2357:30:::1;2384:1;2357:18;:30::i;:::-;2293:101::o:0;6868:669:52:-;7055:10;7035:16;7043:7;7035;:16::i;:::-;-1:-1:-1;;;;;7035:30:52;;7027:52;;;;-1:-1:-1;;;7027:52:52;;15702:2:57;7027:52:52;;;15684:21:57;15741:1;15721:18;;;15714:29;-1:-1:-1;;;15759:18:57;;;15752:39;15808:18;;7027:52:52;15500:332:57;7027:52:52;7097:19;;;;:10;:19;;;;;:28;;;;;7089:60;;;;-1:-1:-1;;;7089:60:52;;16039:2:57;7089:60:52;;;16021:21:57;16078:2;16058:18;;;16051:30;-1:-1:-1;;;16097:18:57;;;16090:49;16156:18;;7089:60:52;15837:343:57;7089:60:52;7168:20;7191:19;;;:10;:19;;;;;:32;;;;7233:18;;7191:32;7233:27;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;:29;;;;;;;;;:::i;:::-;;;;;;7272:18;:27;7291:7;7272:27;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;:29;;;;;;;;;:::i;:::-;;;;-1:-1:-1;;7320:19:52;;;;:10;:19;;;;;:42;;7355:7;;7320:19;-1:-1:-1;;7320:42:52;;7355:7;7320:42;;;;;;;;:::i;:::-;;;;;-1:-1:-1;7372:19:52;;;;:10;:19;;;;;;;:25;;;:36;;;7418:29;;:44;;;7486;7383:7;;7486:44;;;;7512:7;;7400:8;;7486:44;:::i;:::-;;;;;;;;7017:520;6868:669;;;;:::o;2180:106::-;1531:13:0;:11;:13::i;:::-;2249:9:52::1;:30:::0;;-1:-1:-1;;;;;;2249:30:52::1;-1:-1:-1::0;;;;;2249:30:52;;;::::1;::::0;;;::::1;::::0;;2180:106::o;4080:247::-;1531:13:0;:11;:13::i;:::-;4151:9:52::1;::::0;:34:::1;::::0;-1:-1:-1;;;4151:34:52;;4179:4:::1;4151:34;::::0;::::1;1679:51:57::0;4133:15:52::1;::::0;-1:-1:-1;;;;;4151:9:52::1;::::0;:19:::1;::::0;1652:18:57;;4151:34:52::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;4133:52;;4213:1;4203:7;:11;4195:45;;;::::0;-1:-1:-1;;;4195:45:52;;16807:2:57;4195:45:52::1;::::0;::::1;16789:21:57::0;16846:2;16826:18;;;16819:30;-1:-1:-1;;;16865:18:57;;;16858:51;16926:18;;4195:45:52::1;16605:345:57::0;4195:45:52::1;4258:9;::::0;-1:-1:-1;;;;;4258:9:52::1;:18;4277:7;1710:6:0::0;;-1:-1:-1;;;;;1710:6:0;;1638:85;4277:7:52::1;4258:36;::::0;-1:-1:-1;;;;;;4258:36:52::1;::::0;;;;;;-1:-1:-1;;;;;16377:32:57;;;4258:36:52::1;::::0;::::1;16359:51:57::0;16426:18;;;16419:34;;;16332:18;;4258:36:52::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;4250:70;;;::::0;-1:-1:-1;;;4250:70:52;;13580:2:57;4250:70:52::1;::::0;::::1;13562:21:57::0;13619:2;13599:18;;;13592:30;-1:-1:-1;;;13638:18:57;;;13631:51;13699:18;;4250:70:52::1;13378:345:57::0;4250:70:52::1;4123:204;4080:247::o:0;929:52::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::o;2394:93:5:-;2441:13;2473:7;2466:14;;;;;:::i;3487:144::-;3572:52;735:10:11;3605:8:5;3615;3572:18;:52::i;4630:233::-;4743:31;4756:4;4762:2;4766:7;4743:12;:31::i;:::-;4784:72;735:10:11;4832:4:5;4838:2;4842:7;4851:4;4784:33;:72::i;2529:255::-;2593:13;2618:22;2632:7;2618:13;:22::i;:::-;;2651:21;2675:10;3102:9;;;;;;;;;-1:-1:-1;3102:9:5;;;3026:92;2675:10;2651:34;;2726:1;2708:7;2702:21;:25;:75;;;;;;;;;;;;;;;;;2744:7;2753:18;:7;:16;:18::i;:::-;2730:42;;;;;;;;;:::i;:::-;;;;;;;;;;;;;2695:82;2529:255;-1:-1:-1;;;2529:255:5:o;7676:128:52:-;-1:-1:-1;;;;;7775:22:52;;;;;;:15;:22;;;;;;;;;7768:29;;;;;;;;;;;;;;;;;7740:16;;7768:29;;;7775:22;7768:29;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;7676:128;;;:::o;3665:153:5:-;-1:-1:-1;;;;;3776:25:5;;;3753:4;3776:25;;;:18;:25;;;;;;;;:35;;;;;;;;;;;;;;;3665:153::o;2543:215:0:-;1531:13;:11;:13::i;:::-;-1:-1:-1;;;;;2627:22:0;::::1;2623:91;;2672:31;::::0;-1:-1:-1;;;2672:31:0;;2700:1:::1;2672:31;::::0;::::1;1679:51:57::0;1652:18;;2672:31:0::1;1533:203:57::0;2623:91:0::1;2723:28;2742:8;2723:18;:28::i;7953:143:52:-:0;8031:7;8057:18;:32;8076:12;8057:32;;;;;;;;:::i;:::-;;;;;;;;;:::i;:::-;;;;;;;;;;;;;8050:39;;7953:143;;;:::o;15858:241:5:-;15921:7;5470:16;;;:7;:16;;;;;;-1:-1:-1;;;;;5470:16:5;;15983:88;;16029:31;;-1:-1:-1;;;16029:31:5;;;;;2837:25:57;;;2810:18;;16029:31:5;2691:177:57;14138:120:5;14218:33;14227:2;14231:7;14240:4;14246;14218:8;:33::i;3749:292:13:-;3872:25;:23;:25::i;:::-;2407:1;1505:66;3972:62;3749:292::o;10302:100:5:-;10369:26;10379:2;10383:7;10369:26;;;;;;;;;;;;:9;:26::i;8106:721:52:-;8193:7;8212:21;8236:32;8250:2;8254:7;8263:4;8236:13;:32::i;:::-;8212:56;-1:-1:-1;;;;;;8291:27:52;;;8287:397;;-1:-1:-1;;;;;8365:30:52;;8334:28;8365:30;;;:15;:30;;;;;;8409:265;8433:17;;8429:21;;8409:265;;;8496:7;8479:10;8490:1;8479:13;;;;;;;;:::i;:::-;;;;;;;;;:24;8475:185;;8554:17;;8543:10;;8554:21;;8574:1;;8554:21;:::i;:::-;8543:33;;;;;;;;:::i;:::-;;;;;;;;;8527:10;8538:1;8527:13;;;;;;;;:::i;:::-;;;;;;;;:49;;;;8598:10;:16;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;8636:5;;8475:185;8452:3;;8409:265;;;;8320:364;8287:397;-1:-1:-1;;;;;8706:16:52;;;8702:80;;-1:-1:-1;;;;;8738:19:52;;;;;;:15;:19;;;;;;;:33;;;;;;;;;;;;;;;;8702:80;8807:13;8106:721;-1:-1:-1;;;;8106:721:52:o;1796:162:0:-;1710:6;;-1:-1:-1;;;;;1710:6:0;735:10:11;1855:23:0;1851:101;;1901:40;;-1:-1:-1;;;1901:40:0;;735:10:11;1901:40:0;;;1679:51:57;1652:18;;1901:40:0;1533:203:57;2912:187:0;3004:6;;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;;3052:40;;3004:6;;;3020:17;3004:6;;3052:40;;2985:16;;3052:40;2975:124;2912:187;:::o;15311:312:5:-;-1:-1:-1;;;;;15418:22:5;;15414:91;;15463:31;;-1:-1:-1;;;15463:31:5;;-1:-1:-1;;;;;1697:32:57;;15463:31:5;;;1679:51:57;1652:18;;15463:31:5;1533:203:57;15414:91:5;-1:-1:-1;;;;;15514:25:5;;;;;;;:18;:25;;;;;;;;:35;;;;;;;;;;;;;:46;;-1:-1:-1;;15514:46:5;;;;;;;;;;15575:41;;540::57;;;15575::5;;513:18:57;15575:41:5;;;;;;;15311:312;;;:::o;994:926:9:-;-1:-1:-1;;;;;1174:14:9;;;:18;1170:744;;1212:67;;-1:-1:-1;;;1212:67:9;;-1:-1:-1;;;;;1212:36:9;;;;;:67;;1249:8;;1259:4;;1265:7;;1274:4;;1212:67;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;-1:-1:-1;1212:67:9;;;;;;;;-1:-1:-1;;1212:67:9;;;;;;;;;;;;:::i;:::-;;;1208:696;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;1569:6;:13;1586:1;1569:18;1565:325;;1673:39;;-1:-1:-1;;;1673:39:9;;-1:-1:-1;;;;;1697:32:57;;1673:39:9;;;1679:51:57;1652:18;;1673:39:9;1533:203:57;1565:325:9;1842:6;1836:13;1829:4;1821:6;1817:17;1810:40;1208:696;-1:-1:-1;;;;;;1326:51:9;;-1:-1:-1;;;1326:51:9;1322:182;;1446:39;;-1:-1:-1;;;1446:39:9;;-1:-1:-1;;;;;1697:32:57;;1446:39:9;;;1679:51:57;1652:18;;1446:39:9;1533:203:57;1322:182:9;1280:238;1208:696;994:926;;;;;:::o;1343:634:15:-;1399:13;1448:14;1465:17;1476:5;1465:10;:17::i;:::-;1485:1;1465:21;1448:38;;1500:20;1534:6;1523:18;;;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;1523:18:15;-1:-1:-1;1500:41:15;-1:-1:-1;1630:30:15;;;1646:4;1630:30;1687:247;-1:-1:-1;;1718:5:15;-1:-1:-1;;;1817:2:15;1806:14;;1801:32;1718:5;1788:46;1878:2;1869:11;;;-1:-1:-1;1898:21:15;1687:247;1898:21;-1:-1:-1;1954:6:15;1343:634;-1:-1:-1;;;1343:634:15:o;14440:662:5:-;14600:9;:31;;;-1:-1:-1;;;;;;14613:18:5;;;;14600:31;14596:460;;;14647:13;14663:22;14677:7;14663:13;:22::i;:::-;14647:38;-1:-1:-1;;;;;;14813:18:5;;;;;;:35;;;14844:4;-1:-1:-1;;;;;14835:13:5;:5;-1:-1:-1;;;;;14835:13:5;;;14813:35;:69;;;;;14853:29;14870:5;14877:4;14853:16;:29::i;:::-;14852:30;14813:69;14809:142;;;14909:27;;-1:-1:-1;;;14909:27:5;;-1:-1:-1;;;;;1697:32:57;;14909:27:5;;;1679:51:57;1652:18;;14909:27:5;1533:203:57;14809:142:5;14969:9;14965:81;;;15023:7;15019:2;-1:-1:-1;;;;;15003:28:5;15012:5;-1:-1:-1;;;;;15003:28:5;;;;;;;;;;;14965:81;14633:423;14596:460;-1:-1:-1;;15066:24:5;;;;:15;:24;;;;;:29;;-1:-1:-1;;;;;;15066:29:5;-1:-1:-1;;;;;15066:29:5;;;;;;;;;;14440:662::o;3586:157:13:-;1505:66;4560:52;2407:1;4560:63;3644:93;;3696:30;;-1:-1:-1;;;3696:30:13;;;;;;;;;;;10623:207:5;10717:18;10723:2;10727:7;10717:5;:18::i;:::-;10745:78;735:10:11;10801:1:5;10805:2;10809:7;10818:4;10745:33;:78::i;8507:795::-;8593:7;5470:16;;;:7;:16;;;;;;-1:-1:-1;;;;;5470:16:5;;;;8704:18;;;8700:86;;8738:37;8755:4;8761;8767:7;8738:16;:37::i;:::-;-1:-1:-1;;;;;8830:18:5;;;8826:256;;8946:48;8963:1;8967:7;8984:1;8988:5;8946:8;:48::i;:::-;-1:-1:-1;;;;;9037:15:5;;;;;;:9;:15;;;;;:20;;-1:-1:-1;;9037:20:5;;;8826:256;-1:-1:-1;;;;;9096:16:5;;;9092:107;;-1:-1:-1;;;;;9156:13:5;;;;;;:9;:13;;;;;:18;;9173:1;9156:18;;;9092:107;9209:16;;;;:7;:16;;;;;;:21;;-1:-1:-1;;;;;;9209:21:5;-1:-1:-1;;;;;9209:21:5;;;;;;;;;9246:27;;9209:16;;9246:27;;;;;;;9291:4;8507:795;-1:-1:-1;;;;8507:795:5:o;29170:916:18:-;29223:7;;-1:-1:-1;;;29298:17:18;;29294:103;;-1:-1:-1;;;29335:17:18;;;-1:-1:-1;29380:2:18;29370:12;29294:103;29423:8;29414:5;:17;29410:103;;29460:8;29451:17;;;-1:-1:-1;29496:2:18;29486:12;29410:103;29539:8;29530:5;:17;29526:103;;29576:8;29567:17;;;-1:-1:-1;29612:2:18;29602:12;29526:103;29655:7;29646:5;:16;29642:100;;29691:7;29682:16;;;-1:-1:-1;29726:1:18;29716:11;29642:100;29768:7;29759:5;:16;29755:100;;29804:7;29795:16;;;-1:-1:-1;29839:1:18;29829:11;29755:100;29881:7;29872:5;:16;29868:100;;29917:7;29908:16;;;-1:-1:-1;29952:1:18;29942:11;29868:100;29994:7;29985:5;:16;29981:66;;30031:1;30021:11;30073:6;29170:916;-1:-1:-1;;29170:916:18:o;9624:327:5:-;-1:-1:-1;;;;;9691:16:5;;9687:87;;9730:33;;-1:-1:-1;;;9730:33:5;;9760:1;9730:33;;;1679:51:57;1652:18;;9730:33:5;1533:203:57;9687:87:5;9783:21;9807:32;9815:2;9819:7;9836:1;9807:7;:32::i;:::-;9783:56;-1:-1:-1;;;;;;9853:27:5;;;9849:96;;9903:31;;-1:-1:-1;;;9903:31:5;;9931:1;9903:31;;;1679:51:57;1652:18;;9903:31:5;1533:203:57;6751:368:5;6863:38;6877:5;6884:7;6893;6863:13;:38::i;:::-;6858:255;;-1:-1:-1;;;;;6921:19:5;;6917:186;;6967:31;;-1:-1:-1;;;6967:31:5;;;;;2837:25:57;;;2810:18;;6967:31:5;2691:177:57;6917:186:5;7044:44;;-1:-1:-1;;;7044:44:5;;-1:-1:-1;;;;;16377:32:57;;7044:44:5;;;16359:51:57;16426:18;;;16419:34;;;16332:18;;7044:44:5;16185:274:57;6047:272:5;6150:4;-1:-1:-1;;;;;6185:21:5;;;;;;:127;;;6232:7;-1:-1:-1;;;;;6223:16:5;:5;-1:-1:-1;;;;;6223:16:5;;:52;;;;6243:32;6260:5;6267:7;6243:16;:32::i;:::-;6223:88;;;-1:-1:-1;;5679:7:5;5705:24;;;:15;:24;;;;;;-1:-1:-1;;;;;5705:24:5;;;6279:32;;;;6166:146;-1:-1:-1;6047:272:5:o;14:131:57:-;-1:-1:-1;;;;;;88:32:57;;78:43;;68:71;;135:1;132;125:12;150:245;208:6;261:2;249:9;240:7;236:23;232:32;229:52;;;277:1;274;267:12;229:52;316:9;303:23;335:30;359:5;335:30;:::i;592:250::-;677:1;687:113;701:6;698:1;695:13;687:113;;;777:11;;;771:18;758:11;;;751:39;723:2;716:10;687:113;;;-1:-1:-1;;834:1:57;816:16;;809:27;592:250::o;847:271::-;889:3;927:5;921:12;954:6;949:3;942:19;970:76;1039:6;1032:4;1027:3;1023:14;1016:4;1009:5;1005:16;970:76;:::i;:::-;1100:2;1079:15;-1:-1:-1;;1075:29:57;1066:39;;;;1107:4;1062:50;;847:271;-1:-1:-1;;847:271:57:o;1123:220::-;1272:2;1261:9;1254:21;1235:4;1292:45;1333:2;1322:9;1318:18;1310:6;1292:45;:::i;1348:180::-;1407:6;1460:2;1448:9;1439:7;1435:23;1431:32;1428:52;;;1476:1;1473;1466:12;1428:52;-1:-1:-1;1499:23:57;;1348:180;-1:-1:-1;1348:180:57:o;1741:173::-;1809:20;;-1:-1:-1;;;;;1858:31:57;;1848:42;;1838:70;;1904:1;1901;1894:12;1838:70;1741:173;;;:::o;1919:254::-;1987:6;1995;2048:2;2036:9;2027:7;2023:23;2019:32;2016:52;;;2064:1;2061;2054:12;2016:52;2087:29;2106:9;2087:29;:::i;:::-;2077:39;2163:2;2148:18;;;;2135:32;;-1:-1:-1;;;1919:254:57:o;2178:153::-;2256:20;;2305:1;2295:12;;2285:40;;2321:1;2318;2311:12;2336:350;2431:6;2439;2447;2500:2;2488:9;2479:7;2475:23;2471:32;2468:52;;;2516:1;2513;2506:12;2468:52;2539:39;2568:9;2539:39;:::i;:::-;2529:49;2625:2;2610:18;;2597:32;;-1:-1:-1;2676:2:57;2661:18;;;2648:32;;2336:350;-1:-1:-1;;;2336:350:57:o;2873:328::-;2950:6;2958;2966;3019:2;3007:9;2998:7;2994:23;2990:32;2987:52;;;3035:1;3032;3025:12;2987:52;3058:29;3077:9;3058:29;:::i;:::-;3048:39;;3106:38;3140:2;3129:9;3125:18;3106:38;:::i;:::-;3096:48;;3191:2;3180:9;3176:18;3163:32;3153:42;;2873:328;;;;;:::o;3206:377::-;3279:8;3289:6;3343:3;3336:4;3328:6;3324:17;3320:27;3310:55;;3361:1;3358;3351:12;3310:55;-1:-1:-1;3384:20:57;;3427:18;3416:30;;3413:50;;;3459:1;3456;3449:12;3413:50;3496:4;3488:6;3484:17;3472:29;;3556:3;3549:4;3539:6;3536:1;3532:14;3524:6;3520:27;3516:38;3513:47;3510:67;;;3573:1;3570;3563:12;3510:67;3206:377;;;;;:::o;3588:1211::-;3773:6;3781;3789;3797;3805;3813;3821;3874:3;3862:9;3853:7;3849:23;3845:33;3842:53;;;3891:1;3888;3881:12;3842:53;3914:29;3933:9;3914:29;:::i;:::-;3904:39;;3994:2;3983:9;3979:18;3966:32;4017:18;4058:2;4050:6;4047:14;4044:34;;;4074:1;4071;4064:12;4044:34;4113:80;4185:7;4176:6;4165:9;4161:22;4113:80;:::i;:::-;4212:8;;-1:-1:-1;4087:106:57;-1:-1:-1;4300:2:57;4285:18;;4272:32;;-1:-1:-1;4316:16:57;;;4313:36;;;4345:1;4342;4335:12;4313:36;4384:82;4458:7;4447:8;4436:9;4432:24;4384:82;:::i;:::-;4485:8;;-1:-1:-1;4358:108:57;-1:-1:-1;4573:2:57;4558:18;;4545:32;;-1:-1:-1;4589:16:57;;;4586:36;;;4618:1;4615;4608:12;4586:36;;4657:82;4731:7;4720:8;4709:9;4705:24;4657:82;:::i;:::-;3588:1211;;;;-1:-1:-1;3588:1211:57;;-1:-1:-1;3588:1211:57;;;;4631:108;;-1:-1:-1;;;3588:1211:57:o;4804:632::-;4975:2;5027:21;;;5097:13;;5000:18;;;5119:22;;;4946:4;;4975:2;5198:15;;;;5172:2;5157:18;;;4946:4;5241:169;5255:6;5252:1;5249:13;5241:169;;;5316:13;;5304:26;;5385:15;;;;5350:12;;;;5277:1;5270:9;5241:169;;;-1:-1:-1;5427:3:57;;4804:632;-1:-1:-1;;;;;;4804:632:57:o;5441:127::-;5502:10;5497:3;5493:20;5490:1;5483:31;5533:4;5530:1;5523:15;5557:4;5554:1;5547:15;5573:240;5657:1;5650:5;5647:12;5637:143;;5702:10;5697:3;5693:20;5690:1;5683:31;5737:4;5734:1;5727:15;5765:4;5762:1;5755:15;5637:143;5789:18;;5573:240::o;5818:744::-;5964:4;6006:3;5995:9;5991:19;5983:27;;6019:54;6063:9;6054:6;6048:13;6019:54;:::i;:::-;6129:4;6121:6;6117:17;6111:24;6104:4;6093:9;6089:20;6082:54;6192:4;6184:6;6180:17;6174:24;6167:4;6156:9;6152:20;6145:54;6284:1;6280;6275:3;6271:11;6267:19;6259:4;6251:6;6247:17;6241:24;6237:50;6230:4;6219:9;6215:20;6208:80;6344:4;6336:6;6332:17;6326:24;6319:4;6308:9;6304:20;6297:54;6407:4;6399:6;6395:17;6389:24;6382:4;6371:9;6367:20;6360:54;6470:4;6462:6;6458:17;6452:24;6445:4;6434:9;6430:20;6423:54;6547:4;6539:6;6535:17;6529:24;6522:32;6515:40;6508:4;6497:9;6493:20;6486:70;5818:744;;;;:::o;6567:425::-;6671:6;6679;6687;6695;6748:3;6736:9;6727:7;6723:23;6719:33;6716:53;;;6765:1;6762;6755:12;6716:53;6788:29;6807:9;6788:29;:::i;:::-;6778:39;;6836:48;6880:2;6869:9;6865:18;6836:48;:::i;:::-;6567:425;;6826:58;;-1:-1:-1;;;;6931:2:57;6916:18;;6903:32;;6982:2;6967:18;6954:32;;6567:425::o;6997:214::-;7074:6;7127:2;7115:9;7106:7;7102:23;7098:32;7095:52;;;7143:1;7140;7133:12;7095:52;7166:39;7195:9;7166:39;:::i;7216:322::-;7293:6;7301;7309;7362:2;7350:9;7341:7;7337:23;7333:32;7330:52;;;7378:1;7375;7368:12;7330:52;7414:9;7401:23;7391:33;;7443:38;7477:2;7466:9;7462:18;7443:38;:::i;7543:186::-;7602:6;7655:2;7643:9;7634:7;7630:23;7626:32;7623:52;;;7671:1;7668;7661:12;7623:52;7694:29;7713:9;7694:29;:::i;7734:419::-;7838:6;7846;7854;7862;7915:3;7903:9;7894:7;7890:23;7886:33;7883:53;;;7932:1;7929;7922:12;7883:53;7968:9;7955:23;7945:33;;7997:48;8041:2;8030:9;8026:18;7997:48;:::i;8158:118::-;8244:5;8237:13;8230:21;8223:5;8220:32;8210:60;;8266:1;8263;8256:12;8281:315;8346:6;8354;8407:2;8395:9;8386:7;8382:23;8378:32;8375:52;;;8423:1;8420;8413:12;8375:52;8446:29;8465:9;8446:29;:::i;:::-;8436:39;;8525:2;8514:9;8510:18;8497:32;8538:28;8560:5;8538:28;:::i;:::-;8585:5;8575:15;;;8281:315;;;;;:::o;8601:127::-;8662:10;8657:3;8653:20;8650:1;8643:31;8693:4;8690:1;8683:15;8717:4;8714:1;8707:15;8733:1138;8828:6;8836;8844;8852;8905:3;8893:9;8884:7;8880:23;8876:33;8873:53;;;8922:1;8919;8912:12;8873:53;8945:29;8964:9;8945:29;:::i;:::-;8935:39;;8993:38;9027:2;9016:9;9012:18;8993:38;:::i;:::-;8983:48;;9078:2;9067:9;9063:18;9050:32;9040:42;;9133:2;9122:9;9118:18;9105:32;9156:18;9197:2;9189:6;9186:14;9183:34;;;9213:1;9210;9203:12;9183:34;9251:6;9240:9;9236:22;9226:32;;9296:7;9289:4;9285:2;9281:13;9277:27;9267:55;;9318:1;9315;9308:12;9267:55;9354:2;9341:16;9376:2;9372;9369:10;9366:36;;;9382:18;;:::i;:::-;9457:2;9451:9;9425:2;9511:13;;-1:-1:-1;;9507:22:57;;;9531:2;9503:31;9499:40;9487:53;;;9555:18;;;9575:22;;;9552:46;9549:72;;;9601:18;;:::i;:::-;9641:10;9637:2;9630:22;9676:2;9668:6;9661:18;9716:7;9711:2;9706;9702;9698:11;9694:20;9691:33;9688:53;;;9737:1;9734;9727:12;9688:53;9793:2;9788;9784;9780:11;9775:2;9767:6;9763:15;9750:46;9838:1;9833:2;9828;9820:6;9816:15;9812:24;9805:35;9859:6;9849:16;;;;;;;8733:1138;;;;;;;:::o;10098:260::-;10166:6;10174;10227:2;10215:9;10206:7;10202:23;10198:32;10195:52;;;10243:1;10240;10233:12;10195:52;10266:29;10285:9;10266:29;:::i;:::-;10256:39;;10314:38;10348:2;10337:9;10333:18;10314:38;:::i;:::-;10304:48;;10098:260;;;;;:::o;10363:753::-;10703:3;10688:19;;10716:47;10692:9;10745:6;10716:47;:::i;:::-;10794:2;10779:18;;10772:34;;;;10837:2;10822:18;;10815:34;;;;-1:-1:-1;;;;;10885:32:57;;;;10880:2;10865:18;;10858:60;10949:3;10934:19;;10927:35;;;;10905:3;10978:19;;10971:35;11037:3;11022:19;;11015:35;11094:14;11087:22;11081:3;11066:19;;;11059:51;10363:753;;-1:-1:-1;10363:753:57:o;11121:380::-;11200:1;11196:12;;;;11243;;;11264:61;;11318:4;11310:6;11306:17;11296:27;;11264:61;11371:2;11363:6;11360:14;11340:18;11337:38;11334:161;;11417:10;11412:3;11408:20;11405:1;11398:31;11452:4;11449:1;11442:15;11480:4;11477:1;11470:15;11334:161;;11121:380;;;:::o;12203:184::-;12273:6;12326:2;12314:9;12305:7;12301:23;12297:32;12294:52;;;12342:1;12339;12332:12;12294:52;-1:-1:-1;12365:16:57;;12203:184;-1:-1:-1;12203:184:57:o;13128:245::-;13195:6;13248:2;13236:9;13227:7;13223:23;13219:32;13216:52;;;13264:1;13261;13254:12;13216:52;13296:9;13290:16;13315:28;13337:5;13315:28;:::i;13728:127::-;13789:10;13784:3;13780:20;13777:1;13770:31;13820:4;13817:1;13810:15;13844:4;13841:1;13834:15;13860:135;13899:3;13920:17;;;13917:43;;13940:18;;:::i;:::-;-1:-1:-1;13987:1:57;13976:13;;13860:135::o;14000:286::-;14178:2;14163:18;;14190:47;14167:9;14219:6;14190:47;:::i;:::-;14273:6;14268:2;14257:9;14253:18;14246:34;14000:286;;;;;:::o;15368:127::-;15429:10;15424:3;15420:20;15417:1;15410:31;15460:4;15457:1;15450:15;15484:4;15481:1;15474:15;16464:136;16503:3;16531:5;16521:39;;16540:18;;:::i;:::-;-1:-1:-1;;;16576:18:57;;16464:136::o;16955:496::-;17134:3;17172:6;17166:13;17188:66;17247:6;17242:3;17235:4;17227:6;17223:17;17188:66;:::i;:::-;17317:13;;17276:16;;;;17339:70;17317:13;17276:16;17386:4;17374:17;;17339:70;:::i;:::-;17425:20;;16955:496;-1:-1:-1;;;;16955:496:57:o;17456:128::-;17523:9;;;17544:11;;;17541:37;;;17558:18;;:::i;17589:127::-;17650:10;17645:3;17641:20;17638:1;17631:31;17681:4;17678:1;17671:15;17705:4;17702:1;17695:15;17721:489;-1:-1:-1;;;;;17990:15:57;;;17972:34;;18042:15;;18037:2;18022:18;;18015:43;18089:2;18074:18;;18067:34;;;18137:3;18132:2;18117:18;;18110:31;;;17915:4;;18158:46;;18184:19;;18176:6;18158:46;:::i;:::-;18150:54;17721:489;-1:-1:-1;;;;;;17721:489:57:o;18215:249::-;18284:6;18337:2;18325:9;18316:7;18312:23;18308:32;18305:52;;;18353:1;18350;18343:12;18305:52;18385:9;18379:16;18404:30;18428:5;18404:30;:::i","linkReferences":{}},"methodIdentifiers":{"approve(address,uint256)":"095ea7b3","balanceOf(address)":"70a08231","batchMintProperties(address,uint8[],uint256[],uint256[])":"25add652","gameToken()":"c3dfdae6","getApproved(uint256)":"081812fc","getOwnerProperties(address)":"cb644897","getOwnerPropertyCount(address)":"d79fb4ff","getProperty(uint256)":"32665ffb","getPropertyTypeCount(uint8)":"fc0dbbb7","isApprovedForAll(address,address)":"e985e9c5","linkToRWA(uint256,address,uint256)":"6b39bac8","mintProperty(address,uint8,uint256,uint256)":"55d5efb4","name()":"06fdde03","owner()":"8da5cb5b","ownerOf(uint256)":"6352211e","ownerProperties(address,uint256)":"8f48bd5b","properties(uint256)":"f7b10808","propertyCosts(uint8)":"5a25f7bd","propertyTypeCounts(uint8)":"f412cc6e","purchaseProperty(uint8,uint256,uint256)":"2222f588","renounceOwnership()":"715018a6","safeTransferFrom(address,address,uint256)":"42842e0e","safeTransferFrom(address,address,uint256,bytes)":"b88d4fde","setApprovalForAll(address,bool)":"a22cb465","setGameToken(address)":"80d29e66","supportsInterface(bytes4)":"01ffc9a7","symbol()":"95d89b41","tokenURI(uint256)":"c87b56dd","transferFrom(address,address,uint256)":"23b872dd","transferOwnership(address)":"f2fde38b","upgradeProperty(uint256,uint8,uint256,uint256)":"7d61a62b","withdrawTokens()":"8d8f2adb"},"rawMetadata":"{\"compiler\":{\"version\":\"0.8.24+commit.e11b9ed9\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"sender\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"ERC721IncorrectOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"ERC721InsufficientApproval\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"approver\",\"type\":\"address\"}],\"name\":\"ERC721InvalidApprover\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"}],\"name\":\"ERC721InvalidOperator\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"ERC721InvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"receiver\",\"type\":\"address\"}],\"name\":\"ERC721InvalidReceiver\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"sender\",\"type\":\"address\"}],\"name\":\"ERC721InvalidSender\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"ERC721NonexistentToken\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"OwnableInvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"OwnableUnauthorizedAccount\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"ReentrancyGuardReentrantCall\",\"type\":\"error\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"approved\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"Approval\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"bool\",\"name\":\"approved\",\"type\":\"bool\"}],\"name\":\"ApprovalForAll\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"previousOwner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"OwnershipTransferred\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"tokenIds\",\"type\":\"uint256[]\"}],\"name\":\"PropertiesBatchMinted\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"}],\"name\":\"PropertyCreated\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"address\",\"name\":\"rwaContract\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"rwaTokenId\",\"type\":\"uint256\"}],\"name\":\"PropertyLinkedToRWA\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"buyer\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"cost\",\"type\":\"uint256\"}],\"name\":\"PropertyPurchased\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"newType\",\"type\":\"uint8\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"newValue\",\"type\":\"uint256\"}],\"name\":\"PropertyUpgraded\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"Transfer\",\"type\":\"event\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"approve\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"balanceOf\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"enum PropertyNFT.PropertyType[]\",\"name\":\"propertyTypes\",\"type\":\"uint8[]\"},{\"internalType\":\"uint256[]\",\"name\":\"values\",\"type\":\"uint256[]\"},{\"internalType\":\"uint256[]\",\"name\":\"yieldRates\",\"type\":\"uint256[]\"}],\"name\":\"batchMintProperties\",\"outputs\":[{\"internalType\":\"uint256[]\",\"name\":\"\",\"type\":\"uint256[]\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"gameToken\",\"outputs\":[{\"internalType\":\"contract IERC20\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"getApproved\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"getOwnerProperties\",\"outputs\":[{\"internalType\":\"uint256[]\",\"name\":\"\",\"type\":\"uint256[]\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"getOwnerPropertyCount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"getProperty\",\"outputs\":[{\"components\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"yieldRate\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"rwaContract\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"rwaTokenId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"totalYieldEarned\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"createdAt\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"isActive\",\"type\":\"bool\"}],\"internalType\":\"struct PropertyNFT.Property\",\"name\":\"\",\"type\":\"tuple\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"}],\"name\":\"getPropertyTypeCount\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"}],\"name\":\"isApprovedForAll\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"rwaContract\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"rwaTokenId\",\"type\":\"uint256\"}],\"name\":\"linkToRWA\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"yieldRate\",\"type\":\"uint256\"}],\"name\":\"mintProperty\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"name\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"ownerOf\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"ownerProperties\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"properties\",\"outputs\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"yieldRate\",\"type\":\"uint256\"},{\"internalType\":\"address\",\"name\":\"rwaContract\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"rwaTokenId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"totalYieldEarned\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"createdAt\",\"type\":\"uint256\"},{\"internalType\":\"bool\",\"name\":\"isActive\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"\",\"type\":\"uint8\"}],\"name\":\"propertyCosts\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"\",\"type\":\"uint8\"}],\"name\":\"propertyTypeCounts\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"propertyType\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"value\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"yieldRate\",\"type\":\"uint256\"}],\"name\":\"purchaseProperty\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"renounceOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"safeTransferFrom\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"bytes\",\"name\":\"data\",\"type\":\"bytes\"}],\"name\":\"safeTransferFrom\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"operator\",\"type\":\"address\"},{\"internalType\":\"bool\",\"name\":\"approved\",\"type\":\"bool\"}],\"name\":\"setApprovalForAll\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_gameToken\",\"type\":\"address\"}],\"name\":\"setGameToken\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"bytes4\",\"name\":\"interfaceId\",\"type\":\"bytes4\"}],\"name\":\"supportsInterface\",\"outputs\":[{\"internalType\":\"bool\",\"name\":\"\",\"type\":\"bool\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"symbol\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"tokenURI\",\"outputs\":[{\"internalType\":\"string\",\"name\":\"\",\"type\":\"string\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"from\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"to\",\"type\":\"address\"},{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"}],\"name\":\"transferFrom\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"transferOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"tokenId\",\"type\":\"uint256\"},{\"internalType\":\"enum PropertyNFT.PropertyType\",\"name\":\"newType\",\"type\":\"uint8\"},{\"internalType\":\"uint256\",\"name\":\"newValue\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"newYieldRate\",\"type\":\"uint256\"}],\"name\":\"upgradeProperty\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"withdrawTokens\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}],\"devdoc\":{\"errors\":{\"ERC721IncorrectOwner(address,uint256,address)\":[{\"details\":\"Indicates an error related to the ownership over a particular token. Used in transfers.\",\"params\":{\"owner\":\"Address of the current owner of a token.\",\"sender\":\"Address whose tokens are being transferred.\",\"tokenId\":\"Identifier number of a token.\"}}],\"ERC721InsufficientApproval(address,uint256)\":[{\"details\":\"Indicates a failure with the `operator`\\u2019s approval. Used in transfers.\",\"params\":{\"operator\":\"Address that may be allowed to operate on tokens without being their owner.\",\"tokenId\":\"Identifier number of a token.\"}}],\"ERC721InvalidApprover(address)\":[{\"details\":\"Indicates a failure with the `approver` of a token to be approved. Used in approvals.\",\"params\":{\"approver\":\"Address initiating an approval operation.\"}}],\"ERC721InvalidOperator(address)\":[{\"details\":\"Indicates a failure with the `operator` to be approved. Used in approvals.\",\"params\":{\"operator\":\"Address that may be allowed to operate on tokens without being their owner.\"}}],\"ERC721InvalidOwner(address)\":[{\"details\":\"Indicates that an address can't be an owner. For example, `address(0)` is a forbidden owner in ERC-721. Used in balance queries.\",\"params\":{\"owner\":\"Address of the current owner of a token.\"}}],\"ERC721InvalidReceiver(address)\":[{\"details\":\"Indicates a failure with the token `receiver`. Used in transfers.\",\"params\":{\"receiver\":\"Address to which tokens are being transferred.\"}}],\"ERC721InvalidSender(address)\":[{\"details\":\"Indicates a failure with the token `sender`. Used in transfers.\",\"params\":{\"sender\":\"Address whose tokens are being transferred.\"}}],\"ERC721NonexistentToken(uint256)\":[{\"details\":\"Indicates a `tokenId` whose `owner` is the zero address.\",\"params\":{\"tokenId\":\"Identifier number of a token.\"}}],\"OwnableInvalidOwner(address)\":[{\"details\":\"The owner is not a valid owner account. (eg. `address(0)`)\"}],\"OwnableUnauthorizedAccount(address)\":[{\"details\":\"The caller account is not authorized to perform an operation.\"}],\"ReentrancyGuardReentrantCall()\":[{\"details\":\"Unauthorized reentrant call.\"}]},\"events\":{\"Approval(address,address,uint256)\":{\"details\":\"Emitted when `owner` enables `approved` to manage the `tokenId` token.\"},\"ApprovalForAll(address,address,bool)\":{\"details\":\"Emitted when `owner` enables or disables (`approved`) `operator` to manage all of its assets.\"},\"Transfer(address,address,uint256)\":{\"details\":\"Emitted when `tokenId` token is transferred from `from` to `to`.\"}},\"kind\":\"dev\",\"methods\":{\"approve(address,uint256)\":{\"details\":\"Gives permission to `to` to transfer `tokenId` token to another account. The approval is cleared when the token is transferred. Only a single account can be approved at a time, so approving the zero address clears previous approvals. Requirements: - The caller must own the token or be an approved operator. - `tokenId` must exist. Emits an {Approval} event.\"},\"balanceOf(address)\":{\"details\":\"Returns the number of tokens in ``owner``'s account.\"},\"getApproved(uint256)\":{\"details\":\"Returns the account approved for `tokenId` token. Requirements: - `tokenId` must exist.\"},\"isApprovedForAll(address,address)\":{\"details\":\"Returns if the `operator` is allowed to manage all of the assets of `owner`. See {setApprovalForAll}\"},\"name()\":{\"details\":\"Returns the token collection name.\"},\"owner()\":{\"details\":\"Returns the address of the current owner.\"},\"ownerOf(uint256)\":{\"details\":\"Returns the owner of the `tokenId` token. Requirements: - `tokenId` must exist.\"},\"purchaseProperty(uint8,uint256,uint256)\":{\"params\":{\"propertyType\":\"The type of property to purchase\",\"value\":\"The property value (used for yield calculation)\",\"yieldRate\":\"The yield rate in basis points (e.g., 500 = 5%)\"}},\"renounceOwnership()\":{\"details\":\"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner.\"},\"safeTransferFrom(address,address,uint256)\":{\"details\":\"Safely transfers `tokenId` token from `from` to `to`, checking first that contract recipients are aware of the ERC-721 protocol to prevent tokens from being forever locked. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must exist and be owned by `from`. - If the caller is not `from`, it must have been allowed to move this token by either {approve} or   {setApprovalForAll}. - If `to` refers to a smart contract, it must implement {IERC721Receiver-onERC721Received}, which is called upon   a safe transfer. Emits a {Transfer} event.\"},\"safeTransferFrom(address,address,uint256,bytes)\":{\"details\":\"Safely transfers `tokenId` token from `from` to `to`. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must exist and be owned by `from`. - If the caller is not `from`, it must be approved to move this token by either {approve} or {setApprovalForAll}. - If `to` refers to a smart contract, it must implement {IERC721Receiver-onERC721Received}, which is called upon   a safe transfer. Emits a {Transfer} event.\"},\"setApprovalForAll(address,bool)\":{\"details\":\"Approve or remove `operator` as an operator for the caller. Operators can call {transferFrom} or {safeTransferFrom} for any token owned by the caller. Requirements: - The `operator` cannot be the address zero. Emits an {ApprovalForAll} event.\"},\"setGameToken(address)\":{\"details\":\"Only owner can call this - allows updating existing contract\"},\"supportsInterface(bytes4)\":{\"details\":\"Returns true if this contract implements the interface defined by `interfaceId`. See the corresponding https://eips.ethereum.org/EIPS/eip-165#how-interfaces-are-identified[ERC section] to learn more about how these ids are created. This function call must use less than 30 000 gas.\"},\"symbol()\":{\"details\":\"Returns the token collection symbol.\"},\"tokenURI(uint256)\":{\"details\":\"Returns the Uniform Resource Identifier (URI) for `tokenId` token.\"},\"transferFrom(address,address,uint256)\":{\"details\":\"Transfers `tokenId` token from `from` to `to`. WARNING: Note that the caller is responsible to confirm that the recipient is capable of receiving ERC-721 or else they may be permanently lost. Usage of {safeTransferFrom} prevents loss, though the caller must understand this adds an external call which potentially creates a reentrancy vulnerability. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must be owned by `from`. - If the caller is not `from`, it must be approved to move this token by either {approve} or {setApprovalForAll}. Emits a {Transfer} event.\"},\"transferOwnership(address)\":{\"details\":\"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner.\"}},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{\"purchaseProperty(uint8,uint256,uint256)\":{\"notice\":\"Purchase and mint a property by paying TYCOON tokens\"},\"setGameToken(address)\":{\"notice\":\"Set the game token address (for existing deployments)\"},\"withdrawTokens()\":{\"notice\":\"Owner can withdraw TYCOON tokens collected from property purchases\"}},\"version\":1}},\"settings\":{\"compilationTarget\":{\"src/PropertyNFT.sol\":\"PropertyNFT\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":true,\"runs\":200},\"remappings\":[\":@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/\",\":erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/\",\":forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/\",\":halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/\",\":openzeppelin-contracts/=lib/openzeppelin-contracts/\"]},\"sources\":{\"lib/openzeppelin-contracts/contracts/access/Ownable.sol\":{\"keccak256\":\"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6\",\"dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a\"]},\"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol\":{\"keccak256\":\"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c\",\"dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\":{\"keccak256\":\"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303\",\"dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol\":{\"keccak256\":\"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b\",\"dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol\":{\"keccak256\":\"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3\",\"dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol\":{\"keccak256\":\"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e\",\"dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol\":{\"keccak256\":\"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e\",\"dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol\":{\"keccak256\":\"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435\",\"dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6\"]},\"lib/openzeppelin-contracts/contracts/utils/Bytes.sol\":{\"keccak256\":\"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147\",\"dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR\"]},\"lib/openzeppelin-contracts/contracts/utils/Context.sol\":{\"keccak256\":\"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12\",\"dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF\"]},\"lib/openzeppelin-contracts/contracts/utils/Panic.sol\":{\"keccak256\":\"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a\",\"dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG\"]},\"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol\":{\"keccak256\":\"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99\",\"dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N\"]},\"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol\":{\"keccak256\":\"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b\",\"dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM\"]},\"lib/openzeppelin-contracts/contracts/utils/Strings.sol\":{\"keccak256\":\"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a\",\"dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol\":{\"keccak256\":\"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377\",\"dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol\":{\"keccak256\":\"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617\",\"dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u\"]},\"lib/openzeppelin-contracts/contracts/utils/math/Math.sol\":{\"keccak256\":\"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c\",\"dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol\":{\"keccak256\":\"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8\",\"dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol\":{\"keccak256\":\"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03\",\"dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ\"]},\"src/PropertyNFT.sol\":{\"keccak256\":\"0x48a2b49e2339638970b9ddd5673ccb1e070dc627bccdf970d7bf08f52385c588\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://dd99a2ac850b965991210a954b15d6b28782345a083baff6b69532e1de8216a2\",\"dweb:/ipfs/QmeNkvV9P8nqLXCp6rft5pZ7KnCbNdhvE56PU44Qd9NZcu\"]}},\"version\":1}","metadata":{"compiler":{"version":"0.8.24+commit.e11b9ed9"},"language":"Solidity","output":{"abi":[{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"ERC721IncorrectOwner"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"type":"error","name":"ERC721InsufficientApproval"},{"inputs":[{"internalType":"address","name":"approver","type":"address"}],"type":"error","name":"ERC721InvalidApprover"},{"inputs":[{"internalType":"address","name":"operator","type":"address"}],"type":"error","name":"ERC721InvalidOperator"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"ERC721InvalidOwner"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"type":"error","name":"ERC721InvalidReceiver"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"type":"error","name":"ERC721InvalidSender"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"type":"error","name":"ERC721NonexistentToken"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"OwnableInvalidOwner"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"type":"error","name":"OwnableUnauthorizedAccount"},{"inputs":[],"type":"error","name":"ReentrancyGuardReentrantCall"},{"inputs":[{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"address","name":"approved","type":"address","indexed":true},{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true}],"type":"event","name":"Approval","anonymous":false},{"inputs":[{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"address","name":"operator","type":"address","indexed":true},{"internalType":"bool","name":"approved","type":"bool","indexed":false}],"type":"event","name":"ApprovalForAll","anonymous":false},{"inputs":[{"internalType":"address","name":"previousOwner","type":"address","indexed":true},{"internalType":"address","name":"newOwner","type":"address","indexed":true}],"type":"event","name":"OwnershipTransferred","anonymous":false},{"inputs":[{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"uint256[]","name":"tokenIds","type":"uint256[]","indexed":false}],"type":"event","name":"PropertiesBatchMinted","anonymous":false},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true},{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8","indexed":false},{"internalType":"uint256","name":"value","type":"uint256","indexed":false}],"type":"event","name":"PropertyCreated","anonymous":false},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true},{"internalType":"address","name":"rwaContract","type":"address","indexed":false},{"internalType":"uint256","name":"rwaTokenId","type":"uint256","indexed":false}],"type":"event","name":"PropertyLinkedToRWA","anonymous":false},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true},{"internalType":"address","name":"buyer","type":"address","indexed":true},{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8","indexed":false},{"internalType":"uint256","name":"cost","type":"uint256","indexed":false}],"type":"event","name":"PropertyPurchased","anonymous":false},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true},{"internalType":"enum PropertyNFT.PropertyType","name":"newType","type":"uint8","indexed":false},{"internalType":"uint256","name":"newValue","type":"uint256","indexed":false}],"type":"event","name":"PropertyUpgraded","anonymous":false},{"inputs":[{"internalType":"address","name":"from","type":"address","indexed":true},{"internalType":"address","name":"to","type":"address","indexed":true},{"internalType":"uint256","name":"tokenId","type":"uint256","indexed":true}],"type":"event","name":"Transfer","anonymous":false},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"approve"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function","name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"enum PropertyNFT.PropertyType[]","name":"propertyTypes","type":"uint8[]"},{"internalType":"uint256[]","name":"values","type":"uint256[]"},{"internalType":"uint256[]","name":"yieldRates","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function","name":"batchMintProperties","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"gameToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"view","type":"function","name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function","name":"getOwnerProperties","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}]},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function","name":"getOwnerPropertyCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"view","type":"function","name":"getProperty","outputs":[{"internalType":"struct PropertyNFT.Property","name":"","type":"tuple","components":[{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"uint256","name":"yieldRate","type":"uint256"},{"internalType":"address","name":"rwaContract","type":"address"},{"internalType":"uint256","name":"rwaTokenId","type":"uint256"},{"internalType":"uint256","name":"totalYieldEarned","type":"uint256"},{"internalType":"uint256","name":"createdAt","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}]}]},{"inputs":[{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8"}],"stateMutability":"view","type":"function","name":"getPropertyTypeCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"stateMutability":"view","type":"function","name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}]},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"rwaContract","type":"address"},{"internalType":"uint256","name":"rwaTokenId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"linkToRWA"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"uint256","name":"yieldRate","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"mintProperty","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"name","outputs":[{"internalType":"string","name":"","type":"string"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"view","type":"function","name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"ownerProperties","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"properties","outputs":[{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"uint256","name":"yieldRate","type":"uint256"},{"internalType":"address","name":"rwaContract","type":"address"},{"internalType":"uint256","name":"rwaTokenId","type":"uint256"},{"internalType":"uint256","name":"totalYieldEarned","type":"uint256"},{"internalType":"uint256","name":"createdAt","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}]},{"inputs":[{"internalType":"enum PropertyNFT.PropertyType","name":"","type":"uint8"}],"stateMutability":"view","type":"function","name":"propertyCosts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"enum PropertyNFT.PropertyType","name":"","type":"uint8"}],"stateMutability":"view","type":"function","name":"propertyTypeCounts","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"enum PropertyNFT.PropertyType","name":"propertyType","type":"uint8"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"uint256","name":"yieldRate","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"purchaseProperty","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"renounceOwnership"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"safeTransferFrom"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"stateMutability":"nonpayable","type":"function","name":"safeTransferFrom"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"stateMutability":"nonpayable","type":"function","name":"setApprovalForAll"},{"inputs":[{"internalType":"address","name":"_gameToken","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"setGameToken"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"stateMutability":"view","type":"function","name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}]},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"view","type":"function","name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}]},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"transferFrom"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"transferOwnership"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"enum PropertyNFT.PropertyType","name":"newType","type":"uint8"},{"internalType":"uint256","name":"newValue","type":"uint256"},{"internalType":"uint256","name":"newYieldRate","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"upgradeProperty"},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"withdrawTokens"}],"devdoc":{"kind":"dev","methods":{"approve(address,uint256)":{"details":"Gives permission to `to` to transfer `tokenId` token to another account. The approval is cleared when the token is transferred. Only a single account can be approved at a time, so approving the zero address clears previous approvals. Requirements: - The caller must own the token or be an approved operator. - `tokenId` must exist. Emits an {Approval} event."},"balanceOf(address)":{"details":"Returns the number of tokens in ``owner``'s account."},"getApproved(uint256)":{"details":"Returns the account approved for `tokenId` token. Requirements: - `tokenId` must exist."},"isApprovedForAll(address,address)":{"details":"Returns if the `operator` is allowed to manage all of the assets of `owner`. See {setApprovalForAll}"},"name()":{"details":"Returns the token collection name."},"owner()":{"details":"Returns the address of the current owner."},"ownerOf(uint256)":{"details":"Returns the owner of the `tokenId` token. Requirements: - `tokenId` must exist."},"purchaseProperty(uint8,uint256,uint256)":{"params":{"propertyType":"The type of property to purchase","value":"The property value (used for yield calculation)","yieldRate":"The yield rate in basis points (e.g., 500 = 5%)"}},"renounceOwnership()":{"details":"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner."},"safeTransferFrom(address,address,uint256)":{"details":"Safely transfers `tokenId` token from `from` to `to`, checking first that contract recipients are aware of the ERC-721 protocol to prevent tokens from being forever locked. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must exist and be owned by `from`. - If the caller is not `from`, it must have been allowed to move this token by either {approve} or   {setApprovalForAll}. - If `to` refers to a smart contract, it must implement {IERC721Receiver-onERC721Received}, which is called upon   a safe transfer. Emits a {Transfer} event."},"safeTransferFrom(address,address,uint256,bytes)":{"details":"Safely transfers `tokenId` token from `from` to `to`. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must exist and be owned by `from`. - If the caller is not `from`, it must be approved to move this token by either {approve} or {setApprovalForAll}. - If `to` refers to a smart contract, it must implement {IERC721Receiver-onERC721Received}, which is called upon   a safe transfer. Emits a {Transfer} event."},"setApprovalForAll(address,bool)":{"details":"Approve or remove `operator` as an operator for the caller. Operators can call {transferFrom} or {safeTransferFrom} for any token owned by the caller. Requirements: - The `operator` cannot be the address zero. Emits an {ApprovalForAll} event."},"setGameToken(address)":{"details":"Only owner can call this - allows updating existing contract"},"supportsInterface(bytes4)":{"details":"Returns true if this contract implements the interface defined by `interfaceId`. See the corresponding https://eips.ethereum.org/EIPS/eip-165#how-interfaces-are-identified[ERC section] to learn more about how these ids are created. This function call must use less than 30 000 gas."},"symbol()":{"details":"Returns the token collection symbol."},"tokenURI(uint256)":{"details":"Returns the Uniform Resource Identifier (URI) for `tokenId` token."},"transferFrom(address,address,uint256)":{"details":"Transfers `tokenId` token from `from` to `to`. WARNING: Note that the caller is responsible to confirm that the recipient is capable of receiving ERC-721 or else they may be permanently lost. Usage of {safeTransferFrom} prevents loss, though the caller must understand this adds an external call which potentially creates a reentrancy vulnerability. Requirements: - `from` cannot be the zero address. - `to` cannot be the zero address. - `tokenId` token must be owned by `from`. - If the caller is not `from`, it must be approved to move this token by either {approve} or {setApprovalForAll}. Emits a {Transfer} event."},"transferOwnership(address)":{"details":"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner."}},"version":1},"userdoc":{"kind":"user","methods":{"purchaseProperty(uint8,uint256,uint256)":{"notice":"Purchase and mint a property by paying TYCOON tokens"},"setGameToken(address)":{"notice":"Set the game token address (for existing deployments)"},"withdrawTokens()":{"notice":"Owner can withdraw TYCOON tokens collected from property purchases"}},"version":1}},"settings":{"remappings":["@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/","erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/","forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/","halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/","openzeppelin-contracts/=lib/openzeppelin-contracts/"],"optimizer":{"enabled":true,"runs":200},"metadata":{"bytecodeHash":"ipfs"},"compilationTarget":{"src/PropertyNFT.sol":"PropertyNFT"},"evmVersion":"cancun","libraries":{}},"sources":{"lib/openzeppelin-contracts/contracts/access/Ownable.sol":{"keccak256":"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb","urls":["bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6","dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol":{"keccak256":"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998","urls":["bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c","dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol":{"keccak256":"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2","urls":["bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303","dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol":{"keccak256":"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039","urls":["bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b","dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol":{"keccak256":"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f","urls":["bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3","dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol":{"keccak256":"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055","urls":["bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e","dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol":{"keccak256":"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76","urls":["bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e","dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol":{"keccak256":"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd","urls":["bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435","dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Bytes.sol":{"keccak256":"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33","urls":["bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147","dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Context.sol":{"keccak256":"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2","urls":["bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12","dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Panic.sol":{"keccak256":"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a","urls":["bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a","dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol":{"keccak256":"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53","urls":["bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99","dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol":{"keccak256":"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97","urls":["bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b","dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Strings.sol":{"keccak256":"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a","urls":["bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a","dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol":{"keccak256":"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e","urls":["bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377","dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol":{"keccak256":"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c","urls":["bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617","dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/Math.sol":{"keccak256":"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c","urls":["bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c","dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol":{"keccak256":"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54","urls":["bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8","dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol":{"keccak256":"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3","urls":["bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03","dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ"],"license":"MIT"},"src/PropertyNFT.sol":{"keccak256":"0x48a2b49e2339638970b9ddd5673ccb1e070dc627bccdf970d7bf08f52385c588","urls":["bzz-raw://dd99a2ac850b965991210a954b15d6b28782345a083baff6b69532e1de8216a2","dweb:/ipfs/QmeNkvV9P8nqLXCp6rft5pZ7KnCbNdhvE56PU44Qd9NZcu"],"license":"MIT"}},"version":1},"id":52}
</file>

<file path="backend/src/contracts/abis/YieldDistributor.json">
{"abi":[{"type":"constructor","inputs":[{"name":"_propertyNFT","type":"address","internalType":"address"},{"name":"_gameToken","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"YIELD_UPDATE_INTERVAL","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"batchClaimYield","inputs":[{"name":"propertyIds","type":"uint256[]","internalType":"uint256[]"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"batchDistributeYield","inputs":[{"name":"propertyIds","type":"uint256[]","internalType":"uint256[]"},{"name":"amounts","type":"uint256[]","internalType":"uint256[]"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"calculateYield","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"claimYield","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"distributeYield","inputs":[{"name":"propertyId","type":"uint256","internalType":"uint256"},{"name":"amount","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"gameToken","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract GameToken"}],"stateMutability":"view"},{"type":"function","name":"getTotalPendingYield","inputs":[{"name":"owner","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"lastYieldUpdate","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"pendingYield","inputs":[{"name":"","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"propertyNFT","inputs":[],"outputs":[{"name":"","type":"address","internalType":"contract PropertyNFT"}],"stateMutability":"view"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"totalYieldClaimed","inputs":[{"name":"","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"BatchYieldClaimed","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"propertyIds","type":"uint256[]","indexed":false,"internalType":"uint256[]"},{"name":"totalAmount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"BatchYieldDistributed","inputs":[{"name":"propertyIds","type":"uint256[]","indexed":false,"internalType":"uint256[]"},{"name":"amounts","type":"uint256[]","indexed":false,"internalType":"uint256[]"}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"YieldClaimed","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"YieldDistributed","inputs":[{"name":"propertyId","type":"uint256","indexed":true,"internalType":"uint256"},{"name":"amount","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]},{"type":"error","name":"ReentrancyGuardReentrantCall","inputs":[]}],"bytecode":{"object":"0x608060405234801561000f575f80fd5b5060405161128638038061128683398101604081905261002e9161011c565b60017f9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f0055338061007757604051631e4fbdf760e01b81525f600482015260240160405180910390fd5b610080816100b2565b50600180546001600160a01b039384166001600160a01b0319918216179091556002805492909316911617905561014d565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b80516001600160a01b0381168114610117575f80fd5b919050565b5f806040838503121561012d575f80fd5b61013683610101565b915061014460208401610101565b90509250929050565b61112c8061015a5f395ff3fe608060405234801561000f575f80fd5b50600436106100f0575f3560e01c80637cf6384711610093578063d7c436d311610063578063d7c436d314610208578063eb197bee1461021b578063f007e9d514610225578063f2fde38b14610238575f80fd5b80637cf63847146101b357806380a3301b146101d25780638da5cb5b146101e5578063c3dfdae6146101f5575f80fd5b806340bd2e23116100ce57806340bd2e23146101665780634bf0c1fd146101795780635fec8c8c1461018c578063715018a6146101ab575f80fd5b806306ac7aed146100f45780631f45e11f1461012657806337f768381461013b575b5f80fd5b610113610102366004610cbc565b60046020525f908152604090205481565b6040519081526020015b60405180910390f35b610139610134366004610d26565b61024b565b005b60015461014e906001600160a01b031681565b6040516001600160a01b03909116815260200161011d565b610139610174366004610d8d565b6103e3565b610113610187366004610cbc565b6105d3565b61011361019a366004610d8d565b60056020525f908152604090205481565b610139610690565b6101136101c1366004610d8d565b60036020525f908152604090205481565b6101136101e0366004610d8d565b6106a3565b5f546001600160a01b031661014e565b60025461014e906001600160a01b031681565b610139610216366004610da4565b610804565b6101136201518081565b610139610233366004610de3565b610af7565b610139610246366004610cbc565b610ba9565b8281146102975760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b60448201526064015b60405180910390fd5b82158015906102a7575060648311155b6102e85760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b604482015260640161028e565b5f5b8381101561039f575f83838381811061030557610305610e03565b9050602002013511156103975782828281811061032457610324610e03565b9050602002013560035f87878581811061034057610340610e03565b9050602002013581526020019081526020015f205f8282546103629190610e2b565b9091555042905060055f87878581811061037e5761037e610e03565b9050602002013581526020019081526020015f20819055505b6001016102ea565b507f97bb4e35fdf04af0222059338d39fbc34c217a08ffca26c9bd18d5030e6e537b848484846040516103d59493929190610e74565b60405180910390a150505050565b6103eb610be3565b6001546040516331a9108f60e11b81526004810183905233916001600160a01b031690636352211e90602401602060405180830381865afa158015610432573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104569190610eaa565b6001600160a01b0316146104985760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b604482015260640161028e565b5f6104a2826106a3565b90505f81116104e75760405162461bcd60e51b81526020600482015260116024820152704e6f207969656c6420746f20636c61696d60781b604482015260640161028e565b5f8281526003602090815260408083208390556005825280832042905533835260049091528120805483929061051e908490610e2b565b90915550506002546040516340c10f1960e01b8152336004820152602481018390526001600160a01b03909116906340c10f19906044015f604051808303815f87803b15801561056c575f80fd5b505af115801561057e573d5f803e3d5ffd5b50506040518381523392508491507f1448cb68839238fd008abe5bad73d996f9849e020313466fa9f3476d98006df29060200160405180910390a3506105d060015f805160206110d783398151915255565b50565b60015460405163cb64489760e01b81526001600160a01b0383811660048301525f92839291169063cb644897906024015f60405180830381865afa15801561061d573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526106449190810190610f34565b90505f805b82518110156106885761067483828151811061066757610667610e03565b60200260200101516106a3565b61067e9083610e2b565b9150600101610649565b509392505050565b610698610bfe565b6106a15f610c2a565b565b6001546040516332665ffb60e01b8152600481018390525f9182916001600160a01b03909116906332665ffb9060240161010060405180830381865afa1580156106ef573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107139190610fe4565b905080602001515f148061072957506040810151155b1561073657505f92915050565b5f8381526005602052604081205490819003610753575060c08101515b5f61075e824261106a565b90506301e1338081111561077357506301e133805b62015180811015610793575050505f918252506003602052604090205490565b5f6237b1d0846040015185602001516107ac919061107d565b6107b69190611094565b90505f6107c66201518084611094565b905061016d8111156107d7575061016d5b6107e1818361107d565b5f888152600360205260409020546107f99190610e2b565b979650505050505050565b61080c610be3565b801580159061081c575060328111155b61085d5760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b604482015260640161028e565b5f805b828110156109d15760015433906001600160a01b0316636352211e86868581811061088d5761088d610e03565b905060200201356040518263ffffffff1660e01b81526004016108b291815260200190565b602060405180830381865afa1580156108cd573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108f19190610eaa565b6001600160a01b0316146109335760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b604482015260640161028e565b5f61095585858481811061094957610949610e03565b905060200201356106a3565b905080156109c8575f60035f87878681811061097357610973610e03565b9050602002013581526020019081526020015f20819055504260055f8787868181106109a1576109a1610e03565b9050602002013581526020019081526020015f208190555080836109c59190610e2b565b92505b50600101610860565b505f8111610a155760405162461bcd60e51b81526020600482015260116024820152704e6f207969656c6420746f20636c61696d60781b604482015260640161028e565b335f9081526004602052604081208054839290610a33908490610e2b565b90915550506002546040516340c10f1960e01b8152336004820152602481018390526001600160a01b03909116906340c10f19906044015f604051808303815f87803b158015610a81575f80fd5b505af1158015610a93573d5f803e3d5ffd5b50505050336001600160a01b03167f342420ff203c68b5830392178aa75b5ba464e922f1148dc30c1b6107f69b4980848484604051610ad4939291906110b3565b60405180910390a250610af360015f805160206110d783398151915255565b5050565b5f8111610b375760405162461bcd60e51b815260206004820152600e60248201526d125b9d985b1a5908185b5bdd5b9d60921b604482015260640161028e565b5f8281526003602052604081208054839290610b54908490610e2b565b90915550505f82815260056020526040908190204290555182907ffe4996cd48c364c468cee70dd6b9061874ff01b05c5ea49311cbcabd9b9cb61590610b9d9084815260200190565b60405180910390a25050565b610bb1610bfe565b6001600160a01b038116610bda57604051631e4fbdf760e01b81525f600482015260240161028e565b6105d081610c2a565b610beb610c79565b60025f805160206110d783398151915255565b5f546001600160a01b031633146106a15760405163118cdaa760e01b815233600482015260240161028e565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f805160206110d7833981519152546002036106a157604051633ee5aeb560e01b815260040160405180910390fd5b6001600160a01b03811681146105d0575f80fd5b5f60208284031215610ccc575f80fd5b8135610cd781610ca8565b9392505050565b5f8083601f840112610cee575f80fd5b50813567ffffffffffffffff811115610d05575f80fd5b6020830191508360208260051b8501011115610d1f575f80fd5b9250929050565b5f805f8060408587031215610d39575f80fd5b843567ffffffffffffffff80821115610d50575f80fd5b610d5c88838901610cde565b90965094506020870135915080821115610d74575f80fd5b50610d8187828801610cde565b95989497509550505050565b5f60208284031215610d9d575f80fd5b5035919050565b5f8060208385031215610db5575f80fd5b823567ffffffffffffffff811115610dcb575f80fd5b610dd785828601610cde565b90969095509350505050565b5f8060408385031215610df4575f80fd5b50508035926020909101359150565b634e487b7160e01b5f52603260045260245ffd5b634e487b7160e01b5f52601160045260245ffd5b80820180821115610e3e57610e3e610e17565b92915050565b8183525f6001600160fb1b03831115610e5b575f80fd5b8260051b80836020870137939093016020019392505050565b604081525f610e87604083018688610e44565b82810360208401526107f9818587610e44565b8051610ea581610ca8565b919050565b5f60208284031215610eba575f80fd5b8151610cd781610ca8565b634e487b7160e01b5f52604160045260245ffd5b604051610100810167ffffffffffffffff81118282101715610efd57610efd610ec5565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610f2c57610f2c610ec5565b604052919050565b5f6020808385031215610f45575f80fd5b825167ffffffffffffffff80821115610f5c575f80fd5b818501915085601f830112610f6f575f80fd5b815181811115610f8157610f81610ec5565b8060051b9150610f92848301610f03565b8181529183018401918481019088841115610fab575f80fd5b938501935b83851015610fc957845182529385019390850190610fb0565b98975050505050505050565b80518015158114610ea5575f80fd5b5f6101008284031215610ff5575f80fd5b610ffd610ed9565b82516004811061100b575f80fd5b80825250602083015160208201526040830151604082015261102f60608401610e9a565b60608201526080830151608082015260a083015160a082015260c083015160c082015261105e60e08401610fd5565b60e08201529392505050565b81810381811115610e3e57610e3e610e17565b8082028115828204841417610e3e57610e3e610e17565b5f826110ae57634e487b7160e01b5f52601260045260245ffd5b500490565b604081525f6110c6604083018587610e44565b905082602083015294935050505056fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a264697066735822122095eb068a43097a361b7fd785af239c727838fd38be5829758ac5291d214a08c164736f6c63430008180033","sourceMap":"226:5241:55:-:0;;;935:173;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;2365:1:13;1505:66;2539;997:10:55;;1269:95:0;;1322:31;;-1:-1:-1;;;1322:31:0;;1350:1;1322:31;;;640:51:57;613:18;;1322:31:0;;;;;;;1269:95;1373:32;1392:12;1373:18;:32::i;:::-;-1:-1:-1;1019:11:55::1;:39:::0;;-1:-1:-1;;;;;1019:39:55;;::::1;-1:-1:-1::0;;;;;;1019:39:55;;::::1;;::::0;;;1068:9:::1;:33:::0;;;;;::::1;::::0;::::1;;::::0;;226:5241;;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;14:177:57:-;93:13;;-1:-1:-1;;;;;135:31:57;;125:42;;115:70;;181:1;178;171:12;115:70;14:177;;;:::o;196:293::-;275:6;283;336:2;324:9;315:7;311:23;307:32;304:52;;;352:1;349;342:12;304:52;375:40;405:9;375:40;:::i;:::-;365:50;;434:49;479:2;468:9;464:18;434:49;:::i;:::-;424:59;;196:293;;;;;:::o;494:203::-;226:5241:55;;;;;;","linkReferences":{}},"deployedBytecode":{"object":"0x608060405234801561000f575f80fd5b50600436106100f0575f3560e01c80637cf6384711610093578063d7c436d311610063578063d7c436d314610208578063eb197bee1461021b578063f007e9d514610225578063f2fde38b14610238575f80fd5b80637cf63847146101b357806380a3301b146101d25780638da5cb5b146101e5578063c3dfdae6146101f5575f80fd5b806340bd2e23116100ce57806340bd2e23146101665780634bf0c1fd146101795780635fec8c8c1461018c578063715018a6146101ab575f80fd5b806306ac7aed146100f45780631f45e11f1461012657806337f768381461013b575b5f80fd5b610113610102366004610cbc565b60046020525f908152604090205481565b6040519081526020015b60405180910390f35b610139610134366004610d26565b61024b565b005b60015461014e906001600160a01b031681565b6040516001600160a01b03909116815260200161011d565b610139610174366004610d8d565b6103e3565b610113610187366004610cbc565b6105d3565b61011361019a366004610d8d565b60056020525f908152604090205481565b610139610690565b6101136101c1366004610d8d565b60036020525f908152604090205481565b6101136101e0366004610d8d565b6106a3565b5f546001600160a01b031661014e565b60025461014e906001600160a01b031681565b610139610216366004610da4565b610804565b6101136201518081565b610139610233366004610de3565b610af7565b610139610246366004610cbc565b610ba9565b8281146102975760405162461bcd60e51b8152602060048201526015602482015274082e4e4c2f240d8cadccee8d040dad2e6dac2e8c6d605b1b60448201526064015b60405180910390fd5b82158015906102a7575060648311155b6102e85760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b604482015260640161028e565b5f5b8381101561039f575f83838381811061030557610305610e03565b9050602002013511156103975782828281811061032457610324610e03565b9050602002013560035f87878581811061034057610340610e03565b9050602002013581526020019081526020015f205f8282546103629190610e2b565b9091555042905060055f87878581811061037e5761037e610e03565b9050602002013581526020019081526020015f20819055505b6001016102ea565b507f97bb4e35fdf04af0222059338d39fbc34c217a08ffca26c9bd18d5030e6e537b848484846040516103d59493929190610e74565b60405180910390a150505050565b6103eb610be3565b6001546040516331a9108f60e11b81526004810183905233916001600160a01b031690636352211e90602401602060405180830381865afa158015610432573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104569190610eaa565b6001600160a01b0316146104985760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b604482015260640161028e565b5f6104a2826106a3565b90505f81116104e75760405162461bcd60e51b81526020600482015260116024820152704e6f207969656c6420746f20636c61696d60781b604482015260640161028e565b5f8281526003602090815260408083208390556005825280832042905533835260049091528120805483929061051e908490610e2b565b90915550506002546040516340c10f1960e01b8152336004820152602481018390526001600160a01b03909116906340c10f19906044015f604051808303815f87803b15801561056c575f80fd5b505af115801561057e573d5f803e3d5ffd5b50506040518381523392508491507f1448cb68839238fd008abe5bad73d996f9849e020313466fa9f3476d98006df29060200160405180910390a3506105d060015f805160206110d783398151915255565b50565b60015460405163cb64489760e01b81526001600160a01b0383811660048301525f92839291169063cb644897906024015f60405180830381865afa15801561061d573d5f803e3d5ffd5b505050506040513d5f823e601f3d908101601f191682016040526106449190810190610f34565b90505f805b82518110156106885761067483828151811061066757610667610e03565b60200260200101516106a3565b61067e9083610e2b565b9150600101610649565b509392505050565b610698610bfe565b6106a15f610c2a565b565b6001546040516332665ffb60e01b8152600481018390525f9182916001600160a01b03909116906332665ffb9060240161010060405180830381865afa1580156106ef573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107139190610fe4565b905080602001515f148061072957506040810151155b1561073657505f92915050565b5f8381526005602052604081205490819003610753575060c08101515b5f61075e824261106a565b90506301e1338081111561077357506301e133805b62015180811015610793575050505f918252506003602052604090205490565b5f6237b1d0846040015185602001516107ac919061107d565b6107b69190611094565b90505f6107c66201518084611094565b905061016d8111156107d7575061016d5b6107e1818361107d565b5f888152600360205260409020546107f99190610e2b565b979650505050505050565b61080c610be3565b801580159061081c575060328111155b61085d5760405162461bcd60e51b8152602060048201526012602482015271496e76616c69642062617463682073697a6560701b604482015260640161028e565b5f805b828110156109d15760015433906001600160a01b0316636352211e86868581811061088d5761088d610e03565b905060200201356040518263ffffffff1660e01b81526004016108b291815260200190565b602060405180830381865afa1580156108cd573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906108f19190610eaa565b6001600160a01b0316146109335760405162461bcd60e51b81526020600482015260096024820152682737ba1037bbb732b960b91b604482015260640161028e565b5f61095585858481811061094957610949610e03565b905060200201356106a3565b905080156109c8575f60035f87878681811061097357610973610e03565b9050602002013581526020019081526020015f20819055504260055f8787868181106109a1576109a1610e03565b9050602002013581526020019081526020015f208190555080836109c59190610e2b565b92505b50600101610860565b505f8111610a155760405162461bcd60e51b81526020600482015260116024820152704e6f207969656c6420746f20636c61696d60781b604482015260640161028e565b335f9081526004602052604081208054839290610a33908490610e2b565b90915550506002546040516340c10f1960e01b8152336004820152602481018390526001600160a01b03909116906340c10f19906044015f604051808303815f87803b158015610a81575f80fd5b505af1158015610a93573d5f803e3d5ffd5b50505050336001600160a01b03167f342420ff203c68b5830392178aa75b5ba464e922f1148dc30c1b6107f69b4980848484604051610ad4939291906110b3565b60405180910390a250610af360015f805160206110d783398151915255565b5050565b5f8111610b375760405162461bcd60e51b815260206004820152600e60248201526d125b9d985b1a5908185b5bdd5b9d60921b604482015260640161028e565b5f8281526003602052604081208054839290610b54908490610e2b565b90915550505f82815260056020526040908190204290555182907ffe4996cd48c364c468cee70dd6b9061874ff01b05c5ea49311cbcabd9b9cb61590610b9d9084815260200190565b60405180910390a25050565b610bb1610bfe565b6001600160a01b038116610bda57604051631e4fbdf760e01b81525f600482015260240161028e565b6105d081610c2a565b610beb610c79565b60025f805160206110d783398151915255565b5f546001600160a01b031633146106a15760405163118cdaa760e01b815233600482015260240161028e565b5f80546001600160a01b038381166001600160a01b0319831681178455604051919092169283917f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e09190a35050565b5f805160206110d7833981519152546002036106a157604051633ee5aeb560e01b815260040160405180910390fd5b6001600160a01b03811681146105d0575f80fd5b5f60208284031215610ccc575f80fd5b8135610cd781610ca8565b9392505050565b5f8083601f840112610cee575f80fd5b50813567ffffffffffffffff811115610d05575f80fd5b6020830191508360208260051b8501011115610d1f575f80fd5b9250929050565b5f805f8060408587031215610d39575f80fd5b843567ffffffffffffffff80821115610d50575f80fd5b610d5c88838901610cde565b90965094506020870135915080821115610d74575f80fd5b50610d8187828801610cde565b95989497509550505050565b5f60208284031215610d9d575f80fd5b5035919050565b5f8060208385031215610db5575f80fd5b823567ffffffffffffffff811115610dcb575f80fd5b610dd785828601610cde565b90969095509350505050565b5f8060408385031215610df4575f80fd5b50508035926020909101359150565b634e487b7160e01b5f52603260045260245ffd5b634e487b7160e01b5f52601160045260245ffd5b80820180821115610e3e57610e3e610e17565b92915050565b8183525f6001600160fb1b03831115610e5b575f80fd5b8260051b80836020870137939093016020019392505050565b604081525f610e87604083018688610e44565b82810360208401526107f9818587610e44565b8051610ea581610ca8565b919050565b5f60208284031215610eba575f80fd5b8151610cd781610ca8565b634e487b7160e01b5f52604160045260245ffd5b604051610100810167ffffffffffffffff81118282101715610efd57610efd610ec5565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610f2c57610f2c610ec5565b604052919050565b5f6020808385031215610f45575f80fd5b825167ffffffffffffffff80821115610f5c575f80fd5b818501915085601f830112610f6f575f80fd5b815181811115610f8157610f81610ec5565b8060051b9150610f92848301610f03565b8181529183018401918481019088841115610fab575f80fd5b938501935b83851015610fc957845182529385019390850190610fb0565b98975050505050505050565b80518015158114610ea5575f80fd5b5f6101008284031215610ff5575f80fd5b610ffd610ed9565b82516004811061100b575f80fd5b80825250602083015160208201526040830151604082015261102f60608401610e9a565b60608201526080830151608082015260a083015160a082015260c083015160c082015261105e60e08401610fd5565b60e08201529392505050565b81810381811115610e3e57610e3e610e17565b8082028115828204841417610e3e57610e3e610e17565b5f826110ae57634e487b7160e01b5f52601260045260245ffd5b500490565b604081525f6110c6604083018587610e44565b905082602083015294935050505056fe9b779b17422d0df92223018b32b4d1fa46e071723d6817e2486d003becc55f00a264697066735822122095eb068a43097a361b7fd785af239c727838fd38be5829758ac5291d214a08c164736f6c63430008180033","sourceMap":"226:5241:55:-:0;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;412:52;;;;;;:::i;:::-;;;;;;;;;;;;;;;;;548:25:57;;;536:2;521:18;412:52:55;;;;;;;;1400:618;;;;;;:::i;:::-;;:::i;:::-;;286:30;;;;;-1:-1:-1;;;;;286:30:55;;;;;;-1:-1:-1;;;;;1919:32:57;;;1901:51;;1889:2;1874:18;286:30:55;1734:224:57;2028:724:55;;;;;;:::i;:::-;;:::i;5119:346::-;;;;;;:::i;:::-;;:::i;470:50::-;;;;;;:::i;:::-;;;;;;;;;;;;;;2293:101:0;;;:::i;359:47:55:-;;;;;;:::i;:::-;;;;;;;;;;;;;;3834:1275;;;;;;:::i;:::-;;:::i;1638:85:0:-;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;1638:85;;322:26:55;;;;;-1:-1:-1;;;;;322:26:55;;;2762:1062;;;;;;:::i;:::-;;:::i;531:54::-;;579:6;531:54;;1118:272;;;;;;:::i;:::-;;:::i;2543:215:0:-;;;;;;:::i;:::-;;:::i;1400:618:55:-;1537:36;;;1529:70;;;;-1:-1:-1;;;1529:70:55;;3480:2:57;1529:70:55;;;3462:21:57;3519:2;3499:18;;;3492:30;-1:-1:-1;;;3538:18:57;;;3531:51;3599:18;;1529:70:55;;;;;;;;;1617:22;;;;;:51;;-1:-1:-1;1665:3:55;1643:25;;;1617:51;1609:82;;;;-1:-1:-1;;;1609:82:55;;3830:2:57;1609:82:55;;;3812:21:57;3869:2;3849:18;;;3842:30;-1:-1:-1;;;3888:18:57;;;3881:48;3946:18;;1609:82:55;3628:342:57;1609:82:55;1715:9;1710:235;1730:22;;;1710:235;;;1790:1;1777:7;;1785:1;1777:10;;;;;;;:::i;:::-;;;;;;;:14;1773:162;;;1843:7;;1851:1;1843:10;;;;;;;:::i;:::-;;;;;;;1811:12;:28;1824:11;;1836:1;1824:14;;;;;;;:::i;:::-;;;;;;;1811:28;;;;;;;;;;;;:42;;;;;;;:::i;:::-;;;;-1:-1:-1;1905:15:55;;-1:-1:-1;1871:15:55;:31;1887:11;;1899:1;1887:14;;;;;;;:::i;:::-;;;;;;;1871:31;;;;;;;;;;;:49;;;;1773:162;1754:3;;1710:235;;;;1968:43;1990:11;;2003:7;;1968:43;;;;;;;;;:::i;:::-;;;;;;;;1400:618;;;;:::o;2028:724::-;3023:21:13;:19;:21::i;:::-;2106:11:55::1;::::0;:31:::1;::::0;-1:-1:-1;;;2106:31:55;;::::1;::::0;::::1;548:25:57::0;;;2141:10:55::1;::::0;-1:-1:-1;;;;;2106:11:55::1;::::0;:19:::1;::::0;521:18:57;;2106:31:55::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;;;;;2106:45:55::1;;2098:67;;;::::0;-1:-1:-1;;;2098:67:55;;5810:2:57;2098:67:55::1;::::0;::::1;5792:21:57::0;5849:1;5829:18;;;5822:29;-1:-1:-1;;;5867:18:57;;;5860:39;5916:18;;2098:67:55::1;5608:332:57::0;2098:67:55::1;2175:14;2192:26;2207:10;2192:14;:26::i;:::-;2175:43;;2320:1;2311:6;:10;2303:40;;;::::0;-1:-1:-1;;;2303:40:55;;6147:2:57;2303:40:55::1;::::0;::::1;6129:21:57::0;6186:2;6166:18;;;6159:30;-1:-1:-1;;;6205:18:57;;;6198:47;6262:18;;2303:40:55::1;5945:341:57::0;2303:40:55::1;2446:1;2419:24:::0;;;:12:::1;:24;::::0;;;;;;;:28;;;2457:15:::1;:27:::0;;;;;2487:15:::1;2457:45:::0;;2530:10:::1;2512:29:::0;;:17:::1;:29:::0;;;;;:39;;2545:6;;2446:1;2512:39:::1;::::0;2545:6;;2512:39:::1;:::i;:::-;::::0;;;-1:-1:-1;;2652:9:55::1;::::0;:34:::1;::::0;-1:-1:-1;;;2652:34:55;;2667:10:::1;2652:34;::::0;::::1;6465:51:57::0;6532:18;;;6525:34;;;-1:-1:-1;;;;;2652:9:55;;::::1;::::0;:14:::1;::::0;6438:18:57;;2652:34:55::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;::::0;::::1;;;;;-1:-1:-1::0;;2701:44:55::1;::::0;548:25:57;;;2726:10:55::1;::::0;-1:-1:-1;2714:10:55;;-1:-1:-1;2701:44:55::1;::::0;536:2:57;521:18;2701:44:55::1;;;;;;;2088:664;3065:20:13::0;2365:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292;3065:20;2028:724:55;:::o;5119:346::-;5234:11;;:37;;-1:-1:-1;;;5234:37:55;;-1:-1:-1;;;;;1919:32:57;;;5234:37:55;;;1901:51:57;5185:7:55;;;;5234:11;;;:30;;1874:18:57;;5234:37:55;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;-1:-1:-1;;5234:37:55;;;;;;;;;;;;:::i;:::-;5204:67;;5281:13;5322:9;5317:111;5341:10;:17;5337:1;:21;5317:111;;;5388:29;5403:10;5414:1;5403:13;;;;;;;;:::i;:::-;;;;;;;5388:14;:29::i;:::-;5379:38;;;;:::i;:::-;;-1:-1:-1;5360:3:55;;5317:111;;;-1:-1:-1;5453:5:55;5119:346;-1:-1:-1;;;5119:346:55:o;2293:101:0:-;1531:13;:11;:13::i;:::-;2357:30:::1;2384:1;2357:18;:30::i;:::-;2293:101::o:0;3834:1275:55:-;3953:11;;:35;;-1:-1:-1;;;3953:35:55;;;;;548:25:57;;;3899:7:55;;;;-1:-1:-1;;;;;3953:11:55;;;;:23;;521:18:57;;3953:35:55;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;3918:70;;4002:4;:10;;;4016:1;4002:15;:38;;;-1:-1:-1;4021:14:55;;;;:19;4002:38;3998:52;;;-1:-1:-1;4049:1:55;;3834:1275;-1:-1:-1;;3834:1275:55:o;3998:52::-;4145:18;4166:27;;;:15;:27;;;;;;;4207:15;;;4203:73;;-1:-1:-1;4251:14:55;;;;4203:73;4294:23;4320:28;4338:10;4320:15;:28;:::i;:::-;4294:54;;4457:8;4439:15;:26;4435:83;;;-1:-1:-1;4499:8:55;4435:83;579:6;4540:15;:39;4536:101;;;-1:-1:-1;;;4602:24:55;;;;-1:-1:-1;4602:12:55;:24;;;;;;;3834:1275::o;4536:101::-;4776:18;4830:11;4811:4;:14;;;4798:4;:10;;;:27;;;;:::i;:::-;4797:45;;;;:::i;:::-;4776:66;-1:-1:-1;4852:15:55;4870:39;579:6;4870:15;:39;:::i;:::-;4852:57;;4985:3;4975:7;:13;4971:57;;;-1:-1:-1;5014:3:55;4971:57;5081:20;5094:7;5081:10;:20;:::i;:::-;5053:24;;;;:12;:24;;;;;;:49;;;;:::i;:::-;5046:56;3834:1275;-1:-1:-1;;;;;;;3834:1275:55:o;2762:1062::-;3023:21:13;:19;:21::i;:::-;2857:22:55;;;;;:50:::1;;-1:-1:-1::0;2905:2:55::1;2883:24:::0;::::1;;2857:50;2849:81;;;::::0;-1:-1:-1;;;2849:81:55;;3830:2:57;2849:81:55::1;::::0;::::1;3812:21:57::0;3869:2;3849:18;;;3842:30;-1:-1:-1;;;3888:18:57;;;3881:48;3946:18;;2849:81:55::1;3628:342:57::0;2849:81:55::1;2949:19;2996:9:::0;2991:481:::1;3011:22:::0;;::::1;2991:481;;;3062:11;::::0;3101:10:::1;::::0;-1:-1:-1;;;;;3062:11:55::1;:19;3082:11:::0;;3094:1;3082:14;;::::1;;;;;:::i;:::-;;;;;;;3062:35;;;;;;;;;;;;;548:25:57::0;;536:2;521:18;;402:177;3062:35:55::1;;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;:::i;:::-;-1:-1:-1::0;;;;;3062:49:55::1;;3054:71;;;::::0;-1:-1:-1;;;3054:71:55;;5810:2:57;3054:71:55::1;::::0;::::1;5792:21:57::0;5849:1;5829:18;;;5822:29;-1:-1:-1;;;5867:18:57;;;5860:39;5916:18;;3054:71:55::1;5608:332:57::0;3054:71:55::1;3139:14;3156:30;3171:11;;3183:1;3171:14;;;;;;;:::i;:::-;;;;;;;3156;:30::i;:::-;3139:47:::0;-1:-1:-1;3279:10:55;;3275:187:::1;;3340:1;3309:12;:28;3322:11;;3334:1;3322:14;;;;;;;:::i;:::-;;;;;;;3309:28;;;;;;;;;;;:32;;;;3393:15;3359;:31;3375:11;;3387:1;3375:14;;;;;;;:::i;:::-;;;;;;;3359:31;;;;;;;;;;;:49;;;;3441:6;3426:21;;;;;:::i;:::-;;;3275:187;-1:-1:-1::0;3035:3:55::1;;2991:481;;;;3512:1;3498:11;:15;3490:45;;;::::0;-1:-1:-1;;;3490:45:55;;6147:2:57;3490:45:55::1;::::0;::::1;6129:21:57::0;6186:2;6166:18;;;6159:30;-1:-1:-1;;;6205:18:57;;;6198:47;6262:18;;3490:45:55::1;5945:341:57::0;3490:45:55::1;3572:10;3554:29;::::0;;;:17:::1;:29;::::0;;;;:44;;3587:11;;3554:29;:44:::1;::::0;3587:11;;3554:44:::1;:::i;:::-;::::0;;;-1:-1:-1;;3699:9:55::1;::::0;:39:::1;::::0;-1:-1:-1;;;3699:39:55;;3714:10:::1;3699:39;::::0;::::1;6465:51:57::0;6532:18;;;6525:34;;;-1:-1:-1;;;;;3699:9:55;;::::1;::::0;:14:::1;::::0;6438:18:57;;3699:39:55::1;;;;;;;;;;;;;;;;;::::0;::::1;;;;;;;;;;;;::::0;::::1;;;;;;;;;3780:10;-1:-1:-1::0;;;;;3762:55:55::1;;3792:11;;3805;3762:55;;;;;;;;:::i;:::-;;;;;;;;2839:985;3065:20:13::0;2365:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292;3065:20;2762:1062:55;;:::o;1118:272::-;1213:1;1204:6;:10;1196:37;;;;-1:-1:-1;;;1196:37:55;;10274:2:57;1196:37:55;;;10256:21:57;10313:2;10293:18;;;10286:30;-1:-1:-1;;;10332:18:57;;;10325:44;10386:18;;1196:37:55;10072:338:57;1196:37:55;1243:24;;;;:12;:24;;;;;:34;;1271:6;;1243:24;:34;;1271:6;;1243:34;:::i;:::-;;;;-1:-1:-1;;1287:27:55;;;;:15;:27;;;;;;;1317:15;1287:45;;1347:36;1303:10;;1347:36;;;;1376:6;548:25:57;;536:2;521:18;;402:177;1347:36:55;;;;;;;;1118:272;;:::o;2543:215:0:-;1531:13;:11;:13::i;:::-;-1:-1:-1;;;;;2627:22:0;::::1;2623:91;;2672:31;::::0;-1:-1:-1;;;2672:31:0;;2700:1:::1;2672:31;::::0;::::1;1901:51:57::0;1874:18;;2672:31:0::1;1734:224:57::0;2623:91:0::1;2723:28;2742:8;2723:18;:28::i;3749:292:13:-:0;3872:25;:23;:25::i;:::-;2407:1;-1:-1:-1;;;;;;;;;;;3972:62:13;3749:292::o;1796:162:0:-;1684:7;1710:6;-1:-1:-1;;;;;1710:6:0;735:10:11;1855:23:0;1851:101;;1901:40;;-1:-1:-1;;;1901:40:0;;735:10:11;1901:40:0;;;:51:57;1874:18;;1901:40:0;1734:224:57;2912:187:0;2985:16;3004:6;;-1:-1:-1;;;;;3020:17:0;;;-1:-1:-1;;;;;;3020:17:0;;;;;;3052:40;;3004:6;;;;;;;3052:40;;2985:16;3052:40;2975:124;2912:187;:::o;3586:157:13:-;-1:-1:-1;;;;;;;;;;;4560:52:13;2407:1;4560:63;3644:93;;3696:30;;-1:-1:-1;;;3696:30:13;;;;;;;;;;;14:131:57;-1:-1:-1;;;;;89:31:57;;79:42;;69:70;;135:1;132;125:12;150:247;209:6;262:2;250:9;241:7;237:23;233:32;230:52;;;278:1;275;268:12;230:52;317:9;304:23;336:31;361:5;336:31;:::i;:::-;386:5;150:247;-1:-1:-1;;;150:247:57:o;584:367::-;647:8;657:6;711:3;704:4;696:6;692:17;688:27;678:55;;729:1;726;719:12;678:55;-1:-1:-1;752:20:57;;795:18;784:30;;781:50;;;827:1;824;817:12;781:50;864:4;856:6;852:17;840:29;;924:3;917:4;907:6;904:1;900:14;892:6;888:27;884:38;881:47;878:67;;;941:1;938;931:12;878:67;584:367;;;;;:::o;956:773::-;1078:6;1086;1094;1102;1155:2;1143:9;1134:7;1130:23;1126:32;1123:52;;;1171:1;1168;1161:12;1123:52;1211:9;1198:23;1240:18;1281:2;1273:6;1270:14;1267:34;;;1297:1;1294;1287:12;1267:34;1336:70;1398:7;1389:6;1378:9;1374:22;1336:70;:::i;:::-;1425:8;;-1:-1:-1;1310:96:57;-1:-1:-1;1513:2:57;1498:18;;1485:32;;-1:-1:-1;1529:16:57;;;1526:36;;;1558:1;1555;1548:12;1526:36;;1597:72;1661:7;1650:8;1639:9;1635:24;1597:72;:::i;:::-;956:773;;;;-1:-1:-1;1688:8:57;-1:-1:-1;;;;956:773:57:o;1963:180::-;2022:6;2075:2;2063:9;2054:7;2050:23;2046:32;2043:52;;;2091:1;2088;2081:12;2043:52;-1:-1:-1;2114:23:57;;1963:180;-1:-1:-1;1963:180:57:o;2583:437::-;2669:6;2677;2730:2;2718:9;2709:7;2705:23;2701:32;2698:52;;;2746:1;2743;2736:12;2698:52;2786:9;2773:23;2819:18;2811:6;2808:30;2805:50;;;2851:1;2848;2841:12;2805:50;2890:70;2952:7;2943:6;2932:9;2928:22;2890:70;:::i;:::-;2979:8;;2864:96;;-1:-1:-1;2583:437:57;-1:-1:-1;;;;2583:437:57:o;3025:248::-;3093:6;3101;3154:2;3142:9;3133:7;3129:23;3125:32;3122:52;;;3170:1;3167;3160:12;3122:52;-1:-1:-1;;3193:23:57;;;3263:2;3248:18;;;3235:32;;-1:-1:-1;3025:248:57:o;3975:127::-;4036:10;4031:3;4027:20;4024:1;4017:31;4067:4;4064:1;4057:15;4091:4;4088:1;4081:15;4107:127;4168:10;4163:3;4159:20;4156:1;4149:31;4199:4;4196:1;4189:15;4223:4;4220:1;4213:15;4239:125;4304:9;;;4325:10;;;4322:36;;;4338:18;;:::i;:::-;4239:125;;;;:::o;4369:311::-;4457:19;;;4439:3;-1:-1:-1;;;;;4488:31:57;;4485:51;;;4532:1;4529;4522:12;4485:51;4568:6;4565:1;4561:14;4620:8;4613:5;4606:4;4601:3;4597:14;4584:45;4649:18;;;;4669:4;4645:29;;4369:311;-1:-1:-1;;;4369:311:57:o;4685:519::-;4962:2;4951:9;4944:21;4925:4;4988:73;5057:2;5046:9;5042:18;5034:6;5026;4988:73;:::i;:::-;5109:9;5101:6;5097:22;5092:2;5081:9;5077:18;5070:50;5137:61;5191:6;5183;5175;5137:61;:::i;5209:138::-;5288:13;;5310:31;5288:13;5310:31;:::i;:::-;5209:138;;;:::o;5352:251::-;5422:6;5475:2;5463:9;5454:7;5450:23;5446:32;5443:52;;;5491:1;5488;5481:12;5443:52;5523:9;5517:16;5542:31;5567:5;5542:31;:::i;6570:127::-;6631:10;6626:3;6622:20;6619:1;6612:31;6662:4;6659:1;6652:15;6686:4;6683:1;6676:15;6702:252;6774:2;6768:9;6816:3;6804:16;;6850:18;6835:34;;6871:22;;;6832:62;6829:88;;;6897:18;;:::i;:::-;6933:2;6926:22;6702:252;:::o;6959:275::-;7030:2;7024:9;7095:2;7076:13;;-1:-1:-1;;7072:27:57;7060:40;;7130:18;7115:34;;7151:22;;;7112:62;7109:88;;;7177:18;;:::i;:::-;7213:2;7206:22;6959:275;;-1:-1:-1;6959:275:57:o;7239:936::-;7334:6;7365:2;7408;7396:9;7387:7;7383:23;7379:32;7376:52;;;7424:1;7421;7414:12;7376:52;7457:9;7451:16;7486:18;7527:2;7519:6;7516:14;7513:34;;;7543:1;7540;7533:12;7513:34;7581:6;7570:9;7566:22;7556:32;;7626:7;7619:4;7615:2;7611:13;7607:27;7597:55;;7648:1;7645;7638:12;7597:55;7677:2;7671:9;7699:2;7695;7692:10;7689:36;;;7705:18;;:::i;:::-;7751:2;7748:1;7744:10;7734:20;;7774:28;7798:2;7794;7790:11;7774:28;:::i;:::-;7836:15;;;7906:11;;;7902:20;;;7867:12;;;;7934:19;;;7931:39;;;7966:1;7963;7956:12;7931:39;7990:11;;;;8010:135;8026:6;8021:3;8018:15;8010:135;;;8092:10;;8080:23;;8043:12;;;;8123;;;;8010:135;;;8164:5;7239:936;-1:-1:-1;;;;;;;;7239:936:57:o;8180:164::-;8256:13;;8305;;8298:21;8288:32;;8278:60;;8334:1;8331;8324:12;8349:826;8446:6;8499:3;8487:9;8478:7;8474:23;8470:33;8467:53;;;8516:1;8513;8506:12;8467:53;8542:22;;:::i;:::-;8594:9;8588:16;8635:1;8626:7;8623:14;8613:42;;8651:1;8648;8641:12;8613:42;8678:7;8671:5;8664:22;;8739:2;8728:9;8724:18;8718:25;8713:2;8706:5;8702:14;8695:49;8797:2;8786:9;8782:18;8776:25;8771:2;8764:5;8760:14;8753:49;8834;8879:2;8868:9;8864:18;8834:49;:::i;:::-;8829:2;8822:5;8818:14;8811:73;8938:3;8927:9;8923:19;8917:26;8911:3;8904:5;8900:15;8893:51;8998:3;8987:9;8983:19;8977:26;8971:3;8964:5;8960:15;8953:51;9058:3;9047:9;9043:19;9037:26;9031:3;9024:5;9020:15;9013:51;9097:47;9139:3;9128:9;9124:19;9097:47;:::i;:::-;9091:3;9080:15;;9073:72;9084:5;8349:826;-1:-1:-1;;;8349:826:57:o;9180:128::-;9247:9;;;9268:11;;;9265:37;;;9282:18;;:::i;9313:168::-;9386:9;;;9417;;9434:15;;;9428:22;;9414:37;9404:71;;9455:18;;:::i;9486:217::-;9526:1;9552;9542:132;;9596:10;9591:3;9587:20;9584:1;9577:31;9631:4;9628:1;9621:15;9659:4;9656:1;9649:15;9542:132;-1:-1:-1;9688:9:57;;9486:217::o;9708:359::-;9925:2;9914:9;9907:21;9888:4;9945:73;10014:2;10003:9;9999:18;9991:6;9983;9945:73;:::i;:::-;9937:81;;10054:6;10049:2;10038:9;10034:18;10027:34;9708:359;;;;;;:::o","linkReferences":{}},"methodIdentifiers":{"YIELD_UPDATE_INTERVAL()":"eb197bee","batchClaimYield(uint256[])":"d7c436d3","batchDistributeYield(uint256[],uint256[])":"1f45e11f","calculateYield(uint256)":"80a3301b","claimYield(uint256)":"40bd2e23","distributeYield(uint256,uint256)":"f007e9d5","gameToken()":"c3dfdae6","getTotalPendingYield(address)":"4bf0c1fd","lastYieldUpdate(uint256)":"5fec8c8c","owner()":"8da5cb5b","pendingYield(uint256)":"7cf63847","propertyNFT()":"37f76838","renounceOwnership()":"715018a6","totalYieldClaimed(address)":"06ac7aed","transferOwnership(address)":"f2fde38b"},"rawMetadata":"{\"compiler\":{\"version\":\"0.8.24+commit.e11b9ed9\"},\"language\":\"Solidity\",\"output\":{\"abi\":[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"_propertyNFT\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"_gameToken\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"OwnableInvalidOwner\",\"type\":\"error\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"account\",\"type\":\"address\"}],\"name\":\"OwnableUnauthorizedAccount\",\"type\":\"error\"},{\"inputs\":[],\"name\":\"ReentrancyGuardReentrantCall\",\"type\":\"error\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"totalAmount\",\"type\":\"uint256\"}],\"name\":\"BatchYieldClaimed\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"},{\"indexed\":false,\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"}],\"name\":\"BatchYieldDistributed\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"address\",\"name\":\"previousOwner\",\"type\":\"address\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"OwnershipTransferred\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":true,\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"YieldClaimed\",\"type\":\"event\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":true,\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"indexed\":false,\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"YieldDistributed\",\"type\":\"event\"},{\"inputs\":[],\"name\":\"YIELD_UPDATE_INTERVAL\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"}],\"name\":\"batchClaimYield\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256[]\",\"name\":\"propertyIds\",\"type\":\"uint256[]\"},{\"internalType\":\"uint256[]\",\"name\":\"amounts\",\"type\":\"uint256[]\"}],\"name\":\"batchDistributeYield\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"calculateYield\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"}],\"name\":\"claimYield\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"propertyId\",\"type\":\"uint256\"},{\"internalType\":\"uint256\",\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"distributeYield\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"gameToken\",\"outputs\":[{\"internalType\":\"contract GameToken\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"owner\",\"type\":\"address\"}],\"name\":\"getTotalPendingYield\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"lastYieldUpdate\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"owner\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"name\":\"pendingYield\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"propertyNFT\",\"outputs\":[{\"internalType\":\"contract PropertyNFT\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"renounceOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"name\":\"totalYieldClaimed\",\"outputs\":[{\"internalType\":\"uint256\",\"name\":\"\",\"type\":\"uint256\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newOwner\",\"type\":\"address\"}],\"name\":\"transferOwnership\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"}],\"devdoc\":{\"errors\":{\"OwnableInvalidOwner(address)\":[{\"details\":\"The owner is not a valid owner account. (eg. `address(0)`)\"}],\"OwnableUnauthorizedAccount(address)\":[{\"details\":\"The caller account is not authorized to perform an operation.\"}],\"ReentrancyGuardReentrantCall()\":[{\"details\":\"Unauthorized reentrant call.\"}]},\"kind\":\"dev\",\"methods\":{\"owner()\":{\"details\":\"Returns the address of the current owner.\"},\"renounceOwnership()\":{\"details\":\"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner.\"},\"transferOwnership(address)\":{\"details\":\"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner.\"}},\"version\":1},\"userdoc\":{\"kind\":\"user\",\"methods\":{},\"version\":1}},\"settings\":{\"compilationTarget\":{\"src/YieldDistributor.sol\":\"YieldDistributor\"},\"evmVersion\":\"cancun\",\"libraries\":{},\"metadata\":{\"bytecodeHash\":\"ipfs\"},\"optimizer\":{\"enabled\":true,\"runs\":200},\"remappings\":[\":@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/\",\":erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/\",\":forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/\",\":halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/\",\":openzeppelin-contracts/=lib/openzeppelin-contracts/\"]},\"sources\":{\"lib/openzeppelin-contracts/contracts/access/Ownable.sol\":{\"keccak256\":\"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6\",\"dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a\"]},\"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol\":{\"keccak256\":\"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c\",\"dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol\":{\"keccak256\":\"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195\",\"dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol\":{\"keccak256\":\"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303\",\"dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV\"]},\"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol\":{\"keccak256\":\"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e\",\"dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol\":{\"keccak256\":\"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b\",\"dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol\":{\"keccak256\":\"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3\",\"dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol\":{\"keccak256\":\"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e\",\"dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol\":{\"keccak256\":\"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e\",\"dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u\"]},\"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol\":{\"keccak256\":\"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435\",\"dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6\"]},\"lib/openzeppelin-contracts/contracts/utils/Bytes.sol\":{\"keccak256\":\"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147\",\"dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR\"]},\"lib/openzeppelin-contracts/contracts/utils/Context.sol\":{\"keccak256\":\"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12\",\"dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF\"]},\"lib/openzeppelin-contracts/contracts/utils/Panic.sol\":{\"keccak256\":\"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a\",\"dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG\"]},\"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol\":{\"keccak256\":\"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99\",\"dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N\"]},\"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol\":{\"keccak256\":\"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b\",\"dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM\"]},\"lib/openzeppelin-contracts/contracts/utils/Strings.sol\":{\"keccak256\":\"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a\",\"dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol\":{\"keccak256\":\"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377\",\"dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E\"]},\"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol\":{\"keccak256\":\"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617\",\"dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u\"]},\"lib/openzeppelin-contracts/contracts/utils/math/Math.sol\":{\"keccak256\":\"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c\",\"dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol\":{\"keccak256\":\"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8\",\"dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy\"]},\"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol\":{\"keccak256\":\"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03\",\"dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ\"]},\"src/GameToken.sol\":{\"keccak256\":\"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28\",\"dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35\"]},\"src/PropertyNFT.sol\":{\"keccak256\":\"0x48a2b49e2339638970b9ddd5673ccb1e070dc627bccdf970d7bf08f52385c588\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://dd99a2ac850b965991210a954b15d6b28782345a083baff6b69532e1de8216a2\",\"dweb:/ipfs/QmeNkvV9P8nqLXCp6rft5pZ7KnCbNdhvE56PU44Qd9NZcu\"]},\"src/YieldDistributor.sol\":{\"keccak256\":\"0xb1abf3c6cd5de070a411614ada1464371fcc88a3e6f42b94ed6d30407f4b5db3\",\"license\":\"MIT\",\"urls\":[\"bzz-raw://6ecb54a4be9e6482bd9eacf2d3477eb40bf5db1a0abe346684ffa10477765129\",\"dweb:/ipfs/QmZ4Jc6n38JeoXEi3S3ekmN7od8Qftat5FnwPZYQN9dtm7\"]}},\"version\":1}","metadata":{"compiler":{"version":"0.8.24+commit.e11b9ed9"},"language":"Solidity","output":{"abi":[{"inputs":[{"internalType":"address","name":"_propertyNFT","type":"address"},{"internalType":"address","name":"_gameToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"type":"error","name":"OwnableInvalidOwner"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"type":"error","name":"OwnableUnauthorizedAccount"},{"inputs":[],"type":"error","name":"ReentrancyGuardReentrantCall"},{"inputs":[{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]","indexed":false},{"internalType":"uint256","name":"totalAmount","type":"uint256","indexed":false}],"type":"event","name":"BatchYieldClaimed","anonymous":false},{"inputs":[{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]","indexed":false},{"internalType":"uint256[]","name":"amounts","type":"uint256[]","indexed":false}],"type":"event","name":"BatchYieldDistributed","anonymous":false},{"inputs":[{"internalType":"address","name":"previousOwner","type":"address","indexed":true},{"internalType":"address","name":"newOwner","type":"address","indexed":true}],"type":"event","name":"OwnershipTransferred","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"address","name":"owner","type":"address","indexed":true},{"internalType":"uint256","name":"amount","type":"uint256","indexed":false}],"type":"event","name":"YieldClaimed","anonymous":false},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256","indexed":true},{"internalType":"uint256","name":"amount","type":"uint256","indexed":false}],"type":"event","name":"YieldDistributed","anonymous":false},{"inputs":[],"stateMutability":"view","type":"function","name":"YIELD_UPDATE_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function","name":"batchClaimYield"},{"inputs":[{"internalType":"uint256[]","name":"propertyIds","type":"uint256[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"nonpayable","type":"function","name":"batchDistributeYield"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"}],"stateMutability":"view","type":"function","name":"calculateYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"claimYield"},{"inputs":[{"internalType":"uint256","name":"propertyId","type":"uint256"},{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"nonpayable","type":"function","name":"distributeYield"},{"inputs":[],"stateMutability":"view","type":"function","name":"gameToken","outputs":[{"internalType":"contract GameToken","name":"","type":"address"}]},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function","name":"getTotalPendingYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"lastYieldUpdate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}]},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function","name":"pendingYield","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[],"stateMutability":"view","type":"function","name":"propertyNFT","outputs":[{"internalType":"contract PropertyNFT","name":"","type":"address"}]},{"inputs":[],"stateMutability":"nonpayable","type":"function","name":"renounceOwnership"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function","name":"totalYieldClaimed","outputs":[{"internalType":"uint256","name":"","type":"uint256"}]},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"stateMutability":"nonpayable","type":"function","name":"transferOwnership"}],"devdoc":{"kind":"dev","methods":{"owner()":{"details":"Returns the address of the current owner."},"renounceOwnership()":{"details":"Leaves the contract without owner. It will not be possible to call `onlyOwner` functions. Can only be called by the current owner. NOTE: Renouncing ownership will leave the contract without an owner, thereby disabling any functionality that is only available to the owner."},"transferOwnership(address)":{"details":"Transfers ownership of the contract to a new account (`newOwner`). Can only be called by the current owner."}},"version":1},"userdoc":{"kind":"user","methods":{},"version":1}},"settings":{"remappings":["@openzeppelin/contracts/=lib/openzeppelin-contracts/contracts/","erc4626-tests/=lib/openzeppelin-contracts/lib/erc4626-tests/","forge-std/=lib/openzeppelin-contracts/lib/forge-std/src/","halmos-cheatcodes/=lib/openzeppelin-contracts/lib/halmos-cheatcodes/src/","openzeppelin-contracts/=lib/openzeppelin-contracts/"],"optimizer":{"enabled":true,"runs":200},"metadata":{"bytecodeHash":"ipfs"},"compilationTarget":{"src/YieldDistributor.sol":"YieldDistributor"},"evmVersion":"cancun","libraries":{}},"sources":{"lib/openzeppelin-contracts/contracts/access/Ownable.sol":{"keccak256":"0xff6d0bb2e285473e5311d9d3caacb525ae3538a80758c10649a4d61029b017bb","urls":["bzz-raw://8ed324d3920bb545059d66ab97d43e43ee85fd3bd52e03e401f020afb0b120f6","dweb:/ipfs/QmfEckWLmZkDDcoWrkEvMWhms66xwTLff9DDhegYpvHo1a"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/interfaces/draft-IERC6093.sol":{"keccak256":"0x1b88b3fb3d85ba5496d7d5f396f83ee1fddcdd6762059ff65992655b67920998","urls":["bzz-raw://89393bb3212da1c0889601b9706a07b39419ddc4d2faab9eaf6e7f9152cf6a1c","dweb:/ipfs/QmcCfzzxv1Bkdz1c1yF4gQCeYb6Us5BJANnzTFqawfd1HL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/ERC20.sol":{"keccak256":"0x669464167428061ee0f8618b73b3ee90aff8405683e7ddde8cd77dadaa1afe29","urls":["bzz-raw://0dda78587a7358b4fdf6b9fca0fde5a5e34930f36d5268a16028627fc0170195","dweb:/ipfs/QmQ1b6cCceDRWNxti9HifsTCzmVP25Haxs1bWugm52vTqH"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/IERC20.sol":{"keccak256":"0x74ed01eb66b923d0d0cfe3be84604ac04b76482a55f9dd655e1ef4d367f95bc2","urls":["bzz-raw://5282825a626cfe924e504274b864a652b0023591fa66f06a067b25b51ba9b303","dweb:/ipfs/QmeCfPykghhMc81VJTrHTC7sF6CRvaA1FXVq2pJhwYp1dV"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC20/extensions/IERC20Metadata.sol":{"keccak256":"0xd6fa4088198f04eef10c5bce8a2f4d60554b7ec4b987f684393c01bf79b94d9f","urls":["bzz-raw://f95ee0bbd4dd3ac730d066ba3e785ded4565e890dbec2fa7d3b9fe3bad9d0d6e","dweb:/ipfs/QmSLr6bHkPFWT7ntj34jmwfyskpwo97T9jZUrk5sz3sdtR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/ERC721.sol":{"keccak256":"0x0a5edd019f899b88982213d19339419578276a3f398eec03084b295cc1994039","urls":["bzz-raw://f0680afad39f55515cb8b0109d1c0d39691442edb1282d57127f834aedd2d77b","dweb:/ipfs/QmbEn2gLtmZz15hRo8wNrzzqqm6nvowNABZAKatGrhNoRn"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721.sol":{"keccak256":"0xf78f05f3b8c9f75570e85300d7b4600d7f6f6a198449273f31d44c1641adb46f","urls":["bzz-raw://e28b872613b45e0e801d4995aa4380be2531147bfe2d85c1d6275f1de514fba3","dweb:/ipfs/QmeeFcfShHYaS3BdgVj78nxR28ZaVUwbvr66ud8bT6kzw9"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/IERC721Receiver.sol":{"keccak256":"0x88cd5e3bee2e8c36b8d9058fbcaa81ad5704281b25634122234b55ea853d8055","urls":["bzz-raw://8dc7e7ab5b8ea36c15027ab04221b05d1c970f47a53e9fd47ead8ca665d49c7e","dweb:/ipfs/Qmeeph7fsDyfRr8vb2L8KcDEmKPb224TAayMvgqgGAnqpL"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/extensions/IERC721Metadata.sol":{"keccak256":"0xf46268c37522320bb2119a5a394bc5c739a95c0c574c8d08e8c643f4d06e5c76","urls":["bzz-raw://517e4b295f35b9947c72ad7379a6089439ece7bb6f4a2ea0a159da13046c039e","dweb:/ipfs/QmZXzkSfLUbvujig3zVbpDHykpHhqLpvQtdiN3B5j4TA3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/token/ERC721/utils/ERC721Utils.sol":{"keccak256":"0xc7efbc23214ad7dced8bf2249460f4bda114d57f6a0079f84040654280f455bd","urls":["bzz-raw://1f5bd44efca8c8c0d74439e7b808d1f9c4af1df78f91fef8e8bbca8104645435","dweb:/ipfs/Qmb42XSd8MKsEitp42sZkSFGqDRigk6QgGXtiJyJqUZJJ6"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Bytes.sol":{"keccak256":"0x8140d608316521b1fd71167c3b708ebb8659da070723fc8807609553b296ee33","urls":["bzz-raw://a7bf7db66869ba1e945a0390b85da2f6afc7e42a4735ca918d0d56ac90c50147","dweb:/ipfs/QmRmNyhpBpgzSdQqLtrQCYE7H7eLnVVxh2Yy4YMrySR8AR"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Context.sol":{"keccak256":"0x493033a8d1b176a037b2cc6a04dad01a5c157722049bbecf632ca876224dd4b2","urls":["bzz-raw://6a708e8a5bdb1011c2c381c9a5cfd8a9a956d7d0a9dc1bd8bcdaf52f76ef2f12","dweb:/ipfs/Qmax9WHBnVsZP46ZxEMNRQpLQnrdE4dK8LehML1Py8FowF"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Panic.sol":{"keccak256":"0xf7fe324703a64fc51702311dc51562d5cb1497734f074e4f483bfb6717572d7a","urls":["bzz-raw://c6a5ff4f9fd8649b7ee20800b7fa387d3465bd77cf20c2d1068cd5c98e1ed57a","dweb:/ipfs/QmVSaVJf9FXFhdYEYeCEfjMVHrxDh5qL4CGkxdMWpQCrqG"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/ReentrancyGuard.sol":{"keccak256":"0xa516cbf1c7d15d3517c2d668601ce016c54395bf5171918a14e2686977465f53","urls":["bzz-raw://1e1d079e8edfb58efd23a311e315a4807b01b5d1cf153f8fa2d0608b9dec3e99","dweb:/ipfs/QmTBExeX2SDTkn5xbk5ssbYSx7VqRp9H4Ux1CY4uQM4b9N"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/StorageSlot.sol":{"keccak256":"0xcf74f855663ce2ae00ed8352666b7935f6cddea2932fdf2c3ecd30a9b1cd0e97","urls":["bzz-raw://9f660b1f351b757dfe01438e59888f31f33ded3afcf5cb5b0d9bf9aa6f320a8b","dweb:/ipfs/QmarDJ5hZEgBtCmmrVzEZWjub9769eD686jmzb2XpSU1cM"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/Strings.sol":{"keccak256":"0x36d1750bf1aa5fee9c52adb2f7857ab652daca722fc05dff533b364f67a1139a","urls":["bzz-raw://2e5e7052539b7849d02f3ce25acc1dce29373c11cfae9f0bc918c54b780c549a","dweb:/ipfs/QmRGE32xNkMTo6i4pHHMxjpiu77yPwnTA25SFngw2NXJys"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/ERC165.sol":{"keccak256":"0x2d9dc2fe26180f74c11c13663647d38e259e45f95eb88f57b61d2160b0109d3e","urls":["bzz-raw://81233d1f98060113d9922180bb0f14f8335856fe9f339134b09335e9f678c377","dweb:/ipfs/QmWh6R35SarhAn4z2wH8SU456jJSYL2FgucfTFgbHJJN4E"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/introspection/IERC165.sol":{"keccak256":"0x8891738ffe910f0cf2da09566928589bf5d63f4524dd734fd9cedbac3274dd5c","urls":["bzz-raw://971f954442df5c2ef5b5ebf1eb245d7105d9fbacc7386ee5c796df1d45b21617","dweb:/ipfs/QmadRjHbkicwqwwh61raUEapaVEtaLMcYbQZWs9gUkgj3u"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/Math.sol":{"keccak256":"0x09e3f1c72d4c5cbe8e2644ab7313f8f7177533ae2f4c24cdcbbeaf520a73734c","urls":["bzz-raw://93208401215d539fa2d81626b207c1f611def7883d0e447b3b5969ebaa7b3c2c","dweb:/ipfs/QmXPxDnQPx8LAweX5ZJqEcwkvs59kP4c64VVDG1Jjq1mef"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SafeCast.sol":{"keccak256":"0x195533c86d0ef72bcc06456a4f66a9b941f38eb403739b00f21fd7c1abd1ae54","urls":["bzz-raw://b1d578337048cad08c1c03041cca5978eff5428aa130c781b271ad9e5566e1f8","dweb:/ipfs/QmPFKL2r9CBsMwmUqqdcFPfHZB2qcs9g1HDrPxzWSxomvy"],"license":"MIT"},"lib/openzeppelin-contracts/contracts/utils/math/SignedMath.sol":{"keccak256":"0xb1970fac7b64e6c09611e6691791e848d5e3fe410fa5899e7df2e0afd77a99e3","urls":["bzz-raw://db5fbb3dddd8b7047465b62575d96231ba8a2774d37fb4737fbf23340fabbb03","dweb:/ipfs/QmVUSvooZKEdEdap619tcJjTLcAuH6QBdZqAzWwnAXZAWJ"],"license":"MIT"},"src/GameToken.sol":{"keccak256":"0xd03a0ddc0c435f7e71ad2faba96c259b21d0328cc138e2b85d54913c3c759169","urls":["bzz-raw://1d0224bb17e87de0a16482300b9f1e00ff673cf9dba6bb5bc826e3a5cc81fe28","dweb:/ipfs/QmP1ZSshVXZC2pCfraoS9CvttGtu8D4tjRVopE3Auhaa35"],"license":"MIT"},"src/PropertyNFT.sol":{"keccak256":"0x48a2b49e2339638970b9ddd5673ccb1e070dc627bccdf970d7bf08f52385c588","urls":["bzz-raw://dd99a2ac850b965991210a954b15d6b28782345a083baff6b69532e1de8216a2","dweb:/ipfs/QmeNkvV9P8nqLXCp6rft5pZ7KnCbNdhvE56PU44Qd9NZcu"],"license":"MIT"},"src/YieldDistributor.sol":{"keccak256":"0xb1abf3c6cd5de070a411614ada1464371fcc88a3e6f42b94ed6d30407f4b5db3","urls":["bzz-raw://6ecb54a4be9e6482bd9eacf2d3477eb40bf5db1a0abe346684ffa10477765129","dweb:/ipfs/QmZ4Jc6n38JeoXEi3S3ekmN7od8Qftat5FnwPZYQN9dtm7"],"license":"MIT"}},"version":1},"id":55}
</file>

<file path="backend/src/database/schema/leaderboard.schema.ts">
import { pgTable, uuid, bigint, timestamp, integer, varchar, numeric } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

export const leaderboard = pgTable('leaderboard', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' })
    .unique(),
  rank: integer('rank'),
  totalPortfolioValue: numeric('total_portfolio_value').default('0').notNull(),
  totalYieldEarned: numeric('total_yield_earned').default('0').notNull(),
  propertiesOwned: integer('properties_owned').default(0).notNull(),
  questsCompleted: integer('quests_completed').default(0).notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type LeaderboardEntry = typeof leaderboard.$inferSelect;
export type NewLeaderboardEntry = typeof leaderboard.$inferInsert;
</file>

<file path="backend/src/database/schema/users.schema.ts">
import { pgTable, uuid, varchar, timestamp, bigint, numeric } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: uuid('id').defaultRandom().primaryKey(),
  walletAddress: varchar('wallet_address', { length: 42 }).notNull().unique(),
  username: varchar('username', { length: 100 }),
  totalPortfolioValue: numeric('total_portfolio_value').default('0').notNull(),
  totalYieldEarned: numeric('total_yield_earned').default('0').notNull(),
  propertiesOwned: bigint('properties_owned', { mode: 'number' }).default(0).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
</file>

<file path="backend/src/events/events.module.ts">
import { Module, forwardRef } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { EventIndexerService } from './event-indexer.service';
import { ContractsModule } from '../contracts/contracts.module';
import { DatabaseModule } from '../database/database.module';
import { WebsocketGateway } from '../websocket/websocket.gateway';
import { MantleModule } from '../mantle/mantle.module';
import { LeaderboardModule } from '../leaderboard/leaderboard.module';
import { GuildsModule } from '../guilds/guilds.module';
import { PropertiesModule } from '../properties/properties.module';
import { YieldModule } from '../yield/yield.module';

@Module({
  imports: [
    ConfigModule,
    ContractsModule,
    DatabaseModule,
    MantleModule,
    LeaderboardModule,
    GuildsModule,
    forwardRef(() => PropertiesModule),
    forwardRef(() => YieldModule),
  ],
  providers: [EventIndexerService, WebsocketGateway],
  exports: [EventIndexerService],
})
export class EventsModule {}
</file>

<file path="backend/src/leaderboard/leaderboard.module.ts">
import { Module } from '@nestjs/common';
import { LeaderboardService } from './leaderboard.service';
import { LeaderboardController } from './leaderboard.controller';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';

@Module({
  imports: [DatabaseModule, ContractsModule],
  controllers: [LeaderboardController],
  providers: [LeaderboardService],
  exports: [LeaderboardService],
})
export class LeaderboardModule {}
</file>

<file path="backend/src/main.ts">
import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Global prefix
  app.setGlobalPrefix(process.env.API_PREFIX || 'api');

  // Enable CORS
  app.enableCors({
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'x-wallet-address'],
  });

  // Global validation pipe
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      transform: true,
      forbidNonWhitelisted: true,
    }),
  );

  // Swagger documentation
  const config = new DocumentBuilder()
    .setTitle('Property Tycoon API')
    .setDescription('API documentation for Property Tycoon - Real estate investment game on Mantle Network')
    .setVersion('1.0')
    .addTag('properties', 'Property management endpoints')
    .addTag('yield', 'Yield distribution endpoints')
    .addTag('marketplace', 'Marketplace trading endpoints')
    .addTag('quests', 'Quest system endpoints')
    .addTag('leaderboard', 'Leaderboard rankings endpoints')
    .build();
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  const port = process.env.PORT || 3001;
  await app.listen(port, '0.0.0.0'); // Listen on all interfaces for Railway
  console.log(` Backend server running on: http://0.0.0.0:${port}`);
  console.log(` API Documentation: http://0.0.0.0:${port}/api/docs`);
}
bootstrap();
</file>

<file path="contracts/script/DeployMarketplace.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {Marketplace} from "../src/Marketplace.sol";

/**
 * @title DeployMarketplaceScript
 * @notice Deploy the Marketplace contract to Mantle Sepolia Testnet
 * @dev This contract uses ESCROW approach (NFTs transfer to marketplace)
 *      Better for high-value property assets - more secure for buyers
 */
contract DeployMarketplaceScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Deploying Marketplace contract to Mantle Sepolia...");
        console.log("Deployer:", vm.addr(deployerPrivateKey));
        
        // Get contract addresses from environment
        address propertyNFT = vm.envAddress("PROPERTY_NFT_ADDRESS");
        address gameToken = vm.envAddress("GAME_TOKEN_ADDRESS");
        
        console.log("Using PropertyNFT:", propertyNFT);
        console.log("Using GameToken:", gameToken);
        
        // Deploy Marketplace
        Marketplace marketplace = new Marketplace(propertyNFT, gameToken);
        address marketplaceAddress = address(marketplace);
        
        console.log("\n=== Marketplace Deployed ===");
        console.log("Marketplace Address:", marketplaceAddress);
        console.log("PropertyNFT Address:", propertyNFT);
        console.log("GameToken Address:", gameToken);
        console.log("\nIMPORTANT: Update these files with the new address:");
        console.log("  1. frontend/.env.local -> NEXT_PUBLIC_MARKETPLACE_ADDRESS");
        console.log("  2. backend/.env -> MARKETPLACE_ADDRESS");
        console.log("  3. frontend/src/lib/contracts.ts -> CONTRACTS.Marketplace (fallback)");
        console.log("\nFeatures:");
        console.log("  - Escrow-based (NFTs transfer to marketplace)");
        console.log("  - getActiveListings() function included");
        console.log("  - getActiveListingsCount() function included");
        console.log("  - Batch listing support");
        console.log("  - Auction support");
        console.log("  - 2.5% platform fee");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/DeployMockRWA.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {MockRWA} from "../src/MockRWA.sol";

contract DeployMockRWA is Script {
    function run() public {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);

        console.log("Deploying MockRWA contract...");
        
        MockRWA mockRWA = new MockRWA();
        
        console.log("MockRWA deployed at:", address(mockRWA));
        
        // Mint some test RWA properties for demo
        console.log("Minting test RWA properties...");
        
        // Property 1: NYC Apartment
        mockRWA.mintRWAProperty(
            msg.sender,
            "NYC Apartment #42",
            1000000 * 10**18,  // $1M value
            5000 * 10**18,     // $5K/month yield
            "New York, NY"
        );
        console.log("Minted: NYC Apartment #42");
        
        // Property 2: Commercial Building
        mockRWA.mintRWAProperty(
            msg.sender,
            "Commercial Building #15",
            2000000 * 10**18,  // $2M value
            15000 * 10**18,    // $15K/month yield
            "Los Angeles, CA"
        );
        console.log("Minted: Commercial Building #15");
        
        // Property 3: Industrial Warehouse
        mockRWA.mintRWAProperty(
            msg.sender,
            "Industrial Warehouse #8",
            5000000 * 10**18,  // $5M value
            50000 * 10**18,    // $50K/month yield
            "Chicago, IL"
        );
        console.log("Minted: Industrial Warehouse #8");
        
        // Property 4: Luxury Estate
        mockRWA.mintRWAProperty(
            msg.sender,
            "Luxury Estate #3",
            10000000 * 10**18, // $10M value
            125000 * 10**18,   // $125K/month yield
            "Miami, FL"
        );
        console.log("Minted: Luxury Estate #3");
        
        // Property 5: Residential Complex
        mockRWA.mintRWAProperty(
            msg.sender,
            "Residential Complex #12",
            3000000 * 10**18,  // $3M value
            20000 * 10**18,    // $20K/month yield
            "Seattle, WA"
        );
        console.log("Minted: Residential Complex #12");
        
        console.log("MockRWA deployment complete!");
        console.log("Contract Address:", address(mockRWA));
        console.log("Total RWA Properties Minted: 5");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/src/interfaces/IRWA.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

/**
 * @title IRWA
 * @notice Standard interface for Real-World Asset contracts
 * @dev Any RWA contract implementing this interface can be linked to Property NFTs
 * 
 * This interface allows Property Tycoon to work with any RWA platform that implements
 * these standard functions. Examples:
 * - Centrifuge (real estate, invoices)
 * - RealT (tokenized properties)
 * - Tangible (real-world asset NFTs)
 * - Custom RWA platforms
 */
interface IRWA {
    /**
     * @notice Get the value of an RWA token
     * @param tokenId The RWA token ID
     * @return The property value in wei
     */
    function getPropertyValue(uint256 tokenId) external view returns (uint256);
    
    /**
     * @notice Get the annual yield for an RWA token
     * @param tokenId The RWA token ID
     * @return The annual yield amount in wei
     */
    function getAnnualYield(uint256 tokenId) external view returns (uint256);
    
    /**
     * @notice Get the yield rate (APY) for an RWA token
     * @param tokenId The RWA token ID
     * @return APY in basis points (e.g., 500 = 5%)
     */
    function getYieldRate(uint256 tokenId) external view returns (uint256);
    
    /**
     * @notice Check if an RWA token exists and is active
     * @param tokenId The RWA token ID
     * @return True if token exists and is active
     */
    function isActive(uint256 tokenId) external view returns (bool);
    
    /**
     * @notice Get the owner of an RWA token (for ERC-721 compatibility)
     * @param tokenId The RWA token ID
     * @return The owner address
     */
    function ownerOf(uint256 tokenId) external view returns (address);
}
</file>

<file path="contracts/src/MockRWA.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";

/**
 * @title MockRWA
 * @notice Mock Real-World Asset contract for demo/testing
 * @dev Implements ERC-721 standard - can be replaced with real RWA contracts
 * 
 * This contract simulates tokenized real estate assets.
 * In production, this would be replaced with actual RWA platforms like:
 * - Centrifuge (real estate, invoices)
 * - RealT (tokenized properties)
 * - Tangible (real-world asset NFTs)
 */
contract MockRWA is ERC721, Ownable, ReentrancyGuard {
    uint256 private _tokenIdCounter;
    
    struct RWAProperty {
        string name;              // Property name (e.g., "NYC Apartment #42")
        uint256 value;           // Property value in wei
        uint256 monthlyYield;    // Monthly yield in wei
        string location;         // Property location
        uint256 createdAt;       // Creation timestamp
        bool isActive;           // Active status
    }
    
    mapping(uint256 => RWAProperty) public properties;
    mapping(address => uint256[]) public ownerProperties;
    
    event RWAPropertyCreated(
        uint256 indexed tokenId,
        address indexed owner,
        string name,
        uint256 value,
        uint256 monthlyYield
    );
    
    constructor() ERC721("Mock Real-World Asset", "MRWA") Ownable(msg.sender) {}
    
    /**
     * @notice Mint a new RWA property token
     * @param to Address to mint token to
     * @param name Property name
     * @param value Property value (in wei)
     * @param monthlyYield Monthly yield amount (in wei)
     * @param location Property location
     * @return tokenId The minted token ID
     */
    function mintRWAProperty(
        address to,
        string memory name,
        uint256 value,
        uint256 monthlyYield,
        string memory location
    ) public onlyOwner nonReentrant returns (uint256) {
        uint256 tokenId = _tokenIdCounter++;
        _safeMint(to, tokenId);
        
        properties[tokenId] = RWAProperty({
            name: name,
            value: value,
            monthlyYield: monthlyYield,
            location: location,
            createdAt: block.timestamp,
            isActive: true
        });
        
        ownerProperties[to].push(tokenId);
        
        emit RWAPropertyCreated(tokenId, to, name, value, monthlyYield);
        return tokenId;
    }
    
    /**
     * @notice Batch mint multiple RWA properties
     * @param to Address to mint tokens to
     * @param names Array of property names
     * @param values Array of property values
     * @param monthlyYields Array of monthly yields
     * @param locations Array of property locations
     * @return tokenIds Array of minted token IDs
     */
    function batchMintRWAProperties(
        address to,
        string[] memory names,
        uint256[] memory values,
        uint256[] memory monthlyYields,
        string[] memory locations
    ) public onlyOwner nonReentrant returns (uint256[] memory) {
        require(
            names.length == values.length &&
            values.length == monthlyYields.length &&
            monthlyYields.length == locations.length,
            "Array length mismatch"
        );
        
        uint256[] memory tokenIds = new uint256[](names.length);
        
        for (uint256 i = 0; i < names.length; i++) {
            tokenIds[i] = mintRWAProperty(
                to,
                names[i],
                values[i],
                monthlyYields[i],
                locations[i]
            );
        }
        
        return tokenIds;
    }
    
    /**
     * @notice Get RWA property details
     * @param tokenId Token ID
     * @return RWAProperty struct with property details
     */
    function getRWAProperty(uint256 tokenId) public view returns (RWAProperty memory) {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        return properties[tokenId];
    }
    
    /**
     * @notice Get all properties owned by an address
     * @param owner Owner address
     * @return Array of token IDs owned by the address
     */
    function getOwnerProperties(address owner) public view returns (uint256[] memory) {
        return ownerProperties[owner];
    }
    
    /**
     * @notice Calculate annual yield for a property
     * @param tokenId Token ID
     * @return Annual yield amount (monthlyYield * 12)
     */
    function getAnnualYield(uint256 tokenId) public view returns (uint256) {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        return properties[tokenId].monthlyYield * 12;
    }
    
    /**
     * @notice Calculate yield rate (APY) for a property
     * @param tokenId Token ID
     * @return APY in basis points (e.g., 500 = 5%)
     */
    function getYieldRate(uint256 tokenId) public view returns (uint256) {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        RWAProperty memory prop = properties[tokenId];
        if (prop.value == 0) return 0;
        // APY = (annualYield / value) * 10000 (basis points)
        return (prop.monthlyYield * 12 * 10000) / prop.value;
    }
    
    /**
     * @notice Update property value (for demo - simulates market changes)
     * @param tokenId Token ID
     * @param newValue New property value
     */
    function updatePropertyValue(uint256 tokenId, uint256 newValue) public onlyOwner {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        properties[tokenId].value = newValue;
    }
    
    /**
     * @notice Update monthly yield (for demo - simulates rent changes)
     * @param tokenId Token ID
     * @param newMonthlyYield New monthly yield amount
     */
    function updateMonthlyYield(uint256 tokenId, uint256 newMonthlyYield) public onlyOwner {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        properties[tokenId].monthlyYield = newMonthlyYield;
    }
    
    /**
     * @notice Deactivate a property (for demo)
     * @param tokenId Token ID
     */
    function deactivateProperty(uint256 tokenId) public onlyOwner {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        properties[tokenId].isActive = false;
    }
    
    /**
     * @notice Reactivate a property (for demo)
     * @param tokenId Token ID
     */
    function reactivateProperty(uint256 tokenId) public onlyOwner {
        require(_ownerOf(tokenId) != address(0), "Token does not exist");
        properties[tokenId].isActive = true;
    }
    
    /**
     * @dev Override to update ownerProperties mapping
     */
    function _update(address to, uint256 tokenId, address auth) internal override returns (address) {
        address previousOwner = super._update(to, tokenId, auth);
        
        if (previousOwner != address(0)) {
            // Remove from previous owner's list
            uint256[] storage prevOwnerProps = ownerProperties[previousOwner];
            for (uint256 i = 0; i < prevOwnerProps.length; i++) {
                if (prevOwnerProps[i] == tokenId) {
                    prevOwnerProps[i] = prevOwnerProps[prevOwnerProps.length - 1];
                    prevOwnerProps.pop();
                    break;
                }
            }
        }
        
        if (to != address(0)) {
            // Add to new owner's list
            ownerProperties[to].push(tokenId);
        }
        
        return previousOwner;
    }
}
</file>

<file path="frontend/app/globals.css">
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap');

@font-face {
  font-family: 'KnightWarrior';
  src: url('/assets/fonts/KnightWarrior-w16n8.otf') format('opentype');
  font-weight: normal;
  font-style: normal;
}

@import "tailwindcss";

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 221.2 83.2% 53.3%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    --card: 222.2 84% 4.9%;
    --card-foreground: 210 40% 98%;
    --popover: 222.2 84% 4.9%;
    --popover-foreground: 210 40% 98%;
    --primary: 217.2 91.2% 59.8%;
    --primary-foreground: 222.2 47.4% 11.2%;
    --secondary: 217.2 32.6% 17.5%;
    --secondary-foreground: 210 40% 98%;
    --muted: 217.2 32.6% 17.5%;
    --muted-foreground: 215 20.2% 65.1%;
    --accent: 217.2 32.6% 17.5%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 210 40% 98%;
    --border: 217.2 32.6% 17.5%;
    --input: 217.2 32.6% 17.5%;
    --ring: 224.3 76.3% 48%;
  }
}

@layer base {
  * {
    border-color: hsl(var(--border));
  }
  body {
    background-color: hsl(var(--background));
    color: hsl(var(--foreground));
    font-family: 'KnightWarrior', sans-serif;
    font-feature-settings: 'rlig' 1, 'calt' 1;
    letter-spacing: 0.025em;
  }

  /* Gaming font for numbers */
  .font-numbers {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.02em;
  }

  /* Gaming font for headers */
  h1, h2, h3, h4, h5, h6 {
    font-family: 'KnightWarrior', sans-serif;
    font-weight: normal;
    letter-spacing: 0.05em;
  }
}

/* Animations */
@keyframes float {
  0%, 100% {
    transform: translateY(0px) translateX(0px);
  }
  33% {
    transform: translateY(-20px) translateX(10px);
  }
  66% {
    transform: translateY(20px) translateX(-10px);
  }
}

@keyframes fade-in-up {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes gradient {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

@keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
  }
  50% {
    box-shadow: 0 0 40px rgba(16, 185, 129, 0.6);
  }
}

@keyframes shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

@keyframes scroll-down {
  0% {
    transform: translateY(0);
    opacity: 1;
  }
  100% {
    transform: translateY(10px);
    opacity: 0;
  }
}

.animate-float {
  animation: float 20s ease-in-out infinite;
}

.animate-fade-in-up {
  animation: fade-in-up 0.6s ease-out forwards;
  opacity: 0;
}

.animate-gradient {
  background-size: 200% 200%;
  animation: gradient 3s ease infinite;
}

.animate-pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite;
}

.animate-shimmer {
  animation: shimmer 3s linear infinite;
}

.animate-scroll-down {
  animation: scroll-down 1.5s ease-in-out infinite;
}
</file>

<file path="frontend/app/layout.tsx">
import type { Metadata } from "next";
import "./globals.css";
import { cookies } from "next/headers";
import ContextProvider from '@/context';

export const metadata: Metadata = {
  title: "Property Tycoon - Real Estate Investment Game",
  description: "Build your property portfolio, earn yield, and compete on Mantle Network",
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const cookieStore = await cookies();
  // Get the cookie header string - format as "name=value; name2=value2"
  const cookieHeader = cookieStore.getAll()
    .map(cookie => `${cookie.name}=${cookie.value}`)
    .join('; ') || null;
  
  return (
    <html lang="en">
      <body>
        <ContextProvider cookies={cookieHeader}>{children}</ContextProvider>
      </body>
    </html>
  );
}
</file>

<file path="frontend/app/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAccount } from 'wagmi';
import { Building2, TrendingUp, DollarSign, Trophy, Zap, Target, Sparkles, Users, Landmark, Coins } from 'lucide-react';
import { WalletConnect } from '@/components/WalletConnect';
import Link from 'next/link';

export default function Home() {
  const router = useRouter();
  const { isConnected, address } = useAccount();
  const [scrollY, setScrollY] = useState(0);
  const [mousePosition, setMousePosition] = useState({ x: 0, y: 0 });

  useEffect(() => {
    const handleScroll = () => setScrollY(window.scrollY);
    const handleMouseMove = (e: MouseEvent) => {
      setMousePosition({ x: e.clientX, y: e.clientY });
    };

    window.addEventListener('scroll', handleScroll);
    window.addEventListener('mousemove', handleMouseMove);

    return () => {
      window.removeEventListener('scroll', handleScroll);
      window.removeEventListener('mousemove', handleMouseMove);
    };
  }, []);

  const parallaxY = scrollY * 0.5;
  const cursorX = typeof window !== 'undefined' ? (mousePosition.x - window.innerWidth / 2) * 0.02 : 0;
  const cursorY = typeof window !== 'undefined' ? (mousePosition.y - window.innerHeight / 2) * 0.02 : 0;

  const features = [
    {
      icon: Building2,
      title: 'Build Your Empire',
      description: 'Purchase residential, commercial, and luxury properties to expand your portfolio',
      color: 'from-blue-500 to-cyan-500',
    },
    {
      icon: TrendingUp,
      title: 'Earn Real Yield',
      description: 'Claim daily yield from your properties backed by real-world assets',
      color: 'from-emerald-500 to-teal-500',
    },
    {
      icon: Coins,
      title: 'Trade Properties',
      description: 'Buy and sell properties on the marketplace to maximize your returns',
      color: 'from-amber-500 to-orange-500',
    },
    {
      icon: Trophy,
      title: 'Compete & Win',
      description: 'Climb the leaderboards and prove your real estate investment skills',
      color: 'from-yellow-500 to-amber-500',
    },
    {
      icon: Zap,
      title: 'Lightning Fast',
      description: 'Powered by Mantle blockchain for instant, low-cost transactions',
      color: 'from-purple-500 to-pink-500',
    },
    {
      icon: Target,
      title: 'Strategic Investment',
      description: 'Master property valuation and timing to build the ultimate portfolio',
      color: 'from-indigo-500 to-violet-500',
    },
  ];

  const stats = [
    { label: 'Active Players', value: '5K+', icon: Users },
    { label: 'Properties Owned', value: '15K+', icon: Building2 },
    { label: 'Yield Earned', value: '$500K+', icon: DollarSign },
    { label: 'Trades Today', value: '1K+', icon: TrendingUp },
  ];

  return (
    <div className="relative min-h-screen bg-black text-white overflow-x-hidden">
      {/* Animated Background */}
      <div
        className="fixed inset-0 bg-gradient-to-br from-gray-900 via-black to-gray-900"
        style={{
          transform: `translateY(${parallaxY}px)`,
        }}
      />

      {/* Gradient Overlays */}
      <div className="fixed inset-0 bg-gradient-to-b from-black/80 via-black/40 to-black/80" />
      <div className="fixed inset-0 bg-gradient-to-r from-emerald-900/20 via-transparent to-blue-900/20" />

      {/* Floating Particles */}
      <div className="fixed inset-0 pointer-events-none">
        {[...Array(20)].map((_, i) => (
          <div
            key={i}
            className="absolute animate-float"
            style={{
              left: `${Math.random() * 100}%`,
              top: `${Math.random() * 100}%`,
              animationDelay: `${Math.random() * 5}s`,
              animationDuration: `${10 + Math.random() * 10}s`,
            }}
          >
            <Sparkles
              className="text-emerald-500/20"
              size={Math.random() * 20 + 10}
            />
          </div>
        ))}
      </div>

      {/* Content */}
      <div className="relative z-10">
        {/* Navigation */}
        <nav className="fixed top-0 left-0 right-0 z-50 backdrop-blur-md bg-black/30 border-b border-white/10">
          <div className="container mx-auto px-6 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center">
                  <Building2 className="w-6 h-6 text-white" />
                </div>
                <h1
                  className="text-2xl font-bold bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-500 bg-clip-text text-transparent"
                  style={{ letterSpacing: '0.15em' }}
                >
                  PROPERTY TYCOON
          </h1>
              </div>

              <div className="flex gap-3">
                {isConnected ? (
                  <>
                    <Link
                      href="/game"
                      className="px-6 py-2.5 rounded-lg bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 font-medium transition-all duration-300 hover:scale-105"
                      style={{ letterSpacing: '0.05em' }}
                    >
                      My Portfolio
                    </Link>
                    <Link
                      href="/game"
                      className="px-6 py-2.5 rounded-lg bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 font-bold transition-all duration-300 hover:scale-105 shadow-lg shadow-emerald-500/50"
                      style={{ letterSpacing: '0.05em' }}
                    >
                      Play Now
                    </Link>
                  </>
                ) : (
                  <WalletConnect />
                )}
              </div>
            </div>
          </div>
        </nav>

        {/* Hero Section */}
        <section className="relative min-h-screen flex items-center justify-center pt-20">
          <div className="container mx-auto px-6 text-center">
            <div
              className="animate-fade-in-up"
              style={{ transform: `translate(${cursorX}px, ${cursorY}px)` }}
            >
              {/* Badge */}
              <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 backdrop-blur-sm mb-8 animate-pulse-glow">
                <Zap className="w-4 h-4 text-yellow-400" />
                <span className="text-sm font-medium bg-gradient-to-r from-emerald-300 to-teal-300 bg-clip-text text-transparent">
                  Powered by Mantle Blockchain
                </span>
              </div>

              {/* Main Title */}
              <h1 className="text-6xl md:text-8xl font-bold mb-6 leading-tight">
                <span
                  className="block bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-500 bg-clip-text text-transparent animate-gradient"
                  style={{ letterSpacing: '0.05em' }}
                >
                  INVEST. BUILD.
                </span>
                <span
                  className="block bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 bg-clip-text text-transparent animate-gradient"
                  style={{ letterSpacing: '0.05em', animationDelay: '1s' }}
                >
                  DOMINATE.
                </span>
              </h1>

              <p className="text-xl md:text-2xl text-gray-300 max-w-3xl mx-auto mb-12 leading-relaxed">
                Enter the ultimate blockchain-powered real estate investment game. Build your
                property empire, earn real yield, and dominate the leaderboard in this
                revolutionary GameFi experience.
              </p>

              {/* CTA Buttons */}
              <div className="flex flex-col sm:flex-row gap-4 justify-center items-center mb-16">
                {isConnected ? (
                  <Link
                    href="/game"
                    className="group relative px-8 py-4 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 font-bold text-lg transition-all duration-300 hover:scale-105 shadow-2xl shadow-emerald-500/50 overflow-hidden"
                    style={{ letterSpacing: '0.08em' }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/20 to-white/0 translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-1000" />
                    <span className="relative flex items-center gap-2">
                      <Building2 className="w-5 h-5" />
                      START BUILDING
                    </span>
                  </Link>
                ) : (
                  <div className="flex justify-center">
                    <WalletConnect />
                  </div>
                )}

                <button
                  onClick={() => {
                    document
                      .getElementById('features')
                      ?.scrollIntoView({ behavior: 'smooth' });
                  }}
                  className="px-8 py-4 rounded-xl bg-white/10 hover:bg-white/20 backdrop-blur-sm border border-white/20 font-bold text-lg transition-all duration-300 hover:scale-105"
                  style={{ letterSpacing: '0.08em' }}
                >
                  Learn More
                </button>
              </div>

              {/* Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto">
                {stats.map((stat, index) => (
                  <div
                    key={index}
                    className="group p-6 rounded-xl bg-white/5 hover:bg-white/10 backdrop-blur-sm border border-white/10 hover:border-white/30 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-emerald-500/20 animate-fade-in-up"
                    style={{ animationDelay: `${index * 0.1}s` }}
                  >
                    <stat.icon className="w-8 h-8 text-emerald-400 mx-auto mb-2 group-hover:scale-110 transition-transform" />
                    <div className="text-3xl font-bold bg-gradient-to-br from-white to-gray-400 bg-clip-text text-transparent font-numbers">
                      {stat.value}
                    </div>
                    <div className="text-sm text-gray-400 mt-1">{stat.label}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Scroll Indicator */}
          <div className="absolute bottom-8 left-1/2 -translate-x-1/2 animate-bounce">
            <div className="w-6 h-10 rounded-full border-2 border-white/30 flex items-start justify-center p-2">
              <div className="w-1.5 h-1.5 rounded-full bg-white/50 animate-scroll-down" />
            </div>
          </div>
        </section>

        {/* Features Section */}
        <section id="features" className="py-24 relative">
          <div className="container mx-auto px-6">
            {/* Section Header */}
            <div className="text-center mb-16">
              <h2
                className="text-4xl md:text-6xl font-bold mb-4 bg-gradient-to-r from-emerald-400 to-teal-500 bg-clip-text text-transparent"
                style={{ letterSpacing: '0.1em' }}
              >
                GAME FEATURES
              </h2>
              <p className="text-xl text-gray-400 max-w-2xl mx-auto">
                Experience the next generation of real estate investment gaming
          </p>
        </div>

            {/* Features Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {features.map((feature, index) => (
                <div
                  key={index}
                  className="group relative p-8 rounded-2xl bg-gradient-to-br from-white/5 to-white/0 hover:from-white/10 hover:to-white/5 backdrop-blur-sm border border-white/10 hover:border-white/30 transition-all duration-500 hover:scale-105 hover:shadow-2xl hover:shadow-emerald-500/20 overflow-hidden animate-fade-in-up"
                  style={{ animationDelay: `${index * 0.1}s` }}
                >
                  {/* Gradient Glow */}
                  <div
                    className={`absolute inset-0 bg-gradient-to-br ${feature.color} opacity-0 group-hover:opacity-10 transition-opacity duration-500`}
                  />

                  {/* Icon */}
                  <div
                    className={`w-16 h-16 rounded-xl bg-gradient-to-br ${feature.color} flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300 shadow-lg`}
                  >
                    <feature.icon className="w-8 h-8 text-white" />
                  </div>

                  {/* Content */}
                  <h3
                    className="text-2xl font-bold mb-3 text-white"
                    style={{ letterSpacing: '0.05em' }}
                  >
                    {feature.title}
                  </h3>
                  <p className="text-gray-400 leading-relaxed">
                    {feature.description}
                  </p>

                  {/* Hover Border Animation */}
                  <div className="absolute inset-0 rounded-2xl border-2 border-transparent group-hover:border-white/20 transition-all duration-300" />
                </div>
              ))}
            </div>
          </div>
        </section>

        {/* RWA Integration Section */}
        <section className="py-24 relative bg-gradient-to-b from-black/0 via-emerald-900/5 to-black/0">
          <div className="container mx-auto px-6">
            <div className="text-center mb-12">
              <div className="inline-flex items-center gap-3 mb-4">
                <span className="relative flex h-4 w-4">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-500 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-4 w-4 bg-emerald-600"></span>
                </span>
                <h2
                  className="text-4xl md:text-6xl font-bold bg-gradient-to-r from-emerald-400 via-teal-500 to-cyan-500 bg-clip-text text-transparent"
                  style={{ letterSpacing: '0.1em' }}
                >
                  REAL-WORLD ASSETS
                </h2>
                <span className="relative flex h-4 w-4">
                  <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-500 opacity-75"></span>
                  <span className="relative inline-flex rounded-full h-4 w-4 bg-emerald-600"></span>
                </span>
              </div>
              <p className="text-xl text-gray-400">
                Properties backed by real-world assets  Real yield from actual investments
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
              <div className="p-6 rounded-xl bg-gradient-to-br from-emerald-500/10 to-teal-500/10 backdrop-blur-sm border border-emerald-500/20 hover:border-emerald-500/40 transition-all duration-300">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center">
                    <Landmark className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <div className="text-3xl font-bold text-white font-numbers">100%</div>
                    <div className="text-sm text-gray-400">RWA Backed</div>
                  </div>
                </div>
              </div>

              <div className="p-6 rounded-xl bg-gradient-to-br from-teal-500/10 to-cyan-500/10 backdrop-blur-sm border border-teal-500/20 hover:border-teal-500/40 transition-all duration-300">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-teal-500 to-cyan-600 flex items-center justify-center">
                    <DollarSign className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <div className="text-3xl font-bold text-emerald-400 font-numbers">5-15%</div>
                    <div className="text-sm text-gray-400">Annual Yield</div>
                  </div>
                </div>
              </div>

              <div className="p-6 rounded-xl bg-gradient-to-br from-cyan-500/10 to-blue-500/10 backdrop-blur-sm border border-cyan-500/20 hover:border-cyan-500/40 transition-all duration-300">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                    <Zap className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <div className="text-3xl font-bold text-teal-400 font-numbers flex items-center gap-2">
                      <span className="relative flex h-2 w-2">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                      </span>
                      LIVE
                    </div>
                    <div className="text-sm text-gray-400">Real-time Updates</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* CTA Section */}
        <section className="py-24 relative">
          <div className="container mx-auto px-6">
            <div className="relative overflow-hidden rounded-3xl bg-gradient-to-br from-emerald-900/40 via-teal-900/40 to-cyan-900/40 backdrop-blur-sm border border-white/20 p-12 md:p-16 text-center shadow-2xl">
              {/* Animated Background Pattern */}
              <div className="absolute inset-0 opacity-10">
                <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent animate-shimmer" />
              </div>

              <div className="relative z-10">
                <h2
                  className="text-4xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-emerald-300 via-teal-400 to-cyan-500 bg-clip-text text-transparent"
                  style={{ letterSpacing: '0.1em' }}
                >
                  READY TO BUILD YOUR EMPIRE?
                </h2>
                <p className="text-xl md:text-2xl text-gray-300 mb-10 max-w-2xl mx-auto">
                  Join thousands of players worldwide in the most exciting
                  blockchain real estate investment game
                </p>

                {isConnected ? (
                  <Link
                    href="/game"
                    className="group relative inline-flex items-center gap-3 px-10 py-5 rounded-xl bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 font-bold text-xl transition-all duration-300 hover:scale-110 shadow-2xl shadow-emerald-500/50 overflow-hidden"
                    style={{ letterSpacing: '0.1em' }}
                  >
                    <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/30 to-white/0 translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-1000" />
                    <span className="relative flex items-center gap-3">
                      <Trophy className="w-6 h-6" />
                      PLAY NOW - IT'S FREE
                      <Trophy className="w-6 h-6" />
                    </span>
                  </Link>
                ) : (
                  <div className="flex justify-center">
                    <WalletConnect />
                  </div>
                )}
              </div>
            </div>
          </div>
        </section>

        {/* Footer */}
        <footer className="py-12 border-t border-white/10 bg-black/40 backdrop-blur-sm">
          <div className="container mx-auto px-6">
            <div className="flex flex-col md:flex-row items-center justify-between gap-4">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center">
                  <Building2 className="w-6 h-6 text-white" />
                </div>
                <span
                  className="font-bold text-lg bg-gradient-to-r from-emerald-400 to-teal-500 bg-clip-text text-transparent"
                  style={{ letterSpacing: '0.1em' }}
                >
                  PROPERTY TYCOON
                </span>
              </div>

              <div className="text-sm text-gray-400">
                <span className="flex items-center gap-2">
                  <Zap className="w-4 h-4 text-emerald-400" />
                  Powered by Mantle Blockchain
                </span>
              </div>

              <div className="text-sm text-gray-500">
                 2024 Property Tycoon. All rights reserved.
              </div>
            </div>
          </div>
        </footer>
        </div>
    </div>
  );
}
</file>

<file path="frontend/package.json">
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@mantleio/viem": "^0.0.1-alpha.1",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-scroll-area": "^1.2.10",
    "@reown/appkit": "^1.8.15",
    "@reown/appkit-adapter-wagmi": "^1.8.15",
    "@tanstack/react-query": "^5.90.12",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "framer-motion": "^12.23.26",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "pixi.js": "^8.14.3",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "socket.io-client": "^4.8.3",
    "tailwind-merge": "^3.4.0",
    "viem": "^2.43.3",
    "wagmi": "^3.1.3"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  },
  "peerDependencies": {
    "@metamask/sdk": "^0.33.1"
  }
}
</file>

<file path="frontend/src/config/index.tsx">
'use client'

import { WagmiAdapter } from '@reown/appkit-adapter-wagmi'
import { mantle, mantleSepoliaTestnet } from '@reown/appkit/networks'

// Get project ID from environment variable
export const projectId = process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID || ''

// Create Reown AppKit Wagmi adapter
export const wagmiAdapter = new WagmiAdapter({
  networks: [mantle, mantleSepoliaTestnet],
  projectId,
})
</file>

<file path="frontend/src/lib/api.ts">
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';

export const api = {
  async get(endpoint: string) {
    const response = await fetch(`${API_URL}${endpoint}`);
    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
    return response.json();
  },

  async post(endpoint: string, data?: any) {
    const options: RequestInit = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    };
    if (data) {
      options.body = JSON.stringify(data);
    }
    const response = await fetch(`${API_URL}${endpoint}`, options);
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`API error: ${response.statusText} - ${errorText}`);
    }
    return response.json();
  },

  async put(endpoint: string, data: any) {
    const response = await fetch(`${API_URL}${endpoint}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
    });
    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
    return response.json();
  },
};
</file>

<file path="frontend/src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

export function formatAddress(address: string): string {
  if (!address) return '';
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}
</file>

<file path="backend/nixpacks.toml">
[phases.setup]
nixPkgs = ["nodejs_20", "npm"]

[phases.install]
cmds = ["npm ci"]

[phases.build]
cmds = ["npm run build"]

[start]
cmd = "npm run start:prod"
</file>

<file path="backend/Procfile">
web: npm run start:prod
</file>

<file path="backend/railway.json">
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "startCommand": "npm run start:prod",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
</file>

<file path="backend/src/app.module.ts">
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { DatabaseModule } from './database/database.module';
import { MantleModule } from './mantle/mantle.module';
import { ContractsModule } from './contracts/contracts.module';
import { PropertiesModule } from './properties/properties.module';
import { YieldModule } from './yield/yield.module';
import { MarketplaceModule } from './marketplace/marketplace.module';
import { QuestsModule } from './quests/quests.module';
import { LeaderboardModule } from './leaderboard/leaderboard.module';
import { ChatModule } from './chat/chat.module';
import { GuildsModule } from './guilds/guilds.module';
import { UsersModule } from './users/users.module';
import { WebsocketModule } from './websocket/websocket.module';
import { EventsModule } from './events/events.module';

@Module({
  imports: [
    ConfigModule.forRoot({ isGlobal: true }),
    WebsocketModule,
    DatabaseModule,
    MantleModule,
    ContractsModule,
    PropertiesModule,
    YieldModule,
    MarketplaceModule,
    QuestsModule,
    LeaderboardModule,
    ChatModule,
    GuildsModule,
    UsersModule,
    EventsModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
</file>

<file path="backend/src/database/schema/guilds.schema.ts">
import { pgTable, uuid, varchar, text, bigint, integer, boolean, timestamp, numeric } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

export const guilds = pgTable('guilds', {
  id: uuid('id').defaultRandom().primaryKey(),
  name: varchar('name', { length: 100 }).notNull().unique(),
  description: text('description'),
  ownerId: uuid('owner_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  totalMembers: integer('total_members').default(0).notNull(),
  totalPortfolioValue: numeric('total_portfolio_value').default('0').notNull(),
  totalYieldEarned: numeric('total_yield_earned').default('0').notNull(),
  isPublic: boolean('is_public').default(true).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export const guildMembers = pgTable('guild_members', {
  id: uuid('id').defaultRandom().primaryKey(),
  guildId: uuid('guild_id')
    .notNull()
    .references(() => guilds.id, { onDelete: 'cascade' }),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  role: varchar('role', { length: 50 }).default('member').notNull(), // owner, admin, member
  contribution: numeric('contribution').default('0').notNull(), // Use numeric to return strings (like properties.value)
  joinedAt: timestamp('joined_at').defaultNow().notNull(),
});

export type Guild = typeof guilds.$inferSelect;
export type NewGuild = typeof guilds.$inferInsert;
export type GuildMember = typeof guildMembers.$inferSelect;
export type NewGuildMember = typeof guildMembers.$inferInsert;
</file>

<file path="backend/src/database/schema/properties.schema.ts">
import { pgTable, uuid, varchar, bigint, integer, boolean, timestamp, numeric } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

export const properties = pgTable('properties', {
  id: uuid('id').defaultRandom().primaryKey(),
  tokenId: bigint('token_id', { mode: 'number' }).notNull().unique(),
  ownerId: uuid('owner_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  propertyType: varchar('property_type', { length: 50 }).notNull(), // Residential, Commercial, Industrial, Luxury
  value: numeric('value').notNull(), // Use numeric to handle very large values (e.g., 100 * 10^18)
  yieldRate: integer('yield_rate').notNull(), // Basis points (e.g., 500 = 5%)
  rwaContract: varchar('rwa_contract', { length: 42 }),
  rwaTokenId: bigint('rwa_token_id', { mode: 'number' }),
  totalYieldEarned: bigint('total_yield_earned', { mode: 'bigint' }).default(BigInt(0)).notNull(),
  x: integer('x'), // X coordinate on the map
  y: integer('y'), // Y coordinate on the map
  isActive: boolean('is_active').default(true).notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
});

export type Property = typeof properties.$inferSelect;
export type NewProperty = typeof properties.$inferInsert;
</file>

<file path="backend/src/guilds/guilds.module.ts">
import { Module } from '@nestjs/common';
import { GuildsController } from './guilds.controller';
import { GuildsService } from './guilds.service';
import { DatabaseModule } from '../database/database.module';
import { ContractsModule } from '../contracts/contracts.module';

@Module({
  imports: [DatabaseModule, ContractsModule],
  controllers: [GuildsController],
  providers: [GuildsService],
  exports: [GuildsService],
})
export class GuildsModule {}
</file>

<file path="backend/src/marketplace/marketplace.service.ts">
import { Injectable, Logger, Inject, forwardRef } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, and } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';
import { PropertiesService } from '../properties/properties.service';

@Injectable()
export class MarketplaceService {
  private readonly logger = new Logger(MarketplaceService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
    @Inject(forwardRef(() => PropertiesService)) private propertiesService: PropertiesService,
  ) {}

  async syncListingsFromBlockchain() {
    try {
      this.logger.log(' Syncing marketplace listings from blockchain...');
      
      if (!this.contractsService.marketplace) {
        this.logger.error('Marketplace contract not initialized');
        throw new Error('Marketplace contract not initialized');
      }

      if (!this.contractsService.propertyNFT) {
        this.logger.error('PropertyNFT contract not initialized');
        throw new Error('PropertyNFT contract not initialized');
      }

      const marketplaceAddress = this.contractsService.marketplace.address;
      this.logger.log(`Using marketplace address: ${marketplaceAddress}`);
      this.logger.log(`Marketplace address check: Is it the new one (0xe9E855ff6EB78055AaE90631468BfC948A1446Bb)? ${marketplaceAddress.toLowerCase() === '0xe9e855ff6eb78055aae90631468bfc948a1446bb' ? 'YES' : 'NO'}`);

      // NEW ARCHITECTURE: Try getActiveListings() first (like frontend), then fallback to direct property ownership check
      this.logger.log(' NEW ARCHITECTURE: Try getActiveListings() first (most efficient), then fallback to direct property ownership check');
      
      let propertyIds: bigint[] = [];
      let sellers: string[] = [];
      let prices: bigint[] = [];

      // METHOD 1: Try getActiveListings() first (same as frontend)
      try {
        this.logger.log(' Method 1: Calling marketplace.getActiveListings()...');
        const activeListingsData = await this.contractsService.marketplace.getActiveListings() as any;
        
        this.logger.log(`getActiveListings() returned:`, typeof activeListingsData, Array.isArray(activeListingsData));
        
        if (Array.isArray(activeListingsData) && activeListingsData.length >= 3) {
          propertyIds = Array.isArray(activeListingsData[0]) 
            ? activeListingsData[0].map((id: any) => {
                const idStr = id?.toString() || id?._hex || id;
                return BigInt(idStr);
              })
            : [];
          sellers = Array.isArray(activeListingsData[1]) 
            ? activeListingsData[1].map((s: any) => s?.toString() || s)
            : [];
          prices = Array.isArray(activeListingsData[2]) 
            ? activeListingsData[2].map((p: any) => {
                const pStr = p?.toString() || p?._hex || p;
                return BigInt(pStr);
              })
            : [];
          this.logger.log(` Method 1 SUCCESS: getActiveListings() returned ${propertyIds.length} listings`);
          this.logger.log(`   Property IDs: ${propertyIds.map(id => id.toString()).join(', ')}`);
        } else {
          this.logger.warn('getActiveListings() returned unexpected format, trying Method 2...');
        }
      } catch (error: any) {
        this.logger.warn(`Method 1 failed: getActiveListings() error: ${error.message}`);
        this.logger.warn('Falling back to Method 2: Direct property ownership check...');
      }

      // METHOD 2: If getActiveListings() didn't work, use direct property ownership check
      if (propertyIds.length === 0) {
        try {
          // Step 1: Get all properties owned by the marketplace contract using PropertyNFT.getOwnerProperties()
          this.logger.log(` Method 2: Calling propertyNFT.getOwnerProperties(${marketplaceAddress})...`);
          const ownedProperties = await this.contractsService.getOwnerProperties(marketplaceAddress) as any;
        
        // Handle different return types from ethers.js
        let ownedPropertyIds: bigint[] = [];
        if (Array.isArray(ownedProperties)) {
          ownedPropertyIds = ownedProperties.map((id: any) => {
            const idStr = id?.toString() || id?._hex || id;
            return BigInt(idStr);
          });
        } else if (ownedProperties && typeof ownedProperties === 'object') {
          if ('_hex' in ownedProperties) {
            ownedPropertyIds = [BigInt(ownedProperties._hex)];
          } else if (Array.isArray(Object.values(ownedProperties))) {
            ownedPropertyIds = Object.values(ownedProperties).map((id: any) => BigInt(id?.toString() || id?._hex || id));
          }
        }

        this.logger.log(`Found ${ownedPropertyIds.length} properties owned by marketplace contract`);

        if (ownedPropertyIds.length === 0) {
          this.logger.log('No properties owned by marketplace - no active listings');
          return { synced: 0, errors: 0 };
        }

        // Step 2: For each property, check if it has an active listing using marketplace.listings()
        for (const propertyId of ownedPropertyIds) {
          try {
            this.logger.log(`Checking listing for property #${propertyId.toString()}...`);
            const listing = await this.contractsService.marketplace.listings(propertyId) as any;
            
            // listings mapping returns: (propertyId, seller, price, isActive, createdAt)
            let isActive = false;
            let seller = '';
            let price = BigInt(0);

            if (listing && Array.isArray(listing) && listing.length >= 4) {
              isActive = listing[3] === true || listing[3] === 'true' || listing[3] === 1 || listing[3] === '1';
              seller = listing[1]?.toString() || '';
              const priceValue = listing[2];
              if (priceValue) {
                price = BigInt(priceValue?.toString() || priceValue?._hex || '0');
              }
            } else if (listing && typeof listing === 'object') {
              // Handle object format
              isActive = listing.isActive === true || listing.isActive === 'true' || listing.isActive === 1 || listing.isActive === '1';
              seller = listing.seller?.toString() || '';
              const priceValue = listing.price;
              if (priceValue) {
                price = BigInt(priceValue?.toString() || priceValue?._hex || '0');
              }
            }

            if (isActive && seller && price > 0) {
              propertyIds.push(propertyId);
              sellers.push(seller);
              prices.push(price);
              this.logger.log(` Active listing: Property #${propertyId.toString()}, Seller: ${seller}, Price: ${price.toString()} wei`);
            } else {
              this.logger.log(` Property #${propertyId.toString()} owned by marketplace but not actively listed (isActive: ${isActive}, seller: ${seller || 'none'}, price: ${price.toString()})`);
            }
          } catch (error: any) {
            this.logger.warn(`Error checking listing for property ${propertyId.toString()}: ${error.message}`);
          }
        }

        this.logger.log(` Method 2 SUCCESS: Found ${propertyIds.length} active listings from ${ownedPropertyIds.length} marketplace-owned properties`);
        } catch (error: any) {
          this.logger.error(`Method 2 failed: Error in direct property ownership check: ${error.message}`);
          this.logger.error(`Stack: ${error.stack}`);
        }
      }

      this.logger.log(`Found ${propertyIds.length} active listings on-chain`);

      let syncedCount = 0;
      let errorCount = 0;

      for (let i = 0; i < propertyIds.length; i++) {
        try {
          const propertyId = Number(propertyIds[i]);
          const seller = sellers[i].toLowerCase();
          const price = prices[i].toString();

          // Check if property exists in database
          let [property] = await this.db
            .select()
            .from(schema.properties)
            .where(eq(schema.properties.tokenId, propertyId))
            .limit(1);

          if (!property) {
            // Property doesn't exist, sync it first
            this.logger.log(`Property ${propertyId} not in DB, syncing from blockchain...`);
            await this.propertiesService.syncFromChain(seller);
            
            // Try again
            [property] = await this.db
              .select()
              .from(schema.properties)
              .where(eq(schema.properties.tokenId, propertyId))
              .limit(1);
          }

          if (!property) {
            this.logger.warn(`Property ${propertyId} still not found after sync, skipping...`);
            errorCount++;
            continue;
          }

          // Check if listing exists
          const [existing] = await this.db
            .select()
            .from(schema.marketplaceListings)
            .where(eq(schema.marketplaceListings.propertyId, property.id))
            .limit(1);

          if (existing) {
            // Update existing listing
            await this.db
              .update(schema.marketplaceListings)
              .set({
                price: price,
                isActive: true,
                updatedAt: new Date(),
              })
              .where(eq(schema.marketplaceListings.propertyId, property.id));
          } else {
            // Create new listing
            await this.db.insert(schema.marketplaceListings).values({
              propertyId: property.id,
              sellerId: property.ownerId,
              price: price,
              isActive: true,
              listingType: 'fixed',
              createdAt: new Date(),
              updatedAt: new Date(),
            });
          }

          syncedCount++;
          this.logger.log(` Synced listing for property ${propertyId}`);
        } catch (error) {
          this.logger.error(`Error syncing listing for property ${propertyIds[i]}: ${error.message}`);
          errorCount++;
        }
      }

      this.logger.log(` Sync complete: ${syncedCount} synced, ${errorCount} errors`);
      return { synced: syncedCount, errors: errorCount };
    } catch (error) {
      this.logger.error(`Error syncing listings from blockchain: ${error.message}`);
      throw error;
    }
  }

  async getActiveListings() {
    try {
      // Get active listings from database with property and seller details
      const listings = await this.db
        .select({
          id: schema.marketplaceListings.id,
          propertyId: schema.marketplaceListings.propertyId,
          sellerId: schema.marketplaceListings.sellerId,
          price: schema.marketplaceListings.price,
          isActive: schema.marketplaceListings.isActive,
          listingType: schema.marketplaceListings.listingType,
          auctionEndTime: schema.marketplaceListings.auctionEndTime,
          highestBid: schema.marketplaceListings.highestBid,
          highestBidderId: schema.marketplaceListings.highestBidderId,
          createdAt: schema.marketplaceListings.createdAt,
          updatedAt: schema.marketplaceListings.updatedAt,
          property: {
            id: schema.properties.id,
            tokenId: schema.properties.tokenId,
            propertyType: schema.properties.propertyType,
            value: schema.properties.value,
            yieldRate: schema.properties.yieldRate,
          },
          seller: {
            id: schema.users.id,
            walletAddress: schema.users.walletAddress,
            username: schema.users.username,
          },
        })
        .from(schema.marketplaceListings)
        .innerJoin(schema.properties, eq(schema.marketplaceListings.propertyId, schema.properties.id))
        .innerJoin(schema.users, eq(schema.marketplaceListings.sellerId, schema.users.id))
        .where(eq(schema.marketplaceListings.isActive, true));

      // Validate each listing against the contract (source of truth)
      const validatedListings: typeof listings = [];
      for (const listing of listings) {
        try {
          const tokenId = Number(listing.property.tokenId);
          
          // Check if listing is actually active on-chain
          const contractListing = await this.contractsService.getMarketplaceListing(tokenId);
          
          if (contractListing && contractListing.isActive) {
            // Listing is active on-chain, include it
            validatedListings.push(listing);
          } else {
            // Listing is not active on-chain, mark as inactive in database
            this.logger.warn(`Listing for property ${tokenId} is inactive on-chain, updating database...`);
            await this.db
              .update(schema.marketplaceListings)
              .set({ isActive: false, updatedAt: new Date() })
              .where(eq(schema.marketplaceListings.propertyId, listing.property.id));
          }
        } catch (error) {
          this.logger.error(`Error validating listing for property ${listing.property.tokenId}: ${error.message}`);
          // If validation fails, exclude the listing to be safe
        }
      }

      // Format for frontend
      return validatedListings.map((listing) => ({
        id: listing.id,
        propertyId: listing.property.tokenId.toString(),
        property: {
          tokenId: Number(listing.property.tokenId),
          propertyType: listing.property.propertyType,
          value: listing.property.value?.toString() || '0',
          yieldRate: Number(listing.property.yieldRate),
        },
        seller: {
          walletAddress: listing.seller.walletAddress,
          username: listing.seller.username,
        },
        price: listing.price?.toString() || '0',
        listingType: listing.listingType === 'fixed' ? 'fixed' : 'auction',
        auctionEndTime: listing.auctionEndTime,
        highestBid: listing.highestBid?.toString(),
        isActive: listing.isActive,
      }));
    } catch (error) {
      this.logger.error(`Error getting active listings: ${error.message}`);
      throw error;
    }
  }

  async getListing(propertyId: number) {
    try {
      // Get listing from database by propertyId
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, propertyId))
        .limit(1);

      if (!property) {
        return null;
      }

      const [listing] = await this.db
        .select()
        .from(schema.marketplaceListings)
        .where(eq(schema.marketplaceListings.propertyId, property.id))
        .limit(1);

      return listing;
    } catch (error) {
      this.logger.error(`Error getting listing: ${error.message}`);
      throw error;
    }
  }

  async debugMarketplaceState() {
    try {
      if (!this.contractsService.marketplace || !this.contractsService.propertyNFT) {
        return { error: 'Contracts not initialized' };
      }

      const marketplaceAddress = this.contractsService.marketplace.address;
      const debugInfo: any = {
        marketplaceAddress,
        isNewAddress: marketplaceAddress.toLowerCase() === '0xe9e855ff6eb78055aae90631468bfc948a1446bb',
      };

      // Try getActiveListings()
      try {
        const activeListings = await this.contractsService.marketplace.getActiveListings() as any;
        debugInfo.getActiveListings = {
          success: true,
          type: typeof activeListings,
          isArray: Array.isArray(activeListings),
          length: Array.isArray(activeListings) ? activeListings.length : 'N/A',
          rawData: activeListings,
        };
      } catch (error: any) {
        debugInfo.getActiveListings = {
          success: false,
          error: error.message,
        };
      }

      // Try getOwnerProperties()
      try {
        const ownedProperties = await this.contractsService.getOwnerProperties(marketplaceAddress) as any;
        debugInfo.getOwnerProperties = {
          success: true,
          type: typeof ownedProperties,
          isArray: Array.isArray(ownedProperties),
          length: Array.isArray(ownedProperties) ? ownedProperties.length : 'N/A',
          rawData: ownedProperties,
        };
      } catch (error: any) {
        debugInfo.getOwnerProperties = {
          success: false,
          error: error.message,
        };
      }

      return debugInfo;
    } catch (error: any) {
      return { error: error.message };
    }
  }

  async getAuction(propertyId: number) {
    try {
      const listing = await this.getListing(propertyId);
      if (!listing || listing.listingType !== 'auction') {
        return null;
      }
      return listing;
    } catch (error) {
      this.logger.error(`Error getting auction: ${error.message}`);
      throw error;
    }
  }
}
</file>

<file path="backend/src/users/users.controller.ts">
import { Controller, Get, Put, Param, Body } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { UsersService, UserProfileDto } from './users.service';

@ApiTags('users')
@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Get('profile/:walletAddress')
  @ApiOperation({ summary: 'Get user profile' })
  @ApiResponse({ status: 200, description: 'User profile', type: Object })
  async getProfile(@Param('walletAddress') walletAddress: string): Promise<UserProfileDto | null> {
    return this.usersService.getProfile(walletAddress);
  }

  @Put('profile/:walletAddress/username')
  @ApiOperation({ summary: 'Update username' })
  @ApiResponse({ status: 200, description: 'Username updated successfully' })
  async updateUsername(
    @Param('walletAddress') walletAddress: string,
    @Body('username') username: string,
  ): Promise<UserProfileDto> {
    return this.usersService.updateUsername(walletAddress, username);
  }
}
</file>

<file path="backend/src/users/users.module.ts">
import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';
import { UsersService } from './users.service';
import { DatabaseModule } from '../database/database.module';

@Module({
  imports: [DatabaseModule],
  controllers: [UsersController],
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}
</file>

<file path="backend/src/users/users.service.ts">
import { Injectable, Logger, Inject } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq } from 'drizzle-orm';

export interface UserProfileDto {
  id: string;
  walletAddress: string;
  username?: string;
  avatar: string;
  totalPortfolioValue: string;
  totalYieldEarned: string;
  propertiesOwned: number;
  createdAt: Date;
  updatedAt: Date;
}

@Injectable()
export class UsersService {
  private readonly logger = new Logger(UsersService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
  ) {}

  async getProfile(walletAddress: string): Promise<UserProfileDto | null> {
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      return null;
    }

    // Generate avatar URL using dicebear (using wallet address as seed)
    const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.walletAddress}`;

    return {
      id: user.id,
      walletAddress: user.walletAddress,
      username: user.username || undefined,
      avatar: avatarUrl,
      totalPortfolioValue: user.totalPortfolioValue?.toString() || '0',
      totalYieldEarned: user.totalYieldEarned?.toString() || '0',
      propertiesOwned: user.propertiesOwned || 0,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
    };
  }

  async updateUsername(walletAddress: string, username: string): Promise<UserProfileDto> {
    // Validate username
    if (!username || username.trim().length === 0) {
      throw new Error('Username cannot be empty');
    }

    if (username.length > 100) {
      throw new Error('Username must be 100 characters or less');
    }

    // Check if username is already taken
    const [existingUser] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.username, username.trim()))
      .limit(1);

    if (existingUser && existingUser.walletAddress.toLowerCase() !== walletAddress.toLowerCase()) {
      throw new Error('Username is already taken');
    }

    // Get or create user
    let [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      // Create new user
      [user] = await this.db
        .insert(schema.users)
        .values({
          walletAddress: walletAddress.toLowerCase(),
          username: username.trim(),
          createdAt: new Date(),
          updatedAt: new Date(),
        })
        .returning();
    } else {
      // Update existing user
      [user] = await this.db
        .update(schema.users)
        .set({
          username: username.trim(),
          updatedAt: new Date(),
        })
        .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
        .returning();
    }

    // Generate avatar URL
    const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.walletAddress}`;

    return {
      id: user.id,
      walletAddress: user.walletAddress,
      username: user.username || undefined,
      avatar: avatarUrl,
      totalPortfolioValue: user.totalPortfolioValue?.toString() || '0',
      totalYieldEarned: user.totalYieldEarned?.toString() || '0',
      propertiesOwned: user.propertiesOwned || 0,
      createdAt: user.createdAt,
      updatedAt: user.updatedAt,
    };
  }
}
</file>

<file path="contracts/script/DeployYieldDistributor.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {YieldDistributor} from "../src/YieldDistributor.sol";

contract DeployYieldDistributorScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Deploying UPDATED YieldDistributor with RWA integration to Mantle Sepolia...");
        console.log("Deployer:", vm.addr(deployerPrivateKey));
        
        // Existing contract addresses (Mantle Sepolia Testnet)
        address propertyNFT = 0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c;
        address gameToken = 0x3334f87178AD0f33e61009777a3dFa1756e9c23f;
        
        console.log("Using PropertyNFT:", propertyNFT);
        console.log("Using GameToken:", gameToken);
        
        // Deploy NEW YieldDistributor with RWA yield integration
        // This version uses RWA data for yield calculation when property is linked to RWA
        YieldDistributor yieldDistributor = new YieldDistributor(
            propertyNFT,
            gameToken
        );
        
        console.log("\n=== NEW YieldDistributor Deployed (with RWA integration) ===");
        console.log("Address:", address(yieldDistributor));
        console.log("\nFeatures:");
        console.log("  - Uses RWA value and yield rate when property linked to RWA");
        console.log("  - Falls back to property data if not linked");
        console.log("  - Backward compatible with existing properties");
        console.log("\nIMPORTANT: Update these files with the new address:");
        console.log("  1. frontend/.env.local -> NEXT_PUBLIC_YIELD_DISTRIBUTOR_ADDRESS");
        console.log("  2. backend/.env -> YIELD_DISTRIBUTOR_ADDRESS");
        console.log("  3. frontend/src/lib/contracts.ts -> CONTRACTS.YieldDistributor (fallback)");
        console.log("  4. contracts/README.md -> YieldDistributor address");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/FixQuestSystemPropertyNFT.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {QuestSystem} from "../src/QuestSystem.sol";

/**
 * @title FixQuestSystemPropertyNFT
 * @notice Update QuestSystem to use the new PropertyNFT address
 */
contract FixQuestSystemPropertyNFT is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address questSystemAddress = vm.envAddress("QUEST_SYSTEM_ADDRESS");
        address newPropertyNFTAddress = vm.envAddress("PROPERTY_NFT_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Updating QuestSystem PropertyNFT Address");
        console.log("==========================================");
        console.log("QuestSystem Address:", questSystemAddress);
        console.log("New PropertyNFT Address:", newPropertyNFTAddress);
        
        QuestSystem questSystem = QuestSystem(questSystemAddress);
        
        // Check if QuestSystem has setPropertyNFT function
        // If not, we'll need to redeploy with correct address
        address currentPropertyNFT = address(questSystem.propertyNFT());
        console.log("Current PropertyNFT in QuestSystem:", currentPropertyNFT);
        
        if (currentPropertyNFT != newPropertyNFTAddress) {
            console.log("\nWARNING: QuestSystem is using old PropertyNFT address!");
            console.log("QuestSystem does not have a setter function.");
            console.log("You need to redeploy QuestSystem with the new PropertyNFT address.");
        } else {
            console.log("\nQuestSystem is already using the correct PropertyNFT address.");
        }
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/InitializePropertyCosts.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";

/**
 * @title InitializePropertyCosts
 * @notice Script to initialize propertyCosts mapping in PropertyNFT contract
 * @dev Run this if propertyCosts were not set during deployment
 */
contract InitializePropertyCosts is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address propertyNFTAddress = vm.envAddress("PROPERTY_NFT_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Initializing Property Costs");
        console.log("==========================================");
        console.log("PropertyNFT Address:", propertyNFTAddress);
        
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddress);
        
        // Set property costs (in TYCOON tokens with 18 decimals)
        console.log("\nSetting Residential cost: 100 TYCOON");
        propertyNFT.setPropertyCost(PropertyNFT.PropertyType.Residential, 100 * 10**18);
        
        console.log("Setting Commercial cost: 200 TYCOON");
        propertyNFT.setPropertyCost(PropertyNFT.PropertyType.Commercial, 200 * 10**18);
        
        console.log("Setting Industrial cost: 500 TYCOON");
        propertyNFT.setPropertyCost(PropertyNFT.PropertyType.Industrial, 500 * 10**18);
        
        console.log("Setting Luxury cost: 1000 TYCOON");
        propertyNFT.setPropertyCost(PropertyNFT.PropertyType.Luxury, 1000 * 10**18);
        
        // Verify costs were set
        console.log("\nVerifying costs...");
        uint256 residentialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Residential);
        uint256 commercialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Commercial);
        uint256 industrialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Industrial);
        uint256 luxuryCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Luxury);
        
        console.log("Residential cost:", residentialCost);
        console.log("Commercial cost:", commercialCost);
        console.log("Industrial cost:", industrialCost);
        console.log("Luxury cost:", luxuryCost);
        
        require(residentialCost > 0, "Residential cost not set");
        require(commercialCost > 0, "Commercial cost not set");
        require(industrialCost > 0, "Industrial cost not set");
        require(luxuryCost > 0, "Luxury cost not set");
        
        console.log("\n==========================================");
        console.log("Property costs initialized successfully!");
        console.log("==========================================");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/RedeployPropertyNFT.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";
import {GameToken} from "../src/GameToken.sol";

/**
 * @title RedeployPropertyNFT
 * @notice Redeploy PropertyNFT with propertyCosts initialized in constructor
 */
contract RedeployPropertyNFT is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("==========================================");
        console.log("Redeploying PropertyNFT");
        console.log("==========================================");
        
        // Deploy new PropertyNFT (constructor will initialize propertyCosts)
        PropertyNFT propertyNFT = new PropertyNFT();
        console.log("New PropertyNFT deployed at:", address(propertyNFT));
        
        // Set GameToken address
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        propertyNFT.setGameToken(gameTokenAddress);
        console.log("GameToken set to:", gameTokenAddress);
        
        // Verify propertyCosts are initialized
        console.log("\nVerifying propertyCosts...");
        uint256 residentialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Residential);
        uint256 commercialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Commercial);
        uint256 industrialCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Industrial);
        uint256 luxuryCost = propertyNFT.propertyCosts(PropertyNFT.PropertyType.Luxury);
        
        console.log("Residential cost:", residentialCost);
        console.log("Commercial cost:", commercialCost);
        console.log("Industrial cost:", industrialCost);
        console.log("Luxury cost:", luxuryCost);
        
        require(residentialCost > 0, "Residential cost not set");
        require(commercialCost > 0, "Commercial cost not set");
        require(industrialCost > 0, "Industrial cost not set");
        require(luxuryCost > 0, "Luxury cost not set");
        
        console.log("\n==========================================");
        console.log("PropertyNFT redeployed successfully!");
        console.log("==========================================");
        console.log("\nNew PropertyNFT Address:", address(propertyNFT));
        console.log("\nNext Steps:");
        console.log("1. Update frontend/.env.local with new address");
        console.log("2. Update backend/.env with new address");
        console.log("3. Update frontend/src/lib/contracts.ts with new address");
        console.log("4. Update YieldDistributor to use new PropertyNFT address");
        console.log("5. Update Marketplace to use new PropertyNFT address");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/src/PropertyNFT.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";

contract PropertyNFT is ERC721, Ownable, ReentrancyGuard {
    IERC20 public gameToken;
    
    // Property costs in TYCOON tokens (with 18 decimals)
    mapping(PropertyType => uint256) public propertyCosts;
    uint256 private _tokenIdCounter;
    
    enum PropertyType { Residential, Commercial, Industrial, Luxury }
    
    struct Property {
        PropertyType propertyType;
        uint256 value;
        uint256 yieldRate;
        address rwaContract;
        uint256 rwaTokenId;
        uint256 totalYieldEarned;
        uint256 createdAt;
        bool isActive;
    }
    
    mapping(uint256 => Property) public properties;
    mapping(address => uint256[]) public ownerProperties;
    mapping(PropertyType => uint256) public propertyTypeCounts;
    
    event PropertyCreated(uint256 indexed tokenId, address indexed owner, PropertyType propertyType, uint256 value);
    event PropertyLinkedToRWA(uint256 indexed tokenId, address rwaContract, uint256 rwaTokenId);
    event PropertyUpgraded(uint256 indexed tokenId, PropertyType newType, uint256 newValue);
    event PropertiesBatchMinted(address indexed owner, uint256[] tokenIds);
    event PropertyPurchased(uint256 indexed tokenId, address indexed buyer, PropertyType propertyType, uint256 cost);
    
    constructor() ERC721("PropertyNFT", "PROP") Ownable(msg.sender) {
        // Set property costs (in TYCOON tokens with 18 decimals)
        propertyCosts[PropertyType.Residential] = 100 * 10**18;  // 100 TYCOON
        propertyCosts[PropertyType.Commercial] = 200 * 10**18;  // 200 TYCOON
        propertyCosts[PropertyType.Industrial] = 500 * 10**18; // 500 TYCOON
        propertyCosts[PropertyType.Luxury] = 1000 * 10**18;     // 1000 TYCOON
    }
    
    /**
     * @notice Set the game token address (for existing deployments)
     * @dev Only owner can call this - allows updating existing contract
     */
    function setGameToken(address _gameToken) public onlyOwner {
        gameToken = IERC20(_gameToken);
    }
    
    /**
     * @notice Set property cost for a property type (for existing deployments)
     * @dev Only owner can call this - allows initializing propertyCosts after deployment
     */
    function setPropertyCost(PropertyType propertyType, uint256 cost) public onlyOwner {
        propertyCosts[propertyType] = cost;
    }
    
    /**
     * @notice Purchase and mint a property by paying TYCOON tokens
     * @param propertyType The type of property to purchase
     * @param value The property value (used for yield calculation)
     * @param yieldRate The yield rate in basis points (e.g., 500 = 5%)
     */
    function purchaseProperty(
        PropertyType propertyType,
        uint256 value,
        uint256 yieldRate
    ) public nonReentrant returns (uint256) {
        require(address(gameToken) != address(0), "Game token not set");
        uint256 cost = propertyCosts[propertyType];
        require(cost > 0, "Invalid property type");
        
        // Check user has enough TYCOON tokens
        require(gameToken.balanceOf(msg.sender) >= cost, "Insufficient TYCOON balance");
        
        // Transfer TYCOON tokens from user to contract
        require(gameToken.transferFrom(msg.sender, address(this), cost), "Token transfer failed");
        
        // Mint property to user
        uint256 tokenId = _tokenIdCounter++;
        _safeMint(msg.sender, tokenId);
        
        properties[tokenId] = Property({
            propertyType: propertyType,
            value: value,
            yieldRate: yieldRate,
            rwaContract: address(0),
            rwaTokenId: 0,
            totalYieldEarned: 0,
            createdAt: block.timestamp,
            isActive: true
        });
        
        ownerProperties[msg.sender].push(tokenId);
        propertyTypeCounts[propertyType]++;
        
        emit PropertyCreated(tokenId, msg.sender, propertyType, value);
        emit PropertyPurchased(tokenId, msg.sender, propertyType, cost);
        
        return tokenId;
    }
    
    /**
     * @notice Owner can withdraw TYCOON tokens collected from property purchases
     */
    function withdrawTokens() public onlyOwner {
        uint256 balance = gameToken.balanceOf(address(this));
        require(balance > 0, "No tokens to withdraw");
        require(gameToken.transfer(owner(), balance), "Token transfer failed");
    }
    
    function mintProperty(
        address to,
        PropertyType propertyType,
        uint256 value,
        uint256 yieldRate
    ) public onlyOwner returns (uint256) {
        uint256 tokenId = _tokenIdCounter++;
        _safeMint(to, tokenId);
        
        properties[tokenId] = Property({
            propertyType: propertyType,
            value: value,
            yieldRate: yieldRate,
            rwaContract: address(0),
            rwaTokenId: 0,
            totalYieldEarned: 0,
            createdAt: block.timestamp,
            isActive: true
        });
        
        ownerProperties[to].push(tokenId);
        propertyTypeCounts[propertyType]++;
        
        emit PropertyCreated(tokenId, to, propertyType, value);
        return tokenId;
    }
    
    function batchMintProperties(
        address to,
        PropertyType[] calldata propertyTypes,
        uint256[] calldata values,
        uint256[] calldata yieldRates
    ) public onlyOwner returns (uint256[] memory) {
        require(propertyTypes.length == values.length && values.length == yieldRates.length, "Array length mismatch");
        require(propertyTypes.length > 0 && propertyTypes.length <= 50, "Invalid batch size");
        
        uint256[] memory tokenIds = new uint256[](propertyTypes.length);
        
        for (uint256 i = 0; i < propertyTypes.length; i++) {
            uint256 tokenId = _tokenIdCounter++;
            _safeMint(to, tokenId);
            
            properties[tokenId] = Property({
                propertyType: propertyTypes[i],
                value: values[i],
                yieldRate: yieldRates[i],
                rwaContract: address(0),
                rwaTokenId: 0,
                totalYieldEarned: 0,
                createdAt: block.timestamp,
                isActive: true
            });
            
            ownerProperties[to].push(tokenId);
            propertyTypeCounts[propertyTypes[i]]++;
            tokenIds[i] = tokenId;
        }
        
        emit PropertiesBatchMinted(to, tokenIds);
        return tokenIds;
    }
    
    /**
     * @notice Link a property NFT to a Real-World Asset (RWA)
     * @dev Validates that RWA contract exists and follows standards (ERC-721/ERC-1155)
     * @param tokenId Property NFT token ID
     * @param rwaContract Address of the RWA contract
     * @param rwaTokenId Token ID in the RWA contract
     */
    function linkToRWA(
        uint256 tokenId,
        address rwaContract,
        uint256 rwaTokenId
    ) public {
        require(ownerOf(tokenId) == msg.sender, "Not owner");
        require(properties[tokenId].isActive, "Property not active");
        require(rwaContract != address(0), "Invalid RWA contract");
        require(rwaContract.code.length > 0, "RWA contract does not exist");
        
        // Validate RWA contract follows NFT standards (ERC-721 or ERC-1155)
        // This ensures we're linking to a valid tokenized asset
        _validateRWAContract(rwaContract, rwaTokenId);
        
        properties[tokenId].rwaContract = rwaContract;
        properties[tokenId].rwaTokenId = rwaTokenId;
        emit PropertyLinkedToRWA(tokenId, rwaContract, rwaTokenId);
    }
    
    /**
     * @notice Internal function to validate RWA contract
     * @dev Checks if contract implements ERC-721 or ERC-1155 standards
     * @param rwaContract Address of the RWA contract
     * @param rwaTokenId Token ID to validate
     */
    function _validateRWAContract(address rwaContract, uint256 rwaTokenId) internal view {
        // Try to check if contract supports ERC-165 (interface detection)
        (bool success, bytes memory data) = rwaContract.staticcall(
            abi.encodeWithSignature("supportsInterface(bytes4)", 0x01ffc9a7) // ERC-165
        );
        
        if (success && data.length > 0) {
            bool supportsERC165 = abi.decode(data, (bool));
            if (supportsERC165) {
                // Check for ERC-721 support (0x80ac58cd)
                (success, data) = rwaContract.staticcall(
                    abi.encodeWithSignature("supportsInterface(bytes4)", 0x80ac58cd)
                );
                if (success && data.length > 0 && abi.decode(data, (bool))) {
                    // ERC-721: Verify token exists by checking ownerOf
                    (success, data) = rwaContract.staticcall(
                        abi.encodeWithSignature("ownerOf(uint256)", rwaTokenId)
                    );
                    if (success && data.length > 0) {
                        address owner = abi.decode(data, (address));
                        require(owner != address(0), "RWA token does not exist");
                        return;
                    }
                }
                
                // Check for ERC-1155 support (0xd9b67a26)
                (success, data) = rwaContract.staticcall(
                    abi.encodeWithSignature("supportsInterface(bytes4)", 0xd9b67a26)
                );
                if (success && data.length > 0 && abi.decode(data, (bool))) {
                    // ERC-1155: Check balance (token must exist and have balance > 0)
                    (success, data) = rwaContract.staticcall(
                        abi.encodeWithSignature("balanceOf(address,uint256)", msg.sender, rwaTokenId)
                    );
                    if (success && data.length > 0) {
                        uint256 balance = abi.decode(data, (uint256));
                        require(balance > 0, "You do not own this RWA token");
                        return;
                    }
                }
            }
        }
        
        // If standard checks fail, at least verify contract exists
        // This allows linking to custom RWA contracts that don't follow ERC standards
        // In production, you might want to require standard compliance
    }
    
    function upgradeProperty(
        uint256 tokenId,
        PropertyType newType,
        uint256 newValue,
        uint256 newYieldRate
    ) public {
        require(ownerOf(tokenId) == msg.sender, "Not owner");
        require(properties[tokenId].isActive, "Property not active");
        
        PropertyType oldType = properties[tokenId].propertyType;
        propertyTypeCounts[oldType]--;
        propertyTypeCounts[newType]++;
        
        properties[tokenId].propertyType = newType;
        properties[tokenId].value = newValue;
        properties[tokenId].yieldRate = newYieldRate;
        
        emit PropertyUpgraded(tokenId, newType, newValue);
    }
    
    function getProperty(uint256 tokenId) public view returns (Property memory) {
        return properties[tokenId];
    }
    
    function getOwnerProperties(address owner) public view returns (uint256[] memory) {
        return ownerProperties[owner];
    }
    
    function getOwnerPropertyCount(address owner) public view returns (uint256) {
        return ownerProperties[owner].length;
    }
    
    function getPropertyTypeCount(PropertyType propertyType) public view returns (uint256) {
        return propertyTypeCounts[propertyType];
    }
    
    function _update(address to, uint256 tokenId, address auth) internal override returns (address) {
        address previousOwner = super._update(to, tokenId, auth);
        
        if (previousOwner != address(0)) {
            uint256[] storage ownerProps = ownerProperties[previousOwner];
            for (uint256 i = 0; i < ownerProps.length; i++) {
                if (ownerProps[i] == tokenId) {
                    ownerProps[i] = ownerProps[ownerProps.length - 1];
                    ownerProps.pop();
                    break;
                }
            }
        }
        
        if (to != address(0)) {
            ownerProperties[to].push(tokenId);
        }
        
        return previousOwner;
    }
}
</file>

<file path="frontend/src/components/game/BuildMenu.tsx">
'use client';

import { useState } from 'react';
import { Building2, Plus } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

interface BuildMenuProps {
  onBuildProperty: (type: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury') => void | Promise<void>;
  tokenBalance: bigint;
  isMinting?: boolean;
}

const PROPERTY_TYPES = [
  {
    type: 'Residential' as const,
    name: 'Residential',
    cost: 100n * 10n ** 18n,
    yieldRate: 500, // 5% APY
    color: 'bg-blue-500',
    description: 'Stable yield, lower risk',
  },
  {
    type: 'Commercial' as const,
    name: 'Commercial',
    cost: 200n * 10n ** 18n,
    yieldRate: 800, // 8% APY
    color: 'bg-green-500',
    description: 'Balanced returns',
  },
  {
    type: 'Industrial' as const,
    name: 'Industrial',
    cost: 500n * 10n ** 18n,
    yieldRate: 1200, // 12% APY
    color: 'bg-orange-500',
    description: 'Higher yield, higher risk',
  },
  {
    type: 'Luxury' as const,
    name: 'Luxury',
    cost: 1000n * 10n ** 18n,
    yieldRate: 1500, // 15% APY
    color: 'bg-pink-500',
    description: 'Maximum returns',
  },
];

export function BuildMenu({ onBuildProperty, tokenBalance, isMinting = false }: BuildMenuProps) {
  const formatValue = (value: bigint) => {
    return (Number(value) / 1e18).toFixed(0);
  };

  return (
    <Card className="border-white/10 bg-white/5 backdrop-blur-md">
      <CardHeader>
        <CardTitle className="text-white flex items-center gap-2">
          <Plus className="w-5 h-5" />
          Build New Property
        </CardTitle>
        <p className="text-sm text-gray-400">Balance: {formatValue(tokenBalance)} TYCOON</p>
      </CardHeader>
      <CardContent className="space-y-3">
        {PROPERTY_TYPES.map((prop) => {
          const canAfford = tokenBalance >= prop.cost;
          return (
            <div
              key={prop.type}
              className={`p-4 rounded-lg border ${
                canAfford ? 'border-white/20 bg-white/5' : 'border-gray-700/50 bg-gray-800/30 opacity-50'
              }`}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-lg ${prop.color} flex items-center justify-center`}>
                    <Building2 className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <h4 className="text-white font-semibold">{prop.name}</h4>
                    <p className="text-xs text-gray-400 mt-1">{prop.description}</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-sm font-semibold text-white">{formatValue(prop.cost)} TYCOON</p>
                  <p className="text-xs text-emerald-400">{prop.yieldRate / 100}% APY</p>
                </div>
              </div>
              <Button
                onClick={() => onBuildProperty(prop.type)}
                disabled={!canAfford || isMinting}
                className="w-full"
                variant={canAfford ? 'default' : 'outline'}
              >
                {isMinting ? 'Minting...' : canAfford ? 'Build' : 'Insufficient Funds'}
              </Button>
            </div>
          );
        })}
      </CardContent>
    </Card>
  );
}
</file>

<file path="frontend/src/components/game/CityView.tsx">
'use client';

import { useEffect, useRef, useState } from 'react';
import { Application, Container, Graphics, Text, Sprite } from 'pixi.js';

interface Property {
  id: string;
  tokenId: number;
  propertyType: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury';
  value: bigint;
  yieldRate: number;
  x: number;
  y: number;
}

interface OtherPlayerProperty extends Property {
  owner: string;
  isOwned: boolean;
}

interface CityViewProps {
  properties: Property[];
  otherPlayersProperties?: OtherPlayerProperty[];
  onPropertyClick?: (property: Property) => void;
  onEmptyTileClick?: (x: number, y: number) => void;
}

const CANVAS_WIDTH = 800;
const CANVAS_HEIGHT = 600;
const GRID_WIDTH = 20;
const GRID_HEIGHT = 15;
const TILE_SIZE = 40;

const PROPERTY_COLORS = {
  Residential: 0x4a90e2, // Blue
  Commercial: 0x50c878, // Green
  Industrial: 0xffa500, // Orange
  Luxury: 0xff69b4, // Pink
};

export function CityView({ properties, otherPlayersProperties = [], onPropertyClick, onEmptyTileClick }: CityViewProps) {
  const canvasRef = useRef<HTMLDivElement>(null);
  const appRef = useRef<Application | null>(null);
  const stageRef = useRef<Container | null>(null);
  const gridLayerRef = useRef<Container | null>(null);
  const propertiesLayerRef = useRef<Container | null>(null);
  const [spritesLoaded, setSpritesLoaded] = useState(false);

  // Initialize Pixi app
  useEffect(() => {
    if (!canvasRef.current || appRef.current) return;

    const initPixi = async () => {
      const app = new Application();
      await app.init({
        width: CANVAS_WIDTH,
        height: CANVAS_HEIGHT,
        backgroundColor: 0x1a1a2e,
        antialias: true,
      });

      if (canvasRef.current) {
        canvasRef.current.appendChild(app.canvas);
        appRef.current = app;
      }

      // Create layers
      const stage = new Container();
      const gridLayer = new Container();
      const propertiesLayer = new Container();

      stage.addChild(gridLayer);
      stage.addChild(propertiesLayer);
      app.stage.addChild(stage);

      stageRef.current = stage;
      gridLayerRef.current = gridLayer;
      propertiesLayerRef.current = propertiesLayer;

      // Draw background terrain/land tiles (always draw all tiles as empty land)
      const terrainGraphics = new Graphics();
      for (let x = 0; x < GRID_WIDTH; x++) {
        for (let y = 0; y < GRID_HEIGHT; y++) {
          // Draw empty land tile with subtle pattern
          terrainGraphics.beginFill(0x2d2d44, 0.6); // Darker land color
          terrainGraphics.drawRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          terrainGraphics.endFill();
          
          // Add subtle texture pattern (dots) to show it's buildable land
          terrainGraphics.beginFill(0x3a3a55, 0.3);
          terrainGraphics.drawCircle(x * TILE_SIZE + TILE_SIZE / 4, y * TILE_SIZE + TILE_SIZE / 4, 2);
          terrainGraphics.drawCircle(x * TILE_SIZE + (TILE_SIZE * 3) / 4, y * TILE_SIZE + (TILE_SIZE * 3) / 4, 2);
          terrainGraphics.endFill();
        }
      }
      gridLayer.addChild(terrainGraphics);

      // Draw grid lines (more visible)
      const gridGraphics = new Graphics();
      gridGraphics.lineStyle(1, 0x4a4a6e, 0.8); // More visible grid lines

      // Vertical lines
      for (let x = 0; x <= GRID_WIDTH; x++) {
        gridGraphics.moveTo(x * TILE_SIZE, 0);
        gridGraphics.lineTo(x * TILE_SIZE, CANVAS_HEIGHT);
      }

      // Horizontal lines
      for (let y = 0; y <= GRID_HEIGHT; y++) {
        gridGraphics.moveTo(0, y * TILE_SIZE);
        gridGraphics.lineTo(CANVAS_WIDTH, y * TILE_SIZE);
      }

      gridLayer.addChild(gridGraphics);

      // Make stage interactive
      app.stage.eventMode = 'static';
      app.stage.hitArea = app.screen;
      
      app.stage.on('pointerdown', (e) => {
        const x = Math.floor(e.global.x / TILE_SIZE);
        const y = Math.floor(e.global.y / TILE_SIZE);
        
        // Validate coordinates
        if (x < 0 || x >= GRID_WIDTH || y < 0 || y >= GRID_HEIGHT) return;
        
        // Check if clicked on your property
        const yourProperty = properties.find(p => p.x === x && p.y === y);
        if (yourProperty) {
          onPropertyClick?.(yourProperty);
          return;
        }
        
        // Check if clicked on other player's property
        const otherProperty = otherPlayersProperties.find(p => p.x === x && p.y === y);
        if (otherProperty) {
          // Don't allow building on other players' properties
          return;
        }
        
        // It's an empty tile
        onEmptyTileClick?.(x, y);
      });

      setSpritesLoaded(true);
    };

    initPixi();

    return () => {
      if (appRef.current) {
        appRef.current.destroy(true, { children: true });
        appRef.current = null;
      }
    };
  }, []);

  // Update click handler when properties or callbacks change
  useEffect(() => {
    if (!appRef.current || !spritesLoaded) return;
    
    const stage = appRef.current.stage;
    
    // Remove old pointerdown handler
    stage.removeAllListeners('pointerdown');
    
    // Add new handler that checks current properties
    stage.on('pointerdown', (e) => {
      const x = Math.floor(e.global.x / TILE_SIZE);
      const y = Math.floor(e.global.y / TILE_SIZE);
      
      // Validate coordinates
      if (x < 0 || x >= GRID_WIDTH || y < 0 || y >= GRID_HEIGHT) return;
      
      // Check if clicked on your property
      const yourProperty = properties.find(p => p.x === x && p.y === y);
      if (yourProperty) {
        onPropertyClick?.(yourProperty);
        return;
      }
      
      // Check if clicked on other player's property
      const otherProperty = otherPlayersProperties.find(p => p.x === x && p.y === y);
      if (otherProperty) {
        // Don't allow building on other players' properties
        return;
      }
      
      // It's an empty tile - call the handler
      console.log('Empty tile clicked:', x, y);
      onEmptyTileClick?.(x, y);
    });
  }, [properties, otherPlayersProperties, spritesLoaded, onPropertyClick, onEmptyTileClick]);

  // Render properties (yours and other players') and selected tile
  useEffect(() => {
    if (!propertiesLayerRef.current || !gridLayerRef.current || !spritesLoaded) return;

    // Store ref value to avoid TypeScript null checks
    const propertiesLayer = propertiesLayerRef.current;

    // Clear existing properties
    propertiesLayer.removeChildren();
    

    // Render other players' properties first (dimmer, in background)
    otherPlayersProperties.forEach((property) => {
      if (property.isOwned) return; // Skip if it's yours (will render below)
      
      const propertyGraphics = new Graphics();
      const color = PROPERTY_COLORS[property.propertyType];
      
      // Draw other player's property (dimmer, with border)
      propertyGraphics.beginFill(color, 0.4); // Dimmer
      propertyGraphics.drawRect(
        property.x * TILE_SIZE + 2,
        property.y * TILE_SIZE + 2,
        TILE_SIZE - 4,
        TILE_SIZE - 4
      );
      propertyGraphics.endFill();
      
      // Dashed border to show it's not yours
      propertyGraphics.lineStyle(2, color, 0.6);
      propertyGraphics.drawRect(
        property.x * TILE_SIZE + 2,
        property.y * TILE_SIZE + 2,
        TILE_SIZE - 4,
        TILE_SIZE - 4
      );

      // Property type label (smaller, dimmer)
      const label = new Text({
        text: property.propertyType[0],
        style: {
          fontSize: 14,
          fill: 0xaaaaaa,
          fontWeight: 'bold',
        },
      });
      label.x = property.x * TILE_SIZE + TILE_SIZE / 2 - label.width / 2;
      label.y = property.y * TILE_SIZE + TILE_SIZE / 2 - label.height / 2;

      propertyGraphics.addChild(label);
      propertyGraphics.eventMode = 'static';
      propertyGraphics.cursor = 'default';
      propertyGraphics.interactiveChildren = false;
      // Don't block clicks - let stage handle them
      propertyGraphics.hitArea = null;

      propertiesLayer.addChild(propertyGraphics);
    });

    // Render your properties on top (bright, clickable)
    properties.forEach((property) => {
      const propertyGraphics = new Graphics();
      const color = PROPERTY_COLORS[property.propertyType];
      
      // Draw property tile (bright)
      propertyGraphics.beginFill(color, 0.9);
      propertyGraphics.drawRect(
        property.x * TILE_SIZE + 2,
        property.y * TILE_SIZE + 2,
        TILE_SIZE - 4,
        TILE_SIZE - 4
      );
      propertyGraphics.endFill();
      
      // Bright border with glow effect
      propertyGraphics.lineStyle(3, color, 1);
      propertyGraphics.drawRect(
        property.x * TILE_SIZE + 2,
        property.y * TILE_SIZE + 2,
        TILE_SIZE - 4,
        TILE_SIZE - 4
      );

      // Property type label (bright)
      const label = new Text({
        text: property.propertyType[0],
        style: {
          fontSize: 20,
          fill: 0xffffff,
          fontWeight: 'bold',
        },
      });
      label.x = property.x * TILE_SIZE + TILE_SIZE / 2 - label.width / 2;
      label.y = property.y * TILE_SIZE + TILE_SIZE / 2 - label.height / 2;

      propertyGraphics.addChild(label);
      propertyGraphics.eventMode = 'static';
      propertyGraphics.cursor = 'pointer';
      propertyGraphics.interactiveChildren = false;
      // Set hitArea to only the property rectangle, not the full tile
      propertyGraphics.hitArea = {
        contains: (x: number, y: number) => {
          const tileX = property.x * TILE_SIZE + 2;
          const tileY = property.y * TILE_SIZE + 2;
          return x >= tileX && x <= tileX + TILE_SIZE - 4 && 
                 y >= tileY && y <= tileY + TILE_SIZE - 4;
        }
      };
      // Handle click on property
      propertyGraphics.on('pointerdown', (e) => {
        e.stopPropagation(); // Stop event from reaching stage
        onPropertyClick?.(property);
      });

      propertiesLayer.addChild(propertyGraphics);
    });
      }, [properties, otherPlayersProperties, spritesLoaded, onPropertyClick]);

  return (
    <div className="w-full bg-gray-900 rounded-lg border border-white/10 p-4">
      <div className="mb-4 flex items-center justify-between">
        <h3 className="text-white font-semibold text-lg">Your Property Portfolio</h3>
        <div className="flex gap-4 text-xs text-gray-400">
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-blue-500 rounded" />
            <span>Residential</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-green-500 rounded" />
            <span>Commercial</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-orange-500 rounded" />
            <span>Industrial</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-pink-500 rounded" />
            <span>Luxury</span>
          </div>
        </div>
      </div>
      <div ref={canvasRef} className="w-full flex justify-center rounded-lg overflow-hidden border border-white/10" />
    </div>
  );
}
</file>

<file path="frontend/src/components/Quests.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useAccount, useWriteContract, useWaitForTransactionReceipt } from 'wagmi'
import { Target, CheckCircle, Circle, Trophy, TrendingUp } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { api } from '@/lib/api'
import { CONTRACTS, QUEST_SYSTEM_ABI } from '@/lib/contracts'

interface Quest {
  id: string
  questId?: number // Numeric quest ID (0-4)
  title: string
  description: string
  reward: bigint
  progress: number
  target: number
  completed: boolean
  type: 'diversify' | 'yield' | 'properties' | 'guild'
}

export function Quests() {
  const { address } = useAccount()
  const [quests, setQuests] = useState<Quest[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [claimingQuestId, setClaimingQuestId] = useState<string | null>(null)
  
  const { writeContract, data: hash, isPending, error } = useWriteContract()
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({
    hash,
  })

  useEffect(() => {
    loadQuests()
  }, [address])

  useEffect(() => {
    if (isSuccess && claimingQuestId) {
      // Quest claimed successfully, reload quests
      loadQuests()
      setClaimingQuestId(null)
    }
  }, [isSuccess, claimingQuestId])

  const loadQuests = async () => {
    setIsLoading(true)
    try {
      // Pass wallet address to get quests with progress
      const url = address ? `/quests?address=${address}` : '/quests'
      const data = await api.get(url)
      
      if (!Array.isArray(data)) {
        console.error('Invalid quest data format:', data)
        setQuests([])
        return
      }
      
      // Map backend data to frontend format
      const formattedQuests = data.map((q: any) => {
        // Handle reward - backend returns as string
        let reward: bigint
        try {
          if (typeof q.reward === 'bigint') {
            reward = q.reward
          } else if (typeof q.reward === 'string') {
            reward = BigInt(q.reward || '0')
          } else if (q.rewardAmount) {
            reward = BigInt(q.rewardAmount.toString() || '0')
          } else {
            reward = BigInt('0')
          }
        } catch (e) {
          console.warn('Error parsing reward for quest:', q, e)
          reward = BigInt('0')
        }
        
        return {
          id: q.id || q.questId?.toString() || '',
          questId: q.questId, // Store the numeric quest ID (0-4)
          title: q.title || q.name || 'Unknown Quest',
          description: q.description || '',
          reward,
          progress: q.progress || 0,
          target: q.target || q.requiredProperties || 1,
          completed: q.completed || false,
          type: q.type || 'properties',
        }
      })
      
      console.log(` Loaded ${formattedQuests.length} quests`)
      setQuests(formattedQuests)
      
      // Sync quest progress from contract if user is connected
      if (address) {
        try {
          await api.get(`/quests/sync-progress/${address}`)
        } catch (error) {
          console.warn('Failed to sync quest progress:', error)
        }
      }
    } catch (error: any) {
      console.error('Failed to load quests:', error)
      console.error('Error details:', error.response?.data || error.message)
      setQuests([])
    } finally {
      setIsLoading(false)
    }
  }

  const claimReward = async (questId: string, questType: number) => {
    if (!address) {
      console.error('Wallet not connected')
      return
    }

    try {
      setClaimingQuestId(questId)
      
      // Map quest type to contract function name
      let functionName: string
      switch (questType) {
        case 0: // FirstProperty
          functionName = 'checkFirstPropertyQuest'
          break
        case 1: // DiversifyPortfolio
          functionName = 'checkDiversifyPortfolioQuest'
          break
        case 3: // PropertyMogul
          functionName = 'checkPropertyMogulQuest'
          break
        case 4: // RWAPioneer
          functionName = 'checkRWAPioneerQuest'
          break
        default:
          console.error(`Quest type ${questType} not supported for claiming`)
          setClaimingQuestId(null)
          return
      }

      // Call the contract function directly
      writeContract({
        address: CONTRACTS.QuestSystem,
        abi: QUEST_SYSTEM_ABI,
        functionName: functionName as any,
        args: [address],
      })
    } catch (error) {
      console.error('Failed to claim reward:', error)
      setClaimingQuestId(null)
    }
  }

  const formatValue = (value: bigint | string | number) => {
    try {
      // Handle different input types
      let bigIntValue: bigint
      if (typeof value === 'bigint') {
        bigIntValue = value
      } else if (typeof value === 'string') {
        bigIntValue = BigInt(value)
      } else if (typeof value === 'number') {
        bigIntValue = BigInt(value)
      } else {
        return '0.00'
      }
      
      // Convert from wei to TYCOON (divide by 1e18)
      const divisor = BigInt('1000000000000000000') // 1e18
      const quotient = bigIntValue / divisor
      const remainder = bigIntValue % divisor
      const decimalPart = Number(remainder) / Number(divisor)
      const amount = Number(quotient) + decimalPart
      
      if (isNaN(amount) || !isFinite(amount)) {
        return '0.00'
      }
      
      if (amount < 1) return amount.toFixed(4)
      return amount.toFixed(2)
    } catch (error) {
      console.error('Error formatting value:', error, value)
      return '0.00'
    }
  }

  const getQuestIcon = (type: string) => {
    switch (type) {
      case 'diversify':
        return <TrendingUp className="w-5 h-5 text-blue-400" />
      case 'yield':
        return <Trophy className="w-5 h-5 text-yellow-400" />
      case 'properties':
        return <Target className="w-5 h-5 text-purple-400" />
      case 'guild':
        return <Trophy className="w-5 h-5 text-green-400" />
      default:
        return <Target className="w-5 h-5 text-gray-400" />
    }
  }

  return (
    <div className="space-y-4">
      <h2 className="text-xl font-bold text-white">Investment Quests</h2>

      {isLoading ? (
        <div className="text-center py-8 text-gray-400">Loading quests...</div>
      ) : quests.length === 0 ? (
        <div className="text-center py-8 text-gray-400">No quests available</div>
      ) : (
        <div className="space-y-3">
          {quests.map((quest) => (
            <Card
              key={quest.id}
              className={`bg-white/5 border-white/10 ${
                quest.completed ? 'border-green-500/50 bg-green-500/5' : ''
              }`}
            >
              <CardContent className="p-4">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-3 flex-1">
                    <div className="p-2 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                      {getQuestIcon(quest.type)}
                    </div>
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <h3 className="text-white font-semibold">{quest.title}</h3>
                        {quest.completed ? (
                          <CheckCircle className="w-4 h-4 text-green-400" />
                        ) : (
                          <Circle className="w-4 h-4 text-gray-400" />
                        )}
                      </div>
                      <p className="text-sm text-gray-400 mt-1">{quest.description}</p>
                      <div className="mt-3">
                        <div className="flex items-center justify-between text-xs text-gray-400 mb-1">
                          <span>Progress</span>
                          <span>
                            {quest.progress} / {quest.target}
                          </span>
                        </div>
                        <div className="w-full bg-gray-800 rounded-full h-2">
                          <div
                            className="bg-yellow-500 h-2 rounded-full transition-all"
                            style={{
                              width: `${Math.min((quest.progress / quest.target) * 100, 100)}%`,
                            }}
                          />
                        </div>
                      </div>
                      <div className="mt-2 text-sm text-yellow-400 font-semibold">
                        Reward: {formatValue(quest.reward)} TYCOON
                      </div>
                    </div>
                  </div>
                  {quest.completed ? (
                    <div className="text-xs text-green-400 font-semibold"> Completed</div>
                  ) : (
                    <Button
                      onClick={() => {
                        // Use questId from backend (0-4) or infer from quest data
                        const questType = quest.questId ?? 
                          (quest.title?.includes('First') ? 0 :
                           quest.title?.includes('Diversify') ? 1 :
                           quest.title?.includes('Mogul') ? 3 :
                           quest.title?.includes('RWA') ? 4 : 0)
                        claimReward(quest.id, questType)
                      }}
                      disabled={isPending || isConfirming || claimingQuestId === quest.id}
                      size="sm"
                      className="bg-yellow-500 hover:bg-yellow-600 text-black disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {isPending || isConfirming || claimingQuestId === quest.id
                        ? 'Checking...'
                        : 'Check & Claim'}
                    </Button>
                  )}
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}
</file>

<file path="frontend/src/components/RWALinkModal.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useReadContract, useWriteContract, useWaitForTransactionReceipt, useAccount } from 'wagmi';
import { X, Building2, Check } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { CONTRACTS, PROPERTY_NFT_ABI } from '@/lib/contracts';
import { formatEther } from 'viem';
import { getPublicClient } from '@wagmi/core';
import { wagmiConfig } from '@/lib/mantle-viem';

interface RWALinkModalProps {
  isOpen: boolean;
  onClose: () => void;
  propertyTokenId: number;
  onSuccess?: () => void;
}

// MockRWA ABI for reading token data
const MOCK_RWA_ABI = [
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'properties',
    outputs: [
      { name: 'name', type: 'string' },
      { name: 'value', type: 'uint256' },
      { name: 'monthlyYield', type: 'uint256' },
      { name: 'location', type: 'string' },
      { name: 'createdAt', type: 'uint256' },
      { name: 'isActive', type: 'bool' },
    ],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'getPropertyValue',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'getAnnualYield',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'ownerOf',
    outputs: [{ name: '', type: 'address' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'getYieldRate',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
] as const;

interface RWAToken {
  tokenId: number;
  name?: string;
  value?: bigint;
  yield?: bigint;
  location?: string;
  isOwned?: boolean;
}

export function RWALinkModal({ isOpen, onClose, propertyTokenId, onSuccess }: RWALinkModalProps) {
  const [selectedTokenId, setSelectedTokenId] = useState<number | null>(null);
  const [availableTokens, setAvailableTokens] = useState<RWAToken[]>([]);
  const [loading, setLoading] = useState(false);
  const { address } = useAccount();

  // Write contract for linking
  const { writeContract, data: hash, isPending } = useWriteContract();
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash });

  // Determine which RWA contract to use (oracle-based or fallback to MockRWA)
  const getRWAContract = () => {
    // Check for oracle-based RWA contract first (from CONTRACTS)
    if (CONTRACTS.OracleRWA && CONTRACTS.OracleRWA !== '0x0000000000000000000000000000000000000000') {
      return CONTRACTS.OracleRWA;
    }
    // Fallback to MockRWA
    return CONTRACTS.MockRWA;
  };

  // Load available RWA tokens (filtered by current user's ownership)
  useEffect(() => {
    const rwaContract = getRWAContract();
    
    if (!isOpen || !rwaContract || rwaContract === '0x0000000000000000000000000000000000000000' || !address) {
      setAvailableTokens([]);
      return;
    }

    const loadTokens = async () => {
      setLoading(true);
      try {
        const tokens: RWAToken[] = [];
        const publicClient = getPublicClient(wagmiConfig);
        if (!publicClient) {
          setLoading(false);
          return;
        }
        
        // Check tokens 0-19 (covers initial tokens and newly minted tokens)
        for (let i = 0; i < 20; i++) {
          try {
            // First check if token exists by checking ownerOf
            const owner = await publicClient.readContract({
              address: rwaContract,
              abi: MOCK_RWA_ABI,
              functionName: 'ownerOf',
              args: [BigInt(i)],
            }).catch(() => null);

            // If token doesn't exist, ownerOf will revert, so skip it
            if (!owner) continue;

            // IMPORTANT: Only show RWA tokens owned by the current user
            const ownerLower = (owner as string).toLowerCase();
            const userAddressLower = address.toLowerCase();
            if (ownerLower !== userAddressLower) {
              console.log(`Skipping RWA token ${i}: owned by ${owner}, not by user ${address}`);
              continue;
            }

            // Try to read property data
            const propertyData = await publicClient.readContract({
              address: rwaContract,
              abi: MOCK_RWA_ABI,
              functionName: 'properties',
              args: [BigInt(i)],
            });

            tokens.push({
              tokenId: i,
              name: propertyData[0] as string,
              value: propertyData[1] as bigint,
              yield: propertyData[2] as bigint,
              location: propertyData[3] as string,
              isOwned: true,
            });
          } catch (error) {
            // If token doesn't exist or can't read, skip it
            console.warn(`Failed to load RWA token ${i}:`, error);
          }
        }
        
        setAvailableTokens(tokens);
        console.log(` Loaded ${tokens.length} RWA tokens owned by user ${address} from ${rwaContract === CONTRACTS.MockRWA ? 'MockRWA (fallback)' : 'Oracle RWA'}`);
      } catch (error) {
        console.error('Failed to load RWA tokens:', error);
      } finally {
        setLoading(false);
      }
    };

    loadTokens();
  }, [isOpen, address]);

  // Handle successful transaction
  useEffect(() => {
    if (isSuccess && hash) {
      console.log(' RWA link transaction confirmed!');
      console.log(`   Transaction hash: ${hash}`);
      console.log(`   Property #${propertyTokenId} is now linked to RWA token #${selectedTokenId}`);
      console.log(`   Yield calculation will now use RWA value and yield rate`);
      console.log(`   Refresh the page or wait a few seconds to see updated yield`);
      
      // Wait a bit for blockchain state to update, then reload
      setTimeout(() => {
        onSuccess?.();
        onClose();
      }, 3000);
    }
  }, [isSuccess, hash, onSuccess, onClose, propertyTokenId, selectedTokenId]);

  const handleLink = () => {
    const rwaContract = getRWAContract();
    if (!selectedTokenId || !rwaContract) {
      console.error('Cannot link: missing RWA contract or token ID');
      return;
    }

    try {
      console.log(` Attempting to link property ${propertyTokenId} to RWA:`, {
        rwaContract,
        rwaTokenId: selectedTokenId,
        propertyTokenId,
      });
      
      writeContract({
        address: CONTRACTS.PropertyNFT,
        abi: PROPERTY_NFT_ABI,
        functionName: 'linkToRWA',
        args: [BigInt(propertyTokenId), rwaContract, BigInt(selectedTokenId)],
      });
      
      console.log(` Link transaction submitted! Waiting for confirmation...`);
      console.log(`   Property: #${propertyTokenId}`);
      console.log(`   RWA Contract: ${rwaContract}`);
      console.log(`   RWA Token: #${selectedTokenId}`);
      console.log(`   After confirmation, property will use RWA yield automatically`);
    } catch (error) {
      console.error(' Failed to link RWA:', error);
      alert('Failed to link property to RWA. Check console for details.');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <Card className="w-full max-w-2xl max-h-[90vh] overflow-hidden bg-gray-900 border-gray-700">
        <div className="flex items-center justify-between p-4 border-b border-gray-700">
          <h2 className="text-xl font-bold text-white flex items-center gap-2">
            <Building2 className="w-5 h-5" />
            Link Property to RWA
          </h2>
          <Button variant="ghost" size="sm" onClick={onClose} className="text-gray-400 hover:text-white">
            <X className="w-4 h-4" />
          </Button>
        </div>

        <div className="p-4 overflow-y-auto max-h-[calc(90vh-120px)]">
          <p className="text-sm text-gray-400 mb-4">
            Select a Real-World Asset (RWA) token to link to your property. This connects your in-game property to a tokenized real-world asset.
            {getRWAContract() !== CONTRACTS.MockRWA && (
              <span className="block mt-2 text-emerald-400 text-xs">
                Using Oracle-based RWA contract
              </span>
            )}
            {getRWAContract() === CONTRACTS.MockRWA && (
              <span className="block mt-2 text-yellow-400 text-xs">
                Using MockRWA (fallback) - configure NEXT_PUBLIC_ORACLE_RWA_ADDRESS to use oracle
              </span>
            )}
          </p>

          {loading ? (
            <div className="text-center py-8 text-gray-400">Loading RWA tokens...</div>
          ) : availableTokens.length === 0 ? (
            <div className="text-center py-8 text-gray-400">No RWA tokens available</div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {availableTokens.map((token) => (
                <Card
                  key={token.tokenId}
                  className={`cursor-pointer transition-all ${
                    selectedTokenId === token.tokenId
                      ? 'bg-emerald-900/30 border-emerald-500'
                      : 'bg-gray-800/50 border-gray-700 hover:border-gray-600'
                  }`}
                  onClick={() => setSelectedTokenId(token.tokenId)}
                >
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between">
                      <div className="flex-1">
                        <p className="font-semibold text-white">
                          {token.name || `RWA Token #${token.tokenId}`}
                        </p>
                        {token.location && (
                          <p className="text-xs text-gray-400 mt-1">{token.location}</p>
                        )}
                        {token.value && (
                          <p className="text-xs text-emerald-400 mt-1">
                            Value: ${(Number(formatEther(token.value))).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                          </p>
                        )}
                        {token.yield && token.value && (
                          <>
                            <p className="text-xs text-blue-400 mt-1">
                              Monthly: ${(Number(formatEther(token.yield))).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                            </p>
                            <p className="text-xs text-purple-400 mt-1 font-semibold">
                              APY: {((Number(formatEther(token.yield)) * 12 / Number(formatEther(token.value))) * 100).toFixed(2)}%
                            </p>
                          </>
                        )}
                      </div>
                      {selectedTokenId === token.tokenId && (
                        <Check className="w-5 h-5 text-emerald-400 ml-2" />
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}

          <div className="mt-6 flex gap-3">
            <Button
              variant="outline"
              onClick={onClose}
              className="flex-1"
              disabled={isPending || isConfirming}
            >
              Cancel
            </Button>
            <Button
              onClick={handleLink}
              disabled={!selectedTokenId || isPending || isConfirming}
              className="flex-1 bg-emerald-600 hover:bg-emerald-700"
            >
              {isPending || isConfirming ? 'Linking...' : 'Link Property'}
            </Button>
          </div>
        </div>
      </Card>
    </div>
  );
}
</file>

<file path="frontend/src/components/UserProfile.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useAccount } from 'wagmi';
import { motion, AnimatePresence } from 'framer-motion';
import { X, User, Save, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { api } from '@/lib/api';

interface UserProfileProps {
  isOpen: boolean;
  onClose: () => void;
}

export function UserProfile({ isOpen, onClose }: UserProfileProps) {
  const { address } = useAccount();
  const [username, setUsername] = useState('');
  const [currentUsername, setCurrentUsername] = useState<string | null>(null);
  const [avatar, setAvatar] = useState<string>('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (isOpen && address) {
      loadProfile();
    }
  }, [isOpen, address]);

  const loadProfile = async () => {
    if (!address) return;

    setIsLoading(true);
    setError(null);
    try {
      const profile = await api.get(`/users/profile/${address}`);
      if (profile) {
        setCurrentUsername(profile.username || null);
        setUsername(profile.username || '');
        setAvatar(profile.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${address}`);
      } else {
        // Generate default avatar
        setAvatar(`https://api.dicebear.com/7.x/avataaars/svg?seed=${address}`);
      }
    } catch (error: any) {
      console.error('Failed to load profile:', error);
      setError(error.response?.data?.message || 'Failed to load profile');
      // Generate default avatar even on error
      setAvatar(`https://api.dicebear.com/7.x/avataaars/svg?seed=${address}`);
    } finally {
      setIsLoading(false);
    }
  };

  const handleSave = async () => {
    if (!address || !username.trim()) {
      setError('Username cannot be empty');
      return;
    }

    setIsSaving(true);
    setError(null);
    try {
      const profile = await api.put(`/users/profile/${address}/username`, {
        username: username.trim(),
      });
      setCurrentUsername(profile.username || null);
      // Reload avatar to ensure it's updated
      setAvatar(`https://api.dicebear.com/7.x/avataaars/svg?seed=${address}`);
    } catch (error: any) {
      console.error('Failed to update username:', error);
      setError(error.response?.data?.message || 'Failed to update username');
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <AnimatePresence>
      {isOpen && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50"
          />

          {/* Profile Panel */}
          <motion.div
            initial={{ x: '100%' }}
            animate={{ x: 0 }}
            exit={{ x: '100%' }}
            transition={{ type: 'spring', damping: 25, stiffness: 200 }}
            className="fixed right-0 top-0 bottom-0 w-full max-w-md z-50 bg-gradient-to-l from-gray-900/95 to-gray-900/90 backdrop-blur-xl border-l border-white/10 shadow-2xl flex flex-col"
          >
            {/* Header */}
            <div className="p-4 border-b border-white/10 flex items-center justify-between bg-white/5">
              <div className="flex items-center gap-3">
                <div className="relative">
                  <div className="absolute inset-0 bg-purple-500 blur-md opacity-50 rounded-full" />
                  <div className="relative bg-gradient-to-br from-purple-500 to-pink-600 p-2 rounded-full">
                    <User className="w-5 h-5 text-white" />
                  </div>
                </div>
                <div>
                  <h2 className="text-lg font-bold text-white">Profile Settings</h2>
                  <p className="text-xs text-purple-400/80">Customize your identity</p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="icon"
                onClick={onClose}
                className="text-gray-400 hover:text-white hover:bg-white/10 rounded-full"
              >
                <X className="w-5 h-5" />
              </Button>
            </div>

            {/* Content */}
            <div className="flex-1 p-6 overflow-y-auto">
              {isLoading ? (
                <div className="flex flex-col items-center justify-center h-full text-gray-400">
                  <Loader2 className="w-8 h-8 animate-spin mb-2 text-purple-500" />
                  <p>Loading profile...</p>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Avatar */}
                  <div className="flex flex-col items-center">
                    <Avatar className="w-24 h-24 border-4 border-white/20 mb-4">
                      <AvatarImage src={avatar} alt={username || address} />
                      <AvatarFallback className="bg-gradient-to-br from-purple-500 to-pink-600 text-2xl text-white">
                        {username?.[0] || address?.slice(2, 3).toUpperCase()}
                      </AvatarFallback>
                    </Avatar>
                    <p className="text-xs text-gray-400 text-center">
                      Avatar generated from your wallet address
                    </p>
                  </div>

                  {/* Wallet Address */}
                  <div>
                    <label className="text-sm font-medium text-gray-300 mb-2 block">
                      Wallet Address
                    </label>
                    <div className="bg-white/5 border border-white/10 rounded-lg p-3 text-sm text-gray-400 font-mono">
                      {address?.slice(0, 6)}...{address?.slice(-4)}
                    </div>
                  </div>

                  {/* Username */}
                  <div>
                    <label className="text-sm font-medium text-gray-300 mb-2 block">
                      Username
                    </label>
                    <Input
                      value={username}
                      onChange={(e) => {
                        setUsername(e.target.value);
                        setError(null);
                      }}
                      placeholder="Enter your username"
                      maxLength={100}
                      className="bg-white/5 border-white/10 text-white placeholder:text-gray-500 focus-visible:ring-purple-500/50 focus-visible:border-purple-500/50"
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      This will be displayed in chat instead of your wallet address
                    </p>
                  </div>

                  {/* Error Message */}
                  {error && (
                    <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-3 text-sm text-red-400">
                      {error}
                    </div>
                  )}

                  {/* Success Message */}
                  {currentUsername && !error && (
                    <div className="bg-green-500/10 border border-green-500/50 rounded-lg p-3 text-sm text-green-400">
                      Username saved successfully!
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-4 border-t border-white/10 bg-black/20 backdrop-blur-md">
              <Button
                onClick={handleSave}
                disabled={isSaving || !username.trim() || username === currentUsername}
                className="w-full bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white shadow-lg shadow-purple-900/20"
              >
                {isSaving ? (
                  <>
                    <Loader2 className="w-4 h-4 animate-spin mr-2" />
                    Saving...
                  </>
                ) : (
                  <>
                    <Save className="w-4 h-4 mr-2" />
                    Save Username
                  </>
                )}
              </Button>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  );
}
</file>

<file path="frontend/src/context/index.tsx">
'use client'

import { wagmiAdapter, projectId } from '@/config'
import { createAppKit } from '@reown/appkit/react' 
import { mantle, mantleSepoliaTestnet } from '@reown/appkit/networks'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import React, { type ReactNode } from 'react'
import { cookieToInitialState, WagmiProvider, type Config } from 'wagmi'

const queryClient = new QueryClient()

if (!projectId) {
  throw new Error('Project ID is not defined')
}

const metadata = {
  name: "Property Tycoon - Mantle",
  description: "Property Tycoon - Real estate investment game on Mantle Network",
  url: "https://propertytycoon.com", // Replace with your actual domain
  icons: ["https://avatars.githubusercontent.com/u/179229932"] // Replace with your app icon
}

const modal = createAppKit({
  adapters: [wagmiAdapter],
  projectId,
  networks: [mantle, mantleSepoliaTestnet],
  metadata: metadata,
  features: {
    analytics: true,
  },
  themeMode: 'dark' // Set theme to dark to match game UI
})

function ContextProvider({ children, cookies }: { children: ReactNode; cookies: string | null }) {
  // Safely parse cookies - handle null or empty strings
  let initialState;
  try {
    initialState = cookies ? cookieToInitialState(wagmiAdapter.wagmiConfig as Config, cookies) : undefined;
  } catch (error) {
    console.warn('Failed to parse cookies for wagmi initialState:', error);
    initialState = undefined;
  }
  
  return (
    <WagmiProvider config={wagmiAdapter.wagmiConfig as Config} initialState={initialState}>
      <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
    </WagmiProvider>
  )
}

export default ContextProvider
</file>

<file path="frontend/src/hooks/useChat.ts">
'use client';

import { useState, useEffect, useRef } from 'react';
import { useAccount } from 'wagmi';
import { io, Socket } from 'socket.io-client';
import { api } from '@/lib/api';

export interface ChatMessage {
  id: string;
  walletAddress: string;
  username?: string;
  avatar?: string;
  message: string;
  createdAt: string;
  isMe?: boolean;
}

const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL 
  ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') 
  : 'http://localhost:3001';

export function useChat() {
  const { address } = useAccount();
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isSending, setIsSending] = useState(false);
  const socketRef = useRef<Socket | null>(null);

  // Load initial messages
  useEffect(() => {
    const loadMessages = async () => {
      try {
        const data = await api.get('/chat/messages?limit=50');
        const formatted = data.map((msg: any) => ({
          ...msg,
          isMe: msg.walletAddress?.toLowerCase() === address?.toLowerCase(),
        }));
        setMessages(formatted.reverse()); // Reverse to show newest at bottom
        setIsLoading(false);
      } catch (error) {
        console.error('Failed to load messages:', error);
        setIsLoading(false);
      }
    };

    loadMessages();
  }, [address]);

  // Setup WebSocket connection
  useEffect(() => {
    if (!address) return;

    console.log('Connecting to WebSocket at:', BACKEND_URL);
    const socket = io(BACKEND_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 5,
    });

    socket.on('connect', () => {
      console.log(' Connected to chat WebSocket');
      socket.emit('subscribe:chat');
    });

    socket.on('connect_error', (error) => {
      console.error(' WebSocket connection error:', error);
    });

    socket.on('chat:new', (message: ChatMessage) => {
      console.log(' New chat message received:', message);
      setMessages((prev) => {
        // Check if message already exists to avoid duplicates
        if (prev.some(m => m.id === message.id)) {
          return prev;
        }
        return [
          ...prev,
          {
            ...message,
            isMe: message.walletAddress?.toLowerCase() === address?.toLowerCase(),
          },
        ];
      });
    });

    socket.on('disconnect', (reason) => {
      console.log(' Disconnected from chat:', reason);
    });

    socketRef.current = socket;

    return () => {
      console.log(' Cleaning up WebSocket connection');
      socket.disconnect();
    };
  }, [address]);

  const sendMessage = async (message: string) => {
    if (!address || !message.trim()) {
      console.warn('Cannot send message: missing address or empty message');
      return;
    }

    setIsSending(true);
    try {
      console.log(' Sending message:', message);
      const response = await api.post('/chat/messages', {
        message: message.trim(),
        walletAddress: address,
      });
      console.log(' Message sent successfully:', response);
      // Message will be added via WebSocket event
    } catch (error) {
      console.error(' Failed to send message:', error);
      throw error;
    } finally {
      setIsSending(false);
    }
  };

  return {
    messages,
    isLoading,
    isSending,
    sendMessage,
  };
}
</file>

<file path="railway.json">
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "cd backend && npm install && npm run build"
  },
  "deploy": {
    "startCommand": "cd backend && npm run start:prod",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
</file>

<file path="backend/src/database/init-db.ts">
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';
import * as schema from './schema';
import { migrate } from 'drizzle-orm/postgres-js/migrator';

const connectionString =
  process.env.DATABASE_URL ||
  'postgresql://postgres:password@localhost:5432/property_tycoon';

async function initDatabase() {
  console.log(' Connecting to database...');
  const client = postgres(connectionString, { max: 1 });
  const db = drizzle(client, { schema });

  try {
    console.log(' Creating tables...');
    
    // Use Drizzle's push to create tables from schema
    // This will create all tables defined in the schema
    await db.execute(`
      CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        wallet_address VARCHAR(42) NOT NULL UNIQUE,
        username VARCHAR(100),
        total_portfolio_value NUMERIC DEFAULT 0,
        total_yield_earned NUMERIC DEFAULT 0,
        properties_owned INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS properties (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        token_id BIGINT NOT NULL UNIQUE,
        owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        property_type VARCHAR(50) NOT NULL,
        value NUMERIC NOT NULL,
        yield_rate INTEGER NOT NULL,
        rwa_contract VARCHAR(42),
        rwa_token_id BIGINT,
        total_yield_earned BIGINT DEFAULT 0,
        x INTEGER,
        y INTEGER,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS yield_records (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
        owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        amount BIGINT NOT NULL,
        claimed BOOLEAN DEFAULT false,
        transaction_hash VARCHAR(66),
        claimed_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS marketplace_listings (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        property_id UUID NOT NULL REFERENCES properties(id) ON DELETE CASCADE,
        seller_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        price BIGINT NOT NULL,
        is_active BOOLEAN DEFAULT true,
        listing_type VARCHAR(20) NOT NULL,
        auction_end_time TIMESTAMP,
        highest_bid BIGINT,
        highest_bidder_id UUID REFERENCES users(id),
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS quests (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        quest_id BIGINT NOT NULL UNIQUE,
        name VARCHAR(200) NOT NULL,
        description VARCHAR(1000),
        reward_amount NUMERIC NOT NULL,
        required_properties INTEGER DEFAULT 0 NOT NULL,
        required_property_type VARCHAR(50),
        active BOOLEAN DEFAULT true NOT NULL,
        created_at TIMESTAMP DEFAULT NOW() NOT NULL,
        updated_at TIMESTAMP DEFAULT NOW() NOT NULL
      );
      
      -- Alter reward_amount from BIGINT to NUMERIC if it exists as BIGINT
      DO $$
      BEGIN
        IF EXISTS (
          SELECT 1 FROM information_schema.columns 
          WHERE table_name = 'quests' 
          AND column_name = 'reward_amount' 
          AND data_type = 'bigint'
        ) THEN
          ALTER TABLE quests ALTER COLUMN reward_amount TYPE NUMERIC USING reward_amount::text::numeric;
        END IF;
      END $$;
      
      -- Add required_property_type column if it doesn't exist
      DO $$
      BEGIN
        IF NOT EXISTS (
          SELECT 1 FROM information_schema.columns 
          WHERE table_name = 'quests' 
          AND column_name = 'required_property_type'
        ) THEN
          ALTER TABLE quests ADD COLUMN required_property_type VARCHAR(50);
        END IF;
      END $$;
      
      -- Alter quest_id to BIGINT if it's INTEGER (handle existing data)
      DO $$
      BEGIN
        IF EXISTS (
          SELECT 1 FROM information_schema.columns 
          WHERE table_name = 'quests' 
          AND column_name = 'quest_id' 
          AND data_type = 'integer'
        ) THEN
          -- First drop the unique constraint if it exists
          ALTER TABLE quests DROP CONSTRAINT IF EXISTS quests_quest_id_key;
          -- Then alter the column type
          ALTER TABLE quests ALTER COLUMN quest_id TYPE BIGINT USING quest_id::bigint;
          -- Re-add the unique constraint
          ALTER TABLE quests ADD CONSTRAINT quests_quest_id_key UNIQUE (quest_id);
        END IF;
      END $$;
      
      -- Ensure required_properties has NOT NULL constraint
      DO $$
      BEGIN
        IF EXISTS (
          SELECT 1 FROM information_schema.columns 
          WHERE table_name = 'quests' 
          AND column_name = 'required_properties' 
          AND is_nullable = 'YES'
        ) THEN
          ALTER TABLE quests ALTER COLUMN required_properties SET NOT NULL;
          ALTER TABLE quests ALTER COLUMN required_properties SET DEFAULT 0;
        END IF;
      END $$;

      CREATE TABLE IF NOT EXISTS quest_progress (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        quest_id UUID NOT NULL REFERENCES quests(id) ON DELETE CASCADE,
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        completed BOOLEAN DEFAULT false,
        progress INTEGER DEFAULT 0,
        reward_claimed BOOLEAN DEFAULT false,
        completed_at TIMESTAMP,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW(),
        UNIQUE(quest_id, user_id)
      );

      CREATE TABLE IF NOT EXISTS leaderboard (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID NOT NULL UNIQUE REFERENCES users(id) ON DELETE CASCADE,
        total_portfolio_value NUMERIC DEFAULT 0,
        total_yield_earned NUMERIC DEFAULT 0,
        properties_owned INTEGER DEFAULT 0,
        quests_completed INTEGER DEFAULT 0,
        rank INTEGER,
        updated_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS chat_messages (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        message TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS guilds (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        name VARCHAR(100) NOT NULL UNIQUE,
        description TEXT,
        owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        total_members INTEGER DEFAULT 1 NOT NULL,
        total_portfolio_value BIGINT DEFAULT 0 NOT NULL,
        total_yield_earned BIGINT DEFAULT 0 NOT NULL,
        is_public BOOLEAN DEFAULT true NOT NULL,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
      );

      CREATE TABLE IF NOT EXISTS guild_members (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        guild_id UUID NOT NULL REFERENCES guilds(id) ON DELETE CASCADE,
        user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
        role VARCHAR(20) DEFAULT 'member' NOT NULL,
        joined_at TIMESTAMP DEFAULT NOW(),
        contribution NUMERIC DEFAULT '0' NOT NULL,
        UNIQUE(guild_id, user_id)
      );

      -- Migrate existing contribution column from BIGINT to NUMERIC if it exists
      DO $$
      BEGIN
        IF EXISTS (
          SELECT 1 FROM information_schema.columns 
          WHERE table_name = 'guild_members' 
          AND column_name = 'contribution' 
          AND data_type = 'bigint'
        ) THEN
          ALTER TABLE guild_members 
          ALTER COLUMN contribution TYPE NUMERIC USING contribution::text::numeric;
        END IF;
      END $$;

      CREATE INDEX IF NOT EXISTS idx_users_wallet_address ON users(wallet_address);
      CREATE INDEX IF NOT EXISTS idx_guilds_owner_id ON guilds(owner_id);
      CREATE INDEX IF NOT EXISTS idx_guild_members_guild_id ON guild_members(guild_id);
      CREATE INDEX IF NOT EXISTS idx_guild_members_user_id ON guild_members(user_id);
      CREATE INDEX IF NOT EXISTS idx_properties_token_id ON properties(token_id);
      CREATE INDEX IF NOT EXISTS idx_properties_owner_id ON properties(owner_id);
      CREATE INDEX IF NOT EXISTS idx_yield_records_property_id ON yield_records(property_id);
      CREATE INDEX IF NOT EXISTS idx_yield_records_owner_id ON yield_records(owner_id);
      CREATE INDEX IF NOT EXISTS idx_marketplace_listings_property_id ON marketplace_listings(property_id);
      CREATE INDEX IF NOT EXISTS idx_marketplace_listings_seller_id ON marketplace_listings(seller_id);
      CREATE INDEX IF NOT EXISTS idx_quest_progress_user_id ON quest_progress(user_id);
      CREATE INDEX IF NOT EXISTS idx_chat_messages_user_id ON chat_messages(user_id);
      CREATE INDEX IF NOT EXISTS idx_chat_messages_created_at ON chat_messages(created_at DESC);
    `);

    console.log(' Database tables created successfully!');
  } catch (error) {
    console.error(' Error creating tables:', error);
    throw error;
  } finally {
    await client.end();
  }
}

initDatabase()
  .then(() => {
    console.log(' Database initialization complete!');
    process.exit(0);
  })
  .catch((error) => {
    console.error(' Database initialization failed:', error);
    process.exit(1);
  });
</file>

<file path="backend/src/database/migrate-contribution-to-numeric.sql">
-- Migrate guild_members.contribution from BIGINT to NUMERIC
-- This allows PostgreSQL to return strings instead of BigInt, preventing serialization errors

ALTER TABLE guild_members 
ALTER COLUMN contribution TYPE NUMERIC USING contribution::text::numeric;
</file>

<file path="backend/src/database/run-migration.ts">
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

const connectionString =
  process.env.DATABASE_URL ||
  'postgresql://postgres:password@localhost:5432/property_tycoon';

async function runMigration() {
  console.log(' Connecting to database...');
  const client = postgres(connectionString, { max: 1 });

  try {
    console.log(' Migrating guild_members.contribution from BIGINT to NUMERIC...');
    
    await client`
      ALTER TABLE guild_members 
      ALTER COLUMN contribution TYPE NUMERIC USING contribution::text::numeric;
    `;

    console.log(' Migration completed successfully!');
  } catch (error: any) {
    if (error.message?.includes('does not exist')) {
      console.log('  Column might already be NUMERIC or table does not exist');
    } else {
      console.error(' Migration error:', error.message);
      throw error;
    }
  } finally {
    await client.end();
  }
}

runMigration()
  .then(() => {
    console.log(' Migration complete!');
    process.exit(0);
  })
  .catch((error) => {
    console.error(' Migration failed:', error);
    process.exit(1);
  });
</file>

<file path="backend/src/database/schema/chat.schema.ts">
import { pgTable, uuid, varchar, text, timestamp } from 'drizzle-orm/pg-core';
import { users } from './users.schema';

export const chatMessages = pgTable('chat_messages', {
  id: uuid('id').defaultRandom().primaryKey(),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  message: text('message').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
});

export type ChatMessage = typeof chatMessages.$inferSelect;
export type NewChatMessage = typeof chatMessages.$inferInsert;
</file>

<file path="backend/src/leaderboard/cleanup-contracts.sql">
-- Cleanup script to remove contract addresses from leaderboard
-- Run this in your PostgreSQL database

-- First, identify contract addresses
-- Marketplace (old): 0x6389D7168029715DE118Baf51B6D32eE1EBEa46B
-- Marketplace (new): 0xe9E855ff6EB78055AaE90631468BfC948A1446Bb
-- Add other contract addresses as needed

-- Delete leaderboard entries for contract addresses
DELETE FROM leaderboard 
WHERE user_id IN (
  SELECT id FROM users 
  WHERE LOWER(wallet_address) IN (
    LOWER('0x6389D7168029715DE118Baf51B6D32eE1EBEa46B'),  -- Old marketplace
    LOWER('0xe9E855ff6EB78055AaE90631468BfC948A1446Bb'),  -- New marketplace
    LOWER('0x7549a25b9a5206569f6778c6be6a7620687f5A38'),  -- Yield Distributor
    LOWER('0xb5a595A6cd30D1798387A2c781E0646FCA8c4AeD'),  -- Quest System
    LOWER('0x0AE7119c7187D88643fb7B409937B68828eE733D'),  -- PropertyNFT
    LOWER('0x32D9a9b9e241Da421f34786De0B39fD34D1EfeA8')   -- GameToken
  )
);

-- Optionally, delete user entries for contracts (if you want)
-- DELETE FROM users 
-- WHERE LOWER(wallet_address) IN (
--   LOWER('0x6389D7168029715DE118Baf51B6D32eE1EBEa46B'),
--   LOWER('0xe9E855ff6EB78055AaE90631468BfC948A1446Bb'),
--   LOWER('0x7549a25b9a5206569f6778c6be6a7620687f5A38'),
--   LOWER('0xb5a595A6cd30D1798387A2c781E0646FCA8c4AeD'),
--   LOWER('0x0AE7119c7187D88643fb7B409937B68828eE733D'),
--   LOWER('0x32D9a9b9e241Da421f34786De0B39fD34D1EfeA8')
-- );
</file>

<file path="backend/src/mantle/oracle.service.ts">
import { Injectable, Logger } from '@nestjs/common';
import { ethers } from 'ethers';

@Injectable()
export class OracleService {
  private readonly logger = new Logger(OracleService.name);
  private provider: ethers.providers.JsonRpcProvider;

  // Chronicle Oracle addresses on Mantle Sepolia Testnet
  // Found from: https://chroniclelabs.org/dashboard/oracles
  private readonly ORACLE_ADDRESSES = {
    USDC: process.env.CHRONICLE_USDC_ORACLE || '0x9Dd500569A6e77ECdDE7694CDc2E58ac587768D0', // USDC/USD on Mantle Sepolia
    USDT: process.env.CHRONICLE_USDT_ORACLE || '0xD671F5F7c2fb6f75439641C36a578842f5b376A9', // USDT/USD on Mantle Sepolia
    ETH: process.env.CHRONICLE_ETH_ORACLE || '0xa6896dCf3f5Dc3c29A5bD3a788D6b7e901e487D8', // ETH/USD on Mantle Sepolia
    MNT: process.env.CHRONICLE_MNT_ORACLE || '0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307', // MNT/USD on Mantle Sepolia
  };

  // Chronicle Oracle ABI (IChronicle interface)
  // Based on Chronicle Protocol documentation
  private readonly ORACLE_ABI = [
    'function read() external view returns (uint256 value)',
    'function readWithAge() external view returns (uint256 value, uint256 age)',
    'function tryRead() external view returns (bool isValid, uint256 value)',
    'function tryReadWithAge() external view returns (bool isValid, uint256 value, uint256 age)',
  ];

  constructor() {
    this.provider = new ethers.providers.JsonRpcProvider(
      process.env.MANTLE_RPC_URL || 'https://rpc.mantle.xyz',
    );
  }

  /**
   * Get price from Chronicle Oracle
   * Uses Chronicle's IChronicle interface with proper error handling
   * @param oracleAddress Chronicle oracle contract address
   * @returns Price value (18 decimals) and timestamp
   */
  async getPrice(oracleAddress: string): Promise<{ price: bigint; timestamp: number }> {
    try {
      const oracle = new ethers.Contract(
        oracleAddress,
        this.ORACLE_ABI,
        this.provider,
      );

      // Use tryReadWithAge() for safe reading (doesn't revert)
      // Returns: (isValid, value, age)
      try {
        const [isValid, value, age] = await oracle.tryReadWithAge();
        
        if (!isValid) {
          throw new Error('Oracle value is not valid or stale');
        }
        
        // Chronicle returns value in 18 decimals (wei format)
        // age is Unix timestamp in seconds
        return {
          price: BigInt(value.toString()),
          timestamp: Number(age),
        };
      } catch (tryReadError) {
        // Fallback to readWithAge() if tryReadWithAge fails
        try {
          const [value, age] = await oracle.readWithAge();
          return {
            price: BigInt(value.toString()),
            timestamp: Number(age),
          };
        } catch (readError) {
          // Last fallback: try read() without age
          const value = await oracle.read();
          return {
            price: BigInt(value.toString()),
            timestamp: Math.floor(Date.now() / 1000), // Current timestamp as fallback
          };
        }
      }
    } catch (error) {
      this.logger.error(`Failed to get price from Chronicle oracle ${oracleAddress}`, error);
      throw error;
    }
  }
  
  /**
   * Check if Chronicle Oracle data is fresh
   * @param oracleAddress Chronicle oracle contract address
   * @param maxAgeSeconds Maximum acceptable age in seconds (default: 3 hours)
   * @returns True if data is fresh, false if stale
   */
  async isOracleDataFresh(
    oracleAddress: string,
    maxAgeSeconds: number = 3 * 60 * 60, // 3 hours default
  ): Promise<boolean> {
    try {
      const { timestamp } = await this.getPrice(oracleAddress);
      const currentTime = Math.floor(Date.now() / 1000);
      const age = currentTime - timestamp;
      
      return age <= maxAgeSeconds;
    } catch (error) {
      this.logger.warn(`Failed to check oracle data freshness: ${error.message}`);
      return false;
    }
  }

  /**
   * Get USDC price
   */
  async getUSDCPrice(): Promise<bigint> {
    const { price } = await this.getPrice(this.ORACLE_ADDRESSES.USDC);
    return price;
  }

  /**
   * Get USDT price
   */
  async getUSDTPrice(): Promise<bigint> {
    const { price } = await this.getPrice(this.ORACLE_ADDRESSES.USDT);
    return price;
  }

  /**
   * Get ETH price
   */
  async getETHPrice(): Promise<bigint> {
    const { price } = await this.getPrice(this.ORACLE_ADDRESSES.ETH);
    return price;
  }

  /**
   * Get MNT price
   */
  async getMNTPrice(): Promise<bigint> {
    const { price } = await this.getPrice(this.ORACLE_ADDRESSES.MNT);
    return price;
  }

  /**
   * Get property yield rate based on type
   * This would typically come from an RWA oracle or be calculated
   */
  async getPropertyYieldRate(propertyType: string): Promise<number> {
    // Base yield rates by property type
    const baseRates: Record<string, number> = {
      Residential: 5.0, // 5% APY
      Commercial: 8.0, // 8% APY
      Industrial: 12.0, // 12% APY
      Luxury: 15.0, // 15% APY
    };

    const baseRate = baseRates[propertyType] || 5.0;

    // In production, fetch from RWA oracle or adjust based on market conditions
    // For now, return base rate
    return baseRate;
  }

  /**
   * Calculate yield amount based on property value, yield rate, and time period
   * @param propertyValue Property value in wei (18 decimals)
   * @param yieldRate Annual yield rate as percentage (e.g., 5.0 for 5% APY)
   * @param days Number of days to calculate yield for
   * @returns Yield amount in wei (18 decimals)
   */
  async calculateYieldAmount(
    propertyValue: bigint,
    yieldRate: number,
    days: number,
  ): Promise<bigint> {
    // Convert yield rate from percentage to decimal (e.g., 5.0% -> 0.05)
    const yieldRateDecimal = yieldRate / 100;
    
    // Calculate annual yield: propertyValue * yieldRateDecimal
    const annualYield = (propertyValue * BigInt(Math.floor(yieldRateDecimal * 1e18))) / BigInt(1e18);
    
    // Calculate yield for the given number of days: annualYield * (days / 365)
    // Use 1e18 for precision in division
    const daysBigInt = BigInt(Math.floor(days * 1e18));
    const daysInYear = BigInt(365 * 1e18);
    const yieldAmount = (annualYield * daysBigInt) / daysInYear;
    
    return yieldAmount;
  }

  /**
   * Get RWA property value from Chronicle Oracle
   * Chronicle provides RWA data feeds including property values
   * Falls back to contract query if Chronicle oracle not configured
   */
  async getRWAPropertyValue(rwaContract: string, tokenId: string): Promise<bigint> {
    try {
      // Option 1: Use Chronicle's RWA oracle if available
      // Chronicle has 65+ data feeds including RWAs
      // Check if Chronicle RWA oracle is configured
      const chronicleRWAOracle = process.env.CHRONICLE_RWA_PROPERTY_ORACLE;
      
      if (chronicleRWAOracle && chronicleRWAOracle !== '0x...' && chronicleRWAOracle !== '0x') {
        try {
          const { price } = await this.getPrice(chronicleRWAOracle);
          this.logger.log(`Got RWA property value from Chronicle Oracle: ${price}`);
          return price;
        } catch (chronicleError) {
          this.logger.warn('Chronicle RWA oracle failed, falling back to contract query', chronicleError);
        }
      }
      
      // Option 2: Query RWA contract directly (if it implements IRWA interface)
      // This works with MockRWA contract or any RWA that implements getPropertyValue()
      try {
        const rwaContractInstance = new ethers.Contract(
          rwaContract,
          ['function getRWAProperty(uint256) external view returns (tuple(string name, uint256 value, uint256 monthlyYield, string location, uint256 createdAt, bool isActive))'],
          this.provider,
        );
        
        const property = await rwaContractInstance.getRWAProperty(tokenId);
        if (property && property.value) {
          this.logger.log(`Got RWA property value from contract: ${property.value}`);
          return BigInt(property.value.toString());
        }
      } catch (contractError) {
        this.logger.warn('RWA contract query failed', contractError);
      }
      
      // Option 3: Fallback to default value (for demo)
      // Return a default property value if all queries fail
      this.logger.warn(`All RWA property value queries failed for contract ${rwaContract}, token ${tokenId}. Returning default value.`);
      return BigInt(0); // Return 0 as fallback
    } catch (error) {
      this.logger.error(`Failed to get RWA property value for ${rwaContract}, token ${tokenId}`, error);
      // Return 0 as fallback on any error
      return BigInt(0);
    }
  }
}
</file>

<file path="backend/src/properties/properties.controller.ts">
import { Controller, Get, Post, Put, Param, Body } from '@nestjs/common';
import { PropertiesService } from './properties.service';

@Controller('properties')
export class PropertiesController {
  constructor(private readonly propertiesService: PropertiesService) {}

  @Get()
  findAll() {
    return this.propertiesService.findAll();
  }

  @Get(':id')
  findById(@Param('id') id: string) {
    return this.propertiesService.findById(id);
  }

  @Get('owner/:address')
  findByOwner(@Param('address') address: string) {
    return this.propertiesService.findByWalletAddress(address);
  }

  @Post('sync/:address')
  async syncFromChain(@Param('address') address: string) {
    try {
      const properties = await this.propertiesService.syncFromChain(address);
      // Convert BigInt values to strings for JSON serialization
      const serializedProperties = properties.map(prop => ({
        ...prop,
        value: prop.value?.toString() || prop.value,
        totalYieldEarned: prop.totalYieldEarned?.toString() || prop.totalYieldEarned,
      }));
      return {
        success: true,
        propertiesCount: properties.length,
        properties: serializedProperties,
      };
    } catch (error) {
      throw error;
    }
  }

  @Put(':tokenId/coordinates')
  updateCoordinates(
    @Param('tokenId') tokenId: string,
    @Body() body: { x: number; y: number },
  ) {
    return this.propertiesService.updateCoordinates(Number(tokenId), body.x, body.y);
  }

  @Post('sync-all')
  async syncAllFromChain() {
    try {
      const result = await this.propertiesService.syncAllExistingPropertiesFromChain();
      return {
        success: true,
        ...result,
        message: `Synced ${result.synced} properties for ${result.owners} owners`,
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'Unknown error',
        message: 'Failed to sync properties. Check backend logs for details.',
      };
    }
  }

  @Post('cleanup-old')
  async cleanupOldProperties() {
    try {
      const result = await this.propertiesService.cleanupOldProperties();
      return {
        success: true,
        deleted: result.deleted,
        message: `Deleted ${result.deleted} properties from old contract`,
      };
    } catch (error: any) {
      return {
        success: false,
        error: error.message || 'Unknown error',
        message: 'Failed to cleanup old properties. Check backend logs for details.',
      };
    }
  }
}
</file>

<file path="backend/src/websocket/websocket.gateway.ts">
import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  OnGatewayConnection,
  OnGatewayDisconnect,
  MessageBody,
  ConnectedSocket,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { Logger } from '@nestjs/common';

@WebSocketGateway({
  cors: {
    origin: process.env.CORS_ORIGIN || 'http://localhost:3000',
    credentials: true,
    methods: ['GET', 'POST'],
  },
  transports: ['websocket', 'polling'],
})
export class WebsocketGateway implements OnGatewayConnection, OnGatewayDisconnect {
  @WebSocketServer()
  server: Server;

  private readonly logger = new Logger(WebsocketGateway.name);

  constructor() {}

  handleConnection(client: Socket) {
    this.logger.log(`Client connected: ${client.id}`);
  }

  handleDisconnect(client: Socket) {
    this.logger.log(`Client disconnected: ${client.id}`);
  }

  @SubscribeMessage('subscribe:leaderboard')
  handleLeaderboardSubscribe(client: Socket) {
    client.join('leaderboard');
    this.logger.log(`Client ${client.id} subscribed to leaderboard`);
  }

  @SubscribeMessage('subscribe:portfolio')
  handlePortfolioSubscribe(client: Socket, data: { address: string }) {
    const room = `portfolio:${data.address.toLowerCase()}`;
    client.join(room);
    this.logger.log(`Client ${client.id} subscribed to portfolio: ${room}`);
  }

  @SubscribeMessage('subscribe:chat')
  handleChatSubscribe(client: Socket) {
    client.join('chat');
    this.logger.log(`Client ${client.id} subscribed to chat`);
  }

  @SubscribeMessage('chat:message')
  async handleChatMessage(
    @ConnectedSocket() client: Socket,
    @MessageBody() data: { walletAddress: string; message: string },
  ) {
    // Chat messages are handled via HTTP API, then broadcast here
    // This handler can be used for validation or additional processing
    this.logger.log(`Chat message received from ${data.walletAddress}`);
    return { success: true };
  }

  emitPropertyCreated(data: { propertyId: string; owner: string; propertyType: string }) {
    this.server.emit('property:created', data);
  }

  emitYieldClaimed(data: { propertyId: string; owner: string; amount: string }) {
    this.server.emit('yield:claimed', data);
    this.server.to(`portfolio:${data.owner}`).emit('portfolio:updated', data);
  }

  emitMarketplaceListing(data: { propertyId: number; seller: string; price: string }) {
    this.server.emit('marketplace:listing', data);
    this.logger.log(`Emitted marketplace:listing for property ${data.propertyId}`);
  }

  emitMarketplaceTrade(data: { listingId: number; seller: string; buyer: string; price: string }) {
    this.server.emit('marketplace:trade', data);
  }

  emitMarketplaceCancelled(data: { propertyId: number; seller: string }) {
    this.server.emit('marketplace:cancelled', data);
    this.logger.log(`Emitted marketplace:cancelled for property ${data.propertyId}`);
  }

  emitLeaderboardUpdate(data: { rankings: any[] }) {
    this.server.to('leaderboard').emit('leaderboard:updated', data);
  }

  emitChatMessage(data: { id: string; walletAddress: string; username?: string; message: string; createdAt: Date }) {
    this.server.to('chat').emit('chat:new', data);
  }

  emitYieldTimeUpdate(data: {
    walletAddress: string;
    yieldUpdateIntervalSeconds: number;
    currentBlockTimestamp: number;
    shortestTimeRemaining: { hours: number; minutes: number } | null;
    totalClaimableYield: string;
    properties: Array<{
      tokenId: number;
      lastYieldUpdate: number;
      createdAt: number;
      timeElapsedSeconds: number;
      timeElapsedHours: number;
      hoursRemaining: number;
      minutesRemaining: number;
      isClaimable: boolean;
      claimableYield: string;
    }>;
  }) {
    // Ensure all values are JSON-serializable (no BigInt)
    const serializableData = {
      ...data,
      totalClaimableYield: String(data.totalClaimableYield),
      properties: data.properties.map(p => ({
        ...p,
        claimableYield: String(p.claimableYield),
      })),
    };
    const room = `portfolio:${data.walletAddress.toLowerCase()}`;
    const clientsInRoom = this.server.sockets.adapter.rooms.get(room);
    const clientCount = clientsInRoom ? clientsInRoom.size : 0;
    this.logger.log(`Emitting yield:time-update to ${room} (${data.properties.length} properties, ${clientCount} clients)`);
    this.server.to(room).emit('yield:time-update', serializableData);
  }

  emitPriceUpdate(data: {
    mntPriceUSD: number;
    tycoonPriceUSD: number;
    timestamp: number;
  }) {
    // Broadcast to all connected clients
    this.server.emit('price:update', data);
    this.logger.debug(`Emitted price update: MNT/USD = $${data.mntPriceUSD.toFixed(4)}, TYCOON/USD = $${data.tycoonPriceUSD.toFixed(6)}`);
  }
}
</file>

<file path="contracts/README.md">
# Property Tycoon Smart Contracts

Smart contracts for Property Tycoon game. Deploy to Mantle. Test locally. Verify on explorer.

## What These Contracts Do

GameToken: ERC20 token for payments and rewards. Players use TYCOON tokens to mint properties. Properties generate yield in TYCOON tokens.

PropertyNFT: ERC721 NFT contract. Players mint property NFTs by spending TYCOON tokens. Each property is a unique NFT. Properties can be linked to RWA contracts.

YieldDistributor: Distributes yield to property owners. Calculates yield based on property value and yield rate. If property is linked to RWA, uses RWA value and yield rate for calculation. Handles single and batch yield claims. Distributes TYCOON tokens as rewards.

Marketplace: Property trading marketplace. Players list properties for sale. Other players buy properties. Prices set in TYCOON tokens. Handles property transfers.

QuestSystem: Investment quest system. Tracks quest completion. Distributes quest rewards. Rewards players for portfolio diversification.

TokenSwap: MNT to TYCOON token swap. Players buy TYCOON tokens with MNT. Exchange rate: 1 MNT = 100 TYCOON tokens.

MockRWA: Mock Real-World Asset contract for demo and testing. **Currently used for this demo instead of real Chronicle Oracle RWA.** Implements ERC-721 standard. Replaced with real RWA contracts in production. Simulates tokenized real estate assets. Chronicle Oracle integration is ready but not actively used in this demo.

## Prerequisites

Install Foundry. Get MNT for gas fees. Have a wallet ready.

Foundry installation: https://book.getfoundry.sh/getting-started/installation

## Installation

Clone the repository. Navigate to contracts folder. Install dependencies.

```bash
git clone <repository-url>
cd property-tycoon-mantle/contracts
forge install
```

Build contracts:

```bash
forge build
```

Run tests:

```bash
forge test
```

All tests must pass before deployment.

## Configuration

Create a `.env` file in the contracts directory:

```env
PRIVATE_KEY=0xyour_private_key_with_0x_prefix
MANTLE_RPC_URL=https://rpc.sepolia.mantle.xyz
ETHERSCAN_API_KEY=your_etherscan_api_key
MOCK_RWA_ADDRESS=0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45
```

Important notes:
- Private key must include 0x prefix
- Get testnet tokens from Mantle faucet
- Etherscan API key works for Mantle networks

## Get Testnet Tokens

Get testnet tokens before deploying:

- Mantle Sepolia Faucet: https://faucet.sepolia.mantle.xyz

You need MNT for gas fees.

## Deployment

### Deploy All Contracts

Deploy everything to Mantle Sepolia Testnet:

```bash
forge script script/FreshDeploy.s.sol:FreshDeployScript \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --broadcast \
  --verify
```

This deploys all contracts. Sets up relationships. Activates features. Verifies on explorer.

### Deploy Individual Contracts

Deploy contracts individually if needed:

```bash
# Deploy GameToken
forge create src/GameToken.sol:GameToken \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --verify

# Deploy PropertyNFT
forge create src/PropertyNFT.sol:PropertyNFT \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --verify

# Deploy YieldDistributor
forge create src/YieldDistributor.sol:YieldDistributor \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --constructor-args <GAME_TOKEN_ADDRESS> <PROPERTY_NFT_ADDRESS> \
  --verify

# Deploy MockRWA
forge create src/MockRWA.sol:MockRWA \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --verify
```

## Deployed Contracts

Mantle Sepolia Testnet:

GameToken: 0x3334f87178AD0f33e61009777a3dFa1756e9c23f

PropertyNFT: 0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c

YieldDistributor: 0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4 (Updated with RWA yield integration)

Marketplace: 0x6b6b65843117C55da74Ea55C954a329659EFBeF0

QuestSystem: 0x89f72227168De554A28874aA79Bcb6f0E8e2227C

TokenSwap: 0xAd22cC67E66F1F0b0D1Be33F53Bd0948796a460E

MockRWA: 0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45

View contracts on Mantle Explorer: https://explorer.sepolia.mantle.xyz

## Usage

### Buy TYCOON Tokens with MNT

Send MNT to TokenSwap contract. Receive TYCOON tokens.

Exchange rate: 1 MNT equals 100 TYCOON tokens.

Minimum purchase: 0.001 MNT.

### Mint Property NFT

Approve TYCOON tokens. Call `purchaseProperty` function on PropertyNFT contract.

Property types:
- Residential: 100 TYCOON tokens
- Commercial: 200 TYCOON tokens
- Industrial: 500 TYCOON tokens
- Luxury: 1000 TYCOON tokens

### Link Property to RWA

Call `linkToRWA` function on PropertyNFT contract.

Provide RWA contract address and token ID.

Property generates yield from RWA rental income.

Linking property to RWA updates yield calculation automatically. YieldDistributor contract checks if property is linked to RWA. If linked, fetches RWA value and yield rate from RWA contract using IRWA interface. Uses RWA data for yield calculation instead of property data. Property generates real yield from RWA rental income. Yield calculation now dynamically uses the linked RWA's value and yield rate. If RWA call fails or property not linked, falls back to property's own value and yield rate. Backward compatible with existing properties. All yield calculations happen on-chain via YieldDistributor contract.

### Claim Yield

Call `claimYield` or `batchClaimYield` function on YieldDistributor contract.

Yield calculated based on property value and yield rate. If property linked to RWA, uses RWA value and yield rate instead. RWA yield rate calculated from RWA monthly yield and value. Automatic fallback ensures all properties generate yield correctly.

Minimum 24 hours required before first claim.

### List Property for Sale

Approve Marketplace to transfer NFT.

Call `listProperty` function on Marketplace contract.

Set price in TYCOON tokens.

Choose fixed price or auction.

### Complete Quests

Call quest check functions on QuestSystem contract:
- `checkFirstPropertyQuest` - Own at least 1 property
- `checkDiversifyPortfolioQuest` - Own 3 different property types
- `checkPropertyMogulQuest` - Own at least 10 properties
- `checkRWAPioneerQuest` - Link 5 properties to RWA

Rewards automatically minted to player wallet.

### Mint RWA Properties for Different Addresses

Use the `MintRWAForAddresses` script to distribute RWA tokens:

1. Edit `script/MintRWAForAddresses.s.sol`
2. Update the `recipients` array with target addresses
3. Set `MOCK_RWA_ADDRESS=0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45` in `.env`
4. Run:

```bash
forge script script/MintRWAForAddresses.s.sol:MintRWAForAddresses \
  --rpc-url https://rpc.sepolia.mantle.xyz \
  --broadcast
```

Uses MockRWA for demo and testing. Allows testing RWA linking without real tokenized assets. Perfect for hackathons and demos. Replaced with real RWA contracts in production.

## Mantle Network Benefits

Property minting costs 0.001 MNT. Yield claiming costs 0.0005 MNT. Marketplace trading costs 0.002 MNT. Quest completion costs 0.001 MNT.

Supports real-time multiplayer interactions. Handles concurrent property minting. Processes multiple yield claims simultaneously.

Sub-second transaction confirmation. Instant portfolio updates. Real-time leaderboard synchronization.

Standard Solidity contracts. Works with existing tooling. OpenZeppelin contracts integration.

## Mantle Integration in Contracts

Contracts deployed on Mantle Sepolia Testnet. Optimized for Mantle's low fees and high throughput.

Why Mantle for Property Tycoon:
- Low gas costs enable frequent yield claims
- High throughput supports real-time multiplayer
- Fast finality ensures instant portfolio updates
- EVM compatibility works with existing tools

Contract verification uses Mantle Explorer API. Automatic verification during deployment. Manual verification supported via Etherscan API key.

Gas optimization:
- Property minting optimized for batch operations
- Yield claiming uses minimal gas
- Marketplace trades cost less than other chains
- Quest completion requires minimal gas

All contracts use standard Solidity patterns. OpenZeppelin contracts for security. ReentrancyGuard on all state-changing functions. SafeERC20 for token transfers.

## Testing

Run all tests:

```bash
forge test
```

Run with detailed output:

```bash
forge test -vvv
```

Run specific test:

```bash
forge test --match-test testMintProperty
```

## Frontend Integration

### Connect to Mantle Network

```typescript
import { defineChain } from "viem";

const mantleSepolia = defineChain({
  id: 5003,
  name: "Mantle Sepolia",
  network: "mantle-sepolia",
  nativeCurrency: {
    name: "Mantle",
    symbol: "MNT",
    decimals: 18
  },
  rpcUrls: {
    default: {
      http: ["https://rpc.sepolia.mantle.xyz"]
    }
  },
  blockExplorers: {
    default: {
      name: "Mantle Explorer",
      url: "https://explorer.sepolia.mantle.xyz"
    }
  }
});
```

### Get Contract Instance

```typescript
import { getContract } from "wagmi/actions";

const propertyNFT = getContract({
  address: "0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c",
  abi: PropertyNFTABI,
});
```

### Mint Property

```typescript
await writeContract({
  address: PROPERTY_NFT_ADDRESS,
  abi: PropertyNFTABI,
  functionName: "purchaseProperty",
  args: [propertyType, value, yieldRate],
  value: parseEther("0"), // No ETH needed, uses TYCOON tokens
});
```

### Claim Yield

```typescript
await writeContract({
  address: YIELD_DISTRIBUTOR_ADDRESS,
  abi: YieldDistributorABI,
  functionName: "batchClaimYield",
  args: [propertyIds],
});
```

### Link to RWA

```typescript
await writeContract({
  address: PROPERTY_NFT_ADDRESS,
  abi: PropertyNFTABI,
  functionName: "linkToRWA",
  args: [propertyTokenId, rwaContractAddress, rwaTokenId],
});
```

## Network Configuration

Mantle Sepolia Testnet:
- Chain ID: 5003
- RPC: https://rpc.sepolia.mantle.xyz
- Explorer: https://explorer.sepolia.mantle.xyz

Mantle Mainnet:
- Chain ID: 5000
- RPC: https://rpc.mantle.xyz
- Explorer: https://explorer.mantle.xyz

## Contract Verification

Contracts verify automatically during deployment using Etherscan API key.

Verification works on Mantle networks.

Manual verification:

```bash
forge verify-contract <CONTRACT_ADDRESS> <CONTRACT_PATH>:<CONTRACT_NAME> \
  --chain-id 5003 \
  --verifier etherscan \
  --verifier-url https://explorer.sepolia.mantle.xyz/api \
  --etherscan-api-key $ETHERSCAN_API_KEY \
  --constructor-args <ARGS>
```

## Project Structure

```
contracts/
 src/
    GameToken.sol
    PropertyNFT.sol
    YieldDistributor.sol
    Marketplace.sol
    QuestSystem.sol
    TokenSwap.sol
    MockRWA.sol
 test/
    PropertyNFT.t.sol
 script/
    FreshDeploy.s.sol
    DeployAll.s.sol
    DeployMockRWA.s.sol
    MintRWAForAddresses.s.sol
 foundry.toml
 README.md
```

## Security

Contracts include security features:
- ReentrancyGuard prevents reentrancy attacks
- SafeERC20 handles token transfers safely
- Input validation on all functions
- Owner-only functions protected
- Supply limits enforced
- Access control for critical operations

## Troubleshooting

Deployment fails:
- Check `.env` file has correct values
- Ensure you have enough MNT for gas fees
- Verify network connectivity
- Check contract compilation: `forge build`

Verification fails:
- Ensure `ETHERSCAN_API_KEY` is set in `.env`
- Check API key is valid
- Wait a few minutes after deployment before verification
- Try manual verification on explorer

Tests fail:
- Run `forge clean` and rebuild
- Check Solidity version matches (0.8.24)
- Verify dependencies installed: `forge install`

## Contract Update Notes

After deploying new contracts:
- Update contract addresses in backend `.env`
- Update contract addresses in frontend `.env.local`
- Update contract addresses in source files
- Verify all contracts on explorer
- Test full flow: buy TYCOON, mint property, link RWA, claim yield, complete quest

## Support

For issues or questions:
- Mantle Documentation: https://docs.mantle.xyz
- Foundry Book: https://book.getfoundry.sh
- OpenZeppelin Contracts: https://docs.openzeppelin.com/contracts
</file>

<file path="contracts/script/CheckOldMarketplace.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {Marketplace} from "../src/Marketplace.sol";
import {PropertyNFT} from "../src/PropertyNFT.sol";

/**
 * @title CheckOldMarketplaceScript
 * @notice Check which properties are in the old marketplace
 */
contract CheckOldMarketplaceScript is Script {
    function run() external {
        address oldMarketplaceAddress = vm.envAddress("OLD_MARKETPLACE_ADDRESS");
        address propertyNFTAddress = vm.envAddress("PROPERTY_NFT_ADDRESS");
        
        console.log("Checking old marketplace:", oldMarketplaceAddress);
        console.log("PropertyNFT address:", propertyNFTAddress);
        
        Marketplace oldMarketplace = Marketplace(payable(oldMarketplaceAddress));
        PropertyNFT propertyNFT = PropertyNFT(propertyNFTAddress);
        
        // Try to get active listings count
        try oldMarketplace.getActiveListingsCount() returns (uint256 count) {
            console.log("Active listings count:", count);
            
            if (count > 0) {
                // Get active listings
                (uint256[] memory propertyIds, address[] memory sellers, uint256[] memory prices) = 
                    oldMarketplace.getActiveListings();
                
                console.log("\nActive Listings:");
                for (uint256 i = 0; i < propertyIds.length; i++) {
                    console.log("Property ID:", propertyIds[i]);
                    console.log("  Seller:", sellers[i]);
                    console.log("  Price:", prices[i]);
                    console.log("");
                }
            }
        } catch {
            console.log("getActiveListingsCount() not available, checking properties owned by marketplace...");
            
            // Get properties owned by marketplace
            uint256[] memory ownedProperties = propertyNFT.getOwnerProperties(oldMarketplaceAddress);
            console.log("Properties owned by old marketplace:", ownedProperties.length);
            
            for (uint256 i = 0; i < ownedProperties.length; i++) {
                uint256 propertyId = ownedProperties[i];
                console.log("Property ID:", propertyId);
                
                // Check if it's listed
                try oldMarketplace.listings(propertyId) returns (
                    uint256,
                    address seller,
                    uint256 price,
                    bool isActive,
                    uint256
                ) {
                    if (isActive) {
                        console.log("  Status: ACTIVE LISTING");
                        console.log("  Seller:", seller);
                        console.log("  Price:", price);
                    } else {
                        console.log("  Status: NOT ACTIVE (may need recovery)");
                    }
                } catch {
                    console.log("  Status: Could not check listing status");
                }
                console.log("");
            }
        }
    }
}
</file>

<file path="contracts/script/DeployTokenSwap.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {TokenSwap} from "../src/TokenSwap.sol";
import {GameToken} from "../src/GameToken.sol";

contract DeployTokenSwap is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Deploying TokenSwap contract...");
        console.log("GameToken address:", gameTokenAddress);
        
        TokenSwap tokenSwap = new TokenSwap(gameTokenAddress);
        
        console.log("TokenSwap deployed at:", address(tokenSwap));
        console.log("Exchange rate: 1 MNT = 100 TYCOON");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/FundTokenSwap.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";

/**
 * @notice Fund TokenSwap contract with TYCOON tokens for users to purchase
 * @dev Transfer tokens from deployer to TokenSwap contract
 */
contract FundTokenSwap is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        address tokenSwapAddress = vm.envAddress("TOKEN_SWAP_ADDRESS");
        uint256 amount = vm.envUint("AMOUNT"); // Amount in TYCOON tokens (with 18 decimals)
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Funding TokenSwap contract with TYCOON tokens...");
        console.log("GameToken address:", gameTokenAddress);
        console.log("TokenSwap address:", tokenSwapAddress);
        console.log("Amount:", amount / 1e18, "TYCOON");
        
        GameToken gameToken = GameToken(gameTokenAddress);
        
        // Check deployer balance
        uint256 deployerBalance = gameToken.balanceOf(vm.addr(deployerPrivateKey));
        console.log("Deployer balance:", deployerBalance / 1e18, "TYCOON");
        require(deployerBalance >= amount, "Insufficient balance");
        
        // Transfer tokens to TokenSwap
        require(gameToken.transfer(tokenSwapAddress, amount), "Transfer failed");
        
        uint256 swapBalance = gameToken.balanceOf(tokenSwapAddress);
        console.log("TokenSwap balance:", swapBalance / 1e18, "TYCOON");
        console.log("Successfully funded TokenSwap!");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/RecoverListings.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {Marketplace} from "../src/Marketplace.sol";

/**
 * @title RecoverListingsScript
 * @notice Script to cancel listings and recover properties from marketplace
 * @dev Use this to cancel your listings and get your properties back
 */
contract RecoverListingsScript is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerPrivateKey);
        
        address marketplaceAddress = vm.envAddress("MARKETPLACE_ADDRESS");
        console.log("Marketplace address:", marketplaceAddress);
        
        Marketplace marketplace = Marketplace(payable(marketplaceAddress));
        
        // Get all properties owned by marketplace
        // Note: You need to know which property IDs you listed
        // This script assumes you'll provide them via environment variable
        
        string memory propertyIdsStr = vm.envString("PROPERTY_IDS");
        console.log("Property IDs to recover:", propertyIdsStr);
        
        // Parse comma-separated property IDs
        string[] memory propertyIdStrings = vm.split(propertyIdsStr, ",");
        
        for (uint256 i = 0; i < propertyIdStrings.length; i++) {
            uint256 propertyId = vm.parseUint(propertyIdStrings[i]);
            console.log("Attempting to cancel listing for property ID:", propertyId);
            
            try marketplace.cancelListing(propertyId) {
                console.log("Successfully cancelled listing for property:", propertyId);
            } catch Error(string memory reason) {
                console.log("Failed to cancel property", propertyId, ":", reason);
            } catch (bytes memory) {
                console.log("Failed to cancel property", propertyId, ": Unknown error");
            }
        }
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/script/SetupQuestSystemMinter.s.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import {Script, console} from "forge-std/Script.sol";
import {GameToken} from "../src/GameToken.sol";

/**
 * @notice Set QuestSystem as minter in GameToken
 * @dev Run this after deploying QuestSystem
 */
contract SetupQuestSystemMinter is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address gameTokenAddress = vm.envAddress("GAME_TOKEN_ADDRESS");
        address questSystemAddress = vm.envAddress("QUEST_SYSTEM_ADDRESS");
        
        vm.startBroadcast(deployerPrivateKey);
        
        console.log("Setting QuestSystem as minter in GameToken...");
        console.log("GameToken address:", gameTokenAddress);
        console.log("QuestSystem address:", questSystemAddress);
        
        GameToken gameToken = GameToken(gameTokenAddress);
        gameToken.setMinter(questSystemAddress, true);
        
        bool isMinter = gameToken.minters(questSystemAddress);
        console.log("QuestSystem is minter:", isMinter);
        require(isMinter, "Failed to set minter");
        
        console.log("Successfully set QuestSystem as minter!");
        
        vm.stopBroadcast();
    }
}
</file>

<file path="contracts/src/TokenSwap.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "./GameToken.sol";

/**
 * @title TokenSwap
 * @notice Allows users to buy TYCOON tokens with MNT
 * @dev Exchange rate: 1 MNT = 100 TYCOON tokens
 */
contract TokenSwap is Ownable, ReentrancyGuard {
    GameToken public gameToken;
    
    // Exchange rate: 1 MNT = 100 TYCOON tokens (100 * 10^18 wei)
    uint256 public constant EXCHANGE_RATE = 100;
    uint256 public constant MIN_PURCHASE_MNT = 0.001 ether; // Minimum 0.001 MNT
    
    event TokensPurchased(address indexed buyer, uint256 mntAmount, uint256 tycoonAmount);
    event TokensWithdrawn(address indexed to, uint256 amount);
    
    constructor(address _gameToken) Ownable(msg.sender) {
        gameToken = GameToken(_gameToken);
    }
    
    /**
     * @notice Buy TYCOON tokens with MNT
     * @dev Sends MNT to contract, transfers TYCOON tokens to buyer
     */
    function buyTokens() public payable nonReentrant {
        require(msg.value >= MIN_PURCHASE_MNT, "Minimum purchase is 0.001 MNT");
        
        // Calculate TYCOON amount: MNT amount * EXCHANGE_RATE
        // msg.value is in wei, so we multiply by EXCHANGE_RATE
        uint256 tycoonAmount = msg.value * EXCHANGE_RATE;
        
        // Check if contract has enough tokens
        uint256 contractBalance = gameToken.balanceOf(address(this));
        require(contractBalance >= tycoonAmount, "Insufficient tokens in swap contract");
        
        // Transfer TYCOON tokens to buyer
        require(gameToken.transfer(msg.sender, tycoonAmount), "Token transfer failed");
        
        emit TokensPurchased(msg.sender, msg.value, tycoonAmount);
    }
    
    /**
     * @notice Owner can withdraw MNT from contract
     */
    function withdrawMNT() public onlyOwner {
        uint256 balance = address(this).balance;
        require(balance > 0, "No MNT to withdraw");
        payable(owner()).transfer(balance);
    }
    
    /**
     * @notice Owner can deposit TYCOON tokens to contract for users to purchase
     */
    function depositTokens(uint256 amount) public {
        require(gameToken.transferFrom(msg.sender, address(this), amount), "Token transfer failed");
    }
    
    /**
     * @notice Owner can withdraw TYCOON tokens from contract (emergency)
     */
    function withdrawTokens(uint256 amount) public onlyOwner {
        require(gameToken.transfer(owner(), amount), "Token transfer failed");
        emit TokensWithdrawn(owner(), amount);
    }
    
    /**
     * @notice Get the amount of TYCOON tokens for a given MNT amount
     */
    function getTycoonAmount(uint256 mntAmount) public pure returns (uint256) {
        return mntAmount * EXCHANGE_RATE;
    }
    
    /**
     * @notice Get the amount of MNT needed for a given TYCOON amount
     */
    function getMntAmount(uint256 tycoonAmount) public pure returns (uint256) {
        return tycoonAmount / EXCHANGE_RATE;
    }
    
    /**
     * @notice Get contract's TYCOON token balance
     */
    function getTokenBalance() public view returns (uint256) {
        return gameToken.balanceOf(address(this));
    }
}
</file>

<file path="contracts/src/YieldDistributor.sol">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import "./PropertyNFT.sol";
import "./GameToken.sol";

// Interface for RWA contracts (MockRWA or real RWA)
interface IRWA {
    function getRWAProperty(uint256 tokenId) external view returns (
        string memory name,
        uint256 value,
        uint256 monthlyYield,
        string memory location,
        uint256 createdAt,
        bool isActive
    );
    function getYieldRate(uint256 tokenId) external view returns (uint256);
    function properties(uint256 tokenId) external view returns (
        string memory name,
        uint256 value,
        uint256 monthlyYield,
        string memory location,
        uint256 createdAt,
        bool isActive
    );
}

contract YieldDistributor is ReentrancyGuard, Ownable {
    PropertyNFT public propertyNFT;
    GameToken public gameToken;
    
    mapping(uint256 => uint256) public pendingYield;
    mapping(address => uint256) public totalYieldClaimed;
    mapping(uint256 => uint256) public lastYieldUpdate;
    
    uint256 public constant YIELD_UPDATE_INTERVAL = 1 days;
    
    event YieldDistributed(uint256 indexed propertyId, uint256 amount);
    event YieldClaimed(uint256 indexed propertyId, address indexed owner, uint256 amount);
    event BatchYieldDistributed(uint256[] propertyIds, uint256[] amounts);
    event BatchYieldClaimed(address indexed owner, uint256[] propertyIds, uint256 totalAmount);
    
    constructor(address _propertyNFT, address _gameToken) Ownable(msg.sender) {
        propertyNFT = PropertyNFT(_propertyNFT);
        gameToken = GameToken(_gameToken);
    }
    
    function distributeYield(uint256 propertyId, uint256 amount) public {
        require(amount > 0, "Invalid amount");
        pendingYield[propertyId] += amount;
        lastYieldUpdate[propertyId] = block.timestamp;
        emit YieldDistributed(propertyId, amount);
    }
    
    function batchDistributeYield(
        uint256[] calldata propertyIds,
        uint256[] calldata amounts
    ) public {
        require(propertyIds.length == amounts.length, "Array length mismatch");
        require(propertyIds.length > 0 && propertyIds.length <= 100, "Invalid batch size");
        
        for (uint256 i = 0; i < propertyIds.length; i++) {
            if (amounts[i] > 0) {
                pendingYield[propertyIds[i]] += amounts[i];
                lastYieldUpdate[propertyIds[i]] = block.timestamp;
            }
        }
        
        emit BatchYieldDistributed(propertyIds, amounts);
    }
    
    function claimYield(uint256 propertyId) public nonReentrant {
        require(propertyNFT.ownerOf(propertyId) == msg.sender, "Not owner");
        uint256 amount = calculateYield(propertyId); // Use calculateYield to get actual claimable amount (includes time check)
        require(amount > 0, "No yield to claim");
        
        // Clear pendingYield and update lastYieldUpdate
        pendingYield[propertyId] = 0;
        lastYieldUpdate[propertyId] = block.timestamp;
        totalYieldClaimed[msg.sender] += amount;
        
        // Mint tokens directly to the user (yield is generated, not transferred)
        gameToken.mint(msg.sender, amount);
        emit YieldClaimed(propertyId, msg.sender, amount);
    }
    
    function batchClaimYield(uint256[] calldata propertyIds) public nonReentrant {
        require(propertyIds.length > 0 && propertyIds.length <= 50, "Invalid batch size");
        
        uint256 totalAmount = 0;
        
        for (uint256 i = 0; i < propertyIds.length; i++) {
            require(propertyNFT.ownerOf(propertyIds[i]) == msg.sender, "Not owner");
            uint256 amount = calculateYield(propertyIds[i]); // Use calculateYield to get actual claimable amount (includes time check)
            if (amount > 0) {
                pendingYield[propertyIds[i]] = 0;
                lastYieldUpdate[propertyIds[i]] = block.timestamp;
                totalAmount += amount;
            }
        }
        
        require(totalAmount > 0, "No yield to claim");
        
        totalYieldClaimed[msg.sender] += totalAmount;
        
        // Mint tokens directly to the user (yield is generated, not transferred)
        gameToken.mint(msg.sender, totalAmount);
        
        emit BatchYieldClaimed(msg.sender, propertyIds, totalAmount);
    }
    
    function calculateYield(uint256 propertyId) public view returns (uint256) {
        PropertyNFT.Property memory prop = propertyNFT.getProperty(propertyId);
        
        // Determine which value and yieldRate to use
        uint256 value;
        uint256 yieldRate;
        
        // Check if property is linked to RWA
        if (prop.rwaContract != address(0) && prop.rwaTokenId > 0) {
            // Try to fetch RWA data
            try IRWA(prop.rwaContract).getRWAProperty(prop.rwaTokenId) returns (
                string memory,
                uint256 rwaValue,
                uint256,
                string memory,
                uint256,
                bool isActive
            ) {
                // Only use RWA data if RWA is active and has valid value
                if (isActive && rwaValue > 0) {
                    value = rwaValue;
                    // Get yield rate from RWA contract
                    try IRWA(prop.rwaContract).getYieldRate(prop.rwaTokenId) returns (uint256 rwaYieldRate) {
                        if (rwaYieldRate > 0) {
                            yieldRate = rwaYieldRate;
                        } else {
                            // Fallback to property yieldRate if RWA yieldRate is 0
                            value = prop.value;
                            yieldRate = prop.yieldRate;
                        }
                    } catch {
                        // If getYieldRate fails, fallback to property data
                        value = prop.value;
                        yieldRate = prop.yieldRate;
                    }
                } else {
                    // RWA not active or invalid, use property data
                    value = prop.value;
                    yieldRate = prop.yieldRate;
                }
            } catch {
                // If RWA contract call fails, fallback to property data (backward compatible)
                value = prop.value;
                yieldRate = prop.yieldRate;
            }
        } else {
            // Not linked to RWA, use property's own data (existing behavior)
            value = prop.value;
            yieldRate = prop.yieldRate;
        }
        
        // Validate value and yieldRate
        if (value == 0 || yieldRate == 0) return 0;
        
        // If lastYieldUpdate is 0, use property creation time (first time)
        uint256 lastUpdate = lastYieldUpdate[propertyId];
        if (lastUpdate == 0) {
            lastUpdate = prop.createdAt;
        }
        
        uint256 timeSinceUpdate = block.timestamp - lastUpdate;
        
        // Cap yield calculation to prevent overflow (max 365 days)
        if (timeSinceUpdate > 365 days) {
            timeSinceUpdate = 365 days;
        }
        
        if (timeSinceUpdate < YIELD_UPDATE_INTERVAL) {
            return pendingYield[propertyId];
        }
        
        // Calculate daily yield: (value * yieldRate) / (365 * 10000)
        // yieldRate is in basis points (500 = 5%)
        uint256 dailyYield = (value * yieldRate) / (365 * 10000);
        uint256 periods = timeSinceUpdate / YIELD_UPDATE_INTERVAL;
        
        // Cap periods to prevent overflow
        if (periods > 365) {
            periods = 365;
        }
        
        return pendingYield[propertyId] + (dailyYield * periods);
    }
    
    function getTotalPendingYield(address owner) public view returns (uint256) {
        uint256[] memory properties = propertyNFT.getOwnerProperties(owner);
        uint256 total = 0;
        
        for (uint256 i = 0; i < properties.length; i++) {
            total += calculateYield(properties[i]);
        }
        
        return total;
    }
}
</file>

<file path="frontend/app/leaderboard/page.tsx">
'use client';

import { Leaderboard } from '@/components/Leaderboard';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';

export default function LeaderboardPage() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
      {/* Header */}
      <header className="border-b border-white/10 bg-gray-900/50 backdrop-blur-sm sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/game">
              <Button variant="ghost" size="sm" className="text-white hover:bg-white/10">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Back to Game
              </Button>
            </Link>
            <h1 className="text-2xl font-bold text-white">Leaderboard</h1>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="container mx-auto px-4 py-8">
        <div className="max-w-4xl mx-auto">
          <Leaderboard />
        </div>
      </main>
    </div>
  );
}
</file>

<file path="frontend/src/components/game/PropertyCard.tsx">
'use client';

import { Building2, TrendingUp, DollarSign } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useMNTPrice, tycoonToUSD, formatUSD } from '@/hooks/useMNTPrice';

interface PropertyCardProps {
  property: {
    id: string;
    tokenId: number;
    propertyType: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury';
    value: bigint;
    yieldRate: number;
    totalYieldEarned: bigint;
  };
  claimableYield?: bigint; // Claimable yield for this specific property (from contract)
  onClaimYield?: () => void | Promise<void>;
  onViewDetails?: () => void;
  isClaiming?: boolean;
}

const PROPERTY_COLORS = {
  Residential: 'bg-blue-500',
  Commercial: 'bg-green-500',
  Industrial: 'bg-orange-500',
  Luxury: 'bg-pink-500',
};

export function PropertyCard({ property, claimableYield, onClaimYield, onViewDetails, isClaiming = false }: PropertyCardProps) {
  const { tycoonPriceUSD } = useMNTPrice();
  
  const formatValue = (value: bigint) => {
    return (Number(value) / 1e18).toFixed(2);
  };

  return (
    <Card className="border-white/10 bg-white/5 backdrop-blur-md">
      <CardHeader>
        <div className="flex items-center gap-3">
          <div className={`w-12 h-12 rounded-lg ${PROPERTY_COLORS[property.propertyType]} flex items-center justify-center`}>
            <Building2 className="w-6 h-6 text-white" />
          </div>
          <div>
            <CardTitle className="text-white">{property.propertyType}</CardTitle>
            <p className="text-sm text-gray-400">Token ID: #{property.tokenId}</p>
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div>
            <p className="text-xs text-gray-400 mb-1">Value</p>
            <p className="text-lg font-semibold text-white flex items-center gap-1">
              <DollarSign className="w-4 h-4" />
              {formatValue(property.value)} TYCOON
              {tycoonPriceUSD && (
                <span className="text-xs text-gray-400 ml-1">
                  {formatUSD(tycoonToUSD(property.value, tycoonPriceUSD))}
                </span>
              )}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 mb-1">Yield Rate</p>
            <p className="text-lg font-semibold text-emerald-400 flex items-center gap-1">
              <TrendingUp className="w-4 h-4" />
              {(property.yieldRate / 100).toFixed(1)}% APY
            </p>
          </div>
        </div>
        
        <div>
          <p className="text-xs text-gray-400 mb-1">Total Yield Earned</p>
          <p className="text-xl font-bold text-emerald-500">
            {formatValue(property.totalYieldEarned)} TYCOON
            {tycoonPriceUSD && (
              <span className="text-sm text-gray-400 ml-2">
                {formatUSD(tycoonToUSD(property.totalYieldEarned, tycoonPriceUSD))}
              </span>
            )}
          </p>
        </div>

        <div className="flex gap-2">
          {onClaimYield && (
            <Button 
              onClick={onClaimYield} 
              disabled={isClaiming || !claimableYield || claimableYield === BigInt(0)}
              className="flex-1 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
              title={!claimableYield || claimableYield === BigInt(0) ? 'No yield available yet. Requires 24 hours after property creation.' : 'Claim your yield'}
            >
              {isClaiming ? 'Claiming...' : claimableYield && claimableYield > BigInt(0) ? 'Claim Yield' : 'No Yield Yet'}
            </Button>
          )}
          {onViewDetails && (
            <Button onClick={onViewDetails} variant="outline" className="flex-1">
              Details
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="frontend/src/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"
import { cn } from "@/lib/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="frontend/src/components/ui/card.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-lg border bg-card text-card-foreground shadow-sm",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="frontend/src/components/ui/scroll-area.tsx">
"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
import { cn } from "@/lib/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }
</file>

<file path="frontend/src/components/VisitPortfolio.tsx">
'use client'

import { useState, useEffect } from 'react'
import { X, Building2, TrendingUp, DollarSign } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { api } from '@/lib/api'
import { formatAddress } from '@/lib/utils'
import { getOwnerProperties, CONTRACTS, PROPERTY_NFT_ABI } from '@/lib/contracts'
import { readContract } from 'wagmi/actions'
import { wagmiConfig } from '@/lib/mantle-viem'

interface Property {
  id: string
  tokenId: number
  propertyType: string
  value: bigint
  yieldRate: number
  totalYieldEarned: bigint
}

interface VisitPortfolioProps {
  address: string
  username?: string
  onClose: () => void
}

export function VisitPortfolio({ address, username, onClose }: VisitPortfolioProps) {
  const [properties, setProperties] = useState<Property[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [totalValue, setTotalValue] = useState<bigint>(BigInt(0))
  const [totalYield, setTotalYield] = useState<bigint>(BigInt(0))

  useEffect(() => {
    loadPortfolio()
  }, [address])

  const loadPortfolio = async () => {
    setIsLoading(true)
    try {
      // Try backend first (faster if synced)
      try {
        const data = await api.get(`/properties/owner/${address}`)
        if (data && data.length > 0) {
          // Backend returns array directly
          const backendProperties = Array.isArray(data) ? data : (data.properties || [])
          const formattedProps = backendProperties.map((p: any) => ({
            id: p.id || `prop-${p.tokenId}`,
            tokenId: p.tokenId,
            propertyType: p.propertyType,
            value: BigInt(p.value?.toString() || '0'),
            yieldRate: p.yieldRate || 0,
            totalYieldEarned: BigInt(p.totalYieldEarned?.toString() || '0'),
          }))
          setProperties(formattedProps)
          
          const totalVal = formattedProps.reduce((sum: bigint, p: { value: bigint; totalYieldEarned: bigint }) => sum + p.value, BigInt(0))
          const totalYld = formattedProps.reduce((sum: bigint, p: { value: bigint; totalYieldEarned: bigint }) => sum + p.totalYieldEarned, BigInt(0))
          setTotalValue(totalVal)
          setTotalYield(totalYld)
          setIsLoading(false)
          return
        }
      } catch (backendError) {
        console.warn('Backend unavailable, loading from blockchain:', backendError)
      }
      
      // Fallback to blockchain (source of truth)
      console.log('Loading properties from blockchain for:', address)
      const tokenIds = await getOwnerProperties(address as `0x${string}`)
      if (!Array.isArray(tokenIds) || tokenIds.length === 0) {
        setProperties([])
        setTotalValue(BigInt(0))
        setTotalYield(BigInt(0))
        setIsLoading(false)
        return
      }
      
      // Get property data from blockchain
      const blockchainProperties = await Promise.all(
        tokenIds.map(async (tokenId) => {
          try {
            const propData = await readContract(wagmiConfig, {
              address: CONTRACTS.PropertyNFT,
              abi: PROPERTY_NFT_ABI,
              functionName: 'getProperty',
              args: [BigInt(Number(tokenId))],
            }) as {
              propertyType: bigint | number;
              value: bigint;
              yieldRate: bigint;
              totalYieldEarned: bigint;
            };
            
            const propertyTypeNum = typeof propData.propertyType === 'bigint' 
              ? Number(propData.propertyType) 
              : Number(propData.propertyType);
            const propertyTypes = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
            
            // Convert yieldRate to percentage
            let yieldRateValue = Number(propData.yieldRate.toString());
            if (yieldRateValue > 1e15) {
              yieldRateValue = Number(propData.yieldRate.toString()) / 1e18 * 100;
            } else if (yieldRateValue < 100 && yieldRateValue > 0) {
              yieldRateValue = yieldRateValue * 100;
            }
            if (yieldRateValue < 100) {
              yieldRateValue = 500; // Default 5%
            }
            
            return {
              id: `prop-${tokenId}`,
              tokenId: Number(tokenId),
              propertyType: propertyTypes[propertyTypeNum] || 'Residential',
              value: BigInt(propData.value.toString()),
              yieldRate: yieldRateValue / 100, // Convert to percentage
              totalYieldEarned: BigInt(propData.totalYieldEarned.toString()),
            };
          } catch (error) {
            console.error(`Failed to load property ${tokenId}:`, error)
            return null
          }
        })
      )
      
      const validProperties = blockchainProperties.filter((p): p is NonNullable<typeof p> => p !== null)
      setProperties(validProperties)
      
      const totalVal = validProperties.reduce((sum, p) => sum + p.value, BigInt(0))
      const totalYld = validProperties.reduce((sum, p) => sum + p.totalYieldEarned, BigInt(0))
      setTotalValue(totalVal)
      setTotalYield(totalYld)
      
      console.log(` Loaded ${validProperties.length} properties from blockchain for ${address}`)
    } catch (error) {
      console.error('Failed to load portfolio:', error)
      setProperties([])
      setTotalValue(BigInt(0))
      setTotalYield(BigInt(0))
    } finally {
      setIsLoading(false)
    }
  }

  const formatValue = (value: bigint) => {
    const amount = Number(value) / 1e18
    if (amount < 1) return amount.toFixed(4)
    return amount.toFixed(2)
  }

  return (
    <div 
      className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[9999] p-4"
      style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0 }}
      onClick={(e) => {
        // Close when clicking backdrop
        if (e.target === e.currentTarget) {
          onClose();
        }
      }}
    >
      <Card 
        className="bg-gray-900 border-white/20 w-full max-w-3xl max-h-[90vh] flex flex-col mx-auto my-auto"
        style={{ margin: 'auto' }}
        onClick={(e) => e.stopPropagation()}
      >
        <CardHeader className="flex-shrink-0 bg-gray-900 border-b border-white/10 flex flex-row items-center justify-between">
          <div>
            <CardTitle className="text-2xl font-bold text-white">
              {username || formatAddress(address)}'s Portfolio
            </CardTitle>
            <p className="text-sm text-gray-400 mt-1">{formatAddress(address)}</p>
          </div>
          <Button 
            onClick={onClose} 
            variant="ghost" 
            size="sm" 
            className="text-white hover:bg-white/10 rounded-full p-2"
            aria-label="Close"
          >
            <X className="w-5 h-5" />
          </Button>
        </CardHeader>
        <CardContent className="p-6 flex-1 overflow-y-auto min-h-0">
          <div className="grid grid-cols-2 gap-4 mb-6">
            <Card className="bg-blue-500/10 border-blue-500/20">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <Building2 className="w-5 h-5 text-blue-400" />
                  <span className="text-sm text-gray-400">Total Value</span>
                </div>
                <p className="text-2xl font-bold text-white">{formatValue(totalValue)} TYCOON</p>
              </CardContent>
            </Card>
            <Card className="bg-emerald-500/10 border-emerald-500/20">
              <CardContent className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  <TrendingUp className="w-5 h-5 text-emerald-400" />
                  <span className="text-sm text-gray-400">Total Yield</span>
                </div>
                <p className="text-2xl font-bold text-white">{formatValue(totalYield)} TYCOON</p>
              </CardContent>
            </Card>
          </div>

          <h3 className="text-lg font-semibold text-white mb-4">Properties ({properties.length})</h3>

          {isLoading ? (
            <div className="text-center py-8 text-gray-400">Loading portfolio...</div>
          ) : properties.length === 0 ? (
            <div className="text-center py-8 text-gray-400">No properties found</div>
          ) : (
            <div className="space-y-3">
              {properties.map((property) => (
                <Card key={property.id} className="bg-white/5 border-white/10">
                  <CardContent className="p-4">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="text-white font-semibold">{property.propertyType} Property</h4>
                        <p className="text-sm text-gray-400">Token ID: {property.tokenId}</p>
                        <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
                          <span className="flex items-center gap-1">
                            <DollarSign className="w-3 h-3" />
                            {formatValue(property.value)} TYCOON
                          </span>
                          <span>{property.yieldRate}% APY</span>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-sm text-gray-400">Yield Earned</p>
                        <p className="text-emerald-400 font-semibold">{formatValue(property.totalYieldEarned)}</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
</file>

<file path="frontend/src/lib/mantle-viem.ts">
import { createConfig, http, fallback } from 'wagmi';
import { mantle, mantleSepoliaTestnet } from '@mantleio/viem/chains';
import { walletConnect } from 'wagmi/connectors';

// Determine which chain to use based on environment
const chain = process.env.NEXT_PUBLIC_MANTLE_NETWORK === 'testnet' 
  ? mantleSepoliaTestnet 
  : mantle;

// WalletConnect project ID (get from https://cloud.walletconnect.com)
const projectId = process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID || '';

// RPC URLs with fallbacks (official RPC has rate limiting)
const getRpcUrls = (chainId: number) => {
  const customUrl = process.env.NEXT_PUBLIC_MANTLE_RPC_URL;
  if (customUrl && chainId === 5003) return [customUrl];
  
  if (chainId === 5003) {
    // Mantle Sepolia Testnet - use fallbacks first (more reliable)
    return [
      'https://mantle-sepolia.drpc.org', // DRPC fallback (most reliable)
      'https://rpc.ankr.com/mantle_sepolia', // Ankr fallback
      'https://rpc.sepolia.mantle.xyz', // Official (may have rate limiting)
      'https://mantle-sepolia-rpc.publicnode.com', // PublicNode fallback
    ];
  } else {
    // Mantle Mainnet (5000)
    return [
      'https://mantle.drpc.org', // DRPC fallback
      'https://rpc.mantle.xyz', // Official
    ];
  }
};

// Create Wagmi config with Mantle Viem
export const wagmiConfig = createConfig({
  chains: [chain],
  connectors: [
    // MetaMask is handled by Reown AppKit, no need for direct connector
    walletConnect({ projectId }),
  ],
  transports: {
    [mantle.id]: fallback(
      getRpcUrls(mantle.id).map(url => http(url, { 
        timeout: 10000, // 10 second timeout per request
      }))
    ),
    [mantleSepoliaTestnet.id]: fallback(
      getRpcUrls(mantleSepoliaTestnet.id).map(url => http(url, { 
        timeout: 10000, // 10 second timeout per request
      }))
    ),
  },
  ssr: true,
});

// Export chain info for use in components
export { chain, mantle, mantleSepoliaTestnet };

// Helper to get chain config
export function getChainConfig() {
  return {
    id: chain.id,
    name: chain.name,
    nativeCurrency: chain.nativeCurrency,
    rpcUrls: {
      default: {
        http: [chain.rpcUrls.default.http[0]],
      },
    },
    blockExplorers: {
      default: {
        name: chain.blockExplorers?.default?.name || 'Mantle Explorer',
        url: chain.blockExplorers?.default?.url || 'https://mantlescan.xyz',
      },
    },
  };
}
</file>

<file path="START_ALL.bat">
@echo off
REM Property Tycoon - Start All Services (Windows)
REM This script starts Docker, Backend, and Frontend

echo  Starting Property Tycoon...

REM Step 1: Start Docker (PostgreSQL)
echo  Starting Docker PostgreSQL...
docker-compose up -d postgres

REM Wait for database to be ready
echo  Waiting for database to be ready...
timeout /t 5 /nobreak >nul

REM Step 2: Start Backend (in new window)
echo  Starting Backend...
start "Backend Server" cmd /k "cd backend && npm run start:dev"

REM Wait a bit for backend to start
timeout /t 3 /nobreak >nul

REM Step 3: Start Frontend (in new window)
echo  Starting Frontend...
start "Frontend Server" cmd /k "cd frontend && npm run dev"

echo  All services started!
echo.
echo  Frontend: http://localhost:3000
echo  Backend: http://localhost:3001
echo  API Docs: http://localhost:3001/api/docs
echo.
echo Press any key to exit...
pause >nul
</file>

<file path="START_ALL.sh">
#!/bin/bash

# Property Tycoon - Start All Services
# This script starts Docker, Backend, and Frontend

echo " Starting Property Tycoon..."

# Step 1: Start Docker (PostgreSQL)
echo " Starting Docker PostgreSQL..."
docker-compose up -d postgres

# Wait for database to be ready
echo " Waiting for database to be ready..."
sleep 5

# Step 2: Start Backend (in background)
echo " Starting Backend..."
cd backend
npm run start:dev &
BACKEND_PID=$!
cd ..

# Wait a bit for backend to start
sleep 3

# Step 3: Start Frontend
echo " Starting Frontend..."
cd frontend
npm run dev

# Note: Frontend runs in foreground
# Press Ctrl+C to stop everything

# Cleanup function (if you want to add it)
# trap "kill $BACKEND_PID; docker-compose down; exit" INT TERM
</file>

<file path="backend/src/guilds/guilds.controller.ts">
import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';
import { ApiTags, ApiOperation, ApiResponse } from '@nestjs/swagger';
import { GuildsService } from './guilds.service';

@ApiTags('guilds')
@Controller('guilds')
export class GuildsController {
  constructor(private readonly guildsService: GuildsService) {}

  @Get()
  @ApiOperation({ summary: 'Get all guilds' })
  @ApiResponse({ status: 200, description: 'List of guilds' })
  async getAllGuilds(@Query('query') query?: string) {
    return this.guildsService.searchGuilds(query || '', 20);
  }

  @Get('leaderboard')
  @ApiOperation({ summary: 'Get guild leaderboard' })
  @ApiResponse({ status: 200, description: 'Guild leaderboard' })
  async getLeaderboard(@Query('limit') limit?: number) {
    return this.guildsService.getGuildLeaderboard(limit || 20);
  }

  @Post()
  @ApiOperation({ summary: 'Create a new guild' })
  @ApiResponse({ status: 201, description: 'Guild created successfully' })
  async createGuild(
    @Body('walletAddress') walletAddress: string,
    @Body('ownerId') ownerId: string,
    @Body('name') name: string,
    @Body('description') description?: string,
    @Body('isPublic') isPublic?: boolean,
  ) {
    // Support both walletAddress and ownerId for backward compatibility
    if (walletAddress) {
      return this.guildsService.createGuildByWallet(walletAddress.toLowerCase(), name, description, isPublic);
    }
    return this.guildsService.createGuild(ownerId, name, description, isPublic);
  }

  @Get(':id')
  @ApiOperation({ summary: 'Get guild by ID' })
  @ApiResponse({ status: 200, description: 'Guild details' })
  async getGuildById(@Param('id') id: string) {
    return this.guildsService.getGuild(id);
  }

  @Post(':id/join')
  @ApiOperation({ summary: 'Join a guild' })
  @ApiResponse({ status: 201, description: 'Joined guild successfully' })
  async joinGuild(
    @Param('id') id: string, 
    @Body('walletAddress') walletAddress: string,
    @Body('userId') userId?: string,
  ) {
    // Support both walletAddress and userId for backward compatibility
    if (walletAddress) {
      return this.guildsService.joinGuildByWallet(walletAddress.toLowerCase(), id);
    }
    if (userId) {
      return this.guildsService.joinGuild(userId, id);
    }
    throw new Error('Either walletAddress or userId is required');
  }

  @Post(':id/leave')
  @ApiOperation({ summary: 'Leave a guild' })
  @ApiResponse({ status: 200, description: 'Left guild successfully' })
  async leaveGuild(
    @Param('id') id: string, 
    @Body('walletAddress') walletAddress?: string,
    @Body('userId') userId?: string,
  ) {
    // Support both walletAddress and userId for backward compatibility
    if (walletAddress) {
      return this.guildsService.leaveGuildByWallet(walletAddress.toLowerCase(), id);
    }
    if (userId) {
      return this.guildsService.leaveGuild(userId, id);
    }
    throw new Error('Either walletAddress or userId is required');
  }

  @Get('user/:userId')
  @ApiOperation({ summary: 'Get user guild' })
  @ApiResponse({ status: 200, description: 'User guild' })
  async getUserGuild(@Param('userId') userId: string) {
    return this.guildsService.getUserGuild(userId);
  }

  @Get('wallet/:walletAddress')
  @ApiOperation({ summary: 'Get user guild by wallet address' })
  @ApiResponse({ status: 200, description: 'User guild' })
  async getUserGuildByWallet(@Param('walletAddress') walletAddress: string) {
    return this.guildsService.getUserGuildByWallet(walletAddress.toLowerCase());
  }

  @Post(':id/update-stats')
  @ApiOperation({ summary: 'Manually update guild stats' })
  @ApiResponse({ status: 200, description: 'Guild stats updated' })
  async updateGuildStats(@Param('id') id: string) {
    await this.guildsService.updateGuildStats(id);
    return { success: true, message: 'Guild stats updated' };
  }
}
</file>

<file path="frontend/README.md">
# Property Tycoon Frontend

Next.js frontend for Property Tycoon game. Connect wallet. Buy tokens. Mint properties. Earn yield. Trade properties. Complete quests. Real-time updates powered by Mantle Network and Socket.io.

## What This Frontend Does

You connect your wallet. You buy TYCOON tokens. You mint property NFTs. You claim yield. You trade properties. You complete quests. You view leaderboard. Portfolio updates instantly without refreshing. Yield accumulates in real time. Leaderboard updates live. Properties appear as they are minted. All powered by Mantle Network.

## Prerequisites

Install Node.js 18 or higher. Install npm or yarn. Have a wallet extension ready. Configure Mantle Sepolia Testnet in your wallet.

## Installation

Navigate to frontend directory:

```bash
cd property-tycoon-mantle/frontend
```

Install dependencies:

```bash
npm install
```

Create `.env.local` file:

```env
# Contract Addresses (Mantle Sepolia Testnet)
NEXT_PUBLIC_PROPERTY_NFT_ADDRESS=0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c
NEXT_PUBLIC_GAME_TOKEN_ADDRESS=0x3334f87178AD0f33e61009777a3dFa1756e9c23f
NEXT_PUBLIC_YIELD_DISTRIBUTOR_ADDRESS=0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4
NEXT_PUBLIC_MARKETPLACE_ADDRESS=0x6b6b65843117C55da74Ea55C954a329659EFBeF0
NEXT_PUBLIC_QUEST_SYSTEM_ADDRESS=0x89f72227168De554A28874aA79Bcb6f0E8e2227C
NEXT_PUBLIC_TOKEN_SWAP_ADDRESS=0xAd22cC67E66F1F0b0D1Be33F53Bd0948796a460E
NEXT_PUBLIC_MOCK_RWA_ADDRESS=0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45

# Oracle RWA Contract (Optional - uses MockRWA if not set)
NEXT_PUBLIC_ORACLE_RWA_ADDRESS=0xYourOracleRWAAddress

# Backend API
NEXT_PUBLIC_API_URL=http://localhost:3001/api

# Network Configuration
NEXT_PUBLIC_MANTLE_CHAIN_ID=5003
NEXT_PUBLIC_MANTLE_RPC_URL=https://rpc.sepolia.mantle.xyz

# Reown AppKit (formerly WalletConnect)
NEXT_PUBLIC_PROJECT_ID=your_reown_project_id_here
```

Get your Project ID from [Reown Cloud](https://cloud.reown.com/). Create a new project, select AppKit, choose Next.js framework, and copy the Project ID.

**Note:** Contract addresses are also hardcoded in source files as a fallback, so the app works even without `.env.local`.

## Development

Start development server:

```bash
npm run dev
```

Visit http://localhost:3000 in your browser.

## Build for Production

```bash
npm run build
npm start
```

## Key Features

### Buy TYCOON Tokens

Purchase TYCOON tokens directly:
- MNT payment available for all wallets
- One MNT equals 100 TYCOON tokens
- Select amount of TYCOON tokens to buy
- See cost calculated automatically
- Quick buttons for common amounts
- Balance updates automatically after purchase

### Mint Property

Choose property type:
- Residential (100 TYCOON) - 5% APY
- Commercial (200 TYCOON) - 8% APY
- Industrial (500 TYCOON) - 12% APY
- Luxury (1000 TYCOON) - 15% APY

Automatic approval flow.

Balance checks prevent insufficient funds.

Property appears on city map instantly.

### Link to RWA

Connect property to tokenized real estate:
- Select RWA contract (Oracle-based or MockRWA)
- View only RWA tokens you own (up to 20 tokens displayed)
- Link property to RWA token
- Property generates real yield from rental income
- Estimated yield calculation uses RWA value and yield rate
- Yield display updates in real time with RWA data
- Property validation ensures only existing properties are processed

### Claim Yield

Properties generate yield daily.

Claim yield after 24 hours.

Batch claim all properties at once.

Yield distributed as USDC or USDT.

Real money in your wallet.

### Marketplace

Browse properties for sale.

Buy from other players.

Sell your properties.

Fixed price and auction listings.

View seller information.

### Quests

Complete investment challenges:
- First Property: Mint your first property
- Diversify Portfolio: Own 3 different property types
- Property Mogul: Own 10 properties
- RWA Pioneer: Link 5 properties to RWA

Earn bonus TYCOON tokens.

Track progress in real time.

### Leaderboard

Podium display for top three players.

List view for positions four through ten.

Ranked by portfolio value.

Shows total yield earned.

Highlights your position.

Updates instantly without refreshing.

### Guilds

Join existing guilds.

Create your own guild.

See guild members' properties.

Share guild benefits.

Compete in guild leaderboards.

### Chat

Global chat connects everyone.

Real-time messaging.

Usernames and avatars.

Share tips and strategies.

Build community.

## Chronicle Oracle Integration

Frontend uses Chronicle Oracle to fetch MNT/USD price for USD conversions. All TYCOON amounts are displayed with USD equivalents using real-time price data from Chronicle Oracle.

**Implementation:**
- `useMNTPrice` hook fetches MNT/USD price from backend API endpoint
- Backend fetches price from Chronicle Oracle via whitelisted wallet
- Price updates broadcast via Socket.io every 5 minutes
- Frontend receives real-time price updates without page refresh
- TYCOON/USD rate calculated as: MNT/USD  100 (since 1 MNT = 100 TYCOON)
- USD values displayed alongside TYCOON amounts in:
  - Yield Display (claimable yield, estimated yield, total earned)
  - Property Cards (property value, total yield earned)
  - Property Details modal (property value, total yield earned)

**Chronicle Oracle Address:**
- MNT/USD: `0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307` (Mantle Sepolia)

**Backend API:**
- `/api/oracle/mnt-price` - Returns MNT/USD and TYCOON/USD prices

Files:
- `src/hooks/useMNTPrice.ts` - Price fetching hook with Socket.io integration

## Mantle Network Integration

Frontend uses Mantle Viem for type-safe blockchain interactions.

### Mantle Viem Integration

Uses @mantleio/viem package for Mantle chain configuration. Pre-configured Mantle and Mantle Sepolia Testnet chains. Type-safe contract interactions with Wagmi hooks. Efficient data fetching with automatic caching. Real-time event subscriptions for instant updates.

Implementation:
- `src/lib/mantle-viem.ts` configures Wagmi with Mantle chains
- Uses mantle and mantleSepoliaTestnet from @mantleio/viem/chains
- Fallback RPC URLs for reliability
- Timeout handling for network requests
- SSR support for Next.js

Why we use it: Mantle Viem provides official chain configurations. Ensures correct network parameters. Type-safe interactions prevent errors. Automatic caching reduces RPC calls.

Features:
- Multiple RPC fallbacks for reliability
- Automatic retry on network errors
- Optimized for Mantle's high throughput
- Real-time event subscriptions
- Type-safe contract calls

Contract interactions include:
- Property NFT minting and management
- Yield claiming and distribution
- Marketplace trading
- Quest completion and rewards
- Token swapping (MNT to TYCOON)
- RWA linking with Oracle support

Files:
- `src/lib/mantle-viem.ts` - Mantle Viem configuration
- `src/lib/contracts.ts` - Contract ABIs and addresses
- `src/config/wagmi.ts` - Wagmi configuration

## Real-Time Features

Portfolio updates instantly without refreshing.

Live yield accumulation tracking.

Instant leaderboard updates via WebSocket.

Property minting with optimized gas costs.

Yield claiming with micro-transaction support.

WebSocket integration via Socket.io:
- Real-time chat messaging
- Portfolio update notifications
- Leaderboard position changes
- Yield accumulation updates

## Technology Stack

Framework: Next.js 15 (App Router)

Language: TypeScript

UI Library: React 18

Styling: Tailwind CSS

Animations: Framer Motion

Wallet: Wagmi + Viem

Blockchain: Mantle Network (Sepolia Testnet)

Real-time: Socket.io

Rendering: Pixi.js (city map)

Notifications: React Hot Toast

## Project Structure

```
frontend/
 src/
    app/
       game/
          page.tsx              # Main game page
       leaderboard/
          page.tsx              # Leaderboard
       layout.tsx                # Root layout
    components/
       WalletConnect.tsx         # Wallet connection
       GlobalChat.tsx            # Real-time chat
       UserProfile.tsx           # User profile settings
       Quests.tsx                # Quest system
       Marketplace.tsx           # Property marketplace
       Guilds.tsx                # Guild system
       RWALinkModal.tsx         # RWA linking modal
       game/
           CityView.tsx          # City map visualization
           PropertyCard.tsx      # Property display
           YieldDisplay.tsx      # Yield dashboard
           BuildMenu.tsx         # Property minting
    hooks/
       useChat.ts                # Chat hook with WebSocket
    lib/
       contracts.ts              # Contract ABIs and addresses
       api.ts                    # Backend API client
       mantle-viem.ts           # Mantle Viem configuration
    config/
        wagmi.ts                  # Wagmi configuration
 public/
    abis/                         # Contract ABIs
 package.json
 next.config.ts
 README.md
```

## Troubleshooting

Wallet not connecting:
- Ensure wallet extension is installed
- Check wallet is connected to Mantle Sepolia Testnet network
- Refresh page and try again
- Check browser console for errors

Balance not updating:
- Click refresh button next to balance
- Check console for errors
- Verify contract addresses are correct
- Ensure you are on correct network

Properties not loading:
- Check browser console for errors
- Verify backend is running
- Check network requests in DevTools
- Ensure contract addresses are correct

Transaction fails:
- Check you have sufficient MNT for gas
- Verify contract addresses are correct
- Check browser console for error details
- Ensure you are on Mantle Sepolia Testnet network

Yield not claiming:
- Check property is at least 24 hours old
- Verify yield distributor contract address
- Check browser console for error details
- Ensure you have sufficient gas

Leaderboard not updating:
- Check WebSocket connection in browser console
- Verify backend is running
- Check network tab for WebSocket connections
- Refresh page if connection lost

RWA linking not working:
- Verify you own RWA tokens (check MockRWA contract)
- Check RWA contract address is correct
- Ensure property is not already linked
- Check browser console for errors

## Browser Support

Chrome or Edge (recommended)

Firefox

Safari

Mobile browsers (iOS Safari, Chrome Mobile)

## Contract Update Notes

When contracts are redeployed:

Update contract addresses in source files:
- `CONTRACTS` object in `src/lib/contracts.ts`
- Environment variables in `.env.local`

Verify all contract interactions work:
- Buy TYCOON tokens
- Mint properties
- Link to RWA
- Claim yield
- Trade properties
- Complete quests

Test real-time features:
- Portfolio updates work
- Leaderboard displays correctly
- Chat messaging works
- Yield accumulation updates

## Support

For issues or questions:
- Mantle Documentation: https://docs.mantle.xyz
- Wagmi Documentation: https://wagmi.sh
- Viem Documentation: https://viem.sh
- Next.js Documentation: https://nextjs.org/docs
</file>

<file path="frontend/src/components/game/GameGuide.tsx">
'use client'

import { X, BookOpen, Wallet, Coins, Building2, TrendingUp, Trophy, Users } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

interface GameGuideProps {
  isOpen: boolean
  onClose: () => void
}

export function GameGuide({ isOpen, onClose }: GameGuideProps) {
  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <Card className="bg-gray-900 border-white/20 w-full max-w-3xl max-h-[80vh] overflow-y-auto">
        <CardHeader className="sticky top-0 bg-gray-900 border-b border-white/10 flex flex-row items-center justify-between">
          <CardTitle className="text-2xl font-bold text-white flex items-center gap-2">
            <BookOpen className="w-6 h-6" />
            How to Play Property Tycoon
          </CardTitle>
          <Button onClick={onClose} variant="ghost" size="sm" className="text-white">
            <X className="w-5 h-5" />
          </Button>
        </CardHeader>
        <CardContent className="p-6 space-y-6">
          <div className="space-y-4">
            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                <Wallet className="w-6 h-6 text-blue-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 1: Connect Your Wallet</h3>
                <p className="text-gray-300">
                  Connect your MetaMask or WalletConnect wallet. Make sure you're on Mantle Testnet. Get test tokens from the faucet if needed.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                <Coins className="w-6 h-6 text-emerald-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 2: Buy TYCOON Tokens</h3>
                <p className="text-gray-300">
                  Buy TYCOON tokens with MNT. One MNT buys 100 TYCOON tokens. This is a one-time purchase to get started. Buy enough for your first property.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-purple-500/10 border border-purple-500/20">
                <Building2 className="w-6 h-6 text-purple-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 3: Mint Your Property</h3>
                <p className="text-gray-300">
                  Spend TYCOON tokens to mint property NFTs. Choose from Residential (100 tokens), Commercial (200 tokens), Industrial (500 tokens), or Luxury (1000 tokens). Each property generates yield daily.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20">
                <TrendingUp className="w-6 h-6 text-yellow-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 4: Collect Yield</h3>
                <p className="text-gray-300">
                  Properties generate yield daily. Claim your yield rewards as USDC or USDT. Real money in your wallet. Keep the yield or reinvest to expand your portfolio.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-orange-500/10 border border-orange-500/20">
                <Trophy className="w-6 h-6 text-orange-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 5: Compete & Trade</h3>
                <p className="text-gray-300">
                  View the leaderboard to see top tycoons. Visit other players' portfolios. Trade properties on the marketplace. Join guilds. Complete quests for bonus rewards.
                </p>
              </div>
            </div>

            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/20">
                <Users className="w-6 h-6 text-cyan-400" />
              </div>
              <div>
                <h3 className="text-lg font-semibold text-white mb-2">Step 6: Build Your Empire</h3>
                <p className="text-gray-300">
                  Expand your portfolio. Link properties to RWA for real yield. Complete investment quests. Climb the leaderboard. Build the ultimate property empire.
                </p>
              </div>
            </div>
          </div>

          <div className="mt-8 p-4 rounded-lg bg-blue-500/10 border border-blue-500/20">
            <h4 className="font-semibold text-blue-400 mb-2">Property Types & Costs</h4>
            <ul className="space-y-2 text-sm text-gray-300">
              <li> Residential: 100 TYCOON tokens - 5% APY</li>
              <li> Commercial: 200 TYCOON tokens - 8% APY</li>
              <li> Industrial: 500 TYCOON tokens - 12% APY</li>
              <li> Luxury: 1000 TYCOON tokens - 15% APY</li>
            </ul>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}
</file>

<file path="backend/src/leaderboard/leaderboard.controller.ts">
import { Controller, Get, Query, Post, Param } from '@nestjs/common';
import { LeaderboardService } from './leaderboard.service';

@Controller('leaderboard')
export class LeaderboardController {
  constructor(private readonly leaderboardService: LeaderboardService) {}

  @Get()
  async getGlobalLeaderboard(@Query('limit') limit?: string) {
    // Return leaderboard directly from database (fast)
    // Sync should be done separately via /sync-all endpoint or event indexer
    // This makes the leaderboard load instantly since data is already synced
    return this.leaderboardService.getGlobalLeaderboard(limit ? Number(limit) : 100);
  }

  @Post('sync/:address')
  async syncAndUpdate(@Param('address') address: string) {
    await this.leaderboardService.syncAndUpdateLeaderboard(address);
    return { success: true, message: 'Leaderboard synced and updated' };
  }

  @Post('cleanup-contracts')
  async cleanupContracts() {
    return this.leaderboardService.cleanupContractAddresses();
  }

  @Post('recalculate')
  async recalculateLeaderboard() {
    // Force recalculation from blockchain (removes old data)
    const rankings = await this.leaderboardService.calculateLeaderboardFromBlockchain(100);
    return {
      success: true,
      count: rankings.length,
      message: `Recalculated leaderboard with ${rankings.length} entries from new contract`,
    };
  }

  @Post('clear-and-recalculate')
  async clearAndRecalculate() {
    // Clear all old data and recalculate from new contract only
    const rankings = await this.leaderboardService.clearAndRecalculateLeaderboard(100);
    return {
      success: true,
      count: rankings.length,
      message: `Cleared old data and recalculated leaderboard with ${rankings.length} entries from new contract`,
      rankings,
    };
  }
}
</file>

<file path="frontend/src/components/game/YieldDisplay.tsx">
'use client';

import { useEffect } from 'react';
import { TrendingUp, DollarSign, Clock } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useMNTPrice, tycoonToUSD, formatUSD } from '@/hooks/useMNTPrice';

interface YieldDisplayProps {
  totalPendingYield: bigint; // Real-time estimated yield (accumulating by seconds)
  totalYieldEarned: bigint;
  claimableYield?: bigint; // On-chain claimable yield (requires 24 hours)
  onClaimAll?: () => void | Promise<void>;
  isClaiming?: boolean;
}

export function YieldDisplay({ totalPendingYield, totalYieldEarned, claimableYield, onClaimAll, isClaiming = false }: YieldDisplayProps) {
  const { tycoonPriceUSD, loading: priceLoading, error: priceError } = useMNTPrice();
  
  // Debug logging
  useEffect(() => {
    if (tycoonPriceUSD) {
      console.log(` TYCOON/USD price loaded: $${tycoonPriceUSD.toFixed(6)}`);
    }
    if (priceError) {
      console.warn(' Price fetch error:', priceError);
    }
  }, [tycoonPriceUSD, priceError]);
  
  const formatValue = (value: bigint) => {
    // Validate value first - if suspiciously large, return 0
    const MAX_REASONABLE_YIELD = BigInt('1000000000000000000000'); // 1000 TYCOON
    if (value > MAX_REASONABLE_YIELD) {
      console.warn(' formatValue: Suspiciously large value detected, returning 0:', value.toString());
      return '0.0000';
    }
    
    // Convert from wei to TYCOON (divide by 1e18)
    // Always use BigInt division for accuracy
    const divisor = BigInt('1000000000000000000'); // 1e18
    const quotient = value / divisor;
    const remainder = value % divisor;
    
    // Calculate decimal part accurately
    const decimalPart = Number(remainder) / Number(divisor);
    const tycoonAmount = Number(quotient) + decimalPart;
    
    // Format with appropriate decimal places
    if (tycoonAmount < 0.0001) {
      return '0.0000';
    }
    if (tycoonAmount < 1) {
      return tycoonAmount.toFixed(4);
    }
    if (tycoonAmount < 1000) {
      return tycoonAmount.toFixed(2);
    }
    // For large amounts, use comma separators
    return tycoonAmount.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
  };

  // Calculate daily yield rate for display
  const dailyYield = Number(totalPendingYield) / 1e18;
  const dailyRate = dailyYield > 0 ? (dailyYield / 365).toFixed(4) : '0.0000';

  return (
    <Card className="border-white/10 bg-gradient-to-br from-emerald-900/20 to-teal-900/20 backdrop-blur-md">
      <CardHeader>
        <CardTitle className="text-white flex items-center gap-2">
          <TrendingUp className="w-5 h-5 text-emerald-400" />
          Yield Earnings
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Claimable Yield - PRIMARY DISPLAY (24-hour requirement - core game mechanic) */}
        <div>
          <p className="text-xs text-gray-400 mb-1 flex items-center gap-1">
            <Clock className="w-3 h-3" />
            Claimable Yield
          </p>
          <p className="text-3xl font-bold text-emerald-400 flex items-center gap-2 flex-wrap">
            <DollarSign className="w-6 h-6" />
            <span>
              {claimableYield !== undefined ? formatValue(claimableYield) : formatValue(totalPendingYield)} TYCOON
              {tycoonPriceUSD && (() => {
                const usdValue = tycoonToUSD(claimableYield !== undefined ? claimableYield : totalPendingYield, tycoonPriceUSD);
                const usdFormatted = formatUSD(usdValue);
                return usdFormatted ? (
                  <span className="text-lg text-gray-400 ml-2">
                    ({usdFormatted})
                  </span>
                ) : null;
              })()}
            </span>
          </p>
          {claimableYield !== undefined && claimableYield === BigInt(0) && totalPendingYield > BigInt(0) ? (
            <p className="text-xs text-yellow-400 mt-1">
              Properties generate yield daily  Requires 24 hours before claiming
              {typeof window !== 'undefined' && (window as any).propertyTimeRemaining ? (
                <span className="block mt-1">
                  {(() => {
                    const timeRemainingMap = (window as any).propertyTimeRemaining as Map<number, { hours: number; minutes: number; isClaimable: boolean }>;
                    // Find the property with the SHORTEST time remaining (closest to being claimable)
                    const nonClaimableProperties = Array.from(timeRemainingMap.values()).filter((t) => !t.isClaimable);
                    if (nonClaimableProperties.length > 0) {
                      // Sort by total minutes remaining (hours * 60 + minutes) and get the minimum
                      const shortestTime = nonClaimableProperties.reduce((min, current) => {
                        const minMinutes = min.hours * 60 + min.minutes;
                        const currentMinutes = current.hours * 60 + current.minutes;
                        return currentMinutes < minMinutes ? current : min;
                      });
                      return ` ${shortestTime.hours}h ${shortestTime.minutes}m remaining`;
                    }
                    return '';
                  })()}
                </span>
              ) : null}
            </p>
          ) : claimableYield !== undefined && claimableYield > BigInt(0) ? (
            <p className="text-xs text-green-400 mt-1">
              Ready to claim! Your daily yield is available
            </p>
          ) : (
            <p className="text-xs text-gray-500 mt-1">
              Properties generate yield daily  Check back tomorrow
            </p>
          )}
        </div>

        {/* Estimated Yield - SECONDARY DISPLAY (for engagement, shows what's accumulating) */}
        {totalPendingYield > BigInt(0) && (
          <div className="border-t border-white/10 pt-4">
            <p className="text-xs text-gray-400 mb-1 flex items-center gap-1">
              <TrendingUp className="w-3 h-3" />
              Estimated Yield (Accumulating)
            </p>
            <p className="text-xl font-semibold text-white">
              {formatValue(totalPendingYield)} TYCOON
              {tycoonPriceUSD && (
                <span className="text-sm text-gray-400 ml-2">
                  {formatUSD(tycoonToUSD(totalPendingYield, tycoonPriceUSD))}
                </span>
              )}
            </p>
            <p className="text-xs text-gray-500 mt-1">
              Growing in real-time  Will be claimable after 24 hours
            </p>
          </div>
        )}

        <div className="border-t border-white/10 pt-4">
          <p className="text-xs text-gray-400 mb-1">Total Earned (All Time)</p>
          <p className="text-xl font-semibold text-white">
            {formatValue(totalYieldEarned)} TYCOON
            {tycoonPriceUSD && (
              <span className="text-sm text-gray-400 ml-2">
                {formatUSD(tycoonToUSD(totalYieldEarned, tycoonPriceUSD))}
              </span>
            )}
          </p>
        </div>

        {onClaimAll && claimableYield !== undefined && claimableYield > 0n && (
          <Button 
            onClick={onClaimAll} 
            disabled={isClaiming}
            className="w-full bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-50"
          >
            {isClaiming ? 'Claiming...' : 'Claim Daily Yield'}
          </Button>
        )}
      </CardContent>
    </Card>
  );
}
</file>

<file path="backend/README.md">
# Property Tycoon Backend

NestJS backend for Property Tycoon. Manages properties. Distributes yield. Handles marketplace. Tracks quests. Updates leaderboards. Real-time updates via Socket.io. Mantle SDK integration. Chronicle Oracle price feeds.

## What This Backend Does

You submit property minting requests. Backend validates and processes. You claim yield. Backend distributes rewards. You trade properties. Backend handles marketplace. You complete quests. Backend tracks progress. Leaderboard updates in real time. Portfolio values update instantly. Yield calculations happen automatically. All powered by Mantle Network.

## Prerequisites

Install Node.js 18 or higher. Install npm or yarn. Set up PostgreSQL database. Configure Mantle network access. Have contract addresses ready.

## Installation

Navigate to backend directory:

```bash
cd property-tycoon-mantle/backend
```

Install dependencies:

```bash
npm install
```

Create `.env` file:

```env
# Database
DATABASE_URL=postgresql://postgres:password@localhost:5432/property_tycoon

# Mantle Network
MANTLE_RPC_URL=https://rpc.sepolia.mantle.xyz
# Optional: Multiple RPC endpoints for failover (comma-separated)
# If not set, uses default fallback chain: official, Ankr, DRPC
MANTLE_RPC_URLS=https://rpc.sepolia.mantle.xyz,https://rpc.ankr.com/mantle_sepolia,https://mantle-sepolia.drpc.org
L1_RPC_URL=https://eth.llamarpc.com

# Contract Addresses (Mantle Sepolia Testnet)
PROPERTY_NFT_ADDRESS=0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c
GAME_TOKEN_ADDRESS=0x3334f87178AD0f33e61009777a3dFa1756e9c23f
YIELD_DISTRIBUTOR_ADDRESS=0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4
MARKETPLACE_ADDRESS=0x6b6b65843117C55da74Ea55C954a329659EFBeF0
QUEST_SYSTEM_ADDRESS=0x89f72227168De554A28874aA79Bcb6f0E8e2227C
TOKEN_SWAP_ADDRESS=0xAd22cC67E66F1F0b0D1Be33F53Bd0948796a460E
MOCK_RWA_ADDRESS=0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45

# Chronicle Oracle (Optional)
CHRONICLE_RWA_PROPERTY_ORACLE=0xYourChronicleOracleAddress

# Private Key (for contract interactions)
PRIVATE_KEY=your_private_key_here

# Server
PORT=3001
```

Important notes:
- Private key must include 0x prefix
- Backend wallet needs MNT for gas fees
- Get testnet tokens from Mantle faucet
- Database will be auto-initialized on first run

## Database Setup

Start PostgreSQL using Docker:

```bash
cd property-tycoon-mantle
docker-compose up -d postgres
```

Initialize database:

```bash
cd backend
npm run db:init
```

Database schemas are automatically created using Drizzle ORM. Tables include:
- `users` - User accounts linked to wallet addresses
- `properties` - Property NFTs with metadata
- `yield_records` - Yield claim history
- `marketplace_listings` - Active property listings
- `quests` - Available quests
- `quest_progress` - User quest completion tracking
- `leaderboard` - Portfolio rankings
- `chat_messages` - Global chat messages
- `guilds` - Guild information
- `guild_members` - Guild membership

## Development

Start development server:

```bash
npm run start:dev
```

Server runs on http://localhost:3001

API documentation available at http://localhost:3001/api/docs

## Production

Use process manager like PM2:

```bash
pm2 start dist/main.js --name property-tycoon-backend
```

Or deploy to your preferred hosting platform.

## API Endpoints

### Properties

GET `/api/properties/:address` - Get user's properties

POST `/api/properties/sync/:address` - Sync properties from blockchain

### Yield

GET `/api/yield/pending/:address` - Get pending yield

GET `/api/yield/property/:propertyId` - Get property yield

GET `/api/yield/history/:address` - Get yield history

### Marketplace

GET `/api/marketplace/listings` - Get active listings

POST `/api/marketplace/list` - List property for sale

POST `/api/marketplace/purchase` - Purchase listed property

### Quests

GET `/api/quests` - Get all quests

GET `/api/quests/:id` - Get specific quest

GET `/api/quests/sync` - Sync quests from contract

GET `/api/quests/sync-progress/:address` - Sync quest progress

POST `/api/quests/:id/claim` - Claim quest reward

### Leaderboard

GET `/api/leaderboard` - Get global leaderboard

POST `/api/leaderboard/sync/:address` - Sync and update leaderboard

### Chat

POST `/api/chat/messages` - Send chat message

GET `/api/chat/messages` - Get recent messages

### Users

GET `/api/users/profile/:walletAddress` - Get user profile

PUT `/api/users/profile/:walletAddress/username` - Update username

### Guilds

GET `/api/guilds` - Get all guilds

POST `/api/guilds` - Create guild

GET `/api/guilds/:id` - Get guild details

POST `/api/guilds/:id/join` - Join guild

## Mantle Integration

Backend uses multiple Mantle tools for advanced blockchain operations.

### Mantle SDK Integration

Uses @mantleio/sdk package for cross-chain operations. CrossChainMessenger handles L1 to L2 asset bridging. Deposit and withdrawal estimation for gas optimization. Message status tracking for reliable cross-chain operations. L1 to L2 asset transfers for RWA tokenization.

Implementation:
- MantleSdkService initializes CrossChainMessenger
- Connects to L1 and L2 providers
- Tracks message status for cross-chain transfers
- Estimates gas for deposits and withdrawals
- Monitors L1 and L2 block numbers

Why we use it: Enables RWA assets to bridge from Ethereum mainnet to Mantle L2. Reduces costs for large asset transfers. Provides reliable cross-chain messaging.

### Mantle API Service

Uses Mantle custom RPC methods for efficient data queries. eth_getBlockRange fetches multiple blocks in one call. rollup_getInfo monitors L2 node status. Reduces RPC calls by 90 percent for event indexing.

Implementation:
- MantleApiService calls custom RPC methods
- eth_getBlockRange for batch block queries
- rollup_getInfo for node sync status
- L1 and L2 block number tracking
- L2 transaction index monitoring

Why we use it: Event indexing requires many block queries. Standard RPC needs one call per block. Mantle custom methods fetch 100 blocks in one call. Reduces backend load and improves performance.

### Mantle Gas Service

Uses Mantle GasPriceOracle for gas optimization. Tracks L1 base fee and L2 gas price. Estimates transaction costs accurately. Optimizes batch transactions.

Implementation:
- MantleGasService queries GasPriceOracle contract
- Gets L1 base fee for cross-chain operations
- Gets L2 gas price for local transactions
- Estimates L1 fees for transaction data
- Checks node sync status before transactions

Why we use it: Yield claims happen frequently. Gas optimization saves costs. Accurate estimates prevent failed transactions. Batch operations require cost estimation.

Files:
- `src/mantle/mantle-sdk.service.ts` - CrossChainMessenger integration
- `src/mantle/mantle-api.service.ts` - Custom RPC method calls
- `src/mantle/mantle-gas.service.ts` - GasPriceOracle integration

## Chronicle Oracle Integration

Uses Chronicle Oracle for price feeds on Mantle Sepolia. 60 to 80 percent less gas than other oracles. Critical for frequent yield calculations. Property value updates cost less.

Chronicle Oracle integration is implemented in `OracleService` with methods to fetch real-time prices for USDC, USDT, ETH, and MNT (`getUSDCPrice`, `getUSDTPrice`, `getETHPrice`, `getMNTPrice`). MNT/USD price is actively used for USD conversions. Backend wallet must be whitelisted on Chronicle Oracle to fetch prices.

**Active Usage:**
- `OracleController` exposes `/api/oracle/mnt-price` endpoint
- `PriceUpdateService` fetches MNT/USD price every 5 minutes
- Price updates broadcast via Socket.io to all connected clients
- Frontend receives real-time price updates without polling

RWA property values can be fetched from Chronicle when `CHRONICLE_RWA_PROPERTY_ORACLE` is configured in `getRWAPropertyValue()` method, but this environment variable is not set. The system falls back to contract queries (MockRWA) when Chronicle oracle is not configured.

YieldDistributor contract uses RWA data for yield calculation. If property linked to RWA, contract fetches RWA value and yield rate. Uses RWA data instead of property data for yield calculation. Automatic fallback to property data if RWA not linked or unavailable. All yield calculations happen on-chain via YieldDistributor contract.

Backend yield service also uses RWA data for estimated yield calculations. When property is linked to RWA, backend fetches RWA value and yield rate from blockchain. Uses RWA data for pending yield calculations. Falls back to property data if RWA fetch fails. BigInt values are properly serialized to numbers for JSON responses. Property ID validation ensures only existing properties are processed. Property ID 0 is valid if it exists and is owned.

Chronicle Oracle addresses on Mantle Sepolia:
- USDC/USD: 0x9Dd500569A6e77ECdDE7694CDc2E58ac587768D0
- USDT/USD: 0xD671F5F7c2fb6f75439641C36a578842f5b376A9
- ETH/USD: 0xa6896dCf3f5Dc3c29A5bD3a788D6b7e901e487D8
- MNT/USD: 0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307

Schnorr-based architecture ensures secure price feeds. Data freshness validation with 3-hour default threshold. tryReadWithAge functions prevent reverts. Graceful fallbacks if oracle data is stale.

## Multi-RPC Failover

Backend uses multiple RPC endpoints for resilience. If one RPC fails, automatically switches to another. Ensures contract calls succeed even if primary RPC is down.

Implementation:
- `MultiRpcService` manages multiple RPC providers
- Tests connectivity to all configured RPCs on startup
- `executeWithFailover` attempts function with each RPC until one succeeds
- Logs RPC endpoint usage and failures
- Default fallback chain: official Mantle RPC, Ankr, DRPC
- Integrated into `ContractsService` for all contract calls
- Property validation prevents processing non-existent properties

Why we use it: RPC endpoints can be unreliable. Failover ensures backend continues working. Multiple endpoints provide redundancy. Critical for production deployments. Property ID validation prevents contract reverts for invalid properties.

Files:
- `src/mantle/multi-rpc.service.ts` - Multi-RPC failover service
- `src/contracts/contracts.service.ts` - Uses MultiRpcService for contract calls

## Event Indexing

Backend listens to contract events and syncs database automatically:

- `PropertyCreated` - New property minted
- `PropertyLinkedToRWA` - Property linked to RWA
- `YieldClaimed` - Yield claimed by owner
- `PropertyPurchased` - Property sold on marketplace
- `QuestCompleted` - Quest completed by player

Events are indexed in real-time and broadcast via WebSocket to frontend.

## BigInt Serialization

Backend properly handles BigInt values in JSON responses. All property methods convert BigInt fields (tokenId, rwaTokenId, totalYieldEarned, value) to numbers or strings before returning. This prevents "Do not know how to serialize a BigInt" errors when sending data to frontend.

## Property Validation

Backend validates property IDs before processing. Checks if property exists using `ownerOf` before calculating yield. Property ID 0 is valid if it exists and is owned. Only skips properties that don't exist. Prevents contract reverts for invalid property IDs. Filters out non-existent properties in batch operations.

## WebSocket Events

Backend emits real-time events via Socket.io:

- `property:created` - New property minted
- `yield:updated` - Yield accumulation updated
- `yield:time-update` - Yield time information updated
- `leaderboard:updated` - Leaderboard position changed
- `chat:new` - New chat message
- `quest:completed` - Quest completed
- `price:update` - MNT/USD price updated (every 5 minutes)

Frontend subscribes to these events for instant updates. Price updates broadcast automatically without frontend polling.

## Project Structure

```
backend/
 src/
    app.module.ts              # Root module
    main.ts                    # Application entry point
    contracts/                 # Smart contract integration
    database/                  # Database layer (Drizzle ORM)
    events/                    # Event indexing service
    mantle/                    # Mantle integration
    properties/               # Property management
    yield/                     # Yield distribution
    marketplace/              # Marketplace trading
    quests/                    # Quest system
    leaderboard/              # Leaderboard management
    chat/                      # Chat system
    users/                     # User profile management
    guilds/                    # Guild system
    websocket/                # WebSocket gateway
 package.json
 README.md
```

## Security

Backend includes security features:
- Input validation on all endpoints
- SQL injection prevention via Drizzle ORM
- CORS enabled for frontend access
- Error handling prevents crashes
- Rate limiting on critical endpoints
- Private key stored securely in environment variables

## Troubleshooting

Server not starting:
- Check `.env` file has correct values
- Ensure Node.js version is 18 or higher
- Check port 3001 is available
- Verify dependencies installed: `npm install`
- Check PostgreSQL is running

Database connection fails:
- Verify DATABASE_URL is correct
- Check PostgreSQL is accessible
- Run `npm run db:init` to initialize database
- Check database logs for errors

Contract interaction fails:
- Check backend wallet has MNT for gas
- Verify contract addresses are correct
- Check RPC URL is accessible
- Ensure contracts are deployed on Mantle Sepolia

Event indexing not working:
- Check event indexer service is running
- Verify contract addresses match deployed contracts
- Check RPC connection is stable
- Review event indexer logs

## Testing

Test API endpoints:

```bash
# Get properties
curl http://localhost:3001/api/properties/0x...

# Get leaderboard
curl http://localhost:3001/api/leaderboard

# Get quests
curl http://localhost:3001/api/quests
```

## Support

For issues or questions:
- Mantle Documentation: https://docs.mantle.xyz
- NestJS Documentation: https://docs.nestjs.com
- Drizzle ORM Documentation: https://orm.drizzle.team
- Socket.io Documentation: https://socket.io/docs
</file>

<file path="backend/src/yield/yield.service.ts">
import { Injectable, Logger, Inject, OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, and } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';
import { OracleService } from '../mantle/oracle.service';
import { MantleApiService } from '../mantle/mantle-api.service';
import { WebsocketGateway } from '../websocket/websocket.gateway';
import { ethers } from 'ethers';

@Injectable()
export class YieldService implements OnModuleInit, OnModuleDestroy {
  private readonly logger = new Logger(YieldService.name);

  private yieldTimeUpdateInterval: NodeJS.Timeout | null = null;

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
    private oracleService: OracleService,
    private mantleApiService: MantleApiService,
    private websocketGateway: WebsocketGateway,
  ) {}

  onModuleInit() {
    // Start periodic yield time updates every 60 seconds
    this.startYieldTimeUpdates();
  }

  onModuleDestroy() {
    if (this.yieldTimeUpdateInterval) {
      clearInterval(this.yieldTimeUpdateInterval);
    }
  }

  private startYieldTimeUpdates() {
    // Update every 60 seconds (1 minute)
    this.yieldTimeUpdateInterval = setInterval(async () => {
      try {
        await this.broadcastYieldTimeUpdates();
      } catch (error) {
        this.logger.error(`Error broadcasting yield time updates: ${error.message}`);
      }
    }, 60000); // 60 seconds
  }

  private async broadcastYieldTimeUpdates() {
    try {
      // Get contract addresses to exclude
      const contractAddresses = this.getContractAddresses();
      
      // Get all users with properties
      const users = await this.db
        .select({
          id: schema.users.id,
          walletAddress: schema.users.walletAddress,
        })
        .from(schema.users)
        .limit(100); // Limit to avoid overload

      for (const user of users) {
        // Skip contract addresses
        const userAddr = user.walletAddress.toLowerCase();
        if (contractAddresses.includes(userAddr)) {
          this.logger.debug(`Skipping contract address ${userAddr} for yield updates`);
          continue;
        }
        
        try {
          const yieldTimeInfo = await this.getYieldTimeInfo(user.walletAddress);
          // Check if yieldTimeInfo is valid and has all required properties
          if (yieldTimeInfo && 
              yieldTimeInfo.properties.length > 0 &&
              yieldTimeInfo.yieldUpdateIntervalSeconds !== undefined &&
              yieldTimeInfo.currentBlockTimestamp !== undefined &&
              yieldTimeInfo.totalClaimableYield !== undefined) {
            // Use the gateway method to emit yield time update
            this.websocketGateway.emitYieldTimeUpdate(yieldTimeInfo);
            this.logger.log(`Broadcasted yield time update to ${user.walletAddress} (${yieldTimeInfo.properties.length} properties)`);
          }
        } catch (error) {
          this.logger.warn(`Failed to get yield time info for ${user.walletAddress}: ${error.message}`);
        }
      }
    } catch (error) {
      this.logger.error(`Error in broadcastYieldTimeUpdates: ${error.message}`);
    }
  }

  private getContractAddresses(): string[] {
    const addresses: string[] = [];
    if (this.contractsService.marketplace?.address) {
      addresses.push(this.contractsService.marketplace.address.toLowerCase());
    }
    if (this.contractsService.yieldDistributor?.address) {
      addresses.push(this.contractsService.yieldDistributor.address.toLowerCase());
    }
    if (this.contractsService.questSystem?.address) {
      addresses.push(this.contractsService.questSystem.address.toLowerCase());
    }
    if (this.contractsService.propertyNFT?.address) {
      addresses.push(this.contractsService.propertyNFT.address.toLowerCase());
    }
    if (this.contractsService.gameToken?.address) {
      addresses.push(this.contractsService.gameToken.address.toLowerCase());
    }
    if (this.contractsService.tokenSwap?.address) {
      addresses.push(this.contractsService.tokenSwap.address.toLowerCase());
    }
    // Old marketplace
    const oldMarketplace = process.env.OLD_MARKETPLACE_ADDRESS;
    if (oldMarketplace) {
      addresses.push(oldMarketplace.toLowerCase());
    }
    return addresses;
  }

  async broadcastYieldTimeUpdateForUser(walletAddress: string) {
    try {
      const yieldTimeInfo = await this.getYieldTimeInfo(walletAddress);
      if (yieldTimeInfo && 
          yieldTimeInfo.properties.length > 0 &&
          yieldTimeInfo.yieldUpdateIntervalSeconds !== undefined &&
          yieldTimeInfo.currentBlockTimestamp !== undefined &&
          yieldTimeInfo.totalClaimableYield !== undefined) {
        this.websocketGateway.emitYieldTimeUpdate(yieldTimeInfo);
        this.logger.log(`Manually broadcasted yield time update to ${walletAddress} (${yieldTimeInfo.properties.length} properties)`);
        return true;
      }
      return false;
    } catch (error) {
      this.logger.error(`Error broadcasting yield time update for ${walletAddress}: ${error.message}`);
      return false;
    }
  }

  async getPendingYield(walletAddress: string) {
    try {
      // First try to get from contract
      let totalYield = BigInt(0);
      try {
        totalYield = await this.contractsService.getTotalPendingYield(walletAddress);
      } catch (error) {
        this.logger.warn(`Contract yield calculation failed, calculating from database: ${error.message}`);
      }

      // If contract returns 0 or fails, calculate from database
      if (totalYield === BigInt(0)) {
        const [user] = await this.db
          .select()
          .from(schema.users)
          .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
          .limit(1);

        if (user) {
          const properties = await this.db
            .select()
            .from(schema.properties)
            .where(eq(schema.properties.ownerId, user.id));

          const now = new Date();
          for (const property of properties) {
            if (property.createdAt) {
              const createdAt = new Date(property.createdAt);
              const timeElapsedMs = now.getTime() - createdAt.getTime();
              const timeElapsedSeconds = timeElapsedMs / 1000;
              
              // Calculate estimated yield in real-time (by seconds) for engagement
              // This shows players what's accumulating, even though claimable yield requires 24 hours
              // This creates anticipation and engagement while respecting the daily yield mechanic
              if (timeElapsedSeconds > 0) {
                let propertyValue = BigInt(property.value.toString());
                let yieldRate = property.yieldRate || 500;
                let yieldSource = 'PROPERTY';
                
                // Check if property is linked to RWA - use RWA data for yield calculation
                if (property.rwaContract && property.rwaTokenId) {
                  try {
                    // Create RWA contract instance
                    const rwaAbi = [
                      'function getRWAProperty(uint256) external view returns (string name, uint256 value, uint256 monthlyYield, string location, uint256 propertyType, bool isActive)',
                      'function getYieldRate(uint256) external view returns (uint256)',
                    ];
                    const rwaContract = new ethers.Contract(
                      property.rwaContract,
                      rwaAbi,
                      this.contractsService.getProvider(),
                    );
                    
                    // Fetch RWA property data
                    const rwaProperty = await rwaContract.getRWAProperty(property.rwaTokenId);
                    const rwaYieldRate = await rwaContract.getYieldRate(property.rwaTokenId);
                    
                    const rwaValue = BigInt(rwaProperty.value.toString());
                    const rwaYieldRateNum = Number(rwaYieldRate.toString());
                    const rwaIsActive = rwaProperty.isActive;
                    
                    if (rwaIsActive && rwaValue > BigInt(0) && rwaYieldRateNum > 0) {
                      propertyValue = rwaValue;
                      yieldRate = rwaYieldRateNum;
                      yieldSource = 'RWA';
                      this.logger.debug(`Property ${property.tokenId}: Using RWA data for yield calculation`, {
                        rwaContract: property.rwaContract,
                        rwaTokenId: property.rwaTokenId,
                        rwaValue: rwaValue.toString(),
                        rwaYieldRate: rwaYieldRateNum,
                      });
                    } else {
                      this.logger.warn(`Property ${property.tokenId}: RWA linked but inactive or invalid, using property data`, {
                        rwaIsActive,
                        rwaValue: rwaValue.toString(),
                        rwaYieldRate: rwaYieldRateNum,
                      });
                    }
                  } catch (error) {
                    this.logger.warn(`Property ${property.tokenId}: Failed to fetch RWA data, using property data: ${error.message}`);
                  }
                }
                
                // Calculate daily yield: (value * yieldRate) / (365 * 10000)
                // Then calculate per-second yield for real-time accumulation display
                const dailyYield = (propertyValue * BigInt(yieldRate)) / BigInt(365 * 10000);
                const secondsPerDay = 86400;
                const yieldPerSecond = dailyYield / BigInt(secondsPerDay);
                
                // Calculate estimated yield for elapsed seconds (cap at 365 days worth)
                // This is for display only - actual claimable yield requires 24 hours (contract enforces this)
                const maxSeconds = 365 * secondsPerDay;
                const secondsToCalculate = Math.min(timeElapsedSeconds, maxSeconds);
                const propertyYield = yieldPerSecond * BigInt(Math.floor(secondsToCalculate));
                totalYield += propertyYield;
                
                this.logger.debug(`Property ${property.tokenId} estimated yield: ${propertyYield.toString()} wei (${ethers.utils.formatEther(propertyYield.toString())} TYCOON) - Source: ${yieldSource}`);
              }
            }
          }
        }
      }

      return {
        totalPending: totalYield.toString(),
        formatted: ethers.utils.formatEther(totalYield.toString()),
      };
    } catch (error) {
      this.logger.error(`Error getting pending yield: ${error.message}`);
      throw error;
    }
  }

  async getPropertyYield(propertyId: number) {
    try {
      // First try to get from contract (if yield has been distributed)
      let yieldAmount = BigInt(0);
      try {
        yieldAmount = await this.contractsService.calculateYield(BigInt(propertyId));
      } catch (error) {
        this.logger.warn(`Contract yield calculation failed, calculating from database: ${error.message}`);
      }

      // If contract returns 0 or fails, calculate from database based on time elapsed
      if (yieldAmount === BigInt(0)) {
        const [property] = await this.db
          .select()
          .from(schema.properties)
          .where(eq(schema.properties.tokenId, propertyId))
          .limit(1);

        if (property && property.createdAt) {
          // Calculate time elapsed since property creation
          const now = new Date();
          const createdAt = new Date(property.createdAt);
          const timeElapsedMs = now.getTime() - createdAt.getTime();
          const timeElapsedSeconds = timeElapsedMs / 1000;
          
          // Calculate estimated yield in real-time (by seconds) for engagement
          // This shows players what's accumulating, even though claimable yield requires 24 hours
          // The contract enforces the 24-hour requirement - this is just for display/engagement
          if (timeElapsedSeconds > 0) {
            // Property value is stored as string (NUMERIC), convert to BigInt
            let propertyValue = BigInt(property.value.toString());
            let yieldRate = property.yieldRate || 500; // Default to 5% (500 basis points)
            let yieldSource = 'PROPERTY';
            
            // Check if property is linked to RWA - use RWA data for yield calculation
            if (property.rwaContract && property.rwaTokenId) {
              try {
                // Create RWA contract instance
                const rwaAbi = [
                  'function getRWAProperty(uint256) external view returns (string name, uint256 value, uint256 monthlyYield, string location, uint256 propertyType, bool isActive)',
                  'function getYieldRate(uint256) external view returns (uint256)',
                ];
                const rwaContract = new ethers.Contract(
                  property.rwaContract,
                  rwaAbi,
                  this.contractsService.getProvider(),
                );
                
                // Fetch RWA property data
                const rwaProperty = await rwaContract.getRWAProperty(property.rwaTokenId);
                const rwaYieldRate = await rwaContract.getYieldRate(property.rwaTokenId);
                
                const rwaValue = BigInt(rwaProperty.value.toString());
                const rwaYieldRateNum = Number(rwaYieldRate.toString());
                const rwaIsActive = rwaProperty.isActive;
                
                if (rwaIsActive && rwaValue > BigInt(0) && rwaYieldRateNum > 0) {
                  propertyValue = rwaValue;
                  yieldRate = rwaYieldRateNum;
                  yieldSource = 'RWA';
                  this.logger.debug(`Property ${propertyId}: Using RWA data for yield calculation`, {
                    rwaContract: property.rwaContract,
                    rwaTokenId: property.rwaTokenId,
                    rwaValue: rwaValue.toString(),
                    rwaYieldRate: rwaYieldRateNum,
                  });
                } else {
                  this.logger.warn(`Property ${propertyId}: RWA linked but inactive or invalid, using property data`, {
                    rwaIsActive,
                    rwaValue: rwaValue.toString(),
                    rwaYieldRate: rwaYieldRateNum,
                  });
                }
              } catch (error) {
                this.logger.warn(`Property ${propertyId}: Failed to fetch RWA data, using property data: ${error.message}`);
              }
            }
            
            // Calculate daily yield: (value * yieldRate) / (365 * 10000)
            // Then calculate per-second yield for real-time accumulation display
            const dailyYield = (propertyValue * BigInt(yieldRate)) / BigInt(365 * 10000);
            const secondsPerDay = 86400;
            const yieldPerSecond = dailyYield / BigInt(secondsPerDay);
            
            // Calculate estimated yield for elapsed seconds (cap at 365 days worth)
            // This is for display only - actual claimable yield requires 24 hours (contract enforces this)
            const maxSeconds = 365 * secondsPerDay;
            const secondsToCalculate = Math.min(timeElapsedSeconds, maxSeconds);
            yieldAmount = yieldPerSecond * BigInt(Math.floor(secondsToCalculate));
            
            this.logger.debug(`Property ${propertyId} estimated yield: ${yieldAmount.toString()} wei (${ethers.utils.formatEther(yieldAmount.toString())} TYCOON) - Source: ${yieldSource}`);
          }
        }
      }

      return {
        pending: yieldAmount.toString(),
        formatted: ethers.utils.formatEther(yieldAmount.toString()),
      };
    } catch (error) {
      this.logger.error(`Error getting property yield: ${error.message}`);
      throw error;
    }
  }

  async getYieldHistory(walletAddress: string) {
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress.toLowerCase()))
      .limit(1);

    if (!user) {
      return [];
    }

    return this.db
      .select()
      .from(schema.yieldRecords)
      .where(eq(schema.yieldRecords.ownerId, user.id))
      .orderBy(schema.yieldRecords.createdAt);
  }

  /**
   * Calculate yield using Oracle service for dynamic rates
   * Uses Mantle's Chronicle Oracle for real-time yield rates
   */
  async calculateYieldWithOracle(propertyId: string, days: number = 1) {
    try {
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.id, propertyId))
        .limit(1);

      if (!property) {
        throw new Error('Property not found');
      }

      // Get yield rate from oracle (can be dynamic based on market conditions)
      const yieldRate = await this.oracleService.getPropertyYieldRate(property.propertyType);
      
      // Calculate yield amount
      // Property value is now stored as numeric (string), convert to BigInt for calculations
      const propertyValue = BigInt(property.value.toString());
      const yieldAmount = await this.oracleService.calculateYieldAmount(
        propertyValue,
        yieldRate,
        days,
      );

      return {
        yieldAmount: yieldAmount.toString(),
        formatted: ethers.utils.formatEther(yieldAmount.toString()),
        yieldRate,
        days,
      };
    } catch (error) {
      this.logger.error(`Error calculating yield with oracle: ${error.message}`);
      throw error;
    }
  }

  /**
   * Get optimized gas price using Mantle's GasPriceOracle
   */
  async getOptimizedGasPrice() {
    try {
      // Use Mantle API to get L2 gas price
      const l2GasPrice = await this.mantleApiService.getL2GasPrice();
      const l1BaseFee = await this.mantleApiService.getL1BaseFee();
      
      return {
        l2GasPrice: l2GasPrice.toString(),
        l1BaseFee: l1BaseFee.toString(),
        formatted: {
          l2GasPrice: ethers.utils.formatUnits(l2GasPrice.toString(), 'gwei'),
          l1BaseFee: ethers.utils.formatUnits(l1BaseFee.toString(), 'gwei'),
        },
      };
    } catch (error) {
      this.logger.error(`Error getting optimized gas price: ${error.message}`);
      throw error;
    }
  }

  async recordYieldClaim(propertyId: string, ownerId: string, amount: string, txHash: string) {
    const [record] = await this.db
      .insert(schema.yieldRecords)
      .values({
        propertyId,
        ownerId,
        amount: BigInt(amount),
        claimed: true,
        transactionHash: txHash,
        claimedAt: new Date(),
        createdAt: new Date(),
      })
      .returning();
    return record;
  }

  /**
   * Get yield time information for all properties of a wallet
   * Returns time remaining until yield is claimable for each property
   */
  async getYieldTimeInfo(walletAddress: string) {
    try {
      // Skip contract addresses
      const contractAddresses = this.getContractAddresses();
      if (contractAddresses.includes(walletAddress.toLowerCase())) {
        this.logger.debug(`Skipping yield time info for contract address ${walletAddress}`);
        return null;
      }
      
      if (!this.contractsService.yieldDistributor || !this.contractsService.propertyNFT) {
        this.logger.warn('Contracts not initialized');
        return null;
      }

      // Get yield update interval from contract
      let yieldUpdateInterval: bigint;
      try {
        yieldUpdateInterval = await this.contractsService.getYieldUpdateInterval();
      } catch (error: any) {
        // If YIELD_UPDATE_INTERVAL fails, contract might not be initialized correctly
        this.logger.error(`Failed to get YIELD_UPDATE_INTERVAL: ${error.message}`);
        return null;
      }
      const yieldUpdateIntervalSeconds = Number(yieldUpdateInterval);

      // Get current block timestamp
      const provider = this.contractsService.getProvider();
      const block = await provider.getBlock('latest');
      const currentBlockTimestamp = block.timestamp;

      // Get user's properties from blockchain
      let tokenIds: bigint[] = [];
      try {
        const result = await this.contractsService.getOwnerProperties(walletAddress);
        if (Array.isArray(result)) {
          tokenIds = result;
        } else if (result && typeof result === 'object' && 'length' in result) {
          tokenIds = Array.from(result as any);
        }
        
        // Log raw tokenIds to debug
        this.logger.debug(`Raw tokenIds from contract for ${walletAddress}:`, tokenIds.map(id => id.toString()));
      } catch (error: any) {
        // If getOwnerProperties fails, user has no properties in new contract
        this.logger.warn(`No properties found in new contract for ${walletAddress}: ${error.message}`);
        return { walletAddress, properties: [] };
      }
      
      if (!Array.isArray(tokenIds) || tokenIds.length === 0) {
        return { walletAddress, properties: [] };
      }

      // Deduplicate tokenIds (convert to numbers, remove duplicates)
      const uniqueTokenIds = Array.from(new Set(tokenIds.map(id => Number(id))));
      
      // Validate each property ID exists before processing
      // Property ID 0 CAN exist (first property minted), so we validate instead of filtering
      const validTokenIds: number[] = [];
      for (const tokenId of uniqueTokenIds) {
        if (tokenId < 0) {
          this.logger.warn(`Skipping invalid property ID (negative): ${tokenId} for ${walletAddress}`);
          continue;
        }
        
        // Check if property exists by trying to get owner
        try {
          await this.contractsService.propertyNFT.ownerOf(BigInt(tokenId));
          validTokenIds.push(tokenId);
        } catch (error: any) {
          // Property doesn't exist, skip it
          this.logger.warn(`Skipping non-existent property ID: ${tokenId} for ${walletAddress}`);
        }
      }
      
      // Log if we filtered out any invalid/non-existent IDs
      const filteredCount = uniqueTokenIds.length - validTokenIds.length;
      if (filteredCount > 0) {
        this.logger.warn(`Filtered out ${filteredCount} invalid/non-existent property ID(s) for ${walletAddress}`);
      }
      
      this.logger.log(`Found ${tokenIds.length} tokenIds, ${validTokenIds.length} unique valid properties for ${walletAddress}`);

      const properties = await Promise.all(
        validTokenIds.map(async (tokenId): Promise<{
          tokenId: number;
          lastYieldUpdate: number;
          createdAt: number;
          timeElapsedSeconds: number;
          timeElapsedHours: number;
          hoursRemaining: number;
          minutesRemaining: number;
          isClaimable: boolean;
          claimableYield: string;
        } | null> => {
          try {
            // Get lastYieldUpdate from contract
            const lastUpdate = await this.contractsService.getLastYieldUpdate(BigInt(Number(tokenId)));
            const lastUpdateTimestamp = Number(lastUpdate);

            // Get property data to get createdAt
            const propData = await this.contractsService.getProperty(BigInt(Number(tokenId)));
            const createdAtTimestamp = Number(propData.createdAt);

            // Determine start timestamp (lastYieldUpdate if > 0, else createdAt)
            const startTimestamp = lastUpdateTimestamp > 0 ? lastUpdateTimestamp : createdAtTimestamp;

            // Calculate time elapsed and remaining
            const timeElapsed = currentBlockTimestamp - startTimestamp;
            const timeElapsedSeconds = timeElapsed;
            const isClaimable = timeElapsedSeconds >= yieldUpdateIntervalSeconds;

            let hoursRemaining = 0;
            let minutesRemaining = 0;
            if (!isClaimable) {
              const timeRemaining = yieldUpdateIntervalSeconds - timeElapsedSeconds;
              hoursRemaining = Math.floor(timeRemaining / 3600);
              minutesRemaining = Math.floor((timeRemaining % 3600) / 60);
            }

            // Get claimable yield from contract
            const claimableYieldResult = await this.contractsService.calculateYield(BigInt(Number(tokenId)));
            
            // Ensure claimableYield is a BigInt (contractsService.calculateYield returns bigint)
            const claimableYieldBigInt: bigint = typeof claimableYieldResult === 'bigint' 
              ? claimableYieldResult 
              : BigInt(String(claimableYieldResult));
            
            // Log for debugging
            this.logger.debug(`Property ${tokenId} claimable yield: ${claimableYieldBigInt.toString()} wei (${Number(claimableYieldBigInt) / 1e18} TYCOON)`);

            return {
              tokenId: Number(tokenId),
              lastYieldUpdate: lastUpdateTimestamp,
              createdAt: createdAtTimestamp,
              timeElapsedSeconds,
              timeElapsedHours: timeElapsedSeconds / 3600,
              hoursRemaining,
              minutesRemaining,
              isClaimable,
              claimableYield: claimableYieldBigInt.toString(),
            };
          } catch (error) {
            this.logger.warn(`Failed to get yield time info for property ${tokenId}: ${error.message}`);
            return null;
          }
        })
      );

      // Filter out nulls
      const validProperties = properties.filter((p): p is NonNullable<typeof p> => p !== null);

      // Find shortest time remaining
      const nonClaimableProperties = validProperties.filter((p) => !p.isClaimable);
      let shortestTimeRemaining: { hours: number; minutes: number } | null = null;
      if (nonClaimableProperties.length > 0) {
        const shortest = nonClaimableProperties.reduce((min, current) => {
          const minMinutes = min.hoursRemaining * 60 + min.minutesRemaining;
          const currentMinutes = current.hoursRemaining * 60 + current.minutesRemaining;
          return currentMinutes < minMinutes ? current : min;
        });
        shortestTimeRemaining = {
          hours: Number(shortest.hoursRemaining), // Ensure number, not BigInt
          minutes: Number(shortest.minutesRemaining), // Ensure number, not BigInt
        };
      }

      // Calculate total claimable yield (keep in wei, frontend will convert)
      const totalClaimable = validProperties.reduce((sum, p) => {
        // claimableYield is already a string from the property object
        const claimableStr = String(p.claimableYield || '0');
        
        // Validate the string is a valid number (not concatenated or corrupted)
        if (!/^\d+$/.test(claimableStr)) {
          this.logger.warn(`Invalid claimableYield for property ${p.tokenId}: ${claimableStr}`);
          return sum;
        }
        
        const claimableBigInt = BigInt(claimableStr);
        
        // Sanity check: individual property yield should be reasonable
        const MAX_REASONABLE_YIELD = BigInt('1000000000000000000000'); // 1000 TYCOON
        if (claimableBigInt > MAX_REASONABLE_YIELD) {
          this.logger.warn(`Suspiciously large yield for property ${p.tokenId}: ${claimableStr} wei. Skipping.`);
          return sum;
        }
        
        const newSum = sum + claimableBigInt;
        return newSum;
      }, BigInt(0));
      
      // Log for debugging
      this.logger.log(`Total claimable yield for ${walletAddress}: ${totalClaimable.toString()} wei (${Number(totalClaimable) / 1e18} TYCOON)`);

      return {
        walletAddress,
        yieldUpdateIntervalSeconds: Number(yieldUpdateIntervalSeconds), // Ensure number, not BigInt
        currentBlockTimestamp: Number(currentBlockTimestamp), // Ensure number, not BigInt
        shortestTimeRemaining,
        totalClaimableYield: totalClaimable.toString(), // Already string
        properties: validProperties.map(p => ({
          ...p,
          claimableYield: String(p.claimableYield), // Ensure string
        })),
      };
    } catch (error) {
      this.logger.error(`Error getting yield time info: ${error.message}`);
      throw error;
    }
  }
}
</file>

<file path="frontend/src/components/game/PropertyDetails.tsx">
'use client';

import { X, Building2, DollarSign, TrendingUp, Link as LinkIcon, Tag } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { useMNTPrice, tycoonToUSD, formatUSD } from '@/hooks/useMNTPrice';

interface PropertyDetailsProps {
  property: {
    id: string;
    tokenId: number;
    propertyType: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury';
    value: bigint;
    yieldRate: number;
    totalYieldEarned: bigint;
    rwaContract?: string;
    rwaTokenId?: number;
  };
  claimableYield?: bigint; // Claimable yield for this property (from contract)
  isOpen: boolean;
  onClose: () => void;
  onClaimYield?: () => void | Promise<void>;
  onLinkRWA?: () => void;
  onSellProperty?: () => void;
  onCancelListing?: () => void;
  isListed?: boolean;
  isClaiming?: boolean;
}

export function PropertyDetails({
  property,
  claimableYield,
  isOpen,
  onClose,
  onClaimYield,
  onLinkRWA,
  onSellProperty,
  onCancelListing,
  isListed = false,
  isClaiming = false,
}: PropertyDetailsProps) {
  if (!isOpen) return null;

  const { tycoonPriceUSD } = useMNTPrice();

  const formatValue = (value: bigint) => {
    return (Number(value) / 1e18).toFixed(4);
  };

  return (
    <>
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50" onClick={onClose} />
      <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
        <Card className="w-full max-w-md border-white/20 bg-gray-900/95 backdrop-blur-xl">
          <div className="p-6">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-lg bg-blue-500 flex items-center justify-center">
                  <Building2 className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h2 className="text-xl font-bold text-white">{property.propertyType} Property</h2>
                  <p className="text-sm text-gray-400">Token ID: #{property.tokenId}</p>
                </div>
              </div>
              <Button variant="ghost" size="icon" onClick={onClose}>
                <X className="w-5 h-5" />
              </Button>
            </div>

            <CardContent className="space-y-4 p-0">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-gray-400 mb-1">Property Value</p>
                  <p className="text-lg font-semibold text-white flex items-center gap-1">
                    <DollarSign className="w-4 h-4" />
                    {formatValue(property.value)} TYCOON
                    {tycoonPriceUSD && (
                      <span className="text-xs text-gray-400 ml-1">
                        {formatUSD(tycoonToUSD(property.value, tycoonPriceUSD))}
                      </span>
                    )}
                  </p>
                </div>
                <div>
                  <p className="text-xs text-gray-400 mb-1">Yield Rate</p>
                  <p className="text-lg font-semibold text-emerald-400 flex items-center gap-1">
                    <TrendingUp className="w-4 h-4" />
                    {(property.yieldRate / 100).toFixed(1)}% APY
                  </p>
                </div>
              </div>

              <div>
                <p className="text-xs text-gray-400 mb-1">Total Yield Earned</p>
                <p className="text-2xl font-bold text-emerald-500">
                  {formatValue(property.totalYieldEarned)} TYCOON
                  {tycoonPriceUSD && (
                    <span className="text-sm text-gray-400 ml-2">
                      {formatUSD(tycoonToUSD(property.totalYieldEarned, tycoonPriceUSD))}
                    </span>
                  )}
                </p>
              </div>

              {property.rwaContract ? (
                <div className="p-3 bg-emerald-900/20 rounded-lg border border-emerald-500/30">
                  <div className="flex items-center gap-2 mb-2">
                    <LinkIcon className="w-4 h-4 text-emerald-400" />
                    <p className="text-xs text-emerald-400 font-semibold"> Linked to RWA - Using RWA Yield</p>
                  </div>
                  <p className="text-xs text-gray-300 mb-1">Yield calculated from RWA value and yield rate</p>
                  <p className="text-sm text-white font-mono truncate">{property.rwaContract}</p>
                  {property.rwaTokenId && (
                    <p className="text-xs text-gray-400">Token ID: {property.rwaTokenId}</p>
                  )}
                </div>
              ) : (
                <div className="p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                  <p className="text-xs text-gray-400 mb-2">Not linked to RWA</p>
                  {onLinkRWA && (
                    <Button onClick={onLinkRWA} variant="outline" size="sm" className="w-full">
                      <LinkIcon className="w-4 h-4 mr-2" />
                      Link to RWA
                    </Button>
                  )}
                </div>
              )}

              <div className="flex flex-col gap-2 pt-2">
                <div className="flex gap-2">
                  {onClaimYield && (
                    <Button 
                      onClick={onClaimYield} 
                      disabled={isClaiming || !claimableYield || claimableYield === BigInt(0)}
                      className="flex-1 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      title={!claimableYield || claimableYield === BigInt(0) ? 'No yield available yet. Requires 24 hours after property creation.' : 'Claim your yield'}
                    >
                      {isClaiming ? 'Claiming...' : claimableYield && claimableYield > BigInt(0) ? 'Claim Yield' : 'No Yield Yet'}
                    </Button>
                  )}
                  {isListed ? (
                    onCancelListing && (
                      <Button 
                        onClick={onCancelListing} 
                        variant="outline"
                        className="flex-1 border-red-500/50 text-red-400 hover:bg-red-500/10"
                      >
                        <Tag className="w-4 h-4 mr-2" />
                        Cancel Listing
                      </Button>
                    )
                  ) : (
                    onSellProperty && (
                      <Button 
                        onClick={onSellProperty} 
                        variant="outline"
                        className="flex-1 border-orange-500/50 text-orange-400 hover:bg-orange-500/10"
                      >
                        <Tag className="w-4 h-4 mr-2" />
                        Sell Property
                      </Button>
                    )
                  )}
                </div>
                <Button onClick={onClose} variant="outline" className="w-full">
                  Close
                </Button>
              </div>
            </CardContent>
          </div>
        </Card>
      </div>
    </>
  );
}
</file>

<file path="frontend/src/components/Leaderboard.tsx">
'use client';

import { useState, useEffect } from 'react';
import { Trophy, Medal, Award, TrendingUp, ExternalLink } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { api } from '@/lib/api';
import { VisitPortfolio } from './VisitPortfolio';
import { io, Socket } from 'socket.io-client';

interface LeaderboardEntry {
  rank: number;
  walletAddress: string;
  username?: string;
  totalPortfolioValue: string | bigint; // Backend returns string (NUMERIC), frontend may use bigint
  totalYieldEarned: string | bigint;
  propertiesOwned: number;
  questsCompleted: number;
}

export function Leaderboard() {
  const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [activeTab, setActiveTab] = useState<'global' | 'guilds'>('global');
  const [guildLeaderboard, setGuildLeaderboard] = useState<any[]>([]);
  const [visitingPortfolio, setVisitingPortfolio] = useState<{ address: string; username?: string } | null>(null);

  useEffect(() => {
    // Load leaderboard immediately
    loadLeaderboard();
    
    // Subscribe to WebSocket for real-time leaderboard updates
    const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';
    const socket = (window as any).socket || io(apiUrl);
    
    // Ensure socket is connected
    if (!socket.connected) {
      socket.connect();
    }
    
    socket.emit('subscribe:leaderboard');
    console.log(' Subscribed to leaderboard WebSocket updates');
    
    socket.on('leaderboard:updated', (data: { rankings: LeaderboardEntry[] }) => {
      console.log(' Leaderboard updated via WebSocket:', data);
      if (activeTab === 'global' && data.rankings) {
        setLeaderboard(data.rankings);
        console.log(' Updated leaderboard from WebSocket:', data.rankings.length, 'entries');
      }
    });
    
    // Also refresh periodically (every 5 seconds) to catch any missed updates
    // Only refresh global leaderboard periodically, not guild leaderboard
    // Guild leaderboard updates via WebSocket or manual refresh
    const refreshInterval = setInterval(() => {
      if (activeTab === 'global') {
        console.log(' Periodic global leaderboard refresh...');
        // Only refresh global leaderboard, not guild leaderboard
        loadLeaderboard();
      }
    }, 30000); // Increased to 30 seconds to reduce load
    
    return () => {
      socket.off('leaderboard:updated');
      clearInterval(refreshInterval);
    };
  }, [activeTab]);

  const loadLeaderboard = async () => {
    setIsLoading(true);
    try {
      if (activeTab === 'global') {
        try {
          const data = await api.get('/leaderboard?limit=100');
          console.log(' Loaded leaderboard from backend:', data.length, 'entries');
          // Find current user's entry
          const userEntry = data.find((entry: LeaderboardEntry) => 
            entry.walletAddress?.toLowerCase() === '0xd2df53d9791e98db221842dd085f4144014bbe2a'.toLowerCase()
          );
          if (userEntry) {
            console.log(' Your leaderboard entry:', {
              propertiesOwned: userEntry.propertiesOwned,
              totalPortfolioValue: userEntry.totalPortfolioValue,
            });
          }
          setLeaderboard(data);
        } catch (error) {
          console.warn('Backend leaderboard unavailable, showing empty leaderboard:', error);
          // Backend unavailable - show empty state
          setLeaderboard([]);
        }
      } else {
        try {
          const data = await api.get('/guilds/leaderboard?limit=20');
          setGuildLeaderboard(data);
        } catch (error) {
          console.warn('Backend guild leaderboard unavailable:', error);
          setGuildLeaderboard([]);
        }
      }
    } catch (error) {
      console.error('Failed to load leaderboard:', error);
      setLeaderboard([]);
      setGuildLeaderboard([]);
    } finally {
      setIsLoading(false);
    }
  };

  const formatValue = (value: string | bigint) => {
    // Handle both string (from backend NUMERIC) and bigint
    const valueStr = typeof value === 'string' ? value : value.toString();
    // Value is already in wei (smallest unit), convert to TYCOON
    const tycoonAmount = Number(valueStr) / 1e18;
    if (tycoonAmount < 1) {
      return tycoonAmount.toFixed(2);
    }
    return tycoonAmount.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
  };

  const getRankIcon = (rank: number) => {
    if (rank === 1) return <Trophy className="w-5 h-5 text-yellow-400" />;
    if (rank === 2) return <Medal className="w-5 h-5 text-gray-300" />;
    if (rank === 3) return <Award className="w-5 h-5 text-orange-400" />;
    return <span className="text-gray-500 font-semibold">#{rank}</span>;
  };

  return (
    <Card className="border-white/10 bg-white/5 backdrop-blur-md">
      <CardHeader>
        <CardTitle className="text-white flex items-center gap-2">
          <Trophy className="w-5 h-5 text-yellow-400" />
          Leaderboard
        </CardTitle>
        <div className="flex gap-2 mt-4">
          <button
            onClick={() => setActiveTab('global')}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              activeTab === 'global'
                ? 'bg-blue-600 text-white'
                : 'bg-white/5 text-gray-400 hover:bg-white/10'
            }`}
          >
            Global
          </button>
          <button
            onClick={() => setActiveTab('guilds')}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              activeTab === 'guilds'
                ? 'bg-blue-600 text-white'
                : 'bg-white/5 text-gray-400 hover:bg-white/10'
            }`}
          >
            Guilds
          </button>
        </div>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="text-center py-8 text-gray-400">Loading leaderboard...</div>
        ) : activeTab === 'global' ? (
          <div className="space-y-2">
            {leaderboard.length === 0 ? (
              <div className="text-center py-8 text-gray-400">No rankings yet</div>
            ) : (
              leaderboard.map((entry) => (
                <div
                  key={entry.walletAddress}
                  className="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    {getRankIcon(entry.rank)}
                    <div>
                      <p className="text-white font-semibold">
                        {entry.username || `${entry.walletAddress.slice(0, 6)}...${entry.walletAddress.slice(-4)}`}
                      </p>
                      <p className="text-xs text-gray-400">
                        {entry.propertiesOwned} properties  {entry.questsCompleted} quests
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="text-right">
                      <p className="text-emerald-400 font-semibold">{formatValue(entry.totalPortfolioValue)} TYCOON</p>
                      <p className="text-xs text-gray-400">Yield: {formatValue(entry.totalYieldEarned)}</p>
                    </div>
                    <Button
                      onClick={() => setVisitingPortfolio({ address: entry.walletAddress, username: entry.username })}
                      variant="outline"
                      size="sm"
                      className="border-blue-500/50 text-blue-400 hover:bg-blue-500/10"
                    >
                      <ExternalLink className="w-3 h-3 mr-1" />
                      Visit
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        ) : (
          <div className="space-y-2">
            {guildLeaderboard.length === 0 ? (
              <div className="text-center py-8 text-gray-400">No guilds yet</div>
            ) : (
              guildLeaderboard.map((guild) => (
                <div
                  key={guild.id}
                  className="flex items-center justify-between p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                >
                  <div className="flex items-center gap-3">
                    {getRankIcon(guild.rank)}
                    <div>
                      <p className="text-white font-semibold">{guild.name}</p>
                      <p className="text-xs text-gray-400">
                        {guild.totalMembers} members  Owner: {guild.owner?.username || `${guild.owner?.walletAddress?.slice(0, 6)}...${guild.owner?.walletAddress?.slice(-4)}`}
                      </p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-emerald-400 font-semibold">{formatValue(guild.totalPortfolioValue)} TYCOON</p>
                    <p className="text-xs text-gray-400">Yield: {formatValue(guild.totalYieldEarned)}</p>
                  </div>
                </div>
              ))
            )}
          </div>
        )}
      </CardContent>

      {visitingPortfolio && (
        <VisitPortfolio
          address={visitingPortfolio.address}
          username={visitingPortfolio.username}
          onClose={() => setVisitingPortfolio(null)}
        />
      )}
    </Card>
  );
}
</file>

<file path="frontend/src/components/Guilds.tsx">
'use client'

import { useState, useEffect } from 'react'
import { useAccount } from 'wagmi'
import { Users, Plus, Crown, TrendingUp } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { api } from '@/lib/api'

interface Guild {
  id: string
  name: string
  description: string
  memberCount: number
  totalPortfolioValue: bigint
  totalYield: bigint
  owner: string
}

export function Guilds() {
  const { address, isConnected } = useAccount()
  const [guilds, setGuilds] = useState<Guild[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [showCreateForm, setShowCreateForm] = useState(false)
  const [guildName, setGuildName] = useState('')
  const [guildDescription, setGuildDescription] = useState('')
  const [myGuild, setMyGuild] = useState<any>(null)
  const [joiningGuildId, setJoiningGuildId] = useState<string | null>(null)

  useEffect(() => {
    loadGuilds()
    if (address) {
      loadMyGuild()
    }
  }, [address])

  const loadGuilds = async () => {
    setIsLoading(true)
    try {
      const data = await api.get('/guilds')
      setGuilds(data)
    } catch (error) {
      console.error('Failed to load guilds:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const loadMyGuild = async () => {
    if (!address) {
      setMyGuild(null)
      return
    }
    try {
      // Get guild by wallet address directly
      const guildResponse = await api.get(`/guilds/wallet/${address.toLowerCase()}`)
      console.log('Loaded my guild:', guildResponse)
      if (guildResponse && guildResponse.id) {
        setMyGuild(guildResponse)
      } else {
        setMyGuild(null)
      }
    } catch (error: any) {
      // User might not be in a guild yet (404 is expected, 500 means server error)
      if (error.response?.status === 404) {
        // Not in a guild - this is normal
        setMyGuild(null)
      } else {
        // Other error (500, etc.) - log it but don't block UI
        console.error('Failed to load my guild:', error)
        setMyGuild(null)
      }
    }
  }

  const createGuild = async () => {
    if (!guildName.trim() || !address) return
    
    // Check if already in a guild
    if (myGuild) {
      alert(`You are already a member of ${myGuild.name}. Leave it first to create a new guild.`)
      return
    }
    
    try {
      await api.post('/guilds', {
        walletAddress: address.toLowerCase(),
        name: guildName,
        description: guildDescription,
      })
      setGuildName('')
      setGuildDescription('')
      setShowCreateForm(false)
      loadGuilds()
      loadMyGuild()
    } catch (error: any) {
      console.error('Failed to create guild:', error)
      alert(error.response?.data?.message || 'Failed to create guild')
    }
  }

  const leaveGuild = async (guildId: string) => {
    if (!address || !isConnected) {
      alert('Please connect your wallet first')
      return
    }
    
    if (!confirm(`Are you sure you want to leave ${myGuild?.name || 'this guild'}?`)) {
      return
    }
    
    try {
      await api.post(`/guilds/${guildId}/leave`, {
        walletAddress: address.toLowerCase(),
      })
      await Promise.all([loadGuilds(), loadMyGuild()])
      alert('Successfully left guild!')
    } catch (error: any) {
      console.error('Failed to leave guild:', error)
      alert(error.response?.data?.message || 'Failed to leave guild')
    }
  }

  const joinGuild = async (guildId: string) => {
    if (!address || !isConnected) {
      alert('Please connect your wallet first')
      return
    }
    
    // First, check if we're already in a guild by checking the API directly
    // This ensures we have the latest state before attempting to join
    let currentGuild = null
    try {
      currentGuild = await api.get(`/guilds/wallet/${address.toLowerCase()}`)
    } catch (error: any) {
      // 404 means not in a guild, which is fine
      if (error.response?.status !== 404) {
        console.error('Error checking guild status:', error)
      }
    }
    
    // If we're already in a guild, prevent join attempt
    if (currentGuild && currentGuild.id) {
      alert(`You are already a member of ${currentGuild.name}. Leave it first to join another guild.`)
      // Update state to reflect current guild
      setMyGuild(currentGuild)
      return
    }
    
    setJoiningGuildId(guildId)
    try {
      await api.post(`/guilds/${guildId}/join`, {
        walletAddress: address.toLowerCase(),
      })
      // Reload both guilds list and my guild to update UI
      await Promise.all([loadGuilds(), loadMyGuild()])
      alert('Successfully joined guild!')
    } catch (error: any) {
      console.error('Failed to join guild:', error)
      const errorMessage = error.response?.data?.message || 'Failed to join guild'
      
      // If error says "already a member", reload myGuild to update UI
      if (errorMessage.includes('already a member')) {
        await loadMyGuild()
        alert(`You are already a member of a guild. The page will refresh to show your current guild.`)
        // Force a reload to ensure UI is in sync
        window.location.reload()
        return
      }
      
      alert(errorMessage)
    } finally {
      setJoiningGuildId(null)
    }
  }

  const formatValue = (value: bigint) => {
    const amount = Number(value) / 1e18
    if (amount < 1) return amount.toFixed(4)
    return amount.toFixed(2)
  }

  return (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-bold text-white">Guilds</h2>
        <Button
          onClick={() => {
            if (myGuild) {
              alert(`You are already a member of ${myGuild.name}. Leave it first to create a new guild.`)
              return
            }
            setShowCreateForm(!showCreateForm)
          }}
          variant="outline"
          size="sm"
          className="border-green-500/50 text-green-400 hover:bg-green-500/10"
          disabled={!!myGuild}
        >
          <Plus className="w-4 h-4 mr-2" />
          Create Guild
        </Button>
      </div>

      {showCreateForm && (
        <Card className="bg-gray-800/50 border-white/10">
          <CardHeader>
            <CardTitle className="text-white">Create New Guild</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {myGuild && (
              <div className="bg-yellow-500/10 border border-yellow-500/50 rounded p-3 text-sm text-yellow-400">
                You are already a member of {myGuild.name}. Leave it first to create a new guild.
              </div>
            )}
            <Input
              placeholder="Guild name"
              value={guildName}
              onChange={(e) => setGuildName(e.target.value)}
              className="bg-gray-900 border-white/10 text-white"
              disabled={!!myGuild}
            />
            <Input
              placeholder="Description (optional)"
              value={guildDescription}
              onChange={(e) => setGuildDescription(e.target.value)}
              className="bg-gray-900 border-white/10 text-white"
              disabled={!!myGuild}
            />
            <div className="flex gap-2">
              <Button 
                onClick={createGuild} 
                className="bg-green-500 hover:bg-green-600"
                disabled={!!myGuild}
              >
                Create
              </Button>
              <Button
                onClick={() => setShowCreateForm(false)}
                variant="outline"
                className="border-white/10"
              >
                Cancel
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {myGuild && (
        <Card className="bg-green-500/10 border-green-500/50">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div>
                <div className="flex items-center gap-2">
                  <Crown className="w-4 h-4 text-yellow-400" />
                  <h3 className="text-white font-semibold">My Guild: {myGuild.name}</h3>
                </div>
                {myGuild.description && (
                  <p className="text-sm text-gray-400 mt-1">{myGuild.description}</p>
                )}
                <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
                  <span>{myGuild.totalMembers || myGuild.members?.length || 0} members</span>
                </div>
              </div>
              <Button
                variant="outline"
                size="sm"
                className="border-red-500/50 text-red-400 hover:bg-red-500/10"
                onClick={() => leaveGuild(myGuild.id)}
              >
                Leave Guild
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {isLoading ? (
        <div className="text-center py-8 text-gray-400">Loading guilds...</div>
      ) : guilds.length === 0 ? (
        <div className="text-center py-8 text-gray-400">No guilds yet. Create the first one!</div>
      ) : (
        <div className="space-y-3">
          {guilds.map((guild) => (
            <Card key={guild.id} className="bg-white/5 border-white/10 hover:bg-white/10 transition-colors">
              <CardContent className="p-4">
                <div className="flex items-start justify-between">
                  <div className="flex items-start gap-3">
                    <div className="p-2 rounded-lg bg-green-500/10 border border-green-500/20">
                      <Users className="w-5 h-5 text-green-400" />
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <h3 className="text-white font-semibold">{guild.name}</h3>
                        {guild.owner && (
                          <Crown className="w-4 h-4 text-yellow-400" />
                        )}
                      </div>
                      {guild.description && (
                        <p className="text-sm text-gray-400 mt-1">{guild.description}</p>
                      )}
                      <div className="flex items-center gap-4 mt-2 text-xs text-gray-400">
                        <span>{guild.memberCount} members</span>
                        <span className="flex items-center gap-1">
                          <TrendingUp className="w-3 h-3" />
                          {formatValue(guild.totalPortfolioValue)} TYCOON
                        </span>
                      </div>
                    </div>
                  </div>
                  <Button 
                    variant="outline" 
                    size="sm" 
                    className="border-green-500/50 text-green-400 hover:bg-green-500/10"
                    onClick={() => joinGuild(guild.id)}
                    disabled={joiningGuildId === guild.id || !!myGuild || !isConnected}
                  >
                    {joiningGuildId === guild.id 
                      ? 'Joining...' 
                      : (myGuild && myGuild.id === guild.id) 
                        ? 'Joined' 
                        : myGuild 
                          ? 'In Another Guild'
                          : 'Join'}
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}
</file>

<file path="backend/src/events/event-indexer.service.ts">
import { Injectable, OnModuleInit, Logger, Inject, forwardRef } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { ethers } from 'ethers';
import { ContractsService } from '../contracts/contracts.service';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, and } from 'drizzle-orm';
import { WebsocketGateway } from '../websocket/websocket.gateway';
import { MantleApiService } from '../mantle/mantle-api.service';
import { LeaderboardService } from '../leaderboard/leaderboard.service';
import { GuildsService } from '../guilds/guilds.service';
import { PropertiesService } from '../properties/properties.service';
import { YieldService } from '../yield/yield.service';

@Injectable()
export class EventIndexerService implements OnModuleInit {
  private readonly logger = new Logger(EventIndexerService.name);
  private isIndexing = false;
  private lastProcessedBlock: number = 0;
  private readonly BLOCK_CONFIRMATIONS = 1; // Mantle has fast finality

  constructor(
    private configService: ConfigService,
    private contractsService: ContractsService,
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private websocketGateway: WebsocketGateway,
    private mantleApiService: MantleApiService,
    private leaderboardService: LeaderboardService,
    private guildsService: GuildsService,
    @Inject(forwardRef(() => PropertiesService)) private propertiesService: PropertiesService,
    @Inject(forwardRef(() => YieldService)) private yieldService: YieldService,
  ) {}

  async onModuleInit() {
    if (!this.contractsService.propertyNFT) {
      this.logger.warn('Contracts not initialized. Skipping event indexer setup.');
      return;
    }

    // Get last processed block from database or start from current block
    await this.initializeLastProcessedBlock();
    
    // Start listening to events
    this.startEventListeners();
    
    // Start periodic sync for missed events
    this.startPeriodicSync();
    
    // Optionally sync all existing properties on startup
    // This ensures properties created before backend was running are in database
    if (process.env.SYNC_EXISTING_ON_STARTUP === 'true' && process.env.ENABLE_PROPERTY_SYNC !== 'false') {
      this.logger.log(' SYNC_EXISTING_ON_STARTUP=true - syncing all existing properties...');
      // Run in background to not block startup
      setTimeout(async () => {
        try {
          await this.propertiesService.syncAllExistingPropertiesFromChain();
          this.logger.log(' Auto-sync of existing properties completed');
        } catch (error) {
          this.logger.warn('Could not auto-sync existing properties on startup:', error.message);
        }
      }, 5000); // Wait 5 seconds after startup
    } else {
      this.logger.log(' To sync existing properties, call POST /properties/sync-all or set SYNC_EXISTING_ON_STARTUP=true');
    }
    
    this.logger.log('Event Indexer Service initialized');
  }

  private async initializeLastProcessedBlock() {
    try {
      // In production, store this in a database table
      // For now, start from current block minus some blocks for safety
      const currentBlock = await this.contractsService.getProvider().getBlockNumber();
      this.lastProcessedBlock = Math.max(0, currentBlock - 1000); // Start 1000 blocks back
      this.logger.log(`Starting event indexing from block ${this.lastProcessedBlock}`);
    } catch (error) {
      this.logger.error('Failed to initialize last processed block', error);
      this.lastProcessedBlock = 0;
    }
  }

  private startEventListeners() {
    // Listen to PropertyNFT events
    this.listenToPropertyNFTEvents();
    
    // Listen to YieldDistributor events
    this.listenToYieldDistributorEvents();
    
    // Listen to Marketplace events
    this.listenToMarketplaceEvents();
    
    // Listen to QuestSystem events
    this.listenToQuestSystemEvents();
    
    // Note: TokenSwap events are not listened to - token purchase is blockchain-only
    // No backend sync needed for token purchases
  }

  private listenToPropertyNFTEvents() {
    const contract = this.contractsService.propertyNFT;
    if (!contract) return;

    // PropertyCreated event
    contract.on('PropertyCreated', async (tokenId, owner, propertyType, value, event) => {
      try {
        this.logger.log(`PropertyCreated: tokenId=${tokenId}, owner=${owner}`);
        await this.handlePropertyCreated(
          tokenId.toString(),
          owner,
          propertyType,
          value.toString(),
          event.blockNumber,
        );
      } catch (error) {
        this.logger.error('Error handling PropertyCreated event', error);
      }
    });

    // PropertyLinkedToRWA event
    contract.on('PropertyLinkedToRWA', async (tokenId, rwaContract, rwaTokenId, event) => {
      try {
        this.logger.log(`PropertyLinkedToRWA: tokenId=${tokenId}`);
        await this.handlePropertyLinkedToRWA(
          tokenId.toString(),
          rwaContract,
          rwaTokenId.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling PropertyLinkedToRWA event', error);
      }
    });

    // PropertyUpgraded event
    contract.on('PropertyUpgraded', async (tokenId, newType, newValue, event) => {
      try {
        this.logger.log(`PropertyUpgraded: tokenId=${tokenId}`);
        await this.handlePropertyUpgraded(
          tokenId.toString(),
          newType,
          newValue.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling PropertyUpgraded event', error);
      }
    });

    // Transfer event (property ownership change)
    contract.on('Transfer', async (from, to, tokenId, event) => {
      try {
        this.logger.log(`Property Transfer: tokenId=${tokenId}, from=${from}, to=${to}`);
        await this.handlePropertyTransfer(
          tokenId.toString(),
          from,
          to,
        );
      } catch (error) {
        this.logger.error('Error handling Transfer event', error);
      }
    });

    this.logger.log('PropertyNFT event listeners started');
  }

  private listenToYieldDistributorEvents() {
    const contract = this.contractsService.yieldDistributor;
    if (!contract) return;

    // YieldDistributed event
    contract.on('YieldDistributed', async (propertyId, amount, event) => {
      try {
        this.logger.log(`YieldDistributed: propertyId=${propertyId}, amount=${amount}`);
        await this.handleYieldDistributed(
          propertyId.toString(),
          amount.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling YieldDistributed event', error);
      }
    });

    // YieldClaimed event
    contract.on('YieldClaimed', async (propertyId, owner, amount, event) => {
      try {
        this.logger.log(`YieldClaimed: propertyId=${propertyId}, owner=${owner}, amount=${amount}`);
        await this.handleYieldClaimed(
          propertyId.toString(),
          owner,
          amount.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling YieldClaimed event', error);
      }
    });

    this.logger.log('YieldDistributor event listeners started');
  }

  private listenToMarketplaceEvents() {
    const contract = this.contractsService.marketplace;
    if (!contract) {
      this.logger.warn('Marketplace contract not initialized - marketplace events will not be listened to');
      this.logger.warn('Make sure MARKETPLACE_ADDRESS is set in backend/.env');
      return;
    }
    
    this.logger.log('Starting marketplace event listeners...');

    // PropertyListed event
    contract.on('PropertyListed', async (propertyId, seller, price, event) => {
      try {
        this.logger.log(` PropertyListed EVENT RECEIVED: propertyId=${propertyId}, seller=${seller}, price=${price}`);
        this.logger.log(` Event block: ${event?.blockNumber}, tx: ${event?.transactionHash}`);
        await this.handlePropertyListed(
          propertyId.toString(),
          seller,
          price.toString(),
        );
        this.logger.log(` Successfully processed PropertyListed event for property ${propertyId}`);
      } catch (error) {
        this.logger.error(` Error handling PropertyListed event: ${error.message}`, error.stack);
      }
    });
    
    this.logger.log(' Marketplace PropertyListed event listener registered');

    // PropertySold event
    contract.on('PropertySold', async (propertyId, seller, buyer, price, event) => {
      try {
        this.logger.log(`PropertySold: propertyId=${propertyId}, seller=${seller}, buyer=${buyer}`);
        await this.handlePropertySold(
          propertyId.toString(),
          seller,
          buyer,
          price.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling PropertySold event', error);
      }
    });

    // AuctionCreated event
    contract.on('AuctionCreated', async (propertyId, seller, startingPrice, endTime, event) => {
      try {
        this.logger.log(`AuctionCreated: propertyId=${propertyId}, seller=${seller}`);
        await this.handleAuctionCreated(
          propertyId.toString(),
          seller,
          startingPrice.toString(),
          endTime.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling AuctionCreated event', error);
      }
    });

    // AuctionEnded event
    contract.on('AuctionEnded', async (propertyId, winner, finalPrice, event) => {
      try {
        this.logger.log(`AuctionEnded: propertyId=${propertyId}, winner=${winner}`);
        await this.handleAuctionEnded(
          propertyId.toString(),
          winner,
          finalPrice.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling AuctionEnded event', error);
      }
    });

    // ListingCancelled event
    contract.on('ListingCancelled', async (propertyId, event) => {
      try {
        this.logger.log(`ListingCancelled: propertyId=${propertyId}`);
        await this.handleListingCancelled(propertyId.toString());
      } catch (error) {
        this.logger.error('Error handling ListingCancelled event', error);
      }
    });

    this.logger.log('Marketplace event listeners started');
  }

  private listenToQuestSystemEvents() {
    const contract = this.contractsService.questSystem;
    if (!contract) return;

    // QuestCompleted event
    contract.on('QuestCompleted', async (player, questType, reward, event) => {
      try {
        this.logger.log(`QuestCompleted: player=${player}, questType=${questType}, reward=${reward}`);
        await this.handleQuestCompleted(
          player,
          questType.toString(),
          reward.toString(),
        );
      } catch (error) {
        this.logger.error('Error handling QuestCompleted event', error);
      }
    });

    this.logger.log('QuestSystem event listeners started');
  }

  // Event handlers
  private async handlePropertyCreated(
    tokenId: string,
    owner: string,
    propertyType: number,
    value: string,
    blockNumber: number,
  ) {
    try {
      // Get or create user
      let [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, owner.toLowerCase()))
        .limit(1);

      if (!user) {
        [user] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: owner.toLowerCase(),
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      // Get property data from contract (includes createdAt timestamp)
      const propertyData = await this.contractsService.getProperty(BigInt(tokenId));
      
      // Use contract's createdAt timestamp (source of truth)
      // Contract stores createdAt as Unix timestamp in seconds
      const contractCreatedAtTimestamp = Number(propertyData.createdAt);
      const contractCreatedAt = new Date(contractCreatedAtTimestamp * 1000); // Convert to milliseconds
      
      // Create property in database with contract's createdAt
      const propertyTypeMap = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
      const [property] = await this.db
        .insert(schema.properties)
        .values({
          tokenId: Number(tokenId),
          ownerId: user.id,
          propertyType: propertyTypeMap[propertyType] || 'Residential',
          value: value.toString(), // Use string for numeric column
          yieldRate: Number(propertyData.yieldRate.toString()),
          isActive: true,
          createdAt: contractCreatedAt, // Use contract's createdAt (source of truth)
          updatedAt: new Date(),
        })
        .returning();

      // Emit WebSocket event
      this.websocketGateway.emitPropertyCreated({
        propertyId: property.id,
        owner: owner,
        propertyType: property.propertyType,
      });

      // Update leaderboard
      await this.leaderboardService.updateLeaderboard(user.id);

      // Update guild stats if user is in a guild
      const userGuild = await this.guildsService.getUserGuild(user.id);
      if (userGuild) {
        await this.guildsService.updateGuildStats(userGuild.id);
      }

      this.logger.log(`Property created in database: ${property.id}`);
    } catch (error) {
      this.logger.error(`Error handling PropertyCreated: ${error.message}`, error.stack);
    }
  }

  private async handlePropertyLinkedToRWA(
    tokenId: string,
    rwaContract: string,
    rwaTokenId: string,
  ) {
    try {
      await this.db
        .update(schema.properties)
        .set({
          rwaContract: rwaContract,
          rwaTokenId: Number(rwaTokenId),
          updatedAt: new Date(),
        })
        .where(eq(schema.properties.tokenId, Number(tokenId)));

      this.logger.log(`Property ${tokenId} linked to RWA`);
    } catch (error) {
      this.logger.error(`Error handling PropertyLinkedToRWA: ${error.message}`);
    }
  }

  private async handlePropertyUpgraded(
    tokenId: string,
    newType: number,
    newValue: string,
  ) {
    try {
      const propertyTypeMap = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
      await this.db
        .update(schema.properties)
        .set({
          propertyType: propertyTypeMap[newType] || 'Residential',
          value: newValue.toString(), // Use string for numeric column
          updatedAt: new Date(),
        })
        .where(eq(schema.properties.tokenId, Number(tokenId)));

      this.logger.log(`Property ${tokenId} upgraded`);
    } catch (error) {
      this.logger.error(`Error handling PropertyUpgraded: ${error.message}`);
    }
  }

  private isContractAddress(address: string): boolean {
    const normalized = address.toLowerCase();
    const contractAddresses: string[] = [];
    
    // Get all contract addresses
    if (this.contractsService.marketplace?.address) {
      contractAddresses.push(this.contractsService.marketplace.address.toLowerCase());
    }
    if (this.contractsService.yieldDistributor?.address) {
      contractAddresses.push(this.contractsService.yieldDistributor.address.toLowerCase());
    }
    if (this.contractsService.questSystem?.address) {
      contractAddresses.push(this.contractsService.questSystem.address.toLowerCase());
    }
    if (this.contractsService.propertyNFT?.address) {
      contractAddresses.push(this.contractsService.propertyNFT.address.toLowerCase());
    }
    if (this.contractsService.gameToken?.address) {
      contractAddresses.push(this.contractsService.gameToken.address.toLowerCase());
    }
    
    // Check old marketplace
    const oldMarketplace = process.env.OLD_MARKETPLACE_ADDRESS;
    if (oldMarketplace) {
      contractAddresses.push(oldMarketplace.toLowerCase());
    }
    
    return contractAddresses.includes(normalized);
  }

  private async handlePropertyTransfer(
    tokenId: string,
    from: string,
    to: string,
  ) {
    try {
      // Skip minting transfers (from zero address)
      if (from === '0x0000000000000000000000000000000000000000') {
        return;
      }

      // Skip if transferring to a contract address (e.g., marketplace)
      if (this.isContractAddress(to)) {
        this.logger.log(`Skipping transfer to contract address: ${to}`);
        return;
      }

      // Get or create new owner
      let [newOwner] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, to.toLowerCase()))
        .limit(1);

      if (!newOwner) {
        [newOwner] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: to.toLowerCase(),
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      // Get old owner from property
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(tokenId)))
        .limit(1);

      const oldOwnerId = property?.ownerId;

      // Update property owner
      await this.db
        .update(schema.properties)
        .set({
          ownerId: newOwner.id,
          updatedAt: new Date(),
        })
        .where(eq(schema.properties.tokenId, Number(tokenId)));

      // Update leaderboards for both old and new owners
      if (oldOwnerId) {
        await this.leaderboardService.updateLeaderboard(oldOwnerId);
        const oldOwnerGuild = await this.guildsService.getUserGuild(oldOwnerId);
        if (oldOwnerGuild) {
          await this.guildsService.updateGuildStats(oldOwnerGuild.id);
        }
      }

      await this.leaderboardService.updateLeaderboard(newOwner.id);
      const newOwnerGuild = await this.guildsService.getUserGuild(newOwner.id);
      if (newOwnerGuild) {
        await this.guildsService.updateGuildStats(newOwnerGuild.id);
      }

      this.logger.log(`Property ${tokenId} transferred to ${to}`);
    } catch (error) {
      this.logger.error(`Error handling PropertyTransfer: ${error.message}`);
    }
  }

  private async handleYieldDistributed(
    propertyId: string,
    amount: string,
  ) {
    try {
      // Update pending yield in database (if needed)
      // Yield is calculated on-chain, so we mainly log this
      this.logger.log(`Yield distributed for property ${propertyId}: ${amount}`);
    } catch (error) {
      this.logger.error(`Error handling YieldDistributed: ${error.message}`);
    }
  }

  private async handleYieldClaimed(
    propertyId: string,
    owner: string,
    amount: string,
  ) {
    try {
      // Get property and user
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      if (!property) {
        this.logger.warn(`Property ${propertyId} not found in database`);
        return;
      }

      // Create yield record
      await this.db.insert(schema.yieldRecords).values({
        ownerId: property.ownerId,
        propertyId: property.id,
        amount: BigInt(amount),
        claimed: true,
        claimedAt: new Date(),
        createdAt: new Date(),
      });

      // Update property total yield earned
      const currentTotal = BigInt(property.totalYieldEarned?.toString() || '0');
      const newTotal = currentTotal + BigInt(amount);
      await this.db
        .update(schema.properties)
        .set({
          totalYieldEarned: newTotal,
          updatedAt: new Date(),
        })
        .where(eq(schema.properties.id, property.id));

      // Update leaderboard after yield claim
      const [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, owner.toLowerCase()))
        .limit(1);

      if (user) {
        await this.leaderboardService.updateLeaderboard(user.id);

        // Update guild stats if user is in a guild
        const userGuild = await this.guildsService.getUserGuild(user.id);
        if (userGuild) {
          await this.guildsService.updateGuildStats(userGuild.id);
        }
      }

      // Emit WebSocket event
      this.websocketGateway.emitYieldClaimed({
        propertyId: property.id,
        owner: owner,
        amount: amount,
      });

      // Emit yield time update after claim (lastYieldUpdate was reset in contract)
      // This ensures frontend shows correct time remaining for next claim
      const yieldTimeInfo = await this.yieldService.getYieldTimeInfo(owner);
      if (yieldTimeInfo && 
          yieldTimeInfo.properties.length > 0 &&
          yieldTimeInfo.yieldUpdateIntervalSeconds !== undefined &&
          yieldTimeInfo.currentBlockTimestamp !== undefined &&
          yieldTimeInfo.totalClaimableYield !== undefined) {
        this.websocketGateway.emitYieldTimeUpdate(yieldTimeInfo);
        this.logger.log(`Sent yield time update after claim for ${owner}`);
      }

      this.logger.log(`Yield claimed for property ${propertyId}: ${amount}`);
    } catch (error) {
      this.logger.error(`Error handling YieldClaimed: ${error.message}`);
    }
  }

  private async handlePropertyListed(
    propertyId: string,
    seller: string,
    price: string,
  ) {
    try {
      let [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      // If property doesn't exist in DB, sync it from blockchain first
      if (!property) {
        this.logger.log(`Property ${propertyId} not in DB, syncing from blockchain...`);
        try {
          await this.propertiesService.syncFromChain(seller);
          // Try again after sync
          [property] = await this.db
            .select()
            .from(schema.properties)
            .where(eq(schema.properties.tokenId, Number(propertyId)))
            .limit(1);
          
          if (!property) {
            this.logger.warn(`Property ${propertyId} still not found after sync`);
            return;
          }
        } catch (syncError) {
          this.logger.error(`Failed to sync property ${propertyId} before listing: ${syncError.message}`);
          return;
        }
      }

      // Create or update marketplace listing
      const existing = await this.db
        .select()
        .from(schema.marketplaceListings)
        .where(eq(schema.marketplaceListings.propertyId, property.id))
        .limit(1);

      if (existing.length === 0) {
        await this.db.insert(schema.marketplaceListings).values({
          propertyId: property.id,
          sellerId: property.ownerId,
          price: price.toString(), // Ensure string for numeric column
          isActive: true,
          listingType: 'fixed', // Match frontend format
          createdAt: new Date(),
          updatedAt: new Date(),
        });
      } else {
        await this.db
          .update(schema.marketplaceListings)
          .set({
            price: price.toString(), // Ensure string for numeric column
            isActive: true,
            updatedAt: new Date(),
          })
          .where(eq(schema.marketplaceListings.propertyId, property.id));
      }

      this.logger.log(`Property ${propertyId} listed for ${price}`);
      
      // Update seller's leaderboard (property is no longer in their portfolio)
      if (property.ownerId) {
        await this.leaderboardService.updateLeaderboard(property.ownerId);
        const sellerGuild = await this.guildsService.getUserGuild(property.ownerId);
        if (sellerGuild) {
          await this.guildsService.updateGuildStats(sellerGuild.id);
        }
        this.logger.log(`Updated leaderboard for seller ${seller} after listing property ${propertyId}`);
        
        // Emit leaderboard update via WebSocket
        const updatedLeaderboard = await this.leaderboardService.getGlobalLeaderboard(100);
        this.websocketGateway.emitLeaderboardUpdate({ rankings: updatedLeaderboard });
      }
      
      // Emit WebSocket event for real-time updates
      this.websocketGateway.emitMarketplaceListing({
        propertyId: Number(propertyId),
        seller: seller,
        price: price,
      });
    } catch (error) {
      this.logger.error(`Error handling PropertyListed: ${error.message}`);
    }
  }

  private async handlePropertySold(
    propertyId: string,
    seller: string,
    buyer: string,
    price: string,
  ) {
    try {
      // Update listing to inactive
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      if (property) {
        await this.db
          .update(schema.marketplaceListings)
          .set({
            isActive: false,
            updatedAt: new Date(),
          })
          .where(eq(schema.marketplaceListings.propertyId, property.id));

        // Update property ownership to buyer
        // Get or create buyer user
        let [buyerUser] = await this.db
          .select()
          .from(schema.users)
          .where(eq(schema.users.walletAddress, buyer.toLowerCase()))
          .limit(1);

        if (!buyerUser) {
          [buyerUser] = await this.db
            .insert(schema.users)
            .values({
              walletAddress: buyer.toLowerCase(),
              createdAt: new Date(),
              updatedAt: new Date(),
            })
            .returning();
        }

        // Update property owner
        await this.db
          .update(schema.properties)
          .set({
            ownerId: buyerUser.id,
            updatedAt: new Date(),
          })
          .where(eq(schema.properties.tokenId, Number(propertyId)));

        // Update leaderboards for both seller and buyer
        const oldOwnerId = property.ownerId;
        if (oldOwnerId) {
          await this.leaderboardService.updateLeaderboard(oldOwnerId);
          const sellerGuild = await this.guildsService.getUserGuild(oldOwnerId);
          if (sellerGuild) {
            await this.guildsService.updateGuildStats(sellerGuild.id);
          }
        }

        await this.leaderboardService.updateLeaderboard(buyerUser.id);
        const buyerGuild = await this.guildsService.getUserGuild(buyerUser.id);
        if (buyerGuild) {
          await this.guildsService.updateGuildStats(buyerGuild.id);
        }

        this.logger.log(`Property ${propertyId} ownership updated: ${seller} -> ${buyer}`);
        
        // Emit leaderboard update via WebSocket
        const updatedLeaderboard = await this.leaderboardService.getGlobalLeaderboard(100);
        this.websocketGateway.emitLeaderboardUpdate({ rankings: updatedLeaderboard });
      }

      // Emit WebSocket event
      this.websocketGateway.emitMarketplaceTrade({
        listingId: Number(propertyId),
        seller: seller,
        buyer: buyer,
        price: price,
      });

      this.logger.log(`Property ${propertyId} sold for ${price}`);
    } catch (error) {
      this.logger.error(`Error handling PropertySold: ${error.message}`);
    }
  }

  private async handleAuctionCreated(
    propertyId: string,
    seller: string,
    startingPrice: string,
    endTime: string,
  ) {
    try {
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      if (!property) return;

      const existing = await this.db
        .select()
        .from(schema.marketplaceListings)
        .where(eq(schema.marketplaceListings.propertyId, property.id))
        .limit(1);

      if (existing.length === 0) {
        await this.db.insert(schema.marketplaceListings).values({
          propertyId: property.id,
          sellerId: property.ownerId,
          price: startingPrice.toString(), // Ensure string for numeric column
          isActive: true,
          listingType: 'auction',
          auctionEndTime: new Date(Number(endTime) * 1000),
          createdAt: new Date(),
          updatedAt: new Date(),
        });
      } else {
        await this.db
          .update(schema.marketplaceListings)
          .set({
            price: startingPrice.toString(), // Ensure string for numeric column
            listingType: 'auction',
            auctionEndTime: new Date(Number(endTime) * 1000),
            isActive: true,
            updatedAt: new Date(),
          })
          .where(eq(schema.marketplaceListings.propertyId, property.id));
      }

      this.logger.log(`Auction created for property ${propertyId}`);
    } catch (error) {
      this.logger.error(`Error handling AuctionCreated: ${error.message}`);
    }
  }

  private async handleAuctionEnded(
    propertyId: string,
    winner: string,
    finalPrice: string,
  ) {
    try {
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      if (property) {
        await this.db
          .update(schema.marketplaceListings)
          .set({
            isActive: false,
            updatedAt: new Date(),
          })
          .where(eq(schema.marketplaceListings.propertyId, property.id));
      }

      this.logger.log(`Auction ended for property ${propertyId}, winner: ${winner}`);
    } catch (error) {
      this.logger.error(`Error handling AuctionEnded: ${error.message}`);
    }
  }

  private async handleListingCancelled(propertyId: string) {
    try {
      const [property] = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.tokenId, Number(propertyId)))
        .limit(1);

      if (property) {
        await this.db
          .update(schema.marketplaceListings)
          .set({
            isActive: false,
            updatedAt: new Date(),
          })
          .where(eq(schema.marketplaceListings.propertyId, property.id));

        this.logger.log(`Listing cancelled for property ${propertyId}`);
        
        // Emit WebSocket event
        const [seller] = await this.db
          .select()
          .from(schema.users)
          .where(eq(schema.users.id, property.ownerId))
          .limit(1);
        
        if (seller) {
          this.websocketGateway.emitMarketplaceCancelled({
            propertyId: property.tokenId,
            seller: seller.walletAddress,
          });
        }
      } else {
        this.logger.log(`Listing cancelled for property ${propertyId} (property not found in DB)`);
      }
    } catch (error) {
      this.logger.error(`Error handling ListingCancelled: ${error.message}`);
    }
  }

  private async handleQuestCompleted(
    player: string,
    questType: string,
    reward: string,
  ) {
    try {
      this.logger.log(`Quest completed: player=${player}, type=${questType}, reward=${reward}`);
      
      // Get or create user
      let [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, player.toLowerCase()))
        .limit(1);

      if (!user) {
        [user] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: player.toLowerCase(),
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      // Get quest by questId (questType is the enum value 0-4)
      const questTypeNum = Number(questType);
      const [quest] = await this.db
        .select()
        .from(schema.quests)
        .where(eq(schema.quests.questId, questTypeNum))
        .limit(1);

      if (!quest) {
        this.logger.warn(`Quest ${questTypeNum} not found in database`);
        return;
      }

      // Update or create quest progress
      const [existingProgress] = await this.db
        .select()
        .from(schema.questProgress)
        .where(
          and(
            eq(schema.questProgress.userId, user.id),
            eq(schema.questProgress.questId, quest.id)
          )
        )
        .limit(1);

      if (existingProgress) {
        // Update existing progress
        await this.db
          .update(schema.questProgress)
          .set({
            completed: true,
            rewardClaimed: true, // Quest completion means reward was minted
            completedAt: new Date(),
            updatedAt: new Date(),
          })
          .where(eq(schema.questProgress.id, existingProgress.id));
      } else {
        // Create new progress entry
        await this.db.insert(schema.questProgress).values({
          questId: quest.id,
          userId: user.id,
          completed: true,
          progress: 100,
          rewardClaimed: true,
          completedAt: new Date(),
          createdAt: new Date(),
          updatedAt: new Date(),
        });
      }

      // Update leaderboard
      await this.leaderboardService.updateLeaderboard(user.id);

      this.logger.log(`Quest progress updated for user ${player}, quest ${questTypeNum}`);
    } catch (error) {
      this.logger.error(`Error handling QuestCompleted: ${error.message}`, error.stack);
    }
  }

  // Periodic sync to catch missed events
  private startPeriodicSync() {
    setInterval(async () => {
      if (this.isIndexing) return;
      
      try {
        this.isIndexing = true;
        await this.syncMissedEvents();
      } catch (error) {
        this.logger.error('Error in periodic sync', error);
      } finally {
        this.isIndexing = false;
      }
    }, 60000); // Sync every minute
  }

  private async syncMissedEvents() {
    try {
      // Use Mantle's custom eth_getBlockRange for efficient block querying
      const currentBlock = await this.contractsService.getProvider().getBlockNumber();
      const fromBlock = this.lastProcessedBlock + 1;
      const toBlock = currentBlock - this.BLOCK_CONFIRMATIONS;

      if (fromBlock > toBlock) {
        return; // No new blocks
      }

      const blockRange = toBlock - fromBlock + 1;
      this.logger.log(`Syncing events from block ${fromBlock} to ${toBlock} (${blockRange} blocks)`);

      // Only use Mantle API for small block ranges (to avoid 413 Request Entity Too Large errors)
      // Mantle API has a limit, so we skip it for large ranges and use standard event queries
      const MAX_MANTLE_API_BLOCK_RANGE = 100; // Safe limit to avoid 413 errors
      
      if (blockRange <= MAX_MANTLE_API_BLOCK_RANGE) {
        try {
          const blocks = await this.mantleApiService.getBlockRange(fromBlock, toBlock, false);
          this.logger.log(`Retrieved ${blocks.length} blocks using Mantle eth_getBlockRange`);
        } catch (error: any) {
          // If it's a 413 error, log it but continue with standard queries
          if (error.message?.includes('413')) {
            this.logger.warn(`Mantle API block range too large (${blockRange} blocks), using standard event queries`);
          } else {
            this.logger.warn('Mantle API block range query failed, falling back to standard queries', error);
          }
        }
      } else {
        this.logger.log(`Block range too large (${blockRange} blocks), skipping Mantle API and using standard event queries`);
      }

      // Query events from contracts (this is what actually matters)
      // These use standard eth_getLogs which handles large ranges better
      await this.queryPropertyNFTEvents(fromBlock, toBlock);
      await this.queryYieldDistributorEvents(fromBlock, toBlock);
      await this.queryMarketplaceEvents(fromBlock, toBlock);
      await this.queryQuestSystemEvents(fromBlock, toBlock);

      this.lastProcessedBlock = toBlock;
    } catch (error) {
      this.logger.error('Error syncing missed events', error);
    }
  }

  private async queryPropertyNFTEvents(fromBlock: number, toBlock: number) {
    const contract = this.contractsService.propertyNFT;
    if (!contract) return;

    try {
      const filter = contract.filters.PropertyCreated();
      const events = await contract.queryFilter(filter, fromBlock, toBlock);
      
      for (const event of events) {
        if (event.args) {
          await this.handlePropertyCreated(
            event.args.tokenId.toString(),
            event.args.owner,
            event.args.propertyType,
            event.args.value.toString(),
            event.blockNumber,
          );
        }
      }
    } catch (error) {
      this.logger.error('Error querying PropertyNFT events', error);
    }
  }

  private async queryYieldDistributorEvents(fromBlock: number, toBlock: number) {
    const contract = this.contractsService.yieldDistributor;
    if (!contract) return;

    try {
      const filter = contract.filters.YieldClaimed();
      const events = await contract.queryFilter(filter, fromBlock, toBlock);
      
      for (const event of events) {
        if (event.args) {
          await this.handleYieldClaimed(
            event.args.propertyId.toString(),
            event.args.owner,
            event.args.amount.toString(),
          );
        }
      }
    } catch (error) {
      this.logger.error('Error querying YieldDistributor events', error);
    }
  }

  private async queryMarketplaceEvents(fromBlock: number, toBlock: number) {
    const contract = this.contractsService.marketplace;
    if (!contract) return;

    try {
      const soldFilter = contract.filters.PropertySold();
      const soldEvents = await contract.queryFilter(soldFilter, fromBlock, toBlock);
      
      for (const event of soldEvents) {
        if (event.args) {
          await this.handlePropertySold(
            event.args.propertyId.toString(),
            event.args.seller,
            event.args.buyer,
            event.args.price.toString(),
          );
        }
      }
    } catch (error) {
      this.logger.error('Error querying Marketplace events', error);
    }
  }

  private async queryQuestSystemEvents(fromBlock: number, toBlock: number) {
    const contract = this.contractsService.questSystem;
    if (!contract) return;

    try {
      const filter = contract.filters.QuestCompleted();
      const events = await contract.queryFilter(filter, fromBlock, toBlock);
      
      for (const event of events) {
        if (event.args) {
          await this.handleQuestCompleted(
            event.args.player,
            event.args.questType.toString(),
            event.args.reward.toString(),
          );
        }
      }
    } catch (error) {
      this.logger.error('Error querying QuestSystem events', error);
    }
  }
}
</file>

<file path="backend/src/properties/properties.service.ts">
import { Injectable, Logger, Inject } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, and, sql } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';

@Injectable()
export class PropertiesService {
  private readonly logger = new Logger(PropertiesService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
  ) {}

  async findAll() {
    return this.db
      .select({
        id: schema.properties.id,
        tokenId: schema.properties.tokenId,
        ownerId: schema.properties.ownerId,
        propertyType: schema.properties.propertyType,
        value: schema.properties.value,
        yieldRate: schema.properties.yieldRate,
        rwaContract: schema.properties.rwaContract,
        rwaTokenId: schema.properties.rwaTokenId,
        totalYieldEarned: schema.properties.totalYieldEarned,
        x: schema.properties.x,
        y: schema.properties.y,
        isActive: schema.properties.isActive,
        createdAt: schema.properties.createdAt,
        updatedAt: schema.properties.updatedAt,
        owner: {
          id: schema.users.id,
          walletAddress: schema.users.walletAddress,
          username: schema.users.username,
        },
      })
      .from(schema.properties)
      .leftJoin(schema.users, eq(schema.properties.ownerId, schema.users.id));
  }

  async findById(id: string) {
    const [property] = await this.db
      .select()
      .from(schema.properties)
      .where(eq(schema.properties.id, id))
      .limit(1);
    
    if (!property) return null;
    
    // Convert BigInt values to strings/numbers for JSON serialization
    return {
      ...property,
      value: property.value?.toString() || property.value,
      totalYieldEarned: property.totalYieldEarned?.toString() || property.totalYieldEarned,
      rwaTokenId: property.rwaTokenId !== null && property.rwaTokenId !== undefined 
        ? (typeof property.rwaTokenId === 'bigint' ? Number(property.rwaTokenId) : property.rwaTokenId)
        : undefined,
      tokenId: property.tokenId !== null && property.tokenId !== undefined
        ? (typeof property.tokenId === 'bigint' ? Number(property.tokenId) : property.tokenId)
        : property.tokenId,
    };
  }

  async findByOwner(ownerId: string) {
    const properties = await this.db
      .select({
        id: schema.properties.id,
        tokenId: schema.properties.tokenId,
        ownerId: schema.properties.ownerId,
        propertyType: schema.properties.propertyType,
        value: schema.properties.value,
        yieldRate: schema.properties.yieldRate,
        rwaContract: schema.properties.rwaContract,
        rwaTokenId: schema.properties.rwaTokenId,
        totalYieldEarned: schema.properties.totalYieldEarned,
        x: schema.properties.x,
        y: schema.properties.y,
        isActive: schema.properties.isActive,
        createdAt: schema.properties.createdAt,
        updatedAt: schema.properties.updatedAt,
      })
      .from(schema.properties)
      .where(eq(schema.properties.ownerId, ownerId));
    
    // Convert BigInt values to strings/numbers for JSON serialization
    return properties.map(prop => ({
      ...prop,
      value: prop.value?.toString() || prop.value,
      totalYieldEarned: prop.totalYieldEarned?.toString() || prop.totalYieldEarned,
      rwaTokenId: prop.rwaTokenId !== null && prop.rwaTokenId !== undefined 
        ? (typeof prop.rwaTokenId === 'bigint' ? Number(prop.rwaTokenId) : prop.rwaTokenId)
        : undefined,
      tokenId: prop.tokenId !== null && prop.tokenId !== undefined
        ? (typeof prop.tokenId === 'bigint' ? Number(prop.tokenId) : prop.tokenId)
        : prop.tokenId,
    }));
  }

  async findByWalletAddress(walletAddress: string) {
    const normalizedAddress = walletAddress.toLowerCase();
    
    this.logger.log(`Finding properties for wallet: ${normalizedAddress}`);
    
    // First try to find user in database
    let [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, normalizedAddress))
      .limit(1);

    // NOTE: Frontend loads properties directly from blockchain
    // This endpoint is only for optional features (coordinates, etc.)
    // If property syncing is disabled, skip sync and return database properties only
    if (process.env.ENABLE_PROPERTY_SYNC === 'false') {
      if (!user) {
        this.logger.log(`Property syncing disabled - returning empty array for ${normalizedAddress}`);
        return [];
      }
      const properties = await this.findByOwner(user.id);
      this.logger.log(`Property syncing disabled - returning ${properties.length} properties from database for ${normalizedAddress}`);
      return properties;
    }

    // If user doesn't exist, try to sync from chain first
    if (!user) {
      this.logger.log(`User not found for ${normalizedAddress}, attempting to sync from chain...`);
      try {
        const syncedProperties = await this.syncFromChain(walletAddress);
        if (syncedProperties && syncedProperties.length > 0) {
          this.logger.log(`Successfully synced ${syncedProperties.length} properties for ${normalizedAddress}`);
          return syncedProperties;
        }
        // Try again after sync to get user
        [user] = await this.db
          .select()
          .from(schema.users)
          .where(eq(schema.users.walletAddress, normalizedAddress))
          .limit(1);
      } catch (error) {
        this.logger.error(`Failed to sync user ${normalizedAddress} from chain: ${error.message}`, error.stack);
        // Don't return empty, try to continue
      }
    }

    if (!user) {
      this.logger.warn(`User ${normalizedAddress} not found in database after sync attempt`);
      return [];
    }

    let properties = await this.findByOwner(user.id);
    this.logger.log(`Found ${properties.length} properties in database for ${normalizedAddress}`);
    
    // If no properties found but user exists, try syncing from chain
    if (properties.length === 0) {
      this.logger.log(`No properties found in database for ${normalizedAddress}, attempting to sync from chain...`);
      try {
        const syncedProperties = await this.syncFromChain(walletAddress);
        if (syncedProperties && syncedProperties.length > 0) {
          this.logger.log(`Successfully synced ${syncedProperties.length} properties for ${normalizedAddress}`);
          return syncedProperties;
        }
        // Try fetching again after sync
        properties = await this.findByOwner(user.id);
      } catch (error) {
        this.logger.error(`Failed to sync properties for ${normalizedAddress}: ${error.message}`, error.stack);
        // Return empty array on error
        return [];
      }
    }

    // Filter out listed properties by checking ownerOf on blockchain (source of truth)
    // Listed properties are owned by the marketplace contract
    if (this.contractsService.propertyNFT && properties.length > 0) {
      const marketplaceAddress = this.contractsService.marketplace?.address?.toLowerCase();
      const contractAddresses = [
        marketplaceAddress,
        this.contractsService.yieldDistributor?.address?.toLowerCase(),
        this.contractsService.questSystem?.address?.toLowerCase(),
        this.contractsService.propertyNFT?.address?.toLowerCase(),
        '0x6389d7168029715de118baf51b6d32ee1ebea46b', // Old marketplace
      ].filter(Boolean) as string[];

      this.logger.log(` Filtering ${properties.length} properties to exclude listed ones...`);
      const ownedProperties: typeof properties = [];
      
      for (const prop of properties) {
        try {
          const currentOwner = await this.contractsService.propertyNFT.ownerOf(prop.tokenId);
          const ownerLower = currentOwner.toLowerCase();
          const isOwnedByUser = ownerLower === normalizedAddress;
          const isContract = contractAddresses.includes(ownerLower);
          
          if (isOwnedByUser && !isContract) {
            ownedProperties.push(prop);
            this.logger.debug(` Property ${prop.tokenId} is owned by user`);
          } else {
            this.logger.log(` Property ${prop.tokenId} excluded: owned by ${currentOwner} (${isContract ? 'contract' : 'different user'})`);
          }
        } catch (error) {
          this.logger.warn(`Failed to check ownerOf for property ${prop.tokenId}: ${error.message}`);
          // If ownerOf fails, property doesn't exist in NEW contract (it's from old contract)
          // Exclude it - don't show old properties
          this.logger.log(` Property ${prop.tokenId} excluded: doesn't exist in new contract (from old contract)`);
        }
      }
      
      this.logger.log(` Filtered to ${ownedProperties.length} properties actually owned by user (excluded ${properties.length - ownedProperties.length} listed/transferred)`);
      properties = ownedProperties;
    }

    // Convert BigInt values to strings/numbers for JSON serialization
    return properties.map(prop => ({
      ...prop,
      value: prop.value?.toString() || prop.value,
      totalYieldEarned: prop.totalYieldEarned?.toString() || prop.totalYieldEarned,
      rwaTokenId: prop.rwaTokenId !== null && prop.rwaTokenId !== undefined 
        ? (typeof prop.rwaTokenId === 'bigint' ? Number(prop.rwaTokenId) : prop.rwaTokenId)
        : undefined,
      tokenId: prop.tokenId !== null && prop.tokenId !== undefined
        ? (typeof prop.tokenId === 'bigint' ? Number(prop.tokenId) : prop.tokenId)
        : prop.tokenId,
    }));
  }

  async create(propertyData: {
    tokenId: number;
    ownerId: string;
    propertyType: string;
    value: string; // Changed to string for numeric column
    yieldRate: number;
    rwaContract?: string;
    rwaTokenId?: number;
  }) {
    const [property] = await this.db
      .insert(schema.properties)
      .values({
        ...propertyData,
        createdAt: new Date(),
        updatedAt: new Date(),
      })
      .returning();
    return property;
  }

  async syncFromChain(walletAddress: string) {
    // Skip syncing if disabled
    if (process.env.ENABLE_PROPERTY_SYNC === 'false') {
      this.logger.log(`Property syncing disabled - skipping sync for ${walletAddress}`);
      return [];
    }
    try {
      const normalizedAddress = walletAddress.toLowerCase();
      
      // Check if contract is initialized
      if (!this.contractsService.propertyNFT) {
        this.logger.error('PropertyNFT contract not initialized');
        throw new Error('Contract not initialized. Please check backend configuration.');
      }

      this.logger.log(`Fetching properties from chain for ${normalizedAddress}...`);
      let properties: bigint[] = [];
      try {
        const result = await this.contractsService.getOwnerProperties(walletAddress);
        // Handle different return types
        if (Array.isArray(result)) {
          properties = result;
        } else if (result && typeof result === 'object' && 'length' in result) {
          // Convert array-like object to array
          properties = Array.from(result as any);
        } else {
          this.logger.warn(`getOwnerProperties returned unexpected type: ${typeof result}`);
          properties = [];
        }
        this.logger.log(`Found ${properties.length} properties on-chain for ${normalizedAddress}`);
      } catch (error: any) {
        // If getOwnerProperties fails, user has no properties in new contract
        // Return empty array instead of throwing error
        this.logger.warn(`No properties found in new contract for ${normalizedAddress}: ${error.message}`);
        this.logger.log(`Returning empty array - user may not have properties yet in new contract`);
        return [];
      }
      
      // Get or create user
      let [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, normalizedAddress))
        .limit(1);

      if (!user) {
        this.logger.log(`Creating user for ${normalizedAddress}`);
        [user] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: normalizedAddress,
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      if (properties.length === 0) {
        this.logger.log(`No properties found on-chain for ${normalizedAddress}`);
        return [];
      }

      let syncedCount = 0;
      let errorCount = 0;
      
      for (const tokenId of properties) {
        try {
          const tokenIdNum = typeof tokenId === 'bigint' ? Number(tokenId) : Number(tokenId);
          this.logger.log(`Syncing property ${tokenIdNum}...`);
          
          const propertyData = await this.contractsService.getProperty(BigInt(tokenIdNum));
          
          // Get contract's createdAt timestamp (source of truth for yield calculation)
          const contractCreatedAtTimestamp = Number(propertyData.createdAt);
          const contractCreatedAt = new Date(contractCreatedAtTimestamp * 1000); // Convert seconds to milliseconds
          
          const propertyTypeNum = typeof propertyData.propertyType === 'bigint' 
            ? Number(propertyData.propertyType) 
            : Number(propertyData.propertyType);
          
          // Convert yieldRate to basis points
          let yieldRateValue = Number(propertyData.yieldRate.toString());
          
          // Detect corrupted yieldRate (stored in wei instead of basis points)
          // Normal yieldRate should be 100-1000 (1%-10%), corrupted would be > 1e15
          if (yieldRateValue > 1e15) {
            this.logger.warn(`Property ${tokenId}: Detected corrupted yieldRate ${yieldRateValue}. Attempting to fix...`);
            // Try to convert from wei to basis points
            // If it's around 5e16, it might be 500 * 1e14 (corrupted)
            // Or if it's around 5e16, it might be 500 * 1e14 (corrupted)
            const possibleBasisPoints = yieldRateValue / 1e14; // Try dividing by 1e14
            if (possibleBasisPoints >= 100 && possibleBasisPoints <= 10000) {
              yieldRateValue = Math.round(possibleBasisPoints);
              this.logger.log(`Property ${tokenId}: Fixed yieldRate from ${propertyData.yieldRate.toString()} to ${yieldRateValue} basis points`);
            } else {
              // Fallback: assume it should be 500 (5% - most common)
              yieldRateValue = 500;
              this.logger.warn(`Property ${tokenId}: Could not auto-fix yieldRate, defaulting to 500 basis points`);
            }
          }
          
          // Ensure yieldRate is in valid range (100-10000 basis points = 1%-100%)
          if (yieldRateValue < 100 || yieldRateValue > 10000) {
            this.logger.warn(`Property ${tokenId}: yieldRate ${yieldRateValue} out of valid range (100-10000), defaulting to 500`);
            yieldRateValue = 500;
          }
          
          // Handle legacy format (0-1 range instead of basis points)
          if (yieldRateValue < 100 && yieldRateValue > 0) {
            yieldRateValue = yieldRateValue * 100;
          }

          // Convert value to string for numeric column (handles very large numbers)
          // The schema uses numeric which expects a string representation
          let valueStr: string;
          if (typeof propertyData.value === 'bigint') {
            valueStr = propertyData.value.toString();
          } else if (typeof propertyData.value === 'string') {
            valueStr = propertyData.value;
          } else {
            valueStr = propertyData.value.toString();
          }
          
          // Handle rwaTokenId - set to undefined if not valid (will be NULL in database)
          let rwaTokenIdValue: number | undefined;
          if (propertyData.rwaTokenId) {
            const rwaTokenIdNum = Number(propertyData.rwaTokenId.toString());
            if (rwaTokenIdNum && rwaTokenIdNum > 0) {
              rwaTokenIdValue = rwaTokenIdNum;
            } else {
              rwaTokenIdValue = undefined;
            }
          } else {
            rwaTokenIdValue = undefined;
          }
          
          // Handle rwaContract - check for valid address, set to undefined if invalid
          let rwaContractValue: string | undefined;
          if (propertyData.rwaContract && 
              propertyData.rwaContract !== '0x0000000000000000000000000000000000000000' &&
              propertyData.rwaContract.trim() !== '' &&
              propertyData.rwaContract.length === 42) {
            rwaContractValue = propertyData.rwaContract;
          } else {
            rwaContractValue = undefined; // Will be NULL in database
          }
          
          const propertyTypeStr = this.mapPropertyType(propertyTypeNum);
          
          // Use Drizzle ORM for proper type handling
          try {
            // Check if property exists
            const [existing] = await this.db
              .select()
              .from(schema.properties)
              .where(eq(schema.properties.tokenId, tokenIdNum))
              .limit(1);

            // Build property data object - only include optional fields if they have values
            // Use string for numeric column to handle very large values
            const propertyDataObj: any = {
              ownerId: user.id,
              propertyType: propertyTypeStr,
              value: valueStr, // Use string for numeric column (handles values > BIGINT max)
              yieldRate: yieldRateValue,
              updatedAt: new Date(),
            };

            // Only include rwaContract if it has a valid value
            // If omitted, Drizzle will use NULL for optional fields
            if (rwaContractValue && rwaContractValue !== '0x0000000000000000000000000000000000000000' && rwaContractValue !== '') {
              propertyDataObj.rwaContract = rwaContractValue;
            }
            // Don't include if null/undefined - Drizzle will use NULL

            // Only include rwaTokenId if it has a valid value
            if (rwaTokenIdValue !== null && rwaTokenIdValue !== undefined && rwaTokenIdValue > 0) {
              propertyDataObj.rwaTokenId = rwaTokenIdValue;
            }
            // Don't include if null/undefined - Drizzle will use NULL

            if (existing) {
              // Update existing property (preserve createdAt if it's already correct, or update if it was wrong)
              // Only update createdAt if it's significantly different from contract (more than 1 hour difference)
              const existingCreatedAt = existing.createdAt ? new Date(existing.createdAt).getTime() : 0;
              const contractCreatedAtMs = contractCreatedAt.getTime();
              const timeDiff = Math.abs(existingCreatedAt - contractCreatedAtMs);
              
              // If createdAt differs by more than 1 hour, update it to match contract
              if (timeDiff > 3600000) { // 1 hour in milliseconds
                this.logger.log(`Updating createdAt for property ${tokenIdNum} to match contract (diff: ${Math.floor(timeDiff / 1000 / 60)} minutes)`);
                await this.db
                  .update(schema.properties)
                  .set({
                    ...propertyDataObj,
                    createdAt: contractCreatedAt, // Update to contract's createdAt
                  })
                  .where(eq(schema.properties.tokenId, tokenIdNum));
              } else {
                // Just update other fields, keep existing createdAt
                await this.db
                  .update(schema.properties)
                  .set(propertyDataObj)
                  .where(eq(schema.properties.tokenId, tokenIdNum));
              }
            } else {
              // Insert new property with contract's createdAt (source of truth)
              await this.db.insert(schema.properties).values({
                ...propertyDataObj,
                tokenId: tokenIdNum,
                createdAt: contractCreatedAt, // Use contract's createdAt, not current time
              });
              this.logger.log(`Inserted property ${tokenIdNum} with contract createdAt: ${contractCreatedAt.toISOString()}`);
            }
            
            this.logger.log(` Upserted property ${tokenIdNum} for ${normalizedAddress}`);
            syncedCount++;
          } catch (dbError: any) {
            errorCount++;
            const errorMsg = dbError.message || String(dbError);
            this.logger.error(`Database error syncing property ${tokenIdNum}: ${errorMsg}`);
            // Log the actual PostgreSQL error if available
            if (dbError.cause) {
              this.logger.error(`PostgreSQL error: ${JSON.stringify(dbError.cause)}`);
            }
            if (dbError.code) {
              this.logger.error(`Error code: ${dbError.code}`);
            }
            if (dbError.detail) {
              this.logger.error(`Error detail: ${dbError.detail}`);
            }
            if (dbError.stack) {
              this.logger.error(`Stack: ${dbError.stack.substring(0, 500)}`);
            }
          }
        } catch (error) {
          errorCount++;
          this.logger.error(`Error syncing property ${tokenId}: ${error.message}`, error.stack);
        }
      }

      this.logger.log(`Sync complete: ${syncedCount} new properties synced, ${errorCount} errors for ${normalizedAddress}`);
      const finalProperties = await this.findByOwner(user.id);
      this.logger.log(`Total properties in database for ${normalizedAddress}: ${finalProperties.length}`);
      // Convert BigInt values to strings for JSON serialization
      return finalProperties.map(prop => ({
        ...prop,
        value: prop.value?.toString() || prop.value,
        totalYieldEarned: prop.totalYieldEarned?.toString() || prop.totalYieldEarned,
      }));
    } catch (error) {
      this.logger.error(`Error syncing properties from chain: ${error.message}`, error.stack);
      throw error;
    }
  }

  async updateCoordinates(tokenId: number, x: number, y: number) {
    const [updated] = await this.db
      .update(schema.properties)
      .set({
        x,
        y,
        updatedAt: new Date(),
      })
      .where(eq(schema.properties.tokenId, tokenId))
      .returning();
    return updated;
  }

  private mapPropertyType(type: number): string {
    const types = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
    return types[type] || 'Residential';
  }

  /**
   * Sync ALL existing properties from blockchain to database
   * This is needed for properties created before the backend was running
   * Queries all PropertyCreated events from contract deployment
   */
  async syncAllExistingPropertiesFromChain() {
    // Skip syncing if disabled
    if (process.env.ENABLE_PROPERTY_SYNC === 'false') {
      this.logger.log('Property syncing disabled - skipping full sync');
      return { synced: 0, owners: 0 };
    }

    if (!this.contractsService.propertyNFT) {
      this.logger.error('PropertyNFT contract not initialized');
      throw new Error('Contract not initialized');
    }

    try {
      this.logger.log(' Starting full sync of all existing properties from blockchain...');

      // Get current block and contract deployment block
      const provider = this.contractsService.getProvider();
      const currentBlock = await provider.getBlockNumber();
      
      // Try to get contract deployment block, or start from a reasonable block
      // For Mantle Sepolia, we'll query in chunks of 10,000 blocks (RPC limit)
      const CHUNK_SIZE = 10000;
      const filter = this.contractsService.propertyNFT.filters.PropertyCreated();
      
      // Start from block 0 or contract deployment (if known)
      // For now, start from a recent block to avoid too many queries
      // You can adjust this based on when your contract was deployed
      const startBlock = Math.max(0, currentBlock - 50000); // Last 50k blocks
      const allEvents: any[] = [];
      
      this.logger.log(` Querying events from block ${startBlock} to ${currentBlock} in chunks of ${CHUNK_SIZE}...`);
      
      // Query in chunks to respect RPC limits
      for (let fromBlock = startBlock; fromBlock < currentBlock; fromBlock += CHUNK_SIZE) {
        const toBlock = Math.min(fromBlock + CHUNK_SIZE - 1, currentBlock);
        try {
          this.logger.log(`  Querying blocks ${fromBlock} to ${toBlock}...`);
          const chunkEvents = await this.contractsService.propertyNFT.queryFilter(filter, fromBlock, toBlock);
          allEvents.push(...chunkEvents);
          this.logger.log(`  Found ${chunkEvents.length} events in this chunk`);
        } catch (error: any) {
          this.logger.warn(`  Failed to query blocks ${fromBlock}-${toBlock}: ${error.message}`);
          // Continue with next chunk
        }
      }
      
      const events = allEvents;
      this.logger.log(` Found ${events.length} PropertyCreated events in blockchain history`);

      // Get unique owners from events
      const uniqueOwners = new Set<string>();
      for (const event of events) {
        if (event.args && event.args.owner) {
          uniqueOwners.add(event.args.owner.toLowerCase());
        }
      }

      this.logger.log(` Found ${uniqueOwners.size} unique property owners`);

      let totalSynced = 0;
      const syncedOwners = new Set<string>();

      // Sync properties for each owner
      for (const ownerAddress of uniqueOwners) {
        try {
          this.logger.log(` Syncing properties for ${ownerAddress}...`);
          const properties = await this.syncFromChain(ownerAddress);
          if (properties.length > 0) {
            totalSynced += properties.length;
            syncedOwners.add(ownerAddress);
            this.logger.log(` Synced ${properties.length} properties for ${ownerAddress}`);
          }
        } catch (error) {
          this.logger.error(` Failed to sync properties for ${ownerAddress}: ${error.message}`);
        }
      }

      this.logger.log(` Full sync complete: ${totalSynced} properties synced for ${syncedOwners.size} owners`);
      return {
        synced: totalSynced,
        owners: syncedOwners.size,
        totalEvents: events.length,
      };
    } catch (error) {
      this.logger.error(`Failed to sync all existing properties: ${error.message}`, error.stack);
      throw error;
    }
  }

  async cleanupOldProperties() {
    // Clean up properties that don't exist in the new contract
    // (properties from old contract that fail ownerOf check)
    if (!this.contractsService.propertyNFT) {
      this.logger.error('PropertyNFT contract not initialized');
      throw new Error('Contract not initialized');
    }

    this.logger.log(' Starting cleanup of old properties (checking against new contract)...');
    const allProperties = await this.db
      .select({
        id: schema.properties.id,
        tokenId: schema.properties.tokenId,
      })
      .from(schema.properties);

    let deleted = 0;
    const errors: string[] = [];

    for (const prop of allProperties) {
      try {
        // Try to get ownerOf - if it fails, property doesn't exist in new contract
        await this.contractsService.propertyNFT.ownerOf(prop.tokenId);
        // If successful, property exists in new contract - keep it
      } catch (error) {
        // ownerOf failed - property doesn't exist in new contract, delete it
        try {
          await this.db
            .delete(schema.properties)
            .where(eq(schema.properties.id, prop.id));
          deleted++;
          this.logger.log(` Deleted property ${prop.tokenId} (doesn't exist in new contract)`);
        } catch (deleteError: any) {
          errors.push(`Failed to delete property ${prop.tokenId}: ${deleteError.message}`);
          this.logger.error(`Failed to delete property ${prop.tokenId}: ${deleteError.message}`);
        }
      }
    }

    this.logger.log(` Cleanup complete: deleted ${deleted} old properties from database`);
    if (errors.length > 0) {
      this.logger.warn(` ${errors.length} errors during cleanup`);
    }

    return { deleted, errors };
  }
}
</file>

<file path="frontend/src/lib/contracts.ts">
import { Address } from 'viem';
import { wagmiConfig } from './mantle-viem';
import { readContract, writeContract } from 'wagmi/actions';

// Import ABIs from public folder (loaded at runtime)
// For TypeScript, we'll use dynamic imports or fetch
let PropertyNFTABI: any = null;
let GameTokenABI: any = null;
let YieldDistributorABI: any = null;
let MarketplaceABI: any = null;
let QuestSystemABI: any = null;

// Load ABIs dynamically
if (typeof window !== 'undefined') {
  Promise.all([
    fetch('/abis/PropertyNFT.json').then(r => r.json()),
    fetch('/abis/GameToken.json').then(r => r.json()),
    fetch('/abis/YieldDistributor.json').then(r => r.json()),
    fetch('/abis/Marketplace.json').then(r => r.json()),
    fetch('/abis/QuestSystem.json').then(r => r.json()),
    fetch('/abis/TokenSwap.json').then(r => r.json()).catch(() => null), // Optional, fallback to inline ABI
  ]).then(([pnft, gt, yd, mp, qs, ts]) => {
    PropertyNFTABI = pnft;
    GameTokenABI = gt;
    YieldDistributorABI = yd;
    MarketplaceABI = mp;
    QuestSystemABI = qs;
    // TokenSwapABI can use inline ABI if fetch fails
  }).catch(console.error);
}

// Contract addresses (Mantle Sepolia Testnet)
export const CONTRACTS = {
  PropertyNFT: (process.env.NEXT_PUBLIC_PROPERTY_NFT_ADDRESS || '0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c') as Address,
  GameToken: (process.env.NEXT_PUBLIC_GAME_TOKEN_ADDRESS || '0x3334f87178AD0f33e61009777a3dFa1756e9c23f') as Address,
  YieldDistributor: (process.env.NEXT_PUBLIC_YIELD_DISTRIBUTOR_ADDRESS || '0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4') as Address,
  Marketplace: (process.env.NEXT_PUBLIC_MARKETPLACE_ADDRESS || '0x6b6b65843117C55da74Ea55C954a329659EFBeF0') as Address,
  QuestSystem: (process.env.NEXT_PUBLIC_QUEST_SYSTEM_ADDRESS || '0x89f72227168De554A28874aA79Bcb6f0E8e2227C') as Address,
  TokenSwap: (process.env.NEXT_PUBLIC_TOKEN_SWAP_ADDRESS || '0xAd22cC67E66F1F0b0D1Be33F53Bd0948796a460E') as Address,
  MockRWA: (process.env.NEXT_PUBLIC_MOCK_RWA_ADDRESS || '0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45') as Address,
  // Oracle-based RWA contract (if configured, will be used instead of MockRWA)
  OracleRWA: (process.env.NEXT_PUBLIC_ORACLE_RWA_ADDRESS || null) as Address | null,
} as const;

// Fallback inline ABIs for critical functions (used until dynamic ABIs load)
export const PROPERTY_NFT_ABI = [
  {
    inputs: [{ name: 'to', type: 'address' }, { name: 'propertyType', type: 'uint8' }, { name: 'value', type: 'uint256' }, { name: 'yieldRate', type: 'uint256' }],
    name: 'mintProperty',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyType', type: 'uint8' }, { name: 'value', type: 'uint256' }, { name: 'yieldRate', type: 'uint256' }],
    name: 'purchaseProperty',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [
      { name: 'to', type: 'address' },
      { name: 'tokenId', type: 'uint256' },
    ],
    name: 'approve',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [
      { name: 'operator', type: 'address' },
      { name: 'approved', type: 'bool' },
    ],
    name: 'setApprovalForAll',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'getProperty',
    outputs: [
      {
        components: [
          { name: 'propertyType', type: 'uint8' },
          { name: 'value', type: 'uint256' },
          { name: 'yieldRate', type: 'uint256' },
          { name: 'rwaContract', type: 'address' },
          { name: 'rwaTokenId', type: 'uint256' },
          { name: 'totalYieldEarned', type: 'uint256' },
          { name: 'createdAt', type: 'uint256' },
          { name: 'isActive', type: 'bool' },
        ],
        name: '',
        type: 'tuple',
      },
    ],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'owner', type: 'address' }],
    name: 'getOwnerProperties',
    outputs: [{ name: '', type: 'uint256[]' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [
      { name: 'owner', type: 'address' },
      { name: 'operator', type: 'address' },
    ],
    name: 'isApprovedForAll',
    outputs: [{ name: '', type: 'bool' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'ownerOf',
    outputs: [{ name: '', type: 'address' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [
      { name: 'tokenId', type: 'uint256' },
      { name: 'rwaContract', type: 'address' },
      { name: 'rwaTokenId', type: 'uint256' },
    ],
    name: 'linkToRWA',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
] as const;

export const YIELD_DISTRIBUTOR_ABI = [
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'claimYield',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyIds', type: 'uint256[]' }],
    name: 'batchClaimYield',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'calculateYield',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'YIELD_UPDATE_INTERVAL',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'lastYieldUpdate',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
] as const;

export const MARKETPLACE_ABI = [
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'buyProperty',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [
      { name: 'propertyId', type: 'uint256' },
      { name: 'price', type: 'uint256' },
    ],
    name: 'listProperty',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'cancelListing',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [
      { name: 'propertyId', type: 'uint256' },
      { name: 'startingPrice', type: 'uint256' },
      { name: 'duration', type: 'uint256' },
    ],
    name: 'createAuction',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'propertyId', type: 'uint256' }],
    name: 'listings',
    outputs: [
      { name: 'propertyId', type: 'uint256' },
      { name: 'seller', type: 'address' },
      { name: 'price', type: 'uint256' },
      { name: 'isActive', type: 'bool' },
      { name: 'createdAt', type: 'uint256' },
    ],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'getActiveListings',
    outputs: [
      { name: 'propertyIds', type: 'uint256[]' },
      { name: 'sellers', type: 'address[]' },
      { name: 'prices', type: 'uint256[]' },
    ],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'getActiveListingsCount',
    outputs: [{ name: 'count', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
] as const;

export const QUEST_SYSTEM_ABI = [
  {
    inputs: [{ name: 'player', type: 'address' }],
    name: 'checkFirstPropertyQuest',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'player', type: 'address' }],
    name: 'checkDiversifyPortfolioQuest',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'player', type: 'address' }],
    name: 'checkPropertyMogulQuest',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'player', type: 'address' }],
    name: 'checkRWAPioneerQuest',
    outputs: [],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'player', type: 'address' }, { name: 'questType', type: 'uint8' }],
    name: 'hasCompletedQuest',
    outputs: [{ name: '', type: 'bool' }],
    stateMutability: 'view',
    type: 'function',
  },
] as const;

/**
 * Mint a property NFT
 */
export async function mintProperty(
  to: Address,
  propertyType: number,
  value: bigint,
  yieldRate: bigint,
) {
  // Use dynamic ABI if available, otherwise fallback
  const abi = PropertyNFTABI || PROPERTY_NFT_ABI;
  return writeContract(wagmiConfig, {
    address: CONTRACTS.PropertyNFT,
    abi: abi,
    functionName: 'mintProperty',
    args: [to, propertyType, value, yieldRate],
  });
}

/**
 * Get property details
 */
export async function getProperty(tokenId: bigint) {
  return readContract(wagmiConfig, {
    address: CONTRACTS.PropertyNFT,
    abi: PROPERTY_NFT_ABI,
    functionName: 'getProperty',
    args: [tokenId],
  });
}

/**
 * Get owner's properties with retry logic
 */
export async function getOwnerProperties(owner: Address): Promise<bigint[]> {
  const maxRetries = 3;
  let lastError: any = null;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      console.log(` Attempt ${attempt}/${maxRetries}: Fetching properties for ${owner}...`);
      const result = await readContract(wagmiConfig, {
        address: CONTRACTS.PropertyNFT,
        abi: PROPERTY_NFT_ABI,
        functionName: 'getOwnerProperties',
        args: [owner],
      }) as bigint[];
      
      console.log(` Successfully fetched ${result.length} properties`);
      return result || [];
    } catch (error: any) {
      lastError = error;
      const errorMessage = error.message || error.toString();
      console.warn(` Attempt ${attempt} failed:`, errorMessage);
      
      // If it's a revert error and user might have no properties, return empty array
      if (errorMessage.includes('revert') || errorMessage.includes('execution reverted')) {
        // Check if it's because user has no properties (shouldn't revert, but handle gracefully)
        if (attempt === maxRetries) {
          console.log(' getOwnerProperties reverted - user may have no properties yet, returning empty array');
          return [];
        }
      }
      
      // If it's a network error, wait before retrying
      if (attempt < maxRetries && (error.message?.includes('fetch') || error.message?.includes('network') || error.message?.includes('HTTP'))) {
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Exponential backoff
        continue;
      }
      
      // If it's not a network error, throw immediately
      if (!error.message?.includes('fetch') && !error.message?.includes('network') && !error.message?.includes('HTTP')) {
        throw error;
      }
    }
  }
  
  // All retries failed
  console.error(' All attempts failed to fetch properties:', lastError);
  throw new Error(`Failed to fetch properties after ${maxRetries} attempts: ${lastError?.message || 'Unknown error'}`);
}

/**
 * Claim yield for a property
 */
export async function claimYield(propertyId: bigint) {
  const abi = YieldDistributorABI || YIELD_DISTRIBUTOR_ABI;
  return writeContract(wagmiConfig, {
    address: CONTRACTS.YieldDistributor,
    abi: abi,
    functionName: 'claimYield',
    args: [propertyId],
  });
}

/**
 * Batch claim yield for multiple properties
 */
export async function batchClaimYield(propertyIds: bigint[]) {
  const abi = YieldDistributorABI || YIELD_DISTRIBUTOR_ABI;
  return writeContract(wagmiConfig, {
    address: CONTRACTS.YieldDistributor,
    abi: abi,
    functionName: 'batchClaimYield',
    args: [propertyIds],
  });
}

/**
 * Calculate yield for a property
 */
export async function calculateYield(propertyId: bigint) {
  const abi = YieldDistributorABI || YIELD_DISTRIBUTOR_ABI;
  return readContract(wagmiConfig, {
    address: CONTRACTS.YieldDistributor,
    abi: abi,
    functionName: 'calculateYield',
    args: [propertyId],
  });
}

export const TOKEN_SWAP_ABI = [
  {
    inputs: [],
    name: 'buyTokens',
    outputs: [],
    stateMutability: 'payable',
    type: 'function',
  },
  {
    inputs: [{ name: 'mntAmount', type: 'uint256' }],
    name: 'getTycoonAmount',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'pure',
    type: 'function',
  },
  {
    inputs: [],
    name: 'getTokenBalance',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'EXCHANGE_RATE',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'view',
    type: 'function',
  },
] as const;
</file>

<file path="README.md">
# Property Tycoon

Build property empires. Earn real yield. Own your portfolio. Real-time updates powered by Mantle Network.

## What You Get

You build property portfolios. You manage properties. You earn real yield from RWA-backed assets. Top tycoons win more. Your properties stay on blockchain. Your yield stays in your wallet. Portfolio updates instantly without refreshing. No waiting. No polling. Pure real-time property management. See other players. Visit their portfolios. Trade properties. Join neighborhoods. Compete on leaderboards. All in real time.

## Why We Built This

Property investment is expensive. Real estate requires large capital. Most people cannot afford properties. We built Property Tycoon to make property investment accessible. Start with small amounts. Build your portfolio over time. Learn investment strategies. Experience the fun of property management. Watch your empire grow. See your yield accumulate. Compete with friends. Visit their portfolios. Learn from top tycoons. All while earning real yield from tokenized real estate.

The game makes property investment fun. You see your properties on a city map. You watch yield accumulate in real time. You compete on leaderboards. You complete investment quests. You join guilds with friends. You trade properties with other players. You link properties to real-world assets. You earn actual rental income. All powered by blockchain. All transparent. All yours.

## How It Works

Connect your wallet. Buy TYCOON tokens with MNT. One-time purchase to get started. Mint property NFTs. Link properties to RWA. Properties generate yield daily. Collect real yield. Earn USDC or USDT. Reinvest yield to expand. Or keep the money. Complete investment quests. Compete for rewards. Watch portfolio value update in real time. See your yield grow instantly. See leaderboard positions shift live. Visit other players portfolios. Buy properties from marketplace. Join neighborhoods with friends. All powered by Mantle Network.

## Your First Property

Step one: Connect your wallet. Use MetaMask or WalletConnect. Switch to Mantle Sepolia Testnet. Get test tokens from faucet.

Step two: Buy TYCOON tokens. One-time purchase to get started. Send MNT to swap contract. One MNT buys 100 TYCOON tokens. Buy enough for your first property. Buy more later if you want to expand. No recurring payments. No subscriptions.

Step three: Mint your property. Spend 100 TYCOON tokens. One-time cost per property. Choose property type. Residential for stability. Commercial for balance. Industrial for higher yield. Luxury for maximum returns. Your property NFT stays in your wallet. View it in your collection. See it on your map. Property is yours forever.

Step four: Link to RWA. Connect your property to tokenized real estate. Select RWA contract. Enter token ID. Link confirmed. Your property now generates real yield from rental income. No additional cost.

Step five: Collect yield. Properties generate yield daily. Free money. No cost to collect. Claim your yield rewards. Yield distributed as USDC or USDT. Real money in your wallet. Transparent on-chain distribution. Keep the yield or reinvest.

Step six: Expand your portfolio. Use collected yield to buy more TYCOON tokens. Mint more properties. Or keep the yield as profit. Your choice. No pressure to keep buying. Properties keep generating yield.

Step seven: Visit other players. Click leaderboard. See top tycoons. Visit their portfolios. See how they built their empires. Get inspired. Learn strategies.

Step eight: Complete quests. Finish investment challenges. Diversify your portfolio. Optimize your yield. Earn bonus rewards. Unlock achievements. Climb the leaderboard.

## Properties

Residential Properties: Apartments and houses. Stable yield around 5 percent APY. Lower risk. Perfect for beginners. Steady income stream. Easy to manage. Great starting point for your portfolio. Costs 100 TYCOON tokens to mint. Generates yield daily. No maintenance cost.

Commercial Properties: Offices and retail spaces. Moderate yield around 8 percent APY. Medium risk. Balanced returns. Requires more capital. Steady tenant base. Good for portfolio diversification. Costs 200 TYCOON tokens to mint. Generates yield daily. No maintenance cost.

Industrial Properties: Warehouses and factories. Higher yield around 12 percent APY. Higher risk. Requires significant investment. Strong cash flow potential. Long-term leases. Advanced portfolio addition. Costs 500 TYCOON tokens to mint. Generates yield daily. No maintenance cost.

Luxury Properties: Premium real estate. Highest yield around 15 percent APY. Highest cost. Maximum returns. Exclusive properties. High-value assets. For serious tycoons. Costs 1000 TYCOON tokens to mint. Generates yield daily. No maintenance cost.

## Purchasing Model

One-time token purchase to get started. Buy TYCOON tokens with MNT. Use tokens to mint properties. Each property costs tokens one time. No recurring payments. No subscriptions. No maintenance fees.

Properties generate yield daily. Free money. No cost to collect. Claim yield as USDC or USDT. Real money in your wallet. Keep the yield or reinvest. Your choice.

Expand when you want. Use collected yield to buy more tokens. Mint more properties. Or keep the yield as profit. No pressure to keep buying. Properties keep generating yield forever.

Example: Buy 1000 TYCOON tokens once. Mint 5 properties. Properties generate yield daily. Collect yield. Use yield to expand or keep money. No more token purchases needed unless you want to grow faster.

## Multiplayer Features

See other players portfolios. Visit top tycoons. Browse their properties. See how they arranged their empire. Learn from the best. Get inspired by successful portfolios. Click "Visit" on any leaderboard entry to view their complete portfolio.

Global leaderboard shows all players. Ranked by portfolio value. Ranked by total yield. Ranked by properties owned. See your position. See top ten. Updates automatically when properties change. Leaderboard refreshes in real time via WebSocket events.

Guilds create communities. Join existing guilds. Create your own guild. See guild members properties. Share guild benefits. Compete in guild leaderboards. Guild stats update automatically when members properties change. Combined portfolio value and yield tracking.

Marketplace connects players. Browse properties for sale. See seller information. View property details. Buy from other players. Sell your properties. Click "Sell Property" button in property details or "List Property" in marketplace. Set your prices. Choose fixed price or auction. Approve marketplace to transfer your NFT. List property for sale. Cancel listings anytime. Trade with community. No need to always mint new. Buy from others. Fixed price and auction listings supported.

Quest system rewards players. Complete investment challenges. Diversify your portfolio. Optimize your yield. Earn bonus rewards. Unlock achievements. Track progress in real time. Claim rewards when completed.

Global chat connects everyone. Talk with all players. Share tips and strategies. Announce property sales. Discuss market trends. Real-time messaging. Build community. Usernames and avatars for personalized experience.

## Real-Time Features

Portfolio updates instantly. No refresh needed. Property values appear as they change. Yield accumulates in real time. Your rank changes instantly. See new properties minted. See yield distributions. See leaderboard shifts. See other players join. See properties traded. All without page refresh.

Powered by Mantle Network. Backend emits events via smart contracts when properties are created. Frontend subscribes using Wagmi hooks for real-time updates. Socket.io handles multiplayer events. On-chain events stream directly to your browser. Fast updates without polling. Low latency. High performance. Database-like speed with blockchain security.

## RWA Integration

Properties linked to tokenized real estate. Each property NFT backed by real-world asset. Real yield from actual rental income. Transparent distribution on-chain. Verifiable ownership. Compliant with regulations. KYC flow for RWA investments. Fractional ownership supported. Multiple properties per RWA. Yield distributed proportionally.

Linking property to RWA updates yield calculation. YieldDistributor contract checks if property is linked to RWA. If linked, uses RWA value and yield rate for yield calculation. If not linked, uses property's own value and yield rate. Automatic fallback ensures backward compatibility. All existing linked properties benefit immediately. Frontend and backend also use RWA data for estimated yield calculations. Estimated yield display updates in real time using RWA value and yield rate when property is linked.

**Note:** Currently using MockRWA contract for this demo. Chronicle Oracle integration is fully implemented and ready for production use, but we are using MockRWA for demo and testing purposes. MockRWA is ERC-721 compatible and can be replaced with real RWA contracts in production. Frontend supports both oracle-based and MockRWA contracts. To use real Chronicle Oracle RWA, configure the appropriate environment variables.

## Yield Distribution

First place wins 40 percent of yield pool. Second place wins 25 percent. Third place wins 15 percent. Places four through ten split 10 percent. All players split 10 percent participation rewards.

Minimum one property required to qualify.

## What You Own

Your property NFTs belong to you. Trade them. Sell them. Keep them. Your TYCOON tokens belong to you. Spend them. Hold them. Your yield belongs to you. Claim it. Reinvest it. Your portfolio stays on blockchain forever. Your rewards stay in your wallet.

## Why Mantle

Mantle offers low fees. Your yield stays in your pocket. Fast transactions mean quick property purchases. Real-time updates mean instant portfolio changes. Sub-second finality. High throughput. Built for real use. Perfect for property management. Perfect for multiplayer interactions.

Property minting costs 0.001 MNT. Yield claiming costs 0.0005 MNT. Enables micro-transactions for frequent yield collection. Supports real-time multiplayer interactions. Handles concurrent property minting. Processes multiple yield claims simultaneously.

## Mantle Integration

We use Mantle SDK for cross-chain messaging. Asset bridging between L1 and L2. Deposit and withdrawal estimation. Message status tracking. L1 to L2 asset transfers for RWA tokenization.

We use Mantle Viem for type-safe contract interactions. Wagmi and Viem integration. Efficient data fetching with automatic caching. Real-time event subscriptions. Optimized RPC calls leveraging Mantle throughput.

We use Mantle custom RPC methods. eth_getBlockRange for batch block queries. rollup_getInfo for L2 node status. Gas price optimization using Mantle GasPriceOracle. Custom API methods for performance.

We use Mantle GasPriceOracle for gas optimization. L1 base fee tracking. L2 gas price optimization. Transaction cost estimation. Batch transaction support.

## Chronicle Oracle

Uses Chronicle Oracle for price feeds on Mantle Sepolia. 60 to 80 percent less gas than other oracles. Critical for frequent yield calculations. Property value updates cost less.

Schnorr-based architecture ensures secure price feeds. Data freshness validation with 3-hour default threshold. tryReadWithAge functions prevent reverts. Graceful fallbacks if oracle data is stale.

Chronicle Oracle addresses on Mantle Sepolia:
- USDC/USD: 0x9Dd500569A6e77ECdDE7694CDc2E58ac587768D0
- USDT/USD: 0xD671F5F7c2fb6f75439641C36a578842f5b376A9
- ETH/USD: 0xa6896dCf3f5Dc3c29A5bD3a788D6b7e901e487D8
- MNT/USD: 0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307

Chronicle Oracle integration is implemented and actively used for USD price conversions. Frontend displays all TYCOON amounts with USD equivalents using real-time MNT/USD price from Chronicle Oracle. Backend fetches price via whitelisted wallet and broadcasts updates via Socket.io every 5 minutes. Frontend receives real-time price updates without page refresh.

**Active Usage:**
- Frontend displays all TYCOON amounts with USD equivalents using Chronicle Oracle MNT/USD price feed
- Property values, yield amounts, and portfolio totals show both TYCOON and USD
- Real-time price updates via Socket.io without page refresh
- Uses Chronicle Oracle address: `0xCE0F753FDEEE2D0EC5F1ba086bD7d5087C20c307` (MNT/USD on Mantle Sepolia)
- Exchange rate: 1 MNT = 100 TYCOON, so TYCOON/USD = MNT/USD  100
- Backend wallet must be whitelisted on Chronicle Oracle for price fetching

**Other Price Feeds:**
Backend has methods for USDC, USDT, and ETH price feeds, but these are not currently used. They are available for future features like multi-currency support.

**RWA Property Values:**
RWA property values can be fetched from Chronicle when `CHRONICLE_RWA_PROPERTY_ORACLE` is configured, but this environment variable is not set in the demo. The system falls back to contract queries (MockRWA) when Chronicle oracle is not configured.

**Note:** Chronicle Oracle MNT/USD price feed is actively used for USD display with real-time updates. For RWA property values, we are using MockRWA contract instead of real Chronicle Oracle RWA data. To use real Chronicle Oracle RWA, configure `CHRONICLE_RWA_PROPERTY_ORACLE` environment variable in backend and `NEXT_PUBLIC_ORACLE_RWA_ADDRESS` in frontend.

## MockRWA

**Currently using MockRWA for this demo.** Uses MockRWA for demo and testing purposes. Allows testing RWA linking without real tokenized assets. Perfect for hackathons and demos. Developers test property linking without deploying real RWA contracts. Easy to mint test properties to different addresses.

MockRWA implements ERC-721 standard. Replaced with any real RWA contract following the same interface. Real RWA platforms require KYC and compliance. MockRWA allows immediate testing and demos.

**Note:** Chronicle Oracle integration is fully implemented and ready for production. For this demo, we are using MockRWA instead of real Chronicle Oracle RWA data. Frontend checks for NEXT_PUBLIC_ORACLE_RWA_ADDRESS environment variable. If set, uses oracle-based RWA contract. If not set, falls back to MockRWA contract. Backend uses Chronicle Oracle for RWA property values when CHRONICLE_RWA_PROPERTY_ORACLE is configured. System handles both mock and real RWA contracts seamlessly.

## Technical Excellence

Web-based gameplay. No downloads. No Unity. No plugins. Works in any browser. Mobile responsive. Touch controls. Keyboard support. Smooth animations. Property visualization. Yield charts. Real-time leaderboard. RWA integration. Smart contract rewards. Mantle network integration. Next.js frontend. NestJS backend. Socket.io real-time. Pixi.js rendering.

## Getting Started

Frontend: Navigate to frontend folder. Run npm install. Run npm run dev. Visit localhost:3000.

Contracts: See contracts README for setup. Deploy to Mantle Testnet. Update frontend addresses.

Backend: See backend README for setup. Run API server. Configure contract addresses. Start Socket.io server.

## Deployed Contracts

Mantle Sepolia Testnet:

TYCOON Token: 0x3334f87178AD0f33e61009777a3dFa1756e9c23f

Property NFT: 0xeD1c7F14F40DF269E561Eb775fbD0b9dF3B4892c

Yield Distributor: 0x37e425aece1e2fc89b286cf7a63a74e8c7a791c4

Marketplace: 0x6b6b65843117C55da74Ea55C954a329659EFBeF0

Quest System: 0x89f72227168De554A28874aA79Bcb6f0E8e2227C

Token Swap: 0xAd22cC67E66F1F0b0D1Be33F53Bd0948796a460E

MockRWA: 0xDF1D8Bce49E57f12e78e5881bcFE2f546e7A5a45

View contracts on Mantle Explorer: https://explorer.sepolia.mantle.xyz

## Documentation

[Contracts README](contracts/README.md): Smart contract setup and deployment details.

[Frontend README](frontend/README.md): Frontend setup and feature documentation.

[Backend README](backend/README.md): Backend setup and API documentation.

## Built for Mantle Global Hackathon 2025

Property Tycoon built for Mantle Global Hackathon 2025. Play to earn mechanics. Real yield from RWA. Smart contract rewards. Mantle integration. RWA tokenization. Multiplayer features. Web-based gameplay. Contracts deployed and verified. Ready for users. Production quality code.
</file>

<file path="backend/src/contracts/contracts.service.ts">
import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { ethers } from 'ethers';
import PropertyNFTABI from './abis/PropertyNFT.json';
import GameTokenABI from './abis/GameToken.json';
import YieldDistributorABI from './abis/YieldDistributor.json';
import MarketplaceABI from './abis/Marketplace.json';
import QuestSystemABI from './abis/QuestSystem.json';
import TokenSwapABI from './abis/TokenSwap.json';
import { MultiRpcService } from '../mantle/multi-rpc.service';

@Injectable()
export class ContractsService implements OnModuleInit {
  private readonly logger = new Logger(ContractsService.name);
  private provider: ethers.providers.JsonRpcProvider;
  private wallet: ethers.Wallet;
  
  public propertyNFT: ethers.Contract;
  public gameToken: ethers.Contract;
  public yieldDistributor: ethers.Contract;
  public marketplace: ethers.Contract;
  public questSystem: ethers.Contract;
  public tokenSwap: ethers.Contract;

  constructor(
    private configService: ConfigService,
    private multiRpcService?: MultiRpcService,
  ) {
    // Don't initialize in constructor - wait for OnModuleInit
  }

  onModuleInit() {
    this.initializeContracts();
  }

  private initializeContracts() {
    try {
      // Use process.env as fallback if ConfigService doesn't have values
      const rpcUrl = this.configService.get<string>('MANTLE_RPC_URL') || process.env.MANTLE_RPC_URL;
      const privateKey = this.configService.get<string>('PRIVATE_KEY') || process.env.PRIVATE_KEY;

      this.logger.log(`[ContractsService] Initializing contracts...`);
      this.logger.log(`[ContractsService] RPC URL: ${rpcUrl ? 'SET' : 'MISSING'}`);
      this.logger.log(`[ContractsService] Private Key: ${privateKey ? 'SET' : 'MISSING'}`);

      if (!rpcUrl || !privateKey) {
        this.logger.error('[ContractsService] Missing MANTLE_RPC_URL or PRIVATE_KEY for contract service.');
        this.logger.error(`[ContractsService] ConfigService MANTLE_RPC_URL: ${this.configService.get<string>('MANTLE_RPC_URL') || 'NOT SET'}`);
        this.logger.error(`[ContractsService] process.env MANTLE_RPC_URL: ${process.env.MANTLE_RPC_URL || 'NOT SET'}`);
        this.logger.error(`[ContractsService] ConfigService PRIVATE_KEY: ${this.configService.get<string>('PRIVATE_KEY') ? 'SET (hidden)' : 'NOT SET'}`);
        this.logger.error(`[ContractsService] process.env PRIVATE_KEY: ${process.env.PRIVATE_KEY ? 'SET (hidden)' : 'NOT SET'}`);
        return;
      }

      // Use MultiRpcService if available, otherwise use single provider
      if (this.multiRpcService) {
        this.provider = this.multiRpcService.getProvider();
        this.logger.log(`Using MultiRpcService with ${this.multiRpcService.getAllRpcUrls().length} endpoints`);
        // Test connectivity on startup
        this.multiRpcService.testConnectivity().catch(err => {
          this.logger.warn('RPC connectivity test failed:', err.message);
        });
      } else {
        this.provider = new ethers.providers.JsonRpcProvider(rpcUrl);
        this.logger.log(`Using single RPC provider: ${rpcUrl}`);
      }
      this.wallet = new ethers.Wallet(privateKey, this.provider);

      const propertyNFTAddress = this.configService.get<string>('PROPERTY_NFT_ADDRESS') || process.env.PROPERTY_NFT_ADDRESS;
      const gameTokenAddress = this.configService.get<string>('GAME_TOKEN_ADDRESS') || process.env.GAME_TOKEN_ADDRESS;
      const yieldDistributorAddress = this.configService.get<string>('YIELD_DISTRIBUTOR_ADDRESS') || process.env.YIELD_DISTRIBUTOR_ADDRESS;
      const marketplaceAddress = this.configService.get<string>('MARKETPLACE_ADDRESS') || process.env.MARKETPLACE_ADDRESS;
      const questSystemAddress = this.configService.get<string>('QUEST_SYSTEM_ADDRESS') || process.env.QUEST_SYSTEM_ADDRESS;
      const tokenSwapAddress = this.configService.get<string>('TOKEN_SWAP_ADDRESS') || process.env.TOKEN_SWAP_ADDRESS;

      this.logger.log(`PropertyNFT Address: ${propertyNFTAddress || 'NOT SET'}`);

      if (propertyNFTAddress) {
        // Handle ABI - it might be wrapped in default export or be direct array
        let propertyNFTAbi: any = PropertyNFTABI;
        if (!Array.isArray(propertyNFTAbi)) {
          propertyNFTAbi = (PropertyNFTABI as any).default || (PropertyNFTABI as any).abi || PropertyNFTABI;
        }
        if (!Array.isArray(propertyNFTAbi)) {
          this.logger.error(`PropertyNFT ABI type: ${typeof propertyNFTAbi}, isArray: ${Array.isArray(propertyNFTAbi)}`);
          throw new Error('PropertyNFT ABI is not an array');
        }
        this.propertyNFT = new ethers.Contract(propertyNFTAddress, propertyNFTAbi, this.wallet);
        this.logger.log(`PropertyNFT contract initialized at ${propertyNFTAddress}`);
      } else {
        this.logger.error('PROPERTY_NFT_ADDRESS not set in environment variables');
      }
      
      if (gameTokenAddress) {
        let gameTokenAbi: any = GameTokenABI;
        if (!Array.isArray(gameTokenAbi)) {
          gameTokenAbi = (GameTokenABI as any).default || (GameTokenABI as any).abi || GameTokenABI;
        }
        if (!Array.isArray(gameTokenAbi)) {
          throw new Error('GameToken ABI is not an array');
        }
        this.gameToken = new ethers.Contract(gameTokenAddress, gameTokenAbi, this.wallet);
      }
      if (yieldDistributorAddress) {
        let yieldDistributorAbi: any = YieldDistributorABI;
        if (!Array.isArray(yieldDistributorAbi)) {
          yieldDistributorAbi = (YieldDistributorABI as any).default || (YieldDistributorABI as any).abi || YieldDistributorABI;
        }
        if (!Array.isArray(yieldDistributorAbi)) {
          throw new Error('YieldDistributor ABI is not an array');
        }
        this.yieldDistributor = new ethers.Contract(yieldDistributorAddress, yieldDistributorAbi, this.wallet);
      }
      if (marketplaceAddress) {
        let marketplaceAbi: any = MarketplaceABI;
        if (!Array.isArray(marketplaceAbi)) {
          marketplaceAbi = (MarketplaceABI as any).default || (MarketplaceABI as any).abi || MarketplaceABI;
        }
        if (!Array.isArray(marketplaceAbi)) {
          throw new Error('Marketplace ABI is not an array');
        }
        this.marketplace = new ethers.Contract(marketplaceAddress, marketplaceAbi, this.wallet);
        this.logger.log(`Marketplace contract initialized at ${marketplaceAddress}`);
      } else {
        this.logger.warn('MARKETPLACE_ADDRESS not set in environment variables - marketplace events will not be listened to');
      }
      if (questSystemAddress) {
        let questSystemAbi: any = QuestSystemABI;
        if (!Array.isArray(questSystemAbi)) {
          questSystemAbi = (QuestSystemABI as any).default || (QuestSystemABI as any).abi || QuestSystemABI;
        }
        if (!Array.isArray(questSystemAbi)) {
          throw new Error('QuestSystem ABI is not an array');
        }
        this.questSystem = new ethers.Contract(questSystemAddress, questSystemAbi, this.wallet);
      }
      if (tokenSwapAddress) {
        let tokenSwapAbi: any = TokenSwapABI;
        if (!Array.isArray(tokenSwapAbi)) {
          tokenSwapAbi = (TokenSwapABI as any).default || (TokenSwapABI as any).abi || TokenSwapABI;
        }
        if (!Array.isArray(tokenSwapAbi)) {
          throw new Error('TokenSwap ABI is not an array');
        }
        this.tokenSwap = new ethers.Contract(tokenSwapAddress, tokenSwapAbi, this.wallet);
        this.logger.log(`TokenSwap contract initialized at ${tokenSwapAddress}`);
      }

      if (this.propertyNFT) {
        this.logger.log('Smart contracts initialized successfully with wallet signer.');
      } else {
        this.logger.error('PropertyNFT contract failed to initialize!');
      }
    } catch (error) {
      this.logger.error('Failed to initialize smart contracts:', error);
      this.logger.error('Error details:', error.message, error.stack);
    }
  }

  getProvider(): ethers.providers.JsonRpcProvider {
    // Return current provider (MultiRpcService handles failover internally)
    return this.provider;
  }

  /**
   * Execute contract call with automatic RPC failover
   */
  async executeWithFailover<T>(
    operation: (provider: ethers.providers.JsonRpcProvider) => Promise<T>,
    operationName: string = 'contract call',
  ): Promise<T> {
    if (this.multiRpcService) {
      return this.multiRpcService.executeWithFailover(operation, operationName);
    } else {
      // Fallback to single provider if MultiRpcService not available
      return operation(this.provider);
    }
  }

  getWallet(): ethers.Wallet {
    return this.wallet;
  }

  async getProperty(tokenId: bigint) {
    return this.propertyNFT.getProperty(tokenId);
  }

  async getMarketplaceListing(propertyId: number): Promise<{ propertyId: number; seller: string; price: string; isActive: boolean; createdAt: number } | null> {
    try {
      if (!this.marketplace) {
        this.logger.warn('Marketplace contract not initialized');
        return null;
      }
      
      const listing = await this.marketplace.listings(BigInt(propertyId));
      
      // listings mapping returns: (propertyId, seller, price, isActive, createdAt)
      return {
        propertyId: Number(listing[0]),
        seller: listing[1],
        price: listing[2].toString(),
        isActive: listing[3],
        createdAt: Number(listing[4]),
      };
    } catch (error) {
      this.logger.error(`Error getting marketplace listing for property ${propertyId}: ${error.message}`);
      return null;
    }
  }

  async getOwnerProperties(ownerAddress: string) {
    return this.propertyNFT.getOwnerProperties(ownerAddress);
  }

  async getOwnerPropertyCount(ownerAddress: string) {
    return this.propertyNFT.getOwnerPropertyCount(ownerAddress);
  }

  async calculateYield(propertyId: bigint): Promise<bigint> {
    // Validate property ID (allow 0, but check if negative)
    if (propertyId < BigInt(0)) {
      this.logger.warn(`Invalid property ID: ${propertyId}. Property IDs cannot be negative.`);
      return BigInt(0);
    }

    // Check if property exists before calculating yield (property 0 CAN exist)
    try {
      await this.propertyNFT.ownerOf(propertyId);
    } catch (error: any) {
      // Property doesn't exist
      this.logger.warn(`Property ${propertyId} does not exist. Skipping yield calculation.`);
      return BigInt(0);
    }

    try {
      // Use failover mechanism if available
      if (this.multiRpcService) {
        const result = await this.multiRpcService.executeWithFailover(
          async (provider) => {
            // Create a new contract instance with the provider
            const yieldDistributorWithProvider = new ethers.Contract(
              this.yieldDistributor.address,
              this.yieldDistributor.interface,
              provider,
            );
            return await yieldDistributorWithProvider.calculateYield(propertyId);
          },
          `calculateYield(${propertyId})`,
        );
        
        // Convert result to BigInt (same logic as below)
        return this.convertYieldResultToBigInt(result, propertyId);
      }
      
      // Fallback to single provider
      const result = await this.yieldDistributor.calculateYield(propertyId);
      
      return this.convertYieldResultToBigInt(result, propertyId);
    } catch (error: any) {
      // If it's a revert (property doesn't exist or invalid), return 0 instead of throwing
      if (error.code === 'CALL_EXCEPTION' || error.message?.includes('revert')) {
        this.logger.warn(`Property ${propertyId} yield calculation reverted (property may not exist or be invalid): ${error.message}`);
        return BigInt(0);
      }
      this.logger.error(`Error calling calculateYield for property ${propertyId}: ${error.message}`);
      throw error;
    }
  }

  /**
   * Convert yield result from ethers.js to BigInt
   */
  private convertYieldResultToBigInt(result: any, propertyId: bigint): bigint {
    // Debug: Log the actual result type and structure
    this.logger.debug(`calculateYield result for property ${propertyId}:`, {
      type: typeof result,
      isBigInt: typeof result === 'bigint',
      hasHex: result && typeof result === 'object' && '_hex' in result,
      hasIsBigNumber: result && typeof result === 'object' && '_isBigNumber' in result,
      keys: result && typeof result === 'object' ? Object.keys(result) : 'N/A',
    });
    
    // Handle different return types from ethers.js
    let resultBigInt: bigint;
      
      if (typeof result === 'bigint') {
        resultBigInt = result;
      } else if (result && typeof result === 'object') {
        // Handle ethers.js BigNumber - ALWAYS prefer _hex (most reliable, avoids toString() bugs)
        // Check _hex FIRST before anything else
        if ('_hex' in result) {
          // BigNumber with _hex property - this is the most reliable way
          const hexValue = result._hex;
          if (typeof hexValue === 'string' && hexValue.startsWith('0x')) {
            resultBigInt = BigInt(hexValue);
            const resultStr = resultBigInt.toString();
            
            // Validate immediately after conversion - check for corrupted values
            // Normal yield should be < 1000 TYCOON = 1e21 wei = ~21 decimal digits
            if (resultStr.length > 25) {
              this.logger.error(`Property ${propertyId}: Hex value converts to corrupted number (${resultStr.length} digits). Hex: ${hexValue}. Contract state appears corrupted. Returning 0.`);
              return BigInt(0);
            }
            
            this.logger.debug(`Property ${propertyId}: Using _hex value: ${hexValue} = ${resultStr} wei`);
          } else {
            this.logger.error(`Invalid _hex value for property ${propertyId}: ${hexValue}`);
            return BigInt(0);
          }
        } else if ('_isBigNumber' in result && result._isBigNumber) {
          // ethers v5 BigNumber - try to get hex value
          try {
            const hexValue = (result as any).toHexString();
            if (hexValue && typeof hexValue === 'string' && hexValue.startsWith('0x')) {
              resultBigInt = BigInt(hexValue);
            } else {
              throw new Error('Invalid hex from toHexString()');
            }
          } catch (hexError) {
            this.logger.warn(`Failed to get hex from BigNumber for property ${propertyId}, trying toString()...`);
            // Fallback to toString() but validate carefully
            const resultStr = result.toString();
            if (resultStr.length > 25) {
              this.logger.error(`Suspiciously long yield string for property ${propertyId}: ${resultStr.length} chars. Value likely corrupted.`);
              return BigInt(0);
            }
            if (!/^\d+$/.test(resultStr)) {
              this.logger.error(`Invalid calculateYield result (non-numeric) for property ${propertyId}: ${resultStr}`);
              return BigInt(0);
            }
            resultBigInt = BigInt(resultStr);
          }
        } else if ('toString' in result) {
          // Last resort: toString() - but validate carefully
          const resultStr = result.toString();
          
          // Check for suspicious patterns (repeated digits, too long, etc.)
          if (resultStr.length > 25) {
            this.logger.error(`Suspiciously long yield string for property ${propertyId}: ${resultStr.length} chars. Value likely corrupted. Returning 0.`);
            return BigInt(0);
          }
          
          // Validate it's a valid number string
          if (!/^\d+$/.test(resultStr)) {
            this.logger.error(`Invalid calculateYield result (non-numeric) for property ${propertyId}: ${resultStr}`);
            return BigInt(0);
          }
          resultBigInt = BigInt(resultStr);
        } else {
          this.logger.error(`Unknown result type for property ${propertyId}:`, typeof result, Object.keys(result));
          return BigInt(0);
        }
      } else {
        // Handle string or number
        const resultStr = String(result);
        if (!/^\d+$/.test(resultStr)) {
          this.logger.error(`Invalid calculateYield result (non-numeric) for property ${propertyId}: ${resultStr}`);
          return BigInt(0);
        }
        resultBigInt = BigInt(resultStr);
      }
      
      // Sanity check: yield should be reasonable (< 1000 TYCOON = 1e21 wei)
      // If larger, it's likely corrupted (string concatenation bug)
      const MAX_REASONABLE_YIELD = BigInt('1000000000000000000000'); // 1000 TYCOON
      if (resultBigInt > MAX_REASONABLE_YIELD) {
        this.logger.error(`Corrupted yield value for property ${propertyId}: ${resultBigInt.toString()} wei. Returning 0.`);
        return BigInt(0);
      }
      
      return resultBigInt;
  }

  async getTotalPendingYield(ownerAddress: string) {
    return this.yieldDistributor.getTotalPendingYield(ownerAddress);
  }

  async getLastYieldUpdate(propertyId: bigint): Promise<bigint> {
    return this.yieldDistributor.lastYieldUpdate(propertyId);
  }

  async getYieldUpdateInterval(): Promise<bigint> {
    if (!this.yieldDistributor) {
      throw new Error('YieldDistributor contract not initialized');
    }
    try {
      // Try calling as a function first (for public constant)
      const result = await this.yieldDistributor.YIELD_UPDATE_INTERVAL();
      return typeof result === 'bigint' ? result : BigInt(result.toString());
    } catch (error: any) {
      // If function call fails, return default (1 day = 86400 seconds)
      this.logger.warn(`Failed to get YIELD_UPDATE_INTERVAL from contract, using default 86400 seconds: ${error.message}`);
      return BigInt(86400); // 1 day in seconds
    }
  }

  async getListing(propertyId: bigint) {
    return this.marketplace.listings(propertyId);
  }

  async getAuction(propertyId: bigint) {
    return this.marketplace.auctions(propertyId);
  }

  async hasCompletedQuest(playerAddress: string, questType: number) {
    return this.questSystem.hasCompletedQuest(playerAddress, questType);
  }

  async getTotalQuestsCompleted(playerAddress: string) {
    return this.questSystem.getTotalQuestsCompleted(playerAddress);
  }

  async getQuest(questType: number) {
    return this.questSystem.quests(questType);
  }

  async getActiveListings() {
    // Note: Marketplace contract doesn't have a getActiveListings function
    // This would need to be implemented by querying events or maintaining an index
    // For now, return empty array - listings are synced via events
    return [];
  }
}
</file>

<file path="frontend/app/game/page.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract, useConfig } from 'wagmi';
import { parseEther } from 'viem';
import { CityView } from '@/components/game/CityView';
import { PropertyCard } from '@/components/game/PropertyCard';
import { BuildMenu } from '@/components/game/BuildMenu';
import { YieldDisplay } from '@/components/game/YieldDisplay';
import { PropertyDetails } from '@/components/game/PropertyDetails';
import { GlobalChat } from '@/components/GlobalChat';
import { UserProfile } from '@/components/UserProfile';
import { WalletConnect } from '@/components/WalletConnect';
import { RWALinkModal } from '@/components/RWALinkModal';
import { GameGuide } from '@/components/game/GameGuide';
import { Guilds } from '@/components/Guilds';
import { Marketplace } from '@/components/Marketplace';
import { Quests } from '@/components/Quests';
import { TokenPurchase } from '@/components/TokenPurchase';
import { MessageSquare, Building2, BookOpen, Trophy, Users, ShoppingBag, Target, Coins, User } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import Link from 'next/link';
import { getOwnerProperties, calculateYield, CONTRACTS, PROPERTY_NFT_ABI, YIELD_DISTRIBUTOR_ABI } from '@/lib/contracts';
import { readContract, getBlock, getPublicClient } from 'wagmi/actions';
import { createPublicClient, http, parseAbiItem } from 'viem';
import { api } from '@/lib/api';
import { io, Socket } from 'socket.io-client';

interface Property {
  id: string;
  tokenId: number;
  propertyType: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury';
  value: bigint;
  yieldRate: number;
  totalYieldEarned: bigint;
  createdAt?: Date; // Property creation date from blockchain
  x: number;
  y: number;
  rwaContract?: string;
  rwaTokenId?: number;
  isListed?: boolean; // Whether property is listed in marketplace
}

export default function GamePage() {
  const { address, isConnected } = useAccount();
  const config = useConfig();
  const [properties, setProperties] = useState<Property[]>([]);
  const [selectedProperty, setSelectedProperty] = useState<Property | null>(null);
  const [showBuildMenu, setShowBuildMenu] = useState(false);
  const [showChat, setShowChat] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showGuide, setShowGuide] = useState(false);
  const [showGuilds, setShowGuilds] = useState(false);
  const [showMarketplace, setShowMarketplace] = useState(false);
  const [showQuests, setShowQuests] = useState(false);
  const [showTokenPurchase, setShowTokenPurchase] = useState(false);
  const [showSellProperty, setShowSellProperty] = useState(false);
  const [propertyToSell, setPropertyToSell] = useState<Property | null>(null);
  const [showRWALink, setShowRWALink] = useState(false);
  const [totalPendingYield, setTotalPendingYield] = useState<bigint>(BigInt(0)); // Real-time estimated yield
  const [claimableYield, setClaimableYield] = useState<bigint>(BigInt(0)); // On-chain claimable yield (24-hour requirement)
  const [propertyClaimableYields, setPropertyClaimableYields] = useState<Map<number, bigint>>(new Map()); // Claimable yield per property
  const [totalYieldEarned, setTotalYieldEarned] = useState<bigint>(BigInt(0));
  const [yieldUpdateTimestamp, setYieldUpdateTimestamp] = useState<number>(Date.now()); // Force re-render when WebSocket updates
  const [isLoading, setIsLoading] = useState(true);
  const [isMinting, setIsMinting] = useState(false);
  const [isClaiming, setIsClaiming] = useState(false);
  const [tokenBalanceValue, setTokenBalanceValue] = useState<bigint>(BigInt(0));
  const [otherPlayersProperties, setOtherPlayersProperties] = useState<Array<Property & { owner: string; isOwned: boolean }>>([]);
  const [pendingPropertyType, setPendingPropertyType] = useState<'Residential' | 'Commercial' | 'Industrial' | 'Luxury' | null>(null);

  // Load properties function - FROM BACKEND (synced from blockchain)
  const loadProperties = useCallback(async () => {
    if (!address || !isConnected) {
      console.log('Cannot load properties: address or connection missing', { address, isConnected });
      return;
    }

    try {
      setIsLoading(true);
      console.log(' Loading properties from backend for:', address);
      
      // Try to load from backend first (faster, already synced)
      try {
        const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';
        const response = await fetch(`${BACKEND_URL}/properties/owner/${address}`, {
          signal: AbortSignal.timeout(5000), // 5 second timeout
        });
        
        if (response.ok) {
          const backendProperties = await response.json();
          console.log(` Loaded ${backendProperties.length} properties from backend`);
          console.log(' Backend property tokenIds:', backendProperties.map((p: any) => p.tokenId));
          
          if (backendProperties.length > 0) {
            // Convert backend properties to frontend format
            const mappedProperties: Property[] = await Promise.all(
              backendProperties.map(async (prop: any, index: number) => {
                // Backend returns value as string (NUMERIC), convert to BigInt
                const value = typeof prop.value === 'string' 
                  ? BigInt(prop.value) 
                  : BigInt(prop.value?.toString() || '0');
                const totalYieldEarned = typeof prop.totalYieldEarned === 'string'
                  ? BigInt(prop.totalYieldEarned)
                  : BigInt(prop.totalYieldEarned?.toString() || '0');
                
                // ALWAYS fetch property data from contract (source of truth)
                // This includes createdAt, rwaContract, and rwaTokenId
                // Backend data may be stale, so we trust the blockchain
                let createdAt: Date | undefined = undefined;
                let rwaContract: string | undefined = undefined;
                let rwaTokenId: number | undefined = undefined;
                
                try {
                  const propData = await readContract(config, {
                    address: CONTRACTS.PropertyNFT,
                    abi: PROPERTY_NFT_ABI,
                    functionName: 'getProperty',
                    args: [BigInt(prop.tokenId)],
                  }) as { 
                    createdAt: bigint;
                    rwaContract: `0x${string}`;
                    rwaTokenId: bigint;
                  };
                  
                  const createdAtTimestamp = Number(propData.createdAt);
                  createdAt = new Date(createdAtTimestamp * 1000);
                  
                  // Fetch RWA link data from contract (source of truth)
                  if (propData.rwaContract && 
                      propData.rwaContract !== '0x0000000000000000000000000000000000000000') {
                    rwaContract = propData.rwaContract;
                    rwaTokenId = Number(propData.rwaTokenId);
                    console.log(` Property #${prop.tokenId}: Linked to RWA ${rwaContract}, token ${rwaTokenId}`);
                  }
                  
                  // Calculate time remaining until yield becomes claimable (24 hours requirement)
                  const YIELD_UPDATE_INTERVAL_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
                  const timeElapsedMs = Date.now() - createdAt.getTime();
                  const timeRemainingMs = YIELD_UPDATE_INTERVAL_MS - timeElapsedMs;
                  const hoursRemaining = timeRemainingMs / (1000 * 60 * 60);
                  const isClaimable = timeElapsedMs >= YIELD_UPDATE_INTERVAL_MS;
                  
                  console.log(` Property #${prop.tokenId}: Contract data (source of truth):`, {
                    contractTimestamp: createdAtTimestamp,
                    contractDate: createdAt.toISOString(),
                    elapsedHours: (timeElapsedMs / (1000 * 60 * 60)).toFixed(2),
                    elapsedDays: (timeElapsedMs / (1000 * 60 * 60 * 24)).toFixed(2),
                    hoursUntilClaimable: isClaimable ? '0 (READY!)' : hoursRemaining.toFixed(2),
                    isClaimable: isClaimable,
                    rwaContract: rwaContract || 'Not linked',
                    rwaTokenId: rwaTokenId || 'N/A',
                    note: 'Yield requires 24 hours (YIELD_UPDATE_INTERVAL) before becoming claimable',
                  });
                  
                  if (prop.createdAt) {
                    const backendDate = new Date(prop.createdAt);
                    const backendDiff = Math.abs(createdAt.getTime() - backendDate.getTime());
                    if (backendDiff > 60000) { // More than 1 minute difference
                      console.warn(` Property #${prop.tokenId}: Backend createdAt differs from contract!`, {
                        backendDate: prop.createdAt,
                        contractDate: createdAt.toISOString(),
                        differenceHours: (backendDiff / (1000 * 60 * 60)).toFixed(2),
                      });
                    }
                  }
                  
                  // Check if RWA link differs between backend and contract
                  if (rwaContract && (prop.rwaContract !== rwaContract || prop.rwaTokenId !== rwaTokenId)) {
                    console.warn(` Property #${prop.tokenId}: RWA link differs between backend and contract!`, {
                      backendRWA: prop.rwaContract || 'Not linked',
                      contractRWA: rwaContract,
                      backendTokenId: prop.rwaTokenId || 'N/A',
                      contractTokenId: rwaTokenId,
                      note: 'Using contract data (source of truth)',
                    });
                  }
                } catch (error) {
                  console.warn(`Failed to fetch property data from contract for property ${prop.tokenId}:`, error);
                  // Fallback to backend if contract fetch fails
                  if (prop.createdAt) {
                    createdAt = new Date(prop.createdAt);
                  }
                  rwaContract = prop.rwaContract || undefined;
                  rwaTokenId = prop.rwaTokenId || undefined;
                }
                
                return {
                  id: prop.id || `prop-${prop.tokenId}`,
                  tokenId: prop.tokenId,
                  propertyType: prop.propertyType as Property['propertyType'],
                  value: value,
                  yieldRate: prop.yieldRate || 500,
                  totalYieldEarned: totalYieldEarned,
                  createdAt: createdAt,
                  x: prop.x ?? (index % 10),
                  y: prop.y ?? Math.floor(index / 10),
                  rwaContract: rwaContract, // Use contract data (source of truth)
                  rwaTokenId: rwaTokenId, // Use contract data (source of truth)
                  isOwned: true,
                };
              })
            );
            
            setProperties(mappedProperties);
            
            // Calculate total yield earned
            const totalYield = mappedProperties.reduce((sum, p) => sum + p.totalYieldEarned, BigInt(0));
            setTotalYieldEarned(totalYield);
            
            // Calculate claimable yield and time remaining from contract (requires 24 hours) - PER PROPERTY
            let totalClaimable = BigInt(0);
            const claimableYieldsMap = new Map<number, bigint>();
            const timeRemainingMap = new Map<number, { hours: number; minutes: number; isClaimable: boolean }>();
            
            // Get YIELD_UPDATE_INTERVAL from contract
            let yieldUpdateInterval = BigInt(86400); // Default 1 day in seconds
            try {
              const interval = await readContract(config, {
                address: CONTRACTS.YieldDistributor,
                abi: YIELD_DISTRIBUTOR_ABI,
                functionName: 'YIELD_UPDATE_INTERVAL',
              }) as bigint;
              yieldUpdateInterval = interval;
              console.log(` YIELD_UPDATE_INTERVAL from contract: ${interval.toString()} seconds = ${Number(interval) / 3600} hours`);
            } catch (error) {
              console.warn('Failed to fetch YIELD_UPDATE_INTERVAL, using default 86400 seconds');
            }
            
            // Get current block timestamp
            let currentBlockTimestamp = Math.floor(Date.now() / 1000); // Fallback to current time
            try {
              const block = await getBlock(config, { blockTag: 'latest' });
              currentBlockTimestamp = Number(block.timestamp);
              console.log(` Current block timestamp: ${currentBlockTimestamp} (${new Date(currentBlockTimestamp * 1000).toISOString()})`);
            } catch (error) {
              console.warn('Failed to fetch block timestamp, using current time');
            }
            
            const claimablePromises = mappedProperties.map(async (prop) => {
              try {
                // Get lastYieldUpdate from contract
                let lastUpdate = BigInt(0);
                try {
                  lastUpdate = await readContract(config, {
                    address: CONTRACTS.YieldDistributor,
                    abi: YIELD_DISTRIBUTOR_ABI,
                    functionName: 'lastYieldUpdate',
                    args: [BigInt(prop.tokenId)],
                  }) as bigint;
                } catch (error) {
                  console.warn(`Failed to fetch lastYieldUpdate for property ${prop.tokenId}`);
                }
                
                // If lastYieldUpdate is 0, use createdAt from PropertyNFT
                let startTimestamp = lastUpdate;
                if (lastUpdate === BigInt(0) && prop.createdAt) {
                  startTimestamp = BigInt(Math.floor(prop.createdAt.getTime() / 1000));
                  console.log(` Property #${prop.tokenId}: Using createdAt (lastYieldUpdate was 0)`);
                } else if (lastUpdate > BigInt(0)) {
                  console.log(` Property #${prop.tokenId}: Using lastYieldUpdate from contract`);
                }
                
                // Calculate time elapsed and remaining
                const timeElapsed = BigInt(currentBlockTimestamp) - startTimestamp;
                const timeElapsedSeconds = Number(timeElapsed);
                const timeElapsedHours = timeElapsedSeconds / 3600;
                const isClaimable = timeElapsed >= yieldUpdateInterval;
                
                let hoursRemaining = 0;
                let minutesRemaining = 0;
                if (!isClaimable) {
                  const timeRemaining = yieldUpdateInterval - timeElapsed;
                  const timeRemainingSeconds = Number(timeRemaining);
                  hoursRemaining = Math.floor(timeRemainingSeconds / 3600);
                  minutesRemaining = Math.floor((timeRemainingSeconds % 3600) / 60);
                }
                
                timeRemainingMap.set(prop.tokenId, {
                  hours: hoursRemaining,
                  minutes: minutesRemaining,
                  isClaimable,
                });
                
                console.log(` Property #${prop.tokenId} time status:`, {
                  lastUpdate: lastUpdate.toString(),
                  startTimestamp: startTimestamp.toString(),
                  currentTimestamp: currentBlockTimestamp.toString(),
                  timeElapsed: `${timeElapsedHours.toFixed(2)} hours`,
                  hoursRemaining: isClaimable ? '0 (READY!)' : `${hoursRemaining}h ${minutesRemaining}m`,
                  isClaimable,
                });
                
                // Get claimable yield
                const yieldPromise = calculateYield(BigInt(prop.tokenId));
                const timeoutPromise = new Promise<bigint>((resolve) => {
                  setTimeout(() => resolve(BigInt(0)), 2000); // 2 second timeout
                });
                const yieldAmount = await Promise.race([yieldPromise, timeoutPromise]);
                const claimable = typeof yieldAmount === 'bigint' ? yieldAmount : BigInt(yieldAmount?.toString() || '0');
                claimableYieldsMap.set(prop.tokenId, claimable);
                console.log(` Property #${prop.tokenId} claimable yield: ${claimable.toString()} wei (${Number(claimable) / 1e18} TYCOON)`);
                return claimable;
              } catch (error) {
                claimableYieldsMap.set(prop.tokenId, BigInt(0));
                timeRemainingMap.set(prop.tokenId, { hours: 0, minutes: 0, isClaimable: false });
                return BigInt(0);
              }
            });
            const claimableYields = await Promise.all(claimablePromises);
            totalClaimable = claimableYields.reduce((sum, y) => sum + y, BigInt(0));
            
            // Validate totalClaimable before setting (prevent showing corrupted values)
            // Max reasonable yield: 1000 TYCOON = 1e21 wei
            const MAX_REASONABLE_YIELD = BigInt('1000000000000000000000');
            if (totalClaimable > MAX_REASONABLE_YIELD) {
              console.warn(' Total claimable yield is suspiciously large, resetting to 0:', totalClaimable.toString());
              setClaimableYield(BigInt(0));
            } else {
              setClaimableYield(totalClaimable);
            }
            setPropertyClaimableYields(claimableYieldsMap);
            
            // Store time remaining map for display
            (window as any).propertyTimeRemaining = timeRemainingMap;
            
            console.log(` Total claimable yield: ${totalClaimable.toString()} wei (${Number(totalClaimable) / 1e18} TYCOON)`);
            
            // Calculate estimated yield from blockchain data (real-time) - WITH VERIFICATION
            // IMPORTANT: Uses RWA data when property is linked to RWA
            let totalPending = BigInt(0);
            const now = Date.now();
            
            console.log(' YIELD CALCULATION VERIFICATION:');
            const YIELD_UPDATE_INTERVAL_MS = 24 * 60 * 60 * 1000; // 24 hours (from YieldDistributor.sol line 17)
            
            // RWA ABI for fetching RWA data (matches MockRWA.sol struct)
            // Use 'properties' public mapping instead of 'getRWAProperty' for better viem compatibility
            const RWA_ABI = [
              {
                inputs: [{ name: '', type: 'uint256' }],
                name: 'properties',
                outputs: [
                  { name: 'name', type: 'string' },
                  { name: 'value', type: 'uint256' },
                  { name: 'monthlyYield', type: 'uint256' },
                  { name: 'location', type: 'string' },
                  { name: 'createdAt', type: 'uint256' },
                  { name: 'isActive', type: 'bool' },
                ],
                stateMutability: 'view',
                type: 'function',
              },
              {
                inputs: [{ name: 'tokenId', type: 'uint256' }],
                name: 'getYieldRate',
                outputs: [{ name: '', type: 'uint256' }],
                stateMutability: 'view',
                type: 'function',
              },
            ] as const;
            
            for (const prop of mappedProperties) {
              if (prop.createdAt) {
                const timeElapsedMs = now - prop.createdAt.getTime();
                const timeElapsedSeconds = timeElapsedMs / 1000;
                const timeElapsedHours = timeElapsedSeconds / 3600;
                const timeElapsedDays = timeElapsedHours / 24;
                const timeRemainingMs = YIELD_UPDATE_INTERVAL_MS - timeElapsedMs;
                const hoursRemaining = timeRemainingMs / (1000 * 60 * 60);
                const isClaimable = timeElapsedMs >= YIELD_UPDATE_INTERVAL_MS;
                
                if (timeElapsedSeconds > 0) {
                  let valueToUse = prop.value;
                  let yieldRateToUse = prop.yieldRate;
                  let yieldSource = 'PROPERTY';
                  
                  // Check if property is linked to RWA - use RWA data for yield calculation
                  if (prop.rwaContract && prop.rwaContract !== '0x0000000000000000000000000000000000000000' && prop.rwaTokenId !== undefined) {
                    try {
                      const publicClient = getPublicClient(config);
                      if (publicClient) {
                        // Fetch RWA property data using 'properties' public mapping (more reliable with viem)
                        const rwaProperty = await publicClient.readContract({
                          address: prop.rwaContract as `0x${string}`,
                          abi: RWA_ABI,
                          functionName: 'properties',
                          args: [BigInt(prop.rwaTokenId)],
                        }) as [string, bigint, bigint, string, bigint, boolean];
                        
                        // Fetch RWA yield rate
                        const rwaYieldRate = await publicClient.readContract({
                          address: prop.rwaContract as `0x${string}`,
                          abi: RWA_ABI,
                          functionName: 'getYieldRate',
                          args: [BigInt(prop.rwaTokenId)],
                        }) as bigint;
                        
                        const [rwaName, rwaValue, rwaMonthlyYield, rwaLocation, rwaCreatedAt, rwaIsActive] = rwaProperty;
                        
                        if (rwaIsActive && rwaValue > BigInt(0) && rwaYieldRate > BigInt(0)) {
                          valueToUse = rwaValue;
                          yieldRateToUse = Number(rwaYieldRate);
                          yieldSource = 'RWA';
                          console.log(` Property #${prop.tokenId}: Using RWA data for yield calculation`, {
                            rwaContract: prop.rwaContract,
                            rwaTokenId: prop.rwaTokenId,
                            rwaName,
                            rwaValue: `${Number(rwaValue) / 1e18} TYCOON`,
                            rwaYieldRate: `${Number(rwaYieldRate) / 100}% APY`,
                            rwaIsActive,
                          });
                        } else {
                          console.warn(` Property #${prop.tokenId}: RWA linked but inactive or invalid, using property data`, {
                            rwaIsActive,
                            rwaValue: rwaValue.toString(),
                            rwaYieldRate: rwaYieldRate.toString(),
                          });
                        }
                      }
                    } catch (error) {
                      console.warn(` Property #${prop.tokenId}: Failed to fetch RWA data, using property data:`, error);
                    }
                  }
                  
                  const yieldRateBigInt = BigInt(Math.floor(yieldRateToUse));
                  // Daily yield formula: (value * yieldRate) / (365 * 10000)
                  // yieldRate is in basis points (500 = 5% APY)
                  const dailyYield = (valueToUse * yieldRateBigInt) / BigInt(365 * 10000);
                  const secondsPerDay = 86400;
                  const yieldPerSecond = dailyYield / BigInt(secondsPerDay);
                  const maxSeconds = 365 * secondsPerDay;
                  const secondsToCalculate = Math.min(timeElapsedSeconds, maxSeconds);
                  const propertyEstimatedYield = yieldPerSecond * BigInt(Math.floor(secondsToCalculate));
                  totalPending += propertyEstimatedYield;
                  
                  // Verification logging
                  console.log(`  Property #${prop.tokenId} (${prop.propertyType}):`, {
                    yieldSource: yieldSource,
                    value: `${Number(valueToUse) / 1e18} TYCOON ${yieldSource === 'RWA' ? '(from RWA)' : '(from property)'}`,
                    yieldRate: `${yieldRateToUse / 100}% APY ${yieldSource === 'RWA' ? '(from RWA)' : '(from property)'}`,
                    createdAt: prop.createdAt.toISOString(),
                    elapsed: `${timeElapsedDays.toFixed(2)} days (${timeElapsedHours.toFixed(2)} hours)`,
                    hoursUntilClaimable: isClaimable ? '0 (READY!)' : `${hoursRemaining.toFixed(2)} hours`,
                    isClaimable: isClaimable,
                    dailyYield: `${Number(dailyYield) / 1e18} TYCOON/day`,
                    estimatedYield: `${Number(propertyEstimatedYield) / 1e18} TYCOON`,
                    formula: `(${Number(valueToUse) / 1e18}  ${yieldRateToUse / 100}%) / 365 days  ${timeElapsedDays.toFixed(2)} days`,
                    note: yieldSource === 'RWA' 
                      ? ' Using RWA yield (real rental income)' 
                      : 'Contract requires 24 hours (YIELD_UPDATE_INTERVAL) before yield becomes claimable',
                  });
                }
              }
            }
            
            console.log(` Total estimated yield: ${totalPending.toString()} wei (${Number(totalPending) / 1e18} TYCOON)`);
            setTotalPendingYield(totalPending);
            setIsLoading(false);
            return; // Successfully loaded from backend
          }
        }
      } catch (error) {
        console.warn(' Backend unavailable, falling back to blockchain:', error);
      }
      
      // Fallback to blockchain if backend fails
      console.log(' Falling back to blockchain loading...');
      
      // Get token IDs directly from contract
      let tokenIds: readonly bigint[] | bigint[] = [];
      try {
        const fetchedIds = await getOwnerProperties(address as `0x${string}`);
        tokenIds = Array.isArray(fetchedIds) ? [...fetchedIds] : [];
      
      if (tokenIds.length === 0) {
          setProperties([]);
          setTotalPendingYield(BigInt(0));
          setTotalYieldEarned(BigInt(0));
          setIsLoading(false);
          return;
        }
      } catch (error: any) {
        console.error(' Failed to get owner properties from contract:', error);
        setProperties([]);
        setTotalPendingYield(BigInt(0));
        setTotalYieldEarned(BigInt(0));
        setIsLoading(false);
        return;
      }
      
      // Deduplicate tokenIds
      const uniqueTokenIds = Array.from(new Set(tokenIds.map(id => Number(id))));
      
      // Filter out listed properties by checking ownerOf for each property
      // Listed properties are owned by the marketplace contract
      const marketplaceAddress = CONTRACTS.Marketplace.toLowerCase();
      const ownedTokenIds: number[] = [];
      
      console.log(` Checking ownership for ${uniqueTokenIds.length} properties...`);
      for (const tokenId of uniqueTokenIds) {
        try {
          const currentOwner = await readContract(config, {
            address: CONTRACTS.PropertyNFT,
            abi: PROPERTY_NFT_ABI,
            functionName: 'ownerOf',
            args: [BigInt(tokenId)],
          }) as `0x${string}`;
          
          const ownerLower = currentOwner.toLowerCase();
          const isOwnedByUser = ownerLower === address.toLowerCase();
          const isListed = ownerLower === marketplaceAddress;
          
          console.log(`Property ${tokenId}: owner=${currentOwner}, isOwnedByUser=${isOwnedByUser}, isListed=${isListed}`);
          
          if (isOwnedByUser && !isListed) {
            ownedTokenIds.push(tokenId);
            console.log(` Property ${tokenId} is owned by user`);
          } else {
            console.log(` Property ${tokenId} excluded: ${isListed ? 'listed (owned by marketplace)' : 'owned by different address'}`);
          }
      } catch (error) {
          console.warn(`Failed to check ownerOf for property ${tokenId}:`, error);
          // If ownerOf fails, include it (better to show than hide)
          ownedTokenIds.push(tokenId);
        }
      }
      
      console.log(` Filtered to ${ownedTokenIds.length} properties actually owned by user (excluded ${uniqueTokenIds.length - ownedTokenIds.length} listed/transferred)`);
      
      // Map properties from blockchain (only owned ones)
      const mappedProperties: Property[] = await Promise.all(
        ownedTokenIds.map(async (tokenId: number, index: number) => {
          try {
            const propData = await readContract(config, {
            address: CONTRACTS.PropertyNFT,
            abi: PROPERTY_NFT_ABI,
            functionName: 'getProperty',
            args: [BigInt(tokenId)],
            }) as {
              propertyType: bigint | number;
              value: bigint;
              yieldRate: bigint;
              rwaContract: string;
              rwaTokenId: bigint;
              totalYieldEarned: bigint;
              createdAt: bigint;
              isActive: boolean;
            };

            // Convert yieldRate
          const yieldRateRaw = propData.yieldRate;
          const yieldRateBigInt = typeof yieldRateRaw === 'bigint' 
            ? yieldRateRaw 
            : BigInt(String(yieldRateRaw));
          let yieldRateValue = Number(yieldRateBigInt);
          
          if (yieldRateValue < 100 && yieldRateValue > 0) {
            yieldRateValue = yieldRateValue * 100;
          } else if (yieldRateValue > 1e15) {
            yieldRateValue = Number(yieldRateBigInt) / 1e18 * 100;
          }
          
          if (yieldRateValue < 100) {
              yieldRateValue = 500;
            }

            // Convert createdAt from BigInt (seconds) to Date
            // Contract stores block.timestamp (Unix timestamp in seconds)
            const createdAtTimestamp = Number(propData.createdAt);
            const createdAtDate = new Date(createdAtTimestamp * 1000); // Convert seconds to milliseconds
            
            // Verify timestamp is reasonable (not in the future, not too old)
            const now = Date.now();
            const createdAtMs = createdAtDate.getTime();
            const timeDiff = now - createdAtMs;
            
            if (timeDiff < 0) {
              console.warn(` Property #${tokenId}: createdAt is in the future! Contract timestamp: ${createdAtTimestamp}, Date: ${createdAtDate.toISOString()}`);
            } else if (timeDiff > 365 * 24 * 60 * 60 * 1000) {
              console.warn(` Property #${tokenId}: createdAt is more than 1 year old! Contract timestamp: ${createdAtTimestamp}, Date: ${createdAtDate.toISOString()}`);
            }
            
            // Try to verify against blockchain event (optional, for verification)
            let eventBlockTimestamp: number | null = null;
            try {
              const publicClient = getPublicClient(config);
              if (publicClient) {
                // Query PropertyCreated event for this tokenId
                const events = await publicClient.getLogs({
                  address: CONTRACTS.PropertyNFT,
                  event: parseAbiItem('event PropertyCreated(uint256 indexed tokenId, address indexed owner, uint8 propertyType, uint256 value)'),
                  args: {
                    tokenId: BigInt(tokenId),
                  },
                  fromBlock: 0n,
                });
                
                if (events.length > 0) {
                  // Get the block timestamp from the event
                  const block = await getBlock(config, { blockNumber: events[0].blockNumber });
                  eventBlockTimestamp = Number(block.timestamp);
                  console.log(` Property #${tokenId} event verification:`, {
                    eventBlockNumber: events[0].blockNumber.toString(),
                    eventBlockTimestamp: eventBlockTimestamp,
                    eventBlockDate: new Date(eventBlockTimestamp * 1000).toISOString(),
                    contractCreatedAt: createdAtTimestamp,
                    contractCreatedAtDate: createdAtDate.toISOString(),
                    match: eventBlockTimestamp === createdAtTimestamp ? ' MATCH' : ' MISMATCH',
                    difference: eventBlockTimestamp !== createdAtTimestamp ? `${Math.abs(eventBlockTimestamp - createdAtTimestamp)} seconds` : '0 seconds',
                  });
                }
              }
            } catch (error) {
              // Event query failed - that's okay, we'll use contract timestamp
              console.log(` Property #${tokenId}: Could not verify via event (non-critical):`, error);
            }
            
            console.log(` Property #${tokenId} timestamp from contract:`, {
              contractTimestamp: createdAtTimestamp,
              contractTimestampHex: `0x${createdAtTimestamp.toString(16)}`,
              convertedDate: createdAtDate.toISOString(),
              currentTime: new Date().toISOString(),
              elapsedHours: (timeDiff / (1000 * 60 * 60)).toFixed(2),
              elapsedDays: (timeDiff / (1000 * 60 * 60 * 24)).toFixed(2),
              note: 'This timestamp is set once during minting and is immutable (see PropertyNFT.sol line 51)',
            });

            const property = {
            id: `prop-${tokenId}`,
            tokenId: tokenId,
            propertyType: ['Residential', 'Commercial', 'Industrial', 'Luxury'][Number(propData.propertyType)] as Property['propertyType'],
            value: BigInt(propData.value.toString()),
              yieldRate: yieldRateValue,
            totalYieldEarned: BigInt(propData.totalYieldEarned.toString()),
              createdAt: createdAtDate, // Store creation date for yield calculation
              x: index % 10,
              y: Math.floor(index / 10),
            rwaContract: propData.rwaContract !== '0x0000000000000000000000000000000000000000' ? propData.rwaContract : undefined,
            rwaTokenId: propData.rwaTokenId ? Number(propData.rwaTokenId) : undefined,
              isOwned: true,
            };
            
            return property;
          } catch (error) {
            console.error(` Failed to load property ${tokenId}:`, error);
            return {
              id: `prop-${tokenId}`,
              tokenId: tokenId,
              propertyType: 'Residential' as Property['propertyType'],
              value: BigInt(0),
              yieldRate: 500,
              totalYieldEarned: BigInt(0),
              x: index % 10,
              y: Math.floor(index / 10),
              isOwned: true,
            };
          }
        })
      );

      // Filter out any failed properties (shouldn't happen, but just in case)
      const validProperties = mappedProperties.filter(p => p !== null && p.value > 0);
      console.log(` Successfully loaded ${validProperties.length} properties from blockchain`);
      
      // Calculate claimable yield from contract (requires 24 hours) - PER PROPERTY
      let totalClaimable = BigInt(0);
      const claimableYieldsMap = new Map<number, bigint>();
      const claimablePromises = validProperties.map(async (prop) => {
        try {
          const yieldPromise = calculateYield(BigInt(prop.tokenId));
          const timeoutPromise = new Promise<bigint>((resolve) => {
            setTimeout(() => resolve(BigInt(0)), 2000);
          });
          const yieldAmount = await Promise.race([yieldPromise, timeoutPromise]);
          const claimable = typeof yieldAmount === 'bigint' ? yieldAmount : BigInt(yieldAmount?.toString() || '0');
          claimableYieldsMap.set(prop.tokenId, claimable);
          return claimable;
        } catch (error) {
          claimableYieldsMap.set(prop.tokenId, BigInt(0));
          return BigInt(0);
        }
      });
      const claimableYields = await Promise.all(claimablePromises);
      totalClaimable = claimableYields.reduce((sum, y) => sum + y, BigInt(0));
      setClaimableYield(totalClaimable);
      setPropertyClaimableYields(claimableYieldsMap);
      console.log(` Total claimable yield: ${totalClaimable.toString()} wei (${Number(totalClaimable) / 1e18} TYCOON)`);
      
      // Calculate estimated yield directly from blockchain data (real-time, works even if backend is down)
      // This calculates yield based on time elapsed since property creation - WITH VERIFICATION
      let totalPending = BigInt(0);
      const now = Date.now();
      
      console.log(' YIELD CALCULATION VERIFICATION (Blockchain Path):');
      for (const prop of validProperties) {
        if (prop.createdAt) {
          const timeElapsedMs = now - prop.createdAt.getTime();
          const timeElapsedSeconds = timeElapsedMs / 1000;
          const timeElapsedHours = timeElapsedSeconds / 3600;
          const timeElapsedDays = timeElapsedHours / 24;
          
          if (timeElapsedSeconds > 0) {
            // Calculate daily yield: (value * yieldRate) / (365 * 10000)
            // yieldRate is in basis points (500 = 5% APY)
            const yieldRateBigInt = BigInt(Math.floor(prop.yieldRate));
            const dailyYield = (prop.value * yieldRateBigInt) / BigInt(365 * 10000);
            const secondsPerDay = 86400;
            const yieldPerSecond = dailyYield / BigInt(secondsPerDay);
            
            // Calculate estimated yield for elapsed seconds (cap at 365 days)
            const maxSeconds = 365 * secondsPerDay;
            const secondsToCalculate = Math.min(timeElapsedSeconds, maxSeconds);
            const propertyEstimatedYield = yieldPerSecond * BigInt(Math.floor(secondsToCalculate));
            totalPending += propertyEstimatedYield;
            
            // Verification logging
            const claimableForProp = claimableYieldsMap.get(prop.tokenId) || BigInt(0);
            console.log(`  Property #${prop.tokenId} (${prop.propertyType}):`, {
              value: `${Number(prop.value) / 1e18} TYCOON`,
              yieldRate: `${prop.yieldRate / 100}% APY`,
              createdAt: prop.createdAt.toISOString(),
              elapsed: `${timeElapsedDays.toFixed(2)} days (${timeElapsedHours.toFixed(2)} hours)`,
              dailyYield: `${Number(dailyYield) / 1e18} TYCOON/day`,
              estimatedYield: `${Number(propertyEstimatedYield) / 1e18} TYCOON`,
              claimableYield: `${Number(claimableForProp) / 1e18} TYCOON`,
              formula: `(${Number(prop.value) / 1e18}  ${prop.yieldRate / 100}%) / 365 days  ${timeElapsedDays.toFixed(2)} days`,
            });
          }
        }
      }
      
      console.log(` Total estimated yield: ${totalPending.toString()} wei (${Number(totalPending) / 1e18} TYCOON)`);
      
      // Try backend for additional data (optional, non-blocking)
      try {
        const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';
        const yieldResponse = await fetch(`${BACKEND_URL}/yield/pending/${address}`, {
          signal: AbortSignal.timeout(2000), // 2 second timeout (non-blocking)
        });
        
        if (yieldResponse.ok) {
          const yieldData = await yieldResponse.json();
          const backendYield = BigInt(yieldData.totalPending || '0');
          // Use backend value if it's higher (more accurate) or if our calculation is 0
          if (backendYield > totalPending || totalPending === BigInt(0)) {
            totalPending = backendYield;
            console.log(` Using backend yield: ${yieldData.formatted} TYCOON`);
          }
        }
      } catch (error) {
        // Backend unavailable - that's okay, we have blockchain calculation
        console.log(' Backend yield unavailable, using blockchain calculation');
      }
      
      setTotalPendingYield(totalPending);
      
      console.log(` Properties breakdown:`, {
        total: mappedProperties.length,
        valid: validProperties.length,
        invalid: mappedProperties.length - validProperties.length,
        propertyDetails: validProperties.map(p => ({
          tokenId: p.tokenId,
          type: p.propertyType,
          value: p.value.toString(),
        })),
      });

      if (validProperties.length === 0 && mappedProperties.length > 0) {
        console.warn(' All properties were filtered out! Check property values:', mappedProperties);
      }

      setProperties(validProperties);

      // Calculate total earned
      const totalEarned = validProperties.reduce((sum, p) => sum + p.totalYieldEarned, BigInt(0));
      setTotalYieldEarned(totalEarned);
      
      console.log(` Total pending yield: ${totalPending.toString()}, Total earned: ${totalEarned.toString()}`);
    } catch (error) {
      console.error('Failed to load properties:', error);
    } finally {
      setIsLoading(false);
    }
  }, [address, isConnected]);
  
  // Load token balance using wagmi hook (reactive)
  const { data: tokenBalance, refetch: refetchBalance } = useReadContract({
    address: CONTRACTS.GameToken,
    abi: [
      {
        inputs: [{ name: 'account', type: 'address' }],
        name: 'balanceOf',
        outputs: [{ name: '', type: 'uint256' }],
        stateMutability: 'view',
        type: 'function',
      },
    ],
    functionName: 'balanceOf',
    args: address ? [address] : undefined,
    query: {
      enabled: !!address,
      refetchInterval: 10000, // Refetch every 10 seconds
    },
  });

  // Update token balance value when data changes
  useEffect(() => {
    if (tokenBalance !== undefined) {
      const balance = BigInt(tokenBalance.toString());
      console.log(' Token balance updated:', balance.toString());
      setTokenBalanceValue(balance);
    } else if (address) {
      // If address exists but balance is undefined, try manual fetch
      const loadBalance = async () => {
        try {
          const balance = await readContract(config, {
        address: CONTRACTS.GameToken,
        abi: [
          {
            inputs: [{ name: 'account', type: 'address' }],
            name: 'balanceOf',
            outputs: [{ name: '', type: 'uint256' }],
            stateMutability: 'view',
            type: 'function',
          },
        ],
        functionName: 'balanceOf',
        args: [address],
          }) as bigint;
          console.log(' Manual balance fetch:', balance.toString());
      setTokenBalanceValue(BigInt(balance.toString()));
    } catch (error) {
          console.error(' Failed to load token balance:', error);
      setTokenBalanceValue(BigInt(0));
    }
      };
      loadBalance();
    }
  }, [tokenBalance, address]);

  // Mint property transaction
  const { writeContract: writeMint, data: mintHash, isPending: isMintPending } = useWriteContract();
  const { writeContract: writeApprove, data: approveHash, isPending: isApprovePending } = useWriteContract();
  
  // Check TYCOON token allowance
  const { data: tokenAllowance } = useReadContract({
    address: CONTRACTS.GameToken,
    abi: [
      {
        name: 'allowance',
        type: 'function',
        stateMutability: 'view',
        inputs: [
          { name: 'owner', type: 'address' },
          { name: 'spender', type: 'address' },
        ],
        outputs: [{ name: '', type: 'uint256' }],
      },
    ],
    functionName: 'allowance',
    args: address ? [address, CONTRACTS.PropertyNFT] : undefined,
    query: { enabled: !!address },
  });
  
  // Wait for approve transaction
  const { isLoading: isApproveConfirming, isSuccess: isApproveSuccess } = useWaitForTransactionReceipt({
    hash: approveHash,
  });
  
  // Auto-purchase property after approval succeeds
  useEffect(() => {
    if (isApproveSuccess && pendingPropertyType && address) {
      const propertyTypes: Record<string, number> = {
        Residential: 0,
        Commercial: 1,
        Industrial: 2,
        Luxury: 3,
      };
      
      const propertyCosts: Record<string, bigint> = {
        Residential: parseEther('100'),
        Commercial: parseEther('200'),
        Industrial: parseEther('500'),
        Luxury: parseEther('1000'),
      };
      
      const yieldRates: Record<string, bigint> = {
        Residential: BigInt(500),
        Commercial: BigInt(800),
        Industrial: BigInt(1200),
        Luxury: BigInt(1500),
      };
      
      console.log(`Approval successful, purchasing ${pendingPropertyType} property...`);
      writeMint({
        address: CONTRACTS.PropertyNFT,
        abi: PROPERTY_NFT_ABI,
        functionName: 'purchaseProperty',
        args: [propertyTypes[pendingPropertyType], propertyCosts[pendingPropertyType], yieldRates[pendingPropertyType]],
      });
      setPendingPropertyType(null);
      setShowBuildMenu(false);
    }
  }, [isApproveSuccess, pendingPropertyType, address, writeMint]);
  
  // Claim yield transaction
  const { writeContract: writeClaim, data: claimHash, isPending: isClaimPending } = useWriteContract();

  // Wait for mint transaction
  const { isLoading: isMintConfirming, isSuccess: isMintSuccess } = useWaitForTransactionReceipt({
    hash: mintHash,
  });

  // Wait for claim transaction
  const { isLoading: isClaimConfirming, isSuccess: isClaimSuccess } = useWaitForTransactionReceipt({
    hash: claimHash,
  });

  // Reload properties when mint succeeds and assign coordinates automatically
  useEffect(() => {
    if (isMintSuccess) {
      const refreshData = async () => {
        // Wait for event indexer to process
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Refresh properties to get the new one
        await loadProperties();
        
        // Get the latest property token ID and assign coordinates automatically
        try {
          const tokenIds = await getOwnerProperties(address as `0x${string}`);
          if (tokenIds.length > 0) {
            const latestTokenId = Number(tokenIds[tokenIds.length - 1]);
            
            // Find next available position on the map (simple grid placement)
            // Use index-based positioning (NO BACKEND NEEDED)
            const propertyCount = properties.length;
            const x = propertyCount % 10;
            const y = Math.floor(propertyCount / 10);
            
                  console.log(`Auto-placed property ${latestTokenId} at (${x}, ${y})`);
            
            // Optionally save coordinates to backend (non-blocking)
            api.put(`/properties/${latestTokenId}/coordinates`, { x, y }).catch(() => {
              // Backend unavailable - that's okay, we use index-based positioning
            });
          }
        } catch (error) {
          console.error('Failed to assign coordinates:', error);
        }
        
        // Refresh balance
        refetchBalance();
        await new Promise(resolve => setTimeout(resolve, 1000));
        refetchBalance();
        
        // Reload properties again to show the new position
        await loadProperties();
      };
      
      refreshData();
      setIsMinting(false);
    }
  }, [isMintSuccess, address, loadProperties, refetchBalance]);

  // Reload properties when claim succeeds
  useEffect(() => {
    if (isClaimSuccess) {
      loadProperties();
      refetchBalance();
      setIsClaiming(false);
    }
  }, [isClaimSuccess, loadProperties, refetchBalance]);
  
  // Load properties on mount and when address changes
  useEffect(() => {
    if (address && isConnected) {
      console.log('Loading properties on mount/address change');
      loadProperties();
    }
  }, [address, isConnected, loadProperties]);

  // Refetch balance when address changes
  useEffect(() => {
    if (address) {
      refetchBalance();
    }
  }, [address, refetchBalance]);

  // WebSocket for real-time updates (replaces periodic refresh)
  useEffect(() => {
    if (!address || !isConnected) return;

    const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL 
      ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') 
      : 'http://localhost:3001';

    const socket: Socket = io(BACKEND_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
    });

    socket.on('connect', () => {
      console.log(' Connected to WebSocket for real-time updates');
      // Subscribe to portfolio updates for this address
      socket.emit('subscribe:portfolio', { address });
      console.log(` Subscribed to portfolio: ${address}`);
    });

    socket.on('connect_error', (error) => {
      console.error(' WebSocket connection error:', error);
    });

    // Listen for property created events
    socket.on('property:created', (data: { propertyId: string; owner: string; propertyType: string }) => {
      if (data.owner.toLowerCase() === address?.toLowerCase()) {
        console.log(' New property created, refreshing...');
        loadProperties();
        refetchBalance();
      }
    });

    // Listen for yield claimed events
    socket.on('yield:claimed', (data: { propertyId: string; owner: string; amount: string }) => {
      if (data.owner.toLowerCase() === address?.toLowerCase()) {
        console.log(' Yield claimed, refreshing...');
        loadProperties();
        refetchBalance();
      }
    });

    // Listen for yield time updates (real-time countdown from backend)
    socket.on('yield:time-update', (data: {
      walletAddress: string;
      yieldUpdateIntervalSeconds: number;
      currentBlockTimestamp: number;
      shortestTimeRemaining: { hours: number; minutes: number } | null;
      totalClaimableYield: string;
      properties: Array<{
        tokenId: number;
        lastYieldUpdate: number;
        createdAt: number;
        timeElapsedSeconds: number;
        timeElapsedHours: number;
        hoursRemaining: number;
        minutesRemaining: number;
        isClaimable: boolean;
        claimableYield: string;
      }>;
    }) => {
      console.log(' Received yield:time-update event:', {
        receivedAddress: data.walletAddress,
        currentAddress: address,
        match: data.walletAddress.toLowerCase() === address?.toLowerCase(),
        propertiesCount: data.properties.length,
      });
      
      if (data.walletAddress.toLowerCase() === address?.toLowerCase()) {
        console.log(' Yield time update received from backend:', data);
        
        // Update claimable yield from backend (more reliable than blockchain calls)
        const claimable = BigInt(data.totalClaimableYield || '0');
        
        // Validate claimable yield from backend (prevent showing corrupted values)
        const MAX_REASONABLE_YIELD = BigInt('1000000000000000000000'); // 1000 TYCOON
        if (claimable > MAX_REASONABLE_YIELD) {
          console.warn(' Backend returned suspiciously large claimable yield, resetting to 0:', claimable.toString());
          setClaimableYield(BigInt(0));
        } else {
          setClaimableYield(claimable);
        }
        
        // Update property claimable yields map
        const newClaimableYieldsMap = new Map<number, bigint>();
        const newTimeRemainingMap = new Map<number, { hours: number; minutes: number; isClaimable: boolean }>();
        
        data.properties.forEach((prop) => {
          newClaimableYieldsMap.set(prop.tokenId, BigInt(prop.claimableYield || '0'));
          newTimeRemainingMap.set(prop.tokenId, {
            hours: prop.hoursRemaining,
            minutes: prop.minutesRemaining,
            isClaimable: prop.isClaimable,
          });
        });
        
        setPropertyClaimableYields(newClaimableYieldsMap);
        (window as any).propertyTimeRemaining = newTimeRemainingMap;
        
        // Force re-render of YieldDisplay by updating timestamp
        setYieldUpdateTimestamp(Date.now());
        
        // Update estimated yield (calculate from backend data with RWA support)
        // Calculate asynchronously since we need to fetch RWA data
        (async () => {
          // Use current properties state - if empty, wait for properties to load
          const currentProperties = properties;
          if (!currentProperties || currentProperties.length === 0) {
            console.log(' WebSocket: No properties loaded yet, skipping yield calculation');
            return;
          }
          
          let totalEstimated = BigInt(0);
          
          // RWA ABI for fetching RWA data
          const RWA_ABI = [
            {
              inputs: [{ name: '', type: 'uint256' }],
              name: 'properties',
              outputs: [
                { name: 'name', type: 'string' },
                { name: 'value', type: 'uint256' },
                { name: 'monthlyYield', type: 'uint256' },
                { name: 'location', type: 'string' },
                { name: 'createdAt', type: 'uint256' },
                { name: 'isActive', type: 'bool' },
              ],
              stateMutability: 'view',
              type: 'function',
            },
            {
              inputs: [{ name: 'tokenId', type: 'uint256' }],
              name: 'getYieldRate',
              outputs: [{ name: '', type: 'uint256' }],
              stateMutability: 'view',
              type: 'function',
            },
          ] as const;
          
          // Calculate estimated yield for each property (with RWA support)
          for (const prop of currentProperties) {
            const propData = data.properties.find((p) => p.tokenId === prop.tokenId);
            if (propData && prop.createdAt) {
              let valueToUse = prop.value;
              let yieldRateToUse = prop.yieldRate;
              
              // Check if property is linked to RWA - use RWA data for yield calculation
              if (prop.rwaContract && prop.rwaContract !== '0x0000000000000000000000000000000000000000' && prop.rwaTokenId !== undefined) {
                try {
                  const publicClient = getPublicClient(config);
                  if (publicClient) {
                    // Fetch RWA property data
                    const rwaProperty = await publicClient.readContract({
                      address: prop.rwaContract as `0x${string}`,
                      abi: RWA_ABI,
                      functionName: 'properties',
                      args: [BigInt(prop.rwaTokenId)],
                    }) as [string, bigint, bigint, string, bigint, boolean];
                    
                    // Fetch RWA yield rate
                    const rwaYieldRate = await publicClient.readContract({
                      address: prop.rwaContract as `0x${string}`,
                      abi: RWA_ABI,
                      functionName: 'getYieldRate',
                      args: [BigInt(prop.rwaTokenId)],
                    }) as bigint;
                    
                    const [rwaName, rwaValue, rwaMonthlyYield, rwaLocation, rwaCreatedAt, rwaIsActive] = rwaProperty;
                    
                    if (rwaIsActive && rwaValue > BigInt(0) && rwaYieldRate > BigInt(0)) {
                      valueToUse = rwaValue;
                      yieldRateToUse = Number(rwaYieldRate);
                      console.log(` WebSocket: Property #${prop.tokenId} using RWA yield (${Number(rwaValue) / 1e18} TYCOON, ${Number(rwaYieldRate) / 100}% APY)`);
                    }
                  }
                } catch (error) {
                  // If RWA fetch fails, use property data
                  console.warn(` Property #${prop.tokenId}: Failed to fetch RWA data in WebSocket update, using property data:`, error);
                }
              }
              
              // Calculate estimated yield: dailyYield  (timeElapsedHours / 24)
              const dailyYield = (valueToUse * BigInt(yieldRateToUse)) / BigInt(365 * 10000);
              const hoursElapsed = propData.timeElapsedHours;
              const daysElapsed = hoursElapsed / 24;
              const estimatedYield = (dailyYield * BigInt(Math.floor(daysElapsed * 100))) / BigInt(100);
              totalEstimated += estimatedYield;
            }
          }
          
          setTotalPendingYield(totalEstimated);
          console.log(` WebSocket: Updated estimated yield to ${totalEstimated.toString()} wei (${Number(totalEstimated) / 1e18} TYCOON)`);
        })();
        
        console.log(' Updated yield data from backend WebSocket:', {
          claimable: claimable.toString(),
          shortestTimeRemaining: data.shortestTimeRemaining,
          propertiesCount: data.properties.length,
        });
      }
    });

    // Listen for portfolio updates
    socket.on('portfolio:updated', () => {
      console.log(' Portfolio updated, refreshing...');
      loadProperties();
      refetchBalance();
    });

    socket.on('disconnect', () => {
      console.log(' Disconnected from WebSocket');
    });

    return () => {
      socket.disconnect();
    };
  }, [address, isConnected, loadProperties, refetchBalance]);

  // No periodic refresh - only refresh on:
  // 1. User actions (mint, claim)
  // 2. WebSocket events (real-time updates)
  // This prevents constant loading and improves UX

  // Load other players' properties for multiplayer view (OPTIONAL - backend only)
  // Note: This is for viewing other players' properties on the map
  // Since we're blockchain-first, this is optional and only works if backend has data
  const loadOtherPlayersProperties = useCallback(async () => {
    if (!address) return;
    try {
      // Try to get other players' properties from backend (optional)
      const allProperties = await api.get('/properties').catch(() => []);
      if (allProperties.length === 0) {
        // Backend unavailable or no data - that's okay, we'll just show user's properties
        return;
      }
      
      const otherProps = allProperties
        .filter((p: any) => {
          const ownerAddr = p.owner?.walletAddress || p.owner?.wallet_address;
          return ownerAddr?.toLowerCase() !== address?.toLowerCase();
        })
        .slice(0, 50) // Limit to 50 other properties for performance
        .map((p: any) => {
          const ownerAddr = p.owner?.walletAddress || p.owner?.wallet_address || '';
          // Use coordinates from backend if available, otherwise skip (properties without coordinates aren't placed)
          if (p.x === null || p.x === undefined || p.y === null || p.y === undefined) {
            return null;
          }
          return {
            id: `other-prop-${p.tokenId}`,
            tokenId: Number(p.tokenId),
            propertyType: p.propertyType as Property['propertyType'],
            value: BigInt(p.value?.toString() || '0'),
            yieldRate: Number(p.yieldRate || 0),
            totalYieldEarned: BigInt(p.totalYieldEarned?.toString() || '0'),
            x: Number(p.x),
            y: Number(p.y),
            owner: ownerAddr,
            isOwned: false,
          };
        })
        .filter((p: any) => p !== null); // Remove properties without coordinates
      setOtherPlayersProperties(otherProps);
    } catch (error) {
      console.error('Failed to load other players properties:', error);
      setOtherPlayersProperties([]);
    }
  }, [address]);

  // Load properties on mount and when address changes
  useEffect(() => {
    if (address && isConnected) {
      loadProperties();
      loadOtherPlayersProperties();
    }
  }, [address, isConnected, loadProperties, loadOtherPlayersProperties]);

  if (!isConnected || !address) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-white mb-4">Connect Your Wallet</h1>
          <p className="text-gray-400 mb-8">Connect your wallet to start building your property empire</p>
          <WalletConnect />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
      {/* Header */}
      <header className="border-b border-white/10 bg-white/5 backdrop-blur-md sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-white">Property Tycoon</h1>
            <p className="text-sm text-gray-400">Build your real estate empire</p>
          </div>
          <div className="flex items-center gap-4">
            <Button
              onClick={() => setShowGuide(true)}
              variant="outline"
              className="border-blue-500/50 text-blue-400 hover:bg-blue-500/10"
            >
              <BookOpen className="w-4 h-4 mr-2" />
              How to Play
            </Button>
            <Link href="/leaderboard">
            <Button
              variant="outline"
              className="border-purple-500/50 text-purple-400 hover:bg-purple-500/10"
            >
              <Trophy className="w-4 h-4 mr-2" />
              Leaderboard
            </Button>
            </Link>
            <Button
              onClick={() => setShowGuilds(!showGuilds)}
              variant="outline"
              className="border-green-500/50 text-green-400 hover:bg-green-500/10"
            >
              <Users className="w-4 h-4 mr-2" />
              Guilds
            </Button>
            <Button
              onClick={() => setShowMarketplace(!showMarketplace)}
              variant="outline"
              className="border-orange-500/50 text-orange-400 hover:bg-orange-500/10"
            >
              <ShoppingBag className="w-4 h-4 mr-2" />
              Marketplace
            </Button>
            <Button
              onClick={() => setShowQuests(!showQuests)}
              variant="outline"
              className="border-yellow-500/50 text-yellow-400 hover:bg-yellow-500/10"
            >
              <Target className="w-4 h-4 mr-2" />
              Quests
            </Button>
            <WalletConnect />
            {isConnected && (
              <Button
                onClick={() => setShowProfile(true)}
                className="bg-purple-600 hover:bg-purple-700 text-white"
              >
                <User className="w-4 h-4 mr-2" />
                Profile
              </Button>
            )}
            <Button
              onClick={() => setShowChat(true)}
              className="bg-emerald-600 hover:bg-emerald-700 text-white"
            >
              <MessageSquare className="w-4 h-4 mr-2" />
              Chat
            </Button>
          </div>
        </div>
      </header>

      {/* Main Game Area */}
      <main className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          {/* Left Sidebar */}
          <div className="lg:col-span-1 space-y-6">
            <YieldDisplay
              key={yieldUpdateTimestamp} // Force re-render when WebSocket updates
              totalPendingYield={totalPendingYield}
              claimableYield={claimableYield}
              totalYieldEarned={totalYieldEarned}
              isClaiming={isClaiming || isClaimPending || isClaimConfirming}
              onClaimAll={async () => {
                if (!address || properties.length === 0) return;
                try {
                  setIsClaiming(true);
                  const propertyIds = properties.map(p => BigInt(p.tokenId));
                  console.log(' Claiming yield for properties:', propertyIds.map(id => id.toString()));
                  console.log(' Property details:', properties.map(p => ({ tokenId: p.tokenId, propertyType: p.propertyType })));
                  writeClaim({
                    address: CONTRACTS.YieldDistributor,
                    abi: YIELD_DISTRIBUTOR_ABI,
                    functionName: 'batchClaimYield',
                    args: [propertyIds],
                  });
                } catch (error) {
                  console.error('Failed to claim yield:', error);
                  setIsClaiming(false);
                }
              }}
            />

            <Button
              onClick={() => setShowTokenPurchase(!showTokenPurchase)}
              className="w-full bg-emerald-600 hover:bg-emerald-700 mb-2"
            >
              <Coins className="w-4 h-4 mr-2" />
              {showTokenPurchase ? 'Close Token Purchase' : 'Buy TYCOON Tokens'}
            </Button>

            {showTokenPurchase && (
              <div className="mb-4">
                <TokenPurchase />
              </div>
            )}

            <Button
              onClick={() => setShowBuildMenu(!showBuildMenu)}
              className="w-full bg-blue-600 hover:bg-blue-700"
            >
              <Building2 className="w-4 h-4 mr-2" />
              {showBuildMenu ? 'Close Build Menu' : 'Build Property'}
            </Button>

            {showBuildMenu && (
              <BuildMenu
                tokenBalance={tokenBalanceValue}
                isMinting={isMinting || isMintPending || isMintConfirming}
                onBuildProperty={async (type: 'Residential' | 'Commercial' | 'Industrial' | 'Luxury') => {
                  // Mint property immediately without tile selection
                  if (!address) return;
                  
                  const propertyTypes: Record<string, number> = {
                    Residential: 0,
                    Commercial: 1,
                    Industrial: 2,
                    Luxury: 3,
                  };
                  
                  const propertyCosts: Record<string, bigint> = {
                    Residential: parseEther('100'),
                    Commercial: parseEther('200'),
                    Industrial: parseEther('500'),
                    Luxury: parseEther('1000'),
                  };
                  
                  const yieldRates: Record<string, bigint> = {
                    Residential: BigInt(500), // 5% APY in basis points
                    Commercial: BigInt(800), // 8% APY in basis points
                    Industrial: BigInt(1200), // 12% APY in basis points
                    Luxury: BigInt(1500), // 15% APY in basis points
                  };

                  try {
                    setIsMinting(true);
                    const cost = propertyCosts[type];
                    const currentAllowance = (tokenAllowance as bigint) || BigInt(0);
                    
                    // If allowance is insufficient, approve first
                    if (currentAllowance < cost) {
                      console.log(`Approving ${cost.toString()} TYCOON tokens for PropertyNFT...`);
                      setPendingPropertyType(type); // Store property type for auto-purchase after approval
                      writeApprove({
                        address: CONTRACTS.GameToken,
                        abi: [
                          {
                            name: 'approve',
                            type: 'function',
                            stateMutability: 'nonpayable',
                            inputs: [
                              { name: 'spender', type: 'address' },
                              { name: 'amount', type: 'uint256' },
                            ],
                            outputs: [{ name: '', type: 'bool' }],
                          },
                        ],
                        functionName: 'approve',
                        args: [CONTRACTS.PropertyNFT, cost],
                      });
                      // Wait for approval to complete before purchasing
                      // The useEffect hook will handle the purchase after approval succeeds
                      return;
                    }
                    
                    // Purchase property (this will transfer TYCOON tokens and mint NFT)
                    console.log(`Purchasing ${type} property for ${cost.toString()} TYCOON...`);
                    writeMint({
                      address: CONTRACTS.PropertyNFT,
                      abi: PROPERTY_NFT_ABI,
                      functionName: 'purchaseProperty',
                      args: [propertyTypes[type], propertyCosts[type], yieldRates[type]],
                    });
                    setShowBuildMenu(false);
                  } catch (error) {
                    console.error('Failed to purchase property:', error);
                    setIsMinting(false);
                  }
                }}
              />
            )}
          </div>

          {/* Center - City View */}
          <div className="lg:col-span-2">
            {isLoading ? (
              <div className="w-full h-[600px] bg-gray-900 rounded-lg border border-white/10 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mx-auto mb-4" />
                  <p className="text-gray-400">Loading your portfolio...</p>
                </div>
              </div>
            ) : (
              <CityView
                properties={properties.map(p => ({
                  id: p.id,
                  tokenId: p.tokenId,
                  propertyType: p.propertyType,
                  value: p.value,
                  yieldRate: p.yieldRate,
                  x: p.x,
                  y: p.y,
                }))}
                otherPlayersProperties={otherPlayersProperties}
                onPropertyClick={(property) => {
                  const fullProperty = properties.find(p => p.id === property.id);
                  if (fullProperty) setSelectedProperty(fullProperty);
                }}
                onEmptyTileClick={(x: number, y: number) => {
                  // Empty tile clicks don't do anything now
                  // Properties are minted directly from the build menu
                }}
              />
            )}
          </div>

          {/* Right Sidebar - Property List */}
          <div className="lg:col-span-1 space-y-4">
            <h2 className="text-white font-semibold text-lg">Your Properties</h2>
            {properties.length === 0 ? (
              <div className="text-center text-gray-400 py-8">
                <Building2 className="w-12 h-12 mx-auto mb-4 opacity-50" />
                <p>No properties yet</p>
                <p className="text-sm mt-2">Build your first property to get started!</p>
              </div>
            ) : (
              <ScrollArea className="h-[600px] pr-4">
                <div className="space-y-3">
                {properties.map((property) => (
                  <PropertyCard
                    key={property.id}
                    property={property}
                    claimableYield={propertyClaimableYields.get(property.tokenId)}
                    onViewDetails={() => setSelectedProperty(property)}
                    isClaiming={isClaiming || isClaimPending || isClaimConfirming}
                    onClaimYield={async () => {
                      try {
                        setIsClaiming(true);
                        writeClaim({
                          address: CONTRACTS.YieldDistributor,
                          abi: YIELD_DISTRIBUTOR_ABI,
                          functionName: 'claimYield',
                          args: [BigInt(property.tokenId)],
                        });
                      } catch (error) {
                        console.error('Failed to claim yield:', error);
                        setIsClaiming(false);
                      }
                    }}
                  />
                ))}
              </div>
              </ScrollArea>
            )}
          </div>
        </div>
      </main>

      {/* Property Details Modal */}
      {selectedProperty && (
        <PropertyDetails
          property={selectedProperty}
          claimableYield={propertyClaimableYields.get(selectedProperty.tokenId)}
          isOpen={!!selectedProperty}
          onClose={() => setSelectedProperty(null)}
          isClaiming={isClaiming || isClaimPending || isClaimConfirming}
          onClaimYield={async () => {
            if (!selectedProperty) return;
            try {
              setIsClaiming(true);
              console.log(' Claiming yield for property:', {
                tokenId: selectedProperty.tokenId,
                propertyType: selectedProperty.propertyType,
                claimableYield: propertyClaimableYields.get(selectedProperty.tokenId)?.toString() || '0',
              });
              writeClaim({
                address: CONTRACTS.YieldDistributor,
                abi: YIELD_DISTRIBUTOR_ABI,
                functionName: 'claimYield',
                args: [BigInt(selectedProperty.tokenId)],
              });
              setSelectedProperty(null);
            } catch (error) {
              console.error('Failed to claim yield:', error);
              setIsClaiming(false);
            }
          }}
          onLinkRWA={() => {
            setShowRWALink(true);
          }}
          onSellProperty={() => {
            setPropertyToSell(selectedProperty);
            setShowSellProperty(true);
            setSelectedProperty(null);
          }}
        />
      )}

      {/* RWA Link Modal */}
      {showRWALink && selectedProperty && (
        <RWALinkModal
          isOpen={showRWALink}
          onClose={() => {
            setShowRWALink(false);
            setSelectedProperty(null);
          }}
          propertyTokenId={selectedProperty.tokenId}
          onSuccess={() => {
            // Reload properties to get updated RWA info
            console.log(' RWA linked successfully, reloading properties...');
            // Force reload after a short delay to ensure on-chain data is updated
            setTimeout(() => {
              loadProperties();
            }, 2000);
          }}
        />
      )}

      {/* User Profile */}
      {showProfile && <UserProfile isOpen={showProfile} onClose={() => setShowProfile(false)} />}
      
      {/* Global Chat */}
      <GlobalChat isOpen={showChat} onClose={() => setShowChat(false)} />
      
      {/* Game Guide */}
      <GameGuide isOpen={showGuide} onClose={() => setShowGuide(false)} />

      {/* Guilds Modal */}
      {showGuilds && (
        <div 
          className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
          onClick={(e) => {
            if (e.target === e.currentTarget) setShowGuilds(false);
          }}
        >
          <div 
            className="bg-gray-900 rounded-lg border border-white/20 w-full max-w-2xl max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex-shrink-0 bg-gray-900 border-b border-white/10 p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Guilds</h2>
              <Button onClick={() => setShowGuilds(false)} variant="ghost" size="sm" className="hover:bg-white/10 rounded-full">
                
              </Button>
            </div>
            <div className="flex-1 overflow-y-auto min-h-0 p-4">
              <Guilds />
            </div>
          </div>
        </div>
      )}

      {/* Marketplace Modal */}
      {showMarketplace && (
        <div 
          className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
          onClick={(e) => {
            if (e.target === e.currentTarget) setShowMarketplace(false);
          }}
        >
          <div 
            className="bg-gray-900 rounded-lg border border-white/20 w-full max-w-2xl max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex-shrink-0 bg-gray-900 border-b border-white/10 p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Marketplace</h2>
              <Button onClick={() => setShowMarketplace(false)} variant="ghost" size="sm" className="hover:bg-white/10 rounded-full">
                
              </Button>
            </div>
            <div className="flex-1 overflow-y-auto min-h-0 p-4">
              <Marketplace />
            </div>
          </div>
        </div>
      )}

      {/* Quests Modal */}
      {showQuests && (
        <div 
          className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
          onClick={(e) => {
            if (e.target === e.currentTarget) setShowQuests(false);
          }}
        >
          <div 
            className="bg-gray-900 rounded-lg border border-white/20 w-full max-w-2xl max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex-shrink-0 bg-gray-900 border-b border-white/10 p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Quests</h2>
              <Button onClick={() => setShowQuests(false)} variant="ghost" size="sm" className="hover:bg-white/10 rounded-full">
                
              </Button>
            </div>
            <div className="flex-1 overflow-y-auto min-h-0 p-4">
              <Quests />
            </div>
          </div>
        </div>
      )}

      {/* Sell Property Modal */}
      {showSellProperty && propertyToSell && (
        <div 
          className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4"
          onClick={(e) => {
            if (e.target === e.currentTarget) {
              setShowSellProperty(false);
              setPropertyToSell(null);
            }
          }}
        >
          <div 
            className="bg-gray-900 rounded-lg border border-white/20 w-full max-w-2xl max-h-[90vh] flex flex-col"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex-shrink-0 bg-gray-900 border-b border-white/10 p-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-white">Sell Property</h2>
              <Button onClick={() => {
                setShowSellProperty(false);
                setPropertyToSell(null);
              }} variant="ghost" size="sm">
                
              </Button>
            </div>
            <div className="p-4">
              <Marketplace 
                preselectedProperty={{
                  tokenId: propertyToSell.tokenId,
                  propertyType: propertyToSell.propertyType,
                  value: propertyToSell.value,
                }}
                onListed={() => {
                  setShowSellProperty(false);
                  setPropertyToSell(null);
                }}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/src/components/Marketplace.tsx">
'use client';

import { useState, useEffect } from 'react';
import { ShoppingBag, Tag, Clock, Plus, X } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { api } from '@/lib/api';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract } from 'wagmi';
import { parseEther } from 'viem';
import { readContract } from 'wagmi/actions';
import { io, Socket } from 'socket.io-client';
import { wagmiConfig } from '@/lib/mantle-viem';
import { CONTRACTS, MARKETPLACE_ABI, PROPERTY_NFT_ABI, PROPERTY_NFT_ABI as PropertyNFTABI } from '@/lib/contracts';
import { getOwnerProperties } from '@/lib/contracts';

interface Listing {
  id: string;
  propertyId: string;
  property: {
    tokenId: number;
    propertyType: string;
    value: bigint;
    yieldRate: number;
  };
  seller: {
    walletAddress: string;
    username?: string;
  };
  price: bigint;
  listingType: 'fixed' | 'auction';
  auctionEndTime?: Date;
  highestBid?: bigint;
  isActive: boolean;
}

interface MarketplaceProps {
  preselectedProperty?: {
    tokenId: number;
    propertyType: string;
    value: bigint;
  };
  onListed?: () => void;
}

export function Marketplace({ preselectedProperty, onListed }: MarketplaceProps = {} as MarketplaceProps) {
  const { address, isConnected } = useAccount();
  const [listings, setListings] = useState<Listing[]>([]);
  const [myListings, setMyListings] = useState<Listing[]>([]);
  const [myProperties, setMyProperties] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [loadingSource, setLoadingSource] = useState<'backend' | 'blockchain'>('backend');
  const [purchasingId, setPurchasingId] = useState<string | null>(null);
  const [showListProperty, setShowListProperty] = useState(false);
  const [selectedProperty, setSelectedProperty] = useState<any | null>(null);
  const [listingPrice, setListingPrice] = useState('');
  const [listingType, setListingType] = useState<'fixed' | 'auction'>('fixed');
  const [auctionDuration, setAuctionDuration] = useState('7'); // days

  const { writeContract: writePurchase, data: purchaseHash, isPending: isPurchasePending } = useWriteContract();
  const { isLoading: isPurchaseConfirming, isSuccess: isPurchaseSuccess } = useWaitForTransactionReceipt({
    hash: purchaseHash,
  });

  const { writeContract: writeList, data: listHash, isPending: isListPending } = useWriteContract();
  const { isLoading: isListConfirming, isSuccess: isListSuccess } = useWaitForTransactionReceipt({
    hash: listHash,
  });

  const { writeContract: writeApprove, data: approveHash, isPending: isApprovePending } = useWriteContract();
  const { isLoading: isApproveConfirming, isSuccess: isApproveSuccess } = useWaitForTransactionReceipt({
    hash: approveHash,
  });

  const { writeContract: writeCancel, data: cancelHash, isPending: isCancelPending } = useWriteContract();
  const { isLoading: isCancelConfirming, isSuccess: isCancelSuccess } = useWaitForTransactionReceipt({
    hash: cancelHash,
  });

  const [needsApproval, setNeedsApproval] = useState(false);
  const { data: isApprovedForAll, refetch: refetchApproval } = useReadContract({
    address: CONTRACTS.PropertyNFT,
    abi: PROPERTY_NFT_ABI,
    functionName: 'isApprovedForAll',
    args: address && CONTRACTS.Marketplace ? [address, CONTRACTS.Marketplace] : undefined,
    query: {
      enabled: !!address && !!CONTRACTS.Marketplace,
    },
  });

  useEffect(() => {
    loadListings();
    if (address) {
      loadMyProperties();
    }
    if (preselectedProperty) {
      setShowListProperty(true);
      setSelectedProperty(preselectedProperty);
      setNeedsApproval(false); // Start fresh
    }
  }, [address, preselectedProperty]);

  // Listen for real-time marketplace updates via WebSocket
  useEffect(() => {
    if (typeof window === 'undefined') return;
    
    const BACKEND_URL = process.env.NEXT_PUBLIC_API_URL 
      ? process.env.NEXT_PUBLIC_API_URL.replace('/api', '') 
      : 'http://localhost:3001';

    const socket: Socket = io(BACKEND_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
    });

    socket.on('connect', () => {
      console.log(' Marketplace WebSocket connected');
    });

    const handleListing = (data: { propertyId: number; seller: string; price: string }) => {
      console.log(' New marketplace listing received via WebSocket:', data);
      // Reload listings to show new one
      loadListings();
    };

    const handleCancelled = (data: { propertyId: number; seller: string }) => {
      console.log(' Listing cancelled via WebSocket:', data);
      // Reload listings to remove cancelled one
      loadListings();
    };

    const handleTrade = (data: { listingId: number; seller: string; buyer: string; price: string }) => {
      console.log(' Marketplace trade via WebSocket:', data);
      // Reload listings to remove sold one
      loadListings();
    };

    socket.on('marketplace:listing', handleListing);
    socket.on('marketplace:cancelled', handleCancelled);
    socket.on('marketplace:trade', handleTrade);

    return () => {
      socket.off('marketplace:listing', handleListing);
      socket.off('marketplace:cancelled', handleCancelled);
      socket.off('marketplace:trade', handleTrade);
      socket.disconnect();
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Reload properties when modal opens
  useEffect(() => {
    if (showListProperty && address) {
      loadMyProperties();
      refetchApproval();
    }
  }, [showListProperty, address, refetchApproval]);

  // Check approval status when property is selected
  useEffect(() => {
    if (selectedProperty && address) {
      // Check if marketplace is approved for all (better UX)
      if (isApprovedForAll === false) {
        setNeedsApproval(true);
      } else if (isApprovedForAll === true) {
        setNeedsApproval(false);
      }
    }
  }, [selectedProperty, address, isApprovedForAll]);

  useEffect(() => {
    if (isPurchaseSuccess || isListSuccess || isCancelSuccess) {
      setPurchasingId(null);
      setShowListProperty(false);
      setSelectedProperty(null);
      setListingPrice('');
      
      // Wait a bit for backend to process the event, then reload
      // Backend listens to events and updates database automatically
      const reloadTimeout = setTimeout(() => {
        console.log(' Reloading listings after transaction success (backend should have synced)...');
        loadListings();
        if (address) {
          loadMyProperties();
        }
      }, 2000); // Wait 2 seconds for backend event processing
      
      if (isListSuccess && onListed) {
        onListed();
      }
      
      return () => clearTimeout(reloadTimeout);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isPurchaseSuccess, isListSuccess, isCancelSuccess, address, onListed]);

  const loadListings = async () => {
    setIsLoading(true);
    setLoadingSource('blockchain'); // Always use blockchain as primary source
    try {
      // PRIMARY: Load directly from blockchain (source of truth)
      // Backend sync is optional and only for caching/performance
      console.log(' Loading listings directly from blockchain (source of truth)...');
      await loadListingsFromBlockchain();
    } catch (error) {
      console.error('Failed to load listings from blockchain:', error);
      setListings([]);
      setMyListings([]);
    } finally {
      setIsLoading(false);
    }
  };

  const loadListingsFromBlockchain = async () => {
    // PRIMARY: Load directly from blockchain (source of truth)
    // This is the main method - blockchain is always the source of truth for marketplace
    try {
      console.log(' Loading listings directly from blockchain (source of truth)...');
      console.log(' Marketplace address:', CONTRACTS.Marketplace);
      
      // METHOD 1: Use the new getActiveListings() function (most efficient)
      console.log(' Method 1: Using getActiveListings() from marketplace contract...');
      try {
        const activeListingsDataRaw = await readContract(wagmiConfig, {
          address: CONTRACTS.Marketplace,
          abi: MARKETPLACE_ABI,
          functionName: 'getActiveListings',
          args: [],
        }) as unknown as [readonly bigint[], readonly `0x${string}`[], readonly bigint[]];
        
        const activeListingsData = {
          propertyIds: Array.from(activeListingsDataRaw[0]),
          sellers: Array.from(activeListingsDataRaw[1]),
          prices: Array.from(activeListingsDataRaw[2]),
        };
        
        console.log(` Found ${activeListingsData.propertyIds.length} active listings via getActiveListings()`);
        
        if (activeListingsData.propertyIds.length > 0) {
          // Process the listings
          const processedListings: Listing[] = [];
          for (let i = 0; i < activeListingsData.propertyIds.length; i++) {
            const propertyId = Number(activeListingsData.propertyIds[i]);
            const seller = activeListingsData.sellers[i];
            const price = activeListingsData.prices[i];
            
            try {
              // Get property details
              const propertyDataRaw = await readContract(wagmiConfig, {
                address: CONTRACTS.PropertyNFT,
                abi: PROPERTY_NFT_ABI,
                functionName: 'getProperty',
                args: [BigInt(propertyId)],
              }) as unknown as {
                propertyType: number;
                value: bigint;
                yieldRate: bigint;
              };
              
              const propertyData = {
                propertyType: BigInt(propertyDataRaw.propertyType),
                value: propertyDataRaw.value,
                yieldRate: propertyDataRaw.yieldRate,
              };

              const propertyTypes = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
              const propertyTypeNum = Number(propertyData.propertyType);
              
              processedListings.push({
                id: `listing-${propertyId}`,
                propertyId: propertyId.toString(),
                property: {
                  tokenId: propertyId,
                  propertyType: propertyTypes[propertyTypeNum] || 'Residential',
                  value: BigInt(propertyData.value.toString()),
                  yieldRate: Number(propertyData.yieldRate.toString()),
                },
                seller: {
                  walletAddress: seller,
                },
                price: BigInt(price.toString()),
                listingType: 'fixed' as const,
                isActive: true,
              });
              
              console.log(`   Processed listing for property ${propertyId}`);
            } catch (error) {
              console.error(`   Failed to get property details for ${propertyId}:`, error);
            }
          }
          
          // Separate my listings from others
          const myListingsFiltered = processedListings.filter((l: Listing) => 
            l.seller.walletAddress?.toLowerCase() === address?.toLowerCase()
          );
          const otherListings = processedListings.filter((l: Listing) => 
            l.seller.walletAddress?.toLowerCase() !== address?.toLowerCase()
          );
          
          console.log(` Listings breakdown: ${myListingsFiltered.length} mine, ${otherListings.length} others`);
          
          setListings(otherListings);
          setMyListings(myListingsFiltered);
          return; // Success, exit early
        } else {
          console.log(' No active listings found via getActiveListings()');
        }
      } catch (error: any) {
        console.warn(' getActiveListings() not available or failed, falling back to manual query:', error.message);
      }
      
      // METHOD 2: Fallback - Get all properties owned by marketplace contract
      console.log(' Method 2: Querying properties owned by marketplace contract...');
      console.log(' Marketplace contract address:', CONTRACTS.Marketplace);
      let marketplaceOwnedProperties: bigint[] = [];
      try {
        marketplaceOwnedProperties = await getOwnerProperties(CONTRACTS.Marketplace as `0x${string}`);
        console.log(` Found ${marketplaceOwnedProperties.length} properties owned by marketplace`);
        if (marketplaceOwnedProperties.length > 0) {
          console.log(' Marketplace-owned property IDs:', marketplaceOwnedProperties.map(id => Number(id)));
        } else {
          console.log(' No properties owned by marketplace. This means:');
          console.log('   - Either no properties have been listed yet');
          console.log('   - Or all listed properties have been sold/cancelled');
        }
      } catch (error: any) {
        console.error(' Failed to get marketplace-owned properties:', error);
        console.error('   Error message:', error.message);
        console.error('   This could mean the marketplace contract address is incorrect');
      }

      // METHOD 2: Query PropertyListed events as fallback
      console.log(' Method 2: Querying PropertyListed events...');
      const { createPublicClient, http, fallback, parseAbiItem } = await import('viem');
      const { mantleSepoliaTestnet } = await import('@mantleio/viem/chains');
      
      const rpcUrls = [
        'https://mantle-sepolia.drpc.org',
        'https://rpc.ankr.com/mantle_sepolia',
        'https://rpc.sepolia.mantle.xyz',
        'https://mantle-sepolia-rpc.publicnode.com',
      ];
      
      const publicClient = createPublicClient({
        chain: mantleSepoliaTestnet,
        transport: fallback(rpcUrls.map(url => http(url, { timeout: 10000 }))),
      });

      let eventPropertyIds: bigint[] = [];
      try {
        const currentBlock = await publicClient.getBlockNumber();
        const fromBlock = currentBlock > 100000n ? currentBlock - 100000n : 0n;
        const events = await publicClient.getLogs({
          address: CONTRACTS.Marketplace,
          event: parseAbiItem('event PropertyListed(uint256 indexed propertyId, address indexed seller, uint256 price)'),
          fromBlock: fromBlock,
        });
        eventPropertyIds = events.map(e => BigInt(Number(e.args?.propertyId || 0))).filter(id => id > 0n);
        console.log(` Found ${events.length} PropertyListed events`);
      } catch (error) {
        console.warn(' Failed to query events:', error);
      }

      // Combine both methods - use marketplace-owned properties first, then events
      const allPropertyIds = Array.from(new Set([
        ...marketplaceOwnedProperties,
        ...eventPropertyIds,
      ]));
      
      console.log(` Total unique property IDs to check: ${allPropertyIds.length}`);
      if (allPropertyIds.length === 0) {
        console.log(' No property IDs found to check!');
        console.log('   This means:');
        console.log('   1. Marketplace contract owns 0 properties');
        console.log('   2. No PropertyListed events found');
        console.log('    Properties may not have been listed yet');
        setListings([]);
        setMyListings([]);
        return;
      }

      // Check each property to see if it's listed and active
      const activeListings: Listing[] = [];
      for (const propertyIdBigInt of allPropertyIds) {
        try {
          const propertyId = Number(propertyIdBigInt);
          if (propertyId === 0) continue;
          
          console.log(` Checking property ${propertyId}...`);
          
          // Check if listing is still active
          const listingDataRaw = await readContract(wagmiConfig, {
            address: CONTRACTS.Marketplace,
            abi: MARKETPLACE_ABI,
            functionName: 'listings',
            args: [BigInt(propertyId)],
          }) as unknown as [bigint, `0x${string}`, bigint, boolean, bigint];
          
          const listingData = {
            propertyId: listingDataRaw[0],
            seller: listingDataRaw[1],
            price: listingDataRaw[2],
            isActive: listingDataRaw[3],
            createdAt: listingDataRaw[4],
          };

          console.log(`   Listing status for property ${propertyId}:`, {
            isActive: listingData.isActive,
            seller: listingData.seller,
            price: listingData.price.toString(),
            priceInTYCOON: (Number(listingData.price) / 1e18).toFixed(4),
            createdAt: new Date(Number(listingData.createdAt) * 1000).toISOString(),
          });

          if (listingData.isActive) {
            console.log(`   Property ${propertyId} is ACTIVE and listed!`);
            // Get property details
            const propertyDataRaw = await readContract(wagmiConfig, {
              address: CONTRACTS.PropertyNFT,
              abi: PROPERTY_NFT_ABI,
              functionName: 'getProperty',
              args: [BigInt(propertyId)],
            }) as unknown as {
              propertyType: number;
              value: bigint;
              yieldRate: bigint;
            };
            
            const propertyData = {
              propertyType: BigInt(propertyDataRaw.propertyType),
              value: propertyDataRaw.value,
              yieldRate: propertyDataRaw.yieldRate,
            };

            const propertyTypes = ['Residential', 'Commercial', 'Industrial', 'Luxury'];
            const propertyTypeNum = Number(propertyData.propertyType);
            
            activeListings.push({
              id: `listing-${propertyId}`,
              propertyId: propertyId.toString(),
              property: {
                tokenId: propertyId,
                propertyType: propertyTypes[propertyTypeNum] || 'Residential',
                value: BigInt(propertyData.value.toString()),
                yieldRate: Number(propertyData.yieldRate.toString()),
              },
              seller: {
                walletAddress: listingData.seller,
              },
              price: BigInt(listingData.price.toString()),
              listingType: 'fixed' as const,
              isActive: true,
            });
            
            console.log(`   Added active listing for property ${propertyId}`);
          } else {
            console.log(`    Skipping property ${propertyId} - listing is NOT active`);
            console.log(`     (This property may have been sold or cancelled)`);
          }
        } catch (error) {
          console.error(` Failed to check listing for property ${propertyIdBigInt}:`, error);
        }
      }

      console.log(` Found ${activeListings.length} active listings on blockchain`);

      // Separate my listings from others
      const myListingsFiltered = activeListings.filter((l: Listing) => 
        l.seller.walletAddress?.toLowerCase() === address?.toLowerCase()
      );
      const otherListings = activeListings.filter((l: Listing) => 
        l.seller.walletAddress?.toLowerCase() !== address?.toLowerCase()
      );
      
      console.log(` Listings breakdown: ${myListingsFiltered.length} mine, ${otherListings.length} others`);
      
      setListings(otherListings);
      setMyListings(myListingsFiltered);
    } catch (error) {
      console.error(' Failed to load listings from blockchain:', error);
      setListings([]);
      setMyListings([]);
    }
  };

  const loadMyProperties = async (autoSync: boolean = true) => {
    if (!address) {
      setMyProperties([]);
      return;
    }
    try {
      console.log('Loading properties for address:', address);
      
      // Load directly from blockchain first (like the game page does)
      let propertiesFromChain: any[] = [];
      try {
        const tokenIds = await getOwnerProperties(address as `0x${string}`);
        console.log('Found properties on-chain:', tokenIds);
        
        if (tokenIds && tokenIds.length > 0) {
          // Fetch property details for each token
          propertiesFromChain = await Promise.all(
            tokenIds.map(async (tokenId: bigint) => {
              try {
                const propData = await readContract(wagmiConfig, {
                  address: CONTRACTS.PropertyNFT,
                  abi: PROPERTY_NFT_ABI,
                  functionName: 'getProperty',
                  args: [tokenId],
                });
                
                return {
                  tokenId: Number(tokenId),
                  propertyType: ['Residential', 'Commercial', 'Industrial', 'Luxury'][Number(propData.propertyType)] || 'Residential',
                  value: BigInt(propData.value.toString()),
                  yieldRate: Number(propData.yieldRate.toString()),
                  totalYieldEarned: propData.totalYieldEarned ? BigInt(propData.totalYieldEarned.toString()) : undefined,
                  isActive: propData.isActive,
                };
              } catch (error) {
                console.error(`Failed to fetch property ${tokenId}:`, error);
                return null;
              }
            })
          );
          
          // Filter out nulls
          propertiesFromChain = propertiesFromChain.filter(p => p !== null);
          console.log(`Loaded ${propertiesFromChain.length} properties from blockchain`);
        }
      } catch (chainError) {
        console.error('Failed to load properties from chain:', chainError);
      }
      
      // Try to load from database (for coordinates and other metadata)
      let propertiesFromDb: any[] = [];
      try {
        propertiesFromDb = await api.get(`/properties/owner/${address}`);
        console.log('Loaded properties from database:', propertiesFromDb.length);
      } catch (dbError) {
        console.warn('Failed to load from database (will use chain data):', dbError);
      }
      
      // Merge: use chain data as source of truth, add DB metadata if available
      const mergedProperties = propertiesFromChain.map((chainProp: any) => {
        const dbProp = propertiesFromDb.find((p: any) => p.tokenId === chainProp.tokenId);
        return {
          ...chainProp,
          // Add DB metadata if available
          x: dbProp?.x,
          y: dbProp?.y,
          id: dbProp?.id || `prop-${chainProp.tokenId}`,
        };
      });
      
      console.log(`Total properties available: ${mergedProperties.length}`);
      setMyProperties(mergedProperties);
      
      // If we have properties from chain but not in DB, try to sync them (optional)
      if (mergedProperties.length > 0 && propertiesFromDb.length === 0 && autoSync) {
        console.log('Properties found on-chain but not in DB, attempting sync...');
        try {
          await api.post(`/properties/sync/${address}`).catch(() => {
            // Ignore sync errors, we already have the properties from chain
            console.log('Sync failed but properties are available from chain');
          });
        } catch (syncError) {
          console.log('Sync failed but properties are available from chain');
        }
      }
    } catch (error) {
      console.error('Failed to load my properties:', error);
      setMyProperties([]);
    }
  };

  const approveProperty = async () => {
    if (!address || !isConnected) return;
    
    try {
      console.log(' Approving marketplace for all properties...');
      // Use setApprovalForAll for better UX (approve once for all properties)
      writeApprove({
        address: CONTRACTS.PropertyNFT,
        abi: PROPERTY_NFT_ABI,
        functionName: 'setApprovalForAll',
        args: [CONTRACTS.Marketplace, true],
      });
      console.log(' Approval transaction submitted');
    } catch (error: any) {
      console.error(' Failed to approve marketplace:', error);
      
      // Check if it's an RPC error
      if (error.message?.includes('fetch') || error.message?.includes('HTTP') || error.message?.includes('network')) {
        alert('Network error: RPC endpoint is unavailable. Please try again in a moment. The system will automatically retry with fallback RPCs.');
      } else {
        alert(error.message || 'Failed to approve marketplace. Please check your wallet connection and try again.');
      }
    }
  };

  // Refetch approval after successful approval
  useEffect(() => {
    if (isApproveSuccess) {
      refetchApproval();
    }
  }, [isApproveSuccess, refetchApproval]);

  const listProperty = async () => {
    if (!address || !isConnected || !selectedProperty || !listingPrice) {
      alert('Please fill in all fields');
      return;
    }

    // Check if approval is needed first
    if (needsApproval) {
      await approveProperty();
      return;
    }

    try {
      const priceInWei = parseEther(listingPrice);
      
      if (listingType === 'fixed') {
        writeList({
          address: CONTRACTS.Marketplace,
          abi: MARKETPLACE_ABI,
          functionName: 'listProperty',
          args: [BigInt(selectedProperty.tokenId), priceInWei],
        });
      } else {
        const durationInSeconds = BigInt(Number(auctionDuration) * 24 * 60 * 60);
        writeList({
          address: CONTRACTS.Marketplace,
          abi: MARKETPLACE_ABI,
          functionName: 'createAuction',
          args: [BigInt(selectedProperty.tokenId), priceInWei, durationInSeconds],
        });
      }
    } catch (error: any) {
      console.error('Failed to list property:', error);
      // If error mentions approval, set needsApproval flag
      if (error.message?.toLowerCase().includes('approval') || error.message?.toLowerCase().includes('transfer')) {
        setNeedsApproval(true);
        alert('Please approve the marketplace first, then try listing again.');
      } else {
        alert(error.message || 'Failed to list property');
      }
    }
  };

  // When approval succeeds, automatically proceed with listing
  useEffect(() => {
    if (isApproveSuccess && selectedProperty && listingPrice && needsApproval) {
      setNeedsApproval(false);
      // Small delay to ensure approval is processed
      setTimeout(() => {
        const priceInWei = parseEther(listingPrice);
        
        if (listingType === 'fixed') {
          writeList({
            address: CONTRACTS.Marketplace,
            abi: MARKETPLACE_ABI,
            functionName: 'listProperty',
            args: [BigInt(selectedProperty.tokenId), priceInWei],
          });
        } else {
          const durationInSeconds = BigInt(Number(auctionDuration) * 24 * 60 * 60);
          writeList({
            address: CONTRACTS.Marketplace,
            abi: MARKETPLACE_ABI,
            functionName: 'createAuction',
            args: [BigInt(selectedProperty.tokenId), priceInWei, durationInSeconds],
          });
        }
      }, 1000);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isApproveSuccess, selectedProperty, listingPrice, listingType, auctionDuration, needsApproval]);

  const cancelListing = async (propertyId: number) => {
    if (!address || !isConnected) return;
    
    try {
      writeCancel({
        address: CONTRACTS.Marketplace,
        abi: MARKETPLACE_ABI,
        functionName: 'cancelListing',
        args: [BigInt(propertyId)],
      });
    } catch (error: any) {
      console.error('Failed to cancel listing:', error);
      alert(error.message || 'Failed to cancel listing');
    }
  };

  const purchaseProperty = async (listing: Listing) => {
    if (!address || !isConnected) {
      alert('Please connect your wallet');
      return;
    }

    try {
      setPurchasingId(listing.id);
      writePurchase({
        address: CONTRACTS.Marketplace,
        abi: MARKETPLACE_ABI,
        functionName: 'buyProperty',
        args: [BigInt(listing.property.tokenId)],
        value: listing.price as bigint,
      } as any);
    } catch (error: any) {
      console.error('Failed to purchase:', error);
      alert(error.message || 'Failed to purchase property');
      setPurchasingId(null);
    }
  };

  const formatValue = (value: bigint) => {
    const tycoonAmount = Number(value) / 1e18;
    if (tycoonAmount < 1) {
      return tycoonAmount.toFixed(2);
    }
    return tycoonAmount.toLocaleString('en-US', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
  };

  return (
    <div className="space-y-4">
      <Card className="border-white/10 bg-white/5 backdrop-blur-md">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-white flex items-center gap-2">
                <ShoppingBag className="w-5 h-5" />
                Marketplace
              </CardTitle>
              <p className="text-sm text-gray-400">Buy and sell properties</p>
            </div>
            <div className="flex items-center gap-2">
              <Button
                onClick={() => {
                  console.log(' Manual refresh clicked');
                  loadListings();
                }}
                variant="outline"
                size="sm"
                disabled={isLoading}
                className="text-white border-white/20 hover:bg-white/10"
              >
                {isLoading ? 'Loading...' : 'Refresh'}
              </Button>
              {isConnected && (
                <Button
                  onClick={() => setShowListProperty(true)}
                  className="bg-blue-600 hover:bg-blue-700 text-white"
                >
                  <Plus className="w-4 h-4 mr-2" />
                  List Property
                </Button>
              )}
            </div>
          </div>
        </CardHeader>
        <CardContent>
        {isLoading ? (
          <div className="text-center py-8 text-gray-400">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
            <p>Loading marketplace...</p>
            <p className="text-xs mt-2">Querying blockchain for listings...</p>
          </div>
        ) : listings.length === 0 ? (
          <div className="text-center py-8 text-gray-400">
            <ShoppingBag className="w-12 h-12 mx-auto mb-2 opacity-50" />
            <p>No properties for sale</p>
            <p className="text-xs mt-2 text-gray-500">
              {myListings.length > 0 
                ? `You have ${myListings.length} listed property${myListings.length > 1 ? 'ies' : ''} (see "My Listings" below)`
                : 'List a property to get started'}
            </p>
            <Button
              onClick={() => {
                console.log(' Manual refresh from empty state');
                loadListings();
              }}
              variant="outline"
              size="sm"
              className="mt-4 text-white border-white/20 hover:bg-white/10"
            >
              Refresh Listings
            </Button>
          </div>
        ) : (
          <div className="space-y-4">
            {listings.filter(l => l.property).map((listing) => (
              <div
                key={listing.id}
                className="p-4 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors"
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <Tag className="w-4 h-4 text-blue-400" />
                      <span className="text-white font-semibold">
                        {listing.property?.propertyType || 'Unknown'} Property #{listing.property?.tokenId || 'N/A'}
                      </span>
                      <span className="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400">
                        {listing.listingType === 'auction' ? 'Auction' : 'Fixed Price'}
                      </span>
                    </div>
                    <p className="text-xs text-gray-400 mb-2">
                      Seller: {listing.seller.username || `${listing.seller.walletAddress.slice(0, 6)}...${listing.seller.walletAddress.slice(-4)}`}
                    </p>
                    <div className="flex items-center gap-4 text-xs text-gray-400">
                      <span>Value: {listing.property?.value ? formatValue(listing.property.value) : 'N/A'} TYCOON</span>
                      <span>Yield: {listing.property?.yieldRate ? listing.property.yieldRate / 100 : 'N/A'}% APY</span>
                      {listing.listingType === 'auction' && listing.auctionEndTime && (
                        <span className="flex items-center gap-1">
                          <Clock className="w-3 h-3" />
                          Ends: {new Date(listing.auctionEndTime).toLocaleDateString()}
                        </span>
                      )}
                    </div>
                  </div>
                  <div className="text-right ml-4">
                    <p className="text-emerald-400 font-semibold text-lg mb-2">
                      {formatValue(listing.price)} TYCOON
                    </p>
                    {listing.listingType === 'auction' && listing.highestBid && (
                      <p className="text-xs text-gray-400 mb-2">
                        Highest bid: {formatValue(listing.highestBid)} TYCOON
                      </p>
                    )}
                    <Button
                      onClick={() => purchaseProperty(listing)}
                      disabled={!isConnected || purchasingId === listing.id || isPurchasePending || isPurchaseConfirming || !listing.property}
                      className="bg-emerald-600 hover:bg-emerald-700 text-white"
                      size="sm"
                    >
                      {purchasingId === listing.id
                        ? isPurchaseConfirming
                          ? 'Confirming...'
                          : 'Purchasing...'
                        : 'Buy Now'}
                    </Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
        </CardContent>
      </Card>

      {/* My Listings */}
      {isConnected && myListings.length > 0 && (
        <Card className="border-white/10 bg-white/5 backdrop-blur-md">
          <CardHeader>
            <CardTitle className="text-white flex items-center gap-2">
              <Tag className="w-5 h-5" />
              My Listings
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {myListings.filter(l => l.property).map((listing) => (
                <div
                  key={listing.id}
                  className="p-4 rounded-lg bg-white/5 border border-white/10"
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="text-white font-semibold">
                          {listing.property?.propertyType || 'Unknown'} Property #{listing.property?.tokenId || 'N/A'}
                        </span>
                        <span className="text-xs px-2 py-1 rounded bg-blue-500/20 text-blue-400">
                          {listing.listingType === 'auction' ? 'Auction' : 'Fixed Price'}
                        </span>
                      </div>
                      <p className="text-emerald-400 font-semibold text-lg">
                        {formatValue(listing.price)} TYCOON
                      </p>
                    </div>
                    <Button
                      onClick={() => cancelListing(listing.property?.tokenId || 0)}
                      disabled={isCancelPending || isCancelConfirming || !listing.property}
                      variant="outline"
                      size="sm"
                      className="border-red-500/50 text-red-400 hover:bg-red-500/10"
                    >
                      <X className="w-3 h-3 mr-1" />
                      Cancel
                    </Button>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}

      {/* List Property Modal */}
      {showListProperty && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <Card className="w-full max-w-md border-white/20 bg-gray-900">
            <CardHeader>
              <div className="flex items-center justify-between">
                <CardTitle className="text-white">List Property for Sale</CardTitle>
                <Button onClick={() => setShowListProperty(false)} variant="ghost" size="sm">
                  
                </Button>
              </div>
            </CardHeader>
            <CardContent className="space-y-4">
              <div>
                <label className="text-sm text-gray-400 mb-2 block">Select Property</label>
                {preselectedProperty ? (
                  <div className="p-3 bg-blue-900/20 rounded-lg border border-blue-500/30">
                    <p className="text-white font-semibold">
                      {preselectedProperty.propertyType} Property #{preselectedProperty.tokenId}
                    </p>
                    <p className="text-xs text-gray-400">Value: {formatValue(preselectedProperty.value)} TYCOON</p>
                  </div>
                ) : (
                  <>
                    {myProperties.length === 0 ? (
                      <div className="p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                        <p className="text-sm text-gray-400 mb-2">No properties found in database.</p>
                        {address && (
                          <>
                            <p className="text-xs text-gray-500 mb-3">
                              Click "Sync from Chain" to fetch your properties from the blockchain.
                            </p>
                            <Button
                              onClick={async () => {
                                try {
                                  setIsLoading(true);
                                  console.log('Manually syncing properties from chain...');
                                  await api.post(`/properties/sync/${address}`);
                                  // Reload properties after sync
                                  await loadMyProperties();
                                } catch (error) {
                                  console.error('Failed to sync properties:', error);
                                  alert('Failed to sync properties. Please try again.');
                                } finally {
                                  setIsLoading(false);
                                }
                              }}
                              disabled={isLoading}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                              size="sm"
                            >
                              {isLoading ? 'Syncing...' : 'Sync from Chain'}
                            </Button>
                          </>
                        )}
                      </div>
                    ) : (
                      <select
                        value={selectedProperty?.tokenId || ''}
                        onChange={(e) => {
                          const prop = myProperties.find((p: any) => p.tokenId === Number(e.target.value));
                          setSelectedProperty(prop);
                          setNeedsApproval(false); // Reset approval flag when property changes
                        }}
                        className="w-full p-2 rounded-lg bg-white/5 border border-white/10 text-white"
                      >
                        <option value="">Choose a property...</option>
                        {(() => {
                          const availableProperties = myProperties.filter((p: any) => {
                            const propTokenId = p.tokenId || p.token_id;
                            if (!propTokenId) {
                              console.warn('Property missing tokenId:', p);
                              return false;
                            }
                            
                            // Filter out properties that are already listed
                            const isListed = myListings.some((l: Listing) => {
                              const listingTokenId = l.property?.tokenId || l.propertyId;
                              return Number(listingTokenId) === Number(propTokenId);
                            });
                            
                            return !isListed;
                          });
                          
                          console.log(`Available properties for dropdown: ${availableProperties.length} out of ${myProperties.length}`);
                          
                          if (availableProperties.length === 0 && myProperties.length > 0) {
                            console.warn('All properties are filtered out. Properties:', myProperties);
                            console.warn('My listings:', myListings);
                          }
                          
                          return availableProperties.map((prop: any) => {
                            const tokenId = prop.tokenId || prop.token_id;
                            const propertyType = prop.propertyType || prop.property_type || 'Unknown';
                            const value = prop.value || '0';
                            const valueStr = typeof value === 'bigint' ? value.toString() : (value?.toString() || '0');
                            return (
                              <option key={tokenId} value={tokenId}>
                                {propertyType} #{tokenId} - {formatValue(BigInt(valueStr))} TYCOON
                              </option>
                            );
                          });
                        })()}
                      </select>
                    )}
                  </>
                )}
              </div>

              <div>
                <label className="text-sm text-gray-400 mb-2 block">Listing Type</label>
                <div className="flex gap-2">
                  <Button
                    onClick={() => setListingType('fixed')}
                    variant={listingType === 'fixed' ? 'default' : 'outline'}
                    size="sm"
                    className="flex-1"
                  >
                    Fixed Price
                  </Button>
                  <Button
                    onClick={() => setListingType('auction')}
                    variant={listingType === 'auction' ? 'default' : 'outline'}
                    size="sm"
                    className="flex-1"
                  >
                    Auction
                  </Button>
                </div>
              </div>

              <div>
                <label className="text-sm text-gray-400 mb-2 block">
                  {listingType === 'fixed' ? 'Price' : 'Starting Price'} (TYCOON)
                </label>
                <Input
                  type="number"
                  value={listingPrice}
                  onChange={(e) => setListingPrice(e.target.value)}
                  placeholder="Enter price"
                  className="bg-white/5 border-white/10 text-white"
                />
              </div>

              {listingType === 'auction' && (
                <div>
                  <label className="text-sm text-gray-400 mb-2 block">Duration (days)</label>
                  <Input
                    type="number"
                    value={auctionDuration}
                    onChange={(e) => setAuctionDuration(e.target.value)}
                    placeholder="7"
                    className="bg-white/5 border-white/10 text-white"
                  />
                </div>
              )}

              <div className="flex gap-2">
                {(needsApproval || isApprovedForAll === false) ? (
                  <Button
                    onClick={approveProperty}
                    disabled={isApprovePending || isApproveConfirming}
                    className="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white"
                  >
                    {isApprovePending || isApproveConfirming ? 'Approving...' : 'Approve Marketplace First'}
                  </Button>
                ) : (
                  <Button
                    onClick={listProperty}
                    disabled={!selectedProperty || !listingPrice || isListPending || isListConfirming || isApprovePending || isApproveConfirming}
                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white"
                  >
                    {isListPending || isListConfirming ? 'Listing...' : 'List Property'}
                  </Button>
                )}
                <Button
                  onClick={() => {
                    setShowListProperty(false);
                    setSelectedProperty(null);
                    setListingPrice('');
                  }}
                  variant="outline"
                  className="flex-1"
                >
                  Cancel
                </Button>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}
</file>

<file path="backend/src/guilds/guilds.service.ts">
import { Injectable, Logger, Inject, NotFoundException, BadRequestException } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { eq, and, desc, sql } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';

@Injectable()
export class GuildsService {
  private readonly logger = new Logger(GuildsService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
  ) {}

  // Helper to recursively convert BigInt values to strings for JSON serialization
  private serializeBigInts(obj: any): any {
    if (obj === null || obj === undefined) {
      return obj;
    }
    
    if (typeof obj === 'bigint') {
      return obj.toString();
    }
    
    if (Array.isArray(obj)) {
      return obj.map(item => this.serializeBigInts(item));
    }
    
    if (typeof obj === 'object') {
      const result: any = {};
      for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
          result[key] = this.serializeBigInts(obj[key]);
        }
      }
      return result;
    }
    
    return obj;
  }

  async createGuild(ownerId: string, name: string, description?: string, isPublic: boolean = true) {
    // Check if user already has a guild
    const existingGuild = await this.db
      .select()
      .from(schema.guildMembers)
      .where(eq(schema.guildMembers.userId, ownerId))
      .limit(1);

    if (existingGuild.length > 0) {
      throw new BadRequestException('User is already a member of a guild');
    }

    // Check if guild name exists
    const [existingName] = await this.db
      .select()
      .from(schema.guilds)
      .where(eq(schema.guilds.name, name))
      .limit(1);

    if (existingName) {
      throw new BadRequestException('Guild name already exists');
    }

    // Create guild
    const [guild] = await this.db
      .insert(schema.guilds)
      .values({
        name,
        description,
        ownerId,
        isPublic,
        totalMembers: 1,
      })
      .returning();

    // Add owner as member
    await this.db.insert(schema.guildMembers).values({
      guildId: guild.id,
      userId: ownerId,
      role: 'owner',
    });

    this.logger.log(`Guild created: ${name} by user ${ownerId}`);
    return guild;
  }

  async createGuildByWallet(walletAddress: string, name: string, description?: string, isPublic: boolean = true) {
    // Get or create user by wallet address
    let [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress))
      .limit(1);

    if (!user) {
      // Auto-create user if they don't exist
      this.logger.log(`User not found for wallet ${walletAddress}, creating new user...`);
      [user] = await this.db
        .insert(schema.users)
        .values({
          walletAddress: walletAddress,
          totalPortfolioValue: '0',
          totalYieldEarned: '0',
          propertiesOwned: 0,
        })
        .returning();
      this.logger.log(`Created new user ${user.id} for wallet ${walletAddress}`);
    }

    return this.createGuild(user.id, name, description, isPublic);
  }

  async joinGuild(userId: string, guildId: string) {
    // Check if user is already in a guild
    const existingMembership = await this.db
      .select()
      .from(schema.guildMembers)
      .where(eq(schema.guildMembers.userId, userId))
      .limit(1);

    if (existingMembership.length > 0) {
      throw new BadRequestException('User is already a member of a guild');
    }

    // Check if guild exists
    const [guild] = await this.db
      .select()
      .from(schema.guilds)
      .where(eq(schema.guilds.id, guildId))
      .limit(1);

    if (!guild) {
      throw new NotFoundException('Guild not found');
    }

    if (!guild.isPublic) {
      throw new BadRequestException('Guild is private');
    }

    // Add member
    await this.db.insert(schema.guildMembers).values({
      guildId,
      userId,
      role: 'member',
    });

    // Update guild member count
    await this.db
      .update(schema.guilds)
      .set({ totalMembers: guild.totalMembers + 1 })
      .where(eq(schema.guilds.id, guildId));

    // Update guild stats after member joins
    await this.updateGuildStats(guildId);

    this.logger.log(`User ${userId} joined guild ${guildId}`);
    return { success: true };
  }

  async joinGuildByWallet(walletAddress: string, guildId: string) {
    // Get or create user by wallet address
    let [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress))
      .limit(1);

    if (!user) {
      // Auto-create user if they don't exist
      this.logger.log(`User not found for wallet ${walletAddress}, creating new user...`);
      [user] = await this.db
        .insert(schema.users)
        .values({
          walletAddress: walletAddress,
          totalPortfolioValue: '0',
          totalYieldEarned: '0',
          propertiesOwned: 0,
        })
        .returning();
      this.logger.log(`Created new user ${user.id} for wallet ${walletAddress}`);
    }

    return this.joinGuild(user.id, guildId);
  }

  async leaveGuild(userId: string, guildId: string) {
    const [membership] = await this.db
      .select()
      .from(schema.guildMembers)
      .where(and(eq(schema.guildMembers.userId, userId), eq(schema.guildMembers.guildId, guildId)))
      .limit(1);

    if (!membership) {
      throw new NotFoundException('Membership not found');
    }

    // If owner, transfer ownership or delete guild
    const [guild] = await this.db
      .select()
      .from(schema.guilds)
      .where(eq(schema.guilds.id, guildId))
      .limit(1);

    if (guild.ownerId === userId) {
      // Transfer to first admin or delete if no members
      const [nextOwner] = await this.db
        .select()
        .from(schema.guildMembers)
        .where(and(eq(schema.guildMembers.guildId, guildId), eq(schema.guildMembers.userId, userId)))
        .limit(1);

      if (nextOwner) {
        await this.db
          .update(schema.guilds)
          .set({ ownerId: nextOwner.userId })
          .where(eq(schema.guilds.id, guildId));
        await this.db
          .update(schema.guildMembers)
          .set({ role: 'owner' })
          .where(eq(schema.guildMembers.id, nextOwner.id));
      } else {
        // Delete guild if no members left
        await this.db.delete(schema.guilds).where(eq(schema.guilds.id, guildId));
      }
    }

    // Remove member
    await this.db
      .delete(schema.guildMembers)
      .where(and(eq(schema.guildMembers.userId, userId), eq(schema.guildMembers.guildId, guildId)));

    // Update member count (reuse guild variable from above)
    if (guild && guild.totalMembers > 0) {
      await this.db
        .update(schema.guilds)
        .set({ totalMembers: guild.totalMembers - 1 })
        .where(eq(schema.guilds.id, guildId));
    }

    // Update guild stats after member leaves
    await this.updateGuildStats(guildId);

    this.logger.log(`User ${userId} left guild ${guildId}`);
    return { success: true };
  }

  async leaveGuildByWallet(walletAddress: string, guildId: string) {
    // Get user by wallet address
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, walletAddress))
      .limit(1);

    if (!user) {
      throw new NotFoundException('User not found');
    }

    return this.leaveGuild(user.id, guildId);
  }

  async getGuild(guildId: string) {
    try {
      const [guild] = await this.db
        .select({
          id: schema.guilds.id,
          name: schema.guilds.name,
          description: schema.guilds.description,
          ownerId: schema.guilds.ownerId,
          totalMembers: schema.guilds.totalMembers,
          totalPortfolioValue: schema.guilds.totalPortfolioValue,
          totalYieldEarned: schema.guilds.totalYieldEarned,
          isPublic: schema.guilds.isPublic,
          createdAt: schema.guilds.createdAt,
          owner: {
            walletAddress: schema.users.walletAddress,
            username: schema.users.username,
          },
        })
        .from(schema.guilds)
        .leftJoin(schema.users, eq(schema.guilds.ownerId, schema.users.id))
        .where(eq(schema.guilds.id, guildId))
        .limit(1);

      if (!guild) {
        throw new NotFoundException('Guild not found');
      }

      // Get members
      const membersRaw = await this.db
        .select({
          id: schema.guildMembers.id,
          userId: schema.guildMembers.userId,
          role: schema.guildMembers.role,
          contribution: schema.guildMembers.contribution,
          joinedAt: schema.guildMembers.joinedAt,
          user: {
            walletAddress: schema.users.walletAddress,
            username: schema.users.username,
          },
        })
        .from(schema.guildMembers)
        .leftJoin(schema.users, eq(schema.guildMembers.userId, schema.users.id))
        .where(eq(schema.guildMembers.guildId, guildId));

      // contribution is now numeric (returns string), no conversion needed
      const members = membersRaw.map(member => ({
        id: member.id,
        userId: member.userId,
        role: member.role,
        contribution: member.contribution ? String(member.contribution) : '0',
        joinedAt: member.joinedAt,
        user: member.user,
      }));

      // Ensure all numeric fields are strings (they come from database as strings for NUMERIC type)
      const totalPortfolioValueStr = guild.totalPortfolioValue 
        ? String(guild.totalPortfolioValue) 
        : '0';
      
      const totalYieldEarnedStr = guild.totalYieldEarned 
        ? String(guild.totalYieldEarned) 
        : '0';

      return {
        id: guild.id,
        name: guild.name,
        description: guild.description,
        ownerId: guild.ownerId,
        totalMembers: guild.totalMembers,
        totalPortfolioValue: totalPortfolioValueStr,
        totalYieldEarned: totalYieldEarnedStr,
        isPublic: guild.isPublic,
        createdAt: guild.createdAt,
        owner: guild.owner,
        members,
      };
    } catch (error) {
      this.logger.error(`Error getting guild ${guildId}: ${error.message}`, error.stack);
      throw error;
    }
  }

  async getUserGuild(userId: string) {
    const [membership] = await this.db
      .select()
      .from(schema.guildMembers)
      .where(eq(schema.guildMembers.userId, userId))
      .limit(1);

    if (!membership) {
      return null;
    }

    return this.getGuild(membership.guildId);
  }

  async getUserGuildByWallet(walletAddress: string) {
    try {
      // Get user by wallet address (don't auto-create for read operations)
      const [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, walletAddress))
        .limit(1);

      if (!user) {
        return null; // User doesn't exist, so no guild
      }

      const guild = await this.getUserGuild(user.id);
      
      // Ensure all BigInt values are converted to strings using recursive helper
      if (guild) {
        return this.serializeBigInts(guild);
      }
      
      return null;
    } catch (error) {
      this.logger.error(`Error getting user guild by wallet ${walletAddress}: ${error.message}`, error.stack);
      throw error;
    }
  }

  async getGuildLeaderboard(limit: number = 20) {
    // Return cached data immediately (fast response)
    // Stats are updated via event listeners or manual sync
    // Updating stats for all guilds on every request is too slow and causes reload loops
    
    // Fetch the current rankings from database
    const rankings = await this.db
      .select({
        id: schema.guilds.id,
        name: schema.guilds.name,
        totalMembers: schema.guilds.totalMembers,
        totalPortfolioValue: schema.guilds.totalPortfolioValue,
        totalYieldEarned: schema.guilds.totalYieldEarned,
        owner: {
          walletAddress: schema.users.walletAddress,
          username: schema.users.username,
        },
      })
      .from(schema.guilds)
      .leftJoin(schema.users, eq(schema.guilds.ownerId, schema.users.id))
      .orderBy(desc(schema.guilds.totalPortfolioValue))
      .limit(limit);

    return rankings.map((r, index) => ({
      ...r,
      rank: index + 1,
    }));
  }

  async updateGuildStats(guildId: string) {
    try {
      // Get all members with their wallet addresses
      const members = await this.db
        .select({
          userId: schema.guildMembers.userId,
          walletAddress: schema.users.walletAddress,
        })
        .from(schema.guildMembers)
        .leftJoin(schema.users, eq(schema.guildMembers.userId, schema.users.id))
        .where(eq(schema.guildMembers.guildId, guildId));

      // Calculate total portfolio value and yield from blockchain (source of truth)
      let totalPortfolioValue = BigInt(0);
      let totalYieldEarned = BigInt(0);

      if (!this.contractsService.propertyNFT || !this.contractsService.yieldDistributor) {
        this.logger.warn('Contracts not initialized, falling back to database values');
        // Fallback to database if contracts not available
        for (const member of members) {
          if (!member.walletAddress) continue;
          const [leaderboardEntry] = await this.db
            .select({
              totalPortfolioValue: schema.leaderboard.totalPortfolioValue,
              totalYieldEarned: schema.leaderboard.totalYieldEarned,
            })
            .from(schema.leaderboard)
            .where(eq(schema.leaderboard.userId, member.userId))
            .limit(1);

          if (leaderboardEntry) {
            const portfolioValueStr = leaderboardEntry.totalPortfolioValue ? String(leaderboardEntry.totalPortfolioValue) : '0';
            const yieldEarnedStr = leaderboardEntry.totalYieldEarned ? String(leaderboardEntry.totalYieldEarned) : '0';
            totalPortfolioValue += BigInt(portfolioValueStr);
            totalYieldEarned += BigInt(yieldEarnedStr);
          }
        }
      } else {
        // Fetch directly from blockchain
        this.logger.log(`Fetching guild stats from blockchain for ${members.length} members...`);
        for (const member of members) {
          if (!member.walletAddress) {
            this.logger.warn(`Member ${member.userId} has no wallet address, skipping`);
            continue;
          }
          
          try {
            this.logger.log(`Getting properties for member ${member.walletAddress}...`);
            // Get all properties owned by this member from blockchain
            let tokenIds: bigint[] = [];
            try {
              const result = await this.contractsService.getOwnerProperties(member.walletAddress);
              if (Array.isArray(result)) {
                tokenIds = result;
              } else if (result && typeof result === 'object' && 'length' in result) {
                tokenIds = Array.from(result as any);
              }
            } catch (error: any) {
              // If getOwnerProperties fails, member has no properties in new contract
              this.logger.warn(`No properties found in new contract for ${member.walletAddress}: ${error.message}`);
              // Fallback to database for this member
              const [leaderboardEntry] = await this.db
                .select({
                  totalPortfolioValue: schema.leaderboard.totalPortfolioValue,
                  totalYieldEarned: schema.leaderboard.totalYieldEarned,
                })
                .from(schema.leaderboard)
                .where(eq(schema.leaderboard.userId, member.userId))
                .limit(1);
              
              if (leaderboardEntry) {
                const portfolioValue = BigInt(leaderboardEntry.totalPortfolioValue?.toString() || '0');
                const yieldEarned = BigInt(leaderboardEntry.totalYieldEarned?.toString() || '0');
                totalPortfolioValue += portfolioValue;
                totalYieldEarned += yieldEarned;
                this.logger.log(`Using database fallback for ${member.walletAddress}: portfolio=${portfolioValue}, yield=${yieldEarned}`);
              }
              continue;
            }
            
            if (!Array.isArray(tokenIds) || tokenIds.length === 0) {
              this.logger.log(`No properties found for ${member.walletAddress}`);
              continue;
            }

            // Deduplicate tokenIds
            const uniqueTokenIds = Array.from(new Set(tokenIds.map(id => Number(id))));
            this.logger.log(`Found ${uniqueTokenIds.length} unique properties for ${member.walletAddress}`);

            // Get contract addresses to exclude listed properties
            const contractAddresses: string[] = [];
            if (this.contractsService.marketplace?.address) {
              contractAddresses.push(this.contractsService.marketplace.address.toLowerCase());
            }
            if (this.contractsService.yieldDistributor?.address) {
              contractAddresses.push(this.contractsService.yieldDistributor.address.toLowerCase());
            }
            if (this.contractsService.questSystem?.address) {
              contractAddresses.push(this.contractsService.questSystem.address.toLowerCase());
            }
            if (this.contractsService.propertyNFT?.address) {
              contractAddresses.push(this.contractsService.propertyNFT.address.toLowerCase());
            }
            if (this.contractsService.gameToken?.address) {
              contractAddresses.push(this.contractsService.gameToken.address.toLowerCase());
            }
            // Hardcode old marketplace address
            contractAddresses.push('0x6389d7168029715de118baf51b6d32ee1ebea46b'.toLowerCase());

            // Calculate portfolio value for each property
            // Check ownerOf FIRST to exclude listed properties (owned by marketplace contract)
            for (const tokenId of uniqueTokenIds) {
              try {
                // Check ownerOf FIRST - this is the source of truth
                const currentOwner = await this.contractsService.propertyNFT.ownerOf(tokenId);
                const ownerLower = currentOwner.toLowerCase();
                const isOwnedByUser = ownerLower === member.walletAddress.toLowerCase();
                const isContract = contractAddresses.includes(ownerLower);

                this.logger.log(` Guild Property ${tokenId}: ownerOf=${currentOwner}, member=${member.walletAddress}, isOwnedByUser=${isOwnedByUser}, isContract=${isContract}`);

                // Only process if owned by user AND not a contract address
                if (isOwnedByUser && !isContract) {
                  const propertyData = await this.contractsService.getProperty(BigInt(tokenId));
                  if (propertyData) {
                    // Add property value to portfolio
                    const value = propertyData.value?.toString() || '0';
                    const valueBigInt = BigInt(value);
                    totalPortfolioValue += valueBigInt;
                    
                    this.logger.log(` Guild Property ${tokenId} counted: value=${valueBigInt.toString()}`);
                  }
                } else {
                  this.logger.log(` Guild Property ${tokenId} excluded: owned by ${currentOwner} (${isContract ? 'contract' : 'different user'})`);
                }
              } catch (error) {
                this.logger.warn(`Failed to verify property ${tokenId} for guild stats: ${error.message}`);
              }
            }

            // Get total yield claimed by this member from YieldDistributor
            try {
              if (this.contractsService.yieldDistributor) {
                const totalYieldClaimed = await this.contractsService.yieldDistributor.totalYieldClaimed(member.walletAddress);
                if (totalYieldClaimed) {
                  const yieldStr = totalYieldClaimed.toString() || '0';
                  const yieldBigInt = BigInt(yieldStr);
                  totalYieldEarned += yieldBigInt;
                  this.logger.log(`Member ${member.walletAddress}: totalYieldClaimed=${yieldBigInt.toString()}`);
                }
              }
            } catch (error) {
              this.logger.warn(`Failed to get totalYieldClaimed for ${member.walletAddress}: ${error.message}`);
            }
          } catch (error) {
            this.logger.warn(`Failed to get properties for ${member.walletAddress}: ${error.message}`);
            // Fallback to database for this member
            const [leaderboardEntry] = await this.db
              .select({
                totalPortfolioValue: schema.leaderboard.totalPortfolioValue,
                totalYieldEarned: schema.leaderboard.totalYieldEarned,
              })
              .from(schema.leaderboard)
              .where(eq(schema.leaderboard.userId, member.userId))
              .limit(1);

            if (leaderboardEntry) {
              const portfolioValueStr = leaderboardEntry.totalPortfolioValue ? String(leaderboardEntry.totalPortfolioValue) : '0';
              const yieldEarnedStr = leaderboardEntry.totalYieldEarned ? String(leaderboardEntry.totalYieldEarned) : '0';
              totalPortfolioValue += BigInt(portfolioValueStr);
              totalYieldEarned += BigInt(yieldEarnedStr);
              this.logger.log(`Using database fallback for ${member.walletAddress}: portfolio=${portfolioValueStr}, yield=${yieldEarnedStr}`);
            }
          }
        }
      }

      // Update guild stats - convert BigInt to string for NUMERIC columns
      await this.db
        .update(schema.guilds)
        .set({
          totalPortfolioValue: totalPortfolioValue.toString(), // String for NUMERIC column
          totalYieldEarned: totalYieldEarned.toString(), // String for NUMERIC column
          updatedAt: new Date(),
        })
        .where(eq(schema.guilds.id, guildId));

      const portfolioValueStr = (Number(totalPortfolioValue) / 1e18).toFixed(2);
      const yieldEarnedStr = (Number(totalYieldEarned) / 1e18).toFixed(2);
      this.logger.log(`Updated stats for guild ${guildId}: ${portfolioValueStr} TYCOON portfolio, ${yieldEarnedStr} TYCOON yield`);
    } catch (error) {
      this.logger.error(`Error updating guild stats for ${guildId}: ${error.message}`, error.stack);
      throw error;
    }
  }

  async searchGuilds(query: string, limit: number = 20) {
    return this.db
      .select({
        id: schema.guilds.id,
        name: schema.guilds.name,
        description: schema.guilds.description,
        totalMembers: schema.guilds.totalMembers,
        totalPortfolioValue: schema.guilds.totalPortfolioValue,
        isPublic: schema.guilds.isPublic,
      })
      .from(schema.guilds)
      .where(
        and(
          eq(schema.guilds.isPublic, true),
          sql`LOWER(${schema.guilds.name}) LIKE LOWER(${'%' + query + '%'})`,
        ),
      )
      .orderBy(desc(schema.guilds.totalPortfolioValue))
      .limit(limit);
  }
}
</file>

<file path="backend/src/leaderboard/leaderboard.service.ts">
import { Injectable, Logger, Inject, forwardRef } from '@nestjs/common';
import { DATABASE_CONNECTION } from '../database/database.module';
import { PostgresJsDatabase } from 'drizzle-orm/postgres-js';
import * as schema from '../database/schema';
import { desc, sql, eq, and } from 'drizzle-orm';
import { ContractsService } from '../contracts/contracts.service';

@Injectable()
export class LeaderboardService {
  private readonly logger = new Logger(LeaderboardService.name);

  constructor(
    @Inject(DATABASE_CONNECTION) private db: PostgresJsDatabase<typeof schema>,
    private contractsService: ContractsService,
  ) {}

  async syncAllUsersFromChain() {
    // NOTE: Property syncing is OPTIONAL - frontend works 100% from blockchain
    // This is only needed for leaderboard calculations
    // If you want to disable it, set ENABLE_PROPERTY_SYNC=false in .env
    
    if (process.env.ENABLE_PROPERTY_SYNC === 'false') {
      this.logger.log('Property syncing is disabled (frontend works from blockchain)');
      return;
    }

    // Check if contract is initialized
    if (!this.contractsService.propertyNFT) {
      this.logger.warn('PropertyNFT contract not initialized, cannot sync');
      return;
    }

    this.logger.log('Syncing all users\' properties from blockchain (for leaderboard only)...');
    
    try {
      if (!this.contractsService.propertyNFT) {
        this.logger.warn('PropertyNFT contract not initialized, skipping sync');
        return;
      }

      // Strategy: Get all unique owners from properties in database first
      // Then also check blockchain events for any owners we might have missed
      const allUsers = await this.db
        .select({
          id: schema.users.id,
          walletAddress: schema.users.walletAddress,
        })
        .from(schema.users)
        .limit(100); // Increase limit

      this.logger.log(`Found ${allUsers.length} users in database to sync`);

      // Sync properties for each user in database
      const syncedAddresses = new Set<string>();
      for (const user of allUsers) {
        try {
          const normalized = user.walletAddress.toLowerCase();
          syncedAddresses.add(normalized);
          await this.syncUserPropertiesFromChain(user.walletAddress);
          // Update leaderboard for this user
          await this.updateLeaderboard(user.id);
        } catch (error) {
          this.logger.error(`Failed to sync properties for user ${user.walletAddress}: ${error.message}`);
          // Continue with other users even if one fails
        }
      }

      // Also discover new owners from blockchain by checking PropertyCreated events
      try {
        this.logger.log('Discovering new property owners from blockchain events...');
        const propertyCreatedFilter = this.contractsService.propertyNFT.filters.PropertyCreated();
        const events = await this.contractsService.propertyNFT.queryFilter(propertyCreatedFilter);
        
        const uniqueOwners = new Set<string>();
        for (const event of events) {
          if (event.args && event.args.owner) {
            const owner = event.args.owner.toLowerCase();
            if (!syncedAddresses.has(owner)) {
              uniqueOwners.add(owner);
            }
          }
        }

        this.logger.log(`Found ${uniqueOwners.size} new owners from blockchain events`);

        // Sync properties for newly discovered owners
        for (const ownerAddress of uniqueOwners) {
          try {
            await this.syncUserPropertiesFromChain(ownerAddress);
            // Get the user ID after sync (user should be created)
            const [user] = await this.db
              .select()
              .from(schema.users)
              .where(eq(schema.users.walletAddress, ownerAddress))
              .limit(1);
            
            if (user) {
              await this.updateLeaderboard(user.id);
            }
          } catch (error) {
            this.logger.error(`Failed to sync newly discovered owner ${ownerAddress}: ${error.message}`);
          }
        }
      } catch (error) {
        this.logger.error(`Error discovering owners from events: ${error.message}`);
        // Continue even if event query fails
      }
      
      this.logger.log(`Sync complete: ${allUsers.length} existing users synced`);
    } catch (error) {
      this.logger.error(`Error syncing users from chain: ${error.message}`, error.stack);
      throw error;
    }
  }

  private getContractAddresses(): string[] {
    // Get all contract addresses to exclude from leaderboard
    const addresses: string[] = [];
    
    if (this.contractsService.marketplace?.address) {
      addresses.push(this.contractsService.marketplace.address.toLowerCase());
    }
    if (this.contractsService.yieldDistributor?.address) {
      addresses.push(this.contractsService.yieldDistributor.address.toLowerCase());
    }
    if (this.contractsService.questSystem?.address) {
      addresses.push(this.contractsService.questSystem.address.toLowerCase());
    }
    if (this.contractsService.propertyNFT?.address) {
      addresses.push(this.contractsService.propertyNFT.address.toLowerCase());
    }
    if (this.contractsService.gameToken?.address) {
      addresses.push(this.contractsService.gameToken.address.toLowerCase());
    }
    
    // Also exclude old marketplace if set
    const oldMarketplace = process.env.OLD_MARKETPLACE_ADDRESS;
    if (oldMarketplace) {
      addresses.push(oldMarketplace.toLowerCase());
    }
    
    // Hardcode known old marketplace address (from README)
    addresses.push('0x6389d7168029715de118baf51b6d32ee1ebea46b'.toLowerCase());
    
    return addresses;
  }

  async getGlobalLeaderboard(limit: number = 100) {
    const contractAddresses = this.getContractAddresses();
    
    // Return cached data immediately (fast response)
    // Event listeners automatically update leaderboard when properties are listed/sold
    // No need to refresh on every request - that's too slow
    try {
      const rankings = await this.db
        .select({
          userId: schema.leaderboard.userId,
          totalPortfolioValue: schema.leaderboard.totalPortfolioValue,
          totalYieldEarned: schema.leaderboard.totalYieldEarned,
          propertiesOwned: schema.leaderboard.propertiesOwned,
          questsCompleted: schema.leaderboard.questsCompleted,
          walletAddress: schema.users.walletAddress,
          username: schema.users.username,
        })
        .from(schema.leaderboard)
        .leftJoin(schema.users, eq(schema.leaderboard.userId, schema.users.id))
        .orderBy(desc(schema.leaderboard.totalPortfolioValue))
        .limit(limit * 2); // Get more to filter out contracts
      
      // Filter out contract addresses
      const filteredRankings = rankings.filter(r => {
        if (!r.walletAddress) return false;
        const address = r.walletAddress.toLowerCase();
        return !contractAddresses.includes(address);
      }).slice(0, limit);

      return filteredRankings.map((r, index) => ({
        ...r,
        rank: index + 1,
        // Convert string values (NUMERIC) to strings for JSON serialization
        totalPortfolioValue: r.totalPortfolioValue ? String(r.totalPortfolioValue) : '0',
        totalYieldEarned: r.totalYieldEarned ? String(r.totalYieldEarned) : '0',
      }));
    } catch (error) {
      this.logger.warn(`Error fetching leaderboard from database: ${error.message}`);
    }

    // If database is empty or failed, calculate from blockchain directly
    this.logger.log('Database leaderboard empty or invalid, calculating from blockchain...');
    return await this.calculateLeaderboardFromBlockchain(limit);
  }
  

  async clearAndRecalculateLeaderboard(limit: number = 100) {
    this.logger.log(' Clearing all old leaderboard data and recalculating from new contract only...');
    
    // Step 1: Delete ALL leaderboard entries
    try {
      await this.db.delete(schema.leaderboard);
      this.logger.log(' Cleared all leaderboard entries');
    } catch (error: any) {
      this.logger.error(`Failed to clear leaderboard: ${error.message}`);
      throw error;
    }
    
    // Step 2: Recalculate from new contract only
    const rankings = await this.calculateLeaderboardFromBlockchain(limit);
    
    this.logger.log(` Recalculated leaderboard with ${rankings.length} entries from new contract`);
    return rankings;
  }

  async calculateLeaderboardFromBlockchain(limit: number = 100) {
    if (!this.contractsService.propertyNFT) {
      this.logger.warn('PropertyNFT contract not initialized, cannot calculate leaderboard from blockchain');
      return [];
    }

    try {
      // Get the current PropertyNFT contract address to ensure we only query the new contract
      const propertyNFTAddress = this.contractsService.propertyNFT.address;
      const expectedPropertyNFT = process.env.PROPERTY_NFT_ADDRESS || '0xe1fF4f5f79D843208A0c70a0634a0CE4F034D697';
      this.logger.log(`Using PropertyNFT contract: ${propertyNFTAddress}`);
      this.logger.log(`Expected PropertyNFT: ${expectedPropertyNFT}`);
      
      // Verify we're using the correct PropertyNFT contract
      if (propertyNFTAddress.toLowerCase() !== expectedPropertyNFT.toLowerCase()) {
        this.logger.error(`PropertyNFT address mismatch! Using ${propertyNFTAddress}, expected ${expectedPropertyNFT}`);
        throw new Error('PropertyNFT address mismatch - using wrong contract');
      }
      
      // First, discover property owners from blockchain events (chunk queries to avoid RPC limit)
      const discoveredOwners = new Set<string>();
      try {
        this.logger.log('Discovering property owners from blockchain events (new contract only)...');
        const currentBlock = await this.contractsService.getProvider().getBlockNumber();
        
        // Query from block 0 to ensure we get all properties from the new contract
        // The PropertyNFT contract address filter ensures we only get events from the new contract
        const fromBlock = 0;
        const chunkSize = 10000; // RPC limit
        
        for (let i = fromBlock; i <= currentBlock; i += chunkSize) {
          const toBlock = Math.min(i + chunkSize - 1, currentBlock);
          if (i > toBlock) break;
          
          try {
            const propertyCreatedFilter = this.contractsService.propertyNFT.filters.PropertyCreated();
            const events = await this.contractsService.propertyNFT.queryFilter(propertyCreatedFilter, i, toBlock);
            
            for (const event of events) {
              if (event.args && event.args.owner) {
                discoveredOwners.add(event.args.owner.toLowerCase());
              }
            }
          } catch (error) {
            this.logger.warn(`Failed to query events from block ${i} to ${toBlock}: ${error.message}`);
          }
        }
        this.logger.log(`Found ${discoveredOwners.size} unique property owners from new contract events`);
      } catch (error) {
        this.logger.warn(`Failed to discover owners from events: ${error.message}`);
      }

      // Get all users from database
      const dbUsers = await this.db
        .select({
          id: schema.users.id,
          walletAddress: schema.users.walletAddress,
          username: schema.users.username,
        })
        .from(schema.users)
        .limit(100);

      // Get contract addresses to exclude
      const contractAddresses = this.getContractAddresses();
      
      // Combine database users with discovered owners (exclude contracts)
      const allAddresses = new Set<string>();
      dbUsers.forEach(u => {
        const addr = u.walletAddress.toLowerCase();
        if (!contractAddresses.includes(addr)) {
          allAddresses.add(addr);
        }
      });
      discoveredOwners.forEach(addr => {
        if (!contractAddresses.includes(addr)) {
          allAddresses.add(addr);
        }
      });

      // Create users for discovered owners who aren't in database (exclude contracts)
      for (const address of discoveredOwners) {
        if (contractAddresses.includes(address)) {
          continue; // Skip contract addresses
        }
        if (!dbUsers.find(u => u.walletAddress.toLowerCase() === address)) {
          try {
            const [newUser] = await this.db
              .insert(schema.users)
              .values({
                walletAddress: address,
                createdAt: new Date(),
                updatedAt: new Date(),
              })
              .returning();
            dbUsers.push({
              id: newUser.id,
              walletAddress: newUser.walletAddress,
              username: newUser.username,
            });
            this.logger.log(`Created user for discovered owner: ${address}`);
          } catch (error) {
            this.logger.warn(`Failed to create user for ${address}: ${error.message}`);
          }
        }
      }

      this.logger.log(`Calculating leaderboard from blockchain for ${dbUsers.length} users...`);

      // Filter out contract addresses from dbUsers
      const userAddresses = dbUsers.filter(u => {
        const addr = u.walletAddress.toLowerCase();
        return !contractAddresses.includes(addr);
      });

      const leaderboardEntries = await Promise.all(
        userAddresses.map(async (user) => {
          try {
            // Get properties from blockchain
            let tokenIds: bigint[] = [];
            try {
              const result = await this.contractsService.getOwnerProperties(user.walletAddress);
              if (Array.isArray(result)) {
                tokenIds = result;
              } else if (result && typeof result === 'object' && 'length' in result) {
                tokenIds = Array.from(result as any);
              }
            } catch (error: any) {
              // If getOwnerProperties fails, user has no properties in new contract
              this.logger.debug(`No properties found in new contract for ${user.walletAddress}: ${error.message}`);
              return null; // No properties
            }
            
            if (!Array.isArray(tokenIds) || tokenIds.length === 0) {
              this.logger.debug(`No properties found for ${user.walletAddress}`);
              return null; // No properties
            }

            this.logger.log(`Found ${tokenIds.length} properties for ${user.walletAddress}`);

            // Calculate portfolio value from blockchain
            let totalPortfolioValue = BigInt(0);
            let totalYieldEarned = BigInt(0);

            for (const tokenId of tokenIds) {
              try {
                const propData = await this.contractsService.getProperty(BigInt(Number(tokenId)));
                // Value is now stored as string (numeric), convert to BigInt for calculation
                totalPortfolioValue += BigInt(propData.value.toString());
                totalYieldEarned += BigInt(propData.totalYieldEarned?.toString() || '0');
              } catch (error) {
                this.logger.warn(`Failed to get property ${tokenId} for leaderboard: ${error.message}`);
              }
            }

            return {
              userId: user.id,
              walletAddress: user.walletAddress,
              username: user.username,
              totalPortfolioValue: totalPortfolioValue.toString(),
              totalYieldEarned: totalYieldEarned.toString(),
              propertiesOwned: tokenIds.length,
              questsCompleted: 0, // Quests are in database, skip for now
            };
          } catch (error) {
            this.logger.warn(`Failed to calculate stats for ${user.walletAddress}: ${error.message}`);
            return null;
          }
        })
      );

      // Filter out nulls and sort by portfolio value
      const validEntries = leaderboardEntries
        .filter((e): e is NonNullable<typeof e> => e !== null)
        .sort((a, b) => {
          const aValue = BigInt(a.totalPortfolioValue);
          const bValue = BigInt(b.totalPortfolioValue);
          return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;
        })
        .slice(0, limit)
        .map((entry, index) => ({
          ...entry,
          rank: index + 1,
        }));

      // Save leaderboard entries to database
      for (const entry of validEntries) {
        try {
          await this.db
            .insert(schema.leaderboard)
            .values({
              userId: entry.userId,
              totalPortfolioValue: entry.totalPortfolioValue,
              totalYieldEarned: entry.totalYieldEarned,
              propertiesOwned: entry.propertiesOwned,
              questsCompleted: entry.questsCompleted || 0,
              updatedAt: new Date(),
            })
            .onConflictDoUpdate({
              target: schema.leaderboard.userId,
              set: {
                totalPortfolioValue: entry.totalPortfolioValue,
                totalYieldEarned: entry.totalYieldEarned,
                propertiesOwned: entry.propertiesOwned,
                questsCompleted: entry.questsCompleted || 0,
                updatedAt: new Date(),
              },
            });
        } catch (error: any) {
          this.logger.warn(`Failed to save leaderboard entry for ${entry.walletAddress}: ${error.message}`);
        }
      }
      
      this.logger.log(`Calculated and saved ${validEntries.length} leaderboard entries from blockchain`);
      
      if (validEntries.length === 0) {
        this.logger.warn('No leaderboard entries found. Possible reasons:');
        this.logger.warn(`- No users in database: ${dbUsers.length}`);
        this.logger.warn(`- No property owners discovered from events: ${discoveredOwners.size}`);
        this.logger.warn('- Users in database might not have properties on-chain');
        this.logger.warn('- Check backend logs for property fetching errors');
      }
      
      return validEntries;
    } catch (error) {
      this.logger.error(`Error calculating leaderboard from blockchain: ${error.message}`, error.stack);
      return [];
    }
  }

  async updateLeaderboard(userId: string) {
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.id, userId))
      .limit(1);

    if (!user) {
      this.logger.warn(`User ${userId} not found for leaderboard update`);
      return;
    }

    // Skip if this is a contract address
    const contractAddresses = this.getContractAddresses();
    if (contractAddresses.includes(user.walletAddress.toLowerCase())) {
      this.logger.log(`Skipping leaderboard update for contract address: ${user.walletAddress}`);
      return;
    }

    // Sync properties from blockchain first (only if enabled)
    if (process.env.ENABLE_PROPERTY_SYNC !== 'false') {
      try {
        this.logger.log(`Syncing properties from blockchain for user ${user.walletAddress} before leaderboard update`);
        await this.syncUserPropertiesFromChain(user.walletAddress);
      } catch (error) {
        this.logger.error(`Failed to sync properties for leaderboard update: ${error.message}`, error.stack);
        // Continue with database properties even if sync fails
      }
    }

    // Get user's properties directly from blockchain (source of truth)
    // This ensures listed properties (owned by marketplace contract) are not counted
    let totalPortfolioValue = BigInt(0);
    let actualPropertyCount = 0;
    
    if (this.contractsService.propertyNFT) {
      try {
        // Get actual properties owned by user from blockchain
        let tokenIds: bigint[] = [];
        try {
          const result = await this.contractsService.getOwnerProperties(user.walletAddress);
          if (Array.isArray(result)) {
            tokenIds = result;
          } else if (result && typeof result === 'object' && 'length' in result) {
            tokenIds = Array.from(result as any);
          }
        } catch (error: any) {
          // If getOwnerProperties fails, user has no properties in new contract
          this.logger.warn(`No properties found in new contract for ${user.walletAddress}: ${error.message}`);
          // Don't update leaderboard if user has no properties
          return;
        }
        
        this.logger.log(` getOwnerProperties returned ${tokenIds.length} properties for ${user.walletAddress}`);
        const contractAddresses = this.getContractAddresses();
        
        if (Array.isArray(tokenIds) && tokenIds.length > 0) {
          // Deduplicate tokenIds
          const uniqueTokenIds = Array.from(new Set(tokenIds.map(id => Number(id))));
          
          // For each property, verify current owner FIRST (before getting property data)
          // This ensures listed properties (owned by marketplace) are excluded
          for (const tokenId of uniqueTokenIds) {
            try {
              // Check ownerOf FIRST - this is the source of truth
              let currentOwner: string;
              try {
                currentOwner = await this.contractsService.propertyNFT.ownerOf(tokenId);
              } catch (error) {
                // ownerOf failed - property doesn't exist in new contract (from old contract)
                this.logger.warn(` Property ${tokenId} doesn't exist in new contract, skipping`);
                continue; // Skip this property
              }
              
              const isOwnedByUser = currentOwner.toLowerCase() === user.walletAddress.toLowerCase();
              const isContract = contractAddresses.includes(currentOwner.toLowerCase());
              
              this.logger.log(` Property ${tokenId}: ownerOf=${currentOwner}, user=${user.walletAddress}, isOwnedByUser=${isOwnedByUser}, isContract=${isContract}`);
              
              // Only process if owned by user AND not a contract address
              if (isOwnedByUser && !isContract) {
                const propertyData = await this.contractsService.getProperty(BigInt(tokenId));
                if (propertyData) {
                  const value = propertyData.value?.toString() || '0';
                  totalPortfolioValue += BigInt(value);
                  actualPropertyCount++;
                  this.logger.log(` Property ${tokenId} counted: value=${value}`);
                }
              } else {
                this.logger.log(` Property ${tokenId} excluded: owned by ${currentOwner} (${isContract ? 'contract' : 'different user'})`);
              }
            } catch (error: any) {
              // If ownerOf fails, property doesn't exist in new contract - skip it
              if (error.message?.includes('revert') || error.code === 'CALL_EXCEPTION') {
                this.logger.debug(`Property ${tokenId} doesn't exist in new contract, skipping`);
              } else {
                this.logger.warn(`Failed to verify property ${tokenId} for leaderboard: ${error.message}`);
              }
            }
          }
        }
        
        this.logger.log(`Calculated portfolio for ${user.walletAddress}: ${actualPropertyCount} properties, ${totalPortfolioValue.toString()} wei`);
      } catch (error) {
        this.logger.error(`Failed to get properties from blockchain for leaderboard: ${error.message}`);
        // Fallback to database if blockchain query fails
        const properties = await this.db
          .select()
          .from(schema.properties)
          .where(eq(schema.properties.ownerId, userId));
        totalPortfolioValue = properties.reduce((sum, prop) => {
          return sum + BigInt(prop.value?.toString() || '0');
        }, BigInt(0));
        actualPropertyCount = actualPropertyCount;
      }
    } else {
      // Fallback to database if contract not initialized
      const properties = await this.db
        .select()
        .from(schema.properties)
        .where(eq(schema.properties.ownerId, userId));
      totalPortfolioValue = properties.reduce((sum, prop) => {
        return sum + BigInt(prop.value?.toString() || '0');
      }, BigInt(0));
      actualPropertyCount = actualPropertyCount;
    }

    // Get completed quests
    const completedQuests = await this.db
      .select()
      .from(schema.questProgress)
      .where(
        and(
          eq(schema.questProgress.userId, userId),
          eq(schema.questProgress.completed, true),
        ),
      );

    // Get total yield earned
    const yieldRecords = await this.db
      .select()
      .from(schema.yieldRecords)
      .where(
        and(
          eq(schema.yieldRecords.ownerId, userId),
          eq(schema.yieldRecords.claimed, true),
        ),
      );

    const totalYieldEarned = yieldRecords.reduce((sum, record) => {
      return sum + BigInt(record.amount.toString());
    }, BigInt(0));

    const [existing] = await this.db
      .select()
      .from(schema.leaderboard)
      .where(eq(schema.leaderboard.userId, userId))
      .limit(1);

    // Convert BigInt to string for numeric columns
    // Ensure values are properly formatted as strings for NUMERIC type
    const totalPortfolioValueStr = totalPortfolioValue.toString();
    const totalYieldEarnedStr = totalYieldEarned.toString();
    
    const leaderboardData: any = {
      userId,
      totalPortfolioValue: totalPortfolioValueStr, // String for NUMERIC column
      totalYieldEarned: totalYieldEarnedStr, // String for NUMERIC column
      propertiesOwned: actualPropertyCount,
      questsCompleted: completedQuests.length,
      updatedAt: new Date(),
    };

    try {
      if (existing) {
        await this.db
          .update(schema.leaderboard)
          .set(leaderboardData)
          .where(eq(schema.leaderboard.userId, userId));
      } else {
        await this.db.insert(schema.leaderboard).values(leaderboardData);
      }
    } catch (dbError: any) {
      // Log detailed error for debugging
      this.logger.error(`Database error updating leaderboard: ${dbError.message}`);
      if (dbError.cause) {
        this.logger.error(`PostgreSQL error: ${JSON.stringify(dbError.cause)}`);
      }
      if (dbError.code) {
        this.logger.error(`Error code: ${dbError.code}`);
      }
      if (dbError.detail) {
        this.logger.error(`Error detail: ${dbError.detail}`);
      }
      throw dbError;
    }

    const portfolioValueStr = (Number(totalPortfolioValue) / 1e18).toFixed(2);
    this.logger.log(`Updated leaderboard for user ${userId}: ${actualPropertyCount} properties, ${portfolioValueStr} TYCOON portfolio`);
  }

  private async syncUserPropertiesFromChain(walletAddress: string) {
    if (!this.contractsService.propertyNFT) {
      this.logger.error('PropertyNFT contract not initialized! Cannot sync from blockchain.');
      this.logger.error('Please ensure MANTLE_RPC_URL, PRIVATE_KEY, and PROPERTY_NFT_ADDRESS are set in backend .env');
      throw new Error('Contract not initialized. Please check backend configuration.');
    }

    try {
      const normalizedAddress = walletAddress.toLowerCase();
      
      // Get or create user
      let [user] = await this.db
        .select()
        .from(schema.users)
        .where(eq(schema.users.walletAddress, normalizedAddress))
        .limit(1);

      if (!user) {
        this.logger.log(`Creating user for ${normalizedAddress}`);
        [user] = await this.db
          .insert(schema.users)
          .values({
            walletAddress: normalizedAddress,
            createdAt: new Date(),
            updatedAt: new Date(),
          })
          .returning();
      }

      // Get properties from blockchain
      let tokenIds: any[];
      try {
        tokenIds = await this.contractsService.getOwnerProperties(walletAddress);
      } catch (error) {
        this.logger.error(`Failed to get properties from blockchain for ${walletAddress}: ${error.message}`);
        return;
      }
      
      if (!Array.isArray(tokenIds) || tokenIds.length === 0) {
        // No properties found, but that's okay
        return;
      }

      // Sync each property
      for (const tokenId of tokenIds) {
        try {
          const tokenIdNum = typeof tokenId === 'bigint' ? Number(tokenId) : Number(tokenId);
          const propData = await this.contractsService.getProperty(BigInt(tokenIdNum));
          
          const propertyTypeNum = typeof propData.propertyType === 'bigint' 
            ? Number(propData.propertyType) 
            : Number(propData.propertyType);
          
          const propertyTypeMap: Record<number, string> = {
            0: 'Residential',
            1: 'Commercial',
            2: 'Industrial',
            3: 'Luxury',
          };

          // Convert yieldRate - it might be in wei format, convert to basis points
          let yieldRateValue = Number(propData.yieldRate.toString());
          // If yieldRate is very large (> 1e15), it's likely in wei format, convert to basis points
          if (yieldRateValue > 1e15) {
            yieldRateValue = Number(propData.yieldRate.toString()) / 1e18 * 100;
          }
          // Ensure it's in basis points (500 = 5%)
          if (yieldRateValue < 100 && yieldRateValue > 0) {
            yieldRateValue = yieldRateValue * 100;
          }

          // Handle rwaTokenId - don't insert if it's 0 (BigInt(0) is truthy, so check explicitly)
          const rwaTokenIdNum = propData.rwaTokenId 
            ? Number(propData.rwaTokenId.toString()) 
            : 0;
          const rwaTokenIdValue = (rwaTokenIdNum && rwaTokenIdNum > 0) ? rwaTokenIdNum : null;
          
          // Convert value to string for numeric column (handles very large numbers)
          const valueStr = typeof propData.value === 'bigint' 
            ? propData.value.toString()
            : propData.value.toString();
          
          const rwaContractValue = propData.rwaContract && propData.rwaContract !== '0x0000000000000000000000000000000000000000' 
            ? propData.rwaContract 
            : undefined;
          
          const propertyTypeStr = propertyTypeMap[propertyTypeNum] || 'Residential';
          
          // Use Drizzle ORM for proper type handling (same as PropertiesService)
          try {
            // Check if property exists
            const [existing] = await this.db
              .select()
              .from(schema.properties)
              .where(eq(schema.properties.tokenId, tokenIdNum))
              .limit(1);

            // Build update/insert object conditionally
            const propertyData: any = {
              ownerId: user.id,
              propertyType: propertyTypeStr,
              value: valueStr, // Use string for numeric column
              yieldRate: yieldRateValue,
              updatedAt: new Date(),
            };

            // Only include rwaContract if it has a value
            if (rwaContractValue) {
              propertyData.rwaContract = rwaContractValue;
            } else {
              propertyData.rwaContract = null;
            }

            // Only include rwaTokenId if it has a value
            if (rwaTokenIdValue !== null && rwaTokenIdValue !== undefined) {
              propertyData.rwaTokenId = rwaTokenIdValue;
            } else {
              propertyData.rwaTokenId = null;
            }

            if (existing) {
              // Update existing property
              await this.db
                .update(schema.properties)
                .set(propertyData)
                .where(eq(schema.properties.tokenId, tokenIdNum));
            } else {
              // Insert new property
              await this.db.insert(schema.properties).values({
                ...propertyData,
                tokenId: tokenIdNum,
                createdAt: new Date(),
              });
            }
            
            this.logger.log(`Upserted property ${tokenIdNum} for ${normalizedAddress}`);
          } catch (dbError: any) {
            const errorMsg = dbError.message || String(dbError);
            this.logger.error(`Failed to upsert property ${tokenIdNum}: ${errorMsg}`);
            if (dbError.stack) {
              this.logger.error(`Stack: ${dbError.stack.substring(0, 500)}`);
            }
            // Continue with next property
          }
        } catch (error) {
          this.logger.error(`Error syncing property ${tokenId}: ${error.message}`);
          // Continue with next property
        }
      }
    } catch (error) {
      this.logger.error(`Error in syncUserPropertiesFromChain for ${walletAddress}: ${error.message}`, error.stack);
      throw error;
    }
  }

  async syncAndUpdateLeaderboard(walletAddress: string) {
    const normalizedAddress = walletAddress.toLowerCase();
    
    // Sync properties from chain first (only if enabled)
    if (process.env.ENABLE_PROPERTY_SYNC !== 'false') {
      await this.syncUserPropertiesFromChain(walletAddress);
    }
    
    // Find user
    const [user] = await this.db
      .select()
      .from(schema.users)
      .where(eq(schema.users.walletAddress, normalizedAddress))
      .limit(1);

    if (!user) {
      throw new Error(`User not found for ${walletAddress}`);
    }

    // Update leaderboard
    await this.updateLeaderboard(user.id);
  }

  async cleanupContractAddresses() {
    const contractAddresses = this.getContractAddresses();
    this.logger.log(`Cleaning up leaderboard entries for ${contractAddresses.length} contract addresses...`);
    
    let deletedCount = 0;
    
    for (const contractAddr of contractAddresses) {
      try {
        // Find users with this contract address
        const contractUsers = await this.db
          .select({ id: schema.users.id })
          .from(schema.users)
          .where(eq(schema.users.walletAddress, contractAddr));
        
        for (const user of contractUsers) {
          // Delete leaderboard entries
          await this.db
            .delete(schema.leaderboard)
            .where(eq(schema.leaderboard.userId, user.id));
          
          deletedCount++;
          this.logger.log(`Deleted leaderboard entry for contract ${contractAddr}`);
        }
      } catch (error: any) {
        this.logger.error(`Error cleaning up contract ${contractAddr}: ${error.message}`);
      }
    }
    
    this.logger.log(`Cleanup complete: Deleted ${deletedCount} leaderboard entries for contract addresses`);
    return { 
      success: true, 
      deletedCount,
      contractAddresses: contractAddresses.length,
      message: `Cleaned up ${deletedCount} leaderboard entries for contract addresses` 
    };
  }
}
</file>

</files>
